<<<BEGIN>>>
# 02_tls_証明書・CT・外部依存推定.md

## 目的（この技術で到達する状態）
- TLS/証明書を「HTTPSだから安全」や「CN/SANを見た」で終わらせず、**外部依存（CDN/WAF/SaaS/委託）・境界（資産/信頼）・到達性**を推定し、ASM/OSINTの次の一手（追加探索・優先度付け・検証方針）を自走で決められる。
- CT（Certificate Transparency）を「サブドメイン拾い」だけに使わず、**運用の癖・境界の分割・移行/残骸の兆候**を読み、深掘り対象を選べる。

## 前提（対象・範囲・想定）
- 対象：許可された範囲（契約スコープ/許可された資産/自前環境）に限定。
- 想定：CDN/WAF配下が多く、TLS終端がアプリ/オリジンではなく外部サービスであることがある。
- やらないこと：大量の能動的スキャンや過剰な負荷を前提にしない（ASM/OSINTの“観測”中心）。
- 依存する前提知識（最小限）：証明書（SAN/Issuer/有効期限/ワイルドカード）、TLS終端、SNI。

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象
  - 証明書チェーン：Leaf（サーバ証明書）/中間CA/ルートCA
  - Leafの情報：SAN、Issuer、Subject、Validity、KeyUsage/ExtKeyUsage、Serial、公開鍵
  - ハンドシェイク情報：SNI、ALPN、TLSバージョン、暗号スイート（“何が許されているか”の運用痕跡）
  - CTログ：証明書発行の履歴（「どんな名前が、いつ、どのCAで」発行されたか）
- 境界の観点
  - 資産境界：そのTLS終端は“自社運用”か“外部委託（CDN/WAF/SaaS）”か
  - 信頼境界：証明書の発行・更新プロセス（DNS/HTTP検証、委託先運用）が越境点になり得る
  - 権限境界：証明書更新権限（DNS管理/IAM）と、アプリ変更権限が一致しない場合がある

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか
  - SANに含まれるFQDN：その証明書がカバーするホスト名（ただし“今も稼働”は別）
  - Issuer/チェーン：どのCA経由で発行されているか（管理/委託の手掛かり）
  - Validity：更新頻度や運用体制の傾向（短命証明書が多い等）
- 何が“推定”できるか（推定の根拠/前提）
  - Issuerや証明書パターン、TLS応答傾向から、CDN/WAF/SaaS終端の可能性
  - CTの発行履歴から、移行中/残骸/一時ホスト名運用の可能性
  - ワイルドカード多用やSANの粒度から、運用設計（集中管理/分割管理）の傾向
- 何は“言えない”か（不足情報・観測限界）
  - SANに出た名前が「スコープ内資産」かは確定できない（対象境界の確認が必要）
  - TLS終端が見えても、オリジン（実サーバ）の所在や構成は断定できない（HTTP/挙動・DNS・場合により到達性検証が必要）
  - CTに出たホスト名が「今も到達可能」とは限らない（過去の発行・残骸が混ざる）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- TLS/CT観測で決めたいこと（攻撃者の意思決定）
  - “境界が多い領域”を見つける（外部委託、移行、名称揺れ、ワイルドカード設計）
  - “運用が難しい領域”を優先する（短命証明書大量発行、SAN肥大、頻繁な名前追加）
  - “残骸/一時運用”の兆候を拾う（CTにだけ出て、現状のDNSでは見えない名前等）
- この状態が示す“狙い目”（一般論）
  - CTに多様な命名規則が並ぶ：環境が多い＝境界・責任分界が増える（深掘り価値が高い）
  - 証明書のSANに内部っぽい命名が混じる：運用の混在（ただし断定せず、追加観測へ）
  - Issuer/証明書パターンが急に変わる：移行（CDN切替、WAF導入、管理移管）の可能性
- 戦略変更（見える/見えないで変える）
  - CDN/WAF終端の疑い：オリジン追跡に固執せず、HTTPヘッダ/キャッシュ/認証境界へ寄せる
  - SaaS終端の疑い：アプリ脆弱性より、設定・連携・権限伝播（OAuth/SCIM/IdP連携）を優先検討

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：TLS終端が外部（CDN/WAF/SaaS）で、境界が越境している
  - 次の検証：
    - DNS側（CNAME/NS）と突き合わせ、委譲先が外部サービスか確認する
    - HTTP側観測（ヘッダ/キャッシュ/エラー差）で外部終端の特徴を追加で掴む
  - 期待する観測：
    - “どこが外部依存か”が説明でき、深掘り対象（設定/認証/認可/API）を決められる
- 仮説B：CTに出る名前の一部が残骸/一時環境で、現状のASMで拾えていない
  - 次の検証：
    - CTで得た名前を“代表点”として、DNS解決・HTTP到達可否を最小限で確認する
    - 命名規則（dev/stg/old/region等）が見えるなら、同規則の派生候補を“最小限”で検討する
  - 期待する観測：
    - “現役/残骸/別境界”の分類ができ、優先度を付けられる
- 仮説C：SANが広すぎて、実用的な優先度が付けられない
  - 次の検証：
    - 発行時期（新しい/古い）・Issuer変化・命名規則（本番っぽい/検証っぽい）でクラスタリングする
    - “自社運用っぽい領域”と“外部依存っぽい領域”に分け、深掘り方針を変える
  - 期待する観測：
    - 次に読むtopics（DNS/HTTP/認証/外部連携）が選べる状態になる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/01_attack-box_作業端末設計.md`
    - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
    - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`（視点差分を作る場合）
- 取得する証跡（目的ベースで最小限）
  - 対象ホストごとの「証明書情報（テキスト）」と「観測視点（端末/経路）メモ」
  - CT結果のスナップショット（検索条件・日時・対象を残す）
- 観測の取り方（差分の作り方）
  - 同一ホストを、必要に応じて「別ネットワーク視点」でも観測し、差分（終端/証明書/挙動）を確認する
  - DNS（委譲/外部依存）とTLS（終端/証明書）を突き合わせて境界を確定していく

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 例：TLS終端の証明書を取得（SNIを意識して観測する）
# ※目的：SAN/Issuer/有効期限/チェーンを“観測”する
echo | openssl s_client -connect example.com:443 -servername example.com 2>/dev/null | openssl x509 -noout -text

# 例：SANだけ抜く（比較のための最小化）
echo | openssl s_client -connect example.com:443 -servername example.com 2>/dev/null \
  | openssl x509 -noout -ext subjectAltName

# 例：TLSの許容範囲（バージョン/ALPN等）は環境差の材料として控える（必要時）
# （ここは“強度評価”が目的ではなく、終端や運用差の手掛かりとして扱う）
~~~~

- この例で観測していること
  - TLS終端が返すLeaf証明書の中身（SAN/Issuer/Validity）
  - SNI指定の有無で“別の証明書”が返るか（終端/設定差の兆候）
- 出力のどこを見るか（注目点）
  - SAN：命名規則（prod/stg/dev/region/vendor等）、ワイルドカードの有無、粒度
  - Issuer/チェーン：外部委託の匂い（断定せず、DNS/HTTPで補強）
  - Validity：更新の癖（頻繁/長期）、移行の痕跡（急な変更）
- この例が使えないケース（前提が崩れるケース）
  - CDN/WAF配下で“同じホストでも視点で証明書が変わる”可能性
  - HTTP/3等の影響で観測経路が変わる（必要なら観測条件を固定）
  - そもそもTLSを終端していない（別ポート/別プロトコル）

## CT（Certificate Transparency）の使い方（収集→解釈→優先度）
- 収集（最低限の考え方）
  - 1回の検索結果を“成果”とせず、発行時期・Issuer変化・命名規則で整理する
- 解釈（技術的に読むポイント）
  - 命名規則：環境（dev/stg/old）、地域（jp/us）、委託先（vendor）などの痕跡
  - 発行の連続性：短期間に大量発行は運用変更や自動化（境界・責任分界）を示唆
  - CAの変化：管理移管/サービス変更の兆候
- 優先度付け（深掘り対象の選定）
  - “新しい発行”×“本番っぽい命名”×“外部依存の匂い”を優先し、次の観測（DNS/HTTP）へ繋げる
  - “古い発行”や“明らかな検証命名”は、必要最小限の確認に留める（肥大化防止）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：通信の保護（TLS）・運用（証明書管理）に関する領域（直接のCT要件ではなく、外部依存・終端境界の理解を支える）
  - このファイルの内容が「満たす/破れる」ポイント：
    - TLS終端が外部依存の場合、責任分界を誤ると“設定/更新/鍵管理”の統制が崩れる（検証観点の見落としにつながる）
- WSTG：
  - 該当カテゴリ/テスト観点：Information Gathering（外形把握、技術スタック/依存推定の材料として）
  - 該当が薄い場合：TLS/証明書はWebテストの前提情報（終端/外部依存/環境差）として接続する
- PTES：
  - 該当フェーズ：Intelligence Gathering（情報収集）、Threat Modeling（境界/依存の整理）
  - 前後フェーズとの繋がり（1行）：
    - TLS/CTで境界と依存を固めることで、深掘り（認証/認可/API/設定）の優先度を合理化できる
- MITRE ATT&CK：
  - 該当戦術：Reconnaissance（事前偵察）、Discovery（環境把握）
  - 攻撃者の目的（この技術が支える意図）：
    - 外形と依存関係を把握し、境界が複雑な領域へ探索コストを集中する

## 参考（必要最小限）
- `01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`
- `01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`（次に作る）
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 関連 topics：`01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`

---

<<<END>>>
