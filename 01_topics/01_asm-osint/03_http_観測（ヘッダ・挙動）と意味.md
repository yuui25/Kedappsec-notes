<<<BEGIN>>>
# 03_http_観測（ヘッダ/挙動）と意味.md

## 目的（この技術で到達する状態）
- HTTPの観測を「ヘッダがこう出ていた」で終わらせず、**境界（資産/信頼/権限）・外部依存（CDN/WAF/SaaS）・成立条件（どの条件で挙動が変わるか）**を読み取り、ASM/OSINT→Web/NWの深掘りへ繋げられる。
- “攻撃”ではなく、攻撃者が最初にやる **外形把握と意思決定（どこを深掘りするか）** を、最小の観測で実行できる。

## 前提（対象・範囲・想定）
- 対象：許可範囲の資産のみ（契約スコープ/許可された資産/自前環境）。
- 想定：CDN/WAF配下、マイクロサービス/API、SSO/MFA、SaaS連携が一般的。
- やらないこと：大量アクセスや負荷試験を前提にしない（観測中心）。
- 依存：DNS/TLS観測と突き合わせて境界を固める。
  - `01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`
  - `01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- HTTP観測で見たいもの（攻撃者が最初に決める材料）
  - 到達性：何が返るか（200/301/302/401/403/404/5xx）
  - 認証境界：未ログインでどこまで見えるか（ログイン誘導、SSOリダイレクト等）
  - 依存境界：CDN/WAF/リバプロ/アプリ/バックエンドがどこで分かれるか
  - キャッシュ境界：同じリクエストが“同じレスポンス”か（環境差の有無）
  - API境界：Web画面とAPIがどう分離されているか（同一ドメイン/別ドメイン、CORS等）
- 境界の観点
  - 資産境界：返答しているのが自社運用か外部サービスか（責任分界が変わる）
  - 信頼境界：CDN/WAF/SSOなど、外部の制御点を跨ぐと挙動が変わる
  - 権限境界：認証後に初めて露出するAPI/機能がある（未ログイン観測だけでは足りない）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか
  - ステータスコード/リダイレクト先：認証境界（入口）やポリシーの存在
  - レスポンスヘッダ：キャッシュ、CORS、セキュリティヘッダの有無などの設定傾向
  - Set-Cookie：セッションの存在、属性（Secure/HttpOnly/SameSite等）の傾向
- 何が“推定”できるか（推定の根拠/前提）
  - Server/Via/X-Cache等の痕跡から、CDN/WAF/プロキシ終端の可能性
  - Locationのリダイレクトパターンから、SSO/IdPの存在（ただし断定はしない）
  - CORS応答から、APIの利用形態（ブラウザ利用/サーバ間利用）の可能性
- 何は“言えない”か（不足情報・観測限界）
  - “ヘッダが出ていない”＝“使っていない”ではない（隠蔽/経路差/条件差がある）
  - Serverヘッダ等の指紋は誤誘導になり得る（本体ではない可能性）
  - 未ログイン観測だけで、認可境界（IDOR等）を結論づけられない（認証後観測が必要）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- HTTP観測で決めたいこと（攻撃者の意思決定）
  - 入口（ログイン/SSO/公開API/静的サイト）を分類し、深掘り順を決める
  - 外部制御点（CDN/WAF/SSO）を見抜き、観測点を変える（DNS/TLSと突き合わせる）
  - “条件差で変わる領域”を見つける（ヘッダ差、User-Agent差、Cookie差、地域差等）
- この状態が示す“深掘り価値”（一般論）
  - リダイレクトが複雑：認証境界や複数ドメイン運用（境界が多い）
  - CORSが露出：API境界の存在（ブラウザ利用の前提がある）
  - キャッシュ関連ヘッダが強い：CDN配下の可能性（観測点や再現条件が重要）
  - Set-Cookieが複数：セッション/機能が多い可能性（認証後観測が有効）
- 戦略変更（見える/見えないで変える）
  - CDN/WAF配下：HTTPヘッダ/キャッシュ挙動・エラー差で境界を読む（オリジン追跡に固執しない）
  - SSO誘導：IdP/リダイレクト・Cookieドメイン・SameSiteなど、認証境界の成立条件へ寄せる
  - API中心：CORS/Content-Type/エラー差から、APIの入力点・権限伝播へ寄せる

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：CDN/WAF終端で、観測が視点依存（ヘッダや応答が変わる）
  - 次の検証：
    - DNS/TLSと突き合わせ、外部終端の可能性を補強する
    - “同一リクエストを条件差だけ変えて”観測し、差分が生じる条件を特定する
  - 期待する観測：
    - どの境界（CDN/WAF/アプリ）で差分が出るか説明でき、次の深掘り（認証/認可/API/設定）に繋がる
- 仮説B：SSO/認証境界が入口で、未ログイン観測では中身が見えない
  - 次の検証：
    - 認証後観測（許可範囲で）に切り替える前提を作る（Proxy/HAR）
    - リダイレクト先ドメイン/パラメータのパターンを整理し、境界モデルを作る
  - 期待する観観：
    - 認証境界の構造（どのドメインが何を担うか）が説明でき、次のtopics（authn/authz）へ繋がる
- 仮説C：APIが主で、ブラウザからの観測だけでは入力点/権限伝播が見えない
  - 次の検証：
    - CORS応答、Content-Type、エラー応答の差分から、APIの想定利用形態を推定する
    - 認証後観測（Proxy）で、実際のAPI呼び出しをトレースして境界を固める
  - 期待する観測：
    - “どのAPIがどの境界（テナント/ロール/オブジェクト）で守られているか”の仮説が立つ

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
    - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 取得する証跡（目的ベースで最小限）
  - 未ログインの観測：HTTP応答（ヘッダ/ステータス/リダイレクト）をテキスト化して保存
  - 条件差観測：User-Agent差、Accept差、Cookie有無差などを最小の組み合わせで保存
  - 認証後に繋ぐ準備：HAR/Proxyログ（入口まででも良い）
- 観測の取り方（差分の作り方）
  - “同一URL”に対し、1つだけ条件を変える（ヘッダ/UA/Cookie/参照元）→差分を観測
  - 差分が出たら「境界（CDN/WAF/SSO/アプリ）」の仮説を更新する

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 例：未ログインでの外形観測（ヘッダとステータスを取る）
curl -i https://example.com/

# 例：リダイレクトを追う（認証境界の入口を読む）
curl -i -L https://example.com/

# 例：条件差（User-Agent）で挙動が変わるかを見る（最小の差分）
curl -i -A "Mozilla/5.0" https://example.com/
curl -i -A "curl/8" https://example.com/

# 例：CORSの手掛かり（Origin差分）を観測（最小の差分）
curl -i -H "Origin: https://example.com" https://api.example.com/endpoint
~~~~

- この例で観測していること
  - 入口（リダイレクト/認証境界）、外部終端の痕跡（ヘッダ）、条件差の影響
- 出力のどこを見るか（注目点）
  - ステータス/Location：入口の構造（SSO/ログイン誘導）
  - Set-Cookie：セッション境界（属性含む）
  - CORSヘッダ：API境界とブラウザ利用前提
  - Cache系ヘッダ：CDN配下の可能性（視点差で変わるか）
- この例が使えないケース（前提が崩れるケース）
  - 入口がJS必須でcurlだけでは成立しない（その場合はブラウザ+HARへ）
  - WAF等でcurlがブロックされる（“条件差の一つ”として扱い、UA/ヘッダを変えるのは最小限に留める）

## HTTPヘッダの読み方（“意味”に直結する観点だけ）
> 列挙しない。意思決定に効くものだけを扱う。

- 認証境界の手掛かり
  - Location（リダイレクト先のドメイン/パス/パラメータの規則）
  - Set-Cookie（ドメイン/パス/SameSite/Secure/HttpOnly）
- 外部依存/終端の手掛かり
  - Via / X-Cache / X-Served-By 等（あれば手掛かりだが断定しない）
  - Server（指紋としての価値は限定的。補助扱い）
- API境界の手掛かり
  - Access-Control-*（CORS）
  - Content-Type（JSON/APIの兆候）
- キャッシュ/条件差の手掛かり
  - Cache-Control / Age / ETag / Vary（同一条件で結果が変わる/変わらないの材料）
- セキュリティヘッダ（評価より“境界理解”に寄せる）
  - CSP/HSTS 等（有無より、どの境界を意識しているかの材料）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：通信/ヘッダ/セッション/認証/認可/API/設定の検証に繋がる前提情報（外形把握）
  - この内容が支えるポイント：境界と依存を誤ると、ASVS観点の当て方（どこを見るべきか）がズレる
- WSTG：
  - 該当カテゴリ/テスト観点：Information Gathering（外形・入口・依存把握）、認証/セッション、認可、API（へ繋ぐ入口観測）
  - 該当が薄い場合：WSTG各観点へ入る前の“入口確定”として接続
- PTES：
  - 該当フェーズ：Intelligence Gathering（情報収集）、Vulnerability Analysis（優先度付けの前提）
  - 前後フェーズとの繋がり（1行）：
    - HTTP観測で入口と境界を固めることで、深掘り（認証/認可/API/設定）の検証を外さない
- MITRE ATT&CK：
  - 該当戦術：Reconnaissance（事前偵察）、Discovery（環境把握）
  - 攻撃者の目的（この技術が支える意図）：
    - 最小の観測で入口・依存・境界を把握し、探索コストを最適化する

## 参考（必要最小限）
- `01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`
- `01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`
- `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`
- 関連 labs：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- 関連 topics：`01_topics/02_web/01_web_recon_入口・境界・攻め筋の確定.md`

---

<<<END>>>
