# 12_waf-cdn_挙動観測（ブロック_チャレンジ_例外）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - V1（アーキテクチャ/信頼境界）として、アプリ手前に存在するCDN/WAF/ボット対策を「第三者境界/運用境界」として確定する。
  - V14（運用/構成）として、例外パス（除外URL/許可IP/特定UA/特定Host）や、環境差分（stg/devのみ弱い等）を“状態”で示す。
- WSTG：
  - Information Gathering（入口・挙動・境界の把握）として、レスポンス/ヘッダ/リダイレクト/チャレンジの差分から「どこで何がブロックされているか」を観測し、Web側の検証（Authn/Authz/Input/Config）へ接続する。
- PTES：
  - Intelligence Gathering（外周の防御境界の把握）→ Vulnerability Analysis（例外パス/不整合の発見）へ繋げる。目的は回避手順ではなく、境界の確定と優先度付け。
- MITRE ATT&CK：
  - Reconnaissance（到達性/防御境界の把握）として位置づける。攻撃者が“探索を調整する”のと同じ論理で、診断側は「どの入口を先に見るべきか」「どの経路で証跡を取るべきか」を決める。

## 目的（この技術で到達する状態）
- WAF/CDN/ボット対策を「ある/ない」で終わらせず、**成立点（どのリクエスト以降でブロック/チャレンジが成立したか）** と **例外パス（どの条件で素通りするか）** を観測で固定できる。
- 06_subdomain〜11_cohostingで作った入口群を、WAF/CDNの挙動差分でクラスタリングし、次の深掘り（HTTP/TLS/Cloud/Web Recon）を迷わず選べる。
- 「どこがアプリの問題で、どこが外周の問題か」を、**資産境界/信頼境界/権限境界** で説明できる（報告・責任分界に直結）。

## 前提（対象・範囲・想定）
- 対象：インターネットから到達可能なホスト/パス（代表点）に対するHTTP(S)応答の差分
  - 代表ホスト：`/`、`/login`、`/api/*`、`/admin`、エラー系（存在しないパス）
  - 代表手法：通常ブラウザ相当のGET、最小限のヘッダ差分（UA/Accept/Origin等）
- 想定：
  - CDNとWAFは同一事業者・同一エッジで見えることが多く、**「CDNヘッダがある＝WAFが強い」ではない**。
  - 例外は “パス” だけでなく、Host/サブドメイン/メソッド/ヘッダ/クッキー/地域/レート で起きる。
- 制約：
  - 本ユニットは「観測→解釈→次の一手」。回避ノウハウ（バイパス）を目的化しない。
  - 負荷を上げる試験（大量リクエスト、総当たり、レート検証の過剰反復）はしない。

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) まず “成立点” を固定する（どこからWAF/CDN挙動が変わるか）
- 入口（トップ/ログイン/API/管理）で、同じ条件でも応答が変わることがある。
- 成立点の例（観測で確定する）
  - 1リクエスト目から403/チャレンジ
  - ログイン後（Cookie付与後）にだけブロック
  - 特定パス（/api /admin）でのみブロック
  - 特定ヘッダ/メソッドでのみブロック

### 2) “応答の型” で分類する（判断を速くする）
- 型A：通常応答（200/30xで通常コンテンツ）
- 型B：明確なブロック（403/406/429 等、静的ブロックページ）
- 型C：チャレンジ（JS計算/遅延/リダイレクト多段/人間判定）
- 型D：アプリ側エラー（500等。外周ではなくアプリ起点の可能性）
- 型E：到達不可（タイムアウト/接続拒否。NW境界や許可制御の可能性）

### 3) “ヘッダ差分” を最小セットで取る（運用境界の匂い）
観測の目的はベンダ特定ではなく、境界の説明に使える差分抽出。
- CDN/エッジの匂い：
  - キャッシュ関連（Age, Cache-Control, HIT/MISS系のシグナル）
  - エッジ識別子（リクエストID、PoP、経路ヘッダ）
- WAF/ボット対策の匂い：
  - ブロック時にのみ現れるヘッダ、ブロックページの一貫性
  - 429/チャレンジ誘導（Set-CookieやJSを伴う等）
- アプリ境界の匂い：
  - 302の遷移先（/login等）や、同一ホスト内での権限境界（ログイン必須）
  - 同一パスでもHostにより挙動が異なる（11_cohostingと接続）

### 4) “例外パス” を探すのではなく “例外条件” を状態化する
例外は「見つける」より「存在し得る場所を固定する」。
- 例外が起きやすい条件（観測で yes/no/unknown に落とす）
  - サブドメイン差（api. / admin. / stg. のみ弱い）
  - パス差（/health /status /swagger /graphql など）
  - メソッド差（GETは通るがPOSTで止まる等）
  - 認証状態差（未ログイン/ログイン後で挙動が変わる）
  - IP/地域差（観測地点が変わると型が変わる）
- このファイルでやること：
  - 例外を“探し切る”のではなく、代表点で差分を取り「例外がありそう/なさそう」を決める。

### 5) 境界（資産/信頼/権限）に落とす
- 資産境界：
  - どのホスト群が同一外周（同一CDN/WAF）に乗っているか（クラスター化）
  - 外周が同一でも、アプリが同一とは限らない（次はHTTP/TLS/機能で分ける）
- 信頼境界：
  - 外周（CDN/WAF）が第三者運用なら、責任分界（誰が何を直すか）が変わる
  - 例外条件が運用設計（除外ルール/許可IP/例外ホスト）に起因している可能性を示せる
- 権限境界：
  - ブロック/チャレンジが「重要操作/API」に集中している場合、権限境界保護としての意図がある
  - 逆に重要操作が素通りで、一般ページだけ厳しい場合は“設計のズレ”の可能性を優先観測対象にする

### 6) 証跡（最低限）
- `wafcdn_matrix.csv`（代表点の観測表）
  - host, path, method, status, final_url, response_type(A〜E), key_headers(要約), observed_at
- `wafcdn_clusters.md`
  - クラスターごとの特徴（ブロック型/チャレンジ型/通常型）、代表点、次に回す先（topics）
- 可能なら `har`（ブラウザ相当）と `raw header`（curl相当）の両方を残す（同じ入口を別視点で再現できる）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（状態）
  - 外周の防御境界が「どの入口で」「どの型（A〜E）で」成立しているか
  - 入口群を、外周挙動でクラスター化できる（同一運用っぽい束）
  - 例外条件が“ありそう/なさそう”を、観測差分として提示できる
- 言えないこと（断定しない）
  - そのベンダ/製品の断定（ヘッダ偽装・設定で揺れる）
  - 例外ルールの全容（観測は代表点のみ）
  - 外周が強い＝安全、外周が弱い＝脆弱、の断定

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- 優先度が上がる状態（診断としての意味）
  - `stg/dev/admin/api` など、機能境界が強い入口で外周が弱い/挙動が違う（設計差分の候補）
  - 重要操作だけ別クラスター（別外周・別運用）になっている（境界が増えている）
  - 429/チャレンジが特定条件でだけ出る（例外条件の存在が示唆される）
- 次の仮説（例）
  - 仮説A：ほぼ全ホストが同一外周に収束し、差分が少ない
    - 次：外周は前提として置き、Web側の機能（認証/認可/API/入力境界）で優先度付けする
  - 仮説B：ホスト/パスでブロック型が分かれ、例外条件がありそう
    - 次：例外が出る境界（ホスト/パス）を固定し、02_webのreconへ渡す（境界モデル化）
  - 仮説C：外周がアプリエラー（型D）を隠しておらず、500等が見える
    - 次：入力境界（05_input）や設定境界（06_config）へ寄せ、最小差分で再現性を取る

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：差分が少ない（同一外周に収束）
  - 次に試すこと：
    - 代表点だけを確定証跡として残し、入口の優先度を「機能（login/api/admin）」に寄せる
    - 03_http/02_tls/05_cloud で“同一に見える理由”を補強し、Web側の検証へ進む
  - 到達点：
    - 外周の存在を前提化し、診断の主戦場をアプリ側へ移せる

- 仮説B：ホスト/パスで型B/Cが分かれ、例外条件が疑われる
  - 次に試すこと：
    - 例外が出る境界（host/path/method/auth状態）を固定し、02_web/01_web_00_recon の入口として採用する
    - 併せて 11_cohosting（同居）で “同一外周でも別運用” の可能性を再評価する
  - 到達点：
    - 「どこで境界が破れている可能性があるか」を証跡付きで提示できる

- 仮説C：型E（到達不可）や、NW境界っぽい挙動が見える
  - 次に試すこと：
    - 08_asn_bgp の境界クラスターと突合し、どのネットワーク境界で到達性が切れているかを説明する
    - NW側の入口（03_network/01_enum）へ接続し、到達性→サービス→認証の順に整理する
  - 到達点：
    - “外周の問題”と“NW到達性の問題”を混同せず、次の観測へ繋げられる

## 手を動かす検証（Labs連動：観測点を明確に）
- 関連 labs：
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`（観測の入口：どこでヘッダ/応答を取るか）
  - `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`（HAR/ログの最小証跡）
- 観測で必ず残すもの（最小セット）：
  - 代表点×数件の raw header（curl相当）
  - 代表点×数件の HAR（ブラウザ相当：チャレンジがある場合に重要）
  - 観測条件メモ（UA/ログイン状態/実行日時/経路）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 目的：代表点の“応答の型（A〜E）”と“成立点”を素早く揃え、クラスター化の材料を作る

# 代表点（例）：トップ/ログイン/API/存在しないパス
curl -sk -D - -o /dev/null "https://example.com/" \
  | sed -n '1,40p'

curl -sk -D - -o /dev/null "https://example.com/login" \
  | sed -n '1,40p'

curl -sk -D - -o /dev/null "https://api.example.com/v1/health" \
  | sed -n '1,40p'

curl -sk -D - -o /dev/null "https://example.com/this-path-should-not-exist" \
  | sed -n '1,40p'

# 観測メモ（例）：
# - status / Location / Set-Cookie / 代表的なエッジ系ヘッダ（要約）を控え、型（A〜E）に分類する
~~~~

## 参考（必要最小限）
- `01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`
- `01_topics/01_asm-osint/05_cloud_露出面（CDN_WAF_Storage等）推定.md`
- `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
- `01_topics/01_asm-osint/11_cohosting_同居推定（共有IP_VHost_CDN収束）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`
- 関連 playbooks：`02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- 関連 labs：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
