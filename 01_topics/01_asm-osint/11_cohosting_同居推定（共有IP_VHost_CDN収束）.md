# 11_cohosting_同居推定（共有IP_VHost_CDN収束）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：V1（アーキテクチャ/信頼境界）・V14（運用/構成）を評価する前提として、同一IP/CDN収束の背後にある「同一アプリ/別アプリ」「同一運用主体/別主体」を境界として固定する。
- WSTG：Information Gathering の一部。サブドメイン列挙（06）で得た入口を、同居（共有）という“運用実態”で束ね、Web側の入口（重要機能/認証/管理）へ優先度付きで渡す。
- PTES：Intelligence Gathering（公開インフラ構造の把握）→ Vulnerability Analysis（境界のズレ/例外パス）へ繋げる。目的は「関連性の断定」ではなく、次の観測の効率化。
- MITRE ATT&CK：Reconnaissance（公開インフラ情報の収集）として位置づける。攻撃者が“探索面を広げる”のと同じ論理を、診断側は“範囲を絞り、境界を説明する”ために使う。

## 目的（この技術で到達する状態）
- 「同一IPに見える」状態を、**CDN/WAF収束、共有ホスティング、VHost（Hostヘッダ）** のどれで起きているか切り分け、資産境界を誤らない。
- “同居の可能性”を **強/中/弱**（根拠の束）で状態化し、無駄に深掘りしないための優先度（代表点）を決められる。
- 08_asn_bgp（ネットワーク境界）・10_ctlog（SAN/Issuer）・03_http（挙動）と結合し、同居の裏にある **運用主体の違い**（第三者境界）を説明できる。

## 前提（対象・範囲・想定）
- 対象：
  - 06_subdomain で得た FQDN→IP（A/AAAA/CNAME）
  - 08_asn_bgp のクラスター（CDN/クラウド/自社ASっぽさ）
  - 10_ctlog のSAN候補（同じ証明書/同じIssuerの束）
- 想定する落とし穴：
  - CDN/WAF配下で多数のFQDNが同一IPへ収束する（= 同一アプリとは限らない）
  - 共有ホスティングで多数のドメインが同一IPに同居する（= 対象外が混ざる可能性が高い）
  - 1つのFQDNが複数IPへ分散（Anycast/地域/冗長）し、観測地点により“同居/非同居”の見え方が変わる
- できること/やらないこと：
  - できる：観測（DNS/TLS/HTTP）の最小差分で「同居っぽさ」を束ねる
  - やらない：同居推定を根拠に対象範囲を拡大する（許可境界は別管理）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 同居を3種類に分ける（最初に分類して迷いを減らす）
- タイプA：CDN/WAF収束（同一CDNのAnycast/エッジで同一IPに見える）
- タイプB：共有ホスティング収束（同一IPに多数の独立ドメインが同居）
- タイプC：VHost（Hostヘッダ）収束（同一IP上でHostにより別サイトを返す）

結論は断定ではなく「タイプA/B/Cの可能性（強/中/弱）」でよい。

### 2) “束”で判断する（単一シグナルで断定しない）
同居推定に使う代表的な束：
- DNS束：
  - CNAME先が同一（= 同一運用基盤の可能性）
  - A/AAAAの収束（= 入口の外形）
- TLS束：
  - 実配信証明書のIssuer/中間CAが同一
  - SANに複数FQDNが同居している（10_ctlogと結合）
- HTTP束：
  - レスポンスヘッダ（Server/Via/CDN系）やリダイレクト先が同一
  - エラー挙動（WAFブロック/チャレンジ/404テンプレ）が同一
- ネットワーク束：
  - Origin AS/プレフィックスが同一（08_asn_bgp）
  - ただしクラウド/巨大ASでは“同一だから同居”とはしない（ノイズが大きい）

### 3) 資産境界・信頼境界・権限境界に落とす（ここが本題）
- 資産境界：
  - 同居クラスターを作り「代表点だけ深掘りする」か「差分が出る点を優先する」か決める
- 信頼境界：
  - 同居が第三者基盤（CDN/ホスティング）で起きている場合、責任分界（誰が直すべきか）を説明できる材料になる
- 権限境界：
  - 同居の中に `admin/id/api/dev/stg` が含まれる場合、Web側の検証（認証/認可/設定）優先度が上がる
  - 逆に、同居していても“重要機能がない”なら代表点確認で止める判断ができる

### 4) 証跡（最低限）
- `cohost_clusters.csv`：
  - cluster_id, fqdn, ip, cname, origin_as, tls_issuer, http_fingerprint（短い要約）
- `cohost_notes.md`：
  - クラスターごとの判定（タイプA/B/C）、強/中/弱、代表点、次に見るファイル（02_web/01_web_00_recon 等）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（状態として）
  - 多数のFQDNが「同一運用基盤に収束していそう」か「共有ホスティングとして雑多に同居していそう」かを区別できる
  - 以降の深掘りを、代表点・差分点に絞れる（効率化）
  - 第三者境界（CDN/WAF/ホスティング）を“証跡つき”で説明できる
- 言えないこと（断定しない）
  - 同居＝同一組織/同一資産の断定（対象外が混ざる可能性がある）
  - 同居の内部構成（どのVHostが何を返すかの全量把握）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- 優先度が上がる条件
  - 同居クラスター内に `admin/id/auth/api/dev/stg/old` が含まれる
  - 同居の束が揺れている（Issuer/挙動が混在）＝境界が多い＝設定差分が出やすい
  - 重要ホストだけ別クラスター（= 分離境界の存在）
- 次の仮説
  - 仮説A：CDN収束が強く、IP同居は“入口の外形”に過ぎない
    - 次：HTTP/TLS差分でクラスターを細分化し、Web側は機能（認証/認可/API）で優先度付け
  - 仮説B：共有ホスティング同居が濃く、対象外が混ざる
    - 次：スコープを壊さないよう、FQDN起点でのみ追う（IP起点で広げない）
  - 仮説C：VHost同居が濃く、Hostによる挙動差が明確
    - 次：代表点で 02_web/01_web_00_recon へ渡し、入口・境界・検証方針を固める

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：CDN/WAF収束（タイプA）が強い
  - 次に試すこと：
    - 代表FQDNを少数選び、TLS（Issuer/SAN）とHTTP（ヘッダ/リダイレクト/エラー）で差分が出るか確認
    - 差分が出ないなら、同居クラスターを“まとめ枠”として扱い、Web側の機能優先へ移る
  - 到達点：
    - 「CDN収束で同居に見えるだけ」を証跡つきで説明でき、無駄な深掘りを止められる

- 仮説B：共有ホスティング同居（タイプB）が濃い
  - 次に試すこと：
    - 同居IPを起点に範囲を増やさず、06_subdomain/10_ctlog由来のFQDNだけを対象に扱う
    - 07_whois_rdap で組織境界（owner/operator）を補強し、対象外混入を早期に疑う
  - 到達点：
    - “対象外が混ざる”前提で、スコープ逸脱を避けた運用に切り替えられる

- 仮説C：VHost同居（タイプC）が濃い（Hostで明確に挙動が変わる）
  - 次に試すこと：
    - `admin/id/api` 等の重要ホストを優先し、02_web/01_web_00_recon で入口・境界・検証方針を確定する
    - 重要ホストが見当たらないなら代表点のみ確認し、優先度を下げる
  - 到達点：
    - 同居の“差分がある場所”に時間を寄せられる

## 手を動かす検証（Labs連動：観測点を明確に）
- 関連 labs：
  - `04_labs/01_local/01_attack-box_作業端末設計.md`（結果の保存・差分管理）
  - `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`（代表点のHTTP/TLS証跡）
- 取得する証跡（目的ベースで最小限）：
  - FQDN→IP/CNAME（DNS）
  - 代表点のTLS（Issuer/SAN）
  - 代表点のHTTP（ヘッダ/最終URL/エラーパターン）
- 観測の取り方：
  - 「同居の束」を作るため、全量ではなく“代表点×少数”で差分を取る（深掘り前提の絞り込み）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 目的：同一IPに収束するFQDN群をまとめ、代表点で“束（DNS/TLS/HTTP）”を取る

# (1) FQDN→IPを集める（既にresolved.txt等がある前提でもよい）
dnsx -l candidates.txt -a -aaaa -cname -silent > resolved.txt

# (2) 代表点のHTTP指紋（ステータス/最終URL/主要ヘッダ）を取る
httpx -l resolved.txt -silent -status-code -follow-redirects -final-url -title > http_fingerprint.txt

# (3) 代表点のTLS（Issuer/SAN）を取る（“同じ証明書運用か”の材料）
# ※対象ホストを少数に絞って実行する（全量で回さない）
echo | openssl s_client -connect login.example.com:443 -servername login.example.com 2>/dev/null \
  | openssl x509 -noout -issuer -dates -ext subjectAltName
~~~~
- 観測していること：
  - “同一IP”という見かけの一致を、DNS/TLS/HTTPの束で補強または否定する

## 参考（必要最小限）
- `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
- `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
- `01_topics/01_asm-osint/10_ctlog_証明書拡張観測（SAN_ワイルドカード_中間CA）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
- 関連 playbooks：`02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`