# vdp_scope_制約下での低アクティブ観測設計

## 目的（この技術で到達する状態）
VDP（Vulnerability Disclosure Program）や契約上の制約下で、過度なスキャン/負荷/認証試行を避けつつ、ASM/OSINTとして「観測→判断→次の一手」を成立させる設計（scope_key_plan）を作れる状態にする。
- scope（対象/非対象/禁止行為）を “行為単位” に分解し、迷わず実行できる
- 低アクティブ（最小リクエスト）でも、攻撃面（endpoint）と境界（資産/信頼/権限）を確度高く確定できる
- 収集物（証跡）と報告物（再現性）の粒度を揃え、VDPで通る形にできる
- 既存トピック（14〜22）で得た成果物を「制約に沿って使い回す」ための接続点を持つ

## 前提（対象・範囲・想定）
- VDP の “scope文章” は曖昧なことが多い。曖昧さは「解釈」ではなく「保守的な運用ルール」で吸収する
- 低アクティブとは「安全で無害」ではない。最小リクエストでも影響が出る可能性がある（特に認証、ファイル、検索）
- 本ファイルの目的は “やり方の工夫” であり、禁止行為の回避テクニックではない
- 重大性の高い兆候（P0）が出た場合は “深追いせず、証跡を整えて報告/確認へ” が原則

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) scope を “行為単位” に分解する（解釈の一貫性）
scope は「対象URL」だけでなく「許可される行為」が本質。
- 対象資産：ドメイン/サブドメイン/IP/アプリ/モバイル/メール/クラウド
- 対象外資産：関連会社/旧ブランド/第三者SaaS（どこまで許可か）
- 禁止行為：自動スキャン、DoS、認証総当たり、ソーシャル、破壊的操作、データ改変、マルウェア、外部者への影響
- 許可行為：手動確認、低頻度アクセス、OSINT、限定的な検証（明記がある場合）

行為単位ラベル（例）
- passive_osint：検索・DNS・CT・公開ドキュメント
- low_http_probe：既知URLへの最小HTTP（1回程度、軽量）
- auth_flow_observe：認証フローの観測（ログイン試行の連打はしない）
- upload_or_state_change：状態変更を伴う可能性（原則避ける/明示許可が必要）

### 2) 低アクティブ観測の「最小セット」を定義する
低アクティブは “手数” と “負荷” と “影響” の3軸で設計する。
- 手数：1資産あたりのリクエスト数上限（例：1〜3）
- 負荷：サイズ（HEAD優先、GETでも小さいものに限定）
- 影響：状態変更・メール送信・課金・通知など副作用の可能性

最小セット（例）
- DNS/CT（リクエストはDNSのみ）：01_dns/02_tls に相当
- HTTP（既知URLの1回）：03_http の “観測” のみ（クロール/総当たり禁止）
- 公開物（GitHub/CI/Docs）：16/17 の “証跡化” のみ（実トークン利用禁止）
- モバイル/タグ解析：21/22 の “静的抽出” のみ

### 3) 証跡設計（VDPで通る粒度）を先に決める
VDPでは「再現性」と「影響最小」が重要。観測のたびに以下を残す。
- いつ：日時（JST）
- どこ：URL/ドメイン/参照元（source_locator）
- なに：観測した事実（レスポンス要約、DNS値、CT証明書など）
- どれくらい：リクエスト回数、サイズ、影響（状態変化の有無）
- なぜ：それがリスクにつながる理由（推定は分離して書く）
- 次に：追加確認が必要な場合の “許可依頼ポイント”（何をすれば確定するか）

### 4) scope_key_plan（後工程に渡す正規化キー）
- scope_key_plan（推奨）
  - scope_key_plan = <program> + <asset_set> + <allowed_action_set> + <forbidden_action_set> + <rate_limit_rule> + <evidence_rule> + <escalation_rule>
- asset_set（例）
  - in_scope_domains / out_of_scope_domains / third_party_excluded
- rate_limit_rule（例）
  - max_req_per_host=3, no_bruteforce, no_crawl
- escalation_rule（例）
  - P0 detected -> stop & report, request permission for deeper validation

記録の最小フィールド（推奨）
- scope_text_locator: scope文章の参照箇所（URL/スクショ）
- interpretation_rules: 保守的ルール（後述）
- allowed_actions / forbidden_actions
- per_asset_limit: 回数/サイズ/時間の上限
- evidence_template: 何を残すか
- stop_conditions: 中断条件（P0）
- permission_request_points: 追加許可が必要な行為一覧

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（この設計で到達できる）
  - 制約下でも、攻撃面と境界を一定精度で確定でき、報告可能な証跡が揃う
  - “次に何をすれば確定するか” を、許可依頼として具体化できる（VDPとの交渉点）
  - 深追いせずに、重大兆候（P0）を早期に見つけたら止まれる
- 言えない（この設計だけでは確定しない）
  - 実際の脆弱性確定（多くは追加検証が必要）
  - 影響範囲（本番データ閲覧/改変など）の確証（副作用のある確認は許可が必要）
  - 禁止行為の境界が不明な場合の最終判断（運営への確認が必要）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
※ここは“攻撃”ではなく「どこで止めるか」「どこに集中するか」の意思決定。
### 優先度（P0/P1/P2）と中断条件（Stop rule）
- P0（即中断＋報告/許可依頼へ）
  - secret（鍵/トークン）露出が高確度（16/17）
  - 認証不要で機微情報が見える示唆（03_httpの1回観測で判明）
  - 公開ストレージの疑い（18）で “顧客/バックアップ/ログ” 系が見える示唆
- P1（低アクティブで継続観測）
  - stg/dev 面の存在（18/22）や、重要導線の外部依存（21）
  - API仕様公開（15）で面が大量に見える（ただし総当たり検証はしない）
- P2（情報整備）
  - ブランド/類似ドメイン（20）の候補整理、メール基盤（19）の成熟度整理

### “攻め筋”ではなく“観測設計”としての集中点
- 低アクティブで確度が上がる領域に集中する
  - 公開物（GitHub/CI/Docs）からの漏えい（16/17）
  - 仕様公開（15）と静的解析（14/21/22）
  - DNS/CT（01/02/20）
- 低アクティブだと危険/誤判定が増える領域は “許可依頼ポイント” に回す
  - 認証試行の繰り返し、パスワードリセット、メール送信、アップロード、状態変更、負荷の高い検索

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：scope文章が曖昧で、どこまで許されるか不明
- 次の一手（保守的ルールで固定）
  - “自動化はしない”“1ホスト数リクエストまで”“状態変更はしない” を既定にする
  - 不明な行為は “permission_request_points” に積む（勝手に進めない）
  - 低アクティブで価値の高い OSINT（DNS/CT/公開物/静的解析）に寄せる

### 仮説B：P0兆候が出た（重大だが確証のための追加検証が必要）
- 次の一手
  - 追加検証をしないで止める（副作用や規約違反の回避）
  - 証跡を整える（何がどこに、どの程度の確度で、なぜ危険か）
  - “確定に必要な最小追加行為” を明文化し、運営へ許可依頼（例：この1回のアクセス/この操作のみ）
  - 可能なら “影響確認は運営側ログ確認” を提案する（こちらで操作しない）

### 仮説C：低アクティブだと情報が不足する（P1/P2しか集まらない）
- 次の一手
  - 14〜22 の成果物を相互参照して確度を上げる（単体で確証を求めない）
  - 追加行為の候補を “許可依頼” としてまとめる（スキャン許可、検証環境、テストアカウント等）
  - 24_subdomain_takeover や 25_dnssec のように、DNS系で確度を上げられる領域へ寄せる

#### 最小の運用ルール例（制約下の自己ルール：例示のみ）
~~~~
- 既知URLのみ（ディレクトリ総当たり/クローリングしない）
- 1ホストあたり最大3リクエスト、サイズは小さいものを優先
- 認証試行は連打しない（1回の観測で十分な範囲に限定）
- 状態変更（送信/作成/削除/更新）は行わない
- P0兆候が出たら即停止し、証跡を整えて報告へ
~~~~

## 不明点（ここが決まると精度が上がる：回答は短くてOK）
- 低アクティブの上限を固定するか（例：1ホスト最大3リクエスト、時間あたり上限等）
- “状態変更扱い” の定義をどこまで厳しくするか（メール送信/パスワードリセット/アップロード等）
- P0兆候時の方針：即報告のみで固定か、運営から許可が出たら最小追加検証まで行うか

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - V1（アーキ/要件）：境界（資産/信頼/権限）を定義し、検証の前提を明確化する
  - V14（設定）：公開物/設定/ログの露出は低アクティブでも検出可能で、優先度が高い
  - V2/V3（支える前提）：認証・セッションは副作用が出やすく、制約下では観測設計が重要
- WSTG：
  - INFO：公開情報中心で攻撃面を収集し、制約下での検証計画を組む
  - 一般：安全なテスト設計（負荷/副作用/許可）を前提に、手順を選ぶ
- PTES：
  - Pre-engagement（支える前提）：許可範囲/制約/ルールを明確化し、実施計画に落とす
  - Intelligence Gathering：低アクティブで価値の高い収集を優先する
- MITRE ATT&CK：
  - Reconnaissance：公開情報からの収集に集中する設計
  -（支える前提）Testing/Validation：制約下で“確定に必要な最小行為”を整理して許可依頼する

## 参考（必要最小限）
- 代表的なVDPの制約パターン（自動スキャン禁止、DoS禁止、ソーシャル禁止 等）
- “証跡中心” の報告設計（再現性・影響最小・確度ラベル）
- 低アクティブでも価値が高い情報源（DNS/CT/公開物/静的解析）