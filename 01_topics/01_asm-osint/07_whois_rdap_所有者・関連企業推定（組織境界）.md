# 07_whois_rdap_所有者・関連企業推定（組織境界）.md

## 目的（この技術で到達する状態）
- WHOIS/RDAPを「登録情報を見る手段」ではなく、**組織境界（owner / operator / vendor / reseller）** を切り分けるための“証跡”として扱える。
- ドメイン/AS（次ステップ）/IP/ネームサーバの情報を束ね、**同一組織っぽさ** と **委託運用っぽさ** を観測差分で説明できる（yes/no/unknownで落とす）。
- サブドメイン列挙（06）で見つけた資産を、WHOIS/RDAPで **優先度付け（重要度・交渉先・責任所在）** し、次の調査（ASN/BGP、PassiveDNS、CT、第三者依存）に繋げられる。

## 前提（対象・範囲・想定）
- 対象：主に「ドメイン名（登録）」と「IP/AS（割り当て）」の所有/運用情報。
- WHOIS：
  - 典型的に“テキスト”で返り、TLD/レジストラ/レジストリで出力が揺れる。
  - GDPR等で登録者情報が赤塗りになりやすい（= 直接の所有者名が取れないケースが増える）。
- RDAP：
  - HTTP/JSONベースで、ドメイン・IP・ASの登録情報を“構造化”して取れる。
  - レート制限や認証要求がある場合がある（= 取り過ぎない設計が必要）。
- 想定する落とし穴（章は作らない）：登録情報が取れても、それが「運用者」ではない（CDN/ホスティング/代理登録/グループ会社/買収後の名残）。

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) “主体”を4種類に分けて観測する（境界モデル）
- Owner（法的所有者・ブランド主体）：その資産の最終責任を負う組織
- Operator（運用主体）：インフラ/アプリを運用している主体（委託先を含む）
- Registrar/Registry（登録業者/管理組織）：登録の窓口/上位管理（必ずしもOwnerではない）
- Privacy/Proxy/Reseller（代行・秘匿・再販）：Owner情報を覆い隠す層

観測のポイントは「誰が出ているか」ではなく、
**どの層の情報しか取れていないか** を切り分けること。

### 2) ドメイン（FQDN）→ レジストリ/レジストラ/ネームサーバの確定
最低限の“境界情報”として次を取る（取れない場合はunknownでよい）。
- TLD（.com/.jp 等）：レジストリの支配範囲
- Registrar（登録業者）：移管/失効/ロック等の手続き主体（ただしOwnerとは限らない）
- Nameserver（NS）：運用の匂いが強い（自社/クラウドDNS/マネージドDNS）

判断の要点
- NSがクラウドDNS（Route53等）でも、それは「運用経路」であってOwner断定ではない
- NSが独自ドメイン配下（ns1.example.com等）なら、運用主体の可能性が上がる（ただし委託もある）

### 3) “関連企業推定”は、登録情報の一致ではなく“束”で見る
登録者名が取れない/揺れる前提で、以下の束で同一性を推定する（断定しない）。
- レジストラ一致（同じ窓口で多数ドメイン）
- NSパターン一致（同一DNS運用基盤）
- 連絡先ドメイン/abuse先の一貫性（ある場合）
- 登録更新・有効期限の周期の類似（更新運用の匂い）
- 同一リダイレクト/同一TLS/同一CDN（別ステップの観測と接続）

出力は「同一と断定」ではなく、
- 強い（複数の束が一致）
- 中（束が一部一致）
- 弱い（ほぼ一致なし）
のように扱い、次の手を決めるために使う。

### 4) RDAP/WHOISの“欠落”自体も情報（yes/no/unknown）
- 登録者が完全に赤塗り：owner推定は別ソース（CT/PassiveDNS/サイト記載/採用情報等）に寄せる
- Privacy/Proxyが明示：運用実態の推定を優先（CDN/WAF/ホスティング/同居推定へ）
- レート制限/認証要求：自動化は慎重にし、対象を絞る（“全部取る”はやらない）

### 5) 06_subdomain の結果を“優先度付け”に変換する
サブドメインが多いほど、全部は追えない。WHOIS/RDAPで「攻め筋の入口」を選別する。
- 企業ドメイン直下（brand直結） vs サービス委託臭（vendor名が匂う）
- 複数TLD/国別TLDの分散（地域運用/買収/事業部境界の可能性）
- 登録/運用が混在（統制の弱い領域＝設定ミスが出やすい“候補”）

### 6) 最小の証跡（差分を説明できる形）
- ドメインごとの観測メモ（3点だけでよい）
  - Registrar / NS / RDAPで見える組織（entity/remarks等）
- “束”の一致/不一致（強/中/弱）
- unknownの理由（赤塗り・制限・情報欠落）

#### コマンド例（例示は最小限）
~~~~
# ドメインWHOIS（出力は揺れる。必要行だけ抜く）
whois example.com | sed -n '1,80p'

# RDAP（構造化。TLD/レジストリによりエンドポイントが異なるので、まずは結果が返る範囲で）
curl -s "https://rdap.org/domain/example.com" | head

# IP/AS側は次ステップ（ASN/BGP）で深掘りするが、入口としてRDAPを確認
curl -s "https://rdap.org/ip/203.0.113.0" | head
~~~~

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること
  - “登録の窓口”と“DNS運用の匂い”は観測できる（Registrar/NS）
  - 赤塗り/Proxy/欠落があるなら、それは「登録情報ではowner確定できない」という確定情報
  - サブドメイン群を「統制されていそう/されてなさそう」に優先度付けできる
- 言えないこと（断定しない）
  - 登録情報＝運用主体/所有主体（委託・代行・買収・グループ会社で崩れる）
  - 企業の内部構造（事業部/子会社関係）はWHOIS単体では断定できない
- 典型的な到達点
  - 組織境界が “owner候補A / operator候補B / vendor候補C” として分解でき、次にどこを調べるかが決まっている状態

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- 優先度を上げる条件（攻め筋の入口になりやすい）
  - 登録/運用が事業ごとにバラバラ（統制が弱い領域が混ざる）
  - 古いドメイン/更新が途切れがち（運用放置の可能性）
  - NSが第三者運用へ分散（委託境界が増え、設定差分が出やすい）
- 次の仮説の立て方（例）
  - 仮説A：グループ会社/買収由来で“統制の弱い資産群”が混ざっている
    - 次：PassiveDNS/CTで過去資産と接続し、同一クラスターを探す
  - 仮説B：運用委託（CDN/WAF/ホスティング）が境界を作っている
    - 次：同居推定（11）・WAF/CDN挙動観測（12）で運用主体を寄せる
  - 仮説C：IP側（AS）で見ると“明確に別組織”に分かれる
    - 次：ASN/BGP（08）でネットワーク境界として確定する

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：登録情報が赤塗りでowner断定が難しい（unknownが多い）
- 次に試すこと
  - NS/レジストラ/証明書/外部依存（タグ・SDK）など“運用の束”で同一性を寄せる
  - 08（ASN/BGP）と09（PassiveDNS）を先に進め、過去・ネットワーク境界で補強する
- 到達点
  - ownerは断定しないが、運用クラスター（同一っぽい資産群）として扱える

### 仮説B：複数束が一致し、同一組織クラスターが強い
- 次に試すこと
  - 06のサブドメイン一覧を“クラスター単位”で並べ替え、攻撃面の多いクラスターから深掘りする
  - 10（CTログ）や11（同居推定）で外部依存と露出面を増やし、入口を太くする
- 到達点
  - 「この組織境界に対して、次に何を観測すべきか」が決まる

### 仮説C：Registrar/NSが明確に分かれ、“別組織運用”が濃厚
- 次に試すこと
  - 12（WAF/CDN挙動）で運用境界の差分（ブロック/チャレンジ/例外）を観測する
  - 21（第三者依存）で、タグ/SDK/外部連携の面を洗い出す
- 到達点
  - owner/operator/vendorを分解したまま、境界ごとに攻め筋を設計できる

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 直接の要件ではなく、V1（アーキテクチャ/信頼境界）やV14（構成/運用）を評価する際の「外部依存・責任分界」を明確化する前提として接続する。
  - 例：認証やセッションの例外パス（SSO/回復/委託運用）がどの主体に属するかを、報告でブレなく説明する材料になる。
- WSTG：
  - WSTG-INFO（Information Gathering）に相当する“資産の帰属・境界”の確定として扱う。
  - 以降のテスト（AUTHN/AUTHZ/CONFIG）で「どこが対象範囲で、どこが第三者か」を明示するための前提。
- PTES：
  - Intelligence Gathering（組織/インフラ情報の収集）で、対象の“責任境界”を言語化する作業として位置づける。
  - 収集→分析→次の観測（ASN/BGP、PassiveDNS、CT）に繋げるための中間成果物。
- MITRE ATT&CK：
  - Reconnaissance（組織情報・ドメイン/インフラ情報の収集）として位置づける。
  - 目的は攻撃手順の最適化ではなく、防御側の診断として「境界がどこで増えているか」を説明可能にすること。

## 参考（必要最小限）
- `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
- `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
- `01_topics/01_asm-osint/09_passive-dns_履歴と再利用（過去資産の掘り起こし）.md`
- `01_topics/01_asm-osint/10_ctlog_証明書拡張観測（SAN_ワイルドカード_中間CA）.md`
