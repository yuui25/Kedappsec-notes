# dnssec_観測と意味（委譲_検証_誤設定）

## 目的（この技術で到達する状態）
DNSSEC を ASM/OSINT の範囲で観測し、委譲（DS）〜検証（DNSKEY/RRSIG）〜誤設定（bogus/破綻）までを「証跡つき」「優先度つき」で説明できる状態にする。
- dnssec_key_posture として、対象ドメインの DNSSEC 成熟度（有効/無効/破綻の疑い）を整理できる
- “DNSの信頼境界” を言語化できる（DNS改ざん・キャッシュ汚染等への耐性の前提）
- 誤設定がある場合、可用性リスク（名前解決不能）や境界破綻の兆候を、低アクティブで提示できる
- 01_dns（委譲の解釈）、02_tls（証明書/CT）、20_brand_assets（関連ドメイン）に接続し、全体のASM設計に統合できる

## 前提（対象・範囲・想定）
- 原則は OSINT：DNSクエリと公開情報のみ（状態変更なし、負荷は軽い）
- DNSSEC は「有効＝万能」ではない（DNSの完全性を強化するが、運用ミスで可用性を落とす）
- 本ファイルでは “DNSSECの実装” ではなく “観測と意味づけ（判断）” を主に扱う
- 企業ドメインはサブドメイン委任が多い。親と子で DNSSEC 状態が異なる前提で観測する

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) DNSSEC を “委譲チェーン” として見る
DNSSEC は「親ゾーンが子ゾーンを信頼してよい」という鎖（chain of trust）。
- 親（example.com の親＝.com）が DS を持つ → 子ゾーンの DNSKEY と一致 → 署名（RRSIG）が検証できる
- どこかで鎖が切れると、検証リゾルバは bogus（不正）として扱い、名前解決が失敗し得る

観測の要点（OSINTで見る範囲）
- DS レコードの有無（親側の委譲があるか）
- DNSKEY の有無（子側が鍵を公開しているか）
- RRSIG の有無（署名付き応答が返るか）
- 検証結果（ADフラグなど）や、検証失敗の兆候（SERVFAIL等）

### 2) “有効/無効/破綻” を分ける観測シグナル
- 無効（unsigned）
  - DS が無い（親が委譲していない）
  - DNSKEY/RRSIG が返らない
- 有効（signed & validating）
  - DS がある（親に登録されている）
  - DNSKEY/RRSIG が返る
  - 検証済みの兆候（検証リゾルバで AD フラグなどが立つ）
- 破綻の疑い（bogus / misconfig）
  - DS はあるが DNSKEY が合わない/署名が壊れている
  - 検証リゾルバ経由で SERVFAIL が出る（検証失敗の可能性）
  - 一部のリゾルバだけ解決できない（利用者影響の兆候）

※OSINTでは「兆候」として扱い、断定は運用側確認へ繋ぐ。

### 3) “誤設定” が起きやすいポイント（意味づけ）
DNSSEC運用の事故は、信頼の鎖の更新で起きやすい。
- 鍵ロールオーバ（KSK/ZSK更新）で DS 更新が追従しない
- ゾーン移行（DNSプロバイダ変更）で DS/DNSKEY が不整合
- 署名期限切れ（RRSIG expiration）で検証失敗
- 委譲先（サブドメイン）で DNSSEC 状態が親と不一致（運用境界のズレ）

ASMとしては「攻撃」より「可用性＋境界健全性」の観点が強い。

### 4) dnssec_key_posture（後工程に渡す正規化キー）
- dnssec_key_posture（推奨）
  - dnssec_key_posture = <domain> + <ds_present> + <dnskey_present> + <rrsig_present> + <validation_hint> + <misconfig_hint> + <confidence>
- validation_hint（例）
  - ad_set | validates | unknown
- misconfig_hint（例）
  - servfail_on_validating_resolver | ds_dnskey_mismatch_suspected | rrsig_expired_suspected | none | unknown

記録の最小フィールド（推奨）
- source_locator: 取得日時（JST）＋問い合わせ先（どのリゾルバ/ツールか）
- domain: 対象
- ds: 有無/要点
- dnskey: 有無/要点
- rrsig: 有無/要点
- validation_hint: 検証済み兆候
- misconfig_hint: 誤設定兆候
- confidence: high/mid/low
- action_priority: P0/P1/P2

#### 最小の観測例（DNSSEC関連の問合せ：例示のみ）
~~~~
# DS（親側委譲の有無を見る）
dig +dnssec +short DS example.com

# DNSKEY（子側の鍵）
dig +dnssec +short DNSKEY example.com

# 署名付き応答（A等にRRSIGが付くか）
dig +dnssec example.com A

# 検証を意識（ADフラグ等は環境依存）
# 例：検証するリゾルバ（手元/公共）を使う場合は「どのリゾルバで見たか」を証跡に残す
~~~~

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（OSINTで確定できる）
  - DNSSEC が “設定されている/いない” の大枠（DS/DNSKEY/RRSIG の有無）
  - 検証失敗を示唆する兆候（SERVFAIL等）が見えるかどうか
  - サブドメイン委任がある場合、どこで状態が変わるか（運用境界の示唆）
- 言えない（この段階では確定しない）
  - 検証失敗の原因の断定（ロールオーバ失敗、移行事故等）
  - 影響範囲（どの利用者/リゾルバで発生するか）※追加観測が必要
  - 攻撃の有無（DNSSECは攻撃検知ではなく改ざん耐性の仕組み）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
※DNSSECは“攻撃の入口”というより「境界健全性」。ここでは意思決定として扱う。
### 優先度（P0/P1/P2）
- P0（即時に運用確認が必要）
  - DNSSEC破綻の疑いが強い（検証リゾルバでSERVFAIL、DSありなのに検証不能など）
  - 重要導線（auth/billing/support等）のドメインで、名前解決不安定の兆候（可用性に直結）
- P1（優先的に棚卸し/成熟度評価）
  - DNSSECは有効だが、委譲やサブドメインが多く、運用境界が複雑（移行/更新の事故リスク）
  - 関連ドメイン（20_brand_assets）でDNSSEC状態がバラバラ（周辺弱点の示唆）
- P2（情報整備）
  - DNSSEC未導入（必ずしも脆弱性ではないが、境界強化の余地として記録）
  - 小規模/非重要ドメイン（影響が限定）

### 後続トピックへの接続（地続き）
- 01_dns：委譲の境界（NS/サブドメイン委任）と合わせて “どこで運用が分かれているか” を説明する
- 02_tls：DNSが破綻するとTLS/HTTPS以前に到達できない（可用性/信頼の前提）
- 20_brand_assets：類似ドメイン群の成熟度差（DNSSEC/DMARC等）を周辺リスクとして比較する
- 23_vdp_scope：P0兆候が出たら深追いせず、証跡＋運用確認（またはVDP報告）へ

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：DNSSECが無効（DSなし）で、特に問題兆候はない
- 次の一手
  - “未導入” を dnssec_key_posture として記録（P2）
  - 他の境界（TLS/HTTP/メール）と合わせて、優先度が上がる要因があるかを見る（単体では致命でないことが多い）
  - 関連ドメイン（20）も同様に観測し、統制の一貫性を評価する

### 仮説B：DNSSECが有効（DS/DNSKEY/RRSIGあり）で、検証も良さそう
- 次の一手
  - “有効” を posture として記録（P2〜P1）
  - サブドメイン委任が多い場合は、重要サブドメインだけ追加観測（低アクティブで点検）
  - 移行/更新時の事故が起きやすい点を運用リスクとしてメモ（攻撃面ではなく運用境界）

### 仮説C：DNSSEC破綻の疑い（SERVFAIL等）がある（P0/P1）
- 次の一手（OSINTの安全域）
  - どの条件で発生するかを “最小” で切り分ける（例：検証リゾルバAでは失敗、Bでは成功）
  - DS/DNSKEY/RRSIGの有無を証跡化し、“鎖が切れている可能性” を説明できる形にする
  - 影響が大きい導線（auth/support等）なら深追いせず、運用/VDPへ報告・確認へ
- 次の一手（運用側への依頼）
  - 鍵更新/プロバイダ移行/署名期限の状況を運用側で確認してもらう（こちらで状態変更しない）

#### 最小の切り分け例（“条件差” の証跡：例示のみ）
~~~~
- 同じ問い合わせを「別リゾルバ」で実行し、結果差分（NOERROR/SERVFAIL等）を記録
- DS/DNSKEY/RRSIGの有無を並べる
- 重要サブドメイン（login/support等）が同様かを 1〜2件だけ追加観測
~~~~

## 不明点（ここが決まると精度が上がる：回答は短くてOK）
- DNSSEC観測は「親ドメイン＋重要サブドメイン数件」を既定セットにするか（点検範囲）
- “検証リゾルバ” を固定するか（どの環境で見たかを常に記録する運用で統一してよいか）
- 23_vdp_scope を前提に、SERVFAIL等のP0兆候は “即停止＋報告” を既定にするか（本ファイルは既定前提）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - V14（設定）：DNS運用（委譲・署名・更新）の誤設定は可用性と信頼境界に直結する
  - V1（アーキ/要件）：資産境界（DNS委譲/プロバイダ）を定義し、運用変更のリスクを管理する
  - V2（支える前提）：認証・回復導線はDNSの健全性が前提（名前解決不能＝利用不能）
- WSTG：
  - INFO：公開情報（DNS）から境界（委譲・署名）を収集し、意味づけする
  - CONF（支える前提）：設定ミス（DNSSEC破綻）は重大インシデントにつながり得るため、早期発見が重要
- PTES：
  - Intelligence Gathering：DNSSEC状態を収集し、境界健全性として評価する
  - Threat Modeling（支える前提）：DNS改ざん耐性と運用事故リスクを、全体の前提として組み込む
- MITRE ATT&CK：
  - Reconnaissance：DNS公開情報から運用境界を把握
  -（支える前提）Impact：DNS破綻は可用性に影響し得るため、リスク評価の入力として扱う

## 参考（必要最小限）
- DNSSEC（DS/DNSKEY/RRSIG）の役割と “委譲チェーン” の概念
- 検証失敗（bogus）と SERVFAIL の関係（断定はせず、兆候として扱う）
- 鍵ロールオーバ/プロバイダ移行で起きやすい運用事故の一般像