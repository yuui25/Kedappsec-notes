# 09_passive-dns_履歴と再利用（過去資産の掘り起こし）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：V1（アーキテクチャ/境界）とV14（運用・構成）を評価する前提として、過去の到達面・委託境界・残存資産を“状態”として確定する（直接の脆弱性項目ではなく、以降の検証範囲と責任分界をブレさせないため）。
- WSTG：Information Gathering の一部として、現在DNSで見えない入口（過去資産/旧サブドメイン/旧IP）を掘り起こし、Web入口（ホスト/経路/認証面）へ接続する。
- PTES：Intelligence Gathering（履歴からの資産境界の復元）→ Vulnerability Analysis（残存/再利用/例外パスの疑い）へ繋げる。
- MITRE ATT&CK：Reconnaissance（公開インフラ情報の収集・変遷把握）として位置づけ、攻撃者が「忘れられた入口」を探す論理を、診断側の“優先度付け”に転用する。

## 目的（この技術で到達する状態）
- passive DNS（履歴観測）を用いて、**現在の列挙だけでは見えない入口**（過去のFQDN、過去の解決先IP、過去のCNAME先）を復元し、検証優先度へ変換できる。
- 履歴データを「真実」とせず、**観測対象（いつ・どこで・誰が見た履歴か）** と **現在観測（DNS/TLS/HTTP）** を突合して、yes/no/unknownで状態化できる。
- 06_subdomain（現在の入口）と 08_asn_bgp（ネットワーク境界）に、履歴軸（過去→現在）を足して、**残存資産・委託境界・移行の痕跡** を説明できる。

## 前提（対象・範囲・想定）
- 対象：
  - 06_subdomain で得た FQDN 群（現在）
  - そのルートドメイン/主要サブドメイン（過去の履歴を掘る起点）
  - 08_asn_bgp で得た IP/ASN クラスター（過去に紐づいたIPの再確認）
- 想定する環境：
  - CDN/WAF/クラウド移行があり、IPやCNAME先が頻繁に変わる
  - 事業売却/買収/委託変更により、過去のFQDNが別運用主体へ移ることがある
- できること/やらないこと（安全に検証する範囲）：
  - できる：履歴データの収集、差分の状態化、現状DNS/HTTPでの“存在確認”まで
  - やらない：履歴で見えたIPレンジを根拠にスキャン範囲を拡大する（許可境界を壊さない）
- 依存する前提知識（必要最小限）：
  - `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
  - `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
  - `01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`（レコードと委譲の基礎）
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`（到達後の差分観測）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 「FQDN → レコード（A/AAAA/CNAME 等） → 値（IP/別名）」の履歴（first_seen/last_seen/回数/ソース）
  - 「IP → 逆引き的な関連FQDN集合」の履歴（同居・共有・移行の痕跡）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：
    - 過去に“自社っぽい”FQDNが存在したとしても、現在は別主体へ移っている可能性がある。
    - 履歴から「当時の資産境界」を復元し、現在の境界と差分（移行/売却/委託）として扱う。
  - 信頼境界（外部連携・第三者・越境ポイント）：
    - CNAMEが外部サービスに向く履歴、過去IPがホスティング/CDNに乗る履歴は、第三者境界の増減を示す。
    - “いつから第三者に寄ったか”は、設定・運用の変遷として重要。
  - 権限境界（権限の切替/伝播/委任）：
    - `id.` / `auth.` / `admin.` / `api.` のような機能境界が、過去に存在していたか（= 例外パスの候補）。
    - 過去に存在した管理系入口が、別ドメインへ移った痕跡（リダイレクト/別名化）も観測対象。
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - first_seen / last_seen（過去資産か、直近まで生きていたか）
  - 変更前後のレコード種別（A→CNAME、CNAME先変更、MX/NS変更など）
  - IPの性質（クラウド/ホスティング/自社AS っぽさ：08_asn_bgp と結合して判断）
  - “履歴で見えるが、現在は解決しない”状態（残存/撤去/再利用の分岐点）
  - “履歴で見えないが、現在は解決する”状態（履歴ソース偏り：unknownとして扱う）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか：
  - 履歴データとして「過去にそのFQDNが、どの値へ解決していたか」という“観測事実”
  - 過去→現在の差分（現在解決する/しない、CNAME先が変わった等）の“状態”
- 何が“推定”できるか（推定の根拠/前提）：
  - 移行の痕跡（クラウド移行、CDN導入、委託変更、事業分割）を「DNSの変遷」として推定
  - 忘れられた入口の候補（過去の`dev/stg/old/admin`等が残存している可能性）
- 何は“言えない”か（不足情報・観測限界）：
  - 履歴の完全性（どの観測点/リゾルバ/センサーで収集されたかに依存する）
  - 所有/責任の断定（07_whois_rdap、08_asn_bgp、05_cloud推定、HTTP挙動と束ねる必要）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：履歴は大量だが、現状で解決するのは一部（過去資産が多い＝優先度付けが重要）
  - パターンB：過去に自社ASっぽいIPがあり、現在はCDNへ収束（移行が進んだ状態）
  - パターンC：過去の環境系FQDNが“直近まで”生きていた（残存資産の疑いが強い）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”：
  - 「過去に存在し、直近まで生きていた」入口（last_seenが新しい）＝運用漏れ・例外パスの候補
  - `dev/stg/old/backup/admin` 等の命名履歴＝統制差が出やすい領域
  - 過去CNAME先が第三者で、現在は解決しない＝委託境界・再利用・設定ミスの候補（ただし断定しない）
- 優先度の付け方（時間制約がある場合の順序）：
  1) last_seenが新しい履歴（直近まで存在）を優先
  2) 名前が示す環境差/権限差（admin/id/api/dev/stg/old）
  3) 08_asn_bgpで“自社ASっぽい”境界に紐づく過去IP（ただし範囲拡大はしない）
  4) CDN/ホスティング収束の履歴は“第三者境界の変遷”として整理し、Web入口（FQDN）優先で追う
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：履歴候補FQDNを少数に絞り、現状DNS/HTTP/TLSで存在確認→入口として採用/退避を決める
  - 攻め筋2：過去IPを 08_asn_bgp と結合し、「境界が変わった箇所」だけを深掘り（移行/委託変更点）
- 「見える/見えない」による戦略変更：
  - 履歴が薄い（見えない）：CTログ（10）やソースコード由来（JS/URL）に寄せて入口を増やす
  - 履歴が多すぎる：last_seen・命名・機能境界で削り、代表点だけ現状確認してクラスター化する

## 次に試すこと（仮説A/Bの分岐と検証）
> 条件が違うと次の手が変わる形で書く。

- 仮説A：履歴に“直近まで生きていた”環境系/管理系FQDNが含まれる（last_seenが新しい）
  - 次の検証：
    - 当該FQDNを現状DNSで解決（yes/no）し、解決できるならHTTP到達性を最小回数で確認する
    - 入口になり得るなら 02_web/01_web_00_recon に接続し、境界（認証/権限/機能）を確定する
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：現在も到達できる入口として確定（優先度が上がる）
    - 失敗：過去資産として退避（ただし証跡として残す）

- 仮説B：過去に自社AS/オンプレっぽいIPがあり、現在はクラウド/CDNへ移行している
  - 次の検証：
    - 08_asn_bgpで“境界の変化点”（AS/プレフィックスの切替）を説明できる形にする
    - 10_ctlog と結合し、移行前後で証明書/サブドメインの出現がどう変わったかを見る
  - 期待する観測：
    - 成功：移行の時系列が整理でき、残存資産の疑い（置き去りIP/旧FQDN）に優先度を付けられる
    - 失敗：履歴の偏り（unknown）が強い→別ソースへ寄せる判断ができる

- 仮説C：履歴に第三者CNAME（SaaS/CDN/ホスティング）が多く、運用主体が分散している
  - 次の検証：
    - CNAME先をクラスター化し、「第三者境界の種類」を棚卸しする（運用差分の把握）
    - Cloud露出推定（01_asm-osint/05_cloud）やHTTP観測（03_http）へ接続し、入口を“FQDN単位”で確定する
  - 期待する観測：
    - 成功：委託境界ごとに“次に見るべき観測”が決まる（WAF/CDN挙動、Storage露出など）
    - 失敗：第三者が多すぎて判別不能→優先度を命名/機能境界へ戻す

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - `04_labs/01_local/01_attack-box_作業端末設計.md`（結果の保存・差分管理・再現）
  - `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`（現状確認の最小証跡）
- 参照ファイル：
  - `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
  - `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
- 取得する証跡（目的ベースで最小限）：
  - `passivedns_raw.json`（取得した履歴の生データ：ソース/取得日時を含める）
  - `passivedns_normalized.csv`（正規化：fqdn, rrtype, value, first_seen, last_seen, source）
  - `diff_notes.md`（yes/no/unknown：現状解決・現状到達・境界変化点）
- 観測の取り方（どの視点で差分を見るか）：
  - 「履歴→現状確認」を一括でやらず、last_seenが新しい順に少数ずつ検証する
  - 入口の強さ（管理/認証/API/環境差）で優先度をつけ、深掘り対象を固定してからWeb側へ渡す

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 目的：passive DNSで“過去のFQDN→値”を集め、last_seenが新しい候補から現状確認へ回す
# 例は「データ取得→正規化→現状DNS確認」の流れを示す。実際の取得は利用する提供元/APIに合わせる。

# (1) 取得（例：提供元APIからJSONを取得する。キー等は省略）
curl -s "https://passivedns.example/api/v1/domain/example.com" > passivedns_raw.json

# (2) 正規化（必要フィールドだけ抽出してCSV化：後で差分が取りやすい形にする）
# ※jq等の道具は任意。ここでは“正規化する”ことが目的。
jq -r '.records[] | [.fqdn,.rrtype,.value,.first_seen,.last_seen,.source] | @csv' passivedns_raw.json \
  > passivedns_normalized.csv

# (3) 現状確認（履歴で出たFQDNが、今も解決するかを最小で確認する）
cut -d, -f1 passivedns_normalized.csv | tr -d '"' | sort -u > hist_fqdns.txt
dnsx -l hist_fqdns.txt -a -aaaa -cname -silent > hist_resolved_now.txt
~~~~
- この例で観測していること：
  - 履歴（過去）と現状（現在）の差分を、FQDN単位で状態化するための最短ルート
- 出力のどこを見るか（注目点）：
  - `passivedns_normalized.csv`：last_seenが新しい順、命名（admin/dev/stg/old）、rrtype変化
  - `hist_resolved_now.txt`：現状で解決できる候補（= 次のHTTP観測へ回す入口）
- この例が使えないケース（前提が崩れるケース）：
  - passive DNSの入手経路が無い/制限が強い：CTログ（10）・JS由来（04_js）・検索/公開資料へ寄せる
  - split-horizon（社内DNS前提）で外部からは解決できない：境界（到達性）としてunknownに落とす

## 参考（必要最小限）
- `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
- `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
- `01_topics/01_asm-osint/10_ctlog_証明書拡張観測（SAN_ワイルドカード_中間CA）.md`
- （一次情報）各passive DNS提供元の公式ドキュメント（取得できるフィールドと制限）

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
- 関連 playbooks：`02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- 関連 labs：`04_labs/01_local/01_attack-box_作業端末設計.md`
