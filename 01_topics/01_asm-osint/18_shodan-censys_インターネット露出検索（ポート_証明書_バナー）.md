# 18_shodan-censys_インターネット露出検索（ポート_証明書_バナー）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：V1（アーキテクチャ/境界）・V14（運用/構成）を評価する前提として、「インターネットから観測できる到達面（ポート/サービス/証明書/ヘッダ）」を第三者観測データで補強し、スコープ境界と責任分界を固定する。
- WSTG：Information Gathering の一部。Web入口（80/443）に偏らず、公開面（TLS証明書・露出サービス）から“入口の取りこぼし”を減らし、Web/NWの検証方針へ接続する。
- PTES：Intelligence Gathering（外部観測データの収集）→ Threat Modeling（露出面の優先度付け）→ Vulnerability Analysis（設定/運用のズレの疑い）に繋げる。
- MITRE ATT&CK：Reconnaissance（公開インフラ情報の収集）として位置づける。目的は侵入手順ではなく、診断で「どこを先に見るか」「何がスコープ外混入か」を決めること。

## 目的（この技術で到達する状態）
- Shodan/Censys 等のインターネット観測データを使い、**自分の観測（06/08/10/11/12/13）では見落とし得る露出面**（別IP・別ポート・別証明書運用）を補完できる。
- “IP起点で範囲拡大”せず、**証明書（SAN/Issuer/フィンガープリント）とドメイン（FQDN）起点**で、対象資産に紐づく可能性が高い結果だけを抽出できる。
- 結果を yes/no/unknown（対象内/対象外の疑い/判断保留）で状態化し、スコープ逸脱を防ぎながら、次の検証（03_network/01_enum、02_tls、12_waf_cdn）へ渡せる。

## 前提（対象・範囲・想定）
- 対象（入力として持つべきもの）：
  - 10_ctlogで得たSAN候補（FQDN群）
  - 02_tlsで得た実配信証明書の特徴（Issuer/Subject/SAN）
  - 08_asn_bgpで得た境界クラスター（自社AS/クラウド/CDNっぽさ）
- 想定する落とし穴：
  - 観測データは時点差がある（“今もそう”とは限らない）
  - CDN/共有基盤で、証明書やIPが“混ざって見える”ことがある（対象外混入）
  - ポート露出が見えても、診断スコープが“Webのみ”の場合がある（範囲確認が必須）
- できること/やらないこと：
  - できる：外部観測データの収集・照合・優先度付け（机上の境界確定）
  - やらない：観測結果を根拠に無制限にスキャン/侵入試験へ進む（スコープ逸脱防止）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 入口は「IP」ではなく「証明書/ドメイン」から束ねる
- IP起点は混入が増える（共有基盤・クラウド・CDNで顕著）。
- まずは以下の束で候補を作る：
  - 証明書：SAN（FQDN）、Issuer/中間CA、（可能なら）証明書フィンガープリント
  - ドメイン：ルートドメイン/主要サブドメイン（06/10/15/16由来）
- その後に IP/ASN を 08_asn_bgp で照合し、境界の整合を確認する（逆順にしない）。

### 2) “露出面”の種類を3つに固定する（整理軸）
- 露出A：TLS/証明書から見える面（443以外でもTLSがある：8443等）
- 露出B：バナー/ヘッダ/プロトコルから見える面（SSH/RDP/SMTP等）
- 露出C：Webだが別入口（別IP/別ポート/別ホスト名）で見える面

### 3) “時点差”を前提に、現状観測へ落とす
- 外部観測の結果は「候補」。
- 候補を以下に落とす：
  - yes：自分の現状観測（DNS/TLS/HTTP/到達性）でも一致する
  - no：現状では一致しない（過去資産/移行済み/誤紐付け）
  - unknown：外周（12_waf_cdn）や観測条件で確定できない（保留として残す）

### 4) 境界（資産/信頼/権限）に落とす
- 資産境界：
  - “同じ証明書運用”に見えるホスト群を束ね、資産群の可能性を強/中/弱で整理する
  - 共有基盤で混ざる場合は、FQDN一致を優先し、IP一致だけでは採用しない
- 信頼境界：
  - 大手クラウド/CDN上に収束する場合、第三者境界（委託運用）として 05_cloud / 12_waf_cdn へ接続する
- 権限境界：
  - 露出が Web 以外（例：管理用リモート等）でも、検証可否はスコープ次第
  - “見えた”事実を残し、実施判断は playbook（02_playbooks）に従って段階付けする

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（状態）：
  - 公開観測データ上で「対象ドメインに紐づき得る」露出面が存在する可能性
  - 露出面の種類（TLS/バナー/別入口）と優先度（影響が大きい・入口に近い）を整理できる
  - 自分の現状観測での整合（yes/no/unknown）を付けられる
- 言えないこと（断定しない）：
  - 観測結果＝現在の真実（時点差・誤紐付け・共有基盤の混入がある）
  - 露出＝脆弱（ここでは“入口と境界”の確定が目的）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- 優先度が上がる状態（診断としての意味）
  - 10_ctlogのSANに一致するホストが、想定外のIP/ポートで観測される（入口取りこぼし疑い）
  - 証明書運用（Issuer/中間CA）が“重要ホストだけ別”になっている（境界が増えている）
  - 既知のWeb入口（80/443）以外に、TLS終端や管理面が見える可能性（ただしスコープ判断が前提）
- 次の仮説
  - 仮説A：観測結果は過去資産（移行前）で、現状は収束している
    - 次：09_passive-dns / 16_wayback と突合して“過去→現在”を説明できる形にする
  - 仮説B：別入口（別ポート/別IP）が現役で残っている
    - 次：03_network/01_enum（到達性→サービス→認証推定）へ“候補として”渡し、最小観測で現状確認
  - 仮説C：共有基盤混入で誤紐付けが疑わしい
    - 次：FQDN一致・証明書一致を必須条件にし、IP一致だけの候補は退避する

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A（過去資産の可能性が高い）：
  - 次の一手：
    - 観測結果の日時（last_seen相当）を記録し、09_passive-dns/16_waybackで“同じ時期に存在した痕跡”があるか確認
  - 到達点：
    - 露出面を“過去資産”として整理し、現役検証の無駄を減らす

- 仮説B（別入口が現役の可能性）：
  - 次の一手：
    - スコープに沿う範囲で、代表点だけ現状確認（到達性・TLS・バナー）を行い、yes/noを付ける
    - Web入口なら 03_http/12_waf_cdn、NW入口なら 03_network/01_enum へ接続する
  - 到達点：
    - “外部観測→現状確認→検証計画”まで地続きで進められる

- 仮説C（混入が強く、判断不能）：
  - 次の一手：
    - unknownとして残す（無理に対象化しない）
    - 17_rdap_whois（組織境界）や 11_cohosting（同居推定）で“混ざる理由”を説明できる形にする
  - 到達点：
    - スコープ逸脱を防ぎつつ、判断保留の根拠を持てる

## 手を動かす検証（Labs連動：観測点を明確に）
- 関連 labs：
  - `04_labs/01_local/01_attack-box_作業端末設計.md`（結果保存・差分管理）
  - `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`（現状確認の証跡）
- 取得する証跡（目的ベースで最小限）：
  - `exposure_candidates.csv`：source, query_basis(cert/domain), host/ip, port, observed_at, notes
  - `exposure_now_check.csv`：target, method(dns/tls/http/banner), result(yes/no/unknown), evidence_ref
  - 代表点のTLS/HTTPヘッダ（02_tls/03_httpと同じ形式で保管）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 目的：外部観測で得た「候補（IP:port）」を、最小の現状観測で yes/no/unknown に落とす
# 注：ここでは“自分の端末からの現状確認”のみ例示。外部サービスの検索式は環境差が大きいので省略。

# (1) TLSがあるか（SNI込みで確認：ALPNやIssuerは不要なら省略可）
echo | openssl s_client -connect 203.0.113.10:8443 -servername login.example.com 2>/dev/null \
  | openssl x509 -noout -issuer -subject -dates -ext subjectAltName

# (2) HTTP到達性（Web入口なら最小でヘッダだけ）
curl -skI https://login.example.com/ | sed -n '1,30p'

# (3) バナー（Web以外の可能性を“観測として”残す：プロトコルにより別手段）
# 例：TCP到達性のみ（詳細な列挙は03_network/01_enumの責務）
nc -vz 203.0.113.10 22
~~~~
- 観測していること：
  - 候補が“今も見える入口”か（yes/no/unknown）
  - 証明書に対象FQDN（SAN）が含まれるか（混入の除外）
  - Web入口かどうか（次に渡す先：02_web or 03_network）

## 参考（必要最小限）
- `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
- `01_topics/01_asm-osint/10_ctlog_証明書拡張観測（SAN_ワイルドカード_中間CA）.md`
- `01_topics/01_asm-osint/11_cohosting_同居推定（共有IP_VHost_CDN収束）.md`
- `01_topics/01_asm-osint/12_waf-cdn_挙動観測（ブロック_チャレンジ_例外）.md`
- `01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`
- 関連 playbooks：`02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`