# 13_http2_h3_観測（ALPN_Alt-Svc_到達性）.md

## 目的（この技術で到達する状態）
- HTTP/1.1 だけで入口を見切らず、**HTTP/2（h2）/ HTTP/3（h3, QUIC）** の到達性を「観測根拠つき」で確定し、入口・境界・優先度を更新できる。
- **ALPN（TLSでのプロトコル合意）** と **Alt-Svc（h3誘導の広告）** を軸に、同一FQDNでも「経路（TCP/UDP）」「終端（CDN/WAF/Origin）」が変わる可能性を境界として説明できる。
- 12_waf_cdn（外周）・11_hosting（同居）・05_cloud（構成要素）へ接続し、**“外周は同じに見えるが、プロトコル層で経路が分かれている”** などの前提崩れを早期に潰せる。

## 前提（対象・範囲・想定）
- 対象：
  - 代表FQDN（login/api/admin 等）＋代表パス（`/` `/login` `/api/health` など）
  - 既に作った入口一覧（06_subdomain / 09_passive-dns / 10_ctlog 由来）
- 想定する環境：
  - CDN/WAFがHTTP/2/3を終端し、OriginはHTTP/1.1のまま（エッジ→オリジンで変換される）
  - h3（UDP/443）は提供しているが、ネットワーク境界（FW/プロキシ）で到達できない視点がある
  - Alt-Svcが出るが、実際の到達性・挙動は環境差（地域/端末/プロキシ）で揺れる
- できること/やらないこと（安全に検証する範囲）：
  - できる：代表点で **“合意したプロトコル”** と **“誘導（Alt-Svc）”** を観測し、差分を状態化する
  - やらない：高負荷試験（h2/h3で大量並列・レート攻め等）や、プロトコル差を根拠に探索範囲を拡大する
- 依存する前提知識（必要最小限）：
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`
  - `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
  - `01_topics/01_asm-osint/12_waf_cdn_挙動観測（ブロック_チャレンジ_バイパス条件）.md`（外周の成立点）
  - `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - ALPN：TLSハンドシェイクで「h2 / http/1.1」が何に合意したか
  - Alt-Svc：レスポンスヘッダで「h3へ切り替え可能」が広告されているか（例：`Alt-Svc: h3=":443"; ma=...`）
  - 到達性（経路差）：
    - HTTP/2：TCP/443 上の TLS（ALPN=h2）
    - HTTP/3：UDP/443 上の QUIC（h3）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：
    - h2/h3の終端が **CDN/WAF（第三者）** か **自社オリジン** か（05_cloud/08_asn_bgpと突合）
    - “同一FQDN”でも、プロトコル別に別基盤へ収束していないか（11_hostingと接続）
  - 信頼境界（外部連携・第三者・越境ポイント）：
    - h3はエッジ最適化の代表で、実装/設定は第三者に寄ることが多い（責任分界の説明材料）
    - 企業ネットワークや端末プロキシがUDP/443を遮断する場合、利用者視点で“別経路”が成立する
  - 権限境界（権限の切替/伝播/委任）：
    - 権限そのものは上位（認証/認可）で決まるが、**入口の到達性/外周の成立点が変わる** と、観測（Cookie/ヘッダ/チャレンジ）や例外パスの解釈が変わる
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - ALPNが `h2` で合意する / しない
  - レスポンスに `Alt-Svc` が出る / 出ない（出ても到達できるとは限らない）
  - HTTP/2 と HTTP/1.1 で、ステータス・リダイレクト・ブロック型（12_waf_cdn）・主要ヘッダが一致する / しない
  - HTTP/3（h3）でのみ挙動が違う（= 経路・終端・ルールの差の可能性）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか：
  - 代表FQDNが **h2を受け入れるか**（ALPN合意の事実）
  - 代表FQDNが **h3への誘導を広告しているか**（Alt-Svcの事実）
  - 観測地点（端末/ネットワーク）から **h3（UDP/443）が到達できるか**（成功/失敗の事実）
- 何が“推定”できるか（推定の根拠/前提）：
  - 12_waf_cdnのクラスターと合わせ、**外周ルールや終端がプロトコル別に揺れている可能性**（h2/h3で応答型が違う）
  - 08_asn_bgpと合わせ、h3終端が「CDN/大手ASに強く寄っている」などの境界推定
- 何は“言えない”か（不足情報・観測限界）：
  - Alt-Svcが出る＝常にh3が使われる（クライアント/ネットワーク条件で変わる）
  - h2/h3対応＝安全/危険の断定（ここでは“入口と境界”の確定が目的）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：ALPN=h2、Alt-Svcなし（h2のみ）
  - パターンB：ALPN=h2、Alt-Svcあり（h2提供＋h3誘導）
  - パターンC：ALPN=http/1.1、Alt-Svcあり（広告はあるがh2合意しない等：実装/経路のズレ候補）
  - パターンD：h3が社内/特定経路で到達不可（利用者視点の到達性境界が存在）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”：
  - h2/h3で **外周の応答型（ブロック/チャレンジ/通常）が変わる**：境界ズレ（ルール適用の不整合）の疑いが上がる
  - “広告（Alt-Svc）” と “実到達（h3）” が噛み合わない：運用/移行中の可能性があり、例外パスや代表点の見直し価値が上がる
- 優先度の付け方（時間制約がある場合の順序）：
  1) 重要ホスト（login/api/admin）だけ代表点で ALPN/Alt-Svc を確定
  2) 12_waf_cdn のクラスターで“差分が出やすい入口”にだけ広げる
  3) 差分が出たときだけ 11_hosting / 05_cloud / 08_asn_bgp を突合して境界説明を固める
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：外周（WAF/CDN）成立点の再評価（12_waf_cdnへ戻す：プロトコル差でクラスターを再分割）
  - 攻め筋2：到達性境界の確定（UDP/443の到達可否を“利用者視点”として整理し、Web/NWの検証順を調整）
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - h3が見えない（到達不可）→ “その視点ではh3は入口にならない” と割り切り、h1/h2で観測を固める
  - h3が見える（到達可）→ 12_waf_cdnで「h3で応答型が変わる入口」を優先的に境界確認する

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：h2/h3で挙動差がない（外周も同一に見える）
  - 次の検証：
    - h2（ALPN=h2）で代表点の応答型（status/final_url/主要ヘッダ）を固定し、以降は 03_http と 12_waf_cdn の通常フローへ戻す
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：h1/h2で同等の応答 → “プロトコル差は主要因ではない” と切れる
    - 失敗：h2だけ別応答 → 仮説Bへ移行

- 仮説B：h2/h3で応答型が変わる（境界ズレの疑い）
  - 次の検証：
    - 12_waf_cdn の代表点を、h1/h2/h3で同条件比較し「成立点（どこから変わるか）」を更新
    - 08_asn_bgp と突合し、差分が出る入口が特定AS/特定CDNに偏っていないか確認
  - 期待する観測：
    - h3でのみブロック型/チャレンジ型が変わる、またはヘッダ/リダイレクトが変わる → 経路/終端/ルール差の可能性が上がる

- 仮説C：Alt-Svcは出るがh3は到達できない（視点差が主要因）
  - 次の検証：
    - 観測地点（社内/自宅/VM経路）を変え、UDP/443の到達性を“視点差”として記録する（labsのネットワーク分離設計と接続）
  - 期待する観測：
    - ある視点ではh3成功、別視点では失敗 → “利用者環境依存の入口差”として説明できる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`（h2/h3の観測証跡）
  - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`（視点差：経路差の作り分け）
- 取得する証跡（目的ベースで最小限）：
  - h2：TLSハンドシェイク結果（ALPN合意のログ）＋代表点のレスポンスヘッダ
  - h3：`Alt-Svc` の有無、成功/失敗（到達性）とその条件メモ（ネットワーク/端末/経路）
  - 可能なら pcap（UDP/443が出ているか、TCP/443だけか）※復号は前提にしない
- 観測の取り方（どの視点で差分を見るか）：
  - “同一FQDN・同一パス・同一条件”で、h1/h2/h3 を並べて差分を見る（差分が出た入口だけ深掘り）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 目的：ALPN（h2合意）と Alt-Svc（h3広告）を、代表点だけで確定する

# (1) ALPN確認：h2を要求し、合意結果（ALPN protocol）を見る
openssl s_client -connect example.com:443 -servername example.com -alpn h2 </dev/null 2>/dev/null \
  | sed -n 's/^ALPN protocol: //p'

# (2) HTTP/2でヘッダ観測：Alt-Svc の有無と、外周系ヘッダを確認する
curl -skI --http2 https://example.com/ | sed -n '1,30p'

# (3) HTTP/3で到達性確認（curlがhttp3対応の場合のみ）：成功/失敗と Alt-Svc の整合を見る
curl -skI --http3 https://example.com/ | sed -n '1,30p'
~~~~
- この例で観測していること：
  - (1) TLSでh2合意できるか（ALPN）
  - (2) h2経路の応答型と、h3誘導（Alt-Svc）が広告されているか
  - (3) h3（UDP/443）がその視点で成立するか
- 出力のどこを見るか（注目点）：
  - `ALPN protocol: h2` が出るか
  - `Alt-Svc:` の有無、値（h3/h3-29等）、`ma=`（有効期間）
  - h1/h2/h3で status / Location / Set-Cookie / 外周系ヘッダが一致するか
- この例が使えないケース（前提が崩れるケース）：
  - 企業プロキシ/中間装置でALPNやh3が終端・遮断され、クライアント視点が変わる（その場合は“視点差”として扱う）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：通信の保護（TLS/プロトコル合意）、アーキテクチャと信頼境界（外周終端の把握）、運用・構成（例外経路の管理）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 入口の前提（終端/経路）を誤ると、WAF/CDNの評価や証跡の再現が崩れ、検証結果の信頼性が下がる
- WSTG：
  - 該当カテゴリ/テスト観点：Information Gathering（外形・到達性・防御境界の把握）、Configuration and Deployment（外周/プロトコル差分の確認）
  - 該当が薄い場合：この技術が支える前提（到達性推定、外周境界の成立点特定、観測視点差の固定）
- PTES：
  - 該当フェーズ：Intelligence Gathering → Threat Modeling → Vulnerability Analysis
  - 前後フェーズとの繋がり（1行）：
    - プロトコル差（h1/h2/h3）で境界が分かれる可能性を先に潰すことで、以降のWeb/NW検証の優先度と再現性が上がる
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Reconnaissance（外部公開面の把握）
  - 攻撃者の目的（この技術が支える意図）：
    - “到達できる入口”と“外周の成立点”を最小観測で見極め、探索コストを下げる

## 参考（必要最小限）
- 本リポジトリ内の接続：
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`
  - `01_topics/01_asm-osint/12_waf_cdn_挙動観測（ブロック_チャレンジ_バイパス条件）.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`
- 関連 playbooks：`02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`
