# 08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：V1（アーキテクチャ/境界の把握）とV14（運用・構成）を検証する“前提”として、インターネット到達面のネットワーク境界（自社/委託/クラウド/CDN）を固定する。
- WSTG：Information Gathering の一部として、到達性のあるホスト群を「ネットワーク境界」で束ね、Web側の入口（ホスト/サブドメイン）との対応を取る。
- PTES：Intelligence Gathering（対象のインフラ境界の確定）→ Vulnerability Analysis（どの範囲を深掘りすべきか）へ繋げる中核。
- MITRE ATT&CK：Reconnaissance（T1590 Gather Victim Network Information / T1595 Active Scanning）として位置づけ、攻撃者が“探索範囲を決める”のと同じ論理で、診断側も「次の一手」を決められる状態にする。

## 目的（この技術で到達する状態）
- IP/ホストの集合を、**ASN（AS）とプレフィックス（公告IP範囲）** でクラスタリングし、対象のネットワーク境界（自社/委託/クラウド/CDN）を説明できる。
- “どこまでが同一運用の可能性が高いか”を、BGPの観測（Origin AS、公告プレフィックス、上流/隣接）から **yes/no/unknown** で落とせる。
- 06_subdomain の結果（ホスト名→IP）と結合し、Web/NWの入口を「同一クラスター」「別クラスター」に分け、次の調査（PassiveDNS/CT/Cloud推定/スキャン範囲）へ迷いなく繋げられる。

## 前提（対象・範囲・想定）
- 対象：
  - 06_subdomain 等で得た FQDN→IP（A/AAAA）
  - 既知の公開IP（ゲートウェイ、VPN、メール、CDN、API、管理画面等）
- 想定する環境：
  - CDN/WAF 配下（多くが同一CDN ASNへ収束する可能性）
  - クラウド（クラウド事業者ASNに乗るが、必ずしも“その企業の資産”ではない）
  - Anycast（同一IPが複数地点で広告され、観測地点により見え方が変わる）
- できること/やらないこと（安全に検証する範囲）：
  - できる：WHOIS/RDAP・BGP情報（パブリックデータ）で境界推定、最小限の到達性確認
  - やらない：範囲外のスキャン拡大（「ASが同じだから全部対象」にはしない）
- 依存する前提知識（必要最小限）：
  - `01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`（FQDN→委譲）
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`（到達後の差分観測）
  - `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`（入口FQDNの母集団）
  - `01_topics/01_asm-osint/07_whois_rdap_所有者・関連企業推定（組織境界）.md`（登録主体と運用主体の分離）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 最初に固定する「観測の単位」
ASN/BGPで扱う単位は、次の3つに分けると迷いが減る。
- ホスト単位：FQDN / URL（Webの入口）
- IP単位：A/AAAAで解決されたアドレス（到達性の入口）
- ネットワーク単位：Origin AS と公告プレフィックス（運用境界の入口）

### 2) IP→ASN（Origin AS）を引く（ネットワーク境界の核）
観測で確定したいのは「このIPは、どのASが公告しているか（Origin AS）」。
- ここがズレると意味が変わる差分：
  - 同一FQDNでも、解決先IPが複数ASに分散（マルチCDN/マルチクラウド/地域分散）
  - 同一ASでも、異なるサービス（CDN配下の別顧客）である可能性（断定しない）

yes/no/unknown の例
- yes：解決先IPのOrigin ASが一貫している
- no：Origin ASが混在（= 境界が複数）
- unknown：データソース差・Anycastで断定できない（観測点を増やす）

### 3) ASN→公告プレフィックスを引く（範囲の“外形”を取る）
BGPは「このASがどのIP範囲を公告しているか」を示す。
- 目的は“スキャン範囲を増やす”ことではなく、次の意思決定をするための外形取得：
  - 自社運用っぽい：特定のASが、限定的かつ一貫したプレフィックスを持つ
  - クラウド/ホスティングっぽい：巨大なプレフィックス群（= そのまま対象拡大しない）
  - CDN/WAFっぽい：Anycast/広域広告で収束しやすい（Web入口はFQDNで追う）

### 4) 関連性（AS同士の関係）を“推定”に使う
BGPから読みたいのは「所有」ではなく「関係」。
- 上流（transit）/下流（customer）/ピア（peering）の匂い
- 特定ベンダのネットワークへの依存（第三者境界の強いシグナル）
- 企業買収や事業分離の名残（別ASが併存する等）

ここでの結論は「推定」でよい（断定は07_whois_rdapやCloud観測と束ねる）。

### 5) 境界の観点（資産/信頼/権限）を必ず併記する
- 資産境界：
  - 「対象の運用ネットワーク」がどのAS/プレフィックス群に見えるか
  - Web入口（FQDN）が、どのネットワーク境界へ対応しているか
- 信頼境界：
  - CDN/WAF/クラウド/ホスティングへ越境している箇所（ASの分散として見える）
  - 第三者運用の可能性が高いクラスター（報告/責任分界の材料）
- 権限境界（到達性境界として扱う）：
  - “インターネット到達面”のネットワーク範囲がどこまでか
  - 管理系（VPN/踏み台/管理UI）が別ASや別プレフィックスに分離されているか（設計の匂い）

### 6) 証跡（最低限）
- 入力（観測対象）：
  - `hosts.csv`（FQDN, resolved_ip, 取得日時, 取得元）
- 出力（境界を説明する材料）：
  - `asn_map.csv`（ip, origin_as, as_name, prefix）
  - `clusters.md`（クラスターの説明：ASごとのFQDN一覧、yes/no/unknown）
- 差分メモ（yes/no/unknown）：
  - 同一FQDNのAS分散の有無
  - 重要ホスト（login/api/admin 等）のAS/プレフィックスが“一般ホスト”と分離されているか
  - CDN/WAF収束で“ネットワーク境界が見えにくい”状態か

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか：
  - 各IPの Origin AS（公告元）と、それに紐づく公告プレフィックス（外形）
  - ホスト群が「同一ASに収束」「複数ASに分散」のどちらか
- 何が“推定”できるか（推定の根拠/前提）：
  - 運用クラスター（同一AS/同一プレフィックスに集中する群）
  - 第三者境界（CDN/クラウド/ホスティングへ越境している可能性が高い群）
- 何は“言えない”か（不足情報・観測限界）：
  - “その企業の資産である”の断定（クラウド/委託運用では一致しない）
  - スキャンしてよい範囲の自動拡大（AS一致＝許可、ではない）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：ほぼ全てがCDN ASNへ収束（FQDN中心で追う設計が必要）
  - パターンB：コア（login/api）だけ別ASに分離（運用/セキュリティ設計の境界がある）
  - パターンC：古い/環境系（old/dev/stg）が別ASに残存（運用統制の差が出やすい）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”（診断の優先度付けとして使う）：
  - AS分散が大きい：境界が多い＝設定差分・委託差分が出やすい（入口の優先度が上がる）
  - 重要ホストが分離：そこが“守りの境界”になっている可能性（例外パスや別認証が潜む）
  - 古い資産が別境界：統制差の可能性（ただし断定せず、次の観測で固める）
- 優先度の付け方（時間制約がある場合の順序）：
  1) login / id / api / admin 等の重要ホストのAS/プレフィックス確定
  2) 全ホストのASクラスタリング（収束/分散の把握）
  3) 分散している境界だけ追加観測（TLS/HTTP/Cloud推定へ）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：ASクラスターごとに、TLS/HTTPの代表点を比較し“同一運用/別運用”を確定する
  - 攻め筋2：クラウド/第三者境界が濃いクラスターは、`05_cloud_露出面推定` と結合して誤設定面を優先する
- 「見える/見えない」による戦略変更：
  - CDN収束で“ネットワーク境界が見えない”：Web入口（FQDN）中心に、ヘッダ/証明書/挙動で差分を探す
  - 自社ASが見える：ネットワーク列挙（03_network/01_enum）へ繋がる入口が明確になる（ただし範囲許可は別管理）

## 次に試すこと（仮説A/Bの分岐と検証）
> 条件が違うと次の手が変わる形で書く。

- 仮説A：ほぼ全てがCDN/WAFのASNへ収束している（ネットワーク境界が“CDN側”に見える）
  - 次の検証：
    - 代表FQDNを少数選び、TLS（SAN/発行主体）とHTTP（ヘッダ/リダイレクト/キャッシュ）で“別アプリ境界”を探す
    - Cloud推定（CDN/Storage/Functions）へ接続して、第三者境界の設計を固める
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：CDN配下でも差分が出る（= 深掘り対象が分かれる）
    - 失敗：差分が出ない（= 入口はFQDNよりアプリ機能/認証/認可で選別する）

- 仮説B：重要ホスト（login/api/admin）が別AS/別プレフィックスに分離されている
  - 次の検証：
    - その境界だけを優先して、Web側の入口・認証方式・例外パスを観測する（02_webのrecon/authn/authzへ直結）
    - 可能なら“到達性の違い”（許可IP制限、VPN前提等）を最小差分で確認する
  - 期待する観測：
    - 成功：別運用・別認証・別WAFルールなどの境界が説明できる
    - 失敗：分離はあるが意味が薄い（= 単なる地域/冗長化の可能性。次はPassiveDNS/CTで補強）

- 仮説C：dev/stg/old 等が別ASに残存し、運用統制の差が疑われる
  - 次の検証：
    - PassiveDNS（09）で“過去→現在”の移り変わりを確認し、残存資産の位置づけを固める
    - HTTP観測で、ログイン有無・管理UI有無・バナー差分など「入口としての強さ」を判断する
  - 期待する観測：
    - 成功：残存資産が“現実に到達できる入口”として確定する
    - 失敗：過去資産で実質無効（= 証跡として残し、優先度を下げる）

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - `04_labs/01_local/01_attack-box_作業端末設計.md`（OSINT結果の保存・差分管理）
  - `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`（到達性確認の最小証跡）
- 参照ファイル：
  - `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
- 取得する証跡（目的ベースで最小限）：
  - 入力（FQDN→IP）と、出力（IP→Origin AS→Prefix）の対応表（値はそのままでよい）
  - 観測日時（BGPは変動するため、いつ見たかが証跡になる）
- 観測の取り方（どの視点で差分を見るか）：
  - “重要ホストだけ先に”ASを引く → その後に全体クラスタリング（無駄を減らす）
  - ASが巨大（クラウド/ホスティング）なら、範囲拡大ではなく「第三者境界」として扱う

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 目的：IPの“公告元（Origin AS）”と“外形（プレフィックス）”を引き、ネットワーク境界を説明可能にする

# 1) まずIPのWHOIS/RDAPで、割り当て主体やAS情報の手がかりを取る（出力は証跡として保存）
whois 203.0.113.10 | sed -n '1,120p'

# 2) Origin ASから、そのASが公告しているプレフィックス（候補）を引く（= 外形の把握）
# RADBのroute/route6オブジェクトは“公告の実態”と完全一致しないことがあるため、あくまで候補外形として使う
whois -h whois.radb.net -- "-i origin AS64500" | sed -n '1,120p'

# 3) FQDN→IPの一覧（hosts）と突合し、ASクラスター（同一/分散）を作る（道具は何でもよい）
# 例：手元でCSVにまとめる、スプレッドシートでピボットする、など
~~~~
- この例で観測していること：
  - 「IPがどのASにより公告されているか」「そのASが持つ外形（プレフィックス候補）は何か」
- 出力のどこを見るか（注目点）：
  - whois：AS番号、組織名（あれば）、割り当て範囲の記述
  - radb：route/route6（候補外形）、mnt-by/descr（運用の匂い）
- この例が使えないケース（前提が崩れるケース）：
  - Anycastや観測地点差でASが揺れる（unknownとして観測点を増やす）
  - データソースのレート制限/遮断（最小件数で代表点を取る方針に切り替える）

## 参考（必要最小限）
- `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
- `01_topics/01_asm-osint/07_whois_rdap_所有者・関連企業推定（組織境界）.md`
- `01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`
- MITRE ATT&CK：T1590（Gather Victim Network Information）、T1595（Active Scanning）
- OWASP WSTG：Information Gathering
- PTES：Intelligence Gathering

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
- 関連 playbooks：`02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- 関連 labs：`04_labs/01_local/01_attack-box_作業端末設計.md`
