# 06_subdomain_列挙（passive_active_辞書_優先度）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - 該当領域/章：V1（Architecture, Design and Threat Modeling）/ V14（Configuration）を“直接テスト”する前提として接続する（外部露出資産の境界を確定しないと、以降の検証範囲・責任分界がブレる）。
  - このファイルの内容が「満たす/破れる」ポイント：
    - 対象資産境界（どのFQDN群が対象か）と、第三者境界（委託/クラウド/外部連携）を確定できる状態を作る。
- WSTG：
  - 該当カテゴリ/テスト観点：Information Gathering（4.1）に相当。アプリ列挙・エントリポイント特定へ繋げる“入口の精度”を上げる。
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定）。
- PTES：
  - 該当フェーズ：Intelligence Gathering
  - 前後フェーズとの繋がり（1行）：資産境界を確定 → 脅威モデル/攻め筋選定 → Vulnerability Analysis（Web/NW）へ接続。
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Reconnaissance（Active Scanning / Wordlist Scanning）
  - 攻撃者の目的（この技術が支える意図）：公開インフラの“入口候補”を増やし、到達性・認証面・運用差分が出る場所を優先的に見つける。

## 目的（この技術で到達する状態）
- サブドメイン列挙を「数を増やす作業」ではなく、**資産境界（対象範囲）** と **信頼境界（第三者・委託・クラウド）** を“観測”で確定し、次の検証（TLS/HTTP/Cloud/Web Recon）へ繋げられる。
- passive（第三者データ）と active（直接照会/解決/疎通）を切り分け、結果を **yes/no/unknown**（解決できる/できない/未確認）として扱える。
- 「全部深掘りしない」ために、列挙結果を **優先度（攻撃面が広い順）** に変換できる（例：認証系/管理系/API系/社内向け臭/古い資産臭）。

## 前提（対象・範囲・想定）
- 対象：
  - 企業/サービスの基幹ドメイン（例：example.com）および許可されたサブドメイン範囲
  - 既知の関連ドメイン（ブランド違い・国別・事業部境界）がある場合は別扱い（07_whois_rdap へ接続）
- 想定する環境：
  - CDN/WAF配下で一部が同一IPへ収束する可能性がある（列挙→疎通だけでは“別アプリ”と断定しない）
  - DNSが外部委託（クラウドDNS）で運用されている可能性がある（NS/CAA/証明書観測へ接続）
- できること/やらないこと（安全に検証する範囲）：
  - できる：passiveソース収集、DNS解決の最小照会、HTTP疎通の“存在確認”（負荷を抑える）
  - やらない：大規模な総当たり、過剰な並列スキャン、規約/許可を超える能動探索
- 依存する前提知識（必要最小限）：
  - `01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`（委譲/NS/ゾーン境界）
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`（疎通後に何を見るか）
  - `01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`（CT由来候補の扱い）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - passive：公開データ（検索/既知辞書/CT/PassiveDNS等）から得た「候補FQDN集合」
  - active：DNS解決（A/AAAA/CNAME）、HTTP疎通（ステータス/リダイレクト/サーバ特性）による「実在/到達性」
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：
    - “同一ドメイン配下”でも、運用主体が違う（委託/別部門/買収由来）可能性があるため、後続（WHOIS/RDAP・ASN・Cloud推定）と束ねて判断する。
  - 信頼境界（外部連携・第三者・越境ポイント）：
    - CNAMEが第三者（CDN/ホスティング）へ向いている、証明書発行主体が外部依存、などは「第三者境界」の強いシグナル。
  - 権限境界（権限の切替/伝播/委任）：
    - サブドメインごとに別の認証/別テナント/別管理画面が存在し得る（`admin.` / `id.` / `api.` など）。後続の Web Recon（入口→境界→検証方針）に接続する。
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - DNS状態：NXDOMAIN / 解決可 / CNAME先あり / ワイルドカード疑い
  - 到達性：HTTP(S)で応答あり / リダイレクトのみ / タイムアウト
  - 収束：多数FQDNが同一IP・同一CDNへ収束（＝“同一アプリ”とは限らないが、運用境界の推定に効く）
  - 名前の意味：`dev/stg/test/old/backup/admin/internal/api` 等は優先度付けに直結

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか：
  - 候補FQDNのうち「解決できる/できない」（DNS観測としてのyes/no）
  - 到達性（HTTP(S)で応答がある/ない）
  - 第三者境界の兆候（CNAME/証明書/HTTPヘッダの外部依存）
- 何が“推定”できるか（推定の根拠/前提）：
  - 運用クラスター（同一CDN・同一証明書方針・同一リダイレクト）としてのまとまり
  - “統制が弱そうな領域”の存在（命名・更新頻度・分散度合いからの推定）
- 何は“言えない”か（不足情報・観測限界）：
  - それが本当に別アプリか（CDN配下で同一挙動に見える、逆に同一アプリでも別挙動に見える）
  - 所有者/責任所在の断定（07_whois_rdap、08_asn_bgp、05_cloud 推定と束ねる必要）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：passive候補が多いが、解決できるのは一部（過去資産・誤収集が混ざる）
  - パターンB：解決はできるが、ほぼ同一CDNへ収束（運用境界は見えるが、アプリ境界は後続観測が必要）
  - パターンC：`dev/stg/old` 系が解決・到達できる（優先度が跳ね上がる：設定/認証/公開範囲のズレが出やすい）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”：
  - 命名が示す環境差（dev/stg/old/backup/admin）＝統制差・例外パスが出やすい
  - 第三者境界（CNAME先が外部）＝設定ミス/委託境界/サブドメインテイクオーバー等の前提になり得る（次ステップへ接続）
  - 認証/ID基盤っぽいサブドメイン（id/sso/auth）＝Web側の認証観測へ直結
- 優先度の付け方（時間制約がある場合の順序）：
  1) 到達できる（解決＋疎通）かつ “環境差/管理差” を示す名前（admin/dev/stg/old）
  2) API/ジョブ/管理UI臭（api/graphql/admin/console）
  3) 第三者境界が濃い（CNAME外部、CDN/WAF、クラウドストレージ臭）
  4) 収束クラスター（まとめて扱える）→ 代表点だけ深掘りして横展開
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：TLS/HTTP観測で “同一に見える/違うに見える” の根拠を増やし、入口の優先度を確定（02_tls / 03_http）
  - 攻め筋2：クラウド露出推定（05_cloud）で、Storage/CDN/WAFの外部依存と誤設定面を棚卸し
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - CDN配下で同一挙動：HTTPの差分（ヘッダ/キャッシュ/リダイレクト）とTLS（SAN/発行主体）で“境界”を探す
  - SSO前提：`id/auth/sso` を先に確定し、Web側の認証フロー観測（02_web/02_authn）へ早期接続

## 次に試すこと（仮説A/Bの分岐と検証）
> 条件が違うと次の手が変わる形で書く。

- 仮説A：passive候補の多くは“過去資産/誤収集”で、現行の到達面は限定的
  - 次の検証：
    - DNS解決で yes/no を確定し、解決できない候補は“過去候補”として別枠へ退避
    - CT/PassiveDNS（次ステップ）で「過去→現在」の遷移を見て、重要な過去資産だけ拾い直す
  - 期待する観測：
    - 解決できる母集団が絞れ、以降のHTTP/Cloud観測のコストが下がる

- 仮説B：到達できるが、CDN/WAFへ強く収束しており“入口の差分”が見えにくい
  - 次の検証：
    - TLS（SAN/発行主体）とHTTP（ヘッダ/リダイレクト/キャッシュ）で代表点を比較し、クラスターを分ける
    - 収束クラスターは代表点のみ深掘りし、差分があるクラスターへ時間を寄せる
  - 期待する観測：
    - “同一運用”と“別運用”が分かれ、次の攻め筋（Web/API/Cloud）が自然に決まる

- 仮説C：dev/stg/old/admin 等が到達でき、環境差が露出している
  - 次の検証：
    - Web Recon（02_web/01_web_00_recon）へ直結し、入口・境界・検証方針を確定する（認証/管理導線を最優先）
    - 影響が大きい操作（ログイン/設定/管理）に到達できるかを“少ないリクエスト”で確認する
  - 期待する観測：
    - “設計上想定されない公開”や“例外パス”の存在が、証跡付きで説明できる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - `04_labs/01_local/01_attack-box_作業端末設計.md`（収集・整形・差分管理の作業基盤）
  - `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`（HTTP疎通確認の最小証跡）
- 取得する証跡（目的ベースで最小限）：
  - 列挙結果：`candidates.txt`（passive候補）
  - 解決結果：`resolved.txt`（A/AAAA/CNAMEの状態付き）
  - 疎通結果：`alive.txt`（http/https・ステータス・リダイレクト先）
- 観測の取り方（どの視点で差分を見るか）：
  - “名前の意味” → “DNS状態” → “到達性” の順で削る（先に絞ってから深掘り）
  - 収束（同一CDN/同一証明書傾向）は“まとめる”、差分が出る群へ時間を寄せる

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 目的：passiveで「候補」を集める（= まだ実在は確定しない）
subfinder -d example.com -silent > candidates.txt

# 目的：DNS解決で「実在（解決可）」を確定する（yes/no）
dnsx -l candidates.txt -a -aaaa -cname -silent > resolved.txt

# 目的：HTTP疎通で「入口（到達面）」を確定する（深掘り対象を絞る）
# - ステータスや最終URLを保存し、リダイレクト収束（同一先）も把握する
httpx -l resolved.txt -silent -status-code -follow-redirects -final-url > alive.txt
~~~~
- この例で観測していること：
  - passive候補 → 解決可否 → 到達性、という“境界確定の最短ルート”
- 出力のどこを見るか（注目点）：
  - resolved：CNAME先（第三者境界の兆候）、ワイルドカード疑い（大量に解決する等）
  - alive：`admin/dev/stg/old` 等の到達、リダイレクト収束（同一運用クラスターの兆候）
- この例が使えないケース（前提が崩れるケース）：
  - 許可されない能動探索（並列度やアクセス制限が厳しい契約/VDP）
  - DNS応答が特殊（split-horizon、社内DNS前提）で外からは解決できない
  - ほぼ全てがCDN/WAFで同一応答（HTTPだけでは境界が見えにくい → TLS/Cloud観測へ寄せる）

## 参考（必要最小限）
- OWASP WSTG（Information Gathering）
- PTES（Intelligence Gathering）
- MITRE ATT&CK（Reconnaissance / Active Scanning）
- （repo内）`01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`
- （repo内）`01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`
- （repo内）`01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`
- 関連 playbooks：`02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- 関連 labs：`04_labs/01_local/01_attack-box_作業端末設計.md`
