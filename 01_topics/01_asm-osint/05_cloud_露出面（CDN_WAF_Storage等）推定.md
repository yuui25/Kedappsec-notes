# 05_cloud_露出面（CDN_WAF_Storage等）推定.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：外部依存（CDN/WAF/Storage等）の“信頼境界”と設定論点を特定し、Config/Secrets/Access Control の検証へ繋げる
- WSTG：Information Gathering と Configuration の前提として、外部依存・到達性・保護レイヤを観測根拠つきで整理する
- PTES：Intelligence Gathering → Threat Modeling（境界）→ Vulnerability Analysis（優先度付け）に直結
- MITRE ATT&CK：Reconnaissance / Discovery（外部依存と到達性を把握し、攻め筋の確率を上げる）

## 目的（この技術で到達する状態）
- DNS/TLS/HTTP/JS の観測から、外部に露出している “クラウド構成要素” を **状態として** 説明できる。
  - 例：CDN終端、WAFの前段、オブジェクトストレージ配信、API Gateway、外部IdP、外部SaaS
- 露出面を「サービス名当てクイズ」で終えず、次を確定する。
  - 信頼境界：どこが第三者（外部依存）で、どこが自社運用の可能性が高いか
  - 到達性：どこまでが外部から届き、どこで遮断・変換されるか
  - 優先度：Webの `Config/AuthN/AuthZ/API`、SaaSの `共有/外部連携/監査`、NWの `到達性/認証` のどこへ寄せるべきか

## 前提（対象・範囲・想定）
- 対象：許可スコープ内のドメイン/サブドメイン/URL（能動的探索は最小に留める）
- 想定：
  - “クラウド”は単一ではなく、CDN/WAF/Storage/IdP/SaaS が組み合わさり、境界（信頼/権限）が増える
  - 断定よりも、観測根拠を積み上げて “最も確からしい状態” を作る
- Labs連動：
  - HTTP観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - 証跡：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) DNSの観測（依存先と役割の推定）
- 観測対象
  - CNAME/ALIAS の委譲先（CDN/WAF/Storage/ホスティングの兆候）
  - レコードの階層（サブドメイン分割＝運用分割の兆候）
- 見ている“境界”
  - 信頼境界：委譲先＝第三者サービスを跨いでいる可能性
  - 資産境界：自社管理のDNSゾーンか、外部管理のDNSか

### 2) TLS/証明書の観測（終端の外部依存と運用分割）
- 観測対象
  - SANの傾向（どのドメイン群が同じ終端で扱われるか）
  - 証明書の発行/更新の癖（自動更新、残骸、移行の兆候）
- 見ている“境界”
  - 信頼境界：TLS終端がどこにあるか（CDN/WAF/ロードバランサ等の可能性）
  - 資産境界：運用単位（証明書単位の分割は境界の手掛かり）

### 3) HTTPの観測（保護レイヤと到達性の推定）
- 観測対象
  - レスポンスヘッダの特徴（キャッシュ・WAF・プロキシの兆候）
  - リダイレクト、エラー応答（403/429/5xx）と振る舞い差
  - キャッシュ挙動（HIT/MISS、年齢、vary）とオリジンの見え方
- 見ている“境界”
  - 到達性：外部からオリジンへ届くのか、手前で遮断/変換されるのか
  - 信頼境界：CDN/WAFが“解釈・遮断”する地点になっているか

### 4) JS/フロント資産の観測（外部依存の具体化）
- 観測対象
  - 外部ドメイン（storage、api、webhook、analytics 等）
  - 設定（環境差分、バケット名、配信先、regionの手掛かり等）
- 見ている“境界”
  - 信頼境界：第三者（SaaS/Storage/解析）へデータが流れる可能性
  - 権限境界：共有・委任・トークンの扱いが発生しやすい地点

### 5) “露出面の型”として整理する（当てるのは最後）
- 観測結果を、まず“型”で整理する（例）
  - 型A：CDN配信（静的資産中心、キャッシュが効く、オリジンは隠蔽されがち）
  - 型B：WAF前段（ブロック/チャレンジ/レート制御が見える）
  - 型C：Storage直配信（オブジェクトURLや配信ドメインが露出）
  - 型D：API Gateway/管理プレーン（APIの入口が統合され、認証/スロットリングが見える）
  - 型E：外部IdP/SaaS連携（SSO/監査/共有/外部ゲスト等の境界が増える）
- 見ている“境界”
  - どの型かで、次に深掘りすべき技術（Config/AuthN/AuthZ/API/SaaS）が変わる

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（状態として）
  - 「どこに外部依存（信頼境界）があるか」
  - 「どこで遮断/変換が起きるか（到達性）」
  - 「どの構成要素が“攻撃面”として重要か（優先度）」
- 言えないこと（断定しない）
  - ヘッダやCNAMEだけで、クラウドベンダや製品を断定すること
  - 露出＝脆弱、設定ミス確定、スコープ確定という断定
- 代わりにやること
  - “代表点”で、挙動差（条件差）を観測して確度を上げる

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- 露出面の整理は、次の意思決定に直結する
  - WAF前段が強い → 入口・権限・連携（AuthZ/API/SaaS）へ寄せる（WAF回避が目的ではない）
  - CDN配信が主 → JS/静的資産の差分観測で API面・設定面を掘る
  - Storage露出が濃い → 共有・外部公開・署名URL・権限設計の論点へ寄せる
  - API Gatewayっぽい → 認証方式/スコープ/レート制御/エラー設計を“境界”として掘る
  - 外部IdP/SaaS依存が濃い → 信頼境界（委任/共有/監査）を掘り、責任分界の論点を作る

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：WAF/保護レイヤが入口の支配点（到達性が手前で決まる）
- 次の一手（深掘り先）
  - Web：`01_topics/02_web/01_web_recon_入口・境界・攻め筋の確定.md`
  - Web：`01_topics/02_web/06_config_設定・運用境界（CORS/ヘッダ/Secrets）.md`
- 検証の観測点（最小）
  - 代表リクエストで、拒否点（どこで拒否されるか）と差分（条件で変わるか）を取る

### 仮説B：Storage/公開資産が攻撃面（共有・外部公開が鍵）
- 次の一手（深掘り先）
  - SaaS：`01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`
  - Web：`01_topics/02_web/06_config_設定・運用境界（CORS/ヘッダ/Secrets）.md`
- 検証の観測点（最小）
  - 公開範囲（誰が読めるか）と、URLの性質（推測可能性/期限/署名）を状態で整理する

### 仮説C：API Gateway/委任が鍵（スコープ・認証方式が支配点）
- 次の一手（深掘り先）
  - Web：`01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`
  - SaaS/IdP：`01_topics/04_saas/01_idp_連携（SAML/OIDC/OAuth）と信頼境界.md`
- 検証の観測点（最小）
  - 認証方式（cookie/bearer）と、スコープ/ロールの手掛かりを観測し、差分（主体A/B）で境界が効くか確認する

### 仮説D：外部依存が多く、責任分界が重要（第三者跨ぎが支配点）
- 次の一手（深掘り先）
  - SaaS：`01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`
  - ASM：`01_topics/01_asm-osint/00_index.md`（境界メモの更新）
- 検証の観測点（最小）
  - “誰が管理する構成要素か” を整理し、検証対象（自社設定/連携設定/運用）を切り分ける

## 例（最小：露出面の整理の仕方）
~~~~
# 目的：クラウド名当てではなく、境界（信頼/到達性/権限）を決める
#
# 観測 → 状態 → 次の一手（例）
# - DNSの委譲先が外部っぽい → 信頼境界がある → 連携/設定（Config/SaaS）へ寄せる
# - HTTPでWAF的な拒否点が見える → 到達性が手前で決まる → 入口・権限（Web Recon/AuthZ/API）へ寄せる
# - JSにstorageや共有の匂い → 資産境界が外部へ → 共有・外部公開（SaaS/Config）へ寄せる
~~~~

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 外部依存（信頼境界）と設定論点（Secrets/Headers/CORS等）を、観測根拠つきで特定し、以降の検証（Config/AuthN/AuthZ/API）を外さない
- WSTG：
  - Information Gathering の成果として、Configuration/Authorization/API の検証設計に必要な前提（到達性・依存・保護レイヤ）を供給する
- PTES：
  - Intelligence Gathering：露出面（外部依存・到達性）を整理
  - Threat Modeling：境界（資産/信頼/権限）を確定し、優先度へ反映
- MITRE ATT&CK：
  - Reconnaissance / Discovery：外部依存と到達性を把握し、攻め筋の確率を上げる（列挙より意思決定が主役）

## 参考（必要最小限）
- 連動（ASMの前段観測）
  - `01_dns_委譲・境界・解釈.md`
  - `02_tls_証明書・CT・外部依存推定.md`
  - `03_http_観測（ヘッダ/挙動）と意味.md`
  - `04_js_フロント由来の攻撃面抽出.md`
- 接続先（次工程）
  - `01_topics/02_web/01_web_recon_入口・境界・攻め筋の確定.md`
  - `01_topics/02_web/06_config_設定・運用境界（CORS/ヘッダ/Secrets）.md`
  - `01_topics/04_saas/01_idp_連携（SAML/OIDC/OAuth）と信頼境界.md`
  - `01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`

