## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 位置づけ：FW/WAFは「境界（資産・信頼・権限）」を実装で担保する層。ASVSの要件そのものというより、ASVSで求める安全性（認証強制、管理面保護、通信保護、監査）を“構成/運用で満たしているか”を外形から検証する前提になる。
  - ここで扱うこと：到達性・制御・ログの実効性（許可/遮断/検知/レート制限）が、意図した境界で成立しているかを観測で言い切る。
- WSTG
  - 位置づけ：WSTGの多くのテストは「対象に到達できる」ことが前提。FW/WAFが介在すると、観測される挙動（403/429/チャレンジ/遮断）が“アプリの挙動”ではなく“境界装置の挙動”である可能性が高い。
  - ここで扱うこと：WSTGのテスト結果を誤解しないために、FW/WAF/IPS/CDN/LBの影響を切り分け、テスト設計（どこを、どの観測点から、どの速度で）を確定する。
- PTES
  - 位置づけ：Intelligence Gathering / Scanning の結果を、Vulnerability Analysis に接続するための「障害物（境界装置）」の解釈レイヤ。
  - ここで扱うこと：ブロックや検知でスキャンが進まない時に、闇雲に手数を増やさず、観測→解釈→次の一手（観測点移動/範囲縮小/合意形成）で前進させる。
- MITRE ATT&CK
  - Discovery：T1046 Network Service Discovery（スキャンが“どこで止められるか”を含めて解釈する）
  - Defense Evasion（言及は境界の理解として）：防御回避は攻撃者の目的になり得るが、本ファイルは「回避テクニックの列挙」ではなく、**検知/遮断の成立点を観測で特定し、許可された診断を安全に成立させる**ことに集中する。
  - Proxy/トンネル：T1090 Proxy / T1572 Protocol Tunneling（観測点を移す＝正当な診断手段としてのPivotに接続）

---

# 08_firewall_waf_検知と回避の境界（観測中心）

## タイトル
Firewall/WAF：遮断・検知・制限を“どの境界で起きたか”に分解し、観測で確定する（観測中心）

---

## 目的（この技術で到達する状態）
- 「繋がらない/403が出る/途中で落ちる」を、感想ではなく **状態（state）** として説明できる。
  - 例：「L4でDROP（無応答）」「L4でRST（能動拒否）」「L7で403（WAFブロックページ）」「429（レート制限）」「TLS握手段階で切断（SNI/JA3/ポリシー）」など
- その状態から、次の一手を**分岐（仮説A/B）**で選べる。
  - A：観測点を変える（Pivot/別セグメント/許可IP）
  - B：手順を変える（速度・並列・対象ポート・プロトコル）
  - C：合意形成を先にする（WAFログ提供/一時許可/テストモード/ステージング）
- “回避”を「ルールの穴探し」ではなく、**診断を成立させるための正当な調整（影響制御・誤判定回避・観測点移動）**として定義し、境界（やってよい/だめ）を明確にする。
- 最終的に、次ファイル（SMB/LDAP/AD等）やWeb側テストへ、誤解のない入力（到達性・制御点・制限条件）を渡す。

---

## 前提（対象・範囲・用語の揃え）
### 対象（典型の境界装置の配置）
- Network Firewall / Security Group / NACL（L3/L4中心）
- Host Firewall（Windows Firewall, iptables等）
- IDS/IPS（シグネチャ/異常検知。ブロックする場合はinline）
- WAF / Bot Mitigation（L7中心：HTTP/HTTPS。チャレンジ/403/JS/CAPTCHA等）
- LB/CDN/Reverse Proxy（TLS終端・ALPN・HTTP/2・ヘッダ改変・キャッシュの境界）

### 用語（混ぜると判断が壊れる）
- 遮断（Block）：通信が成立しない/成立したが拒否される（L3/L4/L7で起こり得る）
- 検知（Detect）：止めないがログ/アラート/セッション監視が起こる（外形からは見えにくい）
- 制限（Limit）：429/スロットリング/遅延注入/一時ブロック（可用性を保ちながら抑える）
- 回避（Evasion）：ここでは「許可された診断を成立させるための正当な調整」を指す
  - 例：テストの低速化、対象絞り込み、許可IPの申請、テスト窓の合意、観測点移動（Pivot）
  - 禁止：防御機構の弱点を突いて隠密に抜けるための具体手順・手口の列挙（本プロジェクトのtopicsとしては目的外）

---

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
> 観測は「どの層で」「誰が」「何を根拠に」反応したかを確定する作業。

### 1) L3/L4の観測（FW/SG/NACL/Host FWの影響を切り分ける）
- 観測対象（TCP）
  - SYN→SYN/ACK：open（到達し、待受がいる）
  - SYN→RST：closed（到達したが拒否/待受無し。途中装置がRSTを返す場合もある）
  - SYN→無応答：filtered/dropped（FW/SG/経路/レート制御/ブラックホール）
- 観測対象（ICMP）
  - Echo reply：L3到達の根拠（ただしICMP遮断は一般的）
  - admin prohibited / unreachable：制御点の存在を示唆（返す設計の場合）
- 重要な補助観測（“どこで止まったか”の手がかり）
  - TTL/RTTの変化：経路や中継点が変わった可能性
  - TCPオプション/MSS/Window：中継装置（LB等）が終端している兆候になり得る
  - “同一IP:portでも時間で揺れる”：レート制限・自動ブロック・負荷・フェイルオーバの兆候

### 2) TLSハンドシェイク観測（WAF/LB/CDN境界の入口）
- 観測対象
  - TLSが成立するか（握手が通るか）
  - 証明書（SAN/Issuer/期限）：終端点（LB/CDN/WAF）推定、内部名漏えいの手がかり
  - ALPN（h2/http1.1）：HTTP層の前提確定（同じ443でも挙動が変わる）
  - SNI依存：servernameで返る証明書や挙動が変わるか（名前ベース終端）
- 意味
  - 「HTTPが見えない」時でも、TLS段階で境界装置の存在を確定できる
  - TLS段階で切断されるなら、HTTP以前（WAF/Proxyポリシー、mTLS要求、SNIポリシー等）の可能性

### 3) HTTP/L7観測（WAF/Bot/アプリ/プロキシの境界を切り分ける）
- 観測対象（レスポンス）
  - ステータス：403/406/429/503/30x 等（意味が違う）
  - レスポンスボディ：ブロックページ/チャレンジページ/エラーテンプレの有無
  - ヘッダ：Server/Via/X-Cache/独自ヘッダ/Set-Cookieの挙動（境界装置の手がかり）
  - 接続制御：同一リクエストでも、一定回数でブロック/遅延/切断が入るか（レート制限）
- 観測対象（リクエスト側の条件）
  - メソッド（GET/HEAD/OPTIONS）：境界装置が先に拒否する場合がある
  - パスの違い（/ /robots.txt /favicon.ico /存在しないパス）
  - Host/SNI一致・不一致：名前ベースで別ポリシーが当たっていないか
  - HTTP/1.1 vs HTTP/2：プロキシの実装差が出る

### 4) “検知”の観測（外形から見えないものを、診断で見える形にする）
- 原則：外形観測だけでは「検知したか」は断言できない
- ただし診断としては、次を合意して“観測可能にする”のが実務的
  - WAF/IDS/Firewallのログ抜粋（該当時刻、あなたの送信元IP、該当ルールID）
  - SOC/監視のアラート有無（「いつ」「何が」トリガになったか）
  - ブロック/緩和のポリシー（レート閾値、ブロック時間、例外条件）
- これにより「止められた原因」を推測ではなく根拠で言えるようになる

---

## 結果の意味（その出力が示す状態：何が言える/言えない）
> 同じ“403”でも原因が違う。状態を固定しないと誤診する。

### 状態マトリクス（典型パターン）
- L4 無応答（filtered/dropped）
  - 言える：経路上でドロップされている可能性が高い（FW/SG/NACL/Host FW/レート制御）
  - 言えない：アプリが拒否した、とは言えない（HTTPまで行っていない）
- L4 RST（即時拒否）
  - 言える：到達はしているが拒否されている（待受無し or 中継装置が拒否）
  - 言えない：どの装置が返したRSTかは追加観測が必要
- TLS成立→HTTPで403/ブロックページ
  - 言える：HTTP層まで到達し、L7で拒否されている（WAF/アプリ/認可）
  - 言えない：WAFかアプリかは、レスポンス特徴/ログ合意で確定する
- TLS成立→一定回数後に429/遅延/一時ブロック
  - 言える：レート制限/自動緩和が働いている（IP/UA/セッション単位の可能性）
  - 言えない：閾値やキー（IPだけか、認証/トークン含むか）は追加観測が必要
- TLS段階で失敗/切断
  - 言える：HTTP以前のポリシー（mTLS要求、SNI制限、暗号スイート制限、プロキシの拒否等）
  - 言えない：アプリ側の認証・認可の問題とは別

### “回避”の境界（何が許される調整か）
- 許される（診断成立のための正当な調整）
  - 速度を落とす/並列を下げる/対象を絞る（可用性と誤判定の回避）
  - テスト窓を合意し、監視側と連携してログを突合する（検知の可視化）
  - allowlist / テストモード / ステージング環境を用意する（本番影響と誤検知を回避）
  - 観測点を移す（Pivot）＝“内部利用者としての到達性”を検証する（PTとして自然）
- 本topicsで扱わない（防御回避の具体手口に踏み込む）
  - 防御装置の検知ルールをすり抜けるための具体的な変形・難読化・分割・偽装の手順
  - 目的が「監視を逃げる」こと自体になっている行為
  - 合意なしにブロック解除を狙う反復試行（運用事故の原因）

---

## 実施方法（最高に具体：観測→解釈→次の一手を固定手順化）
> 目的は「止められた」を再現可能にし、制御点（FW/WAF/他）を特定すること。  
> まず“低侵襲のベースライン”→“差分観測”→“ログ合意で確証”の順に進める。

### Step 0：観測条件を固定する（再現性の土台）
- 記録する（必須）
  - 観測点：あなたの送信元（IP/セグメント/VPN有無/Pivot有無）
  - 対象：IP/port/FQDN（SNI/Hostが絡むなら必ず両方）
  - 時刻：開始/終了（秒単位が望ましい）
  - 実施量：並列数、リクエスト数、レート（特にmasscan/nmap）
- ここを曖昧にすると「再現しない/説明できない」になり、診断品質が落ちる

### Step 1：L4の状態を“最小トラフィック”で確定する
- 目的：FW/SG/Host FWの影響で止まっているのか、L7まで届くのかを切る
~~~~
# 例：到達性（TCP）を最小で確認（対象ポートだけ）
# 反復しない。まずは1回で状態を見る
nmap -sS -Pn -n -p 80,443,445,389,3389 <target_ip> -oN 08_l4_baseline.txt
~~~~
- 解釈
  - filteredが多い：L7以前で止まっている可能性が高い → Step 2へ
  - openがある：L7観測に進める → Step 3へ

### Step 2：filtered の“性質”を切り分ける（drop / rate / 経路）
- 目的：単なる遮断か、レート制御か、経路問題かを分ける（闇雲に回さない）
- 実施（短いウィンドウで観測）
  - 同じポートに対して、数回だけ、間隔を変えて観測（例：1回→10秒→1回→60秒→1回）
  - 可能ならpcapで「送った/返らない」を根拠化
~~~~
# pcap観測（例：自端末で対象IPのSYN/応答を見る）
sudo tcpdump -i <iface> host <target_ip> and tcp port 443 -nn -vv

# 再観測（低速・最小）
nmap -sS -Pn -n -p 443 <target_ip> --max-retries 1 --host-timeout 30s -oN 08_l4_retry.txt
~~~~
- 解釈の型
  - ずっと無応答：静的遮断/ACLの可能性が上がる（観測点移動が有効）
  - 時間で揺れる：レート制御/自動緩和/負荷の可能性（速度・並列設計が必要）
  - 一部だけ通る：ポリシーがポート/宛先で分かれている（必要ポートに絞って進める）

### Step 3：TLS境界を確定する（WAF/LB/CDNの入口観測）
- 目的：HTTP以前で止まるのか、HTTPに進めるのかを確定する
~~~~
# TLS成立確認（証明書/終端の手がかり）
openssl s_client -connect <ip>:443 -brief < /dev/null

# SNIが必要なら（FQDNが分かっている場合）
openssl s_client -connect <ip>:443 -servername <fqdn> -alpn h2,http/1.1 -brief < /dev/null

# 証明書SAN/Issuerが必要なら
openssl s_client -connect <ip>:443 -servername <fqdn> -showcerts < /dev/null
~~~~
- 解釈
  - TLS成立：L7観測へ進める（Step 4）
  - TLS不成立：mTLS要件/暗号制約/SNI制限/経路遮断の可能性 → ログ合意 or 観測点移動へ

### Step 4：HTTP/L7で「WAF/アプリ/認可」を分ける（ベースライン→差分）
- 原則：ここで“攻撃ペイロード”を投げない。まずは **健全リクエストの差分**で境界を観測する。
- 目的：同じ到達経路で、(a)正常系 (b)存在しないパス (c)メソッド差 で応答がどう変わるかを見る
~~~~
# 1) 正常系：ヘッダだけ（観測優先で -k）
curl -vkI --http1.1 https://<fqdn_or_ip>/

# 2) 存在しないパス（404が返るならアプリ到達の可能性）
curl -vkI --http1.1 https://<fqdn_or_ip>/__this_should_not_exist__

# 3) OPTIONS（WAFが先に拒否する/許可するの差が出ることがある）
curl -vkI -X OPTIONS --http1.1 https://<fqdn_or_ip>/

# 4) Host/SNIを合わせて観測（名前ベース終端の切り分け）
curl -vkI --resolve <fqdn>:443:<ip> https://<fqdn>/
~~~~
- 解釈の型
  - すべて同じテンプレ403：WAF/フロントポリシーが先に拒否している可能性
  - /__not_exist__ が404：アプリ到達している可能性（WAFが全面遮断ではない）
  - OPTIONSだけ拒否：境界装置のメソッド制御 or アプリ設定
  - resolveで挙動が変わる：名前ベースのポリシー差（WAFルール/vhost）が存在

### Step 5：レート制限（429/遅延/一時ブロック）の“モデル”を作る
- 目的：診断を壊さず進めるために、制限条件（閾値/キー/回復）を把握する
- 原則：負荷を上げない。短い試行で曲線を掴む（5→10→20程度の小さい段階）
- 観測項目
  - 閾値：何回/何秒で429や遅延が出るか
  - 回復：何秒待つと戻るか
  - キー：IP固定か、セッション/クッキー/認証後で変わるか
~~~~
# 例：小さく回して429/遅延を観測（-wで時間も出す）
for i in $(seq 1 20); do
  curl -sk -o /dev/null -w "%{http_code} %{time_total}\n" https://<fqdn_or_ip>/healthz
  sleep 0.5
done
~~~~
- 解釈
  - time_totalが段階的に増える：スロットリング/遅延注入の可能性
  - 429が出る：レート制限が顕在化。以降のスキャン/列挙は速度を落として実施（“回避”＝安全調整）

### Step 6：“検知”を確証にする（ログ合意を実務手順に組み込む）
- 目的：外形観測だけでは断言できない「検知/ルールID/制御点」を確定する
- 実務の進め方（診断を前に進める合意）
  - あなた：時刻・送信元IP・対象・試行内容（正常系差分）を提示
  - 相手：WAF/FW/IDSログから該当イベントを提示（可能ならルール名/アクション）
- これにより
  - “403の主体はWAFかアプリか”
  - “遮断はSGかHost FWか”
  - “429はWAFのbot制限か、アプリのrate-limitか”
  を推測ではなく根拠で言える

### Step 7：次工程へ渡す成果物（表に落とす：迷いを消す）
- `ip:port` ごとに最低限これを埋める（後工程の入力）
  - L4状態：open/closed/filtered（根拠：nmap/pcap）
  - TLS：成立/不成立、SNI依存、ALPN（根拠：s_client）
  - L7：HTTP到達可否、ブロック/制限の種類（根拠：curl）
  - 制限条件：429/遅延/一時ブロックの有無（根拠：小規模ループ）
  - 推定制御点：FW/SG/Host FW/LB/WAF/アプリ（確度：高/中/低）
  - 次の一手：観測点移動/許可申請/対象絞り込み/別プロトコルへ

---

## 攻撃者視点での利用（意思決定：優先度・攻め筋・想定パス）
> ここは“テクニック列挙”ではなく、状態が攻め筋をどう変えるかを書く。

### 1) 外側でfilteredが多い
- 意味：外部からは面が小さい（または見えない）
- 攻撃者の意思決定：内部経由（侵害端末/社内端末/SSRF/プロキシ/認証後導線）に寄せる
- 診断としての次の一手：`07_pivot_tunneling（ssh_socks_chisel）.md` に接続し、観測点を移して“内部の地図”を作る

### 2) 443は開いているが、HTTPでブロックページ/チャレンジが出る
- 意味：L7で制御されている（WAF/Bot/ポリシー）
- 攻撃者の意思決定：まず“素の到達”を作り、認証後導線/別経路/内部直結を探す（ここでは詳細手口は扱わない）
- 診断としての次の一手：ログ合意で主体を確定し、テストモード/allowlist/ステージングで「アプリの挙動」を観測可能にする

### 3) 429/遅延が出る
- 意味：自動緩和が働いている（診断品質に直撃）
- 攻撃者の意思決定：攻撃面の探索コストが上がる（長期戦）
- 診断としての次の一手：安全調整（速度/並列/対象絞り込み）を“回避”として扱い、誤検知と可用性影響を避けて進める

---

## 次に試すこと（仮説A/Bの分岐：条件が違うと次の手が変わる）
### 分岐1：L4で止まっている（filtered主体）
- 仮説A：セグメント/観測点の制約（外からは届かない）
  - 次の一手：観測点移動（VPN内/踏み台/侵害端末）＝Pivotを作る
- 仮説B：ポート/宛先単位のポリシー
  - 次の一手：必要ポートに絞る（SMB/LDAP/RDP/WinRM等）→到達できるものから列挙へ

### 分岐2：TLSは通るがHTTPが制御される（403/チャレンジ）
- 仮説A：WAF/Bot制御が主体（アプリまで届いていない）
  - 次の一手：ログ合意で主体/ルールを確定、allowlist/テストモード/ステージングで観測可能にする
- 仮説B：アプリ認可が主体（到達はしている）
  - 次の一手：認証/認可の観測へ（Web側のAuthN/AuthZ、管理面導線の確認）

### 分岐3：429/遅延が顕在化（レート制限）
- 仮説A：WAF側の緩和（IP/UA/セッション依存）
  - 次の一手：診断計画を“低速・少量・高価値”に変更（対象絞り込み、時間帯合意、ログ突合）
- 仮説B：アプリ側のrate-limit（APIキー/ユーザ単位）
  - 次の一手：認証後のキー設計/制限の妥当性評価へ（本ファイルでは“主体確定”まで）

---

## 手を動かす検証（04_labs と接続：観測→解釈→利用を再現）
> labsは手順書ではなく設計。目的は「同じ症状でも原因が違う」を体験で固定する。

### 最小ラボ設計（3層で境界を作る）
- 구성
  - VM1（Operator）：Kali（curl/nmap/openssl/tcpdump）
  - VM2（Boundary）：FW/LB役（iptables/pfSense/nginx reverse proxyなど）
  - VM3（App）：簡易Web（任意）＋任意サービス（例：SSH/SMB相当の代替）
- 変数（切り分けを起こす）
  1) L4 drop（DROP）と L4 reject（RST/ICMP）を切替
  2) TLS終端をBoundaryで行う/行わないを切替
  3) L7で固定403を返す/404を返す/429を返す を切替
- 観測点（必須）
  - Operator側：tcpdumpでSYN/ACK/RST/無応答、TLS握手の有無を観測
  - Boundary側：iptablesログ/プロキシログで“主体”を確定
  - App側：アクセスログで“到達したか”を確定
- ゴール
  - 同じ「繋がらない」を、どの層で止まったか説明できる
  - 診断の次の一手（観測点移動/対象絞り込み/ログ合意）を、迷わず選べる

---

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：境界（管理面・通信・監査）の実効性を、外形観測とログ突合で検証可能にする。WAF/FWが“あるだけ”ではなく、意図した境界で成立していることが重要。
- WSTG：WSTGの結果を誤解しないため、L4/TLS/L7の制御主体を確定し、テスト対象（アプリ）に到達できる条件を整える。
- PTES：スキャンが止まる要因を「防御装置の状態」として扱い、観測→解釈→次の一手（観測点移動/合意形成/安全調整）で前進させる。
- MITRE ATT&CK：Discovery（T1046）における“阻害要因”の解釈、ならびにPivot（T1090/T1572）による正当な観測点移動へ接続する。防御回避は“手口”ではなく“境界理解”として扱う。

---

## 深掘りリンク（作成済み / 予定：最大8件）
- `05_scanning_到達性把握（nmap_masscan）.md`
- `06_service_fingerprint（banner_tls_alpn）.md`
- `07_pivot_tunneling（ssh_socks_chisel）.md`
- `09_smb_enum_共有・権限・匿名（null_session）.md`
- `11_ldap_enum_ディレクトリ境界（匿名_bind）.md`
- `12_kerberos_asrep_kerberoast_成立条件.md`
- `18_winrm_psremoting_到達性と権限.md`
- `19_rdp_設定と認証（NLA）.md`
