## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 位置づけ：到達性と露出面の把握は「攻撃面がどこにあるか」を確定する前提。アプリ側の堅牢性（認証/認可/入力）を議論しても、**“どの経路で到達できるか”** が不明だと設計・検証が崩れる。
  - 満たすための観点：ネットワーク露出（不要ポート/管理系の公開）、環境分離（社内/管理/顧客系）、監視（スキャン検知・レート制御）、変更管理（公開範囲の逸脱検知）を「到達性＝状態」で説明できること。
- WSTG
  - 位置づけ：WSTGはWeb中心だが、実務では **WSTGのテスト対象へ到達するための前段** が必要（例：管理UI/内部API/管理ポート/踏み台経由）。到達性スキャンは「情報収集→境界確定→対象面の絞り込み」を支える。
  - 接続：情報収集（Information Gathering）/構成・デプロイ観測（Configuration & Deployment）に接続し、Webテストに進む前に **“どの入口が存在するか”** を確定する。
- PTES
  - 位置づけ：Intelligence Gathering / Threat Modeling → Vulnerability Analysis の橋渡し。
  - 本ファイルのゴール：単なるポート一覧ではなく、**到達性（届く/届かない）とフィルタ（遮断/監視）を分解して“次に調べる順序”を決める**。
- MITRE ATT&CK
  - TA0007 Discovery：T1046 Network Service Discovery（ネットワークサービス探索）
  - 以降へ接続：見つけたサービスを起点に、Credential Access / Lateral Movement / Persistence へ繋がる（ただし本ファイルは“成立根拠＝観測”の確立に集中）。

---

## タイトル
到達性把握（nmap / masscan）：ホスト/ポート/経路/フィルタの状態を分解し、“触れる資産”の地図を作る

---

## 目的（この技術で到達する状態）
- 到達性を「開いている/閉じている」の二択にせず、**“どの層で何が起きているか”** を状態として説明できる。
  1) 対象範囲（資産境界）に対し、観測点（送信元・経路・時刻）を固定した上でスキャンを設計できる
  2) Host discovery と Port scan を分離し、**“ホストが落ちている”のか“検知/遮断されている”のか** を切り分けできる
  3) port state（open/closed/filtered 等）を **防御・設計の状態** に翻訳できる（FW/SG/NACL/WAF/IPS などの影響を含む）
  4) 大規模（広いCIDR）と精密（単一ホスト深掘り）でツールを使い分け、masscan→nmapで確証を積み上げられる
  5) 次工程（fingerprint/SMB/LDAP/AD/横展開）へ渡すための「候補リスト」と「優先度」を作れる

---

## 前提（対象・範囲・想定）
### 対象（資産境界）
- スコープに含まれるIPレンジ/ホスト/サブネット（例：オンプレ、クラウドVPC、拠点間VPN配下、踏み台配下）
- スキャン観測は「どこから打ったか」で意味が変わるため、**送信元位置（観測点）** を必ず明示する
  - 例：インターネット側 / 社内LAN側 / VPN内 / 侵害後の内部セグメント / pivot後

### 範囲（安全・影響制御）
- 許可のある範囲でのみ実施（契約・VDPスコープ・ルールを優先）
- “速さ”は価値ではなくリスク。誤ると以下が起きる：
  - 可用性影響（帯域・セッション枯渇・FW負荷）
  - 誤検知/通報（SOC/CSIRTの運用トリガ）
  - 証跡の解釈不能（取りこぼし・偽陰性/偽陽性の混入）

### 想定（到達性の定義を揃える）
- 到達性は層で分解する（混ぜると判断が崩れる）
  - L2（同一セグメントでARPが返る/返らない）
  - L3（IPとして到達し、ICMP等に応答が返る/返らない）
  - L4（特定ポートでSYN-ACK/RST/無応答が返る）
  - L7（プロトコルの握手・バナー・TLSなどの応答が返る）
- 本ファイルは **L3/L4中心**（L7は次ファイル fingerprint に繋ぐ）

---

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 「Host discovery」と「Port scan」を分離して観測する
- Host discovery（生存判定）の観測
  - 目的：ホストが“存在している”を示すシグナル（ARP/ICMP/TCP/UDP応答）
  - 失敗の意味：ホスト不在ではなく **“応答が返らない設計/防御”** かもしれない
- Port scan（ポート状態）の観測
  - 目的：ポートごとの状態（open/closed/filtered）＝**サービス到達性の有無** を確定
  - 成功の意味：そのサービスへの入口が存在する（次工程の対象になる）

### 2) 応答シグナルの種類（状態の根拠）
- TCP
  - SYN→SYN/ACK：open（待受）
  - SYN→RST：closed（到達はするが待受無し）
  - SYN→無応答：filtered / dropped（FW/SG/IPS/回線/host FW/レート制限など）
- UDP
  - UDP→ICMP Port Unreachable：closed の根拠になり得る
  - UDP→無応答：open|filtered が混ざりやすい（UDPは“沈黙が通常”が多い）
- ICMP
  - Echo reply：L3到達の根拠
  - Destination unreachable / admin prohibited：フィルタの根拠（※返す設計なら）
- L2（同一セグメントのみ）
  - ARP応答：最強の生存根拠（ただし proxy ARP 等で誤ることがある）

### 3) “どの境界で止まっているか”を示す観測点
- 送信元の境界：自端末→VPN→踏み台→pivot（どこから見ているか）
- 経路の境界：ルータ/FW/SG/NACL/プロキシ/IDS/IPS
- 管理境界：管理系（RDP/WinRM/SSH/SMB/LDAP）と業務系（HTTP/APP）を区別
- テナント境界（クラウド/社内）：VPC/VNetやセグメント間の到達差がそのまま攻め筋の分岐になる

### 4) 証跡（再現性）として残すべきもの
- nmap：テキスト出力だけでなく **XML含む** 出力（後工程でパース・比較）
- masscan：実行時の設定（rate/ポート/IF/送信元IP）を必ず保存
- 可能ならpcap：特に「filtered」の根拠確認（SYN送ったか、返ってきたか）
- 実行条件：日時・送信元IP・経路（VPN接続/踏み台）・帯域制約

---

## 結果の意味（その出力が示す状態：何が言える/言えない）
> 重要：スキャン結果は“真実”ではなく **観測点から見た状態**。判断は「状態の翻訳」で行う。

### 1) Host discovery で “Down” は「不在」とは限らない
- 意味しうる状態
  - 本当に存在しない/停止中
  - ICMP遮断（設計）
  - FWでPing系遮断（設計/防御）
  - レート制限/IPSでドロップ（運用）
  - 経路不通（ルーティング/ACL/セグメント分離）
- したがって「Host discoveryの結果だけで対象外にしない」
  - 代替プローブ（TCP ping等）や -Pn（生存判定を飛ばす）で再確認する価値がある

### 2) open / closed / filtered の“翻訳”
- open
  - サービス到達可能（入口が存在する）
  - 次工程：サービス特定（fingerprint）→認証方式→権限推定へ
- closed
  - 到達は可能だが待受無し
  - 意味：FWで閉じていない（“到達できる経路”はある）＝別ポート/別プロトコルで露出している可能性
- filtered（または open|filtered）
  - 経路上で落とされている（FW/SG/NACL/IPS/host FW）
  - 次工程：**“どの境界で落ちているか”** を推定する（送信元位置を変える、別セグメントから観測する）

### 3) “広く浅く”と“狭く深く”で意味が変わる（ツールの役割）
- masscanの結果（候補）
  - 高速だが荒い。**open候補の列挙**として使う（確定ではない）
  - 次工程のnmapで、port state とサービス情報を確定する
- nmapの結果（確証）
  - 低速だが精密。Host discovery/port scan/（必要なら）version detection で根拠を固める

### 4) 偽陰性/偽陽性が混ざる前提で“確証の積み上げ”にする
- 偽陰性が起きやすい条件
  - 低速回線・高遅延・パケットロス
  - レート制限/IPSの間欠的ドロップ
  - UDP/ICMPの抑制設計
- 偽陽性が起きやすい条件
  - ルール/機器の応答（RST返却など）が特殊
  - NATやLBが“見せかけの応答”を返す
  - masscanの高速条件で取りこぼし・混線

---

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
### 1) “到達性地図”は攻め筋の優先度を決める
- 優先度を上げる典型（ネットワーク視点）
  - 管理系ポートが外部から open（RDP/WinRM/SSH/SMB/LDAP）
  - ドメイン系サービスが到達可能（Kerberos/LDAP/SMB/RPC）
  - DB系が到達可能（MSSQL/PostgreSQL/MySQL等）
  - Web/管理UIが複数経路で露出（直接/別ポート/別サブドメイン）
- 優先度を下げる/保留にする典型
  - 全面filteredで、現観測点からは到達できない（＝pivot/別観測点が必要）
  - openがゼロに見えるが、Host discovery自体が失敗している可能性（先に切り分け）

### 2) “境界の硬さ”を推定し、分岐を決める
- 仮説：外部→内部の境界が強い（大半filtered）
  - 次の一手：VPN/踏み台/端末内からの観測（観測点移動）や、アプリ経由の到達（SSRF/プロキシ/管理導線）を検討
- 仮説：境界が弱い（openが多い、管理系が露出）
  - 次の一手：fingerprint→認証→権限→横展開の入口（SMB/LDAP/AD）へ直結

### 3) “スキャンで得た情報”を後段の検証に変換する
- 例：TCP/445 open（SMB）
  - 次：匿名可否/署名/SMBv1/共有列挙（`09_smb_enum...` へ）
- 例：TCP/389 or 636 open（LDAP/LDAPS）
  - 次：匿名Bind/署名要件/チャネルバインディング等（`11_ldap_enum...` へ）
- 例：TCP/88 open（Kerberos）
  - 次：AS-REP roast/kerberoast の成立条件（`12_kerberos...` へ）
- 例：TCP/3389 open（RDP）
  - 次：NLA/証明書/認証方式（`19_rdp...` へ）

---

## 次に試すこと（仮説A/Bの分岐と検証）
> ここは「速度」ではなく「切り分け」を目的に組む。  
> 1回で決め打ちせず、観測→解釈→次の観測で確証を積む。

### A) Host discovery が “全滅” する（仮説：生存判定が遮断されている）
- 仮説A：ICMPが遮断されているだけで、TCPは生きている
  - 対応：Host discoveryを飛ばしてポートスキャン（-Pn）で“到達”を確認
- 仮説B：経路がそもそも不通（VPN/ルーティング/ACL）
  - 対応：観測点（送信元）を変える/ルート確認/ゲートウェイ到達確認（運用品質の切り分け）

#### 実務コマンド例（最小限：観測設計の型）
~~~~
# (1) まずは「生存判定だけ」を分離して、観測点を固定する
nmap -sn <CIDR> -oA scan_hostdiscovery

# (2) 生存判定が怪しいときは、-Pn で「ポート到達」を見に行く（範囲は絞る）
nmap -Pn -sS -p 22,80,443,445,3389 <CIDR or targets> -oA scan_tcp_reachability
~~~~

### B) open が散発・再現しない（仮説：レート制限/IPS/回線品質）
- 仮説A：速すぎて取りこぼしている（偽陰性）
  - 対応：レート/並列/リトライを抑えて再試行（“遅くして一致する”なら運用制御が原因）
- 仮説B：IPS/IDSが間欠的に落としている
  - 対応：時間をずらして再観測、送信元IP/観測点を変えて差を見る（※回避目的ではなく状態推定）

### C) 大規模レンジ（/16等）で“候補抽出”が必要（masscan→nmap確証）
- 仮説A：まずは“開いている可能性のあるポート”だけを拾えばよい
  - 対応：masscanでtop/重要ポートのみ候補抽出→nmapで確証
- 仮説B：全ポート（-p-）が必要な状況（運用上の例外ポートが疑い）
  - 対応：masscanでもレート制御し、**“範囲を絞る/時間を区切る”** で安全に回す

#### 実務コマンド例（最小限：masscanの役割を固定）
~~~~
# (1) masscan：候補抽出（速いが“確定”ではない）
# - rateは環境に合わせて慎重に下げる（まず低く）
masscan <CIDR> -p22,80,443,445,3389 --rate 1000 -oX masscan_candidates.xml

# (2) nmap：確証（候補ホスト/ポートに絞って精密化）
nmap -sS -sV -p22,80,443,445,3389 -iL candidates.txt -oA nmap_confirm
~~~~

### D) “filtered” が多い（仮説：境界装置が落としている）
- 仮説A：送信元位置が原因（そのセグメントからは届かない）
  - 対応：観測点を移す（VPN内/踏み台/侵害後セグメント）
- 仮説B：同一観測点でも特定ポートのみ落ちる（SG/NACL/host FW）
  - 対応：ポート別に「到達できるもの/できないもの」を表にして、後段の攻め筋を組み替える
- 次ファイルへの接続（観測中心）
  - `08_firewall_waf_検知と回避の境界（観測中心）.md` にて、フィルタの観測・根拠の取り方を深掘りする

---

## 使い分け設計（nmap と masscan を“役割固定”する）
### nmap（精密：状態確定・証跡化・次工程入力）
- 強み
  - host discovery/port scan/（必要なら）version detection を一貫して扱える
  - 出力形式が整い、後段の再現・比較に強い（XML等）
- 使い所
  - 重要ホストの確証
  - “filtered”の切り分け（プローブ変更、-Pnでの再確認）
  - 小〜中規模レンジの探索（安全に回せる範囲）

### masscan（高速：候補抽出）
- 強み
  - 広いレンジで“開いている可能性”のあるポートを高速抽出
- 制約（前提として織り込む）
  - 高速ゆえに運用リスクが高い（rate設計が本体）
  - 取得結果は候補（nmapで確証が必要）
- 使い所
  - /16〜のような広い範囲で、まず入口候補を拾って絞り込む

---

## 手を動かす検証（04_labs と接続：観測→解釈→利用を再現）
> topicsは手順書ではなく、観測点を設計して“状態”を理解するための最小ラボ案を置く。

### 最小ラボ構成（例）
- VM1：攻撃端末（Kali等）
- VM2：対象端末（Linux/Windows）
- VM3：境界（FW役：pfSense/iptablesルータ等）
- 変数
  - ICMP許可/拒否
  - TCP/445だけ許可、他遮断
  - レート制限（DoSポリシー相当）を入れる
- 観測
  - tcpdump/pcapで SYN/SYN-ACK/RST/無応答 を見て、nmapのstateと対応付ける
  - 同じ対象でも観測点（FWの内側/外側）を変えると状態が変わることを確認する

---

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS
  - 到達性＝運用上の露出面。不要サービス公開/管理ポート露出/セグメント分離の欠如は、アプリの堅牢性以前に“入口”として成立する。
- WSTG
  - Webテスト対象（管理画面/別ポート/内部API）へ到達できる経路の確定が、後段のテスト計画（どこをWSTGで深掘るか）の前提になる。
- PTES
  - Intelligence Gatheringで作った資産仮説を、Scanningで“到達性の根拠”として確定し、Vulnerability Analysisへ渡す。
- MITRE ATT&CK
  - T1046 Network Service Discovery：ネットワーク上のサービス露出を探索し、後段の横展開/資格情報攻撃の入口を見つける。

---

## 参考（必要最小限）
- Nmap Documentation（公式）
- Nmap Book：Host Discovery（設計とアルゴリズムの説明）
- masscan：公式ドキュメント/マニュアル（--rate, --banners, 出力形式）
