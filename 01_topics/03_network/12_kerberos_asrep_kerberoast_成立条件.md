## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：認証（ID連携/SSO含む）、パスワード/鍵管理、アクセス制御（特権ID管理）、ログ/監視（監査証跡）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：AD/Kerberos側の“成立条件”が整うと、Webアプリ本体の脆弱性がなくても **統合認証・サービスアカウント・特権運用**を起点に資格情報が狙われ、横展開へ接続される。
    - 満たす：事前認証/暗号方式/サービスアカウントの設計を **境界（権限・鍵・監査）**として固定し、検知（イベント/相関）と是正（アカウント/鍵/運用）まで回せる。
- WSTG：
  - 該当カテゴリ/テスト観点：認証（WSTG-ATHN）、セッション（WSTG-SESS）、認可（WSTG-ATHZ）、ログ/監視（WSTG-LOGG）
  - このファイルでの焦点：WebアプリがKerberos/ADに依存する場合、**認証の根**はADにあり、AD側の設定（事前認証無効・SPN・暗号方式）がWebの安全性を上書きする点を、観測と証跡で固める。
- PTES：
  - 該当フェーズ：情報収集/列挙 → 脆弱性分析（成立条件の充足確認）→ 侵害評価（横展開/特権化への接続可能性）→ 報告（設計是正）
  - 前後フェーズとの繋がり（1行）：`11_ldap_enum_...` で得たディレクトリ情報から、ここで **Kerberosの“成立条件”を満たすアカウント状態**を抽出し、`14_delegation` や `15_acl_abuse` の横展開へ繋げる。
- MITRE ATT&CK：
  - 該当戦術：Credential Access / Lateral Movement / Discovery
  - 技術（例）：T1558.004（AS-REP Roasting）、T1558.003（Kerberoasting）
  - 攻撃者の目的：KDCが返すチケット応答を“オフラインで評価可能な材料”として扱い、弱い鍵（=弱いパスワード/不適切な暗号設定）を突破して横展開の足場にする。

---

## タイトル
Kerberos AS-REP Roast / Kerberoast：成立条件（事前認証・SPN・暗号方式・証跡）を“観測→判断→次の一手”に落とす

---

## 目的（この技術で到達する状態）
- ディレクトリ/認証基盤（AD/Kerberos）を **「資格情報の境界装置」**として捉え、次の状態を作る。
  - 1) AS-REP Roast / Kerberoast が成立し得る **アカウント状態の条件**を、属性とログで説明できる
  - 2) 発見した条件が **実務上のリスク（横展開・特権化）**にどう繋がるか、優先度を付けられる
  - 3) 対策を **“設計要件”として具体化**（どの属性をどう直す/どのログをどう監視する）できる

---

## 前提（対象・範囲・想定）
- 対象：
  - Active Directory ドメイン（オンプレ/クラウドIaaS上のAD含む）
  - ドメインコントローラ（KDC）と、ユーザー/サービスアカウント、SPN登録された主体
- ここで扱う「成立条件」の意味：
  - “攻撃手順”を暗記するためではなく、**成立する/しないの分岐**を属性・暗号方式・証跡から判定するための条件分解
- 典型シナリオ（実務で多い）：
  - Webアプリが Windows統合認証（Negotiate/Kerberos）や、SQL/ファイルサーバ等のバックエンドにAD資格情報を使う
  - サービスアカウントが長期運用でパスワード固定/弱い、暗号方式がRC4許容のまま、監視は不十分
- 安全な取り扱い：
  - 本ファイルは **監査/診断のための観測と判定**が中心。無断環境でのチケット取得やオフライン解析を推奨しない（必ず許可・スコープ内で実施）。

---

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ）：
  - Kerberos AS-REQ/AS-REP（TGT関連）、TGS-REQ/TGS-REP（サービスチケット関連）
  - ディレクトリ属性（LDAP）：
    - AS-REP Roast：`userAccountControl` の **DONT_REQ_PREAUTH**（事前認証不要）
    - Kerberoast：`servicePrincipalName`（SPNの有無/内容）
    - 暗号方式：`msDS-SupportedEncryptionTypes`（主体が許容する暗号の範囲）
- 境界（Boundary）：
  - 資産境界：
    - どのDCがKDCを担い、どこまでが診断対象ドメイン/フォレストか（信頼関係含む）
  - 信頼境界：
    - フォレスト間/ドメイン間信頼、外部IdP/SSO連携（WebやSaaSがADにぶら下がる形）
  - 権限境界：
    - 「通常ユーザー」「サービスアカウント」「特権グループ」「委任/ACLで実質特権」の境界
- 証跡（ログ）：
  - DCのSecurityログ（Kerberos関連イベント）
  - 監視で見たい主キー（相関）：
    - Account（要求元）・Service（対象SPN）・Client IP・時間帯・暗号方式（TicketEncryptionType）

---

## 結果の意味（その出力が示す状態：何が言える/言えない）
### 1) AS-REP Roast（事前認証不要ユーザー）が示す“状態”
- 言えること：
  - **「事前認証が要求されない」ユーザーが存在**し、Kerberos認証フローの一部が簡略化されている
  - そのユーザーの“鍵強度”（実質：パスワード強度/運用）次第で、資格情報が狙われる入口になり得る
- 言えないこと（ここで決めつけない）：
  - 直ちに侵害済みである、突破可能である（＝強度は別評価）
  - そのアカウントが実運用で有効に使われているか（最終ログオン/利用先は別観測）

### 2) Kerberoast（SPNを持つ主体）が示す“状態”
- 言えること：
  - **SPNを持つ主体（多くはサービスアカウント）が存在**し、Kerberosでサービスチケットが発行される前提が整っている
  - 暗号方式（特にRC4許容/既定値のまま）とパスワード運用が弱いと、資格情報が狙われやすい
- 言えないこと：
  - SPNがある＝必ず危険（SPNは正常運用でも必須）
  - AESのみなら絶対安全（強度は上がるが、運用/特権/横展開面は別）

### 3) 暗号方式（msDS-SupportedEncryptionTypes）が示す“状態”
- 言えること：
  - 主体（ユーザー/サービス/コンピュータ）が **どの暗号方式を許容しているか**の境界
  - 値が未定義/空の場合、既定の挙動に依存し、RC4が残っていることが多い（監査で“未定義”は要確認）
- 言えないこと：
  - その暗号方式が“実際に”常に使われている（KDC・クライアント・サービスの交渉結果で変わるため、ログで確認する）

---

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- 優先度の付け方（現実的な攻め筋に直結する順）：
  1) **事前認証不要（DONT_REQ_PREAUTH）**かつ、権限が高い/横展開に直結する（VPN/VDI/サーバ管理/DB運用）
  2) SPN主体が **特権（adminCount=1、Domain Admins相当、サーバ管理者相当）**に近い
  3) SPN主体が **長期パスワード運用**（pwdLastSetが古い、人的管理、共有アカウント化）
  4) DCログ（4769等）で **不自然なTGS要求の増加**、サービス種類の偏り、夜間アクセスが見える
- “攻め筋”の構造（ここでは手順ではなく分岐として理解）：
  - AS-REP Roast：
    - 条件が揃うと「事前認証の壁」がなく、**アカウント強度評価が重要な入口**になる
  - Kerberoast：
    - SPN主体はサービス運用上「止めにくい」ことが多く、**強度・暗号方式・権限**のどれが弱いかで狙い所が決まる
- 横展開への接続（次ファイルへの橋渡し）：
  - 取得した（または侵害した）アカウントが、`14_delegation` や `15_acl_abuse` の条件を満たすと、権限境界を越えやすい
  - SMB/WinRM/RDP/MSSQL などの到達性（`05_scanning`）と組み合わせて “次の一手” を確定する

---

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：AS-REP Roastが成立するユーザー（DONT_REQ_PREAUTH）が存在する
  - 検証：
    - LDAPで対象ユーザー一覧を抽出し、無効/ロック/期限切れを除外
    - そのユーザーが **どこで使われているか**（ログオン先、サービス、アプリ接続）を棚卸し
    - 権限（グループ/ローカル管理者/委任/ACL）と到達性（RDP/WinRM/SMB等）を結び付ける
  - 次の一手：
    - 原則：事前認証を有効化（例外は用途を明文化し、代替設計へ）
    - 例外が必要なら：パスワード強度・鍵管理・ログ監視（異常な4768/4771）をセットで強化

- 仮説B：SPN主体が多く、RC4許容/未定義が残っている（Kerberoastの成立条件が整う）
  - 検証：
    - SPN主体の棚卸し（用途・所有者・最終更新・権限）
    - `msDS-SupportedEncryptionTypes` の未定義/RC4混在を抽出
    - DCログ（4769）で TicketEncryptionType の傾向（RC4系が出ていないか）を観測
  - 次の一手：
    - サービスアカウントの設計是正（gMSA化、最小権限、定期ローテ）
    - 暗号方式の是正（AES優先、不要なDES/RC4排除）と、影響確認（互換性・非Windows機器）

- 仮説C：上記条件が見当たらない（少なくとも“典型条件”は満たしにくい）
  - 次の一手：
    - `10_ntlm_relay`（署名/LLMNR/NBT-NS）、`15_acl_abuse`、`13_adcs` など “別の権限境界越え” を優先する
    - それでも検知を整える：4768/4769のベースラインを取り、将来の逸脱を検出可能にする

---

## 手を動かす検証（Labs連動：観測点を明確に）
- 目的：同じドメインで「成立する/しない」の差を、属性とログで再現して理解する
- 構成例（最小）：
  - DC1（KDC） + Member Server（IIS/SQL/ファイル共有のいずれか） + Client（Windows）
  - アカウント：
    - user_normal：通常ユーザー
    - user_nopreauth：事前認証不要（DONT_REQ_PREAUTH）を付与（※用途を想定して付与）
    - svc_app：SPNを持つサービスアカウント（権限は最小）
- 観測点（必須）：
  - LDAP属性：
    - user_nopreauth：`userAccountControl` の該当ビット
    - svc_app：`servicePrincipalName`、`msDS-SupportedEncryptionTypes`、`pwdLastSet`
  - DCログ：
    - 4768（TGT要求）：PreAuthType、TicketEncryptionType、Client IP
    - 4769（TGS要求）：ServiceName、TicketEncryptionType、Client IP
- 手順（“設計”としての流れ）：
  1) まず属性で状態を作る（preauth無効/SPN付与/暗号方式の設定）
  2) 次に通常利用でログを取る（通常のログオン、サービスアクセス）
  3) 最後に観測で差分を説明する（どの属性がどのログフィールドに反映されるか）
- 巻き戻し：
  - スナップショットを取り、暗号方式やアカウント設定を変えて再比較（“理解の固定化”が目的）

---

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 目的は「成立条件の棚卸し（監査）」であり、無断環境でのチケット取得やオフライン解析を目的にしない。

### 1) AS-REP Roast成立条件：DONT_REQ_PREAUTHユーザーの抽出（LDAP）
- 監査観点：
  - “事前認証不要”フラグ（userAccountControlのビット）を持つユーザーを一覧化し、用途と権限を結び付ける
~~~~
# LDAPフィルタ例（bitwise AND：DONT_REQ_PREAUTH = 0x400000）
(&(objectCategory=person)(objectClass=user)
 (userAccountControl:1.2.840.113556.1.4.803:=4194304))

# 併せて除外したい例（無効アカウント等は別条件で除外）
# userAccountControl:...:=2  は ACCOUNTDISABLE（必要に応じて）
~~~~

### 2) Kerberoast成立条件：SPN主体の抽出（LDAP）
- 監査観点：
  - SPNを持つ主体（サービスアカウント）を棚卸しし、権限/暗号方式/運用（pwdLastSet）と結び付ける
~~~~
# SPNを持つユーザー主体（コンピュータ以外）を抽出する最小フィルタ例
(&(objectCategory=person)(objectClass=user)(servicePrincipalName=*))
~~~~

### 3) 暗号方式の棚卸し：msDS-SupportedEncryptionTypes（読み方の例）
- 監査観点：
  - 未定義/RC4混在/DES混在の主体を抽出し、「互換性」と「強度」のトレードオフを明示して是正計画へ
~~~~
# msDS-SupportedEncryptionTypes（代表値の読み方：ビット和）
#  4  : RC4
#  8  : AES128
# 16  : AES256
# 28  : RC4 + AES128 + AES256（= 4 + 8 + 16）
# ※未定義（0/空）は“既定挙動”に依存するため、監査上は要確認扱い
~~~~

### 4) 証跡の観測：DCのKerberosイベント（ベースライン作り）
- 監査観点：
  - 4768（TGT）と4769（TGS）を、アカウント/サービス/Client IP/暗号方式で集計し、平常時の形を作る
~~~~
# Windows側での考え方（例：SIEM/ログ基盤に送る前提）
# - 4768：PreAuthType / TicketEncryptionType / IpAddress を軸に「通常の認証」をベースライン化
# - 4769：ServiceName / TicketEncryptionType / IpAddress を軸に「通常のサービス利用」をベースライン化
# - いずれも “高価値アカウント” は個別監視（許可された端末/時間帯/サーバ）
~~~~

---

## 参考（必要最小限）
- 観測の軸：userAccountControl（DONT_REQ_PREAUTH）、servicePrincipalName、msDS-SupportedEncryptionTypes、DCイベント（4768/4769）
- 設計の軸：サービスアカウント（gMSA化/最小権限/ローテ）、暗号方式（AES優先/RC4削減）、監査（ベースライン→逸脱検出）

---

## リポジトリ内リンク（最大3つまで）
- `01_topics/03_network/11_ldap_enum_ディレクトリ境界（匿名_bind）.md`
- `01_topics/03_network/10_ntlm_relay_成立条件（SMB署名_LLMNR）.md`
- `01_topics/03_network/14_delegation（unconstrained_constrained_RBCD）.md`
