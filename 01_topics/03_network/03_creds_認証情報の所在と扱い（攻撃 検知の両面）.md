<<<BEGIN>>>
# 03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md

（先頭要約：ガイドライン対応の位置づけ）
- ASVS：直接のNW規格ではないが、WebのAuthN/AuthZ/セッション運用は「認証情報の扱い」を前提にしており、侵入後の影響（横展開/越権）を決める核心として接続する
- WSTG：WebのCredential関連（セッション/トークン/秘密情報管理）とNWの資格情報（パスワード/ハッシュ/チケット）が地続きであることを、境界モデルで扱う
- PTES：Post-Exploitation と Lateral Movement の燃料。所在→意味→次の一手を最短で回す
- ATT&CK：Credential Access を“技術名”ではなく「どこにあり、どう伝播し、何ができるか」の状態として整理する

## 目的（この技術で到達する状態）
- 認証情報（Credentials）を「種類の暗記」ではなく、次の3点で説明できる状態にする。
  1) どこに存在するか（所在：ファイル/メモリ/設定/外部）
  2) それが何を意味するか（権限/範囲/期限/境界）
  3) 次に何を試すべきか（成立条件と分岐）
- Web起点（APIトークン/Secrets/セッション）とNW起点（パスワード/ハッシュ/チケット）を統合し、横展開や越権の“導線”を作れる。
- 攻撃観点だけでなく、検知・運用観点（どこが監査される/守るべき境界）も最低限で言語化できる。

## 前提（対象・範囲・想定）
- 対象：許可範囲の環境のみ（特に資格情報は影響が大きい）。
- 想定：
  - 資格情報は“単体で危険”ではなく、「どの境界を越えられるか」で価値が決まる
  - ローカル→ドメイン→クラウド/SaaS へ伝播し得る（逆もある）
- 依存（前段の接続）：
  - `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
  - `01_topics/02_web/02_authn_認証・セッション・トークン.md`（Web側の資格情報と統合）
- Labs連動（推奨）：
  - `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
  - `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`
- やらないこと：
  - ツール操作の手順書化（本ファイルは“所在→意味→次の一手”の地図）
  - “落とし穴”章は作らない

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 認証情報の分類（名前ではなく“境界”で分ける）
- 本人性の材料（AuthN）
  - パスワード、秘密鍵、証明書、ワンタイム、MFA要素
- 伝播する材料（Session/Token/Delegation）
  - セッションCookie、Bearerトークン、APIキー、Refreshトークン、STS/一時クレデンシャル
- OS/ドメイン由来の材料（Windows/AD）
  - ハッシュ、チケット、キャッシュ、委任、サービスアカウントの権限
- 重要：種類より「どの境界（資産/信頼/権限）を越える鍵か」を見る

### 2) 所在（Where）：どこに“残る”かを確定する
- ディスク（設定・ファイル）
  - アプリ設定、環境変数ファイル、デプロイ設定、ジョブ設定、バックアップ
- メモリ（実行中）
  - セッション/トークン、チケット、認証キャッシュ
- ログ（観測・監査）
  - アプリログ、プロキシログ、監査ログ（意図せず漏れる/あるいは検知される）
- ネットワーク（伝送）
  - 認証ヘッダ、Cookie、トークン交換、SAML/OIDC/OAuthフロー
- 外部（信頼境界）
  - IdP、SaaS、CI/CD、Vault、クラウドのメタデータ等
- “所在”は、侵入後の動き（横展開/越権）を決める一次情報

### 3) 意味（So what を使わずに）：その認証情報で何ができるか
- 権限境界
  - 何者として扱われるか（ユーザー/サービス/管理者）
- 範囲（Scope）
  - どのシステム/テナント/プロジェクト/サブネットに効くか
- 期限（Lifetime）
  - いつまで使えるか（短命/長命、更新可能か）
- 伝播（Propagation）
  - その鍵は別の鍵を生むか（Refresh→Access、委任→他サービス、SSO→複数SaaS）
- 重要：ここが“技術力の差”になる（見つけた鍵の価値を瞬時に判断できる）

### 4) 次の一手（Next move）：成立条件と分岐を作る
- A：同一境界内での権限拡大（ローカル管理、サービス権限、設定改変）
- B：隣接境界への横展開（同一NW内の他ホスト、共有、管理プロトコル）
- C：信頼境界の越境（SaaS/クラウド/IdPへ、またはそこから戻る）
- 分岐条件
  - 経路（到達性）があるか
  - 認証方式が合っているか（パスワード/鍵/トークン/チケット）
  - 監査/検知の強さ（影響制御の必要度）

### 5) 検知の観点（最低限）
- どこでログが残りやすいか（認証試行、トークン交換、管理プロトコル）
- “静かな行動”と“派手な行動”の差
  - 例：情報取得（Discovery）と認証試行（Brute/Password spray）は検知特性が違う
- 目的：防御の話を厚くするのではなく、攻撃検証の影響制御と再現性を上げる

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（確定できる）
  - どこに資格情報が存在するか（所在）
  - それが越えられる境界（権限/信頼/資産）と範囲/期限
  - 次の一手（横展開/越権/外部越境）の優先度
- 推定（追加観測で強くなる）
  - 伝播の連鎖（この鍵→別の鍵→別の境界）
  - 検知されやすさ（ログ/監査点の推定）
- 言えない（この段階の限界）
  - “確実に横展開できる”の断定（経路と相手側の設定が必要）
  - 影響最大化の断定（許可範囲と安全性がある）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
### 優先度（見つけたら価値が高い順）
1) テナント/ドメインを跨ぐ鍵（SSO/IdP/クラウド権限）
2) 管理権限に直結する鍵（管理者/サービスアカウント）
3) 横展開を加速する鍵（共有/管理プロトコルに通るもの）
4) 短命でも連鎖する鍵（Refresh/STS等）

### 攻め筋（鍵を見つけた後の最短判断）
- その鍵は「誰として」「どこまで」「いつまで」効くか
- “使えるか”を最小確認するならどこか（read-only、影響の小さいAPI等）
- 経路がないなら、経路を作る（ピボット/踏み台）か、別の鍵を探すか

### 次の仮説
- AD色が強い（Kerberos/ドメイン参加） → `04_ad` へ
- Web/APIトークンが主戦場 → `02_web/02_authn` と `02_web/04_api` へ戻る
- SaaS/IdP連携が鍵 → `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md` へ

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：Web側のSecrets/Tokenが“信頼境界越え”に繋がる
- 検証（A/B）
  - A：そのトークンが呼ぶ先（API/テナント/権限）を観測で確定
  - B：最小のread-only確認で“範囲と期限”を確定（許可範囲で）
- 期待する観測
  - 鍵の価値（越えられる境界）が説明でき、次の深掘り対象が絞れる

### 仮説B：NW側の資格情報が横展開の燃料になる
- 検証（A/B）
  - A：経路（到達性）を確認し、成立する入口（SMB/RDP/SSH等）を絞る
  - B：権限境界（ローカル/ドメイン）を確認し、どこまで伝播するかを確定
- 期待する観測
  - “どの入口に対して、どの鍵が効くか”が説明できる

### 仮説C：ADが関与し、チケット/委任/サービス権限が鍵になる
- 次の一手
  - `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md` へ進み、用語ではなく地図（境界）を作る

### 例示（最小の観測：コマンドは補助）
~~~~
# 例：環境変数に秘密が残っていないか（概念）
env | grep -i -E "token|secret|key|pass"

# 例：接続の証跡を残すための基本観測（概念）
whoami
ip route
~~~~
- 主役は「所在→意味→次の一手」の判断であり、ツール操作の羅列ではない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - Webの認証・セッション・秘密情報管理はCredentialsの扱いが前提であり、破れるとAuthZ/データ保護が崩れるため“前提を支える技術”として接続する
- WSTG：
  - 認証情報/セッション/秘密情報の観点を、NW側のCredentialsと統合し、境界越え（テナント/ロール/ドメイン）として扱う
- PTES：
  - Post-Exploitation：Credentialsの所在を確定し、横展開/越権の燃料として最短で意思決定する
- MITRE ATT&CK：
  - 戦術：Credential Access を中心に、Lateral Movement/Privilege Escalation/Discovery へ接続
  - 本ファイルでは、技術名より「どこにあり、何ができ、次に何をするか」を状態として整理する

## 参考（必要最小限）
- `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
- `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
- `01_topics/02_web/02_authn_認証・セッション・トークン.md`
- `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`

<<<END>>>