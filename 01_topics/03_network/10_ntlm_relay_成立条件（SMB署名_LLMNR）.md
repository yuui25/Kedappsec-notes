フォルダ名: `01_topics/03_network/`
ファイル名: `10_ntlm_relay_成立条件（SMB署名_LLMNR）.md`
STEP名: `NW03-10 NTLM Relay：成立条件（SMB署名/LLMNR/NBT-NS/WPAD）を“観測で確定”し、診断を安全に成立させる`

```md
## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 位置づけ：NTLM Relayは「認証の境界（AuthN）」「通信の境界（チャネル保護）」「構成/運用の境界（名前解決・署名・保護拡張）」が噛み合わない時に成立する“設計/運用の破綻”。
  - 接続：ASVSの認証要件（強固な認証・セッション・チャネル保護）を、ネットワーク/OS/AD設定が実際に満たしているかを“外形+ログ”で検証する前提になる。
- WSTG
  - 位置づけ：Webテスト結果（401/403/認可エラー等）が「アプリの認証」ではなく「NTLM/統合認証の構成」「プロキシ/終端のExtended Protection」由来であるケースがある。
  - 接続：WSTGの認証/セッション/設定検証に進む前に、NTLMがどこで使われ、どのチャネル保護が有効かを確定する。
- PTES
  - 位置づけ：Post-Exploitation/Lateral Movementに繋がる“横展開の成立条件”の分析。重要なのは攻撃手順の羅列ではなく、**成立する/しないを決める条件を観測で確定し、診断計画を前に進めること**。
  - 接続：05_scanning→09_smb_enum→（本ファイルで）relay成立条件→11_ldap_enum/12_kerberos/13_adcs/15_acl_abuse へ入力を渡す。
- MITRE ATT&CK
  - T1557 Adversary-in-the-Middle（LLMNR/NBT-NS/WPAD等の名前解決・中間者が絡む）
  - T1557.001 LLMNR/NBT-NS Poisoning and SMB Relay（概念としての分類）
  - T1046 Network Service Discovery（relay先サービス候補の探索）
  - （防御側観点）T1562 Impair Defenses 等は本ファイルの主題ではない。本ファイルは“回避手口”ではなく“成立条件の境界”を観測で確定する。

---

# 10_ntlm_relay_成立条件（SMB署名_LLMNR）

## タイトル
NTLM Relay：LLMNR/NBT-NS/WPADで“認証が飛ぶ条件”と、SMB署名/EPA/LDAP署名で“受け側が受ける条件”を分解する

---

## 目的（この技術で到達する状態）
- 「NTLM Relayが成立する/しない」を、推測ではなく **条件（必要十分条件）** と **観測根拠** で説明できる。
- 具体的に以下を満たす：
  1) 認証が“どの経路で”発生するか（LLMNR/NBT-NS/WPAD/UNC参照/内部アプリ等）を観測で確定できる  
  2) 受け側（SMB/LDAP/HTTP/ADCS等）が“何を要求しているか”（署名/保護拡張/EPA/チャネルバインディング）を確定できる  
  3) 成立しない場合でも、**なぜ成立しないか** を境界（名前解決/署名/ポリシー/到達性）として説明できる  
  4) 実施計画を「安全に成立させる調整」（速度・観測点移動・ログ突合・一時許可）へ落とせる  
  5) 次工程（LDAP/Kerberos/ADCS/ACL/GPO等）の優先度が決められる

---

## 重要な安全注記（本ファイルのスタンス）
- 本ファイルは「NTLM Relayの**具体的な攻撃実行手順（ツール操作・中継の具体コマンド）**」を目的にしない。
- 目的は“診断”として、成立条件を観測し、リスクを評価し、対策と検知設計に落とすこと。
- 実施方法は **環境の観測・設定の確認・ログ突合・安全な検証設計（テストアカウント/テスト窓/allowlist）** を中心に記載する。

---

## 前提（対象・範囲・登場人物）
### 1) 登場人物（3点固定）
- Client（被害側になり得る端末）：Windowsクライアント/サーバ（何らかの理由でNTLM認証を外部へ飛ばす）
- Relay Point（中間）：同一セグメント上の観測点、またはPivot越しの観測点（“見える/応答できる”位置）
- Target（受け側サービス）：SMB/LDAP/HTTP/ADCS 等、NTLMを受けるサービス

### 2) Relay成立を決める“2つの条件群”
- 条件群A：NTLM認証がRelay Pointへ“飛ぶ”条件（名前解決・誘導・プロキシ設定・UNC参照など）
- 条件群B：TargetがRelayされた認証を“受ける”条件（署名/保護拡張/EPA/CBT/ポリシー）

この2つのどちらかが崩れると成立しない。したがって観測は必ずA→Bの順で設計する。

---

## 概念整理（意味→判断→次の一手：ここを揃える）
### 1) “NTLM Relay”の本質（1文）
- **「被害端末が生成したNTLM認証メッセージを、別のサービスへ中継し、被害端末の権限として通す」** こと。

### 2) “ハッシュを盗む”と“リレーする”は別
- 盗む（資格情報取得）＝オフライン解析等へ繋がるが、本ファイルの主題ではない
- リレー（中継）＝**チャネル保護（署名/EPA等）が不十分な受け側**で成立する

### 3) 代表的な“受け側”と成立条件の違い
- SMB（445）
  - 重要条件：**SMB署名が required でない**
- LDAP（389/636）
  - 重要条件：**LDAP署名が required でない**、かつ（環境によって）**チャネルバインディング/EPA要求がない**
- HTTP（IIS統合認証など）
  - 重要条件：**Extended Protection for Authentication (EPA) が有効でない** など（環境依存）
- AD CS（証明書登録Web等）
  - 重要条件：HTTP/EPAや認証方式、テンプレ/権限設計が絡む（本ファイルは“境界確定”まで）

---

## 観測ポイント（観測中心：どの境界で止まっているか）
> “成立した/しない”ではなく「どの条件が満たされた/満たされなかったか」を観測で固める。

### A. 認証が飛ぶ（Client→Relay Point）側の観測
#### 1) 名前解決（LLMNR/NBT-NS/DNS/WPAD）
- LLMNR：UDP/5355（マルチキャスト）で “名前が解決できない” 時に飛びやすい
- NBT-NS：UDP/137（ブロードキャスト）で古い名前解決が残っていると飛びやすい
- WPAD：プロキシ自動検出（wpad.*）探索が残っていると、誤誘導で認証が飛ぶ起点になる

観測のゴール：
- 「どの端末が」「どんな名前を」「どのプロトコルで」解決しようとしたか（= 認証が飛び得る地形）を確定する

#### 2) NTLM認証が飛ぶトリガ（代表）
- UNC参照（\\\\HOST\\share）やリソース参照（アプリ/ショートカット/設定）
- プロキシ経由の認証（統合認証設定）
- 内部アプリが誤って外部ホストへ統合認証を送る（構成/実装の問題）

観測のゴール：
- 「ユーザ操作由来」か「バックグラウンド（サービス/自動探索）」かを切る  
  → 対策・検知設計が変わる（ユーザ教育 vs GPO/構成修正）

### B. 受け側が受ける（Relay Point→Target）側の観測
#### 1) SMB署名（最重要）
- 署名 required：リレーは成立しにくい（境界が成立している側）
- 署名 enabled（requiredではない）：環境によっては“受け側が強制しない”ため成立条件が残る
- 署名 unknown：FW/IPS/検知で観測が歪んでいる可能性

#### 2) LDAP署名/チャネル保護
- LDAP signing：要求される（required）と、特定の認証形態/中継が成立しにくくなる
- Channel Binding / EPA：LDAPSや統合認証の保護拡張により成立条件が変わる
- 重要：ここは“外形だけで断言しづらい”ため、**ポリシー/レジストリ/監査ログで確証**を取るのが実務的

#### 3) HTTP（統合認証）とEPA
- 統合認証（Negotiate/NTLM）が有効か
- EPAが有効か（有効なら中継耐性が上がる）
- これも外形だけでは不確実になりやすいので、サーバ設定とログ突合で確証化する

---

## 成立条件（必要条件を“分解して”定義する）
> ここが本ファイルの核。条件を満たす/満たさないのどちらも価値がある（境界が説明できる）。

### 条件1：ClientがRelay PointへNTLMを送る（送信条件）
- 必要条件（代表）
  - ClientがRelay Pointへ到達できる（L3/L4到達性）
  - Clientが何らかの理由でRelay Pointを“正しい宛先”だと認識する（名前解決/設定/参照）
  - Clientのポリシーが「外部へNTLMを送る」ことを許容している（制限が強いとそもそも飛ばない）

観測根拠（最低限）
- パケット観測（LLMNR/NBT-NS/WPADの問い合わせ）
- サーバ側ログ（受信した認証要求の痕跡）
- クライアント側ログ（NTLM利用の監査ログ）

### 条件2：TargetがNTLMを受ける（受信条件）
- 必要条件（代表）
  - TargetでNTLMが許可されている（Kerberos only ではない）
  - Target側の保護（署名/EPA/CBT 等）が“中継を許さない強度”になっていない
  - TargetへRelay Pointから到達できる（Pivot含む）

観測根拠（最低限）
- SMB署名 required の有無
- LDAP署名 required / CBT強制 の有無（GPO/レジストリ/監査）
- IIS/EPA設定（サーバ設定/監査）

### 条件3：Relayされた“権限”で意味のある操作が可能（影響条件）
- 必要条件（代表）
  - RelayされたアカウントがTarget上で権限を持つ（管理権限/特権/委任権限など）
  - あるいはAD上で“変更可能な権限”（ACL）を持つ

観測根拠（最低限）
- アカウント種別（ユーザ/マシン）とグループ/権限
- 既存のACL/委任（15_acl_abuse、14_delegation へ接続）

---

## 結果の意味（その出力が示す状態：何が言える/言えない）
### 1) LLMNR/NBT-NSが観測される
- 言える：名前解決の“誤誘導余地”が残っている（設計/運用の境界が緩い可能性）
- 言えない：直ちにrelayが成立するとは限らない（受け側条件が必要）

### 2) SMB署名が required
- 言える：少なくともSMBへのrelay成立条件は強く制約される（境界が成立している側）
- 言えない：他プロトコル（LDAP/HTTP/ADCS）への成立条件は別（別途観測が必要）

### 3) LDAP署名 required / CBT強制
- 言える：LDAP系の中継成立条件は制約される（境界が成立している側）
- 言えない：環境差が大きいので、外形観測だけで断言せず、設定と監査で確証が必要

### 4) “成立しない”は成果（診断では価値が高い）
- 成立しない理由を境界として言語化できれば、対策が既に効いている/意図通りの設計であることを示せる。
- 逆に「成立する可能性がある」なら、条件（どの端末/どの区間/どのサービス）を特定し、影響最小の検証設計へ落とす。

---

## 実施方法（最高に具体：観測で確定し、検証を安全に設計する）
> 手順は A（飛ぶ条件）→ B（受ける条件）→ C（影響条件） の順で固定する。  
> いきなり“成立させる”方向へ進まない。診断品質と安全性のため。

---

### Step 0：前提の固定（スコープ・送信元・ログ合意）
- 固定する
  - あなたの送信元IP（テスト元）／観測点（直/ピボット）
  - 対象範囲（CIDR/ホスト）と対象サービス（445/389/636/HTTP等）
  - テスト時間窓（監視側がログを引ける時間帯）
- 合意する（できる限り）
  - DC/サーバの監査ログ提供（該当時刻・あなたのIP・イベントID）
  - WAF/FW/IDSのアラート（誤検知・遮断の切り分けに必須）

成果物（必須）
- “観測条件メモ”（後で報告にそのまま貼れる形）
  - 例：送信元、観測点、対象、開始/終了、実施量（リクエスト数）

---

### Step 1：名前解決（LLMNR/NBT-NS/WPAD）が“現実に起きているか”を観測する
#### 1-1 受動観測（まずこれ：侵襲ゼロ）
- 目的：ネットワーク上で、LLMNR/NBT-NS/WPAD の問い合わせが発生している事実を取る
- 実施（あなたの観測点でパケット観測）
~~~~
# 代表：LLMNR(5355) / NBT-NS(137) / mDNS(5353) / DNS(53) を観測
# ifaceは環境に合わせる（eth0/tun0 等）
sudo tcpdump -i <iface> -nn -vv udp port 5355 or udp port 137 or udp port 53
~~~~

観測の読み方（判断）
- UDP/5355（LLMNR）が定期的に出る
  - → “名前解決の揺らぎ”が存在。A条件の一部が満たされ得る
- UDP/137（NBT-NS）が出る
  - → 古い名前解決が残存。A条件の一部が満たされ得る
- “wpad”を含む問い合わせが出る
  - → プロキシ自動検出が起点になり得る（構成/運用の論点が濃い）
- 何も出ない
  - → それ自体が強い証拠。relay以前に“飛ぶ条件が成立しにくい”可能性が高い（ただしトリガ依存は残る）

次の一手
- 出る：Step 1-2へ（どの端末が出しているか特定）
- 出ない：Step 2へ（受け側条件の確認）。ただし“特定業務操作時のみ出る”可能性があるため、業務手順に紐づく観測も計画する

#### 1-2 クライアント（誰が飛ばしているか）を特定する
- 目的：対策の優先順位（どのOU/端末群/サーバ群から直すか）を決める
- 実施
  - tcpdump/pcapで送信元IPを記録
  - 可能なら端末名へ解決（内部DNS/資産台帳）
- 成果物
  - “LLMNR発生端末リスト”（IP、頻度、問い合わせ名）

---

### Step 2：SMB側（445）の成立条件＝“署名 required か”を確定する
> SMB relay成立条件の最重要。ここで強く分岐が決まる。

#### 2-1 外形観測（nmap）
~~~~
# smb2-security-mode で署名要件を取る（445が対象）
nmap -Pn -n -p 445 --script smb2-security-mode <ip> -oN 10_smb_signing_<ip>.txt
~~~~

#### 2-2 サーバ側での確証（可能なら：運用者協力がある場合）
- 目的：外形推定を“設定根拠”で確定する（診断の説得力が上がる）
- Windows（サーバ）で確認（例：PowerShell）
~~~~
# サーバ側（Windows）で実施できる場合
# EnableSecuritySignature / RequireSecuritySignature を確認
powershell -NoProfile -Command "Get-SmbServerConfiguration | Select EnableSecuritySignature, RequireSecuritySignature"
~~~~

判断（次の一手）
- RequireSecuritySignature = True（required）
  - → SMB relayの成立条件は大きく制約。次はLDAP/HTTP/ADCS側へ重心を移す（Step 3/4）
- requiredでない
  - → 成立条件が残る可能性。影響条件（誰の権限が中継され得るか）を評価する（Step 5へ）

---

### Step 3：LDAP側（389/636）の成立条件＝“LDAP署名/CBT/EPA”を確定する
> LDAPは外形だけだと誤判定しやすい。原則は“設定根拠”と“監査ログ”で確証。

#### 3-1 設定で確証（DC/LDAPサーバに協力がある場合）
- LDAP署名（例：LDAPServerIntegrity）
- チャネルバインディング（例：LdapEnforceChannelBinding）
- 実施例（Windowsレジストリ確認：代表）
~~~~
# DC/LDAPサーバ側で確認（例）
# LDAP署名（LDAPServerIntegrity）
reg query "HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters" /v LDAPServerIntegrity

# チャネルバインディング（LdapEnforceChannelBinding）
reg query "HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters" /v LdapEnforceChannelBinding
~~~~

判断（次の一手）
- 署名が強制/CBT強制
  - → LDAP relayの成立条件は制約される方向。HTTP/ADCS・別経路（Kerberos/ACL）へ重心を移す
- 強制されていない/未設定
  - → 条件が残る可能性。影響条件（誰が何をできるか）をACL/委任へ接続（15/14）

#### 3-2 監査ログで確証（“検知設計”としても重要）
- 目的：NTLMがLDAPへ来ている実態、署名要件の違反/失敗をログで把握する
- 実務の進め方
  - “あなたの送信元IP、時刻、対象サーバ”を渡し、該当ログを突合してもらう
  - ここは環境でイベントの取り方が異なるため、ログ設計そのものを成果にする

---

### Step 4：LLMNR/NBT-NS/WPAD の“設定境界”を確証する（GPO/端末設定）
> 観測で出ているなら、どこで抑えられるかを具体化する。出ていなくても“今後の再発防止”として価値がある。

#### 4-1 LLMNR のGPO（代表）
- 目的：LLMNRを無効化できる運用境界を示す（端末群/OU単位）
- 実務ポイント
  - “無効化できる”だけでなく、無効化後に名前解決が破綻しない（DNS整備が前提）ことを確認する

#### 4-2 NBT-NS の無効化（代表）
- 目的：古い名前解決/ブロードキャスト依存を減らす
- 実務ポイント
  - VPN/拠点間/古いアプリが依存していることがあるため、段階的に

#### 4-3 WPAD の無効化/明示構成
- 目的：プロキシ自動検出が起点になる環境では、構成を固定化して事故を防ぐ
- 実務ポイント
  - “wpad”がDNS/ADに存在する場合の管理（予約・保護）

※このStepは「具体的なポリシー名/手順」を環境に合わせて別ファイル化してもよい（肥大化防止）。本ファイルでは“観測→確証→対策の方向”までを固定する。

---

### Step 5：影響条件（中継され得るアカウントの価値）を評価する
> relayは“成立”より“影響”が重要。成立しても低権限なら影響は限定される可能性がある。

#### 5-1 どのアカウントがNTLMを飛ばし得るか（分類）
- ユーザ操作起点（ユーザ権限）
- サービス起点（サービスアカウント/コンピュータアカウント）
- 管理系（高権限）端末からの発生
  - 例：管理端末/運用サーバがLLMNR等を発生させていると影響が跳ねる

#### 5-2 “relay先”で何が起きると危険か（成果の型）
- SMB：管理共有/サービス操作などに繋がる権限があるか（通常は管理者が必要）
- LDAP/AD：ACLや委任により“変更可能”な範囲があるか（15_acl_abuse、14_delegation）
- ADCS：証明書テンプレ/登録権限/認証方式の組合せ（13_adcs へ）

成果物（診断用メモ）
- “高価値端末/高価値アカウントがLLMNR等を発生させているか”
- “SMB/LDAP/HTTP/ADCSのどこに成立条件が残っているか”

---

### Step 6：成立しない場合の“原因特定”を手順化する（詰まりを潰す）
> relay検証が進まない時、闇雲に手数を増やすと事故になる。境界で切る。

- 代表的な詰まりと切り分け
  - そもそもLLMNR/NBT-NSが観測されない
    - → “飛ぶ条件が薄い”。業務トリガの観測、または他起点（UNC参照等）の有無を確認
  - 445/389に到達できない
    - → 08_firewall_waf（観測中心）に戻り、どの層で止まっているか確定。観測点移動（07_pivot）で再観測
  - SMB署名 required
    - → SMBをrelay先にする前提を捨て、LDAP/HTTP/ADCS/ACLへ重心を移す（“成立条件が潰れている”のは成果）
  - ログが引けない/突合できない
    - → テスト窓の合意、送信元IPの固定、ログ種別の合意（収集できるログを先に決める）

---

## 検知・証跡設計（防御側に渡す“具体”）
> “回避”よりここが実務価値。成立条件が残るなら、検知/抑止/追跡を設計する。

### 1) ネットワーク観測（最短で効く）
- LLMNR（UDP/5355）、NBT-NS（UDP/137）、WPAD関連のDNS問い合わせ
- 社内で“wpad”問い合わせが出ている端末の特定
- 突然のSMB/LDAP認証試行の増加（特定セグメントでスパイク）

### 2) Windowsログ観測（例：方向性）
- DC/サーバでのNTLM利用の監査（NTLMがどこで使われているか）
- SMB共有アクセスログ（共有名、アクセス元、認証結果）
- 失敗が多い場合のアラート（ただしノイズ対策が必要）

### 3) 設計としての抑止（優先度順）
1) LLMNR/NBT-NS/WPAD の整理（“飛ぶ条件”を潰す）
2) SMB署名 required（“受ける条件”を潰す：SMB）
3) LDAP署名 required / CBT強制 / EPA（“受ける条件”を潰す：LDAP/HTTP）
4) NTLMの段階的制限（監査→制限→例外管理）

---

## 攻撃者視点での利用（意思決定：なぜ成立条件が重要か）
- 攻撃者は“手口”より“成立地形”を探す：
  - LLMNRが出るセグメント
  - 署名がrequiredでないサーバ
  - 管理端末がいるセグメント
- 診断側はこれを逆に用い、成立地形を潰す（または監視で捕捉する）ために条件を観測で確定する。

---

## 次に試すこと（本ファイルから次ファイルへ：判断の分岐）
- SMB署名 required が多い
  - → 11_ldap_enum / 12_kerberos に重心移動（認証の別経路へ）
- LLMNR/NBT-NSが出ている端末群が特定できた
  - → OU/端末群単位の対策設計（無効化/例外/影響確認）へ
- LDAP/ADCS側に条件が残っていそう
  - → 13_adcs_証明書サービス悪用の境界、15_acl_abuse（AD権限グラフ）へ接続し、影響条件を具体化する
- そもそも到達性が悪い（filtered主体）
  - → 07_pivot_tunneling と 08_firewall_waf（観測中心）へ戻り、観測点移動で条件を再観測する

---

## 04_labs（検証環境案：成立/不成立を“境界”として体に入れる）
> 目的：攻撃手順の再現ではなく、成立条件（名前解決・署名・保護拡張）が結果を変えることを理解する。

### 最小ラボ構成
- VM1：Windows Client（LLMNR/NBT-NS/WPADの挙動を見る）
- VM2：Windows Server（SMB署名 required の切替、共有ログ観測）
- VM3：DC（LDAP署名/CBTの設定差と監査の違い）
- VM4：観測点（tcpdump/Wireshark、ログ集約）

### 変数（ここだけ変えて差分を取る）
- LLMNR：有効/無効
- SMB署名：required / not required
- LDAP署名/CBT：強制/非強制
- 期待結果：変数を変えると「どの条件が崩れて成立しないか」を説明できる

---

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：認証とチャネル保護の“設計意図”が、OS/AD/ネットワーク設定で実際に成立しているかを観測で確定する。匿名的に起きる名前解決・統合認証の挙動が境界を破る場合がある。
- WSTG：統合認証（NTLM/Negotiate）と終端（LB/WAF/Proxy）の設定がWebテスト結果を歪める。HTTPの挙動を評価する前に、NTLM/EPA/終端点を確定する。
- PTES：成立条件をA（飛ぶ）B（受ける）C（影響）に分解し、診断計画を前進させる（観測点移動、ログ突合、allowlist等）。成立しない理由も成果として提示できる。
- MITRE ATT&CK：T1557（中間者/名前解決）とT1046（サービス探索）の文脈で、環境が“成立地形”を持つかどうかを確定する。目的は回避手口ではなく境界理解。

---

## 深掘りリンク（作成済み / 予定：最大8件）
- `05_scanning_到達性把握（nmap_masscan）.md`
- `06_service_fingerprint（banner_tls_alpn）.md`
- `07_pivot_tunneling（ssh_socks_chisel）.md`
- `08_firewall_waf_検知と回避の境界（観測中心）.md`
- `09_smb_enum_共有・権限・匿名（null_session）.md`
- `11_ldap_enum_ディレクトリ境界（匿名_bind）.md`
- `12_kerberos_asrep_kerberoast_成立条件.md`
- `13_adcs_証明書サービス悪用の境界.md`
```
