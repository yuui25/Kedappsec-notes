<<<BEGIN>>>
# 02_post_侵入後の前提（権限 経路 横展開の入口）.md

（先頭要約：ガイドライン対応の位置づけ）
- ASVS：直接のNW規格ではないが、Webの脆弱性が“侵入後に何ができるか”で価値が変わるため、影響説明の前提として接続する
- WSTG：Web側の成果（例：RCE/SSRF/認証突破）が、NW側でどう展開されるかを“前提整理”として扱う
- PTES：Post-Exploitation の地図。侵入後に迷わず、最短で「権限」「経路」「横展開入口」を固める
- ATT&CK：Privilege Escalation/Lateral Movement/Credential Access を、分類ではなく“状態遷移（次の一手）”として回す

## 目的（この技術で到達する状態）
- 侵入後（Post）の最初にやるべきことを、ツール手順ではなく **状態の確定** として整理し、次の一手を自分で決められる。
  - 自分はいま何者か（権限）
  - どこに届くか（経路）
  - 次にどこへ行けるか（横展開の入口）
- Web起点（Webシェル/アプリRCE/SSRF/資格情報入手）でも、NW起点（VPN/端末侵入）でも共通で使える“初動モデル”を作る。
- 侵入後の行動を「深掘り学習」できる単位に落とし、`03_creds` と `04_ad` へ繋げる。

## 前提（対象・範囲・想定）
- 対象：許可された検証環境または許可範囲内の侵入後ホスト/セッションのみ。
- 想定：
  - 侵入後は“できること”が一気に増えるが、無秩序に動くと再現性が崩れる
  - 監視/制限（EDR、ログ監査、セグメント分割）がある前提で、影響と証跡を制御する
- 依存（前段の接続）：
  - `01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`
- Labs連動（推奨）：
  - `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
  - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`
  - `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`
- やらないこと：
  - “落とし穴”章は作らない
  - ツール羅列で終わらせない（必ず意味→判断→次の一手）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 権限（Privilege）を“状態”として確定する
- 観測対象
  - OSと実行主体（ユーザー/グループ/トークン）、権限レベル（管理者/特権）
  - どの操作が可能か（サービス管理、ファイルアクセス、資格情報領域、ネットワーク操作）
- 意味（状態）
  - “権限が何か”が分からない限り、次の行動（横展開/資格情報/永続化）は判断できない
- 次の一手
  - 権限が低い：昇格の材料（設定/サービス/資格情報）を探す方向へ
  - 権限が高い：横展開と認証情報（後述）を優先し、影響の大きい突破点へ

### 2) 経路（Path）を“到達性”として確定する
- 観測対象
  - 侵入ホストから見えるネットワーク（サブネット、名前解決、到達可能サービス）
  - 外向き通信の可否（外部へ出られるか、プロキシ必須か）
  - どのインタフェース/ルートで到達しているか（ピボットの前提）
- 意味（状態）
  - “自分がいる場所”が分かると、横展開の候補（AD/ファイル/管理系）が見える
- 次の一手
  - 経路が閉じている：ローカルで完結する深掘り（資格情報/権限）を優先
  - 経路が開いている：横展開の入口（認証が絡むサービス）を優先して絞る

### 3) 横展開の入口（Lateral Entry）を“認証と権限境界”として特定する
- 観測対象（代表）
  - AD/認証基盤：ドメイン参加、Kerberos/NTLMの兆候
  - 管理プロトコル：SMB/RDP/WinRM/SSH
  - 共有資源：ファイル共有、管理共有、構成管理
- 意味（状態）
  - 横展開は「到達できる」だけでは成立しない。“認証が成立する入口”と“権限が乗る経路”が必要
- 次の一手
  - 入口が見えたら、次は `03_creds` で認証情報の所在を固める
  - ドメイン色が強いなら、`04_ad` に繋いで地図を作る

### 4) 認証情報（Credentials）の“所在”の兆候を集める（まだ深掘りはしない）
- 観測対象（兆候の段階）
  - 設定ファイル、環境変数、サービス設定、履歴、共有、チケット/キャッシュの存在
- 意味（状態）
  - 侵入後の勝負は“認証情報と権限伝播”。兆候があるなら最短で `03_creds` に移る
- 次の一手
  - 兆候が強い：`03_creds` を優先
  - 兆候が弱い：まず権限/経路/入口を固めて、取りに行く対象を絞る

### 5) 証跡（再現性）と影響制御を維持する
- 観測は“少なく・確実に”
  - 何をしたか（コマンド/操作）より、どんな状態が変わったか（権限/経路/到達性/副作用）を残す
- 影響制御
  - 不要なサービス停止や大量アクセスを避ける
  - ラボでは snapshot/reset を前提に“巻き戻せる検証”にする

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（確定できる）
  - 現在の権限状態（何者で、何ができるか）
  - 現在の経路状態（どこに到達できるか、外へ出られるか）
  - 横展開の入口候補（どの認証が絡むサービスが近いか）
- 推定（追加観測で強くなる）
  - ドメイン参加の有無とAD依存の強さ
  - 監視/制限の存在（検知されやすい行動の把握）
- 言えない（この段階の限界）
  - 具体的な横展開が成立するか（認証情報が必要）
  - 権限昇格が可能か（材料の深掘りが必要）
  - 全体構造（複数ホストの地図）は段階的に作る必要がある

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
### 優先度（侵入後の最短勝ち筋）
1) 権限（今の自分の強さ）を確定
2) 経路（どこへ動けるか）を確定
3) 横展開入口（認証が絡むサービス）を絞る
4) 認証情報の所在を固めて取りに行く（`03_creds`）
5) AD地図が必要なら `04_ad` へ

### 攻め筋（次の一手を外さないための分岐）
- 権限が弱い × 入口が近い：まず creds を取りに行く（横展開成立に寄せる）
- 権限が強い × 経路が広い：横展開候補を最短で絞り、影響の大きい突破点へ
- 経路が狭い：ローカルの権限・creds・設定を深掘りして突破口を作る

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：ドメイン環境が絡む（ADの地図が必要）
- 次の一手
  - `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md` へ進み、用語ではなく“地図（資産/信頼/権限境界）”を作る

### 仮説B：横展開の入口は見えるが、認証情報が足りない
- 次の一手
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md` へ進み、所在→意味→次の一手を固める

### 仮説C：権限が弱く、まず昇格の材料が必要
- 次の一手
  - “どこに材料があるか” を creds/設定/サービスとして整理し、ラボで再現できる単位に落とす（実務では範囲と影響制御を厳守）

### 例示（最小の観測：コマンドは補助）
~~~~
# 例：権限状態の確認（Windows/Linuxで代表）
whoami
id

# 例：経路・到達性の手掛かり（概念）
ip a
ip route
~~~~
- 主役はコマンドではなく、「権限」「経路」「入口」を状態として確定すること

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 直接のNW規格ではないが、Webで得た足場（例：RCE/SSRF/認証突破）の“影響”は侵入後の権限/経路/横展開で決まるため、影響説明の前提として接続する
- WSTG：
  - Webテストの結果が、内部NWにどう繋がるか（境界越え）を整理する前提として位置づける
- PTES：
  - Post-Exploitation：侵入後に最短で権限/経路/横展開入口を固め、次の行動を意思決定する
- MITRE ATT&CK：
  - 戦術：Privilege Escalation、Lateral Movement、Credential Access、Discovery 等
  - 本ファイルでは、分類より「状態遷移（次の一手）」として使う

## 参考（必要最小限）
- `01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`
- `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
- `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

<<<END>>>