フォルダ名: `01_topics/03_network/`
ファイル名: `09_smb_enum_共有・権限・匿名（null_session）.md`
STEP名: `NW03-09 SMB Enum：共有/権限/匿名可否を“境界”として確定し、横展開・認証攻撃の入口を作る（null session中心）`

```md
## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 位置づけ：SMB共有は「機微データ保護」「アクセス制御」「運用境界（管理系と業務系の分離）」の実体。匿名/Guestで見える・書けるは、認可/設定/運用の破綻として説明できる。
  - この技術で支える前提：共有（資産）境界と権限境界（誰が何へアクセスできるか）を外形から確定し、アプリ要件以前の露出を潰す判断材料にする。
- WSTG
  - 位置づけ：Web中心のWSTGでも「ファイル配布（設定、鍵、バックアップ）がWeb以外に露出している」ケースは実務で多い。SMBから設定/鍵/ログが取れると、WebのAuthN/AuthZや秘密管理の検証に直結する。
  - この技術で支える前提：Webテストの前に“機微が別経路で漏れる”入口を排除/証明する。
- PTES
  - 位置づけ：Scanning/Enumeration → Vulnerability Analysis の中核。SMBは「横展開・資格情報・永続化」に直結するため、到達したら優先して確定する価値が高い。
  - 前後接続：05/06で見えた445/139を、ここで「何が見えるか（共有）」「誰として見えるか（匿名/Guest/認証）」「どこまでできるか（R/W）」へ落とし、10/11/12/以降へ渡す。
- MITRE ATT&CK
  - T1135 Network Share Discovery：共有の列挙とアクセス確認
  - T1087 Account Discovery：匿名/低権限でのユーザ/グループ推定（可能な環境のみ）
  - T1021.002 Remote Services: SMB/Windows Admin Shares：成立条件の前段（本ファイルは“列挙と境界確定”に集中）
  - （接続）NTLM Relay（10）やAD列挙（11/12/15/16）へ繋がる「入口情報」を作る

---

# 09_smb_enum_共有・権限・匿名（null_session）

## タイトル
SMB Enum：共有（Share）/権限（Share+NTFS）/匿名（null session・Guest）を“境界”として確定する

---

## 目的（この技術で到達する状態）
- 445/139が開いている対象に対して、次を“観測根拠つき”で言い切れる。
  1) SMBの実体（Windows/Samba/NAS等の種別、SMB dialect/署名要件、ドメイン帰属）
  2) 匿名（null session）/Guest/認証済み それぞれで「見える共有」「入れる共有」「書ける共有」を区別できる
  3) 共有権限（Share Permission）とファイル権限（NTFS/ACL）の“二段階”を混ぜずに評価できる
  4) 得られた結果から、次工程（NTLM relay / LDAP / Kerberos / GPO / LAPS / WinRM/RDP）へ、迷いなく入力を渡せる
- さらに実務品質として、以下ができる。
  - 影響制御（ログ/負荷/試行回数）を意識した列挙設計ができる
  - 成果物（表）として、IPごとの状態（匿名可否、共有、R/W、署名要件）を整理できる

---

## 前提（対象・範囲・成立条件）
### 対象（典型）
- Windows（Workgroup / AD参加サーバ / DC / ファイルサーバ）
- Samba（Linuxファイルサーバ、NAS、アプライアンス）
- ルータ/複合機などのSMB実装（機能限定・独自挙動）

### スコープと安全
- SMB列挙は“認証試行”を伴う。許可された範囲・時間窓・送信元（あなたのIP）を固定する。
- 目的は「共有と権限の境界確定」。パスワード当て・過剰な試行は別テーマ（必要なら別ファイル/手順で合意して実施）。

### SMBの“境界モデル”（混ぜると誤診する）
- 境界1：到達性（L4）… 445/139へ届くか（05_scanning）
- 境界2：SMBの握手… SMB1/2/3のどれで会話できるか、署名の要件は何か
- 境界3：認証… 匿名/null、Guest、ユーザ（NTLM/Kerberos）で挙動がどう変わるか
- 境界4：共有（Share）… 共有一覧が見えるか、入れるか
- 境界5：権限（ACL）… “共有に入れた”後、読み/書き/列挙がどこまで可能か（Share権限＋NTFS/ACL）

---

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) SMB “握手”の観測（最初に取る：全ての分岐の土台）
- 観測したいもの
  - SMB dialect（SMB1が必要/禁止、SMB2/3の可否）
  - 署名（SMB Signing）が enabled か required か
  - ドメイン/ホスト名/OS推定（可能な範囲）
- 意味
  - 署名 required は、後続のNTLM relay成立条件を大きく制約する（10_ntlm_relayへ接続）
  - dialect/署名が取れない場合、列挙が途中装置（FW/IPS）で制御されている可能性を疑う（08へ戻す）

### 2) 認証境界の観測（null / Guest / 認証済み を分離）
- 観測したいもの
  - null session（ユーザ名空＋パス空 or no-pass）で “何が見えるか”
  - Guest（guest/空パス等のマッピング）で “何が見えるか”
  - 失敗時の応答（ACCESS_DENIED / LOGON_FAILURE / STATUS_NOT_SUPPORTED 等）
- 意味
  - “共有一覧が出る” と “共有に入れる” は別（一覧は見えるが入れない、が普通に起きる）
  - 認証成功でも、権限が弱いと中身は見えない（権限境界が成立している、という結論にもなる）

### 3) 共有権限とファイル権限（2段階）を分けて観測
- 観測したいもの
  - Share単位：READ/WRITE 可能か（入口）
  - ディレクトリ/ファイル：list/read/write 可能か（内部）
- 意味
  - ShareでWRITEでも、NTFSで拒否される（逆もある）
  - “書ける”は、横展開・永続化・改ざんの入口になり得るため、必ず根拠（操作ログ/結果）を残す

### 4) 証跡として残す最低限
- ip / hostname（取れれば）/ domain（取れれば）
- signing：enabled / required / unknown
- anonymous：可否（一覧/入室/読み/書き）
- shares：名前、説明、アクセス可否、R/W推定、根拠（コマンドと主要出力）

---

## 結果の意味（その出力が示す状態：何が言える/言えない）
### 状態A：null sessionで共有一覧が見える
- 言える
  - “匿名でも共有メタ情報が見える”＝情報露出（資産境界の破れ）の可能性
  - 次に「入室（connect）できる共有があるか」を確認する価値がある
- 言えない
  - “中身が読める/書ける”は別。必ず共有ごとに確認が必要

### 状態B：null sessionで共有に入れて、list/read できる
- 言える
  - 機微情報や設定が置かれている運用なら、認証境界が崩れている可能性が高い
  - 共有の用途次第で、Web/AD/クラウドへ連鎖し得る（例：設定/鍵/バックアップ）
- 言えない
  - それが“意図した公開”か“事故”かは、共有の目的・配置・運用ルールの確認が必要（診断では事実とリスクを分けて書く）

### 状態C：null sessionは不可、Guestは可
- 言える
  - 匿名は塞いでも、Guestマッピングで実質的に匿名が成立している構成の可能性
  - 共有と権限の境界が、Guestの扱いで破れる
- 言えない
  - Guestが“意図的に公開”かどうかは要確認。公開共有なら公開範囲と内容が評価点

### 状態D：署名 required
- 言える
  - “SMB経由の特定クラスの攻撃（例：relay）”の成立条件に強い制約が入る（10へ）
  - ただし列挙自体は成立する場合がある（署名 required でも認証済み列挙は普通に可能）
- 言えない
  - “安全”とは言えない。共有の権限や内容が弱ければ別経路で破れる

---

## 実施方法（最高に具体：手順を固定し、結果を表に落とす）
> 方針：低侵襲（少試行）→ 事実確定（共有/権限）→ 必要なら深掘り（RPC/ユーザ推定）  
> まず「匿名で見えるか」を最短で確定し、その後に“共有ごとのR/W”へ進む。

### Step 0：入力を整える（05_scanningの成果を受ける）
- 入力（最低限）
  - SMB候補：445/tcp open（必要なら139も）
  - `targets_smb.txt`：IP一覧
- 出力（このファイルの成果物）
  - `smb_matrix.md`（または表）：IPごとの signing / anonymous / shares / R/W / 次の一手

---

### Step 1：SMBの握手と署名を“先に”確定する（nmapで十分）
目的：匿名可否を見る前に、後段の意思決定（relay/横展開）に効く情報を取る。

~~~~
# 代表：SMB2のセキュリティモード（署名）とプロトコル
nmap -Pn -n -p 445 --script smb2-security-mode,smb2-time,smb-os-discovery <ip> -oN 09_smb_nmap_<ip>.txt
~~~~

判断（ここで分岐）
- signing: required → 10_ntlm_relay は“成立しにくい/制約が強い”側に倒す
- smb-os-discoveryが取れない/不自然 → 08_firewall_waf（観測中心）へ戻り、どの層で止まっているか再確認

---

### Step 2：null session（匿名）で“共有一覧が見えるか”を確定する
目的：最小試行で「匿名が成立するか」を確定する。ここで無駄に試行回数を増やさない。

~~~~
# 共有一覧（匿名）：-N はパスワード無し（null sessionの入口）
smbclient -N -L //<ip> -m SMB3

# 共有一覧が出ない場合、RPC（匿名）で握手できるか（環境により）
rpcclient -U "" -N <ip> -c "srvinfo"
~~~~

結果の読み方（状態）
- smbclientで共有一覧が出る → Step 3へ（共有ごとの入室/権限確認）
- smbclientで拒否（例：LOGON_FAILURE/ACCESS_DENIED）→ Step 2b（Guest/低権限の有無）へ
- rpcclientが通る → “匿名でRPCが許可”の可能性（ユーザ/グループ推定に進む価値がある）

---

### Step 2b：Guest（または空パス）で“実質匿名”が成立していないか確認する
目的：nullは塞いでもGuestマッピングで公開になっているケースを拾う。

~~~~
# Guestユーザを明示（環境によっては user=guest, pass=空 が通る）
smbclient -U "guest%"" -L //<ip> -m SMB3

# 共有の見え方が変わるかを見る（差分観測）
~~~~

判断
- Guestで共有が増える/入れる共有が出る → “匿名境界がGuestで破れている”としてStep 3へ
- どれも不可 → 認証済みでの列挙へ（必要なら資格情報入手後に再実施）

---

### Step 3：共有（Share）ごとに「入れるか」「読めるか」「書けるか」を確定する
目的：一覧ではなく“実害の境界”を確定する。共有単位でR/Wを切る。

#### 3-1 共有に入れるか（connect / list）
~~~~
# 例：匿名で特定共有へ入ってみる（入れないなら即拒否で分かる）
smbclient -N //<ip>/<share> -m SMB3 -c "ls"
~~~~

判定
- lsが通る → 読み（list）成立。次に「読み取り」へ
- ACCESS_DENIED → 共有一覧は見えても入れない（境界がある）。次の共有へ

#### 3-2 読み取りが成立するか（ファイル1つを読む前提を作る）
- ここで重要なのは“持ち出し”ではなく、**機微ファイルが置かれていないかの存在確認**。
- 実務では、以下の“分類”で見る（例）
  - 設定：*.conf, *.ini, web.config, application.yml, .env
  - 秘密：id_rsa, *.key, *.pfx, *.kdbx, credential系メモ
  - バックアップ：*.bak, *.zip, *.7z, *.tar, DB dump
  - 自動化：scripts, deploy, ci, ansible, terraform
- ただし本topicsでは「探索パターン」を列挙しすぎず、共有の用途に合わせて観測する。

~~~~
# 共有内の階層を浅く観測（再現性のため、いきなり再帰しない）
smbclient -N //<ip>/<share> -m SMB3 -c "ls; cd <dir>; ls"
~~~~

#### 3-3 書き込みが成立するか（“テストファイル”で最小確認）
- 影響制御：書き込み確認は“最小の検証ファイル”を置いて、すぐ消す（合意がある前提）。
- 書ける＝重大なので、根拠（成功/失敗）を必ず残す。

~~~~
# ローカルに極小ファイルを作る
printf "smb_write_test\n" > smb_write_test.txt

# put -> 成功/失敗で書けるかを見る（成功したら必ず消す）
smbclient -N //<ip>/<share> -m SMB3 -c "put smb_write_test.txt smb_write_test.txt; del smb_write_test.txt"
~~~~

判定
- put成功 → 共有+ACLのどこかがWRITEを許可（永続化/改ざん/横展開の入口になり得る）
- put失敗 → 共有は見えても書けない（境界が成立）

---

### Step 4：匿名で“ユーザ/グループ情報”が漏れるか（可能な環境だけ）
目的：AD/ドメイン環境で、匿名でも“名前の面”が取れると、後段（Kerberos/LDAP）の探索効率が上がる。

> 注意：ここは環境依存が強い。通らないのが普通の構成も多い。  
> 通らない場合は潔く止めて、共有のR/W確定を優先する。

~~~~
# 匿名RPCに入れた場合の代表コマンド（通るものだけ拾う）
rpcclient -U "" -N <ip> -c "srvinfo"
rpcclient -U "" -N <ip> -c "lsaquery"
rpcclient -U "" -N <ip> -c "enumdomusers"
rpcclient -U "" -N <ip> -c "enumdomgroups"
~~~~

判断
- enumdomusers が通る → ユーザ名母集団が取れる（11_ldap_enum / 12_kerberos で効く）
- lsaquery が通る → ドメイン情報・ポリシー断片が取れる場合がある（ただし断定はログで）
- どれも拒否 → “匿名のディレクトリ情報は閉じている”として共有評価へ集中

---

### Step 5：管理共有（ADMIN$ / C$）の扱いを“誤解しない”
- ADMIN$/C$ が見える/見えない、は環境差が大きい。
- 観測として重要なのは「低権限/匿名で管理共有へ入れるか」。
  - 入れないのが通常（境界が成立）
  - 入れるなら重大（ただし誤設定/特殊運用の根拠が必要）

~~~~
# 例：見えている場合でも、入室できるかは別（通常は拒否される）
smbclient -N //<ip>/C$ -m SMB3 -c "ls"
~~~~

---

### Step 6：結果を“意思決定できる形”に整形する（成果物テンプレ）
> 次ファイルへ渡すための最小情報。ここが曖昧だと横展開の判断がブレる。

- 1行（1ホスト）に最低限これを持つ：
  - ip
  - host/domain（取れたら）
  - signing（required/enabled/unknown）
  - anonymous（一覧OK/入室OK/読OK/書OK の4段階）
  - guest（同上）
  - shares（列挙、各shareのR/W推定）
  - “次の一手”（10 relay / 11 ldap / 12 kerberos / 15 acl / 16 gpo / 18 winrm / 19 rdp）

例（表の形の一例）
~~~~
| ip | host | domain | signing | anon_list | anon_read | anon_write | shares(R/W) | 次の一手 |
|---|---|---|---|---|---|---|---|---|
| 10.0.0.10 | FS01 | CORP | required | yes | no | no | Public:R, IT:Denied | 11 LDAP, 12 Kerberos（別経路で認証後） |
| 10.0.0.20 | NAS | - | enabled | yes | yes | yes | share:R/W | 影響評価（機微有無）/ 運用合意 |
~~~~

---

## 攻撃者視点での利用（意思決定：なぜSMBが“入口”になるか）
> ここは“手口”ではなく、状態が攻め筋をどう変えるかを書く。

### 1) 匿名で読める共有がある
- 意思決定：まず“情報で勝てる”可能性が高い（設定・鍵・バックアップ）
- 次に繋がる：Web（秘密管理/認証）、AD（スクリプト/配布物）、クラウド（資格情報）へ連鎖する
- 診断としての主張：資産境界（公開範囲）と権限境界（匿名の扱い）が破れている可能性を、事実（見えた共有/読めたパス）で示せる

### 2) 書ける共有がある
- 意思決定：横展開・永続化・改ざんの入口になり得る（ただし本ファイルは“成立条件の確定”まで）
- 診断としての主張：Writeの成立は重大。共有用途（配布/ログ/受け渡し）と配置（管理系/業務系）を合わせて評価し、境界の妥当性を問える

### 3) 署名 required / anonymous不可
- 意思決定：SMB単体の“抜け”は起きにくい。次はLDAP/Kerberos/別のリモート管理（WinRM/RDP/SSH）へ寄せる
- 診断としての主張：SMBの境界は成立している可能性がある（ただし他経路で破れる可能性は残る）。次工程で全体として評価する

---

## 次に試すこと（仮説A/Bの分岐：条件が違うと次の手が変わる）
### 分岐1：匿名で共有一覧が取れる
- 仮説A：一覧だけで入室不可（情報露出のみ）
  - 次の一手：共有名/説明/命名規則から資産推定（管理/バックアップ/公開）→ 認証後に再検証する計画を立てる
- 仮説B：入室・読が成立する共有がある（実害の可能性）
  - 次の一手：共有用途に沿って“機微の有無”を観測（設定/鍵/バックアップ）→ Web/AD/クラウドの次工程へ繋ぐ（02_web / 11~ へ）

### 分岐2：匿名もGuestも不可
- 仮説A：正しく境界が閉じている（認証が必要）
  - 次の一手：11_ldap_enum / 12_kerberos の“認証前提”に進む（別入口で認証を得る設計）
- 仮説B：観測点が悪い（FW/セグメントで制御されている）
  - 次の一手：07_pivot_tunnelingで観測点を移して再実施（内部からは見える共有があるケース）

### 分岐3：Pivot越しにSMBを扱う必要がある（SOCKS相性問題を避ける）
- 仮説A：SOCKS越しにSMBクライアントが不安定/非対応
  - 次の一手：ポートフォワードで “ローカルの任意ポート→内部445” を作り、ツール側の接続先を localhost:任意ポート に固定する
~~~~
# 例：SSHローカルフォワード（1445）→内部ターゲット:445
ssh -L 127.0.0.1:1445:<target_ip>:445 -N <user>@<pivot_ip>

# smbclientは -p でポート指定して localhost に向ける
smbclient -N -p 1445 //127.0.0.1/<share> -m SMB3 -c "ls"
~~~~

---

## 手を動かす検証（04_labs と接続：観測→解釈→利用を再現）
> labsは“手順書”ではなく“境界設計”。SMBは設定差で挙動が激変するため、再現できると理解が固定される。

### 最小ラボ設計（2パターンで十分）
- パターン1：Windowsファイルサーバ（AD参加でも単体でも可）
  - 共有A：匿名で一覧だけ見える（入室不可）
  - 共有B：GuestでRead可
  - 共有C：特定ユーザのみRead/Write（Share権限とNTFSの二段階を意図的にズラす）
  - 観測：Securityログ（4624/4625/5140/5145）で「何をしたら何が残るか」を確認
- パターン2：Samba（Linux）
  - map to guest の有無で “実質匿名” がどう変わるかを再現
  - 署名/SMBバージョンの制約差で、列挙ツールの挙動がどう変わるかを観測
- ゴール
  - “共有一覧が出る” と “中身が読める/書ける” の差を体で説明できる
  - 同じ共有でも、Share権限とNTFS/ACLのどちらで拒否されているかを切り分けできる

---

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：匿名/Guestでの共有アクセス可否は、アクセス制御・機微情報保護の運用境界そのもの。事実（共有/権限）として示し、設計（最小権限/公開範囲）に落とす。
- WSTG：Webの脆弱性がなくても、SMB経由で設定・鍵・バックアップが露出していれば同等以上の影響になり得る。Webテストの前提（秘密管理/認証境界）を崩す経路として扱う。
- PTES：Enumerationとして、SMBの共有/権限/匿名可否を確定し、後段（NTLM relay、LDAP/Kerberos、横展開）へ入力を渡す。
- MITRE ATT&CK：T1135（共有列挙）、T1087（アカウント推定）、T1021.002（SMBリモートサービス成立の前段）に接続する。

---

## 深掘りリンク（作成済み / 予定：最大8件）
- `05_scanning_到達性把握（nmap_masscan）.md`
- `06_service_fingerprint（banner_tls_alpn）.md`
- `07_pivot_tunneling（ssh_socks_chisel）.md`
- `08_firewall_waf_検知と回避の境界（観測中心）.md`
- `10_ntlm_relay_成立条件（SMB署名_LLMNR）.md`
- `11_ldap_enum_ディレクトリ境界（匿名_bind）.md`
- `12_kerberos_asrep_kerberoast_成立条件.md`
- `16_gpo_永続化と権限境界.md`
```
