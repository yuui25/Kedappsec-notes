<<<BEGIN>>>
# 04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md

（先頭要約：ガイドライン対応の位置づけ）
- ASVS：直接のAD規格ではないが、Webの認証（SSO）や権限制御はAD/IdP連携に依存し得るため、“前提を支える技術”として接続する
- WSTG：SSO/認証基盤（SAML/OIDC）を扱う際に、背後のAD（アカウント/グループ/権限）を理解していると検証が急に速くなる
- PTES：Post-Exploitation/Lateral Movement の主戦場。ADを“用語”ではなく“地図（境界と導線）”として扱う
- ATT&CK：Discovery/Credential Access/Privilege Escalation/Lateral Movement を、ADの構造上の“状態遷移”として回す

## 目的（この技術で到達する状態）
- ADを「難しい用語の集合」ではなく、ペンテストで必要な最小の地図として理解し、次を説明できる。
  - 何が資産で、どこが境界か（資産境界）
  - どこから先が信頼で繋がっているか（信頼境界：信頼関係/委任/連携）
  - どこで権限が切り替わる/伝播するか（権限境界：グループ/委任/チケット）
- “なぜそれが攻撃面になるのか”を、観測→意味→次の一手で回せる。
- Web/IdP/クラウドと繋がるADの位置づけを理解し、NW・Webの両側から検証を組み立てられる。

## 前提（対象・範囲・想定）
- 対象：許可範囲のドメイン環境または検証ラボ（推奨）。
- 想定：
  - ADは「認証」だけでなく「権限の配布と伝播」の仕組み
  - 侵入後はADが“最短で影響が広がる地図”になりやすい
- 依存（前段の接続）：
  - `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- Labs連動（推奨）：
  - `04_labs/03_targets/03_ad_lab_検証用ドメイン構成.md`
  - `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`
- やらないこと：
  - 典型攻撃の羅列（手法カタログ化）ではなく、地図（構造と導線）を作る
  - “落とし穴”章は作らない

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) ADの資産（Asset）を“最小セット”で捉える
- 資産（何が重要か）
  - ドメインコントローラ（DC）：認証とディレクトリの中心
  - アカウント：ユーザー、サービスアカウント、管理者
  - グループ：権限の配布単位（誰が何をできるか）
  - コンピュータ：参加端末/サーバ（どこがドメイン内か）
  - ポリシー/設定：権限の形を決める（委任、アクセス制御）
- 意味（状態）
  - これらの関係が“権限境界”と“伝播”を作る

### 2) 信頼境界（Trust Boundary）を捉える：どこまでが同一の信頼か
- 観測対象
  - フォレスト/ドメインの分割
  - ドメイン間/フォレスト間の信頼関係
  - 連携（IdP/SSO/クラウド同期：AAD Connect等の位置づけ）
- 意味（状態）
  - 信頼境界を跨げると影響が急拡大する（逆に跨げないなら局所化する）
- 次の一手
  - 信頼があるなら“越境点”を探す
  - 信頼がないなら“局所で権限を上げる”へ寄せる

### 3) 権限境界（Privilege Boundary）を捉える：どこで権限が切り替わるか
- 観測対象
  - グループの権限（Domain Admins 等）
  - 委任（Delegation）：特定操作を誰に任せているか
  - ローカル管理者権限の分布（端末/サーバで誰が管理者か）
- 意味（状態）
  - “誰がどこを管理できるか” が横展開の最短導線を決める
- 次の一手
  - まず「いまの自分の権限」と「次に狙える権限境界」を結ぶ

### 4) 認証とチケット（Kerberos中心）を“伝播の仕組み”として捉える
- 観測対象
  - Kerberos/NTLM のどちらが主か（環境の兆候）
  - チケットがどの境界を跨ぐ材料になっているか（委任/サービスアクセス）
- 意味（状態）
  - チケットは“認証情報”であり、環境によっては横展開の燃料になる
- 次の一手
  - credsの所在（キャッシュ/設定/サービス）へ戻り、どこに材料があるかを固める

### 5) “地図”としての最小アウトプット（手法より先に作る）
- 最小の地図項目（これだけは埋める）
  - ドメイン名/フォレスト、DC候補
  - 主要グループ（管理系）、サービスアカウントの存在
  - 端末/サーバの役割（ファイル、業務、管理）
  - 信頼関係/連携（あるなら）
  - 自分の位置（どの端末で、どの権限）
- 目的
  - 以降の攻め筋（横展開/昇格/認証情報収集）を“迷わず”選べる

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（確定できる）
  - AD環境の最小地図（資産/信頼/権限境界の当たり）
  - 自分の位置（どこにいて、どの権限で、どこへ行けそうか）
  - 横展開の入口（認証が絡むサービスと権限境界）
- 推定（追加観測で強くなる）
  - 信頼関係の影響範囲
  - 権限伝播の連鎖（委任・グループ・サービス）
- 言えない（この段階の限界）
  - 具体攻撃が成立するか（材料と経路が必要）
  - 内部ポリシーの詳細（観測が必要）
  - 全体網羅（段階的に広げる）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
### 優先度（最短で影響が拡大する順）
1) 権限境界（管理系グループ/委任/ローカル管理者の分布）
2) 信頼境界（信頼関係/連携）— 越境点があれば最優先
3) 認証材料（チケット/キャッシュ/サービスアカウント）
4) 資産（DC/重要サーバ）への到達性

### 攻め筋（地図→導線→材料の順）
- 地図が薄いなら：まず地図を埋める（観測の追加）
- 導線が見えたなら：次に必要な材料（creds/権限）を特定する
- 材料が見つかったなら：成立条件（経路/監査）を確認して最小行動で検証する

### 次の仮説
- 連携（IdP/クラウド同期）が見える → `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md` へ接続
- 侵入後の経路が課題 → `02_post` に戻って経路（ピボット/到達性）を固める
- 認証材料が課題 → `03_creds` に戻って所在を固める

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：ADの地図がまだ薄く、横展開先が決められない
- 次の一手
  - 最小地図項目（ドメイン/DC/主要グループ/役割/自分の位置）を埋める観測を優先
  - 観測は“差分”で：権限が変わると見えるものが変わるかを確認する

### 仮説B：権限境界が見え、次に必要な材料が認証情報だ
- 次の一手
  - `03_creds` に戻り、“所在→意味→次の一手”で材料を確定する

### 仮説C：SSO/IdP/クラウド連携が越境点になりそうだ
- 次の一手
  - SaaS/IdPの信頼境界へ：`01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`

### 例示（最小の観測：コマンドは補助）
~~~~
# 例：自分の主体（権限）を確定（概念）
whoami

# 例：ドメイン参加の兆候を観測（概念）
# Windowsなら systeminfo / nltest 等の情報が手掛かりになるが、
# まずは「ドメインか、ローカルか」「どこに認証が依存しているか」を状態で確定する
~~~~
- 主役は「ADの地図（資産/信頼/権限境界）」であり、コマンド暗記ではない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - Webの認証・認可・セッションはAD/IdP連携に依存し得るため、背後の権限モデル（グループ/委任）を理解することがWeb検証の前提になる
- WSTG：
  - SSO/認証基盤の検証を行う際、AD側のアカウント/グループ/権限境界を地図として把握していると、誤設定/越権の観測が具体化する
- PTES：
  - Post-Exploitation/Lateral Movement：ADを地図化し、次の一手（材料と導線）を意思決定する
- MITRE ATT&CK：
  - 戦術：Discovery/Credential Access/Privilege Escalation/Lateral Movement 等
  - 本ファイルは、技術の羅列ではなく「境界と導線」を状態として整理する

## 参考（必要最小限）
- `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
- `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- `04_labs/03_targets/03_ad_lab_検証用ドメイン構成.md`

<<<END>>>