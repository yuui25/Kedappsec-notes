## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - この技術で満たす/破れる点：出力エンコーディング（コンテキスト別）、テンプレート自動エスケープの前提崩し（Raw出力/unsafe API）、CSP 等のブラウザ制御、入力の信頼境界（第三者から到達するパラメータ）を“実行”に変えない設計
- WSTG：
  - Input Validation Testing：Testing for Reflected Cross Site Scripting（WSTG-INPV-01）に対応（反射＝単一レスポンス内で成立、被害はリンク/誘導に依存）
- PTES：
  - 該当フェーズ：Vulnerability Analysis → Exploitation（成立根拠の確定）→ Reporting（再現条件・影響範囲・修正の優先順位）
  - 前後フェーズとの繋がり：Web recon で「反射しそうな入力面（検索、エラー表示、リダイレクト、ログイン失敗、トラッキング）」を絞り込み、入力→レスポンスの差分観測で “実行境界” を確定してから深掘りする
- MITRE ATT&CK：
  - 該当戦術：Initial Access / Execution（ユーザがページを開くことでクライアント側が侵害される導線）
  - 参考技術：Drive-by Compromise（T1189）として「Web閲覧を起点にクライアント側を侵害」する枠に接続
  - 攻撃者の目的：ユーザ操作の乗っ取り（被害者権限での操作・情報取得・追加侵害の足場）

---

## タイトル
反射XSS（Reflected XSS）境界モデル

## 目的（この技術で到達する状態）
- 反射XSSを「payloadが通る/通らない」ではなく、以下の“境界”として説明できるようにする
  - どの入力が、どのレスポンス上のどの“実行コンテキスト”に入ったか（HTML/属性/JS/URL/CSS）
  - どの防御（テンプレ自動エスケープ、出力エンコーディング、CSP、フレームワーク）が“どの境界”を守っているか
  - どの差分観測で「実行された」を低侵襲に確定できるか（PoCは最小・現実の制約前提）
- 実務の判断として、次を即断できる
  - “再現性（リンク誘導が必要）” を踏まえたリスク評価（特に認証後ページ/SSO前後の影響差）
  - 修正の核が「入力フィルタ」ではなく「コンテキスト別出力処理＋テンプレ運用＋CSP」であることの説明（再発防止まで）

## 前提（対象・範囲・想定）
- 対象：
  - URLクエリ/パス/フォーム/ヘッダ等の入力が、そのまま（または整形後）HTMLレスポンスへ反映されるページ
  - 典型：検索、フィルタ、エラーメッセージ、リダイレクト先表示、ログイン失敗表示、デバッグ表示
- 想定する環境：
  - CDN/WAFの前段がある場合あり（ただしWAFは本質対策ではなく、回避不能前提にしない）
  - SPAでも “SSR/テンプレ描画/エラーページ/OGP生成” で反射が残ることがある
  - 近年はCSP導入が増加（nonce/strict CSP の有無で現実の成立条件が大きく変わる）
- できること/やらないこと（安全に検証する範囲）：
  - 目的は「反射→実行コンテキスト→成立根拠」の確定と影響見積り
  - 侵害行為（情報窃取・継続侵害の具体化）に踏み込まず、PoCは最小の可観測（例：軽量な実行確認）に留める
- 依存する前提知識（必要最小限）：
  - HTML/JS/URLの基本コンテキスト、出力エンコーディング（コンテキスト依存）
  - CSPの基本（script-src、nonce/strict CSP）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（やり取りの単位）：
  - 1リクエスト→1レスポンスで、入力がレスポンスに“反射”されるか（反射＝単一レスポンス内で成立）
- 境界の観点：
  - 資産境界：反射が起きるページが「認証前/認証後/管理UI/SSOコールバック」どこに属するか
  - 信頼境界：入力が第三者（攻撃者）から被害者へ届けられる経路（リンク、リファラ、外部サイト埋め込み等）を想定できるか
  - 権限境界：被害者がそのページで持つ権限（一般/管理/テナント跨ぎ）が何か
- 重要なフィールド/差分/状態（ここが変わると意味が変わる）：
  - 反射位置のコンテキスト（最重要）
    - HTML本文テキスト / HTML属性値 / URL属性（href/src）/ JS文字列 / JSON / CSS
  - エンコーディングの種類（HTMLエスケープ、属性エスケープ、URLエンコード、JSエスケープが混在し得る）
  - 正規化の有無（URLデコード回数、Unicode正規化、改行正規化）
  - 防御の状態：CSP（script-src、unsafe-inline、nonce）、テンプレ自動エスケープの無効化箇所、DOM操作有無（DOMは別ファイルで深掘り）
  - 反射の“経路”：同期表示（即時）か、リダイレクトを挟むか、エラーページに落ちるか（エラーモデルに接続）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか：
  - 入力がレスポンスへ反射される事実（反射箇所の特定）
  - 反射箇所の実行コンテキスト（HTML/属性/JS/URL等）
  - 防御の一部（エスケープ・CSP）が“どのコンテキストに効いているか”の観測
- 何が“推定”できるか（推定の根拠/前提）：
  - 反射箇所が複数ある場合：同一入力が別コンテキストへ分岐していないか（例：本文＋属性）
  - CSPが強い場合：インライン実行が抑制され、成立には別経路（許可済みスクリプト起点等）が必要になる可能性（ただし本ファイルでは“CSP状態の把握”まで）
- 何は“言えない”か（不足情報・観測限界）：
  - 反射がある＝必ず任意JS実行、とは限らない（コンテキスト適切エスケープやCSPで止まる）
  - 本番での実害（情報窃取等）は、権限・操作導線・CSP・SameSite等の複合で決まるため、追加観測が必要
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：HTML本文に未エスケープ反射（即時に重大）
  - パターンB：属性値に反射（クォート/属性種別で成立条件が変化）
  - パターンC：JS/JSON文脈に反射（エスケープ差分で成立条件が大きい、影響は強いが観測は慎重に）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”：
  - 反射箇所が「認証後ページ」や「管理UI」にある場合、被害者権限での操作代行に直結しやすい（誘導＝社会工学が必要でも、影響が大きい）
  - 反射が「SSO/OIDC/SAMLフローの途中（エラー表示、callback周辺）」にある場合、影響が“局所”に見えても横展開（ログイン連鎖）に接続する可能性がある
- 優先度の付け方（時間制約がある場合の順序）：
  1) 反射位置のコンテキスト（HTML/属性/JS）を確定
  2) CSPの強度を把握（nonce/unsafe-inlineの有無）
  3) 影響が大きいページ（認証後・高権限・重要操作導線）を優先
  4) “反射が1点でも、同一入力が別経路で格納/DOMへ流れていないか”を横断観測（次ファイルへ接続）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：反射コンテキストを固定し、最小PoCで「実行境界を跨いだ」根拠を確定（＝報告に耐える）
  - 攻め筋2：CSP/エスケープの設計レビューに落とし込み、「なぜ再発するか（テンプレ運用/例外API/Raw出力）」まで特定
  - 攻め筋3：入力経路の拡張（クエリだけでなく、ヘッダ/パス/エラー引数など）で反射点を増やす（ただし“回避テクニックの羅列”ではなく、設計上の反射点探索として行う）
- 「見える/見えない」による戦略変更：
  - 反射がレスポンスに見えない：別画面遷移/エラー画面/ログ表示など“表示点”を追う（入力→表示の経路特定が主）
  - CSPが強い：PoCは無理に突破せず、CSP適用範囲・例外（unsafe-inline/許可ドメイン）を観測し、影響見積りを現実化する（突破の具体手順に寄せない）

## 次に試すこと（仮説A/Bの分岐と検証）
> 条件が違うと次の手が変わる形で書く（反射XSSは“どの文脈にいるか”が分岐の根本）

- 仮説A：HTML本文（テキストノード）に未適切エスケープで反射している
  - 次の検証：
    - 入力が “タグとして解釈される余地” を持つかを差分観測（文字として出る/構造が壊れる/DOM構造が変わる）
    - 反射箇所の前後（テンプレ断片）を特定し、同じ変数が別箇所にも出ていないか確認
  - 期待する観測：
    - 成功：反射位置が“文字列”ではなく“HTML構造”として解釈される兆候
    - 失敗：`<` `>` 等がエスケープされ、文字として表示される（防御の根拠になる）

- 仮説B：属性値コンテキストに反射している（href/src/任意属性）
  - 次の検証：
    - クォート有無（`"`, `'`）と属性種別（URL属性・イベント属性等）を観測し、同一入力でも変換ルールが変わるかを見る
    - URL属性の場合、URLエンコード→属性エンコードの順序が正しいかを確認（設計レビュー観点）
  - 期待する観測：
    - 成功：クォートやエンコード差分でDOM属性値の構造が変わる
    - 失敗：属性値が常に安全にエスケープされ、`javascript:` 等の危険スキームが成立しない（根拠として記録）

- 仮説C：JS/JSON文脈に反射している（`<script>`内、JSON埋め込み、data属性からのJS利用）
  - 次の検証：
    - 文字列境界（クォート、バックスラッシュ）の扱いを差分観測し、単純なHTMLエスケープでは守れない“JSエスケープ”が適用されているか確認
    - CSP（script-src）が強い場合、インライン実行が抑止されているかも合わせて確認
  - 期待する観測：
    - 成功：JS構文エラーや動作差分が入力に連動（＝JS文脈にいる根拠）
    - 失敗：入力がJSONとして安全にエンコードされ、実行には至らない（ただしDOM側で再解釈されないかは別ファイルで追う）

- 仮説D：反射はあるが、WAF/フィルタ/正規化で単純差分が見えづらい（ただし本質対策ではない）
  - 次の検証：
    - “同じ意味”の入力でも、表示側の正規化（デコード回数/改行処理/Unicode）で差分が出ないかを観測し、反射経路の処理段（デコード→テンプレ→エンコード）を推定
  - 期待する観測：
    - 成功：どこかで「入力が復元」されている（設計上の処理段が見える）
    - 失敗：観測が不十分。保存/別画面/ログ表示の可能性へ切替（格納/DOMへ接続）

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - 追加候補：`04_labs/02_web/05_input/06_xss_reflected_boundary/`
- 取得する証跡（目的ベースで最小限）：
  - HAR（入力値とレスポンスの差分、リダイレクト有無）
  - レスポンスHTMLの該当断片（反射位置の前後、CSPヘッダ）
  - 可能なら：ブラウザコンソールのエラー（JS構文エラー等）※“情報採取”ではなく成立根拠としてのみ利用
- 観測の取り方（どの視点で差分を見るか）：
  - 反射位置の“文脈”を固定する：同じパラメータで値だけを変え、DOM構造/属性/スクリプト周りの差分を見る
  - CSPはヘッダで確定：`Content-Security-Policy` の script-src と unsafe-inline/nonce を記録する

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 例：検索ページの反射を観測する（cURLは“差分観測”の道具）
curl -i "https://example.test/search?q=keda_xss_marker_123"

# 期待する観測（レスポンス内）
# - keda_xss_marker_123 がどこに出るか（本文/属性/JS/JSON）
# - Content-Security-Policy の有無と script-src の状態
# - リダイレクトが挟まるか（Locationに反射していないか）
~~~~
- この例で観測していること：
  - 反射点（位置）と文脈（コンテキスト）、CSPヘッダの状態
- 出力のどこを見るか（注目点）：
  - HTML上の反射位置（前後のテンプレ断片）
  - `Content-Security-Policy`（script-src / nonce / unsafe-inline）
  - `Content-Type`（HTMLとして解釈されるか）
- この例が使えないケース（前提が崩れるケース）：
  - 反射が認証後のみ：同一手順をログイン後に再実施し、権限境界を変えて影響評価する
  - レスポンスがJSONのみ：反射はDOM側で解釈される可能性があるため、DOM編（03）へ接続する

## 参考（必要最小限）
- OWASP WSTG：Testing for Reflected Cross Site Scripting（反射XSSの定義と観測観点）
- OWASP Cheat Sheet：Cross Site Scripting Prevention（コンテキスト別エンコーディング、URL属性の扱い）
- MDN：CSP script-src（イベントハンドラ等も含む制御範囲）
- MDN：CSP ガイド（nonce/strict CSP の考え方）

## リポジトリ内リンク（最大3つまで）
- `01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
- `01_topics/02_web/06_config_03_セキュリティヘッダ（CSP_HSTS_Frame_Referrer）.md`
- `01_topics/02_web/02_authn_01_cookie属性と境界（Secure_HttpOnly_SameSite_Path_Domain）.md`
