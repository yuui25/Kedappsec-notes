## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 破れる：WAF/CDNの例外運用（パス除外、直オリジン、特定ヘッダ/特定IP許可）で保護が分断され、同じアプリでも“守りが薄い入口”が生まれる。ヘッダ信頼（X-Forwarded-*等）を誤ると権限境界が崩れる。
  - 満たす：適用範囲を仕様化し、例外は期限・理由・監査を持つ。直オリジン到達を遮断し、アプリ側の入力検証/認可と二重化する。
- WSTG
  - 観点：境界装置の存在確認、適用範囲、例外パス、直オリジン到達、応答差分（ヘッダ/エラー/キャッシュ）を検証する。
- PTES
  - 位置づけ：情報収集（配布経路）→ 脆弱性分析（例外/分断）→ 侵害評価（保護外入口からの成立）→ 報告（運用要件）。
- MITRE ATT&CK
  - Defense Evasion（境界装置回避）を支える前提。T1190の成功率を上げる環境要因になり得る。

---

## タイトル
CDN/WAF運用境界（ルール例外・バイパス）：防御は“例外運用”で壊れる

---

## 目的（このファイルで到達する状態）
- CDN/WAFを「あるから安全」ではなく、**適用範囲と例外条件がどこで境界を破るか**を観測で固められる。
- 実務で頻出の分断を所見化できる。
  - webhook/upload/callback等の例外パス
  - 誤検知回避でのルール無効化
  - 直オリジン到達（DNS/証明書/ネットワーク）でWAF外し

---

## 扱う範囲（本ファイルの守備範囲）
- 適用範囲（ホスト/パス/メソッド）と例外運用（期限/理由/監査）
- 直オリジン到達・別ホストでの保護外入口
- “守りの責務分離”（WAFは補助、アプリが本体）を崩さない評価

---

## 前提：運用は必ず例外を作る（誤検知・連携・性能・可用性）
### 現実で例外になりやすい入口
- /webhook（外部SaaS連携）
- /upload（大きいボディ、誤検知回避で除外されがち）
- /callback（SSO/決済）
- /api/*（パートナー連携でIP許可、ヘッダ条件許可など）

---

## 境界モデル（CDN/WAFが破る/守る境界）
- 資産境界：どこまでがCDN/WAF配下か（サブドメイン/別ホスト/直IP）
- 信頼境界：外部連携の入口（webhook等）に例外が集中する
- 権限境界：管理/重要操作が例外になっていないか（最悪パターン）

---

## 観測ポイント（現実で刺さる順）
### 1) 応答差分で“適用外”を疑う
- 同じ入力でも、パス/ホストでブロック挙動が変わる
- エラーページやヘッダ（WAF由来、CDNキャッシュ兆候）で生成主体を推定

### 2) 例外条件を固定する
- 特定パスだけ通る
- 特定ヘッダがあると通る（内部連携ヘッダ等）
- 特定IP帯が許可（社内/パートナー）
※例外の存在自体が“入口の偏り”を作る。

### 3) 直オリジン到達の可能性
- DNS/証明書の取り回しで、オリジンが露出しやすい（現実によくある）
- “CDNで閉じている”前提が崩れると、保護が消える

---

## 結果の意味（この状態なら何が言えるか）
- 適用範囲が分断：攻撃者は“守りが薄い入口”に集中できる
- 例外が恒久：運用上の負債として固定化される（優先度を上げる）
- 直オリジン疑い：CDN/WAFを前提にした防御が無効化され得る

---

## 攻撃者視点での利用（現実での狙い方）
- “ブロックされる入力”から、例外条件（パス/ホスト/ヘッダ）を探す
- webhook/upload/callbackのような例外入口から、入力検証や認可の弱い面を狙う
- 直オリジンがあれば、境界装置を迂回して同じアプリを叩く

---

## 次に試すこと（仮説A/Bで分岐）
### 仮説A：例外はパス単位（最頻出）
- 次の一手
  - 例外パスの理由（誤検知/要件）を確認し、期限・監査・代替策（ルール調整）を要求
  - 例外パスはアプリ側防御（入力検証/認可/レート制限/監査）を強化する要件に落とす

### 仮説B：直オリジン/別ホストが存在（重大）
- 次の一手
  - 直オリジン遮断（許可元をCDNに限定、ネットワークACL等）を最優先
  - “同一アプリ”の証跡（挙動/ヘッダ/エラー差分）を揃え、影響半径を所見化

---

## 修正（現実で通る要件）
- 適用範囲の仕様化（ホスト/パス/メソッド）
- 例外は期限・理由・監査（恒久例外を禁止）
- 直オリジン遮断を前提要件にする（“WAFがある”前提を崩さない）

---

## 04_labs（例外運用を再現：同じアプリでも入口で守りが変わるを体感）
- 追加候補Lab（例）
  - `04_labs/02_web/06_config/10_cdn_waf_exceptions_boundary/`
- Lab設計要件
  - パス例外・ヘッダ例外・直オリジン疑いを再現できる構成
  - 目的：差分観測で例外条件を固定し、運用要件（期限/監査/遮断）に落とせること

---

## コマンド/例（例示は最小限：観測と判断を優先）
~~~~
# CDN/WAFは「あるか」より「どこで効かないか」。
# - パス/ホストでブロック挙動が変わるか（差分）
# - 例外条件（ヘッダ/IP）が存在するか
# - 直オリジン疑いがないか（資産境界）
~~~~

---

## 深掘りリンク（最大8）
- `06_config_06_debug_endpoints（/actuator_/swagger）露出.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_05_cache_control_機微レスポンスの境界.md`
- `05_input_18_http_request_smuggling_04_observable_signals（timing_error_cache）.md`
- `05_input_19_cache_poisoning_02_unkeyed（headers_params）.md`
- `05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
