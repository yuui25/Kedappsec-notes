<<<BEGIN>>>
# 03_authz_01_境界モデル（オブジェクト_ロール_テナント）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：V4（Access Control）を中心に、V2（Authentication）/ V3（Session Management）/ V13（API）へ接続。認可は「誰が何をできるか」の境界設計であり、実装差分の説明が求められる。
- WSTG：WSTG-ATHZ（Authorization）で、境界モデル（主体・対象・操作・条件）を作り、差分検証（A/B）で結論を出すための前提。
- PTES：Vulnerability Analysis（境界の仮説化）→ Exploitation（最小再現）→ Reporting（根拠提示）をブレさせない。“権限が違うから”を、モデルと証跡で説明する。
- MITRE ATT&CK：Discovery / Collection / Privilege Escalation に接続。認可境界が崩れると、データ到達や権限拡大の導線が短くなるため、攻撃者の意思決定に直結する。

## 目的（この技術で到達する状態）
- 認可を「IDだけ変えたら見えた」ではなく、**境界（主体・対象・操作・条件）をモデル化**し、観測→差分→結論で説明できる。
- Web画面・APIの両方で、認可の失敗が「401（身元）」「403（権限）」「404（隠蔽）」「200（通過）」のどれとして現れるかを整理し、誤解を減らす。
- ケース（03_cases）に残すべき情報（前提・差分・証跡・結論）を固定し、再現性のある判断ができる。

## 前提（対象・範囲・想定）
- 対象：Webアプリ／APIにおけるアクセス制御（画面/機能/データ/管理操作）。
- 観測点（固定）：
  - Proxyログ（必須）：リクエスト差分（ID/トークン/ヘッダ/ボディ）とレスポンス差分（Status/Body/Headers）
  - 必要時：サーバログ（認可失敗理由の補強）、UI上の表示差分（画面は“結果”、根拠は通信）
- 依存（関連）：
  - Authn：`01_topics/02_web/02_authn_01_cookie属性と境界（Secure_HttpOnly_SameSite_Path_Domain）.md`
  - Authn：`01_topics/02_web/02_authn_02_session_lifecycle（更新_失効_固定化_ローテーション）.md`
  - 観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - 親：`01_topics/02_web/03_authz_認可（IDOR BOLA BFLA）境界モデル化.md`

## 観測ポイント（何を見ているか：境界の分解）
認可の議論を安定させるため、まず「境界モデル」を4要素に分ける。

### 1) 主体（Subject）
- 誰として操作しているか（一般ユーザ、管理者、別ロール、別テナント、未認証 など）
- 主体の表現：
  - Cookie/Session
  - Bearer Token / API Key
  - SSO由来のクレーム（roles, groups 等）※推測せず、まず通信に現れる情報から入る

### 2) 対象（Object）
- 何にアクセスしているか（ユーザ情報、注文、プロジェクト、ファイル、設定、管理機能）
- 典型的な“対象の識別子”：
  - URLパス：`/users/{id}`、`/orders/{id}` のようなID
  - クエリ：`?id=...`
  - JSONボディ：`{"userId":...}`
  - ヘッダ：`X-Org-Id` 等

### 3) 操作（Action）
- 何をしたいか（read / create / update / delete / approve / export 等）
- HTTPとの関係：
  - GET=参照、POST=作成、PUT/PATCH=更新、DELETE=削除（ただし実装次第なので“推定”で断定しない）

### 4) 条件（Condition）
- 認可判断が変わる条件（所有者、組織、ロール、状態、時間、スコープ）
- 例：
  - 所有者のみ編集可
  - 同一組織のみ参照可
  - 管理者のみ承認可
  - 状態が“未確定”のときのみ削除可

この4要素を埋めると、差分検証が「IDを変える」から「境界を1つだけ動かす」に変わる。

## 認可の失敗パターン（結果の読み違いを防ぐ）
> 同じ“拒否”でも意味が違う。結果だけで断定せず、必ず前提（主体）と差分を添える。

- 401：身元がない／身元が無効（Authn境界の問題）
- 403：身元はあるが権限がない（Authz境界の問題）
- 404：存在を隠す設計（Authzの可能性もある。差分で確定する）
- 200/204：通過（認可が成立、またはそもそも認可が無い可能性）
- 302：再認証誘導（Authnへ戻されている可能性。Cookie/Token送信を確認）

## 境界モデルの作り方（意味→判断→次の一手）
### ステップ1：対象の“粒度”を決める（何が単位か）
- 意味：対象が「ユーザ」「組織」「プロジェクト」「リソース集合」など何単位で守られているかを決める。
- 判断：
  - 単位が曖昧だと、差分が“たまたま”に見える。
- 次の一手：
  - UIとAPIを突き合わせて、「どの操作がどの対象IDに紐づくか」をProxyで確定する。

### ステップ2：主体の差分を用意する（最低2主体）
- 意味：同じ操作でも結果が変わる主体を用意する（UserA/UserB、一般/管理、TenantA/TenantB）。
- 判断：
  - 主体差分が無いと、Authzの検証は成立しない（境界を動かせない）。
- 次の一手：
  - 可能なら最低「UserA（所有者）/UserB（非所有者）」を作り、同じ操作を比較できるようにする。

### ステップ3：境界を1つだけ動かす（差分検証の原則）
- 意味：同時に複数要素を変えると原因が特定できない。
- 判断：
  - 例：IDもトークンも変えた、だと境界不明になる。
- 次の一手：
  - まず「主体は固定、対象IDだけ変える」。次に「対象は固定、主体だけ変える」。

### ステップ4：結論は yes/no/unknown で出す
- yes：主体が違っても対象に到達でき、操作も成立する（境界が崩れている可能性）
- no：主体差分で拒否が起きる（境界が効いている可能性）
- unknown：前提が揃っていない（主体差分が無い／対象IDが同一性を持たない／ログ不足）

## 代表的な認可問題の分類（境界モデルに落とす）
> 用語より「どの境界が壊れるか」で捉える。

### オブジェクト境界の崩れ（IDベース）
- 典型：対象IDを変えると別人のデータが読める/更新できる
- モデル上の崩れ：Object の境界（所有者/組織条件が効いていない）

### ロール境界の崩れ（機能ベース）
- 典型：一般ユーザが管理機能を実行できる
- モデル上の崩れ：Subject の権限（roles/groups）と Action の結び付きが弱い

### テナント境界の崩れ（組織・分離）
- 典型：TenantAのユーザがTenantBの資産を参照/操作できる
- モデル上の崩れ：Condition（tenantId/orgId）での分離が効いていない

### 参照は守るが更新が崩れる（読み/書き境界）
- 典型：GETは403だが、PUT/PATCHは通る（または逆）
- モデル上の崩れ：Action ごとの条件適用の不整合

## 手を動かす検証（最小：差分セット）
~~~~
# 目的：認可境界を「主体・対象・操作・条件」で分解し、1要素だけ動かして差分を取る

# 差分セット（最小）
# 1) 主体A（所有者）で対象Xを read → 期待：200
# 2) 主体B（非所有者）で同じ対象Xを read → 期待：403/404
# 3) 主体Aで対象Xを update（PATCH/PUT） → 期待：200/204
# 4) 主体Bで同じ対象Xを update → 期待：403/404

# 記録すべきもの
# - 主体（Cookie/Tokenの違い）
# - 対象ID（どこに埋まっているか：path/query/body/header）
# - 操作（HTTPメソッド/エンドポイント）
# - 結果（Status/Bodyの差分）
# - 結論（yes/no/unknown）と根拠（Proxyログ保存先）
~~~~

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（証跡で断定できる）
  - 主体差分で結果が変わるか（境界が効いているか）
  - 対象ID差分で結果が変わるか（オブジェクト境界）
  - 操作差分で結果が変わるか（read/write境界）
- 言えないこと（追加証跡が必要）
  - なぜ拒否されたかの内部理由（サーバログ/実装確認が必要な場合がある）
  - 404が“隠蔽”なのか“存在しない”なのか（主体差分と対象の実在確認が必要）

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：403/404の違いで迷う
- 次に試すこと
  - 同一対象IDについて、主体A/主体Bで結果を並べ、差分が一貫するかを見る
- 期待する観測
  - 主体差分で404になる＝隠蔽の可能性（ただし断定せず、条件を追加して確定）

### 仮説B：画面では見えないがAPIが怪しい
- 次に試すこと
  - UI操作で発生したAPIをProxyで抽出し、対象IDの位置（path/query/body）を確定してから差分を作る
- 期待する観測
  - UIはガードされてもAPIで境界が崩れる/崩れないを切り分けられる

### 仮説C：テナント/組織境界が疑わしい
- 次に試すこと
  - orgId/tenantId 相当の値がどこに入っているか（JWTクレーム、ヘッダ、URL、ボディ）を観測し、1要素だけ変えて差分を取る
- 期待する観測
  - “同一主体でも組織を変えると結果が変わる”を根拠として示せる

## 参考（必要最小限）
- 親：`01_topics/02_web/03_authz_認可（IDOR BOLA BFLA）境界モデル化.md`
- 関連（Authn）：`01_topics/02_web/02_authn_02_session_lifecycle（更新_失効_固定化_ローテーション）.md`
- 観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- 実行：`02_playbooks/04_authz_境界モデル→検証観点チェック.md`

## 深掘りリンク（親ファイル末尾に追加する枠：最大8件）
- （親）`01_topics/02_web/03_authz_認可（IDOR BOLA BFLA）境界モデル化.md` の末尾に本ファイルへのリンクを追加する
  - `03_authz_01_境界モデル（オブジェクト_ロール_テナント）.md`

---

<<<END>>>
