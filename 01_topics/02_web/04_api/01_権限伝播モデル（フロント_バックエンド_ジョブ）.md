<<<BEGIN>>>
# 04_api_01_権限伝播モデル（フロント_バックエンド_ジョブ）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：V13（API）とV4（Access Control）を中核に、V2（Authentication）/ V3（Session）/ V1（Architecture）へ接続。API境界では「主体がどこで決まるか」「権限がどこまで伝播するか」が品質を左右する。
- WSTG：APIの検証では、入口（フロント）だけでなく、バックエンド連携や非同期処理まで含めて“主体と対象”を追う必要がある。差分検証で伝播経路を確定する。
- PTES：Vulnerability Analysis（権限伝播の仮説化）→ Exploitation（最小再現）→ Reporting（根拠提示）。APIは推測が混ざりやすいので、相関キーで潰す。
- MITRE ATT&CK：Discovery / Collection / Privilege Escalation に接続。権限伝播の穴は、データ到達や操作権限拡大に直結するため、攻撃者の意思決定に影響する。

## 目的（この技術で到達する状態）
- “APIはAuthzが難しい”を解消し、**主体（誰）・対象（何）・操作（何をする）・条件（いつ/どのスコープ）**を追跡して、権限伝播の境界を説明できる。
- フロント→バックエンド→ジョブ（非同期）まで、**どこで主体が変わる／失われる／上書きされる**かを、観測→差分で確定できる。
- 認証・認可の問題を混同せず、APIで起きる“権限のズレ”を最短で切り分けられる。

## 前提（対象・範囲・想定）
- 対象：REST/GraphQL 等のAPI、またはWeb画面の背後のJSON API。
- 想定する構成要素：
  - フロント（ブラウザ/SPA/モバイル）
  - API Gateway/Edge（存在する場合）
  - バックエンドサービス（複数でもよい）
  - 非同期（ジョブ/キュー/バッチ/ワーカー）
- 観測点（固定）：
  - Proxyログ（必須）：APIリクエスト/レスポンス、ヘッダ、ボディ、ステータス
  - 必要時：入口ログ（アクセスログ）、バックエンドログ、監査ログ（クラウド/基盤）
- 依存（関連）：
  - Authn：`01_topics/02_web/02_authn_02_session_lifecycle（更新_失効_固定化_ローテーション）.md`
  - Authzモデル：`01_topics/02_web/03_authz_01_境界モデル（オブジェクト_ロール_テナント）.md`
  - 観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - 親：`01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`

## 観測ポイント（何を見ているか：伝播の経路と境界）
### 1) 主体が入る場所（Identity Injection Point）
- Cookie/Session → API（同一オリジン）
- Authorizationヘッダ（Bearer/JWT/API Key）
- カスタムヘッダ（X-User, X-Org 等）※推測で信じず、どこで付与されるかを確定する
- バックエンド間（サービス間）での主体伝播（内部トークン/署名/相互TLS等）

### 2) 主体が変わる場所（Identity Transformation Point）
- ロール/スコープが付与・削除される（ログイン時、再認証時、権限昇格時）
- テナント/組織が切り替わる（切替UI、プロジェクト切替、サブアカウント等）
- “代理実行（impersonation）”が発生する（管理機能、サポート機能）

### 3) 主体が失われる場所（Identity Loss Point）
- 非同期ジョブへ渡るとき、主体情報が落ちる
- キュー/イベント経由で“システム主体”に置き換わる
- キャッシュ/プリフェッチで“誰として実行したか”が曖昧になる

### 4) 対象が決まる場所（Object Resolution Point）
- パス/クエリ/ボディ/ヘッダのどこで対象IDが指定されるか
- バックエンド側で“暗黙に対象が決まる”パターン（例：token内のuserIdを使う、直近選択プロジェクトを使う）

## 権限伝播モデル（3つの典型）
### モデルA：フロント主体がそのままAPIへ伝播（直通型）
- 特徴：フロントのCookie/TokenがAPIへそのまま渡る
- 典型リスク：
  - API側の認可漏れ（主体はあるが対象条件が弱い）
  - フロントで隠しているだけ（APIは通る）
- 観測の要点：
  - Cookie/TokenがAPIに送られているか
  - 対象IDの位置（path/query/body）を確定する

### モデルB：フロント→バックエンドで主体が変換（Gateway/Backend変換型）
- 特徴：フロントのトークンがバックエンドで内部トークンに変換される
- 典型リスク：
  - 変換時にスコープが広がる（過剰権限）
  - 変換が一部エンドポイントで抜ける（穴が点在）
- 観測の要点：
  - 入口と内部でヘッダ/トークン形式が変わるか
  - “どの条件で変換されるか”を差分で特定する

### モデルC：非同期ジョブで主体がシステムに置換（ジョブ置換型）
- 特徴：キュー投入後は“システム主体”で実行される（ユーザ主体が消える）
- 典型リスク：
  - ユーザの権限境界がジョブで無視される（別人データ処理、過剰操作）
  - 取り消し・再実行で別主体の影響が出る
- 観測の要点：
  - 入口操作→後続結果（通知/出力/ファイル生成）のタイムラインを作る
  - “誰の操作として実行されたか”をログ/相関キーで追う

## 意味→判断→次の一手（権限伝播を切る実務判断）
### 1) 「APIは同じに見える」問題を解く
- 意味：UI上は同じ操作でも、裏では複数APIが動き、主体/対象の決まり方が違う。
- 判断：
  - 1リクエストの成否だけで境界を判断しない（周辺APIもセットで見る）
- 次の一手：
  - UI操作1回に対するAPI列をProxyで抽出し、「主体が入る場所」「対象が決まる場所」をマーキングする

### 2) 伝播の穴は「例外経路」に出る
- 意味：通常経路はチェックがあるが、例外（エクスポート、検索、バルク、Webhook、プレビュー）で抜ける。
- 判断：
  - “便利機能”ほど伝播が複雑で穴が出やすい
- 次の一手：
  - 例外経路を候補化し、同じ主体差分で比較する（A/B）

### 3) 非同期は“主体消失”を疑う
- 意味：キュー投入で主体が落ちると、最終結果だけ見て原因が分からない。
- 判断：
  - 結果が遅れて出る機能（生成/集計/通知）は、まずタイムラインを作る
- 次の一手：
  - 相関キー（時刻/リクエストID/ジョブID/出力ID）をケースに固定して追跡する

## 手を動かす検証（最小：差分セット）
~~~~
# 目的：権限伝播の境界を「1要素だけ動かす」差分で確定する

# 差分セット（最小）
# 1) 主体Aで操作（UIまたはAPI）→ 生成/参照/更新が成功する
# 2) 主体Bで同じ操作 → 結果がどう変わるか（403/404/200等）
# 3) 対象IDだけ変える（主体は固定）→ 対象境界が効くか
# 4) 非同期がある場合：操作→結果までのタイムラインを作る（時刻/IDを記録）

# 記録すべきもの
# - 主体（Cookie/Tokenの差）
# - 対象（IDが入る場所）
# - 操作（エンドポイント/メソッド）
# - 相関キー（request-id, trace-id, job-id 等）
# - 結果（即時レスポンス + 後続結果）
~~~~

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（証跡で断定できる）
  - 主体がどこで決まり、どこまで伝播するか（直通/変換/置換）
  - 対象境界がAPIで効いているか（Object/Condition）
  - 例外経路や非同期で境界が揺れるか（穴の位置）
- 言えないこと（追加証跡が必要）
  - 内部サービス間の主体変換の詳細（内部ログ/設定が必要な場合）
  - クラウド基盤側の権限（IAM）が絡む場合の根拠（監査ログが必要）

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：UIではできないがAPIでできそう
- 次に試すこと
  - UI操作で出たAPIを列挙し、対象IDの位置を確定してから差分（ID/主体）を作る
- 期待する観測
  - UIガードとAPIガードの差を、通信差分で説明できる

### 仮説B：便利機能（検索/エクスポート/バルク）だけ挙動が違う
- 次に試すこと
  - 通常APIと例外APIを並べ、同じ主体差分で比較する
- 期待する観測
  - 例外経路でだけ対象境界が崩れる/崩れないを確定できる

### 仮説C：非同期結果が別主体に見える
- 次に試すこと
  - ジョブID/出力IDを起点に、入口操作の主体と一致するかを追う（タイムライン化）
- 期待する観測
  - “主体消失/置換”の位置を yes/no/unknown で言える

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - V13（API）での認可・入力・エラーハンドリングに加え、V4（アクセス制御）での“主体×対象×操作×条件”の整合を支える
- WSTG：
  - APIの検証を「入口だけ」で終わらせず、バックエンド/非同期まで含む境界モデルで差分検証を成立させる
- PTES：
  - 境界仮説→差分再現→根拠提示の流れを崩さず、権限伝播の位置を説明できる状態を作る
- MITRE ATT&CK：
  - 権限伝播の穴は Discovery/Collection/Privilege Escalation の導線を短くするため、意思決定の根拠として整理する

## 参考（必要最小限）
- 親：`01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`
- 関連：`01_topics/02_web/03_authz_01_境界モデル（オブジェクト_ロール_テナント）.md`
- 観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`

## 深掘りリンク（親ファイル末尾に追加する枠：最大8件）
- （親）`01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md` の末尾に本ファイルへのリンクを追加する
  - `04_api_01_権限伝播モデル（フロント_バックエンド_ジョブ）.md`

---

<<<END>>>
