## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 破れる：CSPが未導入/形骸化（unsafe-*固定、適用漏れ）だとXSSの実行自由度が高い。違反レポートが無統制だと、内部URL/PIIが“ログ基盤”へ流れ、別の信頼境界を破る。
  - 満たす：Report-Onlyで壊さず観測し、違反をカテゴリ分解して段階的に強制へ移行する。レポート収集はアクセス制御・最小化・保持統制されたログとして扱う。
- WSTG
  - 観点：CSPの適用範囲、unsafe-inline/unsafe-evalの有無、例外パス（管理/エラー/SSO）での抜け、Report-Only運用と違反内容を確認する。
- PTES
  - 位置づけ：脆弱性分析（設定/運用）→ 侵害評価（XSS成立条件の評価）→ 報告（現実的なロールアウト計画：観測→収束→強制）。
- MITRE ATT&CK
  - T1190の後段（Executionの成立条件）を狭める“環境コントロール”。また、違反収集基盤はDiscovery/Collectionの信頼境界になり得る。

---

## タイトル
CSP実務設計（Report-Only → 強制）：壊さず観測し、例外を増やさず強くする

---

## 目的（このファイルで到達する状態）
- CSPを「付ける」ではなく、**現実の制約（第三者タグ/SPA/SSR/SSO/管理画面）を踏まえて強化できる運用**に落とす。
- 診断員として以下を説明できる状態にする。
  - 何が原因で強いCSPが壊れるか（inline / eval / 外部オリジン / connect）
  - Report-Onlyと違反収集で、実害ゼロで“現状依存”を棚卸しする方法
  - 例外を“場当たり”にせず、**適用範囲とテンプレ統制**で閉じる方法

---

## 扱う範囲（本ファイルの守備範囲）
- CSPの段階導入（Report-Only運用、違反収集、強制移行の判断）
- 違反レポートの“運用境界”（PII/内部URLの持ち出し、集計、保持）
- ディレクティブの詳細網羅ではなく、実務で詰まる論点（inline/eval/第三者/例外パス）に集中

---

## 前提：CSPは「強くするほど壊れる」ので、観測→収束→強制の順でしか進まない
### 現実で壊れる典型
- 第三者タグ（分析/CS/広告）がscript-srcを汚し、`unsafe-inline` で妥協しがち
- SPA/SSRの混在でHTML生成点が複数あり、**一部ページだけCSPが抜ける**
- 管理画面・プレビュー・埋め込み機能が例外になりやすい（攻撃価値が高いのに弱くなる）

---

## 境界モデル（CSPが閉じる境界）
- 信頼境界：許可する外部オリジン（script/img/connect/frame等）の最小化
- 権限境界：管理/重要操作ページの実行自由度を落とす（XSS後の被害半径を抑える）
- 資産境界：ヘッダ付与主体（App/Proxy/CDN）と適用漏れが起きる場所を固定する

---

## 段階導入（現実で通るロードマップ）
### フェーズ0：棚卸し（“何が動いているか”を先に知る）
- 代表ページを固定
  - 公開トップ、ログイン、一般機能、管理機能、エラー、SSOコールバック
- 外部依存を列挙
  - どの外部オリジンから script/img/connect しているか（現状の事実）

### フェーズ1：Report-Only導入（壊さない観測）
- Report-Onlyを“全面”ではなく、**代表テンプレから**当てる（適用漏れの検出にもなる）
- 違反をカテゴリ分解する（ここが実務の核心）
  - inline（nonce/hash無し）
  - eval系（unsafe-evalが必要）
  - 外部オリジン（許可リスト不足/過剰）
  - connect-src（API/WS/SSE/IdP等）

### フェーズ2：強制（Enforce）を“価値が高い場所から”
- 先に強制すべき：管理/重要操作ページ（被害半径が大きい）
- 公開トップは段階導入でもよい（広告/タグが多い現場があるため）

### フェーズ3：例外を作らない運用へ収束
- 例外が必要なら“ページ単位”ではなく“機能単位/テンプレ単位”で管理
- “一時的な例外”は期限/理由/影響範囲を必須化（恒久例外がCSPを腐らせる）

---

## 違反収集（reporting）の実務設計：レポートはログであり、持ち出し境界
### 収集方式（現実で使われる）
- Report-To / Reporting-Endpoints（新しめ）
- report-uri（レガシー）
※重要なのは方式より **保護と集計**。

### 収集の要件（現実で事故らない）
- アクセス制御：外部公開でも受信自体は可能だが、閲覧・検索は厳格に
- 最小化：URL全文/クエリ/ユーザ識別子を安易に残さない（内部URLやトークンが混ざる）
- サンプリング/集計：全件保存はノイズとコストで破綻しやすい
- 相関：request_id/trace_id と紐づく設計（後で修正に落とすため）

---

## 観測ポイント（診断で“運用として強化できるか”を見る）
- Report-Onlyが当たっているページ範囲（管理/SSO/エラーを含むか）
- 違反の内訳が取れているか（inline/eval/外部/connect）
- レポートがどこに送られているか（第三者SaaSなら信頼境界）
- 例外がパス単位で増えていないか（/adminだけCSP弱い、/previewだけ無い）

---

## 結果の意味（この状態なら何が言えるか）
- Report-Only違反が多い：現状依存が多い（=強化は段階導入が必須）
- 違反が管理画面に集中：最優先で強制対象（攻撃価値が高い）
- 違反収集が無統制：CSP強化以前に、ログ/データ境界が破れている

---

## 攻撃者視点での利用（現実で狙われるポイント）
- CSPが無い/弱い：XSS後の自由度が高い（入力点探索の価値が上がる）
- CSPが強いが例外がある：例外ページ（プレビュー/埋め込み/管理の一部）を狙う
- reportingが雑：レポート基盤が内部情報の収集面になり得る（内部URL、機能名、環境名）

---

## 次に試すこと（仮説A/Bで分岐）
### 仮説A：CSP未導入/形骸化（まず観測を作る）
- 次の一手
  - Report-Onlyを代表テンプレに導入し、違反カテゴリを収集する
  - “どこが壊れるか”を数でなくカテゴリで見える化（収束できる形にする）
  - レポート基盤のアクセス制御・最小化を同時に要件化する

### 仮説B：導入済みだが例外運用で崩壊している
- 次の一手
  - 例外パスを固定（/admin, /callback, /error, /preview）
  - 例外を“テンプレ/ミドルウェア”で統制し、場当たりヘッダ上書きを止める
  - 強制は管理/重要操作から（価値の高い場所に投資）

---

## 修正（実務で通る要求の形）
- CSPは「一律最強」ではなく、ロードマップを要求する（Report-Only→強制）
- 第三者タグは“最小化・隔離”を検討（サブドメイン分離、タグ管理の統制）
- レポートはログ：保護・保持・閲覧統制をセットで要求する

---

## 04_labs（CSP段階導入の再現：壊れる理由をカテゴリ分解する）
- 追加候補Lab（例）
  - `04_labs/02_web/06_config/04_csp_report_only_rollout/`
- Lab設計要件
  - inline/eval/第三者script/connect を意図的に混在させ、Report-Onlyで違反を分類できる構成
  - 目的：違反を“場当たり例外”ではなく“原因カテゴリ”として収束できること

---

## コマンド/例（例示は最小限：観測と判断を優先）
~~~~
# CSPの現実的な進め方（要点）
# 1) Report-Onlyで壊さず観測
# 2) 違反を inline / eval / 外部 / connect に分類
# 3) 管理/重要操作ページから強制へ
# 4) 例外はテンプレ単位で統制（パス単位で増やさない）
# 5) reportingはログ：アクセス制御・最小化・保持を要件化
~~~~

---

## 深掘りリンク（最大8）
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_08_logging_pii_secret（マスキング_相関）.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `05_input_06_xss_01_reflected（反射_成立条件）.md`
- `05_input_06_xss_02_stored（格納_文脈）.md`
- `05_input_06_xss_03_dom（DOM_シンク）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
