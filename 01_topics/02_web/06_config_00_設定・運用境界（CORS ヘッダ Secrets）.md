<<<BEGIN>>>
# 06_config_設定・運用境界（CORS ヘッダ Secrets）.md

（先頭要約：ガイドライン対応の位置づけ）
- ASVS：設定・運用は「実装が正しくても破れる」領域。境界（資産/信頼/権限）が設定でどう崩れるかを説明できる状態にする
- WSTG：Configuration/Deployment の観点を、観測（ヘッダ/挙動/公開情報）→意味→次の一手へ落とす
- PTES：Intelligence Gathering で見えた設定兆候を、Vulnerability Analysis の優先度に直結させる
- ATT&CK：Initial Access/Discovery/Collection を支える“露出面・境界崩壊”として位置づける

## 目的（この技術で到達する状態）
- 設定（CORS/HTTPヘッダ/Secrets/ログ/デバッグ/クラウド設定等）を、単なる項目チェックではなく **境界（信頼・権限・資産）の崩れ方**として理解し、検証の優先度を自分で決められる。
- 「設定ミスかどうか」を断定する前に、**観測で状態を確定し、影響を説明できる**（何が可能になり、何ができないか）。
- Webだけでなく、ASM/OSINT（DNS/TLS/HTTP）で見える設定兆候を、Web/NWの検証計画へ繋げられる。

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb/API/関連サブドメイン/クラウド露出面。
- 想定：
  - CDN/WAF、SaaS連携、SPA+API、クラウド（AWS/Azure）前提
  - 設定は「ヘッダだけ」「コードだけ」ではなく、複数レイヤで成立する（CDN→LB→アプリ→API）
- 依存（前段の接続）：
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ 挙動）と意味.md`
  - `01_topics/02_web/01_web_recon_入口・境界・攻め筋の確定.md`
  - `01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`
- 観測基盤（推奨）：
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
- やらないこと：
  - 設定項目の網羅列挙（チェックリスト化）はしない
  - “落とし穴”章は作らない
  - 報告テンプレの肥大化はしない（必要な説明枠だけ）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) CORS（ブラウザ境界の制御）
- 観測するもの
  - Access-Control-Allow-Origin
  - Access-Control-Allow-Credentials
  - Access-Control-Allow-Headers / Methods
  - Vary: Origin の有無（キャッシュ境界）
- 何を意味するか（状態）
  - どの “Origin” から、どの “認証状態” で、どの “API” を呼べる可能性があるか
- 次の一手（意思決定）
  - 認証がCookieの場合、CORS設定が“信頼境界”を崩す可能性を優先して検証する
  - 反対にトークン（Bearer）が主体なら、CORSは影響が限定される場合がある（ただし例外あり）

### 2) HTTPセキュリティヘッダ（境界の補助・誤設定の兆候）
- 観測するもの（例）
  - Content-Security-Policy（CSP）
  - Strict-Transport-Security（HSTS）
  - X-Frame-Options / frame-ancestors
  - X-Content-Type-Options
  - Referrer-Policy
  - Permissions-Policy
- 何を意味するか（状態）
  - ブラウザ側の攻撃面（読み込み/埋め込み/スクリプト実行）に対する境界が強いか弱いか
  - “弱い=脆弱”ではなく、「どの攻撃面が開きやすいか」を示すシグナル
- 次の一手
  - 入力系（XSS等）や埋め込み（クリックジャック等）と結びつく場合のみ優先度を上げる（一般論で終えない）

### 3) Secrets（漏洩と誤用：資産境界の崩壊）
- 観測対象（例）
  - フロント配布物（JS/Sourcemap/設定JSON）に埋め込まれたキー
  - リポジトリ/Artifact/ログに出るトークン
  - 例外画面/エラー応答に含まれる内部情報
- 何を意味するか（状態）
  - そのキー/トークンで「何が可能か」（呼べるAPI、権限、対象範囲、期限）
  - “公開キー”のように前提上公開でも問題ないものもあるため、断定せず用途を観測で判断する
- 次の一手
  - 使えるかどうかを“最小の確認”で判定する（許可範囲で、影響の小さいread-onlyから）

### 4) デバッグ/管理露出（運用境界の崩壊）
- 観測対象（例）
  - debug=true で挙動が変わる、stack trace が出る
  - /metrics /health /actuator 等の管理系入口
  - 例外時に内部パス/クラス名/SQL等が露出
- 何を意味するか（状態）
  - 内部構造（依存/パス/フレームワーク）の推定が可能になり、他の検証が急に短縮される
- 次の一手
  - “見える情報が何に使えるか” を `01_topics/01_asm-osint` と接続し、攻め筋に変換する

### 5) クラウド設定（露出面と越境点）
- 観測対象（例）
  - ストレージ公開（バケット/コンテナ）
  - CDNオリジン/キャッシュ設定（Vary、認証の扱い）
  - ログ/監査（どこまで追跡できるか）
- 何を意味するか（状態）
  - 資産境界（公開/非公開、管理主体）のズレ
  - 信頼境界（第三者サービス/マネージド機能）への越境点
- 次の一手
  - `01_topics/01_asm-osint/05_cloud_露出面（CDN WAF Storage等）推定.md` と接続し、確認対象を最小化して深掘りする

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（確定できる）
  - “どの境界が設定で支えられ/崩されているか” の当たり（信頼・権限・資産）
  - 観測された設定が、どの攻撃面（CORS/埋め込み/入力/Secrets/運用露出）に効くか
  - 次に深掘りするべき領域（AuthN/AuthZ/API/Input/ASM/Cloud）への優先度
- 推定（追加観測で強くなる）
  - どのレイヤで設定が入っているか（CDN/WAF/アプリ）
  - Secretsが“実害”に繋がるか（権限/期限/対象範囲）
- 言えない（この段階の限界）
  - “安全/危険”の断定（特にSecretsは用途次第）
  - 設定の意図（運用ポリシー）までは外形だけでは分からない
  - 全攻撃面の網羅（代表入口から広げる必要がある）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
### 優先度（境界が崩れる順）
1) Secrets（使えた瞬間に資産/権限境界が崩れる）
2) CORS（ブラウザ越境で認証状態が使える場合、信頼境界が崩れる）
3) 管理露出/デバッグ（攻め筋が急に短縮される）
4) クラウド露出（ストレージ/キャッシュ/オリジン）
5) ヘッダ類（単体では結論にせず、他領域と接続して意味を出す）

### 攻め筋（設定を“単独”で終わらせない）
- CORS → AuthN（Cookie前提）と接続して成立条件を確定する
- Secrets → API（どの権限で何ができるか）に接続して最小確認する
- デバッグ露出 → ASM/OSINT（依存推定）に接続して次の検証を短縮する
- クラウド露出 → 資産境界（公開/管理主体）を固め、ケース化の素材にする

## 次に試すこと（仮説A/Bの分岐と検証）
### 共通の最小セット（観測→意味→次の一手）
- 代表入口を1つ選び、同じ条件で次を取る
  - レスポンスヘッダ一式
  - CORSプリフライト/実リクエスト時の差分（必要時）
  - エラー時の応答（スタック/内部情報の有無）
- 証跡：HAR/Proxyログ/検証メモ（条件/結果/意味/次の手）

### 仮説A：CORSが“認証状態”と結びついて信頼境界を崩す可能性がある
- 検証（A/B）
  - A：未ログインでCORS応答を観測
  - B：ログイン後に同APIでCORS応答を観測（Allow-Credentials、Origin反映など）
- 期待する観測
  - “どのOriginから、どの認証で、どのAPIが呼べる可能性があるか” が説明できる

### 仮説B：Secretsが露出しているが、実害に繋がるか不明
- 検証（A/B）
  - A：キーの用途を推定（どのサービス/どのAPIに向くか）
  - B：許可範囲で最小のread-only確認（呼べるか/拒否か/範囲はどこまでか）
- 期待する観測
  - “使える/使えない” と “使える場合の境界（範囲/期限/権限）” が状態で説明できる

### 仮説C：デバッグ/管理露出があり、攻め筋短縮に直結する
- 検証（A/B）
  - A：通常時の応答を観測
  - B：エラー条件（安全な範囲）で応答を観測し、内部情報が出るか差分を取る
- 期待する観測
  - 内部構造推定に繋がる情報が整理でき、次の topics（API/Input/ASM）へ最短で繋がる

### 例示（最小の観測：コマンドは補助）
~~~~
# 例：ヘッダ観測（CORS/CSP/HSTS 等の状態を見る入口）
curl -i "https://example.com/"

# 例：CORSの観測（概念例：Origin を付けて応答差を見る）
curl -i -H "Origin: https://attacker.example" "https://example.com/api/me"
~~~~
- 主役は「観測した設定が、どの境界を支える/崩すか」の説明であり、項目列挙ではない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 設定・運用（ヘッダ、CORS、Secrets、管理露出、クラウド設定）を“境界”として扱い、満たす/破れる点を観測で説明できる状態にする
- WSTG：
  - Configuration/Deployment 周りの観点を、観測（ヘッダ/挙動/公開情報）→意味→次の一手へ落とす
  - 該当が薄い場合の接続：設定は他テスト（AuthN/AuthZ/API/Input）の成立条件を左右する前提である
- PTES：
  - Intelligence Gathering：設定兆候（ヘッダ/露出面）を観測し、攻め筋を短縮する
  - Vulnerability Analysis：境界崩壊の可能性が高いもの（Secrets/CORS/管理露出）から優先する
- MITRE ATT&CK：
  - 戦術：Discovery（露出面/設定把握）、Initial Access（設定ミス由来の入口）、Collection（情報取得の足場）等
  - 技術名貼り付けではなく「攻撃者の目的に対して、どの境界が設定で崩れるか」を説明できる状態にする

## 参考（必要最小限）
- `01_topics/01_asm-osint/03_http_観測（ヘッダ 挙動）と意味.md`
- `01_topics/01_asm-osint/05_cloud_露出面（CDN WAF Storage等）推定.md`
- `01_topics/02_web/02_authn_認証・セッション・トークン.md`
- `01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`
- `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`

<<<END>>>
