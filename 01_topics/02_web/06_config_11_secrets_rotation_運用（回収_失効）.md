## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 破れる：秘密が長期有効で回収できないと、漏えい後の被害期間が無期限化する。失効反映が遅い（キャッシュ/JWKS等）とインシデント対応が成立しない。
  - 満たす：ローテーション（世代管理）＋回収（revocation）＋失効反映（TTL/キャッシュ）を運用要件として持ち、監査ログと最小権限で被害半径を抑える。
- WSTG
  - 観点：秘密管理、トークン寿命、失効、ログ/クライアント露出、外部連携鍵の扱いを検証する。
- PTES
  - 位置づけ：脆弱性分析（秘密管理/運用欠陥）→ 侵害評価（継続利用可能性）→ 報告（回収線と運用手順の要求）。
- MITRE ATT&CK
  - Credential Access/Collectionの後段で“継続利用”を支える。回収不能はImpactを増幅する前提。

---

## タイトル
Secrets Rotation運用（回収・失効）：漏えいは起きる前提で“有効期間”と“回収線”を設計する

---

## 目的（このファイルで到達する状態）
- ローテーションを「回す」だけで終わらせず、**回収（revocation）と失効反映（反映遅延）まで含めた実効性**を評価できる。
- 実務で多い秘密（JWT署名鍵、APIキー、Webhook署名鍵、DB資格情報）を分類し、優先度を付けられる。

---

## 扱う範囲（本ファイルの守備範囲）
- 秘密の分類（長期鍵/短期トークン/署名鍵/外部連携鍵）
- 世代管理（kid等）、重なり期間、失効反映（キャッシュ/JWKS）
- 漏えい経路（ログ/設定/クライアント）と組み合わせた運用要件化

---

## 前提：回収できない秘密は“漏えいした瞬間に詰む”
### 現実で多いローテーションの難所
- JWT署名鍵（JWKS）をキャッシュしていて、旧鍵がしばらく有効
- 外部連携（Webhook/パートナー）が旧鍵を持ち続け、切替が段階的になる
- “秘密がどこにあるか”の棚卸し不足（CI/CD、環境変数、コード、ログ）

---

## 境界モデル（Secretsが関与する境界）
- 権限境界：秘密＝権限（API操作/署名/認証）を付与する手段
- 信頼境界：外部連携に配布した秘密は回収が難しい
- 運用境界：失効反映が遅いと、対応が間に合わない

---

## 分類（現実で使える優先度）
### 1) 認証・署名（最優先：被害半径が最大）
- JWT署名鍵、セッション署名/暗号鍵、リフレッシュトークン保護鍵

### 2) 外部連携（回収が難しい）
- Webhook署名鍵、パートナーAPIキー、通知/決済/IdP連携鍵

### 3) インフラ（漏えい時に横展開しやすい）
- DB資格情報、ストレージ鍵、クラウドIAM（権限設計と密結合）

---

## 観測ポイント（診断で“実効性”を見る）
- 世代管理があるか（kid等）→ 段階切替が可能か
- 旧鍵の受け入れ期間（重なり）→ 長すぎないか
- 失効反映の遅延要因（JWKSキャッシュ、CDNキャッシュ、アプリ内キャッシュ）
- 秘密の露出経路（ログ/エラー/クライアント/設定）→ 露出があるなら優先度を上げる

---

## 結果の意味（この状態なら何が言えるか）
- 回収線が無い：漏えい後の被害が継続する（インシデント対応が成立しない）
- 反映遅延が長い：回収しても現場で効かない（運用境界の欠陥）
- 露出経路がある：ローテーション不備は重大度を大きく押し上げる

---

## 攻撃者視点での利用（現実での狙い方）
- まず秘密の入手（ログ/設定/外部連携/バックアップ）を狙う
- 回収が弱いと、短期の侵害が長期の継続アクセスに変わる
- 外部連携鍵は回収が難しく、長期的に悪用されやすい

---

## 次に試すこと（仮説A/Bで分岐）
### 仮説A：ローテーションは可能だが運用が未整備
- 次の一手
  - 世代管理（kid）＋重なり期間＋監査ログを要件化
  - 失効反映時間（SLO）を決め、キャッシュTTLを合わせる
  - 緊急回収手順（誰が/どこで/何を/順番）を最小限で整備

### 仮説B：ローテーションが難しい（外部依存・古い設計）
- 次の一手
  - 短寿命化（トークン寿命、権限最小化）で被害期間を短縮
  - 露出経路の削減を優先（ログ/クライアント/設定）
  - 外部連携は切替窓（両鍵受け入れ）を設計し、最終期限を必須化

---

## 修正（現実で通る要件）
- “回す”だけでなく“回収・失効反映”を要件化（SLOと監査）
- 秘密棚卸し（どこにあるか）を運用資産として管理
- 露出経路（ログ/エラー）を同時に潰す（別ファイルと連動）

---

## 04_labs（回収線の再現：旧鍵がいつまで効くかを体感する）
- 追加候補Lab（例）
  - `04_labs/02_web/06_config/11_secrets_rotation_revocation/`
- Lab設計要件
  - kid世代管理＋JWKSキャッシュ＋失効反映遅延を再現
  - 目的：回収・反映遅延を“運用SLO”として言語化できること

---

## コマンド/例（例示は最小限：観測と判断を優先）
~~~~
# ローテーション評価の要点：
# - 世代管理（kid）があるか
# - 旧鍵がいつまで受け入れられるか（重なり）
# - 失効反映の遅延要因（キャッシュ/JWKS）
# - 秘密の露出経路（ログ/エラー/クライアント）
~~~~

---

## 深掘りリンク（最大8）
- `06_config_08_logging_pii_secret（マスキング_相関）.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_12_s3_presigned_url_期限と権限境界.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `06_config_04_csp_実務設計（report-only_違反収集）.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `05_input_19_cache_poisoning_03_poisoned_object（stored_response）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
