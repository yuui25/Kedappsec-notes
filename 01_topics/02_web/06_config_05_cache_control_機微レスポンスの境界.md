## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 破れる：機微レスポンスが共有キャッシュ（CDN/Proxy）に残ると、認証・認可が正しくても“配布層”で境界が破れ、誤配布・混線・情報漏えいが起き得る。
  - 満たす：機微はno-store/privateを原則とし、共有してよい範囲はキー（Vary/正規化）と運用（例外統制/監視）込みで仕様化する。
- WSTG
  - 観点：認証前後/権限差/テナント差で同一URLが返る場合のキャッシュ挙動、3xx/4xx/5xxのキャッシュ、共有キャッシュ兆候（Age等）、Varyの適切性を検証する。
- PTES
  - 位置づけ：脆弱性分析（キャッシュ設計不備）→ 侵害評価（第三者影響の可能性）→ 報告（配布境界・運用要件として提案）。
- MITRE ATT&CK
  - T1190に接続し得るが、焦点は“配布境界の破綻”。Impact（誤配布/混線）やDefense Evasion（再現性低下）を支える前提として扱う。

---

## タイトル
Cache-Control（機微レスポンスの境界）：認証が正しくても“キャッシュ”が第三者影響を作る

---

## 目的（このファイルで到達する状態）
- 機微レスポンスが **どのキャッシュ層（ブラウザ/共有/中継生成）に残り得るか**を境界で説明できる。
- 実務で頻出の事故パターンを、観測→意味→次の一手で所見化できる。
  - 200だけでなく、302/401/403/404/500 の“例外レスポンス”がキャッシュされる
  - CDNがHTMLを最適化（圧縮/正規化）し、Vary不足で混線する
  - “ログアウト後に戻る”など、ブラウザ側の保存（履歴/端末共有）が事故になる

---

## 扱う範囲（本ファイルの守備範囲）
- Cache-Control/Expires/Pragma/Vary等を、機微レスポンスの境界として扱う
- キャッシュ汚染（Poisoning）の攻撃連鎖は別トピックへ接続
  - `05_input_19_cache_poisoning_02_unkeyed（headers_params）.md`
  - `05_input_19_cache_poisoning_03_poisoned_object（stored_response）.md`

---

## 前提：キャッシュは「速くする仕組み」だが、同時に「配布する仕組み」
### 現実で出る“機微レスポンス”
- 個人化HTML（氏名/通知/履歴）
- テナント依存（B2Bでサブドメイン/ヘッダ/tenant_idで分岐）
- 権限依存（adminボタン、内部メニュー）
- エクスポート（CSV/PDF、請求書、本人確認）

### 境界は3層
- ブラウザキャッシュ境界：同一端末・同一プロファイル内の共有（端末共有で事故る）
- 共有キャッシュ境界：CDN/社内Proxy等で**別ユーザに配布**され得る（重大度が跳ね上がる）
- 中継生成境界：CDN/WAF/Proxyがエラーやリダイレクトを生成し、それ自体をキャッシュし得る

---

## 観測ポイント（現実の事故を差分で特定）
### 1) “同じURL”で状態差を作る（最小差分セット）
- 未ログイン（302/401）→ ログイン（200）→ 権限不足（403）で同一URLの挙動差
- テナント差（別サブドメイン/別tenant_id）で同一パスの挙動差
- エラー（500）を最小回数で誘発し、ヘッダと生成主体を記録

### 2) 重点ヘッダ（最小）
- `Cache-Control` / `Expires` / `Pragma`
- `Vary`（特にOrigin/Authorization/Accept-Encoding等）
- 共有キャッシュ兆候（環境依存）
  - `Age` / `Via` / `X-Cache` / `CF-Cache-Status` 等
- Set-Cookieは“動的”の兆候だが、キャッシュ安全の証明にはならない（CDNが無視することがある）

---

## 結果の意味（この状態なら何が言えるか）
- 機微に `public` / `s-maxage`：共有キャッシュ境界で事故り得る（第三者影響の可能性）
- 機微に `no-store` / `private`：少なくともHTTPキャッシュ再利用を抑止する意思がある（次は適用漏れ/例外の確認）
- 3xx/4xx/5xxで制御が抜ける：例外経路が“配布”され、混線や可用性事故に繋がり得る

---

## 攻撃者視点での利用（現実で起きる“狙い目”）
- 認証突破より、配布層の混線の方が早い場合がある（特にB2B/多層CDN）
- 狙われやすい条件
  - 認証前後で同一URL（/dashboard等）
  - テナント差がHost/ヘッダ依存
  - エラー/リダイレクトがキャッシュされる（“一時的に全員がログインできない”等の事故）

---

## 次に試すこと（仮説A/Bで分岐）
### 仮説A：機微は本来no-store/privateで閉じるべき（止血優先）
- 次の一手
  - 機微ページ/管理/エクスポート/API（個人化）を分類し、no-store/privateの適用漏れを特定
  - 3xx/4xx/5xxも含めて一貫適用（例外テンプレで抜けないようにする）
  - CDN側の上書き（cache everything等）設定有無を確認

### 仮説B：性能要件で共有キャッシュが必要（設計勝負）
- 次の一手
  - 共有してよい範囲（匿名・静的・個人化なし）を明文化
  - キー設計（Vary/正規化/Host扱い）を仕様化し、監視（hit/miss、bypass理由）を要件化
  - 攻撃面としてはCache Poisoning観点へ接続し、混線が起きないことを“証跡”で固める

---

## 修正（現実で通る要件）
- “機微”を定義し、no-store/privateを原則化（例外は明文化）
- 例外レスポンス（302/401/403/500）のキャッシュ制御を含めて統制
- CDN/Proxyの設定（ルール/例外/正規化）をアプリと一致させる

---

## 04_labs（機微レスポンスの誤配布を再現：安全に“境界破綻”を理解する）
- 追加候補Lab（例）
  - `04_labs/02_web/06_config/05_cache_control_sensitive_boundary/`
- Lab設計要件
  - 匿名/認証/権限差で同一URLが変わるミニアプリ＋CDN相当キャッシュ
  - 目的：誤配布/混線の成立条件（キー/Vary/例外）を差分観測で固める

---

## コマンド/例（例示は最小限：観測と判断を優先）
~~~~
# 最小差分で見る：
# 1) 未ログイン(302/401) と ログイン(200) と 権限不足(403) を同一URLで比較
# 2) Cache-Control / Vary / Age等を記録
# 3) 例外レスポンス（3xx/4xx/5xx）でも制御が抜けていないか確認
~~~~

---

## 深掘りリンク（最大8）
- `05_input_19_cache_poisoning_02_unkeyed（headers_params）.md`
- `05_input_19_cache_poisoning_03_poisoned_object（stored_response）.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
- `05_input_18_http_request_smuggling_04_observable_signals（timing_error_cache）.md`
