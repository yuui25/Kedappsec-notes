# 02_authn_09_password_policy（強度_漏えい照合_禁止語）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：V2（Authentication）を中心に、V3（Session Management：変更時の再認証/失効）と結合して扱う。パスワードポリシーは「強度の話」だけでなく、**変更/回復/免除（MFA・端末信頼）** の例外パスと一体で評価する。
- WSTG：Authentication Testing（認証ポリシー、パスワード変更/回復、レート制限/ロックアウト）として扱う。観測は「UI表示」ではなく **サーバ側強制の有無** と **境界（どの操作で再認証が必要か）** を確定する。
- PTES：Information Gathering（ポリシー観測）→ Vulnerability Analysis（強度・漏えい照合・例外パス）→ Exploitation（最小差分で成立/不成立を確定）→ Reporting（改善案：例外パス含む）へ接続。
- MITRE ATT&CK：Credential Access（Brute Force / Password Spraying / Credential Stuffing）を「成立しやすい条件の確定」として位置づける。ここでの目的は“手順”ではなく、**防御設計として何が足りないか** を説明できる状態にすること。

## 目的（この技術で到達する状態）
- パスワードポリシーを「画面に書いてあるルール」ではなく、**サーバが強制している境界** として観測で確定できる。
- 強度（長さ/複雑性）・禁止語（辞書/ユーザー情報）・漏えい照合（breached password check）の有無を、推測ではなく **yes/no/unknown** に落とせる。
- 変更・回復・再認証（step-up）・失効（既存セッション/端末信頼の回収）と結びつけ、「このアプリのアカウント乗っ取り耐性のボトルネック」を優先度付けできる。

## 前提（対象・範囲・想定）
- 対象：ログイン/サインアップ/パスワード変更/パスワードリセットで入力されるパスワード。
- 想定：SSO/IdP連携があっても、ローカルアカウントやサポート用回復経路が残るケースがある（その場合ここが例外パスになりやすい）。
- できること（安全に検証する範囲）：
  - 低頻度・最小回数での入力差分（受理/拒否、エラー形式、前後の資産変化）を観測する
  - UI/JSバリデーションとサーバ側強制の差分を確認する（大量試行はしない）
- やらないこと：
  - 大量のパスワード試行、辞書攻撃、スプレー等の負荷を伴う検証
  - 実ユーザーへの影響が出るロックアウト誘発
- 依存（前段）：
  - `02_authn_02_session_lifecycle（更新_失効_固定化_ローテーション）.md`（変更/回復後の失効境界）
  - `02_authn_06_mfa_成立点と例外パス（step-up_device_trust）.md`（再認証境界/免除の扱い）
  - `02_authn_10_password_reset_回復経路（token_失効_多要素）.md`（回復経路が最弱になりやすい）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（やり取りの単位）：
  - サインアップ / パスワード変更 / リセット完了（新PW設定） のリクエストとレスポンス
  - エラーの形式（HTTPステータス、エラーコード、メッセージ、フィールド単位エラー）
  - 変更完了前後の資産（Set-Cookie、セッション状態、MFA/端末信頼の再要求有無）
- 境界の観点：
  - 資産境界：パスワード入力そのもの、ポリシー設定、禁止語リスト、漏えい照合の参照先（第三者サービス/自前）
  - 信頼境界：クライアント（JS）で止めているだけか、サーバが拒否するか／SSOの場合IdP/RPどちらが強制するか
  - 権限境界：パスワード変更が「重要操作」として再認証（旧PW / MFA / step-up）を要求するか
- 重要なフィールド/差分/状態（ここが変わると意味が変わる）：
  - 最小/最大長（最大長の扱い：拒否/受理/切り詰め等の“挙動”）
  - 文字種要件（複雑性）と、その強制がサーバ側か
  - 禁止語（ユーザー名/メール/会社名などの含有禁止）を示すエラーの有無
  - 漏えい照合（典型的弱PWを拒否するか、拒否理由が区別されるか）
  - パスワード変更時に「旧パスワード」や「step-up」が必須か
  - 変更/回復後の失効：既存セッション/refresh/端末信頼が回収されるか（yes/no/unknown）
  - 入口の列挙耐性：変更/回復の応答が“存在有無”を漏らす設計になっていないか（差分があるか）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか：
  - サーバ側でパスワード強度が強制されているか（クライアント回避で同じ拒否になるか）
  - 最小/最大長・禁止語・漏えい照合の有無（挙動としての yes/no/unknown）
  - 変更/回復が「重要操作」として扱われているか（旧PW/step-up要求、失効回収）
- 何が“推定”できるか（根拠/前提）：
  - 例外パスの存在（SSO/MFAが強くても回復・変更の一部が弱い等）
  - 漏えい照合の方式（第三者照合っぽい遅延/エラー形など）※断定はしない
- 何は“言えない”か（不足情報・観測限界）：
  - パスワードの保存方式（ハッシュ/ソルト等）の内部実装
  - 禁止語リストや漏えい照合データの網羅性（観測は“存在/非存在”の確認が中心）
- よくある状態パターン（境界のズレとして整理）：
  - パターンA：UIでは厳しいが、サーバ側強制が弱い（境界がクライアントに寄っている）
  - パターンB：強度は強いが、変更/回復が弱い（例外パスが成立）
  - パターンC：強度はそこそこでも、漏えい照合/禁止語/再認証/失効が揃っていて全体として強い

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”：
  - サーバ側強制が弱い（=クライアント回避で通る）なら、ポリシーは実質無効
  - 回復/変更に再認証や失効回収が無いなら、セッション奪取・CSRF・運用回復と結合して被害が伸びやすい
  - 漏えい照合が無い/弱いなら、再利用系（既知弱PW・使い回し）に対する耐性が下がる
- 優先度の付け方（時間制約がある場合の順序）：
  1) サーバ側強制の有無（ここが崩れていると他を議論しても意味が薄い）
  2) 変更/回復の再認証・失効回収（例外パスの有無）
  3) 漏えい照合/禁止語（再利用耐性）
  4) メッセージ/エラー差分（列挙・情報漏えい起点）
- 「見える/見えない」による戦略変更：
  - SSO主体：IdP側ポリシーだけで満足せず、RP側の回復経路（ローカルアカウント/サポート）に観測を寄せる
  - SPA主体：JSバリデーションの回避可能性（API直叩き）を優先して確定する

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：パスワードポリシーは“サーバ側で強制”され、漏えい照合/禁止語も機能している
- 次の検証（最小差分）
  - UIを介さず（プロキシで改変して）短すぎる/単純すぎる入力を送っても、同様に拒否されるか（yes/no）
  - 典型的弱PW（例：短い・単語・連番など）を“低頻度”で試し、拒否理由が一貫しているか（unknown→yes/no）
- 期待する観測
  - クライアント回避でも拒否が再現し、エラーがフィールド単位で安定する（境界がサーバ）

### 仮説B：ポリシーは“クライアント側中心”で、サーバ側強制が弱い
- 次の検証
  - JSで弾かれる入力を、APIリクエスト改変で送ったときに受理されるか（yes/no）
  - 受理された場合、変更/回復の成立点（どのレスポンス以降で更新扱いか）を固定し、証跡を残す
- 期待する観測
  - “UIでは不可だがサーバは受理”という差分が出る（境界ズレが確定）

### 仮説C：強度は十分でも、変更/回復が“重要操作として扱われていない”（再認証・失効回収が弱い）
- 次の検証（影響を制御）
  - パスワード変更が「旧PW要求」「step-up要求」「直前再認証」いずれかを伴うかを観測（yes/no/unknown）
  - 変更/回復完了後、既存セッション/長期資産/端末信頼が回収されるかを最小の差分で観測（yes/no/unknown）
- 期待する観測
  - “変更は通るが、奪取済みセッションが生き残る”など、例外パスの成立可否が説明できる

### コマンド/リクエスト例（例示は最小限・意味が主）
~~~~
# 目的：パスワード変更の「サーバ側強制」の有無を観測する（UI/JSを信用しない）
# - 実際は対象アプリのAPIに合わせる。値は必ずマスクし、試行回数は最小にする。
curl -i "https://rp.example.com/api/account/password" \
  -H "Content-Type: application/json" \
  -H "Cookie: session=REDACTED" \
  -d '{"currentPassword":"REDACTED","newPassword":"REDACTED"}'

# この例で観測していること：
# - HTTPステータスとエラー形式（サーバが拒否しているか）
# - 変更完了前後で Set-Cookie が変わるか（セッション再発行/失効回収の兆候）
~~~~

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`（改変で“サーバ強制”を確定）
  - `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`（HAR/Proxyログの最小セット）
  - `04_labs/03_targets/01_web_targets_検証用アプリ選定.md`（検証対象の用意）
- 取得する証跡（目的ベースで最小限）：
  - HAR（パスワード変更/回復の一連、値はマスク）
  - Proxyログ（該当APIのリクエスト/レスポンス、Set-Cookie/Location/エラー形式）
  - 差分メモ（yes/no/unknown）：サーバ強制、漏えい照合、禁止語、再認証、失効回収
- 観測の取り方（差分の軸）
  - UIで弾かれる入力 vs API改変で送った入力（同じ拒否か/通るか）
  - 変更前 vs 変更後（セッション資産が回収されるか）
  - SSOあり/なし（ローカル回復経路が残っているか）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：V2 Authentication、（結合）V3 Session Management
  - このファイルの内容が「満たす/破れる」ポイント：
    - サーバ側で強度・禁止語・漏えい照合が強制されているか（境界の所在）
    - 変更/回復が重要操作として再認証・失効回収を伴うか（例外パスの有無）
- WSTG：
  - 該当カテゴリ/テスト観点：Authentication（パスワードポリシー、変更/回復、レート制限/ロックアウト）
  - 該当が薄い場合：この技術が支える前提（認証の入口強度、例外パスの潰し込み）
- PTES：
  - 該当フェーズ：Information Gathering / Vulnerability Analysis / Exploitation（最小差分）/ Reporting
  - 前後フェーズとの繋がり（1行）：入口強度の確定 → 回復/失効/免除の例外パス評価へ繋げる
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Credential Access（Brute Force / Password Spraying / Credential Stuffing）
  - 攻撃者の目的（この技術が支える意図）：再利用・推測が成立しやすい条件を減らせているかの評価

## 参考（必要最小限）
- OWASP ASVS（Authentication / Session）
- OWASP Authentication Cheat Sheet
- NIST SP 800-63B（Digital Identity Guidelines：Authenticator & Secrets）
- OWASP Password Storage Cheat Sheet（内部実装の一次情報として）

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/02_web/02_authn_06_mfa_成立点と例外パス（step-up_device_trust）.md`
- 関連 playbooks：`02_playbooks/03_authn_観測ポイント（SSO_MFA前提）.md`
- 関連 labs：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
