## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - この技術で満たす/破れる点：認可（非同期実行時の権限再評価）、セッション/トークン（失効・step-upの境界）、入力検証（ジョブpayload/メタデータの信頼境界）、機密情報保護（ジョブpayload/ログ/結果物）、監査（誰が・何を・いつ起動し、何が実行されたか）、可用性（リトライ増殖・ワーカー枯渇）
  - 支える前提：非同期は「実行の時間と場所がズレる」ため、同期APIで成立していた境界（ユーザ権限/テナント/状態/step-up）が、ワーカー側で再評価されないと崩れる。idempotency（06）とセットで“少なくとも一回実行”を前提にする。
- WSTG：
  - 該当テスト観点：Authorization Testing（非同期処理の権限再評価、BOLA/BFLAの非同期版）、Business Logic（状態遷移・二重実行・順序）、API Testing（ジョブ作成/取得/キャンセル、ジョブ結果参照、エラー・ログ）、Session/Token（失効・権限変更後の挙動）
  - どの観測に対応するか：ジョブ作成→キュー投入→ワーカー実行→結果参照、の各段で「権限がどこで決まるか（伝播/再評価）」「誰の主体で走るか」「失効/権限変更/step-upに追従するか」を差分観測で確定する
- PTES：
  - 該当フェーズ：Information Gathering（ジョブ系API/UI/ログ/メトリクスの発見、ワーカー境界の把握）、Vulnerability Analysis（権限伝播欠落、payload改ざん、結果物の越境、リトライ増殖）、Exploitation（低侵襲で成立条件確定：2ユーザ/2テナント差分、結果参照で越境を証跡化）
  - 前後フェーズとの繋がり（1行）：Webhook（04/05）とIdempotency（06）は非同期の事故増幅要因であり、AuthZ（03）と状態遷移（03_authz_10）をワーカー側に持ち込むのが07の主題。以降のexport（08）、error model（09）でも同じ“非同期例外パス”が崩れないように接続する
- MITRE ATT&CK：
  - 戦術：Privilege Escalation / Defense Evasion / Impact / Collection
  - 目的：ジョブpayloadや実行主体のズレを利用し、管理者相当の処理を実行（Privilege Escalation）、再実行/遅延で監査を回避（Defense Evasion）、二重実行・無限リトライで可用性へ影響（Impact）、エクスポート/集約ジョブで大量取得（Collection）。

## タイトル
async_job_権限伝播（キュー_ワーカー）

## 目的（この技術で到達する状態）
- 非同期処理（キュー/ワーカー/スケジューラ）を「権限境界の再設計ポイント」として扱い、(1)実行主体（誰の権限で走るか）、(2)権限の伝播（何を渡すか/渡さないか）、(3)実行時再評価（AuthZ/状態/step-up/失効）、(4)ジョブpayloadの信頼境界、(5)結果物/ログの越境、(6)再実行と二重実行（06）、(7)観測と監査、をモデル化して実務ペネトレで確定できる
- “ジョブはバックエンドだから安全”という誤解を排し、同期APIで守っていた境界がワーカーで崩れる典型（BFLA/越境/二重実行/漏えい）を、差分観測で短時間に証跡化できる
- エンジニアが「どの層で何を強制すべきか（アプリ/DB/キュー/運用）」を具体的に実装/運用へ落とせる

## 前提（対象・範囲・想定）
- 対象：非同期実行される機能（現実に多い）
  - エクスポート（CSV/PDF）、集計/レポート生成、請求締め、承認フロー、通知送信、Webhook送信、バッチ同期、画像変換、スキャン、再計算、データ移行
- 非同期の構成（現実的な共通点）
  - ジョブ作成API（enqueue）→ キュー投入 → ワーカーが実行（dequeue）→ 結果保存 → 結果参照API/UI
  - “少なくとも一回実行”が基本（失敗時リトライ、ワーカー再起動、可視性タイムアウト）
  - 実行が遅延し得る（数秒〜数時間）＝権限/状態/データが変わる
- ペネトレ上の安全配慮
  - 本番では高負荷/大量ジョブ投入は避ける（可用性・費用）
  - 可能ならテストテナントで「越境」「権限昇格」「二重実行」を証跡化
  - 本番でやる場合は、ジョブ作成の“拒否挙動”と結果参照の“越境有無”中心（低侵襲）にする

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 非同期で最初に決めるべき問い：このジョブは「誰の主体」で実行されるか
- 実行主体モデル（実務で混在）
  - ユーザ主体：ユーザの権限で実行（最も直感的。ただし失効/権限変更に追従が必要）
  - テナント主体：テナント内のシステム権限で実行（強すぎるとBFLA化）
  - サービス主体：サービスアカウント権限で実行（最も危険：誤実装で全権に寄る）
- 観測で確定したい点
  - enqueue時に user_id/role/scope が渡されているか（伝播）
  - execute時に “現在の権限” を見直しているか（再評価）
  - 実行ログ/監査に「起動者」と「実行主体」が両方残るか（ズレが事故源）

### 2) 権限伝播（Propagation）：ジョブpayloadに“何を入れるか/入れないか”
非同期は「必要最小限の情報だけ渡し、境界条件はサーバ側で再構築」が原則。
- 入れてよい（推奨）
  - ジョブ対象の参照キー（object_id）
  - 起動者識別（actor_id）※ただし信頼しない、監査の相関用
  - 依頼時点のリクエストID/trace_id
- 入れると危険になりやすい
  - tenant_id をそのまま信頼（03_multi-tenant崩壊）
  - role/is_admin 等の権限属性（BFLAの直結）
  - “結果参照URL”や“送信先URL”（05 SSRFと結合）
  - 認証トークンそのもの（漏えい・再利用・期限のズレ）
- 観測で確定したい点
  - payloadの中に境界条件（tenant/role/state）が入っていないか
  - 入っている場合、それをワーカーが“再計算”して上書きしているか

### 3) 実行時再評価（Re-Authorization）：ワーカーでAuthZ/状態/step-upを必ず再評価する
同期APIで行っていたチェックは、ワーカーでも必要（むしろ重要）。
- 再評価すべき代表（実務）
  - テナント分離（tenant_idの強制、03）
  - オブジェクト認可（所有/共有/スコープ、02/03）
  - RBAC/ABAC（04）
  - 状態遷移（draft→approved等、10）
  - step-up（重要操作の再認証境界、02_authn_16）
  - セッション失効/権限変更（ログアウト/ロール変更後に過去ジョブが走らない）
- 観測で確定したい点
  - enqueue後に権限を落とした/剥奪した場合、そのジョブが実行されるか（危険）
  - enqueue後に対象オブジェクトの状態が変わった場合、古い前提で実行しないか（巻き戻し/二重適用）

### 4) ジョブpayloadの信頼境界：改ざん可能性と“再利用（replay）”を分けて考える
- 改ざんが起きる経路（現実的）
  - ジョブ作成APIで任意フィールドを渡せる（サーバがそのままpayloadにする）
  - ジョブ編集/再実行APIがある（運用UIで広権限）
  - ジョブ詳細がクライアントへ返り、再送可能（ジョブの再利用）
- replay（再実行）の現実
  - ワーカー障害で再実行される（正常）
  - 管理者が手動で“再実行”する（正常）
  - 攻撃者が“再実行”を誘発できる（危険：権限境界が必要）
- 観測で確定したい点
  - ジョブ作成/再実行/キャンセル/優先度変更の権限境界
  - ジョブpayloadがクライアントから観測・再利用できるか

### 5) キュー/ワーカーの配送保証（at-least-once）と06（idempotency）の接続
- “正しい前提”
  - 少なくとも一回：重複実行は必ず起き得る
  - 順序は保証されないことが多い
- したがって必要
  - 重要操作ジョブは idempotency（06）で一回性を担保
  - ジョブごとの一意キー（job_id/event_id）で重複を検知
  - 失敗時の扱い（リトライ/停止/DLQ）を安全に
- 観測で確定したい点
  - 同一ジョブが二回走った時、二重実行にならないか（06の観点をジョブに適用）
  - 失敗時に無限リトライで増殖しないか（可用性/費用）

### 6) ワーカー実行環境の“権限”が強すぎないか（サービス主体の危険）
- 現実に起きる事故
  - ワーカーがDB全権限で動き、アプリ層AuthZをバイパスする実装になる
  - 内部API呼び出し時に“管理者用トークン”を付与してしまう
- 観測で確定したい点（ペネトレで見える兆候）
  - ユーザが本来できない操作が、ジョブ経由だと通る（最重要の差分）
  - ジョブ結果のログに“管理者相当の情報”が出る

### 7) 結果物（artifact）の境界：ジョブの出口は“ファイル/URL/ログ”になりやすい
- 代表的な出口
  - ダウンロードURL（署名URL/直リンク）、オブジェクトストレージ、メール添付、管理画面の表示
- 危険
  - 結果物の参照がIDOR化（08_file_export/03_authz_02と接続）
  - 生成物に他テナントのデータが混入（集計/検索の混線）
  - 結果物URLが推測可能/長寿命（期限・バインド不足）
- 観測で確定したい点
  - ジョブ結果の参照権限（起動者/テナント/ロール）が強制されているか
  - 生成物が“起動時の条件”に束縛され、後から越境参照できないか

### 8) 観測と監査：非同期は“相関キー”が無いと守れない
- 最小の相関キー（推奨）
  - request_id / trace_id（enqueueのHTTPとワーカー実行を繋ぐ）
  - job_id（キュー内の一意）
  - actor_id（起動者）
  - tenant_id（強制された境界）
  - idempotency_key / event_id（重複排除）
- 観測で確定したい点
  - enqueue→execute→artifact まで一気通貫で追えるか
  - 拒否（権限不足/失効/不正payload）もログに残るか

### 9) エラーと再試行：例外パスが“権限チェックを抜ける”ことがある
- 典型の悪い設計
  - “とりあえず再試行”で、権限チェック失敗も再試行する（無意味な増殖）
  - 例外時に安全な停止ではなく、別経路（運用バッチ）で処理してしまう
- 観測で確定したい点
  - 権限エラーは即停止（DLQ/手動介入）か
  - 例外メッセージが情報漏えい（09_error_modelと接続）

### 10) async_job_authz_propagation_key（正規化キー：後続へ渡す）
- 推奨キー：async_job_authz_propagation_key
  - async_job_authz_propagation_key =
    <execution_identity>(user|tenant_system|service|mixed|unknown)
    + <propagation_payload>(minimal_ref_only|includes_tenant|includes_role|includes_token|unknown)
    + <reauthorization>(strict_each_execute|partial|none|unknown)
    + <stepup_handling>(enforced|bypassed|unknown)
    + <revocation_handling>(honors_revocation|ignores|unknown)
    + <idempotency_for_jobs>(strong|partial|none|unknown)
    + <retry_policy>(safe_stop|bounded_retry|unsafe_infinite|unknown)
    + <artifact_access_control>(strong|weak|none|unknown)
    + <observability>(traceable_end_to_end|partial|weak|unknown)
    + <audit_strength>(strong|partial|weak|unknown)
    + <confidence>
- 記録の最小フィールド（推奨）
  - ジョブ作成API/UI（誰が起動できるか）
  - 実行主体の推定根拠（差分：同期では拒否、ジョブでは成立など）
  - payloadに含まれる境界条件の有無（観測可能な範囲）
  - 権限変更/失効後の挙動（再評価の有無）
  - 二重実行時の挙動（06の適用）
  - 結果物参照の境界（IDOR/越境の有無）
  - evidence（HAR、ジョブ一覧UI、ログ断片、生成物URL）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（確定できる）：
  - 非同期ジョブが「誰の権限で」実行され、実行時にAuthZ/状態/step-up/失効を再評価しているか
  - ジョブpayloadに境界条件（tenant/role/token）が含まれ、それが信頼されているか否か
  - 二重実行（at-least-once）に対して安全に収束できるか（06の延長）
  - 結果物（artifact）が越境参照/推測可能/長寿命になっていないか
  - 監査・相関が成立し、事故や悪用を追跡できるか
- 推定（根拠付きで言える）：
  - 同期では拒否される操作がジョブ経由で成立する場合、ワーカーでの再評価欠落（BFLA/権限伝播ミス）が疑われる
  - 失効/権限変更後にも古いジョブが通る場合、伝播情報を信頼し過ぎている可能性が高い
- 言えない（この段階では断定しない）：
  - キュー製品や内部実装の詳細。だが、挙動（差分）と証跡で“境界の欠落”は十分に示せる。

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- 優先度（P0/P1/P2）
  - P0：
    - ジョブ経由で権限昇格（ユーザができない管理操作が実行される）
    - テナント混線（他テナントの結果物が生成/参照できる）
    - 失効/権限変更後でも実行される（revocation無視）＋重要操作に直結
    - ジョブ結果の参照がIDOR（artifact_access_controlが弱い）
  - P1：
    - payloadにtenant/roleが含まれるが、実行時再評価が不明/部分的
    - リトライが過剰で、停止までに事故が増殖（可用性/費用）
    - エラーが情報漏えい（09）またはオラクル化
  - P2：
    - 設計は堅牢だが監査/相関が弱く、調査・再発防止が困難
- “成立条件”としての整理（技術者が直すべき対象）
  - ワーカーは実行時に必ずAuthZ/状態/step-up/失効を再評価（enqueue時の判断を信頼しない）
  - payloadは最小（参照キーのみ）とし、tenant/role/token等の境界条件を入れない（入れても信頼しない）
  - ジョブはat-least-once前提：idempotency（06）と重複排除を設計に組み込む
  - 結果物参照は強制境界（起動者・テナント束縛・期限・署名）を必須化
  - 失敗は安全に停止（DLQ/手動介入）し、無限リトライを避ける
  - 相関キー（trace/job/actor/tenant）を監査に必須化する

## 確認（最大限詳しく：どうやって“確定”したと言えるか）
非同期は内部が見えにくいので、挙動差分＋証跡で確定する。目的は「実行主体」「再評価の有無」「越境の有無」「二重実行耐性」を、少数リクエストで証拠化すること。

### 1) 確認の基本原則（安全・低侵襲・再現性）
- 原則1：2ユーザ×2テナント（可能なら）で差分を取る
  - A（権限強）/ B（権限弱）、T1/T2 を用意し “混線/昇格” を短距離で確定する
- 原則2：同一操作を「同期経路」と「ジョブ経路」で比較する
  - 同期で拒否（403等）だが、ジョブで成功するなら再評価欠落の強い兆候
- 原則3：副作用の大きい操作はテスト環境で、結果参照で証跡化する
  - 例：承認/送金ではなく、exportやdry-run的ジョブで境界を示す
- 原則4：相関キーを固定し、追える形で実施する
  - request_id / job_id / trace_id を必ず控える（レスポンスヘッダ、ジョブ一覧UI、ログ）
- 原則5：確認は“入口→実行→出口”の3点で成立させる
  - 入口：enqueueの権限とpayload
  - 実行：実行主体/再評価の結果（成功/拒否）
  - 出口：結果物（artifact）参照の境界

### 2) 確認ステップ（観測の粒度：A→B→Cで確定度を上げる）
#### ステップA：ジョブ面の発見と面の確定（入口の特定）
- 目的：どこでジョブが作られ、どこで結果が見えるかを特定する
- 観測するもの
  - ジョブ作成API（enqueue）：POST /jobs, POST /exports, POST /reports など
  - ジョブ一覧/詳細：GET /jobs, GET /jobs/{id}
  - 結果参照：GET /jobs/{id}/result, download_url 等
- 確認できたと言う条件（最低限）
  - 1つのジョブを作成し、job_id（または類似ID）と状態（queued/running/completed）を観測できる

#### ステップB：実行主体（誰の権限で走るか）の確定（差分観測）
- 目的：execution_identity を推定し、危険な“サービス主体の全権”を炙り出す
- 差分観測（低侵襲）
  - 同期経路で拒否される操作（例：他人のオブジェクトに対するexport）を、ジョブ経由で起動できるか
  - 起動できる場合、生成物に含まれる範囲が同期の権限と一致するか
- 確認できたと言う条件（証拠）
  - 同期拒否（403） vs ジョブ成功（completed）＋結果物に“本来見えないデータ”が含まれる
  - または、ジョブが “起動者の権限に沿って” 限定された結果しか出さない（堅牢の証拠）

#### ステップC：再評価（Re-Authorization / Revocation / Step-up）の確定（時間差で見る）
- 目的：非同期の本質である“時間差”で境界が崩れないかを確定する
- 差分観測（現実的・再現性が高い）
  - enqueue後にロールを剥奪（admin→viewer）して、ジョブが実行されるか
  - enqueue後に対象オブジェクトの権限を剥奪/移動して、ジョブが古い前提で実行しないか
  - enqueue後にstep-upが必要な操作（重要操作）を実行できてしまわないか
- 確認できたと言う条件（証拠）
  - 剥奪後でもジョブが完遂し、重要操作が通る（再評価欠落：P0/P1）
  - 剥奪後はジョブが拒否/失敗になり、監査に理由が残る（堅牢）

#### ステップD：二重実行（at-least-once）耐性の確定（06のジョブ版）
- 目的：同一ジョブが再実行されても事故らないかを確定する
- 差分観測
  - 同一enqueueを2回（同一条件）実行し、結果が二重生成/二重適用にならないか
  - 再実行（retry）や再キュー（requeue）がUI/APIで可能なら、同様に観測
- 確認できたと言う条件（証拠）
  - 二回目が同結果に収束（同一artifact、または衝突として扱われ参照可能）
  - 二重生成・二重課金・状態二重遷移が起きる（P0）

#### ステップE：結果物（artifact）参照境界の確定（出口＝最頻出の越境）
- 目的：job_id / artifact_id がIDOR化していないか、テナント束縛があるかを確定する
- 差分観測
  - Aが作ったjob_id/artifact_idをBが参照できるか
  - 同一テナント内の別ユーザ、別テナントで差分を取る
- 確認できたと言う条件（証拠）
  - 参照が成功＝IDOR/越境（P0）
  - 参照が403/404で一貫、かつ監査に残る（堅牢）

#### ステップF：監査と相関の確定（防御の成立条件）
- 目的：事故/悪用が起きても追えるかを確定する（実務では重大）
- 観測するもの
  - ジョブの監査に actor_id / tenant_id / job_id / request_id が残るか
  - 拒否（権限不足/失効）もログに残るか
- 確認できたと言う条件（証拠）
  - enqueue→execute→artifact を trace_id で辿れる
  - 失敗理由が曖昧で、再送増殖を招く（運用リスク）

### 3) “確認できた”と言うための最低限の証跡セット（ペネトレ報告に耐える）
- HTTP証跡（またはUI操作のHAR）
  - enqueue（ジョブ作成）リクエスト＆レスポンス（job_idが分かる）
  - ジョブ状態参照（queued→completed等）
  - 結果参照（artifact URL/レスポンス）
- 差分証跡（最重要）
  - 同期拒否 vs ジョブ成功、または別ユーザ/別テナント参照の成否
- 状態証跡（必要に応じて）
  - 実行前後の対象オブジェクト状態（状態遷移/カウンタ）
- 監査証跡（取れるなら強い）
  - job_id/actor/tenant/decision が記録されたログ/監査画面

## 次に試すこと（仮説A/Bの分岐と検証：低侵襲で成立条件を確定）
- 仮説A：ワーカーでの再評価が無い（enqueue時の判断を信頼している）
  - 検証：
    - enqueue後に権限剥奪/状態変更 → ジョブが成功するか
  - 判断：
    - 成功：P0/P1（重要度は操作内容次第）
- 仮説B：実行主体がサービス主体で強すぎる（BFLA化）
  - 検証：
    - 同期で拒否される対象をジョブで処理できるか（差分）
  - 判断：
    - できる：P0
- 仮説C：artifact参照がIDOR（出口で越境）
  - 検証：
    - job_id/artifact_id を別ユーザ/別テナントで参照
  - 判断：
    - 参照成功：P0
- 仮説D：二重実行で事故る（06がジョブに適用されていない）
  - 検証：
    - enqueueの重複・再実行で結果が二重にならないか
  - 判断：
    - 二重：P0
- 仮説E：リトライ増殖で可用性/費用リスク
  - 検証：
    - 失敗時の再試行がboundedか（attempt_countや状態から推定）
  - 判断：
    - 無限/過剰：P1

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - `04_labs/02_web/04_api/07_async_job_authz_propagation_queue_worker/`
    - 構成案（現実運用の再現）
      - テナント2つ、ロール3種（viewer/editor/admin）
      - ジョブ種別：
        - export（artifact生成・参照）
        - privileged_action（承認/権限付与の擬似）
        - webhook_send（05と接続）
      - 防御切替：
        - 実行主体（user/tenant_system/service）切替
        - 実行時再評価 ON/OFF（AuthZ/状態/step-up/失効）
        - payload最小化 ON/OFF（tenant/roleを入れる/入れない）
        - ジョブidempotency ON/OFF（06）
        - retry bounded/unsafe（DLQあり/なし）
        - artifactアクセス制御 ON/OFF（署名URL束縛・期限）
      - 観測点：
        - enqueueログ（request_id/actor/tenant/job_id）
        - workerログ（effective_identity/reauthz_result/idempotency_decision）
        - artifactログ（who_downloaded/tenant_bind/expiry）
- 取得する証跡（深掘り向け：HTTP＋ログ）
  - HTTP：enqueue→status→result のHAR
  - 差分：同期拒否 vs ジョブ成功、別ユーザ/別テナント参照
  - ログ：job_id・actor・tenant・effective_identity・reauthz結果・attempt_count
  - 生成物：artifactのメタ（所有者/tenant/期限）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# ジョブ作成（擬似）
POST /api/exports
Body:
  { "object_type": "invoices", "filter": { "status": "paid" } }

# ジョブ状態
GET /api/jobs/{job_id}

# 結果参照
GET /api/jobs/{job_id}/result
# または download_url を取得してダウンロード

# 観測すること（擬似）
- 同期APIでは拒否される範囲が、ジョブ結果に混入しないか（再評価の有無）
- enqueue後の権限剥奪/状態変更で、ジョブが実行され続けないか
- job_id/artifact_id を別ユーザ/別テナントで参照できないか（出口の境界）
- 再実行/重複enqueueで二重生成にならないか（06）
~~~~
- この例で観測していること：
  - 非同期の“時間差”で権限境界が崩れないか（伝播ではなく実行時再評価があるか）
- 出力のどこを見るか（注目点）：
  - execution_identity、reauthorization、revocation_handling、stepup_handling、artifact_access_control、idempotency_for_jobs、retry_policy、observability
- この例が使えないケース（前提が崩れるケース）：
  - ジョブが完全に内部のみでユーザ起動ができない場合：ペネトレ観点は “結果物の参照” と “運用UIの権限境界（03_authz_09）” に寄せ、再評価と監査の妥当性を確認する

## 参考（必要最小限）
- OWASP ASVS（認可、失効、監査、可用性）
- OWASP WSTG（AuthZ/Business Logic/API：非同期の例外パス）
- PTES（差分観測で成立条件を確定）
- MITRE ATT&CK（Privilege Escalation/Impact：非同期処理の悪用）

## リポジトリ内リンク（最大3つまで）
- `01_topics/02_web/04_api_06_idempotency_レースと二重実行境界.md`
- `01_topics/02_web/04_api_08_file_export_エクスポート境界（CSV_PDF）.md`
- `01_topics/02_web/03_authz_06_privileged_action_重要操作（承認_送金_権限）.md`

## 次（04_api_08 以降）に進む前に確認したいこと（必要なら回答）
- 04_api_08（file_export）では、非同期ジョブの“出口”として最頻出の生成物（CSV/PDF/URL）を、署名URLの束縛・期限・再生成・キャッシュ混線・PIIマスキング・閲覧権限（IDOR）まで、現実運用に寄せて最大限深掘りする
