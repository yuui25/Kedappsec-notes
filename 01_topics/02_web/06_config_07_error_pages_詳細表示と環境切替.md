## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 破れる：詳細エラー（スタック/設定/内部URL）が公開境界に出ると情報漏えいになる。さらに例外時にヘッダ/キャッシュ/認可が抜けると“防御例外”が入口になる。
  - 満たす：本番は安全なエラー（汎用メッセージ）を返し、詳細は保護されたログ基盤へ。例外時もヘッダ/キャッシュ制御を一貫させ、相関IDで追跡可能にする。
- WSTG
  - 観点：エラー処理の情報漏えい、例外時のセキュリティヘッダ/キャッシュ制御、生成主体（App/Edge）の切り分けを検証する。
- PTES
  - 位置づけ：脆弱性分析（設定/例外処理）→ 侵害評価（漏えい情報を材料に攻撃面を絞る）→ 報告（環境切替と例外統制）。
- MITRE ATT&CK
  - Discoveryを強く支える（内部技術/構成の把握）。条件が揃うとT1190の探索効率を上げる。

---

## タイトル
エラーページ（詳細表示と環境切替）：例外は“情報境界”と“防御例外”が同時に抜ける場所

---

## 目的（このファイルで到達する状態）
- 4xx/5xxを「情報漏えい」だけで終わらせず、**例外経路がセキュリティ制御の例外になっていないか**まで診断できる。
- 実務で使える形で、以下を所見化できる。
  - どの条件（環境/パラメータ/Accept/Host/UA）で詳細が出るか
  - エラー時にヘッダ（CSP/Frame等）やCache-Controlが抜けていないか
  - 追跡のための相関キー（request_id/trace_id）を確実に取る

---

## 扱う範囲（本ファイルの守備範囲）
- 詳細エラーの露出（スタック/内部パス/環境名/依存）
- 例外時の“防御抜け”（ヘッダ・キャッシュ・認可の分断）
- 生成主体の切り分け（App/Proxy/WAF/CDN）

---

## 前提：エラーは必ず起きる。問題は“起きたときに何が漏れ、何が抜けるか”
### 現実で多い詳細表示の形
- フレームワークのデバッグ表示が本番に混入（設定/環境変数の誤り）
- 特定パス（/admin）だけ別テンプレで詳細が出る
- 特定ヘッダ（Accept: text/html）で詳細ページが返る（APIはJSONで隠れている等）

### 生成主体が変わる（実務の分岐点）
- App生成：例外名/スタック/テンプレ名が見える
- Proxy/WAF/CDN生成：独自のエラーページ、キャッシュやブロックの痕跡が混ざる

---

## 境界モデル（エラーが破る/崩す境界）
- 情報境界：内部構成、依存、ルーティング、設定キーが漏れる
- 防御境界：例外時にヘッダ/キャッシュ制御が抜けると、Clickjackingや誤配布の条件が生まれる
- 監査境界：相関キーが無い/ログが追えないと、検知と再現が破綻する

---

## 観測ポイント（現実に効く順）
### 1) ステータス別に“同じページ”を作る
- 正常（200）と異常（500）で、ヘッダとボディ差分を取る
- 未ログイン/権限不足（401/403）でも同様に取る（例外テンプレで抜けやすい）

### 2) 例外時の“必須確認”
- `Cache-Control` が機微に対して適切か（エラーキャッシュ事故）
- `Content-Security-Policy` / Frame制御が抜けていないか
- request_id/trace_id が返ってくるか（ログ側と繋がるか）

---

## 結果の意味（この状態なら何が言えるか）
- 詳細が出る：内部推定が可能になり、次の検証が具体化する（ただし断定はしない）
- 例外時にヘッダ/キャッシュが抜ける：**例外パスが攻撃者の入口**になり得る
- 相関キーが無い：再現性と監査が弱く、運用上のリスクが高い

---

## 攻撃者視点での利用（現実での使われ方）
- 詳細エラーから技術スタック/依存/内部URLを拾い、攻撃面を最短で絞る
- 例外パス（特定入力で落ちる）を入口に、別の制御（WAF/ヘッダ/キャッシュ）が抜ける条件を探す

---

## 次に試すこと（仮説A/Bで分岐）
### 仮説A：アプリ側の設定/例外処理が原因（アプリ修正中心）
- 次の一手
  - どの条件で詳細が出るかを固定（環境差・特定ヘッダ等）
  - 共通エラーハンドラの適用範囲（管理/SSO/API）を確認
  - 相関IDを返し、詳細は保護ログへ集約する設計を要求

### 仮説B：エッジ生成が原因（CDN/WAF/Proxy運用中心）
- 次の一手
  - エッジ生成エラーがキャッシュされ得るか（Cache-Control/Age等）
  - ルール例外と一致していないか（特定パスだけ挙動が違う）
  - 直オリジン到達で別のエラーが出ないか（資産境界のズレ）

---

## 修正（現実で通る要件）
- 本番は詳細を出さない（汎用エラー＋相関ID）
- 例外時もヘッダ/キャッシュ制御は一貫（テンプレ差で抜けない）
- 詳細は保護されたログ基盤へ（閲覧権限・保持統制）

---

## 04_labs（例外で抜けるを再現：詳細表示とヘッダ抜けを体感する）
- 追加候補Lab（例）
  - `04_labs/02_web/06_config/07_error_pages_boundary/`
- Lab設計要件
  - 200/500/403でテンプレが変わり、ヘッダが抜ける構成を用意
  - 目的：差分観測で“抜ける条件”を固定し、対策を要件化できること

---

## コマンド/例（例示は最小限：観測と判断を優先）
~~~~
# エラー観測の要点：
# - 200/403/500でヘッダ差分（CSP/Frame/Cache-Control）を取る
# - ボディの詳細（スタック/内部パス/環境名）を記録
# - request_id/trace_id（相関キー）を必ず確保
~~~~

---

## 深掘りリンク（最大8）
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_05_cache_control_機微レスポンスの境界.md`
- `06_config_06_debug_endpoints（/actuator_/swagger）露出.md`
- `06_config_08_logging_pii_secret（マスキング_相関）.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
- `05_input_19_cache_poisoning_03_poisoned_object（stored_response）.md`
