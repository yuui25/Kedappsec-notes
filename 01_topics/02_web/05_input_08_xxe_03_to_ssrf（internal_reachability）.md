## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 重点：XMLパーサが外部参照を解決できる状態は、アプリが“意図せずURLフェッチ機能”を持つのと同義。内部ネットワーク・メタデータ・管理系など「ユーザから直アクセスできない領域」に到達し得るため、入力→実行境界として閉じる（DTD/外部実体/外部サブセット/参照解決器の無効化が本体）。:contentReference[oaicite:0]{index=0}
- WSTG
  - SSRFテスト観点：アプリサーバが内部到達性を持つこと自体がリスクで、非公開アドレス/限定ホストへのアクセスが成立するかを評価する。XXE由来SSRFは「XML入力→パーサ→外部参照解決」が入口である点が差分。:contentReference[oaicite:1]{index=1}
- PTES
  - Vulnerability Analysis：XMLを扱う経路ごとに“どの実行環境が外へ/内へ出られるか”をモデル化（フロント/ワーカー/変換基盤/プロキシ/DNS）。
  - Exploitation（証拠化）：到達性（internal reachability）の成立根拠は、(A)OOB観測、(B)内部応答の反映、(C)タイムアウト差分、(D)内部副作用ログ、のいずれかで「内部へ出た」を確定する（再現条件を固定する）。
  - Reporting：修正は“SSRF対策”ではなく、まずXXEの入口（パーサ設定）を閉じる。残余リスクとして、変換基盤のegress制御・ネットワーク分離・監視の多層化を提示する。:contentReference[oaicite:2]{index=2}
- MITRE ATT&CK
  - 位置づけ：XXE→SSRFは、攻撃者が「被害者サーバの到達性」を借りて内部資源へアクセスする連鎖。内部サービス探索・メタデータ/資格情報の露出など、後続行動（横展開/クラウド権限奪取）へ接続し得る。:contentReference[oaicite:3]{index=3}

---

## タイトル
XXE→SSRF（Internal Reachability）境界モデル：XMLパーサが“内部到達性エンジン”になる瞬間

---

## 目的（このファイルで到達する状態）
- XXEを「ファイル読み取り」だけで終わらせず、**内部到達性（internal reachability）を借りるSSRF連鎖**として、成立根拠・観測設計・防御設計を説明できる。:contentReference[oaicite:4]{index=4}
- 実務で次を即断できる
  - どの経路（API/アップロード/変換/ジョブ）が、どの実行環境（フロント/ワーカー/別ネットワーク）でXMLをパースしているか
  - その実行環境が「内部に出られる」「外部に出られる」「DNSだけ」「プロキシ必須」など、到達性の現実
  - “XXEがBlindでも”内部到達性は成立し得ることを、証拠（OOB/ログ/差分）で確定する方法
- 次のファイル群（SSRF：到達性、URLトリック、プロトコル、SaaS機能）へ地続きに接続できる。:contentReference[oaicite:5]{index=5}

---

## 前提：XXE→SSRFは「SSRFの入口がXMLパーサ」というだけ
- SSRFは「サーバ側アプリに意図しない場所へリクエストさせる」脆弱性。内部限定サービスやメタデータ等、ユーザから到達できない領域へアクセスできる点が本質。:contentReference[oaicite:6]{index=6}
- XXEは「XML処理に干渉して、サーバがアクセスできる外部/内部システムと相互作用できる」ことが多い。つまりXXEは、SSRFの入口になり得る。:contentReference[oaicite:7]{index=7}
- 重要：XXEの“入口”を閉じるのが第一優先（DTD無効化等）。SSRF側の防御は多層（残余リスク低減）として扱う。:contentReference[oaicite:8]{index=8}

---

## 境界モデル（XXE→SSRFを成立させる4つの境界）
### 1) 入力→パーサ境界（XXEの前提）
- XMLパース地点が存在し、DOCTYPE/DTD/ENTITY を受理し得る（または経路差分で設定漏れがある）
- 経路差分が本命：メインAPIは安全でも、アップロード/変換/プレビュー/ジョブで別パーサが動く

### 2) パーサ→リゾルバ境界（外部参照解決）
- “外部参照を解決する（resolve）”機能が生きていることが、SSRF連鎖の直接条件
- ここは「レスポンスに出る/出ない」ではなく、「取りに行くか」が焦点（Blindでも内部到達性は成立し得る）

### 3) 実行環境境界（どのネットワークから出るか）
- もっとも実務的な差分：**XMLをパースする実行環境がどこか**
  - フロント（Web/API）か、ワーカー（変換/プレビュー/バッチ）か
  - その環境が属するネットワーク（DMZ/内部/クラウドサブネット）
- 同じ入力でも、処理系が違うと到達性が別物になる（= 再現性・影響が激変する）

### 4) ネットワーク到達性境界（internal reachability）
- WSTGが述べる通り、SSRFの重要点は「サーバが内部のバックエンドに到達できる」という信頼関係。ここが“借用”される。:contentReference[oaicite:9]{index=9}
- 内部到達性は、次の3軸で“現実”が決まる
  - 名前解決（内部DNS/外部DNS/固定リゾルバ/分割DNS）
  - ルーティング（プライベートレンジ、リンクローカル、NAT、セグメント分離）
  - 制御（プロキシ強制、宛先ホワイトリスト、FW/SG/NACL、WAFではなくNW側）

---

## “内部到達性”を薄くしないための評価軸（Reachability Matrix）
内部到達性は「到達できた/できない」ではなく、**どの種類の内部へ、どの手段で、どの証拠で**を固定して評価する。

### 軸A：到達対象（内部の種類）
- 内部管理系：管理UI、監視、CI/CD、社内API、認証基盤など（公開されない前提）
- 内部データ系：検索/メッセージ/キュー/DB相当のフロント（HTTPで喋るものが特に危険）
- クラウドメタデータ等：クラウド環境で「インスタンスにだけ見える情報」を提供する系
  - 代表例として、XXE→SSRFでメタデータから資格情報に到達するシナリオが学習用に提示されている。:contentReference[oaicite:10]{index=10}

### 軸B：到達手段（解決器が使うプロトコル/経路）
- HTTP(S)（最頻）：内部HTTPサービスに到達しやすい
- それ以外：実装や制約で揺れる（ここは“推測しないで観測”が鉄則）
- 重要：XXEの入口はXMLだが、到達性評価はSSRFと同様に「サーバがどこへリクエストできるか」で判断する。:contentReference[oaicite:11]{index=11}

### 軸C：観測方法（証拠の取り方）
- In-band（レスポンス反映）：最強だが、XXEはBlindになりやすい
- OOB（DNS/HTTP等）：Blindでも成立根拠を取れる（前ファイルの主題）
- 差分（タイムアウト/エラー/副作用ログ）：補助だが、環境制約下では重要になる

---

## 成立根拠（XXE→SSRF）を“報告に耐える形”に落とす
### 根拠1：内部到達性が“外部入力で変化した”こと
- 同一操作で「参照解決を試みる入力」だけを変えたときに、
  - 内部向けアクセスが発生する、または
  - 内部向けアクセスに起因する差分（例外/時間/ログ）が出る
- これを相関（request_id/job_id/時刻窓）で固める

### 根拠2：到達先が“ユーザから到達できない領域”であること
- ここがSSRFの核心（内部限定の信頼関係を借りている）
- WSTGの説明（バックエンドの非公開アドレス/限定到達）に沿って整理すると、報告が強くなる。:contentReference[oaicite:12]{index=12}

### 根拠3：入口がXXEであること（CWE-611の観点）
- CWE-611は、外部実体参照を不適切に制限した場合に「ローカルファイル読み取り等」を引き起こし得ると述べる。これを“参照解決器が危険な既定値で動く”根拠として用いる。:contentReference[oaicite:13]{index=13}
- 報告では「SSRFがある」だけでなく、「XMLパーサ設定不備（CWE-611相当）が入口」と因果で結ぶ

---

## 実務の落とし穴（ここを潰すと深さが出る）
### 1) “メイン経路は安全”の罠（変換/プレビュー/ジョブ）
- XXE→SSRFは、実務上「周辺機能（変換/インポート/プレビュー）」に寄っていることが多い
- 入口探索はUIより、連携・アップロード・非同期処理に重心を置く

### 2) egress制約で“観測できない”問題
- OOBが出ない＝脆弱性なし、ではない
- まず分類：
  - (a) リゾルバが動かない（外部参照解決が無効）
  - (b) ネットワークが出ない（内部/外部いずれか制約）
  - (c) 観測点が合っていない（DNSのみ等）
- この分類自体が、次のSSRF評価（到達性設計）に直結する

### 3) “到達できるが読めない”問題
- 内部到達性があってもレスポンスが返らない（Blind SSRF）
- その場合の評価は「内部操作が起きた証拠（ログ/副作用）」へ移す（薄い結論にしない）

---

## 防御設計（優先順位を間違えない）
### 第1優先：XXE入口を閉じる（本体）
- DTD無効化（DOCTYPE禁止）が最も安全、という指針が明確に示されている。:contentReference[oaicite:14]{index=14}
- 入口が閉じれば、XXE→SSRF連鎖の大半は消える

### 第2優先：SSRFとしての残余リスクを抑える（多層）
- OWASPのSSRF防止ガイダンスは「防御観点」を提示し、攻撃方法の説明を目的としない（設計側の観点に落としやすい）。:contentReference[oaicite:15]{index=15}
- 多層の考え方
  - 変換/プレビュー基盤のネットワーク分離（内部資源への到達性を縮める）
  - egress制御（外向きDNS/HTTPを業務要件最小へ）
  - 宛先制限（allowlist、解決先のIPレンジ制御、プロキシ統制）
  - 監視（DNS/HTTP/プロキシログで異常相互作用を検知）

---

## 証跡テンプレ（yes/no/unknown を出す：深さ＝相関の質）
- Evidence ID：E-XXE-SSRF-###
- 必須フィールド（最小）
  - パース経路：API / アップロード / 変換 / ジョブ
  - 実行環境：フロント / ワーカー / 別ネットワーク（分かる範囲）
  - 到達性の分類：内部へ出る／外へ出る／DNSのみ／HTTP不可／プロキシ必須（観測ベース）
  - 根拠：
    - OOBログ（DNS/HTTP）：時刻・宛先・回数（相関キー）
    - アプリログ：request_id/job_id、例外、処理開始・完了時刻
    - ネットワークログ：プロキシ/FW/DNS（あれば）
  - 結論：
    - yes：内部到達（または内部向け相互作用）が相関付きで確認できた
    - no：全経路でDTD/外部参照解決が無効であることを観測で裏取りできた
    - unknown：観測点不足（ログ/相関不可、非同期で追えない）→追加観測（どのログが要るか）を必ず提案

---

## Labs設計（“内部到達性”の差分を再現する）
- 追加候補Lab
  - `04_labs/02_web/05_input/08_xxe_to_ssrf_internal_reachability/`
- 差分軸（学びが深くなる構成）
  - 経路差分：同期API（即時）／非同期ジョブ（ワーカー）
  - 実行環境差分：フロントは外向き遮断／ワーカーはプロキシ経由のみ許可、など
  - 設定差分：DTD禁止（安全）／DTD許可（危険）
  - 観測差分：OOB（DNS/HTTP）＋ アプリログ（request_id/job_id）＋ プロキシログ
- 成果物
  - “同じ入力でも、どの実行環境がパースするかで到達性が変わる”ことを図示できる
  - これを、そのまま本番診断の相関設計（何を見るべきか）に転用する

---

## コマンド/リクエスト例（例示は最小限：観測設計の形だけ）
~~~~
# 目的：XXE→SSRFは「内部到達性を借りる」連鎖であり、成立根拠は“相関できる観測”で取る。
# 実務の形：
# - 1リクエストに対して request_id / job_id を確保
# - DNS/HTTP（プロキシ含む）の到達ログを、同じ時刻窓で相関
# - DOCTYPE無し/有り 等の差分比較で「外部参照解決が走った」ことを確定する
~~~~

---

## 参考（一次情報に近いもの中心）
- OWASP XXE Prevention Cheat Sheet（DTD無効化が最も安全）:contentReference[oaicite:16]{index=16}
- OWASP XML Security Cheat Sheet（XML起点のSSRFの位置づけ）:contentReference[oaicite:17]{index=17}
- CWE-611（外部実体参照制限不備の影響）:contentReference[oaicite:18]{index=18}
- OWASP WSTG：SSRFテスト（内部バックエンド到達性の観点）:contentReference[oaicite:19]{index=19}
- PortSwigger：XXE / SSRF（XXEがバックエンドと相互作用し得る点、SSRFの定義）:contentReference[oaicite:20]{index=20}
- PortSwigger Lab（XXE→SSRF→クラウドメタデータの学習例）:contentReference[oaicite:21]{index=21}
- OWASP SSRF Prevention Cheat Sheet（防御観点の整理）:contentReference[oaicite:22]{index=22}

---

## リポジトリ内リンク（最大3つまで）
- `01_topics/02_web/05_input_08_xxe_01_parser（doctype_entity）.md`
- `01_topics/02_web/05_input_08_xxe_02_blind（oob）.md`
- `01_topics/02_web/05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`

---

## 次（作成候補順）
- `01_topics/02_web/05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`
