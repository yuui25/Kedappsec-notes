## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - CSV/Spreadsheetは「保存されたデータが、別実行環境（表計算ソフト）で解釈される」典型例。export境界としては、(1) 出力時エスケープ、(2) “数式として解釈される条件”の遮断、(3) 受領者の想定（運用フロー）を含むリスク評価、(4) ダウンロード認可・監査、(5) 代替形式（XLSX/PDF）や安全モード案内が中心。
- WSTG
  - 入出力のテストとして、保存された値が export に乗るか、列/ヘッダ/セルのどこに入るか、また「ダウンロード後に何で開かれるか（Excel/Google Sheets/LibreOffice）」を前提に再現性を確認する。
- PTES
  - 位置づけ：侵害評価はサーバ側RCEではなく「人（運用担当者）の端末で発火」する。したがって、(1) どのロールがエクスポートを行うか（管理/監査/CS）、(2) どの端末/ネットワークで開くか（社内端末、VDI、制限）、(3) その結果の影響（情報漏えい、ワークフロー改ざん、横展開）を“業務フロー”として示す。
- MITRE ATT&CK
  - 初期侵入：T1566（Phishing）の近縁だが、アプリのエクスポート機能が配布チャネルになる。
  - 実行：T1204（User Execution：ユーザがファイルを開く）
  - その後：社内ネットワークへの到達、認証情報・データの窃取などへ波及し得る（ただし環境依存なので成立条件を分解して評価）。

---

## タイトル
CSV Formula Injection：exportが「データ移送」から「端末での解釈・実行」へ境界を跨ぐ

---

## 目的（このファイルで到達する状態）
- CSV式注入を「Excelの小技」ではなく、**export境界の脆弱性**として説明できる。
  1) 入力→保存→export→開封→実行/参照 のデータフローを描ける
  2) どのフィールドが危険（セル/列/ヘッダ）で、どこで無害化すべきかを決められる
  3) 実害を“業務フロー”で確定できる（誰が開くか、どの端末か、権限は何か）
  4) 修正方針を、アプリ側（出力エスケープ/フォーマット）と運用側（手順/注意喚起）に分けて提案できる

---

## 扱う範囲（本ファイルの守備範囲）
- 扱う：CSV/TSV等の表形式エクスポートにおける式注入（数式解釈の悪用）
- 対象となる“解釈器”：
  - Excel、Google Sheets、LibreOffice等（ただし実害の成立条件は環境に依存する）
- 扱わない：
  - “具体的な数式ペイロードの列挙”は最小限（本プロジェクトは境界と成立根拠を優先）
  - マクロ（VBA）そのものの悪用は別系統（ただし運用上同時に議論されやすいので接続は書く）

---

## 境界モデル（export境界＝アプリ外での再解釈）
### 1) 最小データフロー
ユーザ入力（フォーム/API）
→ 保存（DB/ログ/コメント/氏名/住所/品名 等）
→ エクスポート生成（CSV文字列化）
→ ダウンロード（管理者/CS/監査/運用）
→ 表計算ソフトで開封（端末環境）
→ セル内容が “データ” ではなく “数式” として解釈
→ 外部参照/リンク解決/関数実行などの副作用
→ 影響（情報漏えい、社内ネットワーク到達、認証情報露出、業務改ざん）

### 2) 境界の要点
- サーバは「ただ出力しただけ」でも、クライアント側が“実行”する
- したがって、脆弱性の本体は **出力エンコード不足** と **業務フロー上の開封行為** の組み合わせ

---

## どこが危険な入力面か（sourceの棚卸し：CSVに乗りやすい項目）
- ユーザ名、表示名、会社名、部署名
- メールアドレス、電話番号（形式チェックがあるが、先頭文字が残ることがある）
- 住所、備考、コメント、チケット本文
- 商品名/SKU、請求書の品目、自由入力のメタ情報
- インポート機能で入ったデータ（外部取り込み→再エクスポートが起きる）

ポイント
- “管理者だけ”が入力する項目ではなく、一般ユーザが入力した値が管理者向けエクスポートに乗る構図が最重要。

---

## どこに埋め込まれると危険か（sinkの棚卸し：CSV生成の落とし穴）
### A. セル値（フィールド値）として出力される
- もっとも典型。ユーザ入力がそのままセルに入る。

### B. 列ヘッダ（カラム名）として出力される
- “カスタムフィールド名”をユーザが設定できる製品で起きやすい。
- ヘッダ行は見落とされやすく、エスケープされていないことがある。

### C. ファイル名・シート名相当（CSVでもファイル名やzip内構造）
- CSV単体ではシート名はないが、zipで複数CSVをまとめる・後でXLSXに変換する等の派生フローで問題化する。

### D. 文字コード・区切りの揺れ
- Excelは環境により解釈が揺れる（UTF-8/BOM、SJIS、TSVなど）
- “想定していない解釈”が起きると、無害化処理がすり抜けることがある（例：先頭文字が別扱いされる）

---

## 成立条件（差分＝成立根拠として詰める項目）
CSV式注入の成立は「セルが数式として解釈されるか」で決まる。
診断で固めるべき成立条件は次。

### 1) その値が export に乗るか
- 入力 → 保存 → export の経路があること（最重要）

### 2) 出力時に無害化されていないか
- 先頭文字の扱い（危険文字が残っているか）
- 引用符で囲われるかどうか（囲われても解釈される場合があるため“囲うだけ”で完了としない）
- 改行/区切り/引用符のエスケープ（CSV崩壊＝別の列へずれる → 予期しない位置で発火、もあり得る）

### 3) 誰が開くか（人的成立条件）
- 管理者、CS、監査、営業、経理など、エクスポートを行うロール
- 自動処理か（BIツール、ETL、データパイプライン）手動か
- “開く”がルーチンか（毎日・毎週の定例業務なら攻撃価値が上がる）

### 4) どの環境で開くか（実害の半径）
- 社内端末（ドメイン参加、プロキシ、社内ネットワーク到達）
- VDI/サンドボックス（被害半径が小さい）
- Google Sheets（ブラウザ環境）かExcel（ローカル）か

結論
- 技術的成立（セルが式扱い）＋運用成立（誰かが開く）で“脆弱性としての実害”が確定する。

---

## 典型的な被害シナリオ（現実寄り：運用フローで書ける形）
### シナリオ1：CS/運用が“ユーザ一覧”をCSVで落として開く
- 一般ユーザが入力できるフィールド（氏名/会社名/備考）がCSVに出る
- 担当者がExcelで開封
- 端末側で式が評価され、外部参照やリンク解決等の副作用が起きる
- 影響：担当者端末・社内ネットワーク・資格情報・内部URL等への波及可能性

### シナリオ2：監査/経理が“請求/取引明細”を定例エクスポート
- 取引先名/品名/メモなど、外部入力（取引先や連携）由来の値が混ざる
- 定例作業で開封される＝攻撃機会が高い
- 影響：業務改ざん（誤集計、誤請求）＋端末側リスク

### シナリオ3：CSVが“別システムへインポート”される
- BI/ETL/CRMへ取り込まれ、そこで再解釈・再出力される
- “開封”が人間でなくても、変換処理が式を解釈する実装だと自動で発火する可能性がある
- 影響：データパイプライン汚染（広範囲）

---

## 検証手順（安全に“成立根拠”を固める：最大限具体だが破壊しない）
> 目的は「危険な式を実行させる」ではなく、「数式扱いされる境界がある」ことを示すこと。

### ステップ1：危険入力が入るフィールドを特定
- 例：表示名、会社名、備考、カスタムフィールド
- そのフィールドが export 対象に含まれるかを確認

### ステップ2：CSV出力の構造を確認（値の配置とエスケープ）
- どの列に入ったか
- 引用符、区切り、改行の扱い
- 先頭文字がそのまま出るか（前置の無害化があるか）

### ステップ3：開封環境の前提を固める（実害評価の条件）
- どのツールで開く運用か（Excel/Sheets/LibreOffice）
- 自動処理（ETL）があるか
- 可能なら、担当者の“実際の手順”をヒアリングして所見に組み込む

### ステップ4：再現は“無害な差分”で止める
- 実行/外部通信を起こす方向ではなく、
  - “数式として扱われる”ことを確認できる最小差分（表示や形式の差）
  を根拠にする。
- 実害が必要な場合でも、社内ルール/VDP/契約範囲に従い、隔離環境でのみ実施する。

---

## 報告の書き方（薄くならないための要点：技術＋業務）
### 1) 脆弱性の定義（境界）
- 「アプリが出力したCSVを、表計算ソフトが数式として解釈し得る状態で提供している」

### 2) 成立根拠（観測で書く）
- 入力値が export に含まれること（列名/行/サンプル）
- 無害化が行われていないこと（先頭文字、引用、正規化）
- 想定運用で開封されること（役割、頻度、環境）

### 3) 影響（実害の半径を条件付きで）
- “開封者端末”で起こり得る影響（情報露出、内部到達性、業務改ざん）
- ただし、環境により変わる点は条件として明示する（Excel設定、保護ビュー、ネットワーク制御等）

---

## 防御（export境界の修正：アプリ側が主、運用側が補）
### 1) アプリ側（最優先）
- 出力前に “式として解釈される可能性のある先頭文字” を無害化する
  - 方針例：文字列として明示するためのプリフィックス付与（一般論としては単一文字付与が使われるが、プロダクト要件に合わせて統一）
- 重要：単に引用符で囲うだけに依存しない（解釈器差分がある）
- カスタムフィールド名やヘッダ行も対象に含める
- CSV生成の正規化（改行、区切り、引用符）を厳格化し、列ずれを防ぐ

### 2) 代替形式の提供（リスク低減）
- CSV以外（XLSX/PDF）でも同じ危険が出る場合があるため、形式ごとに安全な生成方法を採る
- “安全モード（式を無効化）”相当の出力オプションがあれば提供する（組織の運用に合わせる）

### 3) 運用側（補助：ただしアプリ修正の代替にはしない）
- 開封手順（保護ビュー、マクロ無効、外部リンク無効）を標準化
- VDI/隔離端末で開封する
- 定例業務で開封する担当者の教育・手順書
- 監査ログ：誰がどのCSVを出したか（追跡可能性）

---

## 次に試すこと（仮説A/B）
### 仮説A：ユーザ入力が管理者CSVに乗る（典型）
- 次の一手
  - “どのロールが開封するか”の業務確認を所見に組み込み、優先度を上げる
  - 同じ入力が他のexport（請求、ログ、監査）にも波及しないかを棚卸し

### 仮説B：exportはあるが、入力は限定（管理者のみ）
- 次の一手
  - インポート経由（外部連携）で混入できないか
  - 監査/経理など別部門に渡る運用がないか（人的境界が広いほど影響が増える）

---

## 04_labs（理解用：export境界を再現する）
- 追加候補Lab（例）
  - `04_labs/02_web/05_input/16_csv_formula_injection_export_boundary/`
- Lab設計要件
  - 入力→保存→CSV生成→開封（複数ツール）を一連で観測
  - “セル値/ヘッダ/列ずれ”の3類型を比較し、無害化の差を可視化
  - 実害（外部通信等）は行わず、式扱いになる境界の観測で止める（安全）

---

## コマンド/例（例示は最小限：概念のみ）
~~~~
# ここでは「どの値がCSVにどう出力されるか」を見る。
# - 先頭文字が保持されているか
# - 引用符やエスケープがどう付くか
# - ヘッダ行（カスタムフィールド名）が無害化されているか
# - 改行や区切りで列ずれが起きないか
~~~~

---

## 深掘りリンク（最大8）
- `05_input_12_file_upload_03_execution_chain（preview_processor_rce）.md`
- `05_input_09_ssrf_04_saas_features（webhook_preview_pdf）.md`
- `05_input_15_regex_dos（ReDoS_検証）.md`
- `04_api_08_file_export_エクスポート境界（CSV_PDF）.md`
- `03_authz_08_file_access_ダウンロード認可（署名URL）.md`
- `04_api_09_error_model_情報漏えい（例外_スタック）.md`
- `06_config_03_セキュリティヘッダ（CSP_HSTS_Frame_Referrer）.md`
- `02_playbooks/05_api_権限伝播→検証観点チェック.md`
