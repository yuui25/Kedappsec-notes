<<<BEGIN>>>
# 05_input_02_入力→実行境界（デシリアライズ_型混乱_ガジェット前提）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：V5（Validation, Sanitization and Encoding）/ V12（Files and Resources）/ V1（Architecture）に接続。デシリアライズは“入力の復元（構造化→オブジェクト化）”が境界になり、検証は実装依存が強いので根拠設計が重要。
- WSTG：入力処理の境界として、構造化データ（JSON/XML/Binary等）がどこで“型”を持つか、どこで“復元処理”が走るかを観測→差分で確定する。
- PTES：Vulnerability Analysis（成立条件の切り分け）→ Exploitation（最小再現）→ Reporting（根拠提示）。推測で危険度を断言しやすい領域のため、unknown を許容し観測点を増やす。
- MITRE ATT&CK：Execution / Persistence / Privilege Escalation へ接続し得る（ただし本リポジトリでは“実行手順”ではなく、境界の位置・成立条件・証跡の取り方に限定）。

## 目的（この技術で到達する状態）
- 「JSONを受けている＝危険」ではなく、**どこで“デシリアライズ（復元）”が走るか**を観測→差分で確定できる。
- エラーや挙動差を、**型・復元処理・検証位置（入力前/復元後）**として説明できる。
- 実務で重要な判断（成立・不成立・不明）を、**証跡（通信・ログ・例外）に基づいて**出せる。

## 前提（対象・範囲・想定）
- 対象：API（JSON/XML等）、メッセージング、ファイルアップロード、セッション保存、ジョブ投入など「構造化データ」を受け取る機能。
- 観測点（固定）：
  - Proxyログ：Content-Type、ボディ構造、レスポンス差分（Status/Body/Headers）
  - 必要時：アプリ例外ログ、入口ログ、クラウド監査ログ（例外の相関）
- 依存（関連）：
  - 親：`01_topics/02_web/05_input_入力→実行境界（テンプレ デシリアライズ等）.md`
  - 観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - API境界：`01_topics/02_web/04_api_01_権限伝播モデル（フロント_バックエンド_ジョブ）.md`

## 観測ポイント（何を見ているか：復元処理の境界）
### 1) “復元処理”が発生し得る入口
- APIボディ（JSON/XML/フォームの入れ子）
- Cookie/セッション保存（サーバが状態を復元する設計）
- ジョブ投入（メッセージを復元して処理する）
- ファイル（CSV/Excel/PDF/独自形式）→サーバ側でパースして構造化する

### 2) まず確定するヘッダ・形式
- `Content-Type`（例：application/json 等）
- 文字コード/圧縮
- 送信形（JSONの入れ子、配列、オブジェクト）
- “型”を示唆する要素の有無（特定フィールド名、メタ情報、バージョン）

### 3) 復元の“結果”が見えるサイン
- エラーの種類が変わる（構文エラー／型エラー／検証エラー）
- 例外時のレスポンスが一貫する（同じ箇所で落ちる）
- 同じ入力でも、出力や副作用が変わる（処理分岐が型に依存している）

## 意味→判断→次の一手（デシリアライズを“境界”として扱う）
### 1) 重要なのは「復元前に検証しているか」「復元後に検証しているか」
- 意味：復元後にしか効かない検証（例：型チェック）がある一方、復元自体が危険領域になる場合がある。
- 判断：
  - 構文エラーで落ちる＝復元前の境界に到達している
  - 型エラーで落ちる＝復元後の型境界に到達している
  - 検証エラー（業務ルール違反）＝さらに後段（ビジネス境界）に到達している
- 次の一手：
  - **エラーの層（構文→型→業務）を並べる**。同じ入口で差分を作り、どの層まで到達できるかを確定する。

### 2) “型混乱”は、値ではなく「構造の差分」で起きる
- 意味：危険性の手触りは「文字列が危ない」ではなく、「文字列/数値/配列/オブジェクト」のような構造差分で現れることが多い。
- 判断：
  - 値を変えても同じ結果だが、構造を変えると結果が変わる＝型境界が存在する可能性
- 次の一手：
  - まずは**構造だけ**を最小変更（例：単値↔配列、null、入れ子）し、挙動差をProxyで保存する。

### 3) 影響説明は“実行”より前に「到達範囲」と「副作用」で固める
- 意味：この領域は実装依存が強く、推測で過大評価しやすい。
- 判断：
  - 例外や挙動差があっても、即「重大」と断言しない（根拠が足りないなら unknown）
- 次の一手：
  - 到達範囲（どの処理まで進むか）と副作用（DB更新、ジョブ生成、外部通知など）を、ケースに事実として残す。

## 失敗パターンの読み替え（誤判定を防ぐ）
- 400（Bad Request）：構文/パース境界で止まっている可能性（復元前）
- 422（Validation Error）等：復元後の検証境界で止まっている可能性
- 500（例外）：復元処理や型処理で落ちている可能性（ただし再現性とログ根拠が必要）
- 200だが結果が欠ける：型の解釈違いで処理分岐が変わっている可能性（差分で追う）

## 手を動かす検証（最小：差分セット）
> ここは危険な実行手順ではなく、「境界を特定する差分」の型だけを固定する。

~~~~
# 目的：復元処理（デシリアライズ）の境界を、構造差分で特定する

# 差分セット（最小）
# A) 正常リクエスト（基準）をProxyで保存（Content-Type/ボディ/レスポンス）
# B) 構造だけを最小変更（例：単値↔配列、null、入れ子の有無）して送る
# C) フィールドの順序・未知フィールド追加など、復元処理がどう扱うか差分を見る
# D) 例外が出る場合：再現性・時刻・リクエストID（あれば）を記録し、ログと相関する

# 記録すべきもの
# - 入口（エンドポイント/機能）
# - 形式（Content-Type）
# - 変更点（構造差分の要約）
# - 結果（Status/Bodyの差分）
# - 結論（成立・不成立・不明）と根拠（Proxyログ/例外ログの場所）
~~~~

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（証跡で断定できる）
  - どの入口で復元処理の境界に到達しているか（構文→型→業務の層）
  - 構造差分で挙動が変わるか（型境界が存在するか）
  - 例外の再現性があるか（境界が安定しているか）
- 言えないこと（追加証跡が必要）
  - 内部ライブラリや復元器の具体（実装/ログが必要）
  - 影響の最大範囲（副作用の根拠が必要。無ければ unknown とする）

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：400が多く、何が原因か分からない
- 次に試すこと
  - 基準リクエストと、構造差分の1点変更を並べ、どの層で落ちるか（構文/型/検証）を分類する
- 期待する観測
  - “どの境界まで到達するか”を yes/no/unknown で言える

### 仮説B：500が出るが偶発かもしれない
- 次に試すこと
  - 同条件で再現性を確認し、時刻・リクエストID・ログ相関を揃える（根拠が無いなら unknown）
- 期待する観測
  - 条件依存として説明できる、または観測不足として次の一手が定義できる

### 仮説C：結果が欠けたり、処理分岐が変わる
- 次に試すこと
  - 返却データの差分（項目が落ちる/増える）を記録し、型解釈や条件分岐の可能性として整理する
- 期待する観測
  - 値ではなく構造が境界になっていることを、差分で示せる

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - V5：復元処理に入る前後の検証、エラーハンドリング、許容する形式の限定
  - V12：ファイル/リソース由来のパース・復元処理の安全性（境界の明確化）
- WSTG：
  - 入力の形式・構造を変えた差分検証で、復元境界の位置を確定する
- PTES：
  - 推測ではなく、層（構文/型/業務）と証跡で結論を構造化する
- MITRE ATT&CK：
  - 実行境界に到達し得る領域のため、まず“境界の位置”と“到達範囲”を記録する（行動手順ではなく判断材料）

## 参考（必要最小限）
- 親：`01_topics/02_web/05_input_入力→実行境界（テンプレ デシリアライズ等）.md`
- 観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- API境界：`01_topics/02_web/04_api_01_権限伝播モデル（フロント_バックエンド_ジョブ）.md`

## 深掘りリンク（親ファイル末尾に追加する枠：最大8件）
- （親）`01_topics/02_web/05_input_入力→実行境界（テンプレ デシリアライズ等）.md` の末尾に本ファイルへのリンクを追加する
  - `05_input_02_入力→実行境界（デシリアライズ_型混乱_ガジェット前提）.md`

---

<<<END>>>
