## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 重点：XML入力の“解釈機構”が外部資源（DNS/HTTP/ファイル）へ到達しないこと（DTD/外部実体/外部サブセット/実体展開/参照解決器の無効化）。
  - Blind/OOBは「レスポンスに出ない」ことを安全根拠にできない。外向き相互作用（OOB）を“成立根拠”として取れるため、対策はパーサ設定＋egress制御＋監視の多層で閉じる。
- WSTG
  - Input Validation Testing（XML関連）として、(1) XMLパース地点の特定、(2) DOCTYPE/ENTITYが受理されるか、(3) 外部参照解決の有無、(4) 例外経路（アップロード/変換/ジョブ）での設定漏れ、を観測で確定する。
- PTES
  - Vulnerability Analysis：XMLを扱う経路・パーサ・実行コンテキスト（同期/非同期、ワーカー、プロキシ、DNS）をモデル化。
  - Exploitation：Blindはレスポンス差分が弱いので、OOB（DNS/HTTPなど）・エラー差分・時間差分・副作用（内部アクセス）を“証拠”として設計する（再現条件を固定する）。
  - Reporting：原因を「(A)パーサ設定」「(B)参照解決器」「(C)egress」「(D)監視/ログ」の4分解で提示し、修正は(A)(B)が主、(C)(D)は多層化として提案する。
- MITRE ATT&CK
  - 位置づけ：Blind XXEは“入力→パーサ→外部相互作用”という実行境界の破綻で、外向き通信（DNS/HTTP）を伴う検知・探索の典型。目的は情報取得そのものより、内部到達性（SSRF連鎖・内部探索）や環境指紋化（プロキシ/名前解決/ネットワーク分離の把握）へ繋がる。

---

## タイトル
Blind XXE（OOB）境界モデル：レスポンスに出ない“成立”を、どう確定して、どう潰すか

---

## 目的（このファイルで到達する状態）
- Blind XXEを「見えないから分からない」から脱却し、次の4層で“成立根拠”を作れるようにする。
  1) Parser境界：DOCTYPE/DTD/ENTITY が受理される（前ファイル）
  2) Resolver境界：外部参照（外部実体/外部サブセット/URI解決）を試みる
  3) Egress境界：DNS/HTTP/Proxyなど、外向き相互作用が出る（あるいは抑止される）
  4) 観測境界：アプリ応答ではなく、外部ログ（DNS/HTTP）・例外差分・時間差分・副作用で証拠化する
- 実務で「再現性のある報告」に必要な要素（相関キー、ログ源、環境条件、例外経路のスコープ）を固定できる。
- 次ファイル（XXE→SSRF連鎖）に地続きで進められる（Blind/OOBで得た“到達性の現実”を、そのまま内部到達性評価へ使う）。

---

## Blind XXE を薄くしないための“現実モデル”
### 1) Blindになる典型（返らない設計が多すぎる）
- 同期レスポンスにXML評価結果を出さない
  - 例：在庫チェック、配送見積、検証API、構文チェック、取り込みAPI（登録だけ）
- 非同期で処理される
  - 例：キュー投入→ワーカー変換→DB保存、プレビュー生成、監査ログ投入
- 変換/正規化レイヤが間にある
  - 例：XML→オブジェクト→別フォーマット、XSLT、テンプレ変換、署名検証（SAML周辺）、SVG/Officeプレビュー
=> したがって「レスポンスで読めない」は“仕様”であり、脆弱性否定にならない。

### 2) OOBが“本命”になる理由（攻撃者目線）
- 返らないなら、外へ出る痕跡（DNS/HTTP）だけで成立を確定できる
- さらに、OOBは「内部到達性の現実（DNSだけ出る/HTTPはプロキシ必須）」という“環境情報”を取れる
- これが次の一手（内部探索・SSRF連鎖・防御回避）を決める

---

## 境界モデル（Blind/OOBの成立根拠を作る4層）
### 層1：Parser境界（前提）
- DOCTYPE/DTD が拒否されるなら、Blind/OOB以前に“成立の前提”が崩れる
- ただし「メインAPIは拒否するが、ファイル処理/変換/旧機能で別パーサが生きている」が最頻
  - ここで“経路差分（同じ機能でも別エンドポイント/別処理系）”を探すのが実務の勝ち筋

### 層2：Resolver境界（外部参照を“解決しに行くか”）
Blind XXEで最重要なのは「展開して返すか」ではなく、まず「取りに行くか」。
- 典型の“取りに行く口”
  - 外部実体（一般実体 / パラメータ実体）
  - 外部サブセット（DTD外部参照）
  - XInclude（XML仕様の外部取り込み。利用している場合は別口になる）
  - ライブラリ独自のリゾルバ（カタログ、URIリライタ、プロキシ透過）
- 重要：Resolverは“アプリの意図”ではなく“パーサの設定と実装”で決まる
  - 例：外部一般実体を止めても、外部サブセットが生きている
  - 例：検証（validation）有効時のみ外部を取りに行く、など実装差分がある（言語/ライブラリで揺れる）

### 層3：Egress境界（外へ出られるか）
OOBが観測できない原因の大半は“脆弱性が無い”ではなく“出られない/観測できない”。
- パターン分類（診断の分岐に使う）
  - DNSだけ出る（HTTPは遮断 or プロキシ必須）
  - HTTPは出るがDNSが社内解決に固定（外部ドメインが引けない）
  - 直IP宛は遮断、FQDNのみ許可、SNIやHostで制限
  - egressはホワイトリスト制（特定ドメインのみ）
  - ワーカー環境だけ外へ出る（フロントは出ない）／逆もある
- ここで得られる“環境の現実”は、報告で「再現条件」として必須

### 層4：観測境界（成立根拠をどう残すか）
Blindで勝つには、最初から「証跡が残る観測設計」にする。
- OOBログ：DNS/HTTP（観測点のタイムスタンプが最重要）
- アプリログ：request_id、job_id、ワーカーID、例外スタック（可能なら）
- ネットワークログ：プロキシ、FW、DNSリゾルバログ（組織の運用次第で入手可能性が変わる）
- 差分：DOCTYPE無し/有り、外部参照無し/有り、で“同一条件比較”を作る

---

## Blind XXE の検出パターン（“攻撃手順”ではなく、成立根拠の型）
### パターンA：OOB相互作用で成立を確定（検出の王道）
- ゴール：外部観測点に「ターゲット環境からの到達」を残す
- 何が確定するか
  - XMLパーサが外部参照解決を試みた（Resolver境界が開いている）
  - どの経路（同期/非同期、どの環境）で解決が走ったか（時刻相関で推定できる）
  - egressの現実（DNSのみ/HTTP不可/プロキシ経由など）が見える
- よくある落とし穴（薄くなる原因）
  - “いつ飛んだか”の相関が取れていない（非同期だと数十秒〜数分ズレる）
  - 複数インスタンスでリトライが走り、ログが複数回になる（逆に根拠になるが整理が必要）
  - DNSキャッシュ（負のキャッシュ含む）で“1回しか出ない/出たり出なかったり”が起きる
  - 監視点がHTTPのみで、実際はDNSだけ出ている（観測点ミスマッチ）

### パターンB：エラー差分で“解決を試みた痕跡”を取る（OOB不可の次善策）
- ゴール：アプリ応答（またはログ）から、外部参照解決が試行された証拠を得る
- 典型の材料
  - 参照解決失敗の例外（名前解決失敗、接続拒否、タイムアウト）
  - DTD禁止/外部実体禁止の明示エラー（逆に“対策が効いている”根拠になる）
- 注意
  - エラーは環境差（WAF、ゲートウェイ、例外隠蔽）で消える
  - “エラーが出ない＝安全”ではない（非同期で握りつぶす設計がある）

### パターンC：時間差分・副作用（最弱根拠なので補助に留める）
- 時間差分：外部解決タイムアウトで遅延が出る場合がある
- 副作用：内部向けアクセス（内部DNS、メタデータ、内部HTTP）により別の監視に痕跡が出る場合がある
- ただし誤判定が多いので、OOB/エラー差分が取れるなら主根拠にしない

---

## 実務の“詰め方”チェックリスト（薄さを防ぐ）
### 1) パース地点の確定（XXEの前提）
- どの入力がXMLとして解釈されているかを確定する
  - Content-Typeだけで判断しない（バックエンドで変換されることがある）
  - ファイル処理（SVG/Office/設定インポート/EDI系）を必ず含める
- 「同じ業務操作」の別経路（旧API、管理UI、バッチ）を洗う

### 2) 非同期性の確定（時刻相関が生命線）
- リクエスト→処理（ジョブ投入）→ワーカー実行のどこでXMLがパースされるか
- 相関キーを確保
  - request_id / trace_id / job_id
  - ログにないなら、時間窓（T±N秒/分）と同時刻の操作を最小化して相関する

### 3) egressの現実を確定（DNS/HTTP/Proxy）
- “観測できない”理由を3分類して潰す
  - (a) Resolverが動いていない（外部参照無効）
  - (b) Egressが無い（外へ出られない）
  - (c) 観測点が合っていない（DNSのみ、HTTPのみ、プロキシのみ）
- これを整理すると、次ファイル（to SSRF）で「内部には出られる」評価に繋げられる

### 4) 設定漏れのスコープ確定（修正提案の質が決まる）
- “このエンドポイントだけ直せ”は不正解になりがち
- 典型スコープ
  - API層は安全、変換/プレビュー層が危険
  - 新実装は安全、旧実装が危険
  - フロントは安全、ワーカー（別コンテナ/別VM）が危険
- 報告では「どの処理系（コンポーネント）でパースされているか」まで落とす

---

## 防御設計（推奨の分解：どこを閉じるか）
### 1) パーサ設定（第一優先：ここが本体）
- 原則：DTDを無効化（DOCTYPE禁止）＝最も安全
- 次点：外部一般実体・外部パラメータ実体・外部サブセットを無効化
- 実体展開DoS（エンティティ爆発）への対策も別に必要（DTDを止めればまとめて閉じやすい）
- “例外経路”に適用できていること（ファイル処理、変換、ジョブ、管理機能）

### 2) egress制御（多層化：抑止と爆風低減）
- 業務要件のない環境（変換/プレビュー）からの外向きDNS/HTTPを制限
- プロキシ経由に統一し、宛先の許可制・監査を効かせる
- 注意：egress遮断“だけ”に依存すると、内部到達（社内DNS/内部HTTP）で被害が残る

### 3) 監視・検知（Blind/OOBは“検知設計”と相性が良い）
- 監視の主戦場
  - 外向きDNS（未知ドメイン、短命サブドメイン、異常頻度）
  - 外向きHTTP（プロキシログ、SNI/Hostの異常、到達失敗の増加）
  - 変換/プレビュー基盤の例外ログ（XMLパーサ例外の急増）
- アプリ側ログ
  - XML入力を受け取った処理の request_id / job_id / パーサ例外を残す（相関のため）

---

## 証跡テンプレ（報告に耐える“成立根拠”の形）
- Evidence ID（例）：E-XXE-OOB-###
- 最低限の記録項目
  - 対象機能：どの業務操作・どのエンドポイント・どの経路（UI/API/アップロード/ジョブ）
  - 実行条件：認証状態、役割、非同期か、再現回数
  - 観測根拠
    - OOBログ：時刻、宛先、種別（DNS/HTTP）、回数
    - アプリログ：request_id/job_id、例外有無
    - ネットワークログ：プロキシ/FW/DNS（可能なら）
  - 反証条件（重要）：DOCTYPE無しではOOBが出ない、など同一条件比較
- 結論（yes/no/unknown）
  - yes：OOB相互作用が相関付きで確認できた
  - no：DOCTYPE拒否＋全経路で一貫（かつログ/観測で裏が取れた）
  - unknown：観測点不足（egress不明、ログ無し、非同期で相関不可）→追加観測の提案を必ず添える

---

## ラボ設計（“最大限深い”ための再現環境の作り方：手順ではなく設計）
- 目的：Blind/OOBを「検出できる」「検出できない」両方の状態で再現し、判断軸を固定する
- 最小構成（現実寄り）
  - 経路：同期API（レスポンスに出ない）＋ 非同期ジョブ（キュー→ワーカー）
  - パーサ差分：安全設定（DTD禁止）／危険設定（DTD許可＋外部参照解決）
  - egress差分：DNSのみ許可／HTTPはプロキシ必須／完全遮断
  - 観測：DNSログ、プロキシログ、アプリログ（request_id/job_id）
- 成果物（keda-lab的に残す）
  - “観測点が無いとunknownになる”ケースも含めた、判断の分岐図
  - 例外経路（アップロード→変換）で設定漏れが起きるデモ（実務の最頻）

---

## コマンド/設定例（例示は最小限：防御側の設定観点のみ）
~~~~
# 目的：Blind/OOBの本体は「外部参照解決」が生きていること。
# 対策は入力フィルタではなく、XMLパーサ設定で DTD/外部実体/外部サブセットを止めること。
# 例（概念）：
# - DOCTYPE を禁止
# - 外部一般実体 / 外部パラメータ実体 を無効化
# - 参照解決器（XmlResolver等）を null/無効化
# - 実体展開の上限（安全処理）を有効化
~~~~

---

## 参考（一次情報に近いもの中心）
- OWASP Cheat Sheet（XXE Prevention / XML Security）
- OWASP Community（XXE Processing）
- PortSwigger（Blind XXE / OAST / Error-based）
- JPCERT/CC（Java向けのXXE防止指針：外部実体の扱いと前提）

---

## リポジトリ内リンク（最大3つまで）
- `01_topics/02_web/05_input_08_xxe_01_parser（doctype_entity）.md`（Parser境界：DOCTYPE受理）
- `01_topics/02_web/05_input_08_xxe_03_to_ssrf（internal_reachability）.md`（次：内部到達性へ接続）
- `01_topics/02_web/04_api_09_error_model_情報漏えい（例外_スタック）.md`（Blind時のエラー差分を証拠化）

---

## 次（作成候補順）
- `01_topics/02_web/05_input_08_xxe_03_to_ssrf（internal_reachability）.md`
