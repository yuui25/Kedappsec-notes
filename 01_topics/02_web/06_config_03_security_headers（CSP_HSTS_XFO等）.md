## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 破れる：ブラウザ境界（実行/埋め込み/送信/混在）が未規定だと、XSSやClickjacking、機微URLの外部送信、混在コンテンツ等の“成立条件”が緩む。例外パス（エラー/リダイレクト/管理画面）でヘッダが抜けると、対策が実質無効化される。
  - 満たす：CSP/HSTS/Frame/Referrer/Permissions等を「適用範囲」と「例外統制」込みで仕様化し、App/Proxy/CDNのどこで付与するかも含めて一貫性を担保する。
- WSTG
  - 観点：セキュリティヘッダの有無だけでなく、ページ種別（認証前後/管理/エラー/リダイレクト/静的）と生成主体（App/Edge）で差分を取り、例外条件を特定する。
- PTES
  - 位置づけ：脆弱性分析（設定/運用の不備）→ 侵害評価（成立条件の確認：Clickjacking/XSS/情報送信）→ 報告（適用範囲とロールアウト設計の要求）。
- MITRE ATT&CK
  - T1190（公開アプリ悪用）における“成立しやすさ”の環境要因。特にExecution（XSS）やDefense Evasion（例外パスでの抜け）を支える前提として位置づく。

---

## タイトル
セキュリティヘッダ（CSP / HSTS / Frame等）：ブラウザ境界を“仕様化”し、例外運用で崩れない状態にする

---

## 目的（このファイルで到達する状態）
- 「ヘッダが付いている/いない」ではなく、**どの境界（資産/信頼/権限）を閉じるために、どのレスポンスに何を付けるか**を決められる。
- 実務でよく起きる“形だけの導入”を避け、以下を説明できる状態にする。
  - 例外パス（/admin, /callback, /error, 3xx/4xx/5xx）での抜けを**差分観測**で潰す
  - CDN/WAF/Reverse Proxyでの上書き・削除を前提に、**付与主体**を特定する
  - CSP/Frame/Referrer等が、XSS/Clickjacking/URL漏えいの**成立条件**をどう変えるかを言語化する

---

## 扱う範囲（本ファイルの守備範囲）
- 代表的ヘッダの「実務での役割」と「適用範囲の決め方」を総合的に整理する（深掘りは分割ファイルへ）
- CSPの段階導入・違反収集は別ファイル
  - `06_config_04_csp_実務設計（report-only_違反収集）.md`
- キャッシュ境界（機微レスポンス）は別ファイル
  - `06_config_05_cache_control_機微レスポンスの境界.md`

---

## 前提：ヘッダは“ブラウザ挙動”を固定する契約（例外があると契約が破れる）
### 定義（実務で使える形）
- セキュリティヘッダ＝「ブラウザが何を許す/拒否するか」をレスポンス単位で宣言するもの
- 実務で問題になるのは、ヘッダの“欠落”より **適用範囲の分断**（重要ページだけ抜ける、エラーだけ抜ける、エッジだけ違う）

### 現実でよくある構成（想定して書く）
- CDN → WAF → Reverse Proxy（Nginx/Envoy等）→ App（Spring/Node/Rails等）
- “ヘッダ付与はエッジで一括”の方針が多いが、例外（管理・SSO・ファイル配信）が増えると崩れやすい

---

## 境界モデル（ヘッダが守る3つの境界）
- 資産境界：どの層がレスポンスを生成/加工しているか（App/Proxy/CDN）
- 信頼境界：外部オリジン（分析SDK/広告/外部API/IdP/ストレージ）をどこまで許すか
- 権限境界：管理/重要操作ページで、埋め込み・実行・送信をどこまで許すか

---

## ヘッダ群（現実で効く順：何をどこに当てるか）
### 1) Transport境界：HSTS（Strict-Transport-Security）
- 役割：初回HTTPS到達後のHTTPアクセスを拒否させる（“以降はHTTPS固定”）
- 現実ポイント
  - `includeSubDomains` は効くが、**古いHTTP運用のサブドメインが残っていると事故る**（段階導入が必要）
  - “初回HTTPを踏ませない”設計（HSTSだけに依存しない：リダイレクト/リンク/広告/メール導線）
- 観測：トップ/主要サブドメインで一貫して付くか、max-ageが運用として妥当か

### 2) 埋め込み境界：Frame（Clickjacking）
- 役割：第三者サイトへの埋め込みを制御する（UI操作誘導の成立条件を狭める）
- 現実ポイント
  - XFO（X-Frame-Options）は古いが残存率が高い（`SAMEORIGIN`が現実的）
  - 許可リストが必要なら、CSPの `frame-ancestors` を優先（埋め込み先が複数あるSaaS連携等）
  - “管理画面だけ例外”が最悪の落とし方（攻撃価値が最も高い）
- 観測：重要操作画面、404/500、ログイン画面で `frame-ancestors`/XFO が抜けていないか

### 3) 実行境界：CSP（Content-Security-Policy）
- 役割：XSSが起きても“実行できる範囲”を狭める（完全防止ではない）
- 現実ポイント
  - 第三者タグ・inline依存があると強化で壊れる → Report-Onlyで段階導入が現実解
  - SPA/SSRで“HTMLテンプレが複数”だと適用漏れが出る（/adminだけ別テンプレ等）
- 観測：Report-Only止まりか、適用範囲（HTMLのみ/管理のみ/エラーのみ）に分断がないか

### 4) URL送信境界：Referrer-Policy
- 役割：外部遷移時にRefererとして送る情報量を制御（機微パラメータ漏えい面を減らす）
- 現実ポイント
  - OAuth/OIDCや決済、外部ヘルプ等の導線があるとRefererが外部へ出やすい
  - presigned URL等を使うと、URL自体が権限トークンになり得るため重要（別ファイルと接続）
- 観測：外部オリジンへの遷移/埋め込み時に、機微が漏れない設定になっているか

### 5) 解釈境界：X-Content-Type-Options（nosniff）
- 役割：MIME sniffingを抑止（誤解釈によるXSS等の条件を減らす）
- 現実ポイント：静的配信（CDN）でContent-Typeが揺れると事故る。まず配信の正しさとセットで扱う。

### 6) 権限デバイス境界：Permissions-Policy
- 役割：カメラ/マイク/位置情報等の利用可否を制御（フィッシング/誤操作の被害半径を抑制）
- 現実ポイント：全拒否が安全だが、Web会議/本人確認機能などで必要になる。必要機能に限定して許す。

### 7) 分離境界（採用時のみ）：COOP/COEP/CORP
- 役割：cross-origin isolation等を実現（高度機能や隔離前提のセキュリティに関わる）
- 現実ポイント：SSOポップアップ/外部埋め込みと衝突しやすい。採用時は設計の一部として扱う。

---

## 観測ポイント（差分で“例外”を見つける）
- 代表ページ×ステータスで差分を取る（最低限）
  - HTML：`/` `/login` `/account` `/admin`
  - API：`/api/*` の代表（200/401/403）
  - 例外：404/500（アプリ生成かエッジ生成かも見る）
  - 遷移：302（ログイン誘導/SSOコールバック）
- 生成主体の切り分け
  - オリジン直（可能なら）とCDN経由でヘッダ差分
  - エラーページの見た目/ヘッダでWAF/Proxy生成を疑う

---

## 結果の意味（この状態なら何が言えるか）
- 一貫して付く：少なくとも“方針”は実装されている（次は強度/例外運用の評価）
- ページ/ステータスで抜ける：**例外パスが攻撃者の入口**になり得る（優先度を上げる）
- エッジとオリジンで差分：対策要求はアプリ修正だけでは閉じない（運用境界の問題）

---

## 攻撃者視点での利用（現実で使われる攻め筋）
- “管理/重要操作”でFrameが弱い → Clickjacking成立確認へ（1回の操作で重大影響が出る画面が狙われる）
- CSPが弱い/未適用 → 入力点探索を優先（XSS成立後の自由度が高い）
- Referrerが緩い → 外部遷移・外部埋め込み・外部JSからの情報送信面を狙う（URLにトークンが乗る設計は特に危険）
- ヘッダ分断（例外パス）→ “最初から守っていない場所”を狙う（WAF例外・別テンプレ等）

---

## 次に試すこと（仮説A/Bで分岐）
### 仮説A：ヘッダはあるが“例外パス”で抜ける（最頻出）
- 次の一手
  - 3xx/4xx/5xxで同じヘッダが付くかを差分観測
  - /admin, /callback, /error 等の“例外テンプレ”を重点確認
  - CDN/WAF/Proxyのルール例外（パス除外）と一致していないかを見る

### 仮説B：ヘッダは一律だが“現実要件”で弱くせざるを得ない
- 次の一手
  - 何が要件で緩いのかを特定（第三者タグ、埋め込み、SSO、ファイル配信）
  - 緩い部分を“範囲限定”できるか（管理画面だけ強化、外部タグはサブドメイン隔離等）
  - CSPはReport-Only導入へ（別ファイルへ接続）

---

## 修正（実務で通る要件の出し方）
- “ヘッダ一覧”ではなく、適用範囲で要求する
  - HTML（認証前後/管理/エラー）に必須、APIは必要最小、静的は配信正しさ＋nosniff等
- 付与主体を決める
  - 原則：Reverse Proxyで一括（テンプレ分断を避ける）
  - 例外：アプリがnonce等を生成するCSPはアプリ側、ただし漏れない実装にする
- 例外運用を統制
  - “例外は期限/理由/影響範囲”を持つ（恒久例外を作らない）

---

## 04_labs（ヘッダ分断の再現：例外パスで抜けるを体感する）
- 追加候補Lab（例）
  - `04_labs/02_web/06_config/03_security_headers_split_by_status_path/`
- Lab設計要件
  - 200/302/500でヘッダが変わるミニアプリ＋リバプロ（エラーは別テンプレ）
  - 目的：差分観測で“抜ける条件”を固定し、対策を付与主体/適用範囲で言語化できること

---

## コマンド/例（例示は最小限：観測と判断を優先）
~~~~
# 重要：同一Hostで「ページ種別×ステータス」を揃えて差分を見る
# - /, /login, /admin, /api/health
# - 200, 302, 401/403, 500
# 観測対象：CSP, HSTS, frame-ancestors/XFO, Referrer-Policy, nosniff
# 目的：例外パスでの抜け（=攻撃者の入口）を特定する
~~~~

---

## 深掘りリンク（最大8）
- `06_config_04_csp_実務設計（report-only_違反収集）.md`
- `06_config_05_cache_control_機微レスポンスの境界.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `06_config_12_s3_presigned_url_期限と権限境界.md`
- `05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`
- `05_input_19_cache_poisoning_03_poisoned_object（stored_response）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
