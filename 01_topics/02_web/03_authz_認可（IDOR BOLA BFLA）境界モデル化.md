<<<BEGIN>>>
# 03_authz_認可（IDOR BOLA BFLA）境界モデル化.md

（先頭要約：ガイドライン対応の位置づけ）
- ASVS：認可（アクセス制御）を「満たす/破れる点」を“境界モデル”として扱い、検証で説明できる状態にする
- WSTG：Authorization/Access Control 系テスト観点を、差分観測（条件A/B）へ落とす
- PTES：Vulnerability Analysis → Exploitation に直結する前提（境界の仮説と成立条件）を作る
- ATT&CK：攻撃者の目的（Discovery/Privilege/Collection 等）に対し、権限境界の突破点を説明できる状態にする

## 目的（この技術で到達する状態）
- 認可（AuthZ）を「403が返る/返らない」ではなく、次の3つの境界としてモデル化し、検証の“狙い所”を自分で決められる。
  - テナント境界：組織/契約/顧客の分離（越えたら重大）
  - ロール境界：権限レベル（一般/管理/運用/閲覧のみ 等）
  - オブジェクト境界：同ロール内の“自分のデータ/他人のデータ”
- IDOR/BOLA/BFLA を「用語」で理解するのではなく、実務で再現できる“観測→意味→次の一手”に落とし込める。
- 認証（AuthN）で確定した「鍵（Cookie/Token/ヘッダ）」を前提に、AuthZの検証条件（A/B）を組み立てられる。

## 前提（対象・範囲・想定）
- 対象：許可された範囲のWeb/APIのみ（契約・同意・検証環境の範囲を遵守）。
- 想定：
  - SPA + API、マイクロサービス、SSO前提、SaaS連携（外部API/IdP）がある
  - フロント（UI）とバックエンド（API）で認可の実装位置が異なることがある
- 依存（前段の接続）：
  - `01_topics/02_web/01_web_recon_入口・境界・攻め筋の確定.md`
  - `01_topics/02_web/02_authn_認証・セッション・トークン.md`
- 観測基盤（必須）：
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
- やらないこと：
  - 大量な総当たりや負荷を前提にしない（差分観測で境界を確定する）
  - 「落とし穴」章は作らない（事実確認できない一般論を増やさない）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 境界の“単位”を確定する（まずモデル化）
- テナント境界は何で表現されるか（観測で確定する）
  - サブドメイン（tenantA.example.com）
  - パス（/t/tenantA/…）
  - ヘッダ（X-Tenant 等）
  - トークンクレーム（tenant_id 等）
- ロール境界は何で表現されるか
  - トークンの claim（role/scope/permission）
  - API側の権限チェック（/admin 系）
  - 画面の表示差だけではなく、APIの応答差（200/401/403/404）で境界を観測する
- オブジェクト境界は何で表現されるか
  - URL/path/query（/users/123）
  - JSON body（"userId": 123）
  - GraphQL（query variables / node id）
  - 間接参照（ファイルキー、注文番号、請求書ID 等）

### 2) “誰が・何に”アクセスしているかを固定する（差分観測の設計）
- 主体（Who）：ユーザーA / ユーザーB、ロール差、テナント差（可能な範囲で）
- 対象（What）：同一オブジェクト / 別オブジェクト / 別テナントオブジェクト
- 操作（How）：読む（GET）/ 書く（POST/PUT/PATCH）/ 消す（DELETE）/ 実行（機能呼び出し）
- 重要：差分は1つずつ変える（主体だけ変える、IDだけ変える、操作だけ変える）

### 3) 認可の“強制点”を特定する（UIではなくサーバ側）
- UIで隠れているだけか、サーバで拒否されるかを分ける
  - UI：ボタン非表示、ルートに入れない
  - サーバ：APIが拒否（403等）し、データが返らない/更新されない
- APIゲートウェイ/バックエンド/サービス内のどこで拒否しているか（推定）
  - 返るエラーの型、ヘッダ、レスポンス時間、ログイン状態の扱いで補強する

### 4) 返答（レスポンス）の意味を“状態”として読む
- 401：本人性が未成立（AuthN問題）か、鍵が不足している可能性
- 403：本人性はあるが権限が足りない（AuthZ問題）の可能性
- 404：存在しない可能性もあるが、存在秘匿（認可失敗を404にする）かもしれない（追加観測が必要）
- 200/204：成功。ただし“部分成功”（一部フィールド欠落）や“副作用なし”もあり得るため、必ず状態確認を行う
- 状態確認（重要）：
  - レスポンスだけでなく、再取得（GET）で実際に更新されたかを確認する
  - 監査ログ/履歴/一覧の変化など、影響を観測できる点を用意する（可能な範囲で）

### 5) 代表パターン（用語ではなく境界として扱う）
- BFLA（機能レベル）：本来使えない機能（管理API/操作）を呼べるか
- BOLA（オブジェクトレベル）：他人/他テナントのオブジェクトを読める・更新できるか
- IDOR：参照IDの差し替えでオブジェクト境界が破れる現象（BOLAの典型原因になりやすい）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（確定できる）
  - どの“境界単位”（テナント/ロール/オブジェクト）が、どの“入力点”（URL/Body/Header/Token）で表現されているか
  - どの“操作”（読む/書く/消す/実行）が、どの条件で許可/拒否されるか（A/B差分）
  - 拒否がUIだけか、サーバ側で強制されているか（実装位置の推定）
- 推定（追加観測で強くなる）
  - 認可の強制点（Gateway/サービス内/DBレイヤ）と、越境点（外部SaaS/IdP）の影響
  - “404秘匿”の可能性（存在しないのか、存在するが見せないのか）
- 言えない（この段階の限界）
  - 1回のリクエストだけでの断定（状態確認や別条件での再現が必要）
  - “ロール”の正確な意味（業務定義）までは、外形観測だけでは分からない場合がある
  - 大域的な影響範囲（他機能への波及）は、関連API/画面の追加観測が必要

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
### 1) 優先度（最初に見る境界）
- テナント境界（越えたら重大） → ロール境界 → オブジェクト境界 の順で優先する
- “読む”より“書く/消す/実行”を優先する（影響説明が明確で、技術的価値も高い）

### 2) 攻め筋（モデルに基づく最短ルート）
- オブジェクトIDが露出しているなら：
  - まず「自分のオブジェクト」→「同ロール別ユーザ」→「別テナント」の順で差分観測
- 管理系機能が見えるなら：
  - UIで隠れていても、APIが存在するか（ルーティング/ログ/JS/ネットワークタブ）を観測し、最小の呼び出しで境界を確認
- 404秘匿っぽいなら：
  - “存在確認”のための観測点（一覧、検索、件数、別エンドポイント）を用意し、同一条件で差分を作る

### 3) 次の仮説に繋げる（AuthZ → API/入力/設定へ）
- 認可は単体では終わらない。境界モデルが固まったら、次のどれに進むかを決める。
  - `01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`（権限がどう伝播するか）
  - `01_topics/02_web/05_input_入力→実行境界（テンプレ/デシリアライズ等）.md`（入力が実行境界に到達するか）
  - `01_topics/02_web/06_config_設定・運用境界（CORS ヘッダ Secrets）.md`（境界が設定で崩れるか）

## 次に試すこと（仮説A/Bの分岐と検証）
### 共通の進め方（差分観測の最小セット）
- 最初に“代表機能”を1つだけ選ぶ（例：プロフィール、注文、チケット、ファイル、管理設定など）
- その機能について「読む」と「書く」の両方を用意する（可能なら）
- 取得すべき証跡は最小限で固定する
  - HAR、Proxyログ、検証メモ（主体/対象/操作/条件）
  - 追加が必要な時だけ pcap（ネットワーク境界の切り分け）

### 仮説A：ロール境界がUIだけで、APIが実質フラットに見える
- 検証（A/B）
  - A：低権限ユーザーで管理機能相当のAPIを呼ぶ（最小の1リクエスト）
  - B：管理ユーザーで同じAPIを呼び、差分（200/403、返却フィールド）を取る
- 期待する観測
  - サーバ側で強制されているか（403等）／されていないか（200等）が説明できる
  - “機能レベル”の境界がモデル化でき、次の検証対象が決まる

### 仮説B：オブジェクト境界がID差し替えで破れそう（BOLA/IDOR）
- 検証（A/B）
  - A：自分のオブジェクトIDで取得/更新
  - B：同ロール別ユーザー（可能なら）や別テナントのIDに差し替えて同操作
- 期待する観測
  - 返答（200/403/404）だけでなく、状態確認（再取得）で“本当に越えたか”を確定できる
  - どの入力点（URL/Body/Header/Token）が境界に効いているかが分かる

### 仮説C：テナント境界がヘッダ/トークン/パスに分散し、越境条件が複雑
- 検証（A/B）
  - A：テナントAの正規条件で操作
  - B：テナント識別子（パス/ヘッダ/トークンクレーム相当）のうち1つだけを変更し、どこで拒否されるかを観測
- 期待する観測
  - “越境の成立条件”が特定でき、検証の変数が減る（経験者が速い領域）

### 例示（最小のリクエスト観測：コマンドは補助）
~~~~
# 例：同一エンドポイントを「主体/対象」だけ変えて差分観測する（概念例）
# A（自分のオブジェクト）
curl -i -H "Authorization: Bearer <TOKEN_A>" "https://example.com/api/orders/1001"

# B（他人/別テナントのオブジェクトに差し替え）
curl -i -H "Authorization: Bearer <TOKEN_A>" "https://example.com/api/orders/1002"
~~~~
- 重要：この例は“コマンド”が主ではなく、「何を固定して何を変えるか（差分設計）」が主役

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 認可（アクセス制御）を、境界（テナント/ロール/オブジェクト）と強制点（サーバ側）としてモデル化し、満たす/破れる点を検証で説明できる状態にする
- WSTG：
  - Authorization / Access Control のテスト観点を、差分観測（主体/対象/操作のA/B）へ落とし込む
  - 該当が薄い場合の接続：認可は他すべてのテスト（入力/API/設定）に前提として影響するため、入口のモデル化として位置づける
- PTES：
  - Vulnerability Analysis：境界モデルと成立条件（A/B）を作り、検証優先度を決める
  - Exploitation：境界突破が成立する場合、最小の再現手順と影響確認（状態確認）までを揃える
- MITRE ATT&CK：
  - 戦術：Discovery（権限と境界の把握）、Privilege Escalation（機能/権限の越境）、Collection（他人データ取得）等
  - 技術名の貼り付けではなく「攻撃者の目的に対して、どの境界が突破点になるか」を説明できる状態にする

## 参考（必要最小限）
- `01_topics/02_web/02_authn_認証・セッション・トークン.md`
- `01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`
- `02_playbooks/04_authz_境界モデル→検証観点チェック.md`
- `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`

<<<END>>>
