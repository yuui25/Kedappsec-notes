<<<BEGIN>>>
# 05_input_01_入力→実行境界（テンプレート注入_SSTI）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：V5（Validation, Sanitization and Encoding）/ V12（Files and Resources）/ V1（Architecture）に強く接続。入力が「表示」ではなく「評価（式として実行）」へ到達する境界を扱う。
- WSTG：入力の扱い（サーバサイドレンダリング/テンプレート/式評価）で、反射や保存の経路と、サニタイズの位置を観測→差分で確定する前提。
- PTES：Vulnerability Analysis（成立条件の切り分け）→ Exploitation（最小再現）→ Reporting（根拠提示）の品質が出る領域。推測を排し、境界（どこで評価されるか）を証跡で固定する。
- MITRE ATT&CK：Execution / Persistence / Credential Access / Discovery に接続。入力が実行境界を越えると、後続の行動選択が大きく変わる（ただし本リポジトリでは“手順”ではなく判断と観測の型に留める）。

## 目的（この技術で到達する状態）
- 「入力が画面に出た」ではなく、**入力が“テンプレートとして評価される（=実行境界を越える）”条件**を観測→差分で特定できる。
- 同じ文字列でも発火したりしなかったりする状況を、**レンダリング経路・エンコード位置・評価対象のコンテキスト**として説明できる。
- “危険そう”で止めず、**成立条件／影響範囲／再現性**をケースに残せる（成立・不成立・不明）。

## 前提（対象・範囲・想定）
- 対象：サーバサイドでテンプレート（HTML/メール/通知/帳票など）を生成する機能、または式評価（フィルタ/関数）が使われる機能。
- 観測点（固定）：
  - Proxyログ：入力がどのAPI/画面で送られ、どのレスポンス（または後続表示）で反映されたか
  - 必要時：入口ログ（アクセスログ）、アプリログ（テンプレート例外）、クラウドログ（例外発生時の痕跡）
- 依存（関連）：
  - 親：`01_topics/02_web/05_input_入力→実行境界（テンプレ デシリアライズ等）.md`
  - 観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - 実行：`02_playbooks/02_web_recon_入口→境界→検証方針.md`（どの入力点から始めるか）

## 観測ポイント（何を見ているか：実行境界の分解）
テンプレート注入は「入力→表示」ではなく「入力→評価→出力」の境界問題。最初に以下を分解して固定する。

### 1) 入力点（どこから入るか）
- フォーム（プロフィール、検索、コメント、テンプレ編集機能）
- API（JSONフィールド、クエリ、ヘッダ）
- アップロード由来（ファイル名、メタデータ、CSV等）
- 外部連携由来（Webhook、同期データ）

### 2) 伝播経路（どこを通るか）
- 反射：入力→即レスポンス
- 保存：入力→DB→後で表示（別画面、別ユーザ、メール/通知など）
- 変換：入力→サニタイズ/正規化→テンプレートへ埋め込み

### 3) 評価点（どこで“式”として扱われるか）
- サーバサイドテンプレート（HTML/メール/帳票）
- フィルタ/関数（テンプレの式、ヘルパー）
- 例外挙動（テンプレ解析エラー、スタックトレース）

### 4) 表示コンテキスト（どの文脈で出るか）
- HTML本文、属性値、URL、JavaScript文字列、JSON、ログ
- どのコンテキストでエスケープされているか（エスケープの位置が境界）

## 意味→判断→次の一手（テンプレート注入を“境界”として扱う）
### 1) 「表示された」だけでは結論にならない
- 意味：テンプレート注入は“表示”ではなく“評価（解釈）”が本体。
- 判断：
  - 文字列がそのまま出た＝評価されていない可能性が高い
  - 特定の記号や構文で挙動が変わる＝評価点（またはフィルタ）が存在する可能性
- 次の一手：
  - **差分を最小にして**「表示（文字列）」と「評価（解釈）」を切り分ける（同じ入力点・同じ経路で1要素だけ変える）

### 2) “どこで評価されるか”を先に確定する
- 意味：同じ値でも、UI表示・メール通知・PDF出力で評価点が違う。
- 判断：
  - 反射と保存で挙動が違うなら、評価点が別（またはエスケープ位置が別）
- 次の一手：
  - 入力→表示までの経路をケースに書く（いつ・どこで出たか）。表示箇所が複数あるなら、どれが評価点か優先順位を付ける。

### 3) エスケープは「効いている/いない」ではなく「どこで」効いているか
- 意味：入力時、保存時、レンダリング直前、のどこで変換されるかが境界。
- 判断：
  - 変換の位置が違うと、別の出力経路で抜けることがある（メールでは抜ける等）
- 次の一手：
  - 同一入力を複数出力（画面/メール/帳票）で比較し、差分が出るなら“エスケープ位置の差”として整理する。

## 失敗パターンの読み替え（誤判定を防ぐ）
- 500/例外：評価点が存在する可能性（ただし断定せず、同条件で再現性と例外ログの根拠を取る）
- 200だが出力が欠ける：フィルタ/正規化で変換されている可能性（入力→保存→表示のどこで変わったかを追う）
- UIでは出ないが通知で出る：評価点が通知/テンプレ側にある可能性（評価点の移動）

## 手を動かす検証（最小：差分セット）
> ここは“危険な手順”ではなく、観測と差分の型だけを固定する。

~~~~
# 目的：入力が「文字列」扱いか「式」扱いかを、同条件で差分比較する

# 差分セット（例：同一入力点・同一保存経路で）
# A) 文字列として扱われるはずの入力（安全側の基準点）
# B) 記号を含む入力（表示が変わる/エラーになる等の差分が出るか確認）
# C) 入力を別の出力経路でも確認（画面表示/メール/帳票など）

# 記録すべきもの
# - 入力点（どのフィールド/どのAPI/どの画面）
# - 伝播経路（反射 or 保存、表示される画面/通知の場所）
# - 結果差分（表示の変化、例外の有無、ステータス/レスポンス）
# - 結論（成立・不成立・不明）と根拠（Proxyログ/HAR/サーバログの場所）
~~~~

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（証跡で断定できる）
  - 入力がどの経路でどこに出るか（反射/保存/通知等）
  - “差分”として挙動が変わる条件があるか（例外/変換/出力差）
  - 評価点の候補（どの出力経路でのみ挙動が変わるか）
- 言えないこと（追加証跡が必要）
  - テンプレートエンジン種別や内部評価の詳細（実装/ログ/設定が必要）
  - 影響範囲の確定（他ユーザ・他経路への波及はケースで条件を揃えて判断）

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：入力は表示されるが、評価されていない気がする
- 次に試すこと
  - 出力経路を増やして比較する（画面だけでなく通知/帳票など）
- 期待する観測
  - 評価点が存在しない（=文字列扱い）か、別経路に評価点があるかを切り分けられる

### 仮説B：特定の入力で500/例外が出る
- 次に試すこと
  - 同一条件で再現性を確認し、例外発生の根拠（時刻・リクエストID・ログ）を揃える
- 期待する観測
  - “偶発”ではなく“条件依存”として説明できる（不明→次の観測点が定義できる）

### 仮説C：同じ入力でも出力経路で変換が違う
- 次に試すこと
  - 入力→保存→表示のどこで変わるかを追い、変換位置（境界）をケースに固定する
- 期待する観測
  - エスケープ位置の差分として整理でき、対策/影響説明が具体化する

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - V5：入力がテンプレート評価に到達しないこと（サニタイズ/エンコードの設計）
  - V1：テンプレート生成経路（評価点）の把握と分離
  - V7：例外・ログが過剰情報を出さないこと（観測の根拠にもなる）
- WSTG：
  - 入力の反射/保存と出力コンテキストの差分を観測し、成立条件を yes/no/unknown で出すための前提
- PTES：
  - 成立条件の切り分け→最小再現→根拠提示を崩さない（再現性が出ない場合は unknown と次の観測点を明記）
- MITRE ATT&CK：
  - 実行境界が越えられる場合、後続の意思決定（実行/探索/情報収集）が変わるため、まず“境界の位置”を確定して記録する

## 参考（必要最小限）
- 親：`01_topics/02_web/05_input_入力→実行境界（テンプレ デシリアライズ等）.md`
- 観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- 実行：`02_playbooks/02_web_recon_入口→境界→検証方針.md`

## 深掘りリンク（親ファイル末尾に追加する枠：最大8件）
- （親）`01_topics/02_web/05_input_入力→実行境界（テンプレ デシリアライズ等）.md` の末尾に本ファイルへのリンクを追加する
  - `05_input_01_入力→実行境界（テンプレート注入_SSTI）.md`

---

<<<END>>>