## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - この技術で満たす/破れる点：認証試行に対するレート制御、アカウントロック/解放、例外パス（別エンドポイント/別フロー）で制御が抜ける設計、ユーザ列挙と結びつく“試行可能性”の管理
  - 支える前提：認証境界の防御（MFA/SSO以前に「試行できる回数」が安全性を決める）
- WSTG：
  - 該当テスト観点：Authentication Testing（Brute Force、Rate Limiting、Account Lockout、User Enumeration、Multi-Factorの試行制御）
  - どの観測に対応するか：ログイン/OTP/回復コード/再認証（step-up）等の“試行系エンドポイント”を面として列挙し、制御の一貫性（例外パス）を検証する
- PTES：
  - 該当フェーズ：Vulnerability Analysis（防御制御の欠落/迂回の成立条件を切る）、Exploitation（許可された範囲での最小検証）
  - 前後フェーズとの繋がり（1行）：11の列挙/回復導線、13の認証CSRF/フロー設計、15/16のセッション/再認証と結合して「どこが現実的な侵入口か」を決める
- MITRE ATT&CK：
  - 戦術：Credential Access / Initial Access
  - 目的：パスワード/OTP/回復コードなどの試行を成立させる、あるいはロックアウトを悪用してDoS/妨害（可用性）を誘発する（※ここでは手順ではなく成立条件の判断）

## タイトル
bruteforce_rate-limit_lockout（例外パス）

## 目的（この技術で到達する状態）
- 「試行できる入口（例外パス含む）」を列挙し、どのキー（IP/アカウント/端末/セッション等）で、どの強度（回数/窓/遅延/ブロック/ロック）で抑止されているかを説明できる
- 防御の一貫性（同じ認証でも入口が違うと制御が抜ける）を、HTTP観測＋WAF/CDN/IdP境界の証跡で確定できる
- “強すぎる制御” による副作用（アカウントロックDoS、サポート負荷、誤検知）を含めて、運用として成立する改善案を出せる
- 後続（13 login CSRF、15 同時ログイン、16 step-up、17 rotation、19 passkeys、20 magic-link）へ「どの入口を重点確認すべきか」を渡せる

## 前提（対象・範囲・想定）
- 対象：認証に関わる“試行”が発生する全入口
  - パスワードログイン（UI / API / モバイルAPI）
  - OTP/MFA検証（TOTP / SMS / Push 承認の確認エンドポイント）
  - 回復（回復コード、メールリンク、サポート代行）
  - step-up（重要操作前の再認証）
  - OAuth/OIDC（/authorize → /token）やSAML（IdP側ログイン）における認証試行
- 想定する境界：
  - CDN/WAFが前段にある（rate-limitがエッジで行われる可能性）
  - IdP連携がある（RPとIdPで制御の責任分界が分かれる）
  - 多端末/モバイル/プロキシ/VPNがあり、IPベース制御が破綻しやすい
- 安全な範囲（最小検証の基本方針）：
  - 実ユーザに影響する回数試行はしない（テストアカウント/検証環境を前提）
  - “成立条件の切り分け” を目的に、少数回（例：3〜10回程度）で挙動を観測する
  - ロックアウトが疑われる場合は、解除手段（時間/サポート/自己解除）と監査ログ取得が先（深追いしない）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 「入口（例外パス）」の列挙：同じ認証でも経路が違う
- 典型的に制御が分裂する入口（例）
  - UI：/login
  - API：/api/login, /api/auth/login, /session, /v1/auth/token
  - モバイル専用：/mobile/auth, /oauth/token（アプリクライアント）
  - MFA：/mfa/verify, /otp/verify, /challenge
  - 回復：/forgot, /reset, /recovery/verify
  - SSO：/oauth/authorize, /oauth/token（RP/IdP双方の入口）
- 観測の作法：
  - “同じ資格情報” で入口を変えて挙動が変わるか（制御の一貫性）を見る
  - 入口を変えたとき、どの層（アプリ/エッジ/IdP）がブロックしているかを区別する

### 2) レート制御の「キー」と「挙動」を確定する（境界＝どこで誰を束ねるか）
- 代表的なキー（単独/複合）：
  - IP（送信元IP、X-Forwarded-For等の扱い含む）
  - アカウント（username/email/phone）
  - 端末（device id、cookie、fingerprint）
  - セッション（未認証セッションID、CSRFトークン等）
  - クライアント種別（User-Agent、client_id、API key）
- 観測で確定したいこと：
  - 何回で反応が変わるか（閾値）
  - 時間窓（固定/スライディング/指数バックオフ）
  - 反応の種類（429/403/302/成功に見せる/遅延/キャプチャ要求）
  - “成功時にリセットされるか”（成功があると試行カウンタが戻る設計は攻撃に有利になり得る）
- 証跡として残す項目（HTTP中心）：
  - status / body（文言差）
  - Retry-After 等のヘッダ、rate-limit系ヘッダ（あれば）
  - Set-Cookie の変化（端末キーが付与される/更新される）
  - リダイレクト先（captcha/verify/lockout案内）
  - 応答時間（遅延による抑止があるか）

### 3) アカウントロック（lockout）の「対象」「解除」「副作用」を観測する
- ロックの対象：
  - アカウント単位ロック（本人にも攻撃者にも影響）
  - IP単位ブロック（共有IPでは巻き込みが起きる）
  - デバイス単位制限（cookie削除で回避される可能性）
- 解除条件：
  - 時間経過（何分/何時間）
  - 本人操作（メール/OTP/パスキーで解除）
  - サポート介入（本人確認の強度へ接続：11と直結）
- 副作用（可用性・運用）：
  - ロックアウトDoS（第三者が他者アカウントをロックできる）
  - サポート負荷（解除が人手）
  - 正当ユーザの離脱（過剰抑止）
- 観測の焦点：
  - “ロック状態” が、別入口（API/モバイル/SSO）にも一貫して適用されるか（例外パスの検出）
  - ロック中に返す情報が列挙につながらないか（存在するユーザだけ lockout 表示等）

### 4) “認証以外” に見える試行点（例外パスの温床）
- 例外パスになりやすいもの：
  - パスワード変更/再設定のコード検証（短い数値コード等）
  - magic-link のトークン検証（20へ）
  - step-up（重要操作前の再認証：16へ）
  - refresh token の再発行（17へ：失敗時挙動が緩いと試行点になる）
- 観測の考え方：
  - 「ログイン画面だけ見て安全と判断しない」
  - “検証系エンドポイント” を横断で列挙し、同じ抑止が掛かっているかを確認する

### 5) 収束のための正規化キー（後工程に渡す）
- 推奨キー：rl_key_boundary
  - rl_key_boundary = <endpoint> + <auth_stage>(login|otp|recovery|stepup|token) + <rate_key>(ip|acct|device|session|mixed|unknown) + <enforcer>(app|waf|idp|mixed) + <threshold_hint> + <confidence>
- 記録の最小フィールド（推奨）
  - endpoint / method
  - auth_stage
  - rate_key（推定でも可、根拠を添える）
  - enforcer（どの層が抑止しているか）
  - threshold_hint（回数/窓/遅延）
  - lockout_model（none/time_based/manual_unlock/unknown）
  - evidence（HAR、レスポンス要約、ヘッダ、時刻）
  - action_priority（P0/P1/P2）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（確定できる）：
  - 試行点（入口）の一覧と、各入口の抑止モデル（rate-limit/lockout/遅延/captcha等）
  - 例外パス（入口差分）で制御が抜ける/弱い/別モデルになっている事実
  - 抑止を実装している層（アプリ/WAF/IdP）の推定と、その責任分界（どこを直すべきか）
- 推定（根拠付きで言える）：
  - IPベース偏重で、NAT/VPN/モバイル環境では実効性が下がる可能性
  - 成功時リセットや、入口差分により “試行を継続しやすい” 設計の可能性
  - lockoutが運用負荷・DoSを生み得る可能性（解除条件と監査の有無から）
- 言えない（この段階では断定しない）：
  - 実際の侵害成立（大量試行をしない前提のため）
  - WAF/IdP内部のルール詳細（ただし挙動から責任分界は示せる）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- 優先度（P0/P1/P2）
  - P0：認証試行が現実的に成立し得る（抑止が無い/非常に弱い/例外パスが明確）、または短いコード系（OTP/回復コード）に試行抑止が薄い
  - P1：抑止はあるがキーが弱い（IP偏重、入口ごとに分裂、成功時リセット等）で、環境次第で突破可能性が残る
  - P2：抑止は堅牢だが運用副作用が大きい（lockout DoS、解除が人手、誤検知）で改善余地
- “狙い目” の判断軸（手順ではなく条件）
  - 入口が複数ある（UI/API/SSO/モバイル）ほど例外パスが出やすい
  - 試行対象が短い（OTP/回復コード）ほどレート/ロック設計の差が致命になりやすい
  - 抑止層が分裂（WAFはloginだけ、アプリはOTPだけ等）すると抜け道が生まれる
- 後続への接続（意思決定）
  - 11で列挙が成立しているなら、12の弱さは即P0化しやすい（“試行できる対象集合”が作れるため）
  - 13（login CSRF）と結合すると、試行の“自動化/誘導”の影響が増えるため、抑止の優先度が上がる
  - 16（step-up）の再認証が弱いと、ログインが強くても重要操作が崩れる（入口を広く見る）

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：入口ごとに抑止が分裂している（例外パスがある）
  - 次の検証：
    - UI/API/モバイル/SSO/OTP を “同一アカウント・同一IP” で少数回ずつ試行し、閾値/応答/ヘッダ/遅延の差分を比較する
    - どの層が抑止しているかを切る（WAFっぽい同一エラーページ、IdPへのリダイレクト、アプリ固有のエラー等）
  - 判断：
    - 差分あり：例外パスとしてP0/P1（入口統一、共通レートサービス化、IdP/RPの責任分界明確化が改善方針）
    - 差分なし：次はキー強度（仮説B）とlockout副作用（仮説C）へ移る
- 仮説B：抑止はあるがキーが弱い（IP偏重/端末紐付け無し/成功時リセット等）
  - 次の検証：
    - 同一アカウントで、クライアント条件（cookie有無、別ブラウザ等）を変えても同じ抑止が掛かるかを見る（端末キーの有無の推定）
    - 少数回で “リセットされる条件” の兆候を見る（成功/失敗、一定時間、captcha通過等で変わるか）
  - 判断：
    - 弱い兆候：P1（キー設計：アカウント＋端末＋IP等の複合、成功時リセットの扱い見直し）
    - 強い設計：次は運用副作用（仮説C）へ
- 仮説C：lockout が強すぎて運用/可用性リスクが高い（DoS/巻き込み）
  - 次の検証：
    - ロック解除条件（時間/本人操作/サポート）を証跡化し、解除が人手前提なら運用リスクとして整理
    - ロック状態の通知（本人へ通知されるか）、監査ログ（誰がいつ何回失敗）が取れるかを確認
  - 判断：
    - 運用リスク大：P2〜P1（“遅延/段階的制限/captcha” 等の設計に移行、サポート統制は11と接続）
    - 妥当：抑止は強いので、他の入口（16/20/11）を優先

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - `04_labs/02_web/02_authn/12_rate-limit_lockout/`
    - 構成案：アプリ（ログイン+OTP+回復コード）＋リバプロ（エッジ制限）＋擬似IdP（SSO）を用意し、“抑止層の分裂” を再現できるようにする
- 取得する証跡（深く探れる前提：HTTP＋周辺ログ）
  - HTTP：HAR（入口ごとに開始〜失敗まで少数回）、ステータス/ヘッダ/遅延
  - アプリログ：失敗カウント、ロック状態遷移、解除イベント、captcha要求イベント
  - WAF/CDNログ：ブロック理由（rate-limitルールID等）、キー（IP/ヘッダ）を示す痕跡（可能な範囲）
  - IdPログ：認証失敗/アカウントロック/クライアントID別の制御（可能な範囲）
  - 監査ログ：誰のアカウントがいつロックしたか（運用統制の要）
- 観測の設計（巻き戻し前提）
  - 閾値観測は “少数回” で留め、閾値の推定（threshold_hint）として記録する
  - ロックアウトの解除はスナップショット/管理者解除で巻き戻し、検証による運用汚染を避ける

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 例：同一アカウントに対して入口差分を取る（擬似。実際はHAR中心で記録する）
POST /login                 { user, pass }
POST /api/auth/login        { user, pass }
POST /mfa/verify            { otp }
POST /account/recovery/verify { code }

# 観測すること（擬似）
- 失敗回数が増えた時の status/ヘッダ/遅延の変化
- 入口によって同じ変化が起きるか（例外パス検出）
- lockout発生時に“誰を束ねているか”（IP/アカウント等）の推定材料
~~~~
- この例で観測していること：
  - 入口分裂（例外パス）と、抑止モデルの差分
- 出力のどこを見るか（注目点）：
  - 429/403/302、Retry-After等、Set-Cookie、レスポンス時間、ロック案内の文言と一貫性
- この例が使えないケース（前提が崩れるケース）：
  - IdP側のログイン画面が別ドメインで、RP側からは抑止が観測できない（→IdP側ログ/設定の証跡が主）

## 参考（必要最小限）
- OWASP ASVS（認証試行の制御、例外パス、ロックアウト設計）
- OWASP WSTG（Brute Force / Rate Limiting / Account Lockout / MFA試行）
- 責任分界の設計資料（RP vs IdP、WAF/CDN vs アプリ、サポート運用）

## リポジトリ内リンク（最大3つまで）
- `01_topics/02_web/02_authn_11_account_recovery_本人確認（サポート代行_回復コード）.md`
- `01_topics/02_web/02_authn_16_step-up_再認証境界（重要操作_再確認）.md`
- `01_topics/02_web/02_authn_20_magic-link_メールリンク認証の成立条件.md`
