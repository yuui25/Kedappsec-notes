## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 破れる：署名URLを認可の代替にすると、発行前検証（所有者/テナント/権限）が崩れる。期限が長いと漏えい時の被害期間が長い。URLがログ/Referer/キャッシュに残ると、権限トークンが拡散する。
  - 満たす：発行前の認可を徹底し、短寿命・最小権限（GET/PUT分離、対象キー固定）で被害半径を抑える。URLの漏えい経路（ログ/Referer/キャッシュ）を閉じる。
- WSTG
  - 観点：アクセス制御（IDOR/テナント分離）、情報漏えい（URL/ログ/Referer）、期限と失効、ダウンロード/アップロードの権限境界を検証する。
- PTES
  - 位置づけ：脆弱性分析（設計/運用欠陥）→ 侵害評価（発行APIの認可、漏えい面）→ 報告（期限/配布/ログの要件）。
- MITRE ATT&CK
  - Collection（URL入手）とImpact（漏えい/改ざん）に接続し得る。URLが入手できる現実的経路（ログ/Referer/共有）を前提に評価する。

---

## タイトル
S3 Presigned URL（期限と権限境界）：URLは“権限トークン”なので、漏えい前提で設計する

---

## 目的（このファイルで到達する状態）
- Presigned URLを「一時URL」ではなく、**能力（capability）＝権限そのもの**として境界で扱える。
- 実務で頻出の事故（期限長すぎ、PUT許可、ログ/Referer漏えい、テナント分離不備）を観測→意味→次の一手で所見化できる。

---

## 扱う範囲（本ファイルの守備範囲）
- 期限（被害期間）と権限（GET/PUT、対象キー、条件）
- 発行APIの認可（所有者/テナント/権限）
- 漏えい経路（ログ/Referer/キャッシュ/フロント保存）
※AWS詳細仕様の網羅は目的にしない

---

## 前提：Presigned URLは“見られたら使える”（回収が難しい）
- 一度外部へ出たURLは、期限内なら第三者が利用できる可能性がある
- だから、設計の本体は
  - 期限を短くする（被害期間）
  - 権限を小さくする（被害範囲）
  - 漏えい経路を減らす（入手容易性）
の3点になる

---

## 境界モデル（Presigned URLが破る/守る境界）
- 権限境界：URLが権限を運ぶ（認可をURLに“埋め込む”形になる）
- 信頼境界：URLがブラウザや外部基盤へ出ると“外部”に権限が渡る
- 運用境界：回収が難しいため、短寿命と再発行設計が重要

---

## 観測ポイント（現実で刺さる順）
### 1) 期限（Expires）が業務最小か
- 長いほど漏えい時の被害期間が延びる（回収できない前提で評価）

### 2) 権限の粒度（GET/PUTと対象キー）
- GET：漏えい（閲覧）
- PUT：改ざん（アップロード差し替え、なりすまし）
- 対象キーが推測可能/ユーザ入力で組み立て：テナント境界と衝突しやすい

### 3) 発行APIの認可（ここが本質）
- “署名URLがあるから認可不要”は誤設計
- 発行前に、所有者/テナント/ロール/対象ファイルの妥当性を検証しているか

### 4) 漏えい経路（最も現実的に起きる）
- Referer：外部遷移/外部埋め込みでURLが送られる可能性
- ログ：アクセスログ・分析ログ・エラーログにURL全文が残る
- キャッシュ：ブラウザ/CDNで保持される（Cache-Controlと連動）
- フロント保存：localStorage等で長期化

---

## 結果の意味（この状態なら何が言えるか）
- 期限が長い：漏えい時の被害期間が長い（重大度が上がる）
- PUTが発行される：改ざん方向のリスクが増える（発行認可がより重要）
- URLがログ/Refererに残る：入手容易性が上がり、現実的に悪用されやすい
- 発行APIの認可が弱い：IDOR/テナント分離不備に直結し得る（優先度を上げる）

---

## 攻撃者視点での利用（現実での入手経路）
- ブラウザで拾う（開発者ツール、履歴、共有、画面コピー）
- ログで拾う（分析基盤、エラーログ、APM）
- Refererで拾う（外部遷移や外部埋め込みがあると現実的）

---

## 次に試すこと（仮説A/Bで分岐）
### 仮説A：短寿命・最小権限で設計されている（設計は成立）
- 次の一手
  - 期限切れ時の再発行が安全か（再認可・レート制限・監査）
  - URLをログ/Refererに残さない（マスキング/Referrer-Policy/配布方式）
  - PUTは対象キー固定＋制約（可能なら）で被害範囲をさらに縮める

### 仮説B：期限が長い/配布が雑で漏えい前提に耐えない
- 次の一手
  - 期限短縮を最優先（回収不能の穴埋め）
  - 発行APIの認可を重点検証（所有者/テナント/対象）
  - ログ・Referer・キャッシュの漏えい経路を閉じる要件をセットで出す

---

## 修正（現実で通る要件）
- 期限：業務最小（分単位）＋安全な再発行（監査・レート）
- 権限：GET/PUT分離、対象キー固定、必要なら専用バケット/プレフィックス分離
- 漏えい：ログマスキング、Referrer-Policy、Cache-Control、フロント保存禁止
- 認可：発行前に必ず所有者/テナント/ロールで検証（署名URLは代替しない）

---

## 04_labs（署名URLの被害半径：期限と漏えい経路を再現して判断する）
- 追加候補Lab（例）
  - `04_labs/02_web/06_config/12_s3_presigned_url_boundary/`
- Lab設計要件
  - GET/PUT、期限長短、Referer/ログ混入を再現できる構成
  - 目的：漏えい前提で“期限・権限・漏えい経路”を要件化できること

---

## コマンド/例（例示は最小限：観測と判断を優先）
~~~~
# Presigned URLの評価は3点だけ：
# 1) 期限（被害期間）
# 2) 権限（GET/PUT、対象キーの固定/推測性）
# 3) 漏えい経路（ログ/Referer/キャッシュ/フロント保存）
# そして本質：
# - 発行APIの認可（所有者/テナント/ロール）が正しいか
~~~~

---

## 深掘りリンク（最大8）
- `06_config_05_cache_control_機微レスポンスの境界.md`
- `06_config_08_logging_pii_secret（マスキング_相関）.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_11_secrets_rotation_運用（回収_失効）.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
- `05_input_10_open_redirect（遷移先信頼境界）.md`
