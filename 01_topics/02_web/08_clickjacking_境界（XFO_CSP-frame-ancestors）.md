## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 破れる：UI Redressing（Clickjacking）を「CSRFがあるから大丈夫」「重要操作はPOSTだから大丈夫」と誤認し、**“ユーザ操作を代理実行させる経路”**を放置する。特に、(1) 管理/権限/決済など高影響操作がフレーム内で実行可能、(2) XFO/CSP frame-ancestors の適用がページ/経路/エラーページで抜ける、(3) “埋め込み用途”の例外が広すぎて境界が崩れる、で事故が起きる。
  - 満たす：**「フレームに入れてよいページ」と「絶対に入れてはならないページ」を分離**し、原則 deny（`frame-ancestors 'none'` / `X-Frame-Options: DENY`）をデフォルトにする。例外（埋め込み）を許す場合は、専用画面化・機能縮退・トークン分離・許可親の最小化・監視（違反/異常）を設計要件化する。
- WSTG
  - 観点：クリックジャッキングは「読み取り」ではなく **“ユーザのクリックを被害者セッションで踏ませる”**攻撃。確認は (1) フレーミング可否（XFO / frame-ancestors）、(2) 高影響操作のUI到達性（モーダル/確認/二要素/再認証の有無）、(3) 例外パス（サブドメイン/古い画面/エラー/リダイレクト）を、PoCフレームで観測して成立条件を固める。
- PTES
  - 位置づけ：Vulnerability Analysisで「UI操作が攻撃面になる高影響機能」を抽出し、Exploitationは**最小PoC**（自前HTMLでのiframe）で成立根拠を示す。Reportingは「ヘッダの設計要件」「例外の許容範囲」「運用/監視（逸脱検知）」まで落とす。
- MITRE ATT&CK
  - 目的：ユーザ操作の誘導（ソーシャル/誘導）を起点に、権限操作・設定変更・連携追加・送金/承認等のImpactに繋がり得る。
  - 注意：ATT&CKへの接続は、(a) フレーム可能、(b) ユーザ操作で高影響操作が完遂、(c) 追加の再認証/確認で止まらない、の観測が揃ってから断定する。

---

## タイトル
クリックジャッキング境界（XFO / CSP frame-ancestors）  
“読める/送れる”ではなく「ユーザのクリックを踏ませる」で境界が崩れる領域

---

## 目的（このファイルで到達する状態）
- クリックジャッキングを「CSRFの亜種」や「古い脆弱性」ではなく、**UI Redressing（ユーザ操作の代理実行）**として境界モデル化できる。
- XFO（`X-Frame-Options`）と CSP（`frame-ancestors`）を、互換性・例外設計・適用漏れ（経路/ページ/エッジ）まで含めて観測し、**成立/不成立を言語化**できる。
- “埋め込み（iframe）を要する正当な要件”がある場合でも、例外を安全に作る設計（専用ページ・機能縮退・許可親最小化・監視）へ落とせる。
- 次の一手を分岐できる：
  - A：フレーム不可 → 別経路（XSS/CSRF/認可）へ  
  - B：フレーム可だが重要操作は守られている → 再認証/確認設計の評価へ  
  - C：フレーム可 + 重要操作が完遂 → 高影響として報告・設計是正へ  
  - D：埋め込み例外が広い → 例外境界の縮退・分離へ

---

## 扱う範囲（スコープ）
- 扱う
  - Clickjacking / UI Redressing の成立条件
  - フレーミング制御：`X-Frame-Options` と `Content-Security-Policy: frame-ancestors`
  - 例外（埋め込み要件）を安全に扱う設計
  - 観測（DevTools/プロキシ/簡易PoC）と判断（状態分類）
- 扱わない（接続先）
  - CSRF（トークン/SameSite等）の詳細：`05_input_07_csrf_*`
  - XSSの入口（注入点探索）：`05_input_06_xss_*`
  - セキュリティヘッダ総合（CSP/HSTS等）：`06_config_03_セキュリティヘッダ（CSP_HSTS_Frame_Referrer）.md`
  - 重要操作の再認証（step-up）：`02_authn_16_step-up_再認証境界（重要操作_再確認）.md`
  - 重要操作（承認/送金/権限）の境界：`03_authz_06_privileged_action_重要操作（承認_送金_権限）.md`

---

## クリックジャッキングの本質：SOP/CORSでは止まらない“ユーザ操作の代理実行”
### 1) 何が起きているか（境界の言語化）
- 攻撃者は被害者を攻撃者サイトへ誘導し、そこに **被害者サイトのページをiframeで埋め込む**。
- 被害者は「攻撃者サイト上の見えるボタン」を押したつもりだが、実際には透明化/重ね合わせされた **被害者サイトのUI要素**（送金・承認・設定変更等）をクリックさせられる。
- 重要：攻撃者はレスポンスを“読めない”ことが多い（SOPが守る）  
  しかしクリックジャッキングは「読む必要がない」。**クリックさえ踏ませれば勝ち**になり得る。

### 2) CSRFとの違い（混同が事故を生む）
- CSRF：別オリジンから“送信”して状態変更を狙う（ユーザ操作は必須ではない場合がある）
- Clickjacking：被害者が“正規画面で操作している”状態を偽装し、**被害者自身のクリックで状態変更を完遂**する
- 結果：
  - CSRFトークンがあっても、クリックジャッキングで「正規フォーム送信」や「正規ボタン押下」を踏ませれば回避され得る
  - 「重要操作はPOST」「Referer検査」だけでは止まらないケースがある（ユーザが正規に押しているため）

---

## どこが狙われるか（実務で“あり得る”高影響シナリオ）
クリックジャッキングが“効く”のは、次の特性を持つ操作。
- クリックだけで完遂する（追加の再認証/二要素/手入力確認がない）
- UI要素の位置が安定（オーバーレイで合わせやすい）
- “被害者が押しても不自然でない文脈”に置ける（景品/アンケート/動画再生など）

具体例（典型）：
- アカウント設定
  - メールアドレス変更、パスワード変更開始、2FA無効化、回復コード再発行
- 権限/IAM/管理
  - 管理者追加、ロール付与、APIキー発行、Webhook追加、外部連携（Slack/Jira/IdP）追加
- 金銭/承認
  - 支払い手段追加、送金/振込、承認フローの承認ボタン押下、請求先変更
- 共有/公開
  - “社外共有ON”、公開リンク生成、アクセス権を“公開”へ変更
- OAuth/SSO同意
  - “許可（Allow）”の押下（IdP/RP間の画面で発生しやすい）
  - ※同意画面は特に「ボタン1発」が多く、影響が大きい

---

## 防御の主軸：フレーミング制御（XFO / CSP frame-ancestors）
クリックジャッキング対策の基本は「そもそもフレームに入れさせない」。

### 1) X-Frame-Options（XFO）
- 目的：当該レスポンスを **frame/iframe/object 等に埋め込むことを禁止**する（古典だが依然有効な後方互換枠）
- 代表値
  - `DENY`：すべてのフレーミングを拒否（最も強い）
  - `SAMEORIGIN`：同一originからのフレーミングのみ許可
- 注意点（実務上の落とし穴）
  - `ALLOW-FROM` はブラウザ互換性が弱く、実務では “期待通り動かない” ことがある（許可リスト用途は CSP の frame-ancestors に寄せる）
  - サブドメイン間の埋め込み要件がある場合、SAMEORIGINでは足りない（originが別のため）

### 2) CSP frame-ancestors（推奨：許可親を精密に定義できる）
- 目的：**どの親（ancestor）からのフレーミングを許すか**を宣言する（許可リストが書ける）
- 代表値
  - `frame-ancestors 'none'`：完全拒否（強いデフォルト）
  - `frame-ancestors 'self'`：同一originの親のみ許可
  - `frame-ancestors https://trusted.example.com`：特定の親のみ許可（複数指定可能）
- 実務の要点
  - “埋め込み要件”があるなら **frame-ancestorsを主** にして設計する（XFOは互換性の保険として併用されることが多い）
  - `frame-ancestors` は **metaタグでは指定できない**（HTTPレスポンスヘッダで返す必要がある）
  - `Content-Security-Policy-Report-Only` では **防御にならない**（ブロックせず報告だけ）。clickjacking対策は enforce が必要。

### 3) 併用時の考え方（現実解）
- 現実の運用では、
  - **CSP frame-ancestors：設計の正本（精密・例外制御）**
  - **XFO：後方互換の保険（古いUAや一部環境）**
  の位置づけで “両方返す” ケースが多い。
- 注意：二重ヘッダ（同じヘッダ名が複数回）や、経路による不一致は事故の温床。
  - 例：`X-Frame-Options: SAMEORIGIN` と `X-Frame-Options: DENY` が混在
  - 例：トップページはDENYだが、設定画面だけヘッダが抜ける

---

## “埋め込み例外”の設計：許可するなら、機能を分離し境界を縮退する
フレーミングを完全禁止できない業務（ウィジェット、社内ポータル埋め込み、B2B連携）は実在する。
このときの失敗パターンは「本体UIをそのまま埋め込み許可してしまう」こと。

### 原則（設計ルール）
1) 埋め込みが必要なページは **専用ページ**に切る（本体と同じ設定/管理UIを埋め込ませない）  
2) 埋め込みページは **操作を最小化**し、状態変更を原則禁止（表示中心）  
3) 親を allowlist で最小化（`frame-ancestors` の許可先を限定）  
4) 必要なら “埋め込み専用トークン” を別系統にする（通常セッションと分離）  
5) 重要操作はフレーム外へエスカレーション（トップレベル遷移 + 再認証）

### よくある安全設計の型
- 埋め込みは “閲覧専用ダッシュボード” のみ許可
- 状態変更は「別タブで開く」導線にし、そこで再認証/確認（step-up）を必須化
- 埋め込み先ドメインを社内ポータル等に限定し、委託先/外部CMS/ブログなど“乗っ取られ得る親”を許可しない
- 埋め込みページは `XFO/CSP` だけでなく UI 側でも `window.top === window.self` を確認し、トップでない場合は縮退表示（※フレームバスティング単体は防御にならないが、縮退の補助には使える）

---

## 観測ポイント（診断で“成立条件”を確定する）
### 1) まず“フレームに入るか”を確認する（入口判定）
- 対象ページ（高影響ページを優先）
  - アカウント設定、権限管理、支払い、連携、承認、OAuth同意画面 等
- 期待する防御
  - XFO：`DENY` or `SAMEORIGIN`
  - CSP：`frame-ancestors 'none'`（理想）または必要最小の allowlist
- 確認方法（観測中心）
  - DevTools Networkでレスポンスヘッダを確認
  - 実際に iframe で埋め込んだときの挙動（表示される/拒否される/一部だけ表示される）
  - エッジ（CDN/WAF）経由とオリジン直（可能なら）で差分がないか

### 2) “適用漏れ”を潰す（最も多い事故要因）
クリックジャッキングは「1ページでもヘッダが抜ける」と成立する。
よく抜けるポイント：
- SPA/ルーティングで返すHTMLの経路が複数（`/settings` と `/app/settings` 等）で、片方だけヘッダが無い
- 例外ページ
  - エラーページ（403/404/500）
  - ログアウト完了ページ
  - メールリンクから到達する確認ページ
  - 旧UI（/legacy/*）
- リダイレクトチェーン（302/307）
  - 中間レスポンスのヘッダだけ見て「OK」と誤判定しやすい  
  - 最終HTMLにヘッダが載っているか、iframe表示が最終的に拒否されるかで確定する

### 3) “高影響操作がクリックだけで完遂するか”を確認する（本体判定）
- フレームに入るだけでは脆弱性の影響が弱い場合がある。
- 次を観測して、影響の強さを決める：
  - クリック1回で完遂か（確認モーダル/手入力/再認証があるか）
  - 重要操作に step-up が入るか（パスワード再入力、OTP、WebAuthn 等）
  - UI要素が画面上で安定しているか（毎回配置が変わるなら難易度が上がる）
- 結論の言語化例
  - 「フレーミング可能だが、重要操作は再認証（step-up）により完遂困難」  
  - 「フレーミング可能かつ、承認/変更がクリックのみで完遂し得るため高影響」

### 4) ログ/検知の観点（“攻撃されている兆候”を残せるか）
- サーバ側で観測できること（環境依存）
  - `Sec-Fetch-Dest: iframe`（iframe読み込みの兆候）
  - `Sec-Fetch-Site: cross-site`（クロスサイト埋め込みの兆候）
  - `Referer`（攻撃者サイトが出る可能性。ただしReferrer-Policyで出ない/削られる）
- ポイント：clickjackingは“成功してもエラーにならない”ため、成功イベントログ（重要操作ログ）とセットで追う必要がある。

---

## PoC（最小）：“成立/不成立”の証跡化（やり過ぎない）
目的は「攻撃手順の提供」ではなく、**ヘッダ不備と影響の成立を最小で示す**こと。
- 自組織/許可された対象に限定して検証する。
- 画面キャプチャ（iframeで表示できている事実）＋レスポンスヘッダ（XFO/CSP欠落）を証跡にする。

~~~~
<!-- 最小PoC：対象ページがiframeに入るか確認するだけ -->
<!doctype html>
<html>
  <head><meta charset="utf-8"><title>frame test</title></head>
  <body>
    <h1>Frame Test (Authorized Only)</h1>
    <iframe src="https://target.example.com/settings" style="width:1200px;height:800px;border:1px solid #ccc"></iframe>
  </body>
</html>
~~~~

（影響評価が必要な場合のみ）クリック誘導の概念検証：
- “透明iframe + ダミーUI”のような形で、どの程度ユーザ操作を誘導できるかを示す  
- ただし、報告では「実害（何が変更できるか）」に重心を置き、PoCは最小限に留める

---

## 結果の意味（状態分類：何が言える / 次に何を見る）
### 状態A：フレーム不可（XFO/CSPで拒否される）
- 言える：clickjackingの主要経路は抑止されている可能性が高い
- 次の一手：他の境界（CSRF/認可/XSS）へ優先度を移す  
  - ただし“例外ページ”だけ抜けていないか（エラー/旧UI/特定パス）を最低限確認

### 状態B：フレーム可だが重要操作は再認証/手入力/確認で止まる
- 言える：フレーミング制御は不足だが、影響は限定される可能性
- 次の一手：
  - どの操作が「クリックだけで完遂」かを棚卸しし、重要操作だけでも frame-ancestors 'none' に寄せられるか検討
  - 再認証が“例外パス”でバイパスできないか（古い画面/モバイル専用等）を確認

### 状態C：フレーム可 + 重要操作がクリックのみで完遂（高影響）
- 言える：クリックジャッキングが実害に繋がる成立条件が揃っている
- 次の一手（報告/対策要件）：
  - 原則 deny（`frame-ancestors 'none'` / `XFO: DENY`）を適用し、例外が必要なら専用ページ化で縮退
  - 重要操作には step-up を追加（万一の残存リスク低減）
  - 監視（重要操作ログ + sec-fetch 兆候）を合わせて提案

### 状態D：埋め込み例外が広い（allowlistが広すぎる/外部SaaSやサブドメインを広範に許可）
- 言える：例外が境界を壊している可能性（“親”が乗っ取られたら成立）
- 次の一手：
  - allowlist を「管理主体が強い親」に限定
  - 埋め込み対象の機能を縮退し、本体UIを埋め込ませない
  - 親子通信（postMessage）を使うなら origin 検証と最小権限で設計し直す

---

## 設計・運用のチェックリスト（実務で効く順）
### 1) デフォルト方針
- 原則：アプリのHTMLは `frame-ancestors 'none'`（または少なくとも重要操作系は 'none'）
- 互換性：必要に応じて `X-Frame-Options: DENY` を併用
- 例外：埋め込みが必要なページのみ allowlist（`frame-ancestors https://portal.example.com` 等）

### 2) 適用範囲
- 全HTML（特に重要操作/設定/管理/承認/OAuth同意）
- エラーページや旧UIも含めて統一（「抜け」が最悪）
- リダイレクト最終到達点のHTMLで確定する

### 3) 例外設計
- 埋め込み専用ページの機能縮退（閲覧中心）
- 本体セッションと埋め込みセッションを分離（可能なら）
- 重要操作はトップレベル遷移 + 再認証

### 4) 監視
- 重要操作ログを必ず残す（誰が何を変更したか）
- 可能なら `Sec-Fetch-Dest: iframe` / `Sec-Fetch-Site: cross-site` を補助シグナルにする
- CSP report-only はclickjacking防御にはならないが、導入過程の逸脱検知には使える（ただし最終は enforce）

---

## 04_labs（検証環境で再現して“境界”を腹落ちさせる）
- Lab候補（例）
  - `04_labs/02_web/08_clickjacking_01_xfo_vs_frame_ancestors_matrix/`
  - `04_labs/02_web/08_clickjacking_02_exception_design_embed_only_pages/`
- Lab設計要件
  - 2つのサイト（attacker / target）を用意し、同一origin / 別originのiframeで挙動差を観測できる
  - XFO（DENY/SAMEORIGIN）と CSP frame-ancestors（none/self/allowlist）を切替可能にする
  - “重要操作ページ”と“閲覧ページ”を分け、例外設計（埋め込み専用）に落とせることを確認する
  - 証跡：レスポンスヘッダ＋iframe表示結果＋重要操作ログ（どこまで完遂できたか）

---

## コマンド/例（例示は最小限：観測と判断を優先）
~~~~
# ポイント：
# - clickjackingは「フレームに入るか（XFO / frame-ancestors）」が入口判定
# - 次に「重要操作がクリックだけで完遂するか（step-up/確認/手入力）」で影響判定
# - 防御は原則deny、例外は専用ページ化・機能縮退・許可親最小化で設計する
~~~~

---

## 深掘りリンク（最大8）
- `01_topics/02_web/07_browser_security_境界（SOP_CORS_CSP）.md`
- `01_topics/02_web/06_config_03_セキュリティヘッダ（CSP_HSTS_Frame_Referrer）.md`
- `01_topics/02_web/05_input_07_csrf_01_token（synchronizer_double_submit）.md`
- `01_topics/02_web/05_input_07_csrf_02_samesite（cookie_credential）.md`
- `01_topics/02_web/03_authz_06_privileged_action_重要操作（承認_送金_権限）.md`
- `01_topics/02_web/02_authn_16_step-up_再認証境界（重要操作_再確認）.md`
- `01_topics/02_web/02_authn_01_cookie属性と境界（Secure_HttpOnly_SameSite_Path_Domain）.md`
- `01_topics/02_web/04_api_04_webhook_受信側の信頼境界（署名_再送）.md`
