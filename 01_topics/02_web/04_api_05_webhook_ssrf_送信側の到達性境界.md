## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - この技術で満たす/破れる点：外部通信の信頼境界（送信先URLの制御）、SSRF対策（到達性の制限・正規化・リダイレクト制御）、認証情報の保護（メタデータ/内部サービスへのアクセス防止）、監査（送信先と結果）、濫用耐性（連打・長時間接続・巨大レスポンス）
  - 支える前提：Webhook送信は「サーバが外へHTTPを出す」機能であり、送信先がユーザ入力になるとSSRF（内部到達/メタデータ/横展開）の典型入口になる。さらに“再送”や“非同期処理”と組み合わさると、検知・停止が遅れやすい。
- WSTG：
  - 該当テスト観点：Server-Side Request Forgery（SSRF）、API Testing（送信先URL、リダイレクト、DNS、エラー差分）、Authorization Testing（誰が送信先を登録/変更できるか：運用権限境界）
  - どの観測に対応するか：送信先登録→送信実行（イベント発火）という2段の設計を、「URL正規化」「allowlist」「DNS解決」「リダイレクト」「プロキシ/解決経路」「レスポンス取り扱い（保存/表示）」で分解し、到達性境界が成立しているかを低侵襲に確定する
- PTES：
  - 該当フェーズ：Information Gathering（送信機能の発見：Webhook設定UI/API、送信ログ）、Vulnerability Analysis（SSRF成立条件：到達先・経路・認証情報漏洩）、Exploitation（最小差分で確定：到達性の有無、リダイレクト/DNSによるバイパス可能性）
  - 前後フェーズとの繋がり（1行）：04（受信側）で扱った“外部イベントの信頼”と対に、05は“内部から外部へ出る通信の到達性”を詰める。06（idempotency）と07（async job）により送信が増殖/遅延するため、境界の堅牢性が実務上さらに重要になる
- MITRE ATT&CK：
  - 戦術：Discovery / Lateral Movement / Collection
  - 目的：内部サービス/メタデータの探索（Discovery）、内部への横移動補助（Lateral Movement）、機密情報（クラウド資格情報等）の収集（Collection）。Webhook SSRFは“外向き機能”を“内向き到達”に反転させる。

## タイトル
webhook_ssrf_送信側の到達性境界

## 目的（この技術で到達する状態）
- Webhook送信（送信先URL登録型）をSSRFの観点で、(1)入力（URL）信頼境界、(2)到達性の制限（allowlist/ネットワーク/プロキシ）、(3)URL正規化とパーサ差、(4)DNS解決と再解決、(5)リダイレクト、(6)HTTPクライアントの挙動（ヘッダ/認証/タイムアウト）、(7)レスポンスの扱い（ログ/表示/保存）、(8)監査と濫用耐性、に分解して評価できる
- ペネトレとして、危険な到達（内部IP/メタデータ）を“実害を出さずに”成立条件として示し、是正（設計/実装/ネットワーク）に落とせる
- “URL allowlistだけで終わり”の不十分さ（DNS/リダイレクト/正規化で迂回）を、実務で起きる形で説明できる

## 前提（対象・範囲・想定）
- 対象：Webhookの送信先URLをユーザ/テナント管理者が登録できる機能
  - 例：通知先URL、イベント購読URL、連携URL、カスタムコールバック
- 典型構成（現実的）
  - 管理UI/APIでURL登録 → イベント発火でサーバがHTTP送信
  - 非同期ジョブ（キュー/ワーカー）から送信される（07）
  - 再送（失敗時リトライ）がある（04/06）
  - 送信ログ（成功/失敗、ステータス、レスポンス断片）が管理画面で見られる場合がある（情報漏洩に接続）
- 重要な前提
  - SSRFは「内部到達」だけでなく「外部向けの権限濫用（プロキシ化）」「情報収集」「DoS」も含む
  - クラウド環境ではメタデータサービス（IMDS等）が最重要到達先になり得る（ただし実行を煽らず“境界設計”として扱う）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 入口の権限境界：誰がURLを登録/変更できるか（AuthZ接続）
Webhook URLの登録権限が広いほどリスクが高い。
- 観測で確定したい点
  - URL登録/編集/削除は誰ができるか（一般ユーザ/tenant admin/ops）
  - “検証用のテスト送信”ボタンがあるか（即時にSSRFが実行され得る）
  - URLが複数登録可能か（濫用/分散）
  - 監査（誰がいつ変更したか）があるか（否認防止）

### 2) URL入力の信頼境界：許容スキーム・ホスト・ポート
- 許容すべき/すべきでない（実務の推奨）
  - 許容：https（原則）、http（要件次第で限定）
  - 原則拒否：file://, gopher://, ftp://, dict://, ldap:// 等の非HTTPスキーム
  - ポート：443/80等に限定、または明示allowlist
- 観測で確定したい点
  - スキームのallowlistがあるか
  - ポート指定が許されるか、許される場合は制限があるか
  - URLにユーザ情報（user:pass@host）が許されるか（危険：パーサ差・ログ漏洩）

### 3) URL正規化：パーサ差分がSSRF迂回の温床
URL検証は「文字列検査」ではなく「正規化後の構造」で行う必要がある。
- 実務で問題になる差分
  - 大文字小文字、末尾ドット、IDN（punycode）
  - IPv4表記の揺れ（10進/8進/16進/整数表現）
  - IPv6（[]）とIPv4-mapped
  - @（userinfo）や#（fragment）、複数スラッシュ、エンコード（%2f等）
- 観測で確定したい点（成立条件として）
  - バリデーションが“正規化後のhost”で行われるか（文字列一致だけではないか）
  - 登録時と送信時で同じ正規化ロジックか（ドリフトがないか）

### 4) allowlist設計：ドメイン一致だけでは足りない（現実の落とし穴）
- 実運用のallowlistの型
  - ドメイン allowlist（*.example.com）
  - 完全一致 allowlist（webhook.partner.com）
  - パスまで固定（/webhooks/tenantA/...）※パス固定は誤用も多い
  - IP/ASN allowlist（危険：運用負荷が高いが、内部遮断には効く）
- よくある失敗
  - サブドメイン制御の誤り（evil.example.com を許す/逆に拒否漏れ）
  - “末尾一致”のみで許可（notexample.com が通る）
  - allowlistは登録時だけで、送信時は未検証（再送で抜ける）
- 観測で確定したい点
  - allowlistが登録時/送信時の両方に適用されるか
  - サブドメイン許可のルールが意図通りか（境界の明文化）

### 5) DNS解決：DNSリバインド/再解決で内部到達に反転する
Webhook送信は、DNSが関与するだけで“後から内側へ”切り替わる余地がある。
- 現実の攻撃成立条件（設計として理解）
  - 登録時に外部IP、送信時に内部IPへ解決が変わる（TTL・再解決）
  - CNAMEチェーンやDNSの揺れで検証と実解決がズレる
- 防御（実務で採用される）
  - 送信時に毎回DNS解決し、解決結果が“許容レンジ”か検査（重要）
  - 解決結果がプライベート/リンクローカル等なら拒否（ネットワーク境界）
  - 可能なら固定のアウトバウンドプロキシ/egress制御で物理的に遮断
- 観測で確定したい点
  - 登録時だけでなく送信時にもDNS/到達性チェックがあるか
  - DNS解決結果の検査（privateレンジ拒否）があるか（根拠は挙動）

### 6) リダイレクト：allowlistを“外側”で満たして“内側”へ飛ばす
- 典型リダイレクト問題
  - allowlistされた外部ドメインに一旦行き、302で内部IPへ（追従するとSSRF）
  - 複数回リダイレクトで最終到達が変わる
  - http→https/https→http の降格
- 防御（実務推奨）
  - リダイレクトは原則拒否、または同一ホスト/同一スキームのみ許可
  - 最大回数制限
  - リダイレクト先も同じ検証（allowlist + private拒否）を適用
- 観測で確定したい点
  - リダイレクト追従の有無
  - 追従する場合、最終URLにも検証が適用されるか

### 7) HTTPクライアントの挙動：到達できても“何を持って行くか”がリスク
- 観測の軸
  - 送信時ヘッダ：User-Agent、Authorization、Cookie、内部トークン（持って行ってはいけない）
  - mTLSクライアント証明書の誤用（外部に提示しない設計）
  - プロキシ設定：環境変数/NO_PROXYの影響（内部へ抜ける）
  - タイムアウト：接続/読み取りの上限（ハングでワーカー枯渇）
  - レスポンスサイズ上限：巨大レスポンスでメモリ/ストレージ圧迫
- 観測で確定したい点（実務的）
  - 送信に“内部認証情報”が付与されていないか
  - タイムアウト/サイズ制限があるか
  - HTTPメソッドが制限されているか（GET/POSTのみ等）

### 8) レスポンスの取り扱い：ログ/管理画面表示が漏洩経路になる
Webhook送信の結果をUIに表示する設計は多い。
- 危険
  - レスポンス本文を管理画面に表示（内部到達できると情報持ち帰り）
  - エラーメッセージに内部URL/解決IP/スタックが出る（04_api_09へ）
- 観測で確定したい点
  - 成功/失敗時にどこまで記録・表示されるか（本文/ヘッダ/一部のみ）
  - その閲覧権限（tenant adminだけか、一般ユーザにも見えるか）

### 9) リトライ/再送と非同期（06/07）：SSRFが“増殖”する設計リスク
- 実務で起きること
  - 失敗すると指数バックオフで多数回リトライ
  - キューに溜まり、停止までに大量送信が続く
- 防御（実務）
  - 送信先検証の失敗は“即座に停止”し、再送しない（4xx扱い）
  - 設定変更時に“保留/無効化”できる運用機構
  - リトライ上限とDLQ（隔離）
- 観測で確定したい点
  - “到達性/検証失敗”が再送対象になっていないか（止まるか）
  - 送信先変更が即時に反映されるか（古いURLへ送信が継続しないか）

### 10) webhook_sender_reachability_boundary_key（正規化キー：後続へ渡す）
- 推奨キー：webhook_sender_reachability_boundary_key
  - webhook_sender_reachability_boundary_key =
    <url_controls>(strict_allowlist|domain_allowlist|none|unknown)
    + <scheme_port_controls>(strict|partial|none|unknown)
    + <normalization>(robust|string_check|unknown)
    + <dns_controls>(checked_each_send|checked_on_register|none|unknown)
    + <private_range_block>(yes/no/unknown)
    + <redirect_policy>(none|same_origin_only|follows_unchecked|unknown)
    + <egress_controls>(proxy_enforced|net_acl|none|unknown)
    + <client_behavior_controls>(timeouts|size_cap|no_credentials|mixed|none|unknown)
    + <response_handling_risk>(low|medium|high|unknown)
    + <retry_safety>(safe_stop|unsafe_retry|unknown)
    + <audit_strength>(strong|partial|weak|unknown)
    + <confidence>
- 記録の最小フィールド（推奨）
  - 登録可能なURLの仕様（scheme/port）
  - allowlistルール
  - リダイレクト追従の有無
  - DNS/私設レンジ拒否の有無（挙動根拠）
  - レスポンス保存/表示の有無
  - リトライ挙動（止まる/増殖）
  - evidence（設定画面、送信ログ、エラー断片、HAR）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（確定できる）：
  - 送信先URLがどの程度制御されているか（scheme/port/allowlist）
  - 正規化・DNS・リダイレクトといった“迂回面”に防御があるか
  - 私設レンジ/リンクローカル等の内部到達を物理/論理に遮断しているか
  - 送信時に内部認証情報を付与していないか、タイムアウト/サイズ制限があるか
  - レスポンスを持ち帰れる設計か（漏洩経路）
  - リトライが安全（止まる）か危険（増殖）か
- 推定（根拠付きで言える）：
  - allowlistが弱い/迂回面が未対策の場合、SSRF成立が現実的
  - レスポンス表示がある場合、到達性がそのまま情報持ち帰りに直結する
- 言えない（この段階では断定しない）：
  - 内部ネットワークの全到達範囲（環境依存）。ただし“privateレンジ拒否/egress制御”の有無は境界として評価できる。

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- 優先度（P0/P1/P2）
  - P0：
    - allowlist無し、または正規化/リダイレクト/DNSで容易に迂回できる
    - 私設レンジ/リンクローカル/メタデータ相当への到達を遮断していない兆候
    - レスポンス本文が管理画面で閲覧でき、情報持ち帰りが可能
    - 送信時に内部認証情報（Authorization等）を付与してしまう
  - P1：
    - allowlistはあるが登録時のみで、送信時検証が弱い（DNS変動で抜ける）
    - タイムアウト/サイズ制限がなく、ワーカー枯渇（可用性）に繋がる
    - リトライが過剰で、停止までに送信が増殖する
  - P2：
    - 境界は堅牢だが監査が弱く、悪用/誤設定の調査が難しい
- “成立条件”としての整理（技術者が直すべき対象）
  - URLは構造として正規化し、scheme/port/hostを厳格allowlist
  - DNS解決は送信時にも検査し、private/リンクローカル等を拒否
  - リダイレクトは原則拒否、許可するなら最終先も同様に検証
  - 物理的なegress制御（プロキシ/ACL）で“内部への到達”を遮断（アプリ単体に依存しない）
  - HTTPクライアントは no-credentials、短いタイムアウト、サイズ上限
  - 送信ログ/レスポンス保存は最小限、機微を表示しない（必要ならマスク）
  - 検証失敗は再送しない（unsafe retryを避ける）

## 次に試すこと（仮説A/Bの分岐と検証：実害を出さずに成立条件を確定）
- 仮説A：allowlist/正規化が弱い
  - 次の検証（差分）：
    - “許可されるはずのURL”と“拒否されるべき形状（スキーム/ポート/表記揺れ）”で登録可否の差分を観測
  - 判断：
    - 危険形状が登録可能：P0〜P1
- 仮説B：リダイレクト追従で迂回できる
  - 次の検証（差分）：
    - 外部許可先→別ホストへのリダイレクトで、送信が成功扱いになるか（追従の兆候）を観測（低侵襲）
  - 判断：
    - 追従＋未検証：P0
- 仮説C：DNS変動で迂回できる（送信時検証が無い）
  - 次の検証（差分）：
    - 登録時と送信時で解決結果が変わる前提の防御有無を、挙動/ログ（解決IP記録の有無）で推定
  - 判断：
    - 送信時検証無し：P1（環境次第でP0）
- 仮説D：レスポンス持ち帰りが可能（漏洩経路）
  - 次の検証（差分）：
    - 送信ログ/管理画面に“レスポンス断片”が表示されるか（表示範囲と権限）を観測
  - 判断：
    - 本文表示＋権限広い：P0〜P1
- 仮説E：リトライが増殖し、停止が難しい
  - 次の検証（差分）：
    - 送信失敗時のリトライ回数/間隔の手掛かり（attempt/queued）をログ/UIから観測
  - 判断：
    - unsafe retry：P1（可用性/費用リスク）

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - `04_labs/02_web/04_api/05_webhook_sender_ssrf_reachability/`
    - 構成案（現実運用の再現）
      - URL登録UI/API（tenant adminのみ）
      - 送信：非同期ワーカー＋リトライ（指数バックオフ）＋DLQ
      - 防御切替：allowlist（strict/loose/none）、正規化（robust/string）、DNS送信時検査（on/off）、private拒否（on/off）、redirect（follow/deny）、egress（proxy/none）
      - 送信ログ：成功/失敗、最終URL、解決IP（必要なら）、trace_id
      - レスポンス扱い：保存/非保存/先頭Nバイトのみ 等を比較
- 取得する証跡（深掘り向け：HTTP＋周辺ログ）
  - 登録時のバリデーション結果（許可/拒否と理由）
  - 送信ログ（最終URL、redirect回数、失敗理由、attempt_count）
  - ワーカーのタイムアウト/サイズ制限の挙動
  - 監査（誰がURLを設定変更したか）
  - 可能ならネットワーク側（プロキシログ）で到達先が遮断されている根拠

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# URL登録（擬似）
POST /api/webhooks
{ "url": "https://hooks.partner.example/webhook" }

# テスト送信（擬似）
POST /api/webhooks/{id}/test

# 観測すること（擬似）
- 許容スキーム/ポートが限定されているか
- リダイレクトを追従するか（追従するなら最終先も検証されるか）
- DNS解決や私設レンジ拒否が送信時に働くか（挙動/ログで推定）
- レスポンス本文をUI/ログで持ち帰れないか
- 失敗時にunsafe retryで送信が増殖しないか
~~~~
- この例で観測していること：
  - “到達性境界”がアプリ・DNS・ネットワークで多層に成立しているか（allowlistだけで終わっていないか）
- 出力のどこを見るか（注目点）：
  - normalization、dns_controls、private_range_block、redirect_policy、egress_controls、response_handling_risk、retry_safety
- この例が使えないケース（前提が崩れるケース）：
  - 送信先が固定（ユーザ入力なし）の場合：SSRFではなく“送信内容の漏洩（機微データ）”と“再送/署名”へ評価軸を移す

## 参考（必要最小限）
- OWASP ASVS（SSRF、外部通信の制御、監査）
- OWASP WSTG（SSRF Testing、API境界）
- PTES（成立条件の証跡化：到達性・迂回面・ログ）
- MITRE ATT&CK（Discovery/Collection：内部到達で情報収集）

## リポジトリ内リンク（最大3つまで）
- `01_topics/02_web/04_api_04_webhook_受信側の信頼境界（署名_再送）.md`
- `01_topics/02_web/04_api_06_idempotency_レースと二重実行境界.md`
- `01_topics/02_web/04_api_07_async_job_権限伝播（キュー_ワーカー）.md`

## 次（04_api_06 以降）に進む前に確認したいこと（必要なら回答）
- 04_api_06（idempotency）では、Webhook再送・非同期処理・状態遷移/課金に直結する“二重実行境界”を、キー設計（idempotency-key、イベントID、ユニーク制約）、原子性、アウトボックス等まで踏み込んで最大限詳しく扱う
