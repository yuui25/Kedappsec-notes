<<<BEGIN>>>
# 01_web_recon_入口・境界・攻め筋の確定.md

## 目的（この技術で到達する状態）
- Webアプリの「入口・境界・攻め筋」を、ツール操作ではなく **観測→解釈→優先度付け** で確定できる。
- ASM/OSINT（DNS/TLS/HTTP）で得た外形情報を、Webペネトレで使える形（認証/認可/API/入力/設定の検証計画）に落とし込める。
- “何となく触る”をやめ、**どこを深掘りすべきか** を自分で説明できる（再現条件・境界モデル付き）。

## 前提（対象・範囲・想定）
- 対象：許可された範囲のWebアプリ/ドメイン/環境のみ。
- 想定：SSO/MFA、CDN/WAF、SPA+API、マイクロサービス、SaaS連携（IdP/ログ基盤/通知/決済等）が一般的。
- やらないこと：大量アクセスや無差別列挙を前提にしない（最小観測で意思決定する）。
- 依存（前段の接続）：
  - `01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`
  - `01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`

## このステップで確定するもの（成果物）
- 入口一覧（分類付き）
  - 公開（未ログインで到達） / 認証入口（SSO/ログイン） / 管理入口 / API入口 / ファイル配信 / Webhook等
- 境界モデル（最低限）
  - 認証境界（どこで本人性が決まるか）
  - 認可境界（どこで権限が判定されるか：テナント/ロール/オブジェクト）
  - 信頼境界（CDN/WAF/IdP/SaaS/外部APIなどの越境点）
- 攻め筋候補（優先度付き）
  - 認証/セッション、認可（IDOR/BOLA/BFLA）、API入力、設定/外部連携、キャッシュ/ヘッダ条件差 など
- 観測の最小証跡
  - HAR + Proxyログ + 検証メモ（視点/条件/差分）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 入口（Entry）の観測
- 画面入口：ルーティング（SPA含む）、初期ロード、ログイン誘導、エラー画面
- API入口：ホスト分離（api. 等）、パス規則（/api/v1 等）、Content-Type、エラーの型
- 付随入口：ファイル配信、画像/JS、WebSocket、Webhook受信、外部リダイレクト

### 2) 認証境界（AuthN）の観測
- どこでログインが成立するか（IdP/アプリ、Cookie/トークンの発行点）
- SSOの流れ（リダイレクト先ドメイン、state/nonce等の存在、セッション開始点）
- セッション属性（Secure/HttpOnly/SameSite、ドメイン/パス、更新/失効）

### 3) 認可境界（AuthZ）の観測（この段階では“モデル化”が主）
- テナント境界：URL/ヘッダ/トークン/サブドメインのどれで切り替わるか
- ロール境界：UI表示差だけでなく、API応答差（401/403/200）で境界を観測
- オブジェクト境界：ID（uuid/連番）がどこで渡り、どこで判定されるか（推定）

### 4) 外部依存と終端（CDN/WAF/SaaS等）の観測
- DNS/TLS/HTTPから見える終端の可能性（断定せず突合）
- 依存の越境点（別ドメイン、別Cookieスコープ、別認証主体、別ログ基盤等）

### 5) 条件差（“同じURLでも結果が変わる条件”）の観測
- 未ログイン/ログイン、ロール差、テナント差
- User-Agent/Accept/Origin/Referer差
- キャッシュ差（ETag/Vary/Age等）
- ネットワーク視点差（必要時：別経路で差分が出るか）

## 結果の意味（この観測で何が言える/言えない）
- 言える（確定できる）
  - 入口の分類（公開/認証/管理/API等）と、入口の経路（どのドメイン/パスで成立するか）
  - 認証の“開始点/成立点”の候補（どこでCookie/トークンが発行されるか）
  - APIの存在と分離形態（同一ドメイン/別ドメイン、CORSの有無など）
- 推定（追加観測で強くなる）
  - 認可境界の実装位置（フロント/ゲートウェイ/サービス内）と境界の種類（テナント/ロール/オブジェクト）
  - 外部依存の比率と越境点の多さ（運用複雑性の指標）
- 言えない（この段階の限界）
  - “脆弱”の断定（特に認可は、検証が必要）
  - オリジンの断定（CDN/WAF配下ではHTTP観測だけで決めない）
  - 未ログイン観測だけでの結論（認証後観測が必要な領域が多い）

## 攻撃者視点での利用（意思決定：優先度・攻め筋）
- 入口の分類から、最初の深掘り順を決める
  - 例：認証入口→セッション成立→主要機能のAPI→オブジェクト境界→設定/外部連携
- 境界モデルから、検証が“効く”仮説を作る
  - テナント境界がURL/ヘッダ/トークンのどれで決まるか
  - ロール境界がUIだけか、APIで強制されているか
  - オブジェクトIDがどこで渡り、どこで参照されているか
- 条件差観測で、検証の変数を最小化する（環境差で迷子にならない）

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：入口がSSO中心で、認証境界が外部（IdP）にある
  - 次の検証：
    - 認証フローの成立条件を観測（リダイレクト、Cookie/トークン発行点、SameSite等）
    - 認証後に見えるAPI呼び出しをProxyでトレースし、境界モデルを更新する
  - 期待する観測：
    - “どこで本人性が決まるか”が説明でき、次の `authn` / `authz` 検証に繋がる
- 仮説B：SPA+APIで、認可境界がAPI側にありそう
  - 次の検証：
    - 代表機能のAPIを1つ選び、未ログイン/ログイン/ロール差で応答差を観測する
    - オブジェクトIDの受け渡し箇所（URL/Body/GraphQL等）を特定する
  - 期待する観測：
    - “どの境界で守られているか”の仮説が立ち、IDOR/BOLA検証が最短距離になる
- 仮説C：CDN/WAF配下で、観測が視点依存（同じ操作でも結果が変わる）
  - 次の検証：
    - DNS/TLS/HTTPの突合で終端境界を整理し、観測点（Proxy/HAR）を固定する
    - 条件差（UA/ヘッダ/Cookie）を最小セットで試し、差分が出る条件を特定する
  - 期待する観測：
    - “どの条件で変わるか”が説明でき、無駄な試行錯誤が減る

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 最小の証跡取得（Done条件に直結）
  - 入口1つ（例：トップ/ログイン）について HAR + Proxyログ + メモ を取得
  - 条件差1セット（未ログイン→ログイン後）で同じ操作を再取得
  - メモに「視点（端末/経路/条件）」を必ず残す

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 例：入口の外形（ステータス/リダイレクト）を最小観測
curl -i https://example.com/
curl -i -L https://example.com/login

# 例：API入口の兆候（CORS/Content-Type）を最小観測
curl -i https://api.example.com/
curl -i -H "Origin: https://example.com" https://api.example.com/endpoint
~~~~
- この例で観測していること
  - 入口の種類（公開/認証誘導/API）と、境界の手掛かり（リダイレクト/CORS）
- 出力のどこを見るか
  - ステータス/Location：認証境界の入口
  - Content-Type：APIらしさ（JSON等）
  - Access-Control-*：ブラウザ利用前提のAPI境界
- 前提が崩れるケース
  - JS必須でcurlだけでは入口が再現できない（その場合はブラウザ+HAR/Proxyへ切替）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - 入口と境界（認証/セッション、認可、API、設定/外部依存）を整理し、以後の検証を“当てる”ための前提づくり。
- WSTG：
  - Information Gathering をWebペネトレ実務に変換する段（入口確定→認証→認可→APIへ繋ぐ）。
- PTES：
  - Intelligence Gathering の成果を、Vulnerability Analysis の優先度付けに直結させる（攻め筋の合理化）。
- MITRE ATT&CK：
  - Reconnaissance / Discovery の観点を、検証側の意思決定（入口・境界・依存の把握）に落とす。

## 次に作るべきtopics（推奨順）
1) `01_topics/02_web/02_authn_認証・セッション・トークン.md`  
2) `01_topics/02_web/03_authz_認可（IDOR/BOLA/BFLA）境界モデル化.md`  
3) `01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 関連 topics：`01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`

---


<<<END>>>
