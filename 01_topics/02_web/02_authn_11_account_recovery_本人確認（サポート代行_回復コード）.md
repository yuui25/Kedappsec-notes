## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：Authentication / Session Management / Access Control（回復フローは「認証の例外経路」になりやすい）
  - 該当要件（可能ならID）：（後でASVS版を固定してID付与）
  - このファイルの内容が「満たす/破れる」ポイント：回復トークンの設計、本人確認の強度、例外パス（サポート代行）での権限境界崩壊、ユーザ列挙・レート制御
- WSTG：
  - 該当カテゴリ/テスト観点：Authentication Testing（Password Reset / Account Recovery / User Enumeration / Rate Limit）
  - 該当が薄い場合：この技術が支える前提：認証境界の特定、例外パスの攻撃面抽出、到達性推定
- PTES：
  - 該当フェーズ：Intelligence Gathering / Vulnerability Analysis（回復導線の面抽出→成立条件の切り分け→最小検証）
  - 前後フェーズとの繋がり（1行）：回復導線で得た境界情報は、後続の brute force / CSRF / session / step-up の優先度決定に直結する
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Credential Access / Initial Access / Persistence（Account Manipulation を含む文脈）
  - 攻撃者の目的（この技術が支える意図）：正規の回復導線を悪用してアカウント奪取（ATO）を成立させる、検知されにくい経路で権限を再取得する

## タイトル
account_recovery_本人確認（サポート代行_回復コード）

## 目的（この技術で到達する状態）
- アカウント回復（パスワード再設定、回復コード、サポート代行）を「認証の例外パス」として扱い、境界（資産/信頼/権限）を崩す最短経路になっていないかを判断できる
- 回復フローの成立条件（何が揃うと回復が完了するか）を、HTTP観測＋関連ログ（メール/SMS/サポートCRM）で説明できる
- テストの手数を増やさずに（低アクティブ前提でも）、ユーザ列挙・トークン設計不備・本人確認強度不足・運用例外（サポート代行）を優先度付きで切り分けられる
- 後続（bruteforce/rate-limit、login CSRF、logout、同時ログイン、step-up、refresh rotation、token binding、passkeys、magic-link）へ「どこを重点的に見るべきか」を渡せる

## 前提（対象・範囲・想定）
- 対象：
  - Webアプリのアカウント回復導線（例：/forgot、/reset、/recovery-codes、/support/account-recovery）
  - 回復チャネル（メール、SMS、Authenticator/パスキー回復、サポート窓口）
  - サポート代行がある場合の運用UI/ワークフロー（可能な範囲で設定・ログ・証跡）
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - RP単体（自前認証）と、IdP連携（OIDC/SAML）双方を想定（「RPが回復を持たない」ケースも含めて境界を整理）
- できること/やらないこと（安全に検証する範囲）：
  - できる：正規導線の観測、最小回数での挙動差分確認、トークン/パラメータ設計の分析、ログ/証跡の取得
  - やらない：大量試行（DoS/総当たり）、実在第三者へのソーシャル、回復を完遂して第三者アカウントへ侵入（許可があるテストアカウントでのみ）
- 依存する前提知識（必要最小限）：
  - トークン（Bearer/One-time/TTL/Single-use）、CSRF/リダイレクト、セッション境界（ログイン前後）、メール/SMSの信頼境界

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 回復開始：識別子入力（email/phone/username）
  - チャネル送信：メール/SMS送信トリガ（同期/非同期、レスポンス差分）
  - 回復実行：token/code入力→認証状態/セッション/パスワード変更へ遷移
  - サポート代行：本人確認の要求項目→最終的に「回復を成立させる権限操作」
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：
    - メール配信基盤（外部ESP）、SMSゲートウェイ、サポートCRM/チケット、IdP（外部/社内）
  - 信頼境界（外部連携・第三者・越境ポイント）：
    - 「メール/SMSが届くこと」を本人性の根拠にしてよいか（SIMスワップ等は別として、設計上の想定を明示）
    - サポート担当者が実行できる操作（強制パスワードリセット、MFA解除、回復コード再発行）が “過剰権限” になっていないか
  - 権限境界（権限の切替/伝播/委任）：
    - 未認証→回復中（準認証）→認証済み の遷移点（どのフラグ/セッションが境界か）
    - 回復トークンが「誰の」「どの操作の」権限を委任するか（パスワード変更のみか、メール変更やMFA解除まで含むか）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - ユーザ識別子：email/phone/username（入力ごとのレスポンス差で列挙が成立）
  - 回復トークン：
    - 種別：URL token / numeric code / recovery code（多要素の代替）/ magic-link
    - 属性：TTL、single-use、スコープ（resetのみか、MFA解除/メール変更も含むか）、バインディング（セッション/端末/IP/UAに紐付くか）
  - 例外パス：
    - サポート代行で「回復コード再発行」「MFAリセット」「メール変更」が可能か
    - 本人確認（KBA/決済情報/端末情報/公的書類等）の要求が “手続きとして” 必須か、運用裁量で迂回できるか
  - レート制御：
    - 回復開始（送信トリガ）のレート制限
    - token/code入力のレート制限（回復コードは“パスワードより短い”ことが多く、制御が薄いと致命）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか：
  - 回復フローの状態遷移（未認証→回復中→認証/パスワード変更）が、どのエンドポイント/トークンで成立するか
  - ユーザ列挙の成否（存在/非存在での応答差・タイミング差・送信成否差）
  - 回復トークン/コードのスコープと寿命（観測できる範囲で：URL構造、失効挙動、再利用可否の兆候）
  - サポート代行が存在する場合、どの操作が“人手で”実行可能か（権限境界の所在）
- 何が“推定”できるか（推定の根拠/前提）：
  - トークンがセッション/端末に紐付かない（=奪取時に横展開しやすい）可能性：同一tokenでクライアント条件を変えても通る兆候、失効条件が弱い兆候
  - 送信先（ESP/SMS/CRM）という信頼境界が広い：CSP/外部依存/メールヘッダ/送信ドメイン/サポート運用からの推定
- 何は“言えない”か（不足情報・観測限界）：
  - メール/SMSの実配送・第三者側の脆弱性（ここでは「境界」として扱う）
  - サポート代行の内部ルール（運用ポリシー/教育/監査）までの断定（設定・監査ログが必要）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：回復トークンが短寿命・単回・スコープ限定で、列挙耐性もあり、例外パスが監査されている（堅牢）
  - パターンB：回復開始で列挙が成立し、送信トリガがレート不足（スパム/ATO準備に使われる）
  - パターンC：サポート代行が“最短で回復を成立させる経路”になっており、本人確認が弱い/裁量が強い（境界破綻）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”：
  - 「回復導線は認証の外側」ではなく「認証の最短バイパス」になり得るため、ここが弱いとMFA/SSO/強パスワードが無効化される
  - 特に「サポート代行」「回復コード」「メールリンク」は、運用・例外・短いコード・外部境界が絡み、破綻しやすい
- 優先度の付け方（時間制約がある場合の順序）：
  - P0：回復導線だけで ATO が成立し得る（MFA解除/メール変更/セッション発行まで到達する、または強い兆候）
  - P1：列挙＋送信トリガ乱用が成立（ATO準備・スパム/嫌がらせ・フィッシング補助になる）
  - P2：運用境界の整理（監査ログ不足、通知不足、レート設定の粗さ）だが直ちにATOとは言い切れない
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1（設計）：回復トークンのスコープ過大（reset以外の権限変更まで委任）→権限境界崩壊
  - 攻め筋2（例外）：サポート代行でMFA解除/回復コード再発行が容易→運用例外が最弱点
  - 攻め筋3（列挙）：存在確認ができる→後続のbruteforce/rate-limit評価（02_authn_12）へ直結
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - SSO/IdP前提：RP側に回復が無い場合でも「RPが扱うメール変更/プロファイル変更/セッション発行」が境界になる（IdP回復との“責任分界”を確認対象にする）
  - サポート代行がある：技術より運用境界（監査/二者承認/強制通知/操作制限）が重要になるため、証跡（監査ログ・権限ロール）を優先収集する

## 次に試すこと（仮説A/Bの分岐と検証）
> 条件が違うと次の手が変わる形で書く（低アクティブでも判断できる設計に寄せる）。
- 仮説A：（回復開始でユーザ列挙が成立する）
  - 次の検証：
    - 存在/非存在の入力で、ステータス/レスポンス本文/所要時間/送信トリガの挙動が変わるかを最小回数で比較
    - “同じ文言を返す” 場合でも、ヘッダ（Retry-After等）や副作用（送信回数、レート反応）に差がないかを見る
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功（列挙あり）：入力値の存在性が判定できる→12（rate-limit/lockout）へ優先接続、通知/監査の観点もP1で残す
    - 失敗（列挙なし）：次はトークン設計（仮説B）へ比重を移す
- 仮説B：（回復トークン/コードが “奪取耐性” を持たない：単回/短寿命/バインディングが弱い）
  - 次の検証：
    - トークンが「どの操作を委任するか」を観測で確定（パスワード変更のみか、MFA解除やメール変更に繋がるか）
    - 失効条件の観測（使用後/時間経過/再送/パスワード変更後にどうなるか）を、許可されたテストアカウントで最小回数実施
  - 期待する観測：
    - 成功（弱い兆候）：回復トークンが “認証済み相当の権限” を付与→P0扱い。16（step-up）/17（rotation）/15（concurrency）にも波及
    - 失敗（強い設計）：バインディングや単回性が強い→例外パス（仮説C）へ重点移動
- 仮説C：（サポート代行が最弱点：本人確認が弱い/監査が薄い/操作が過剰）
  - 次の検証：
    - サポートが実行できる操作（MFA解除、回復コード再発行、メール変更、強制ログアウト等）と、必要な承認/証跡/通知の有無を確認
    - “誰が・いつ・何をしたか” の監査ログ粒度が不足していないかを確認（後工程の再現性と報告品質に直結）
  - 期待する観測：
    - 成功（弱い運用兆候）：本人確認の要件が形式的/裁量依存→P0/P1。技術対策だけでなく運用統制（権限分離・二者承認・通知強制）を提案対象にする
    - 失敗（統制あり）：サポート経路が堅牢→回復コード・メールリンク（20）・WebAuthn回復（19）へ検証軸を寄せる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - `04_labs/02_web/02_authn/11_account_recovery/`（想定：RP単体＋メール送信（SMTP捕捉）＋サポート代行（擬似CRM））
- 参照ファイル：
  - （作成予定）回復フロー設計メモ、観測チェック（HAR/メール/SMS/監査ログ）、ロール設計（support権限）
- 取得する証跡（目的ベースで最小限）：
  - HTTP：HAR（回復開始/検証/完了の各リクエスト）
  - メール：本文（リンク・パラメータ）、ヘッダ（Message-ID/Received/Return-Path等）、送信ドメイン/署名（SPF/DKIM/DMARCは19へも接続）
  - SMS（ある場合）：本文（コード形式/長さ/有効期限表記）、送信元識別（短縮URL有無）
  - サーバ/監査：回復トークン発行ログ、使用ログ、失敗ログ、サポート操作ログ（誰が何を）
  - サポートCRM：チケット状態遷移（本人確認項目、承認者、添付の扱い）
- 観測の取り方（どの視点で差分を見るか）：
  - 状態遷移（未認証→回復中→認証相当）を“どの証跡で確定するか”を決め、各段で差分（成功/失敗/再送/期限切れ）を比較する
  - 「例外パス（サポート代行）」は、技術ログだけでなく “権限/承認/監査/通知” を同じ重要度で観測する（境界は人にある）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は“手段”であり“結論”ではない。必ず「何を観測している例か」を添える。
~~~~
# 例：回復フローの3点観測（開始→検証→完了）をHARで残す前提のメモ（擬似）
POST /account/recovery/start        { identifier: "user@example.com" }
POST /account/recovery/verify       { token_or_code: "..." }
POST /account/recovery/complete     { new_password: "...", confirm: "..." }

# 例：観測したいレスポンス要素（擬似）
- status / body（列挙耐性）
- rate-limit系ヘッダ（Retry-After等）
- tokenの受け渡し位置（URL/query/body/cookie）
~~~~
- この例で観測していること：
  - 回復が「どのエンドポイント」「どの状態」で成立するか（境界点の確定）
  - 列挙・レート・トークン受け渡しの設計（攻撃面の骨格）
- 出力のどこを見るか（注目点）：
  - 存在/非存在での差分、送信トリガの副作用、tokenのスコープ/失効挙動、回復完了時のセッション発行（cookie等）
- この例が使えないケース（前提が崩れるケース）：
  - IdP主導でRP側に回復が無い（回復はIdP側の境界）／サポート代行のみで技術導線が見えない（運用証跡が主戦場）

## 参考（必要最小限）
- OWASP ASVS（Authentication / Session / Access Control）
- OWASP WSTG（Authentication Testing：Password Reset / Account Recovery）
- プロダクトの設計資料（回復の責任分界：RP vs IdP、サポート権限モデル、監査要件）

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/02_web/02_authn_12_bruteforce_rate-limit_lockout（例外パス）.md`
  - `01_topics/02_web/02_authn_20_magic-link_メールリンク認証の成立条件.md`
- 関連 labs / cases：
  - `04_labs/02_web/02_authn/11_account_recovery/`（作成予定）
