## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - この技術で満たす/破れる点：
    - アップロードの本丸は「受理」ではなく、受理後に走る **解析・変換・プレビュー**（= 実行連鎖）で“別の実行系”に到達すること。
    - 破綻パターンは、(1) 変換器の危険オプション/機能を無効化していない、(2) サンドボックスが無い/弱い、(3) ネットワーク到達性が残っている（SSRF/OOB）、
      (4) リソース制限が無い（zip bomb・画像爆弾・PDF爆弾）、
      (5) 変換前後で「解釈器」が変わり、検査がすり抜ける（differential parsing）。
- WSTG
  - 該当テスト観点：
    - アップロード機能の「悪性ファイル」「想定外ファイル」を、受理可否だけでなく **受理後の処理パス（変換・プレビュー・AV・OCR）** まで含めて観測・検証する。
- PTES
  - 位置づけ：
    - 情報収集：処理チェーン（同期/非同期、ワーカー、外部SaaS、ジョブキュー）を棚卸し。
    - 脆弱性分析：どの処理器（Image/PDF/Office/Video/Archive）が何を実行しているかを境界モデル化。
    - 侵害成立の評価：RCE/SSRF/DoSを「成立条件（入力・到達性・権限・サンドボックス）」で分解し、最短で“危険な連鎖が存在する”ことを確定する。
- MITRE ATT&CK
  - 初期侵入：T1190（公開アプリの脆弱性悪用）
  - 実行/永続化/横展開の接続（成立条件つき）：
    - 変換ワーカーのRCEは、アプリ本体とは別権限/別ネットワークに居ることが多い。成立すると「内部到達性」「資格情報」「隣接サービス」に連鎖し得る。
    - SSRF/OOBは、内部メタデータや管理面へ到達する導線になり得る（ただし本ファイルでは“到達性の観測と境界”を主眼にする）。

---

## タイトル
file_upload_実行連鎖：プレビュー/変換器が「入力→実行」へ越境する条件（RCE/SSRF/DoS）を差分で確定する

---

## 目的（このファイルで到達する状態）
- アップロード後の“処理チェーン”を、以下の形で説明できる。
  1) どのイベントで処理が走るか（アップロード直後/閲覧時/共有時/バッチ）
  2) どのコンポーネントが実行するか（アプリ内/外部ワーカー/外部SaaS）
  3) 何が危険か（RCE/SSRF/OOB/DoS/情報漏えい）
  4) どの境界が弱いか（ネットワーク到達性、権限分離、サンドボックス、リソース制限、危険機能の無効化）
- 診断としては、まず「危険な実行連鎖が存在する」ことを **観測差分** で固め、次に（必要なら）個別処理器の検証へ進む判断ができる。

---

## 前提（本ファイルの守備範囲）
- 守備範囲：受理後の “処理・実行” に焦点
  - 例：サムネ生成、プレビュー生成、OCR、AV、メタデータ抽出、動画/音声変換、Office→PDF変換、PDFレンダリング、画像最適化、アーカイブ展開、メール添付生成
- 依存ファイル（前提として接続）：
  - `05_input_12_file_upload_01_validation（mime_magic_polyglot）.md`：何が受理されるか
  - `05_input_12_file_upload_02_storage_path（bucket_acl_traversal）.md`：どこに置かれ誰が到達するか
  - `05_input_11_path_traversal_03_archive（zip_slip）.md`：展開系のFS越境（zip/tar/7z）

---

## 境界モデル（実行連鎖は“複数実行環境”の合成）
### 1) 実行連鎖の典型コンポーネント
- アプリ本体（Web/API）
- ワーカー（ジョブキュー：thumbnail生成・変換・OCR）
- 外部処理サービス（SaaS：CDR、DLP、AV、OCR、プレビュー）
- オブジェクトストレージ/CDN（配信・変換のトリガになることがある）
- クライアント（ブラウザ/モバイル：プレビュー表示で二次被害が起きる）

### 2) 典型フロー（観測しやすい形）
- Upload → 受付（DB登録） → Storage保存 → Job enqueue → Worker処理 → Preview保存 → 表示/共有
- 観測可能な“状態”：
  - 受付直後にサムネが生成される（同期/短時間）
  - しばらくしてプレビューURLが有効になる（非同期/キュー）
  - 閲覧操作をした瞬間に生成が走る（遅延生成）
  - 共有リンク生成で変換が走る（共有境界での実行）

---

## リスク分類（何が起きるかを先に固定する）
### A. RCE（変換器がOSプロセス/ライブラリとして実行される）
- 典型：
  - CLIツール呼び出し（引数が組み立てられる）
  - ライブラリのパース/レンダリングの脆弱性
- 重要な成立条件：
  - 実行プロセスが存在する（= 変換が走る）
  - サンドボックス/権限分離が弱い（= 侵害の影響が大きい）
  - 危険機能が有効（例：外部参照、スクリプト機能、埋め込みの実行等）

### B. SSRF / OOB（レンダラ/プレビューが外部参照を解決する）
- 典型：
  - HTML/Markdownプレビューが外部URLをフェッチ
  - PDF/Office/画像（SVG等）が外部リソース参照を解決
  - “リンク展開/プレビューカード”生成（URL入力と同型）
- 成立条件：
  - 変換器がネットワークに出られる（内部/外部）
  - URLパースの差分、リダイレクト、DNS等で到達性境界が崩れる（SSRFの論点に合流）

### C. DoS（リソース枯渇：CPU/メモリ/ディスク/時間）
- 典型：
  - 解凍爆弾、巨大画像（ピクセル爆弾）、複雑PDF、無限再帰参照、極端に長い処理時間
- 成立条件：
  - サイズ/ファイル数/解凍後サイズ/時間の制限が無い
  - ワーカーが共用で、隔離/優先度制御がない

### D. 情報漏えい（処理器のエラー・ログ・一時ファイル）
- 典型：
  - 変換エラーのスタックがユーザへ露出
  - ワーカーのログに機密（署名URL/内部パス）が出る
  - 一時ファイルが公開領域に残る

---

## どこで“境界が崩れる”か（差分＝成立根拠）
> ポイント：危険ペイロードの列挙ではなく、少数の差分で「処理器の存在と性質」を確定する。

### 差分E1：処理が走るトリガ（いつ実行されるか）
- 差分の取り方：
  - アップロード直後に生成されるか vs 閲覧時に生成されるか（時間差・リクエスト増加）
- 言えること：
  - 実行連鎖の“入口”がどこか（アップロード境界か、閲覧境界か、共有境界か）
- 次の一手：
  - 閲覧時生成なら、閲覧権限（IDOR/BOLA）と組み合わさる（他人のファイル閲覧でワーカーを動かせる等）

### 差分E2：処理器の種類（何が動いているか）
- 差分の取り方（安全寄り）：
  - ファイル種別を変える（画像/PDF/Office/動画/アーカイブ）
  - “軽い破損”でエラー差分を見る（エラーメッセージ、処理時間、生成物の有無）
- 言えること：
  - 画像デコーダ/レンダラ、PDFレンダラ、Office変換器、アーカイブ展開器などの存在
- 次の一手：
  - 処理器が判明したら、リスクは「既知の脆弱性」よりも先に **サンドボックス/権限/ネットワーク到達性** を確認する（現実の影響が決まる）

### 差分E3：ネットワーク到達性（SSRF/OOBの成立条件）
- 差分の取り方（設計観点）：
  - プレビューが“外部参照を解決する設計”かどうかを確認（設定・仕様・ログ）
  - 変換ワーカーが外向き/内向き通信できるか（監査ログ・FWルール・プロキシ経由の有無）
- 言えること：
  - SSRFの土俵があるか（ワーカーがURLを取りに行く設計があるか）
- 次の一手：
  - SSRFの詳細は `05_input_09_ssrf_*` に合流し、URLパース差分・到達性を深掘りする

### 差分E4：権限分離（“侵害時の爆発半径”）
- 差分の取り方：
  - ワーカーが別コンテナ/別VM/別VPCか（アーキ資料、ログ、ホスト名、メタ情報）
  - ワーカーがストレージへどの権限でアクセスするか（最小権限か、広すぎるか）
- 言えること：
  - RCEが起きた場合の影響が「ワーカー内に閉じる」のか「内部横展開できる」のか
- 次の一手：
  - 権限が広いなら、RCEの“再現”よりも **影響評価（到達可能資産、権限範囲）** を優先する（実務で重要）

### 差分E5：リソース制限（DoSの成立条件）
- 差分の取り方：
  - サイズ上限、ファイル数上限、解凍後サイズ上限、処理時間上限、キュー制御の有無
- 言えること：
  - DoSが“設計として成立する”かどうか
- 次の一手：
  - 上限が無いなら、実攻撃は不要。設計欠陥として「上限・隔離・レート制御」を提案できる

---

## 実務の“処理器”棚卸し（攻撃面を漏らさないための分類表）
### 1) 画像系
- サムネ生成、サイズ変更、形式変換（jpeg/png/webp/avif）
- 危険が出る典型：
  - 画像デコーダの脆弱性
  - メタデータ（EXIF/ICC）処理の不備
  - SVG（XML + 外部参照 + スクリプト）を“画像”として扱う差分

### 2) PDF系
- PDF→画像、PDF→テキスト、プレビュー生成
- 危険が出る典型：
  - レンダラが外部参照を解決（SSRF/OOB）
  - 複雑PDFでCPU/メモリ枯渇（DoS）

### 3) Office系（docx/xlsx/pptx等）
- Office→PDF変換、メタデータ抽出、プレビュー
- 危険が出る典型：
  - 外部参照（テンプレ/リンク）を解決する設計
  - 変換器の安全設定不足（サンドボックス必須）

### 4) アーカイブ系（zip/tar/7z）
- 展開、ウイルススキャン、内容検査
- 危険が出る典型：
  - Zip Slip（パストラバーサル）
  - 解凍爆弾（リソース枯渇）
  - symlink/hardlink追従（FS越境）

### 5) 動画/音声系
- トランスコード、サムネ、波形生成
- 危険が出る典型：
  - 処理時間が長く、キュー枯渇しやすい
  - 外部コーデック/ライブラリの攻撃面

### 6) “プレビューUI”系（HTML/Markdown/テキスト）
- 危険が出る典型：
  - サニタイズ不足でXSS（これは `05_input_06_xss_*` と接続）
  - 外部リンク/画像の自動取得（SSRFと接続）
  - コンテンツスニッフィング（配信ヘッダ設計と接続）

---

## 観測ポイント（薄くしない：ログとHTTPで“連鎖”を可視化する）
### 1) HTTP観測（ユーザ側から取れるもの）
- アップロード直後：
  - レスポンスに `file_id` / `object_key` / `preview_status` が出るか
- プレビュー生成：
  - 別API（/preview, /thumbnail, /jobs）を叩いていないか
  - 生成完了までの時間差、ポーリング有無
- 配信：
  - CDN/ストレージ直リンクか、アプリ経由か
  - `Content-Type` / `Content-Disposition` / `Cache-Control` / `nosniff` の有無

### 2) サーバ観測（可能なら依頼する：診断の価値が上がる）
- ワーカー/ジョブキュー：
  - job種別（thumbnail, ocr, convert_pdf, antivirus）
  - inputファイルの種類、実行時間、失敗理由
- 外部通信：
  - 変換器が外部へ出ていないか（プロキシログ、FWログ）
- サンドボックス：
  - コンテナ隔離、seccomp、AppArmor、ネットワーク遮断、ファイル権限

~~~~
# ログ最小フィールド（推奨）
request_id
user_id / tenant_id
file_id / object_key
trigger (upload|view|share|batch)
processor (thumbnail|pdf_render|office_convert|ocr|av|extract)
exec_env (app|worker|saas)
network_access (allowed|blocked|via_proxy)
runtime_ms / cpu_time / mem_peak
output_artifacts (preview_key, thumbnail_key)
error_class / error_message (sanitized)
~~~~

---

## 攻撃寄りの判断基準（“再現”より前に優先すべきこと）
- 危険度を決める一次要素は「既知CVEがあるか」ではなく、次の設計条件：
  1) ワーカーが内部ネットワークへ到達できる（SSRF/横展開の土台）
  2) ワーカー権限が広い（ストレージ全読取/書込、シークレット参照）
  3) 変換器が多機能で、危険機能（外部参照/スクリプト/シェル呼び出し）を無効化していない
  4) 監査ログがなく、異常が検知できない
  5) 上限がなく、誰でも何度でも重い変換を起動できる（DoS）

結論：診断では「成立し得る構造」を固め、必要なら個別の深掘り（処理器の特定）へ進む。

---

## 防御（再発しない設計：優先順位）
### 1) 処理チェーンを“最小化”する（機能と形式を絞る）
- 受け付ける形式を減らす（validationの最強手）
- プレビュー不要な形式は “保存のみ” にする（実行連鎖を切る）

### 2) サンドボックス（隔離）を前提にする
- 変換器は原則「別プロセス・別権限・別ネットワーク」で動かす
- ネットワーク遮断（少なくとも内部宛てを遮断）を基本にする

### 3) 危険機能の無効化（“外部参照しない・解釈しない”）
- 変換器が外部参照を解決しない設定
- スクリプト/埋め込み実行に類する機能を無効化
- できるなら入力を“再生成”して余剰構造を落とす（画像のdecode→encode等）

### 4) リソース制限（DoS対策は設計で勝つ）
- サイズ/解凍後サイズ/ページ数/画像寸法/ファイル数/深さ
- 変換時間のタイムアウト、キューの優先度、ユーザ単位のレート制御
- 失敗時は安全に中断し、再試行を制御する（無限リトライ禁止）

### 5) 監査と検知（“変換器が何をしたか”を残す）
- 外部通信の可視化（プロキシ経由強制が望ましい）
- 変換失敗理由のサニタイズ（スタックや内部パスを返さない）
- 変換後成果物のライフサイクル（期限、削除、アクセス制御）

---

## 検証の進め方（安全に、しかし深く：実務の手順設計）
### ステップ1：処理チェーンの棚卸し（入口の全列挙）
- UI/機能：プロフィール画像、添付、インポート、テンプレ、バックアップ復元、共有リンク、コメント添付、Webhook添付
- API：upload-init / presign / complete / preview-status / download
- “閲覧時に生成”の有無：閲覧アクションでリクエストが増えるか

### ステップ2：処理器の存在を差分で確定（危険ペイロードは不要）
- 種別差分（画像/PDF/Office/アーカイブ/動画）で、生成物や時間差を観測
- “軽い破損”で、エラー分類（レンダラ/デコーダ/展開器）を推定
- 生成結果（サムネのフォーマット、出力サイズ、メタデータ除去）から再生成有無を推定

### ステップ3：境界の弱点を設計条件で詰める
- ネットワーク到達性（外部/内部）：
  - 仕様・設定・ログで確認（可能ならプロキシ/FWログ）
- 権限分離：
  - ワーカーがストレージに対し最小権限か（prefix制限、バケット全権限になっていないか）
- リソース制限：
  - 上限と失敗時挙動（タイムアウト、リトライ）を確認

### ステップ4：報告に落とす（再発しない提案）
- 「どの処理器が危険」ではなく、
  - “ワーカーが内部に出られる”
  - “上限が無い”
  - “外部参照を解決する”
  といった **境界条件** を原因として指摘し、アーキ改善を提案する。

---

## コマンド/リクエスト例（例示は最小限：観測目的のみ）
~~~~
# 例：観測したいのは「プレビュー生成が非同期かどうか」「別APIがあるか」
# 1) upload
POST /api/files (multipart)
-> 返却: file_id, status, preview_status?

# 2) preview status (存在すれば)
GET /api/files/{file_id}/preview
-> 返却: processing|ready と preview_url
~~~~
- ここで判断すること：
  - preview生成が別コンポーネント（ワーカー）か
  - 生成が“閲覧トリガ”か“アップロードトリガ”か

---

## 深掘りリンク（最大8）
- `05_input_12_file_upload_01_validation（mime_magic_polyglot）.md`
- `05_input_12_file_upload_02_storage_path（bucket_acl_traversal）.md`
- `05_input_11_path_traversal_03_archive（zip_slip）.md`
- `05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`
- `05_input_09_ssrf_06_parser_differential（url_parse_smuggling）.md`
- `05_input_06_xss_01_反射_境界モデル.md`
- `05_input_06_xss_03_DOM_境界モデル.md`
- `04_api_08_file_export_エクスポート境界（CSV_PDF）.md`
