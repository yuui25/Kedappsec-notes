## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 破れる：HTTPS化（TLS終端）により“安全になった”と誤認し、**HTTPSページ内にHTTP（/ ws / 旧CDN）参照が残る**ことで、(1) ブラウザでブロックされ機能が壊れる、(2) 一部クライアントで読み込みが成立し通信の真正性が崩れる、(3) 例外経路（管理画面・旧UI・メールリンク到達・エラーHTML）だけ取り残される、などの状態になる。結果として、実行境界（スクリプト）・表示境界（CSS/画像）・外部接続境界（API/WebSocket）が壊れ、盗聴/改ざん/誤誘導/セッション悪用の前提が揃い得る。
  - 満たす：HTTPS移行は「証明書が出た」で完了ではなく、**Mixed Content を“境界違反”としてゼロ化**する。方針は (a) 参照のHTTPS化（相対URL化・https固定）、(b) 例外が必要なら専用経路へ隔離、(c) 監視（ブラウザ警告/ログ/レポート）で逸脱を検知、(d) HSTS と CSP（upgrade/ブロック）で最後の門を閉じる、までを要件化する。
- WSTG
  - 観点：Mixed Content は「脆弱性」だけでなく **移行/運用の品質**として出る。テストは (1) どのリソース種別がHTTP参照か、(2) ブラウザがブロックするか/読み込むか、(3) 読み込まれる場合の影響（改ざん・追跡・実行）と範囲、(4) 修正案（参照統一/HSTS/CSP/依存整理）までを、観測→意味→次の一手で固定する。
- PTES
  - 位置づけ：Recon（TLS終端/サブドメイン/外部依存）と、Vulnerability Analysis（境界崩れ）を繋ぐ“移行品質の評価点”。Exploitationは原則として「成立条件の提示」と「影響半径の根拠」まで（過剰な手順化は不要）。Reportingでは、HTTP残存の棚卸し、段階的是正（report→強制）、ロールバック可能な移行計画まで落とす。
- MITRE ATT&CK
  - 条件付きで、初期侵入（公開アプリ経由）や実行（外部スクリプト改ざん）に接続し得る。
  - 目的：Collection（盗聴/追跡）、Credential Access（セッション/トークン周辺の前提崩れ）、Impact（誤誘導・機能破壊）へ繋がり得るが、断定は「どのリソースが読み込まれ、どのクライアントで成立し、何が改ざん可能か」が観測で揃ってから行う。

---

## タイトル
Mixed Content 境界（HTTPS移行）：HTTPSページ内の“HTTP残存”が、実行・表示・外部接続の境界を壊す条件を観測で確定する

---

## 目的（このファイルで到達する状態）
- Mixed Content を「警告が出る/出ない」の話ではなく、**境界（資産/信頼/権限）**として説明できる。
  1) Mixed Content の種類（active/passive、ws、CSS、iframe等）を“影響の強さ”で分類できる  
  2) ブラウザが **ブロックするのか/読み込むのか** を、ページ単位・経路単位で観測し状態化できる  
  3) HTTPS移行の設計（参照統一、HSTS、CSP upgrade/ブロック、外部依存棚卸し）を、優先度と分岐で提示できる  
  4) 攻撃者視点で「何が起きるなら危険か（成立条件）」を、過不足なく示せる  
  5) 次の一手を A/B 分岐で固定できる（“機能破壊の修正”か、“真正性崩れの是正”か、“例外隔離”か）

---

## 扱う範囲（本ファイルの守備範囲）
- 扱う
  - Mixed Content の定義と分類（active/passive、外部接続、WebSocket、iframe等）
  - HTTPS移行時に残りやすい経路（HTML/JS/CSS/テンプレ/設定/外部依存/旧UI）
  - 観測ポイント（DevTools/プロキシ/ログ）と結果の意味（状態分類）
  - 是正の方針（参照統一、段階導入、HSTS/CSP、例外設計）
- 扱わない（接続先）
  - TLS/証明書/CT等の深掘り：`01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`
  - CSP全体設計：`01_topics/02_web/06_config_03_セキュリティヘッダ（CSP_HSTS_Frame_Referrer）.md`
  - ブラウザ境界の総合：`01_topics/02_web/07_browser_security_境界（SOP_CORS_CSP）.md`
  - XSSの入口と成立：`01_topics/02_web/05_input_06_xss_0x_*.md`

---

## 境界モデル：Mixed Content は「HTTPSの信頼境界にHTTPが混入する」状態
### 1) 何の境界が壊れるか（3つの動詞で固定）
- 読める（Read）
  - 例：HTTP経由で取得したリソースがページ上に表示される（画像/フォント等）ことで、追跡や誤誘導の材料になる
- 実行できる（Execute）
  - 例：HTTP経由で読み込まれる script / iframe / worker 等が成立すると、改ざんで任意コード実行に繋がり得る
- 送れる（Send）
  - 例：HTTPの API / WebSocket（ws://）へ接続していると、送信内容が盗聴/改ざんされ得る（認証/操作の真正性が崩れる）

Mixed Content は、SOP/CORSの「読める境界」以前に、**通信路の真正性（改ざん耐性）**が壊れる問題として扱うのが実務に合う。

### 2) 資産境界 / 信頼境界 / 権限境界
- 資産境界
  - 影響対象：HTML（起点）、JS/CSS/画像/フォント、API（JSON等）、WebSocket、埋め込み（iframe）
- 信頼境界
  - HTTPS（信頼）に対し、HTTP（非信頼）が混入することで「経路上の第三者」が介在可能になる
  - 外部依存（CDN/タグ/解析SDK）が “https対応不完全” だと残存しやすい
- 権限境界
  - 被害者のセッションで実行・操作が起きる可能性（特に実行系）
  - API接続がHTTPだと、操作/応答の真正性が崩れ、誤操作・誤状態が起き得る

---

## Mixed Content の分類（影響の強さで見る：実務の優先度が決まる）
### 1) Active Mixed Content（実行・操作に直結しやすい）
- 典型：`<script src="http://...">`、`<iframe src="http://...">`、`<object/data>`, `ws://` 接続 等
- 実務の意味
  - ブラウザがブロックすることが多い → **機能障害（移行失敗）**として顕在化しやすい
  - 一部クライアント/条件で通る場合 → **改ざんで実行境界が崩れる**ため、影響が重い

### 2) Passive / Display Mixed Content（表示・追跡・誤誘導に寄りやすい）
- 典型：画像、アイコン、CSS背景画像、フォント等（HTTP参照）
- 実務の意味
  - ブロックされない/警告に留まる場合がある → “残存しやすい”
  - 追跡（リクエストが外へ飛ぶ）や、表示改ざん（誤誘導）の前提になり得る
  - 「安全」と断定せず、“何が混ざっているか”を資産として扱う

### 3) Mixed WebSocket（wssページから ws:// ）
- 典型：通知・チャット・リアルタイム更新が ws:// で残る
- 実務の意味
  - 通信内容が盗聴/改ざんされ得る（特に操作イベントやトークン）
  - “画面はhttps”でも実体の操作経路がhttpに落ちている、という移行事故の代表

---

## どこに残りやすいか（実務で見つかる順：修正コストも見える）
### 1) HTMLテンプレの絶対URL（http固定）
- 例：`src="http://cdn..."`、`action="http://api..."`、`href="http://..."` の固定記述
- 意味：最も直接的で修正しやすいが、ルート以外のテンプレ（メール用HTML、旧UI、エラーページ）に残りやすい

### 2) JS内のエンドポイント文字列（API/Beacon/追跡）
- 例：`fetch("http://api...")`、ログ送信/分析SDKのURL、WebSocket URL
- 意味：ユーザ操作の裏で発火し、機能障害として見えにくい（“一部だけ不安定”になる）

### 3) CSS（背景画像/フォント/外部import）
- 例：`background-image:url(http://...)`、`@import "http://..."`、`@font-face src: url(http://...)`
- 意味：ページ表示の一部として残存しやすく、警告止まりで放置されやすい

### 4) 外部依存（CDN/タグ/解析SDK/広告）
- 意味：運用主体が外部で、https対応・リダイレクト・SRI等が絡むため、移行の最後まで残りやすい
- 判断軸：その依存は必須か（削除/置換/自社ホスト化が可能か）

### 5) リダイレクト/ロードバランサ設定の“取り残し”
- 例：HTTP→HTTPSはするが、一部パスだけ例外、サブドメインだけ未移行、管理画面だけ未移行
- 意味：部分移行はMixed Contentの温床。特に “別サブドメインのAPI” を抱えるSPAで多い。

---

## 成立条件（差分＝成立根拠）：ブロックされるのか、読み込まれるのか
Mixed Content は「存在する」だけでなく、**そのクライアント/経路で成立しているか**が重要。
ここでは、診断の分岐を固定する。

### 仮説A：ブラウザがブロックしている（機能障害として出る）
- 状態
  - Console/Networkに “blocked:mixed-content” 等の拒否理由が出る
  - 該当リソースが pending / canceled / blocked になる
- 意味
  - 直接の改ざんリスクは“当該ブラウザでは”顕在化しにくいが、**移行品質の失敗**（本番で機能が壊れる）として重大になり得る
  - 例外クライアント（組み込みWebView/古い環境）では成立する可能性があるため、対象範囲（想定UA）を境界として明記する

### 仮説B：読み込まれている（警告止まり/例外成立）
- 状態
  - NetworkでHTTPリソースが200で取得できている（または中継で見える）
  - Securityパネルで “insecure content” 等が表示される
- 意味
  - 表示系なら追跡/誤誘導の前提、実行系なら改ざんで実行境界が壊れ得る
  - ここで “何がHTTPで動いているか（資産）” を確定し、影響半径を評価する

### 仮説C：HTTPSへ自動アップグレードされて成立している（移行の段階措置）
- 状態
  - ブラウザまたはCSP（upgrade系）で、http参照がhttpsへ置換されて取得できている
- 意味
  - “参照文字列がhttpのまま”でも、運用として成立する場合がある
  - ただし、https側が存在しない/証明書が不正/ホスト名が違う等で、環境差により壊れる可能性があるため、最終的には参照自体の是正（https固定/相対化）へ進める

---

## 観測ポイント（Mixed Content を“状態”として証跡化する最小セット）
### 1) ブラウザ観測（最優先：拒否理由と対象資産を取る）
- Console
  - Mixed Content の警告/ブロック理由（どのURLが対象か）
- Network
  - 対象リクエストのスキーム（http/ws）と Initiator（HTML/JS/CSSのどれが起点か）
  - 取得の成否（blocked / redirected / 200）と最終URL（http→httpsの置換が起きているか）
- Security（可能なら）
  - ページが “secure” でも “insecure requests” が混在していないか
- HAR
  - 報告用に、対象URL・起点・成否を再現性ある形で残せる（監査にも使える）

### 2) サーバ/エッジ観測（ヘッダと移行施策の有無）
- 代表的に確認するもの
  - HSTS（Strict-Transport-Security）が出ているか（ドメイン/サブドメイン適用の方針が見える）
  - CSPで upgrade/ブロックの方針があるか（存在するなら段階導入中の可能性）
- 意味
  - “ブラウザが勝手にブロックしている”のか、“サーバが方針として閉じている”のかを切り分けられる

### 3) 中継点（CDN/WAF/Proxy）の関与
- 取り得る状態
  - HTMLはhttpsだが、裏のAPI/WSがhttpに落ちる（別ホスト、別LB、別設定）
  - 中継でURL書き換えをしている（環境差が出やすい）
- 意味
  - 修正はアプリコードだけでなく、エッジ設定の統一（強制リダイレクト/HSTS/CSP配布）に波及する可能性がある

---

## 攻撃者視点での利用（成立根拠ベースで評価する）
### 1) 実行境界が崩れる（active mixed content が成立する場合）
- 意味（評価の核）
  - “HTTPSで守られているはずのページ”に、経路上の第三者が介入できる前提が揃う
  - 結果として、ページ内での任意実行・操作・外部送信が成立し得る（ただし、当該クライアントで読み込みが成立することが前提）
- 判断に必要な根拠
  - どのリソース種別がHTTPか（script/iframe/ws等）
  - そのリソースが実際に読み込まれているか（ブロックされていないか）
  - そのリソースが “権限のある操作” に到達できるページで起きているか

### 2) 誤誘導/追跡が成立する（display mixed content が残る場合）
- 意味
  - 画像やCSS等でも、外部へリクエストが飛ぶ（追跡）、表示が変わる（誤誘導）前提になり得る
  - “軽微”と断定せず、対象がログイン後/管理画面/決済画面かで優先度を調整する

### 3) 外部接続境界が崩れる（http API / ws が残る場合）
- 意味
  - 操作イベント・通知・リアルタイム更新が盗聴/改ざんされ得る
  - 特に、トークン/ID/状態更新が混ざると影響が増える（機能不正・誤状態・誤承認）

---

## 次に試すこと（仮説A/Bで分岐：行動を固定）
### 分岐1：ブロックされている（機能障害として出る）場合
- 次の一手（優先：移行品質の是正）
  1) 対象URLとInitiatorを確定（HTML/JS/CSSのどこが起点か）
  2) 修正方針を決める（https固定、相対URL化、設定値の置換、依存の差し替え）
  3) “例外経路だけ残る”を潰すため、同一機能の別到達（旧UI、メールリンク、エラーHTML）も確認する
  4) 再発防止：CIでの静的検出（http参照検出）や、監視（Consoleエラー/フロント計測）を設計要件に含める

### 分岐2：読み込まれている（成立している）場合
- 次の一手（優先：影響半径の確定→是正）
  1) リソース種別ごとに影響を分ける（script/iframe/ws は高、画像等は状況依存）
  2) 発生ページの権限境界を評価（ログイン後、管理、決済、テナント操作 など）
  3) 外部依存なら「管理主体」と「置換可能性」を決め、最終的に https へ統一する
  4) 最後の門として、HSTS/CSP（upgrade/ブロック）で“残存”を抑え込む（ただし段階導入）

### 分岐3：アップグレードで見かけ上動いている（段階措置）場合
- 次の一手（優先：恒久化）
  1) 参照文字列（http）が残っている箇所を除去（相対/https固定）
  2) アップグレードに依存していた外部ドメイン（https対応が不完全）を棚卸しして置換/自社ホスト化を検討
  3) 移行計画として、report（観測）→強制（ブロック）の順で運用へ落とす

---

## 04_labs（Mixed Content / HTTPS移行を“安全に”観測する設計）
- Lab候補（例）
  - `04_labs/02_web/09_mixed_content_01_active_vs_display_blocking/`
  - `04_labs/02_web/09_mixed_content_02_ws_to_wss_migration_boundary/`
  - `04_labs/02_web/09_mixed_content_03_hsts_csp_upgrade_enforce_rollout/`
- Lab設計要件（手順書ではなく設計）
  - 同一アプリで、(a) httpsページ、(b) httpリソース（script/img/css/api/ws）を用意し、資産種別ごとの挙動差を観測できる
  - 観測点：Console/Network/Security/HAR、サーバログ（http側への到達）、必要ならpcap（盗聴の事実は“自環境”でのみ検証）
  - 段階導入：移行前（http参照残存）→アップグレード（置換）→強制（ブロック）で、機能影響と安全性のトレードオフを説明できる
  - 巻き戻し：設定の切替が一撃で戻せる（snapshot/reset前提）

---

## コマンド/例（例示は最小限：観測・判断を優先）
~~~~
# 記録の基本：
# - ブラウザ（Console/Network/Security）で「どのURLが混在し、ブロック/成功のどちらか」を確定する
# - Initiator で起点（HTML/JS/CSS）を特定し、修正箇所の優先度を付ける
# - エッジ/オリジンでHSTS/CSP等の移行施策が統一されているかを確認する（経路差分が残存の原因になりやすい）
~~~~

---

## 深掘りリンク（最大8）
- `01_topics/02_web/07_browser_security_境界（SOP_CORS_CSP）.md`
- `01_topics/02_web/06_config_03_セキュリティヘッダ（CSP_HSTS_Frame_Referrer）.md`
- `01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`
- `01_topics/01_asm-osint/21_third-party_外部依存（タグ_分析SDK）洗い出し.md`
- `01_topics/02_web/02_authn_01_cookie属性と境界（Secure_HttpOnly_SameSite_Path_Domain）.md`
- `01_topics/02_web/05_input_06_xss_01_反射_境界モデル.md`
- `01_topics/02_web/04_api_00_権限伝播・入力・バックエンド連携.md`
- `01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
