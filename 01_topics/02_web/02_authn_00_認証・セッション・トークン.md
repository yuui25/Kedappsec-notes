<<<BEGIN>>>
# 02_authn_認証・セッション・トークン.md

## 目的（この技術で到達する状態）
- 認証（AuthN）を「ログインできる/できない」で終わらせず、**本人性がどこで・何で・いつ確定し、どの範囲に伝播するか** を観測で説明できる。
- セッション（Cookie）/トークン（Bearer/JWT等）を、**境界（ドメイン/パス/テナント/端末/ブラウザ）** と **成立条件（更新/失効/再認証/MFA）** の観点で理解し、検証に使える。
- 次の認可（AuthZ）検証に繋がる「権限伝播の入口（どの属性が何に効くか）」を確定できる。

## 前提（対象・範囲・想定）
- 対象：許可された範囲のWebアプリ/環境のみ。
- 想定：SSO（SAML/OIDC）、MFA、SPA+API、CDN/WAF、SaaS連携が一般的。
- やらないこと：破壊的試験や過剰負荷。認証系は特にロック/監視に注意し、最小観測で判断する。
- 依存（観測基盤）：
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 前段の接続：
  - `01_topics/02_web/01_web_recon_入口・境界・攻め筋の確定.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 認証の“成立点”を特定する
- 認証開始：どのURL/どのリダイレクトで始まるか（アプリ/IdP）
- 認証成立：どのレスポンスで「状態が変わる」か（Set-Cookie、トークン返却、302先など）
- 認証確認：どのリクエストで“ログイン済み”が判定されるか（/me、/session、/profile等）

### 2) セッション境界（Cookie）
- Cookieのスコープ
  - Domain / Path：どこまで届くか（サブドメイン/アプリ領域）
  - SameSite：クロスサイト遷移（SSO/外部遷移）で影響する
  - Secure/HttpOnly：輸送/JSアクセス境界
- セッションのライフサイクル
  - 発行、更新（回転/延長）、失効（ログアウト/タイムアウト）
  - 並行セッション（複数端末/複数ブラウザ）での挙動差

### 3) トークン境界（Bearer/JWT等）
- どこに現れるか：Authorizationヘッダ、Cookie、ローカルストレージ等（観測で確認）
- 何が含まれるか：sub/uid、tenant、role/scope、exp/iat、aud/iss（断定せず観測で）
- どこまで伝播するか：フロント→API、API→バックエンドで何が渡るか

### 4) SSO/MFAがある場合の“越境点”
- IdPドメインへのリダイレクト（state/nonce等の有無、戻り先のパターン）
- MFA成立の境界（追加チャレンジの挿入点）
- “越境”に伴う条件差（SameSite、サブドメイン、ブラウザ設定、端末差）

### 5) 条件差（同じ操作でも結果が変わる条件）
- 未ログイン/ログイン、端末差、ブラウザプロファイル差
- セッション期限（時間経過）での挙動差
- ログアウト後の残存（キャッシュ、再ログイン不要など）の有無

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（確定できる）
  - 認証の成立点（どこでCookie/トークンが発行されるか）
  - セッション/トークンのスコープ（どこまで届くか、何が境界か）
  - 認証状態がAPIにどう反映されるか（どのヘッダ/Cookieが鍵か）
- 推定（追加観測で強くなる）
  - IdP/アプリの責任分界（どこが外部依存か）
  - トークンの意味（tenant/role/scope等）が何に効くか（認可検証へ繋ぐ）
- 言えない（この段階の限界）
  - 認証が正しい/安全の断定（実装詳細、バックエンド挙動まで必要）
  - MFAの強度評価（運用や実装の詳細が必要）
  - “HttpOnlyだから安全”の断定（別経路の成立条件があり得る）

## 攻撃者視点での利用（意思決定：次に何を深掘りするか）
- 認証の“鍵”を特定する
  - 何を持っていればログイン状態として扱われるか（Cookie/Token/両方/別ヘッダ）
- 越境点を把握する
  - SSO/外部遷移で、どの境界（ドメイン/サイト）を跨ぐか
- 認可検証の準備をする
  - token/cookie内の tenant/role/scope が見えれば、次のAuthZで「境界モデル」を立てやすい
- API中心の場合
  - UIではなくAPIが主戦場になるため、認証状態がAPIにどう伝播するかを優先して固める

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：認証はSSOで、境界が複数ドメインに跨っている
  - 次の検証：
    - リダイレクトの流れと、Cookie/トークンがどのドメインで発行されるかを確定する
    - SameSite/Domain/Pathの条件差で、成立が変わるかを最小セットで観測する
  - 期待する観測：
    - “どこで本人性が成立し、どこまで届くか”が説明できる
- 仮説B：SPA+APIで、認証はトークン（Bearer等）が鍵
  - 次の検証：
    - API呼び出しをProxyでトレースし、どのヘッダ/トークンが必須かを確定する
    - トークン更新（refresh）や失効の境界を観測する
  - 期待する観測：
    - “何が鍵か”が確定し、AuthZ（IDOR/BOLA）検証の前提が整う
- 仮説C：ログアウトしても一部が生き残る/条件で再ログイン不要になる
  - 次の検証：
    - ログアウト時に消えるCookie/残るCookieを比較する
    - 別プロファイル/別端末で同条件を再現し、原因がキャッシュかセッションか切り分ける
  - 期待する観測：
    - 認証状態の境界が整理され、誤判定（ログイン扱いのズレ）を防げる

## 手を動かす検証（Labs連動：観測点を明確に）
- 必須の証跡（最小セット）
  - HAR + Proxyログ + 検証メモ
- 最小の差分セット（必ずやる）
  - 未ログインで入口にアクセス → ログイン実施 → ログイン後の同画面/同APIを再アクセス
  - 追加：ログアウト → 同操作を再度（残存差分を見る）
- メモに必ず残す項目
  - 視点（端末/経路/プロファイル）
  - 成立点（どのレスポンスで状態が変わったか）
  - 鍵（どのCookie/ヘッダ/トークンが必須か）
  - 条件差（SameSite/Domain/期限/端末差）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 例：未ログインで入口を観測（ログイン誘導・リダイレクト）
curl -i -L https://example.com/

# 例：APIの認証要否を観測（401/403/200の差分）
curl -i https://api.example.com/me
~~~~
- この例で観測していること
  - 認証境界（入口）と、APIが認証前に見える範囲
- 出力のどこを見るか
  - ステータス、Location、Set-Cookie、WWW-Authenticate等
- 前提が崩れるケース
  - JS必須/SSO必須の場合、curlだけでは成立しない（ブラウザ+HAR/Proxyで観測へ）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - 認証、セッション管理、トークン処理の要件に直接接続する。成立点と境界を観測で確定し、以後の検証観点を外さないための基盤。
- WSTG：
  - 認証（Authentication Testing）とセッション管理（Session Management Testing）へ直結。未ログイン/ログイン/ログアウトの差分観測で境界を固める。
- PTES：
  - Vulnerability Analysisで“認証境界”を誤ると全検証がズレるため、入口確定→成立点確定→鍵の特定の順で土台を作る。
- MITRE ATT&CK：
  - Credential Access/Valid Accounts等の戦術・技術に直接“手法”として寄せるのではなく、検証側では「本人性の成立条件」を観測して理解する（分類で終わらせない）。

## 次に作るべきtopics（推奨順）
1) `01_topics/02_web/03_authz_認可（IDOR/BOLA/BFLA）境界モデル化.md`  
2) `01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 関連 topics：`01_topics/02_web/01_web_recon_入口・境界・攻め筋の確定.md`

---


<<<END>>>
