<<<BEGIN>>>
# 06_config_01_CORSと信頼境界（Origin_資格情報_プリフライト）.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：V1（Architecture）/ V4（Access Control）/ V13（API）/ V7（Logging）に接続。CORSは“認可”ではなく、ブラウザに対する「読み取り許可」を設計する境界。
- WSTG：設定・運用境界のテストで、CORSは頻出。誤設定は「第三者サイトからの読み取り」を成立させる可能性があるため、観測→差分で根拠を固める。
- PTES：差分比較（条件A/B）で成立条件を切ることで、推測を排して報告品質を上げる（再現・根拠提示が必須）。
- MITRE ATT&CK：Collection に接続。CORS誤設定は、ブラウザを媒介にしたデータ取得（読み取り）に寄与し得る。

## 目的（この技術で到達する状態）
- CORSを「許可されている/されていない」ではなく、**どのOriginに・どの条件（資格情報・メソッド・ヘッダ）で・何が許可されるか**を観測→差分で説明できる。
- CORSと認証/認可を混同せず、**“ブラウザが読み取れるか”の境界**として整理し、結論（成立・不成立・不明）を根拠付きで出せる。
- 誤設定の典型（ワイルドカード、反射、資格情報との矛盾、プリフライトの穴）を、最小の検証で切り分けられる。

## 前提（対象・範囲・想定）
- 対象：ブラウザからAPIを呼ぶ構成（SPA/フロント分離）または外部サイトからアクセスされ得るAPI。
- 観測点（固定）：
  - Proxyログ（必須）：レスポンスヘッダ、OPTIONSプリフライト、要求ヘッダ/Origin
  - 必要時：ブラウザDevTools（CORSブロックの表示は“結果”、根拠は通信ヘッダ）
- 依存（関連）：
  - Authn：`01_topics/02_web/02_authn_01_cookie属性と境界（Secure_HttpOnly_SameSite_Path_Domain）.md`
  - API：`01_topics/02_web/04_api_01_権限伝播モデル（フロント_バックエンド_ジョブ）.md`
  - 観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - 親：`01_topics/02_web/06_config_設定・運用境界（CORS ヘッダ Secrets）.md`

## 観測ポイント（何を見ているか：CORSの境界）
### CORSが決めるのは「読み取り許可」
- CORSは、サーバが“リクエストを受けるか”ではなく、**ブラウザがレスポンスを“読み取ってよいか”**を制御する。
- そのため、APIが200を返していても、ブラウザが読めない場合がある（逆もある）。

### 主要ヘッダ（最低限これだけ）
- リクエスト側：
  - `Origin`
  - （プリフライト時）`Access-Control-Request-Method`
  - （プリフライト時）`Access-Control-Request-Headers`
- レスポンス側：
  - `Access-Control-Allow-Origin`（ACAO）
  - `Access-Control-Allow-Credentials`（ACAC）
  - `Access-Control-Allow-Methods`（ACAM）
  - `Access-Control-Allow-Headers`（ACAH）
  - `Access-Control-Expose-Headers`
  - `Vary: Origin`（キャッシュ境界の重要ポイント）

## 意味→判断→次の一手（CORSを差分で確定する）
### 1) Allow-Origin（ACAO）
- 意味：どのOriginのブラウザにレスポンスの読み取りを許すか
- 判断：
  - 固定の許可Origin：設計意図が比較的明確（ただし範囲が妥当かは別）
  - `*`：資格情報を伴わない読み取りを広く許可する方向
  - 反射（リクエストのOriginをそのまま返すように見える）：境界が崩れている可能性（差分で確定）
- 次の一手：
  - **Originを2種類以上**に変えて比較する（許可/不許可の境界があるか）

### 2) Allow-Credentials（ACAC）
- 意味：Cookie等の資格情報付きの読み取りを許可するか
- 判断：
  - `true` の場合、許可Originが“厳密に限定されているか”が重要
  - `ACAO:*` と `ACAC:true` の組み合わせは矛盾しやすく、挙動は実装依存になりがち（推測せず観測）
- 次の一手：
  - Cookie送信が絡むなら、SameSite/Domain設計（Authn）と合わせて成立条件を切る

### 3) プリフライト（OPTIONS）
- 意味：非単純リクエスト（特定メソッド/ヘッダ）では、本体の前にOPTIONSで許可を取りに行く
- 判断：
  - 本体（GET/POST）が許可されていても、プリフライトが拒否されるとブラウザは呼べない
  - 逆に、プリフライトが広い許可でも、本体側で別の制御がある（認証/認可）
- 次の一手：
  - まず「単純リクエスト」で観測し、その後に「非単純（カスタムヘッダ等）」で差分を見る

### 4) Vary: Origin（キャッシュ境界）
- 意味：Originごとにレスポンスを分けてキャッシュすべきことを示す
- 判断：
  - Varyが無いと、キャッシュ経由で別Originの許可が混ざる可能性（構成依存）
- 次の一手：
  - CDN/キャッシュがある場合は、同一エンドポイントでOrigin差分を繰り返して一貫性を確認する

## 典型的な“誤解”の防止（CORS≠認可）
- CORSが許可されている＝「第三者がAPIを呼べる」ではない  
  → 呼べる/呼べないは認証・認可・到達性の問題。CORSは“ブラウザの読み取り”の問題。
- CORSがブロックされる＝「安全」ではない  
  → ブラウザ以外（サーバ/ツール）はCORSに縛られない。読み取りが防げても、状態変更は別途検討が必要。

## 手を動かす検証（最小：差分セット）
~~~~
# 目的：CORS許可の境界（Origin/credentials/プリフライト）を差分で確定する

# 差分セット（最小）
# 1) Originなし（ツール/同一オリジン相当）でAPIを呼ぶ → レスポンスとヘッダを保存
# 2) Origin=A を付けて呼ぶ → ACAO/ACAC/Expose を保存
# 3) Origin=B（別ドメイン）を付けて呼ぶ → 差分を比較
# 4) 非単純リクエスト（例：カスタムヘッダ）を想定し OPTIONS を観測 → 許可/拒否を保存

# 記録すべきもの
# - 対象エンドポイント
# - Origin値（A/B）
# - 返ってきたCORSヘッダ一式
# - 401/403/200等の結果（認証・認可の結果は別途整理）
~~~~

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（証跡で断定できる）
  - どのOriginに読み取りを許可しているか（固定/ワイルド/反射の差分）
  - 資格情報付き読み取りが許可されるか（ACAC）
  - プリフライトで許可されるメソッド/ヘッダ（ACAM/ACAH）
  - キャッシュ境界が考慮されているか（Vary: Origin）
- 言えないこと（追加証跡が必要）
  - 実際に第三者がデータを取得できるかの確定（認証・認可の成立条件が必要）
  - CDN/キャッシュ経由の混在影響（構成・キャッシュ挙動の追加観測が必要）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- 優先度
  1) 読み取り可能性が高いデータ系API（ユーザ情報、検索、一覧、エクスポート）
  2) 資格情報（Cookie）を伴うAPI（ACAC:true との組み合わせを要観測）
  3) 例外経路（ファイル、エクスポート、管理系API）でCORSだけ緩い箇所
- 次の仮説
  - もし反射に見えるなら：Origin A/Bで差分を取り、境界が存在するか確定する
  - もしACAC:trueなら：Cookieの送信境界（SameSite/Domain）と合わせて成立条件を切る
  - もしVaryが無いなら：キャッシュ混在の可能性を“観測”で潰す（断言しない）

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：CORSが広すぎる気がする
- 次に試すこと
  - データ系エンドポイントを選び、Originを複数で差分観測（固定/反射/ワイルド）を確定する
- 期待する観測
  - “どのOriginが許可されるか”を yes/no/unknown で言える

### 仮説B：Cookie付きで読めるかが焦点
- 次に試すこと
  - ACACとSameSiteの両方を観測し、ブラウザ条件（送信される/されない）を切り分ける
- 期待する観測
  - 読み取り成立の条件（ブラウザが送る/読める）が説明できる

### 仮説C：プリフライト周りだけ挙動が変
- 次に試すこと
  - OPTIONSの結果（許可/拒否）と本体APIの結果を並べ、どこで境界があるかを確定する
- 期待する観測
  - “プリフライトが境界”か“本体が境界”かを説明できる

## 参考（必要最小限）
- 親：`01_topics/02_web/06_config_設定・運用境界（CORS ヘッダ Secrets）.md`
- 関連（Authn）：`01_topics/02_web/02_authn_01_cookie属性と境界（Secure_HttpOnly_SameSite_Path_Domain）.md`
- 観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`

## 深掘りリンク（親ファイル末尾に追加する枠：最大8件）
- （親）`01_topics/02_web/06_config_設定・運用境界（CORS ヘッダ Secrets）.md` の末尾に本ファイルへのリンクを追加する
  - `06_config_01_CORSと信頼境界（Origin_資格情報_プリフライト）.md`

---

<<<END>>>
