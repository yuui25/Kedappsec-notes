## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS
  - 破れる：決済は「重要操作」の代表であり、認証・認可・入力・監査のすべてが交差する。境界が弱いと、(1) 金額/通貨/顧客/請求先の改ざん、(2) 返金の不正実行、(3) 3DSや本人確認の迂回、(4) 二重請求/二重返金（レース）、(5) 決済状態の偽装（成功に見せかける）、(6) Webhook偽造/再送乱用、(7) ログに機微（カード/トークン）が漏れる、が現実に起きる。決済は“境界を踏み外すと即インシデント”になるため、ASVSの重要操作・セッション・認可・監査の要求を横断で満たす必要がある。
  - 満たす：重要操作の前提（再認証/step-up、強固なCSRF、操作意図の確認）、決済パラメータのサーバ側再計算、状態遷移の正当性（state machine）、Webhook署名検証と冪等、監査ログ、最小権限（運用UI/管理API）、を境界として設計する。
- WSTG
  - 観点：決済は“入力検証”ではなく“状態と権限の検証”が主戦場。テストは (1) 金額/通貨/対象（invoice/order）を改ざんできないか、(2) 3DSや認証結果をクライアント信頼していないか、(3) 返金・取消の権限が正しく分離されているか、(4) Webhookの偽造/再送/順序逆転に耐えるか、(5) 競合（リトライ/二重送信/並列）で二重請求・二重返金が起きないか、を観測で確定する。
- PTES
  - 位置づけ：Exploitationは「実際に金を動かす」必要はない。テスト環境・少額・ダミーで、(a) 不正な状態遷移が可能か、(b) 監査証跡が残るか、(c) 回復手段（取消/返金）が悪用されるか、を“最小限の再現”で証明する。Reportingでは、決済ドメインの状態モデルと権限モデルを明示し、是正優先度（最優先）を示す。
- MITRE ATT&CK
  - 決済は攻撃者の最終目的（Impact/Financial theft）に直結し、初期侵害後の権限悪用（Valid Accounts）、セッション再利用、管理機能悪用、Webhook偽造、レース悪用など複数戦術が交差する。防御は「重要操作の境界（step-up/監査/二人承認）」と「外部イベント（Webhook）の信頼境界」が中心になる。

---

## タイトル
Payment 重要操作境界（3DS / 返金）
“金額・状態・権限・外部イベント”をサーバ側で確定し、監査可能な状態遷移として閉じる

---

## 目的（このファイルで到達する状態）
- 決済フローを「画面」ではなく **状態遷移（state machine）** と **信頼境界（client / PSP / webhook）** としてモデル化できる。
- 次を説明・検証できる：
  1) 金額/通貨/税/割引/送料の“真実”はどこで決まるか（サーバ再計算）
  2) 3DSの結果（成功/失敗/チャレンジ）はどこで確定するか（PSP由来の検証）
  3) Webhookの信頼境界（署名/一回性/順序）をどう成立させるか
  4) 返金/取消/チャージバックの権限境界（運用UI/二人承認/上限）
  5) 二重請求/二重返金（レース/冪等）をどう潰すか
  6) 証跡（監査ログ/相関ID）をどう残すか

---

## 扱う範囲（スコープ）
- 扱う
  - 3DS（本人認証）を含む決済の信頼境界
  - 返金（refund）/取消（void/cancel）/部分返金/全額返金の境界
  - 決済パラメータ改ざん防止（サーバ側再計算、price-lock、署名）
  - 状態遷移（authorized/captured/settled/refunded/failed等）と検証
  - Webhook（署名、再送、冪等、順序逆転）と監査
  - 重要操作としての step-up / CSRF / 権限分離 / 監査ログ
- 扱わない（接続先）
  - Webhook詳細：`04_api_04_webhook_受信側の信頼境界（署名_再送）.md`
  - 冪等性：`04_api_06_idempotency_レースと二重実行境界.md`
  - 重要操作一般：`03_authz_06_privileged_action_重要操作（承認_送金_権限）.md`
  - step-up：`02_authn_16_step-up_再認証境界（重要操作_再確認）.md`
  - ログ：`11_logging_tracing_相関IDと証跡設計.md`

---

## 境界モデル：決済は「クライアントを信じない」「外部イベントを信じすぎない」「状態遷移で閉じる」
### 1) 資産境界（何が守られるべきか）
- 金銭的価値
  - 請求額（amount）、通貨（currency）、税/割引/送料、数量、対象（order/invoice）
- 決済状態
  - authorized / captured / settled / failed / canceled / refunded（部分含む）
- 本人認証状態（3DS）
  - frictionless / challenge / failed / attempted 等
- 返金権限
  - 誰が返金できるか、上限、理由、証跡
- 決済プロバイダ情報
  - payment_intent / charge_id / transaction_id、カードトークン等（機微）

### 2) 信頼境界（誰の情報を“真実”として扱うか）
- クライアント（ブラウザ/アプリ）
  - amountや3DS結果を“申告”させてはならない（UIは表示でしかない）
- サーバ（自社）
  - 注文・金額・顧客・在庫・割引の真実を確定する責務
- PSP/アクワイアラ（決済事業者）
  - 認証結果や決済結果の情報源。ただし“イベントの順序/再送”がある
- Webhook
  - PSPから来るが、ネットワーク上は攻撃対象（偽造/再送/順序逆転）なので署名検証と冪等が必須

### 3) 権限境界（誰がどの操作をできるか）
- 顧客：支払い開始・支払い方法変更（自分の注文のみ）
- CS/運用：返金、取消、手動キャプチャ、例外処理（上限/二人承認）
- 管理者：返金上限の設定、PSP鍵の管理（超重要、監査必須）

---

## 状態遷移（State Machine）：このモデルがないと必ず崩れる
### 1) 代表的な遷移（例：カード決済）
- created（注文作成）
- payment_pending（支払い開始）
- 3ds_required / 3ds_in_progress（必要時）
- authorized（与信成功）
- captured（売上確定：キャプチャ）
- settled（入金確定：PSP側の確定）
- canceled（取消：与信取消/未確定取消）
- refunded_partial / refunded_full（返金）
- chargeback / dispute（異議申し立て）

重要：遷移はPSPに依存するが、少なくとも「与信」「売上」「返金/取消」「異議」の区別をサーバ側の状態で表現する。

### 2) 状態遷移で縛るべき不正
- “未承認の注文”を captured にできない
- “未captured”なのに refunded にできない（PSPの仕様に沿う）
- “refund済み”に二重返金ができない（冪等と排他）
- “別注文のtransaction_id”を紐付けられない（参照整合）

---

## 3DS（本人認証）の境界：UI結果ではなく「PSPの確定結果」を検証する
### 1) 3DSの誤解（現場でよく事故る）
- 「3DS画面が出た/成功と表示された」＝成功ではない
- クライアントから返ってくる “success=true” のような値を信じると破られる
- 3DSは “本人認証の手続き” であり、最終的な決済成功/失敗はPSP側の状態で確定する

### 2) 設計の定石
- サーバは「3DS結果」をPSPのAPI（または署名付きイベント）で照会/検証して確定する
- 3DSフローの途中状態（pending）を許容し、完了イベントで遷移する
- 3DS関連のID（payment_intent等）は “注文ID/顧客ID” と強く紐付ける（横取り防止）

### 3) 重要操作としてのstep-upとの接続
- 3DSが存在しても、返金やカード変更など“別の重要操作”は step-up（再認証/MFA）対象にする
- 3DSは決済の本人性であって、運用操作の本人性ではない（境界を混同しない）

---

## 金額・割引・通貨の境界：クライアント入力を“計算に使わない”
### 1) サーバ側再計算（絶対）
- 金額（amount）はサーバが確定する
  - 商品価格、数量、税、送料、クーポン、ポイント、手数料
- クライアントは “購入意思の表明” と “選択” まで
  - 例：クーポンコード入力、配送方法選択
- サーバはその結果を検証し、確定した金額だけでPSPにリクエストする

### 2) Price-lock（価格ロック）の必要性
- 決済開始から完了までに価格が変わり得る（在庫、セール、為替）
- 対策
  - 注文作成時点で価格スナップショットを持ち、決済完了まで固定
  - 期限切れなら注文を再計算して再決済（境界を仕様化）

### 3) 典型の改ざん点（診断観点）
- amount/currencyの直接改ざん
- item_id/quantityの改ざん（価格の低いSKUへすり替え）
- coupon_id/discount_rateの改ざん（不正割引）
- shipping_methodの改ざん（送料0）
- “税”の扱い（免税や税込/税抜の境界）

---

## Webhook（決済結果通知）の信頼境界：偽造・再送・順序逆転を前提にする
### 1) Webhookで起きる現実
- 同じイベントが複数回来る（再送）
- 順序が入れ替わる（captureより先に別イベントが来る等）
- 遅延する（数分〜）
- 攻撃者が到達できる面がある（受信エンドポイントが公開）

### 2) 必須要件（設計として固定）
- 署名検証（HMAC/署名）：検証前に副作用を起こさない
- 冪等（idempotency）：event_idで一回だけ処理する
- 順序耐性：状態遷移は現在状態に対して妥当な遷移のみ許可（state machine）
- 監査ログ：trace_id + event_id + decision + reason を残す

（詳細接続：`04_api_04_webhook_受信側の信頼境界（署名_再送）.md`、`04_api_06_idempotency_レースと二重実行境界.md`）

---

## 返金（Refund）の境界：最も悪用されやすい“運用重要操作”
### 1) 返金の種類と境界
- 全額返金 / 部分返金
- 即時取消（void/cancel：未確定の取り消し）と返金（refund：確定後の返金）
- 返金理由コード（運用監査と不正検知で重要）

### 2) 権限分離（誰が返金できるか）
- 顧客自己返金（返品フロー等）
  - 顧客ができるのは「返金申請」まで、実行はサーバ側のポリシーで決定
- CS（運用）返金
  - RBAC（ロール）＋上限（amount threshold）＋二人承認（高額）
- 管理者返金
  - 例外扱いとして監査強化（全操作ログ + 理由必須 + アラート）

### 3) 返金の実装で必ず必要な制約
- 対象整合
  - refund対象の transaction_id は、その注文（order_id）に紐づくものだけ
- 上限
  - 返金合計は captured/settled の金額を超えない
  - 部分返金の合計と残高をサーバ側で管理
- 冪等
  - 同じ返金要求（refund_id）を重複処理しない
- レース耐性
  - 同時に複数返金を叩いて合計超過しない（排他/トランザクション）

---

## 二重請求・二重返金（レース/再試行/多重送信）の境界
### 1) 典型原因
- フロントの多重クリック（支払うボタン連打）
- ネットワーク再送（タイムアウトでリトライ）
- Webhook再送
- 非同期処理の再実行（ジョブ再試行、ワーカー再起動）

### 2) 対策の設計パターン
- UI：ボタン無効化＋状態表示（補助）
- API：冪等キー（idempotency key）で同一要求を束ねる（本体）
- DB：ユニーク制約（order_idに対してpayment_intentは1つ等）
- state machine：遷移の妥当性で弾く
- 監査ログ：拒否理由を残し、運用が判断できる

---

## 決済の“検知と証跡”：不正より先に運用で揉めるので最初から固める
### 1) 監査ログ（最低限）
- actor（user/service/admin）、tenant、order_id、payment_id、action（capture/refund/cancel）、amount、currency
- decision（allow/deny）と reason（上限超過、状態不整合、権限不足、署名不正）
- trace_id / request_id（横断追跡）
- 高影響操作は “理由必須” を要件化する

### 2) アラート（検知の定石）
- 同一注文で短時間に複数の決済試行（不正/障害）
- 同一ユーザ/同一IPで多数の決済失敗（カード試行）
- 返金が連続・高額・営業時間外・新規権限付与直後
- Webhook署名不正/再送過多/順序異常

### 3) 機微情報の取り扱い
- PAN等のカード情報は保持しない（トークン化/PSP委譲）
- ログに payment_intent の完全値や署名ヘッダを丸ごと残さない（必要ならマスク）
- Secrets/鍵は `06_config_02_Secrets管理...` と一体で扱う

---

## 診断観点（観測→判断→次の一手）
### 1) “クライアント信頼”の有無を潰す（最優先）
- 観測
  - リクエストで amount/currency/discount 等が送られているか
  - サーバがそれをそのままPSPへ流していないか
- 判断
  - 送っているだけは許容され得るが、「サーバ再計算していない」なら危険
- 次の一手
  - サーバ側で再計算（価格スナップショット）と検証を実装

### 2) 3DS結果の確定点
- 観測
  - 3DS完了後の遷移が “フロントの戻り値” で成功扱いになっていないか
- 判断
  - 成功表示＝成功確定ではない。PSP照会/署名イベントが必要
- 次の一手
  - PSP側の状態照会で authorized/captured を確定し、state machineへ反映

### 3) Webhook境界
- 観測
  - 署名検証があるか、失敗時に副作用がないか
  - event_idで冪等か、順序逆転に耐えるか
- 判断
  - “署名だけ”では足りない（再送・順序が残る）
- 次の一手
  - 署名＋冪等＋状態遷移検証の3点セットで是正

### 4) 返金/取消の権限境界
- 観測
  - 返金APIが顧客から直接叩けないか（IDOR/BOLA）
  - 運用UIの権限分離、上限、二人承認があるか
- 判断
  - 返金は即impact。最優先で境界を締める
- 次の一手
  - RBAC + 上限 + 監査ログ + step-up を導入、レースと冪等を追加

### 5) 二重実行（レース）
- 観測
  - 多重クリック/リトライで二重請求・二重返金にならないか
- 判断
  - UI対策だけでは不十分。API/DBが本体
- 次の一手
  - idempotency key + DB制約 + state machine を実装

---

## よくある失敗パターン（実務で刺さる）
1) amountをクライアントで計算し、そのままPSPへ送る（改ざんで即死）
2) 3DSの成功をフロントの戻り値で確定してしまう（偽装/分岐で崩れる）
3) Webhook署名はあるが、再送・順序逆転・冪等がない（二重処理）
4) 返金権限が広すぎる（CS全員無制限/理由不要/監査なし）
5) 部分返金の合計管理がない（合計超過/残高不整合）
6) 冪等がなく、タイムアウト再試行で二重請求
7) ログにトークン/署名/カード情報が混入（二次被害）
8) 管理API/運用UIにstep-upがなく、セッション再利用で不正返金される

---

## 04_labs（手を動かす：状態遷移と境界を再現して腹落ちさせる）
- Lab候補（例）
  - `04_labs/02_web/15_payment_01_amount_recalc_and_price_lock/`
  - `04_labs/02_web/15_payment_02_3ds_result_verification_boundary/`
  - `04_labs/02_web/15_payment_03_webhook_signature_idempotency_ordering/`
  - `04_labs/02_web/15_payment_04_refund_rbac_threshold_dual_approval/`
  - `04_labs/02_web/15_payment_05_race_conditions_double_charge_refund/`
- Lab設計要件
  - ダミー/テストPSPで、二重送信・再送・順序逆転を再現できる
  - state machineの“拒否理由”が監査ログに残る（trace_id付き）
  - 返金の権限境界（RBAC/上限/二人承認）を切り替えて比較できる

---

## コマンド/例（例示は最小限：意味→判断→次の一手を優先）
~~~~
# 仕様として固定すべき要点（例）
# - amount/currency はサーバ再計算＋価格スナップショットで確定（client申告を計算に使わない）
# - 3DS結果/決済結果はPSPの確定状態で遷移（clientのsuccess表示を信じない）
# - webhook：署名検証→冪等(event_id)→状態遷移検証（順序逆転耐性）
# - refund：RBAC + 上限 + 二人承認(高額) + step-up + 監査ログ（理由必須）
# - レース：idempotency + DB制約 + state machine で二重請求/二重返金を潰す
~~~~

---

## 深掘りリンク（最大8）
- `01_topics/02_web/03_authz_06_privileged_action_重要操作（承認_送金_権限）.md`
- `01_topics/02_web/02_authn_16_step-up_再認証境界（重要操作_再確認）.md`
- `01_topics/02_web/04_api_04_webhook_受信側の信頼境界（署名_再送）.md`
- `01_topics/02_web/04_api_06_idempotency_レースと二重実行境界.md`
- `01_topics/02_web/04_api_01_権限伝播モデル（フロント_バックエンド_ジョブ）.md`
- `01_topics/02_web/11_logging_tracing_相関IDと証跡設計.md`
- `01_topics/02_web/13_session_replay_再利用と検知（ua_ip_binding）.md`
- `01_topics/02_web/06_config_02_Secrets管理と漏えい経路（JS_ログ_設定_クラウド）.md`
