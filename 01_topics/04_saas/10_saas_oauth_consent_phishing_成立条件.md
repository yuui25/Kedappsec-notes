# SaaS OAuth同意フィッシング（Consent Phishing）成立条件

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：V2（認証：外部IdP連携の前提/例外パス）、V3（セッション/トークン：失効・更新・回収）、V4（アクセス制御：スコープ/同意=権限付与の境界）、V14（設定：外部連携・監査・運用）
- WSTG：認証（SSO/OAuth/OIDCのテスト観点）、認可（委任権限/スコープ境界）、設定/運用（テナント設定、監査ログ、許可アプリ制御）  
  ※本テーマは「アプリに対する権限付与（同意）」が成立点のため、WSTGの“認証そのもの”より「権限付与の境界（委任/同意/スコープ）」として接続する
- PTES：Intelligence Gathering（SaaS/IdP構成把握）→ Threat Modeling（同意=権限付与の境界化）→ Vulnerability Analysis（設定・例外パス・許可範囲）→ Exploitation（検証環境での再現）→ Reporting（是正案/検知案）
- MITRE ATT&CK：T1528（Steal Application Access Token：同意により取得したトークン悪用）、T1566（Phishing：誘導が必要な場合）、Persistence（Refresh token/アプリ同意の残存）

## 目的（この技術で到達する状態）
「SaaSのOAuth/OIDC同意（Consent）」が、どの条件で“実質的な権限昇格/持続的アクセス”に変わるかを、**境界（資産/信頼/権限）**として説明できる状態になる。  
具体的には、次を判断できる状態をゴールにする。

- 同意が「単発のログイン」ではなく「アプリに継続アクセス権を付与する操作」になっているか
- “誰が”同意できるか（一般ユーザ/管理者/特定グループ）という権限境界がどこにあるか
- 付与される権限の強さ（スコープ、委任/アプリ権限、オフラインアクセス、テナント全体影響）を、観測から見分けられるか
- 監査ログから「同意→トークン利用→データアクセス」を相関できるか（検知・封じ込めに直結）

## 前提（対象・範囲・想定）
- 対象：SaaS（M365/Google Workspace/Slack/GitHub/Atlassian/Okta等）における **OAuth 2.0 / OIDC** の「同意（Consent）」を用いた権限付与
- 想定：外部からの侵入初期段階〜侵入後横展開の入口として、**“ユーザが自分で許可できる範囲”**を悪用される（または管理者同意が誤って広い）
- 実施条件（重要）：
  - 実環境で“人を騙す”検証はしない。検証は必ず **検証テナント/検証ユーザ** で行い、同意画面・監査ログ・トークン失効までを再現する。
  - 本ファイルは「成立条件の理解と、設定点検・観測・検知設計」を目的とする（攻撃手順の提供ではない）。

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
Consent Phishing は「ユーザ/管理者が、IdPが提示する正規の同意画面で許可してしまう」ことで成立する。  
したがって観測は **(1)同意画面の情報、(2)付与された権限の実体、(3)トークンの性質、(4)利用ログ** を軸にする。

### 1) 権限境界：同意できる主体（User consent / Admin consent）
- 観測対象：
  - ユーザ同意が許可されているか（全許可/制限付き/禁止）
  - 管理者同意（テナント全体）を誰が実行できるか、申請ワークフローがあるか
- 観測の意味：
  - **同意=権限付与** であり、Id/PWやMFAを突破しなくても「第三者アプリ」にアクセス権を移譲できる設計になっているかを判定する
- 代表例（Microsoft Entra）：
  - ユーザ同意ポリシー（verified publisher限定/low impact限定/legacyで広い等）
  - 同意フィッシング対策ガイド（同意画面で正規ドメインを使われる前提）

### 2) スコープ境界：何へのアクセスが許可されたか（Scopes / Permissions）
- 観測対象（共通）：
  - 同意画面に表示される権限（例：メール閲覧、ファイル閲覧、チャット閲覧、組織情報、オフラインアクセス）
  - “最小権限”になっているか、過剰な権限が要求されていないか
- 追加観測（M365/Entraの典型）：
  - **Delegated permissions（ユーザ委任）** か **Application permissions（アプリ権限）** か  
    - 委任：ユーザ権限の範囲で実行（ただし大量データ閲覧が可能になり得る）
    - アプリ権限：ユーザ不在で実行（原則、管理者同意が必要で影響が大きい）
- 追加観測（Google Workspaceの典型）：
  - Admin Console の **App access control** で、アプリを Trusted / Restricted / Limited 等に分類できるか
  - “高リスク/制限付きスコープ”の扱い（許可制・ブロック・例外）

### 3) トークン境界：短命か・継続アクセスか（Access/Refresh / Offline）
- 観測対象：
  - Access token の寿命（短いのが普通）
  - Refresh token（継続アクセス）や offline_access 相当が付与されるか
  - 失効トリガ（ユーザのパスワード変更、ログアウト、管理者のリボーク、アプリ無効化）で止まるか
- 観測の意味：
  - Consent Phishing の“持続性”は、Refresh token（または同等の継続資格）と同意の残存で決まる  
  - OAuth BCP（RFC 9700）の推奨（refresh tokenの失効・ローテーション・漏えい時の封じ）に沿っているかを見る

### 4) 信頼境界：アプリの出自・検証状態（Verified publisher / Verified app / Marketplace）
- 観測対象：
  - アプリが「検証済み発行元（verified publisher）」か
  - Google の OAuth 検証（sensitive/restricted scopes verification）状態、Workspace管理者からの見え方
  - Marketplace 経由か、野良クライアントIDか
- 観測の意味：
  - “正規の同意画面”は本質的に信用されやすい。よって **信頼の補助線（検証済み、許可リスト、社内登録）** があるかが境界になる。

### 5) 証跡境界：監査ログで「同意→利用」を追えるか
- 観測対象（例）：
  - 同意イベント（誰が、どのアプリに、どの権限を、いつ付与）
  - アプリ（client_id）によるAPIアクセスの急増、異常地域/UA/IP、短期間での多人数同意
  - 既知アプリAllowListと突合できるか
- 観測の意味：
  - “侵入”というより“権限付与”のため、境界は **監査と運用** で守る比重が高い（検知できないと長期化する）

## 結果の意味（その出力が示す状態：何が言える/言えない）
Consent Phishing の成立可否は「同意を取れる」だけでは決まらず、**同意の範囲と持続性**で決まる。観測結果は次の“状態”に落とす。

### 状態A：ユーザが広く同意でき、継続アクセス（refresh/offline）が成立する
- 言えること：
  - 認証突破なしで、ユーザデータへの継続アクセスが成立し得る（メール/ファイル/チャット等）
  - 追加の横展開（社内情報探索、他SaaSへの誘導、ワークフロー悪用）に繋がる入口になる
- 言えないこと：
  - ただちに管理者権限になるとは限らない（ただし運用設計次第で“管理者同意”が誘発される）

### 状態B：ユーザ同意は制限され、未検証/高リスクスコープはブロックされる
- 言えること：
  - 同意フィッシングの“広がり”が抑制される（特に野良アプリが止まる）
  - 例外承認フローが攻撃面になる（承認業務・例外パスの監視が必要）
- 言えないこと：
  - 0にはならない（正規アプリの侵害、社内登録アプリの悪用、管理者の誤承認は残る）

### 状態C：管理者同意が広く可能、または承認フローが形骸化している
- 言えること：
  - 1回の誤同意でテナント全体影響（アプリ権限/全ユーザデータ）が起き得る
  - 監査と最小権限・発行元検証が崩れると、最優先リスクになる
- 言えないこと：
  - “管理者同意=即死”と決めつけられない（スコープが弱い場合もある）。必ず権限内容を観測して評価する。

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
※ここは「攻撃手順」ではなく、ペンテスト/評価での意思決定モデルとして記載する。

### 1) 優先度の付け方（どのSaaS/どの同意を先に疑うか）
- 高優先（成立時のリターンが大きい）：
  - メール・ファイル・チャット・業務データに直結するスコープが、ユーザ同意で取れる
  - refresh/offline が取れる、または同意が長期間残る運用
  - “許可アプリ制御（AllowList/Trusted）”が無い、または形骸化
- 次点（条件次第で高くなる）：
  - 管理者同意ワークフローがあるが、審査基準が弱い/例外が多い
  - 監査ログがあるが、相関・アラートが無い（気づけない）

### 2) 典型的な攻撃目的（観測から逆算する）
- Discovery：メール/ファイル/チャットの検索で「他の入口（VPN、社内ポータル、共有鍵、請求書、外部連携）」を発見
- Credential Access：トークン/連携設定/招待リンク等の収集（T1528に接続）
- Lateral Movement：同じIdP配下の別アプリへの誘導（SaaS間の信頼を利用）
- Persistence：同意の残存とrefreshで“パスワード変更でも切れない”状態を狙う

### 3) 防御側の“弱点になりやすい境界”
- 「ユーザが同意できる範囲」が広い（利便性優先）
- “検証済み発行元のみ許可”のような信頼境界が無い
- 監査ログはあるが、**同意イベント** を監視していない（ログは“侵入”ではなく“正規操作”に見える）

## 次に試すこと（仮説A/Bの分岐と検証）
ここは“実施方法を最高に具体的に”を優先し、**設定確認→観測→再現（検証テナント）→封じ**の順で記載する。  
（実環境でユーザを騙す検証はしない）

### 仮説A：ユーザ同意が広く、野良アプリでも同意が通る（成立しやすい）
**検証（観測中心）**
1) IdP/管理画面で「ユーザ同意の許可範囲」を確認
   - Microsoft Entra：ユーザ同意ポリシーが “legacy（広い）” 相当になっていないか、verified publisher限定になっているか
2) “許可アプリの制御” があるか確認
   - Google Workspace：Security → API controls → App access control で、Unrestrictedになっていないか。Restricted時の挙動（未信頼アプリは止まり、既存トークンが失効）を把握する
3) 監査ログで「同意イベント」が取れるか確認
   - 同意/認可イベント（誰が、どのアプリに、どの権限）を抽出できる状態にする  
   - “client_id”単位で新規アプリ・短時間に多人数同意を検知できる状態にする

**再現（検証テナントでの安全な再現）**
- 検証用に「最小権限のテストアプリ」を用意し、同意画面で表示される情報（権限一覧、発行元表示、未検証警告）を観測する  
- 観測点：
  - 同意画面に表示される権限が“読めば判断できる”粒度か（曖昧な権限名になっていないか）
  - 同意後、監査ログに「誰が同意したか」が残り、追跡できるか

**封じ（最小差分の是正）**
- ユーザ同意を「verified publisher + low impact」に制限（可能な場合）
- 例外が必要なら「管理者承認ワークフロー」を前提にし、例外承認を監査対象にする
- “新規同意”を高優先でアラートする（侵入検知ではなく権限付与検知）

### 仮説B：ユーザ同意は制限されているが、例外パス（承認/許可リスト）が弱い
**検証**
1) 例外の設計を確認
   - 例外承認の基準（誰が承認、何を確認、期限、取り消し手順）
   - “Trustedにしたら全スコープ許可”のような大雑把運用になっていないか（Googleはスコープ単位の制御が進化しているため、可能なら粒度を上げる）
2) 例外の監査
   - 例外登録（Trusted/許可リスト追加）イベントが監査ログで取れるか
   - 例外を付けたアプリの利用量を監視できるか

**再現（検証テナント）**
- “Restricted→例外で許可”の運用を再現し、許可後にどこまでのスコープが通るか、追加スコープ要求時に再同意が必要かを観測する（製品差が出るポイント）

**封じ**
- 例外は期限付き（見直し）を基本にする
- 例外アプリの client_id をAllowList化し、同一client_id以外を拒否する設計を検討する（可能なSaaSに限る）

### 仮説C：管理者同意（テナント全体同意）が広く可能で、誤承認の影響が最大化する
**検証**
1) 管理者同意が誰でもできる/グループが広い/申請が形骸化、のいずれかを確認
2) “アプリ権限（Application permissions）” の承認がどの程度発生しているか棚卸し
3) 監査ログで “admin consent” を確実に抽出できるか（抽出できない場合、それ自体が運用品質の問題）

**封じ**
- 管理者同意の実行者を最小化し、承認フローを形式知化する（審査観点：発行元、スコープ、必要性、データ種類、失効/回収）
- “高権限スコープ” は常に追加審査（メール全件、ファイル全件、組織管理、ユーザ管理、etc.）

### 追加：検知・相関（同意→トークン利用→データアクセス）
- 検知の考え方：
  - 侵入検知ではなく **“新しいアプリに権限が付与された”** を起点にする
  - client_id 単位で、同意直後にメール/ファイル/チャットへのアクセスが急増するパターンを検知する（T1528の利用フェーズに接続）
- 相関キー（最低限）：
  - user（同意したユーザ）
  - client_id / app_id（アプリ識別子）
  - scopes/permissions（権限内容）
  - time（同意時刻と利用時刻の近接）
  - IP/UA/Geo（同意と利用の乖離、または利用だけ異常）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 認証（V2）：外部IdP/OAuthを“ログイン機構”としてだけでなく、“権限付与の入口”として扱い、例外パス（ユーザ同意/管理者同意）を管理する
  - セッション/トークン（V3）：refresh等の継続資格を前提に、失効・ローテーション・回収（同意取り消し）を運用で回せる状態にする
  - アクセス制御（V4）：スコープ=権限であり、最小権限・高権限スコープの承認統制がアクセス制御そのもの
  - 設定（V14）：許可アプリ制御、検証済み発行元、監査ログ・アラート、例外フローの統制
- WSTG：
  - 認証/SSO（OAuth/OIDC）：同意画面・発行元表示・未検証警告・フロー（Device Code等の例外フロー）を含めて観測する
  - 認可：委任権限（delegated）とアプリ権限（app-only）の境界、スコープ過剰要求、同意の持続性（refresh）をテスト観点に落とす
  - 設定/運用：テナント設定（ユーザ同意、許可アプリ制御、例外パス、監査ログ）を検証対象に含める
- PTES：
  - Intelligence Gathering：対象組織のIdP/SaaS構成、許可アプリ制御、監査ログ取得可否を把握
  - Threat Modeling：同意=権限付与の境界モデルを作り、どの主体がどこまで付与できるかを整理
  - Vulnerability Analysis：同意範囲が広い/例外が弱い/監査できない、を脆弱性（設定不備）として評価
  - Exploitation：検証テナントで再現し、監査ログで追えることまで確認
  - Reporting：最小差分の是正（制限付き同意、許可リスト、例外統制、検知）を提示
- MITRE ATT&CK：
  - T1528 Steal Application Access Token：同意により得られるトークン（およびrefresh相当）の悪用として位置づけ
  - T1566 Phishing：同意操作の誘導が必要な場合に接続（ただし実環境の人間対象検証はしない）
  - Persistence：同意の残存・refreshで継続アクセスが成立する場合に接続

## 参考（必要最小限）
- Microsoft Entra ID: Protect against consent phishing  
  https://learn.microsoft.com/en-us/entra/identity/enterprise-apps/protect-against-consent-phishing
- Microsoft Entra ID: Configure how users consent to applications（ユーザ同意ポリシー/verified publisher等）  
  https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/configure-user-consent
- IETF RFC 9700: OAuth 2.0 Security Best Current Practice（refresh tokenの扱い等）  
  https://www.rfc-editor.org/rfc/rfc9700.pdf
- Google Workspace Admin Help: Control which third-party & internal apps access Google Workspace data（App access control）  
  https://support.google.com/a/answer/13152743
- Google Developers: Google WorkspaceのOAuth production readiness（管理者による制限・検証の考え方）  
  https://developers.google.com/identity/protocols/oauth2/production-readiness/google-workspace
- MITRE ATT&CK: Detection Strategy for T1528（SaaSでのOAuthトークン悪用検知の考え方）  
  https://attack.mitre.org/detectionstrategies/DET0515/
