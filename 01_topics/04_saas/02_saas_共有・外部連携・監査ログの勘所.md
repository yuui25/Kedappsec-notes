<<<BEGIN>>>
# 02_saas_共有・外部連携・監査ログの勘所.md

（先頭要約：ガイドライン対応の位置づけ）
- ASVS：共有/外部連携/監査はアプリ境界を越えて成立する“運用上のセキュリティ要件”。Secrets/権限/監査の観点を、SaaS上の境界として扱う
- WSTG：外部連携（Webhook/API/OAuthアプリ）や共有公開は、Web側のAuthZ/設定検証と直結するため“検証の前提”として落とす
- PTES：Intelligence Gathering で越境点（共有/外部連携）を固め、Vulnerability Analysis で影響が大きい境界崩壊（外部公開/委任/監査欠落）を優先する
- ATT&CK：Collection/Exfiltration/Defense Evasion を、SaaSの共有/連携/監査の“状態”として整理する

## 目的（この技術で到達する状態）
- SaaSにおける「共有」「外部連携」「監査ログ」を、サービス別の設定項目暗記ではなく、**境界（資産/信頼/権限）**として説明できる。
- “共有は便利”の裏側で、どの条件で **外部へ権限やデータが伝播するか** を判断し、検証の優先度を作れる。
- 監査ログを防御議論のためではなく、**検証の再現性・説明力**を上げるために使える（何が追える/追えないを状態で説明できる）。

## 前提（対象・範囲・想定）
- 対象：許可範囲のSaaS（例：ファイル/コラボ/チケット/CI/CD/監視）と、外部連携（Webhook、外部アプリ、API連携）。
- 想定：
  - 共有は「リンク公開」「ゲスト招待」「組織外共有」など複数の越境形態がある
  - 外部連携は “設定した瞬間” に信頼境界が広がる（第三者が継続的にデータへ触れる）
  - 監査ログは「残る/残らない」「誰が見られるか」自体が権限境界になる
- 依存（前段の接続）：
  - `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
  - `01_topics/02_web/06_config_設定・運用境界（CORS ヘッダ Secrets）.md`
- やらないこと：
  - SaaS製品ごとの設定項目羅列
  - “落とし穴”章は作らない

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 共有（Sharing）を“権限伝播”として観測する
- 観測するもの（状態で捉える）
  - 共有の単位：ファイル/フォルダ/プロジェクト/チャンネル/チケット
  - 共有の範囲：組織内限定 / 外部ゲスト / リンク公開 / 誰でも
  - 共有権限：閲覧/コメント/編集/管理
  - 有効期限・失効：期限設定、取り消し、再共有の可否
- 意味（状態）
  - 「誰が、どの範囲で、どの操作をできるか」の権限境界が、組織外へ伝播しているか
- 次の一手
  - 外部共有があるなら、最優先で“資産境界（対象データ）”と“信頼境界（外部主体）”を確定する

### 2) 外部連携（Integration）を“信頼境界の拡張”として観測する
- 典型の越境点（名前より状態）
  - Webhook：イベントが外部へ送られる（データが外へ出る）
  - 外部アプリ（OAuthアプリ等）：委任（scope）で外部が継続的アクセスを持つ
  - API連携/サービスアカウント：長期鍵で自動処理が走る
  - 連携ストレージ/バックアップ：コピーが生まれ、資産境界が増える
- 意味（状態）
  - “第三者が継続的に触れる”状態になると、侵害時の影響が大きくなる（横展開/情報流出の導線）
- 次の一手
  - 連携は「何が送られるか」「どこへ送られるか」「止められるか（失効/削除）」を最小で確定する

### 3) 監査ログ（Audit/Activity Log）を“再現性と境界”として観測する
- 観測するもの
  - どのイベントが記録されるか（ログイン、共有変更、外部アプリ同意、権限変更、ダウンロード等）
  - 誰が閲覧できるか（管理者/セキュリティ担当/一般）
  - 保存期間・検索性（過去に戻れるか）
- 意味（状態）
  - 監査ログは「攻撃を見つける」だけでなく、「検証を説明できる」ことに直結する
  - 監査ログへのアクセス権自体が権限境界（ログは機密データになり得る）
- 次の一手
  - “追える/追えない” を確定し、検証設計（証跡）を変える（Proxyログ、SaaSログ、クラウドログの組み合わせ）

### 4) “境界が崩れると何が起きるか”を短い文章で持つ
- 共有が崩れる：組織外へデータ/権限が伝播し、回収不能になり得る
- 外部連携が崩れる：第三者が継続的アクセスを持ち、連鎖的にデータが出る
- 監査が弱い：事後説明ができず、検証・対応が遅れる（再現性が落ちる）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（確定できる）
  - 共有の境界（誰に、どこまで、何ができるか）
  - 外部連携の境界（どこへ、何が、どの条件で出るか）
  - 監査の境界（何が残り、誰が見られ、どこまで遡れるか）
- 推定（追加観測で強くなる）
  - 影響範囲（コピー/再共有/外部アプリの連鎖）
  - 監査欠落による説明困難性（どこがブラックボックスか）
- 言えない（この段階の限界）
  - 個別SaaSの全設定（本ファイルは“観測の軸”）
  - 組織ポリシーの意図（許可/禁止の理由）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
### 優先度（越境が大きい順）
1) 外部アプリ同意（OAuth委任）・サービスアカウント（長期鍵）
2) リンク公開・外部ゲスト（共有の越境）
3) Webhook/API連携（継続的な外部送信）
4) 監査ログ閲覧権限（検知回避・証跡消しの足場になり得る）

### 攻め筋（“設定”をWeb/NWに接続する）
- OAuth委任が絡む → `03_creds` と `01_idp` に接続（scope/期限/失効）
- 共有が絡む → Web側のAuthZ（IDOR/共有URLの扱い）と接続
- 監査が絡む → Labsの証跡設計（Proxy/クラウドログ）へ接続

### 次の仮説（どこへ進むか）
- 委任/トークンが鍵 → `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- SSO/属性が鍵 → `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- Web側の共有/権限が鍵 → `01_topics/02_web/03_authz_認可（IDOR BOLA BFLA）境界モデル化.md`

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：外部アプリ（OAuth委任）が存在し、長期権限になっている
- 検証（A/B）
  - A：委任されたscopeと対象（どのデータ/機能に効くか）を観測で確定
  - B：失効/削除/再認可の挙動を観測し、期限と回収可能性（境界）を確定
- 期待する観測
  - “どの第三者が、どこまで、いつまで触れるか”が状態で説明できる

### 仮説B：共有（リンク公開/外部ゲスト）が多く、資産境界が崩れやすい
- 検証（A/B）
  - A：共有単位と権限（閲覧/編集/管理）を観測で確定
  - B：再共有/コピー/検索可否など、外部へ広がる条件を観測で確定
- 期待する観測
  - “回収不能になり得る条件”が説明でき、優先度が付けられる

### 仮説C：監査ログが弱く、検証の再現性が取りづらい
- 検証（A/B）
  - A：どのイベントが残るかを確認（共有変更、外部アプリ同意、権限変更）
  - B：誰が見られるか（権限境界）を確認し、証跡設計（Proxy/クラウドログ）へ反映
- 期待する観測
  - “追える/追えない”が確定し、検証手順を安全に組める

### 例示（最小の観測：コマンドは補助）
~~~~
# 例：SaaS画面上で「外部アプリ」「共有設定」「監査ログ」への導線を確認し、
# 何が境界（誰に、どこまで、いつまで）かをメモに落とす。
# 主役は画面操作ではなく、境界の言語化と差分観測。
~~~~

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 秘密情報（トークン/鍵）、権限制御（共有/ゲスト/ロール）、監査（ログ）がSaaS上で成立するため、運用境界として扱う
- WSTG：
  - 設定ミス・外部連携・共有公開はWebテストの一部として、境界越え（誰が何にアクセスできるか）で整理する
- PTES：
  - Intelligence Gathering：共有/外部連携/監査の越境点を把握
  - Vulnerability Analysis：影響が大きい境界崩壊（外部公開/委任/監査欠落）を優先
- MITRE ATT&CK：
  - 戦術：Collection（データ取得）、Exfiltration（外部共有/連携）、Defense Evasion（監査回避の足場）、Privilege Escalation（管理権限/委任）等
  - 目的に対し「どの境界が崩れるか」を状態として説明できるようにする

## 参考（必要最小限）
- `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- `01_topics/02_web/03_authz_認可（IDOR BOLA BFLA）境界モデル化.md`
- `01_topics/02_web/06_config_設定・運用境界（CORS ヘッダ Secrets）.md`

<<<END>>>
