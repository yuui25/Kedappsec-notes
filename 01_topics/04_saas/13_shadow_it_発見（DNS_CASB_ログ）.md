# 13_shadow_it_発見（DNS_CASB_ログ）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：V7（Logging and Monitoring）を中心に「SaaS利用の可視化＝ログの完全性・相関可能性」として扱う。加えて、V4（Access Control）/ V14（Configuration）を“Shadow ITの統制（許可/遮断/例外）”の観点で接続する
- WSTG：WSTG-CONF-02（ログアクセス制御/ログレビュー）を中心に、「ログ閲覧・抽出権限が分離され、レビュー運用が成立しているか」を検証観点として接続する（Shadow IT は“アプリ/サービスの構成・運用”に依存）
- PTES：Intelligence Gathering（外部・内部の利用実態把握）→ Vulnerability Analysis（未管理SaaSのリスク評価）→ Reporting（可視化の根拠と改善提案）に接続
- MITRE ATT&CK：T1526（Cloud Service Discovery）を中心に、Discovery（利用サービスの把握）/ Defense Evasion（監視外の経路作り）/ Persistence（同意済みアプリの継続利用）を“守る側が観測できる/できない境界”として扱う

---

## 目的（この技術で到達する状態）
組織内で利用されているSaaS（承認/未承認、業務/私用、正式/野良）を、**DNS と CASB（Cloud Discovery）と各種ログ**の組み合わせで発見し、以下を“再現可能な根拠”として提示できる状態にする。

- 何が使われているか（SaaS/ドメイン/アプリカテゴリ）
- 誰が使っているか（ユーザ/端末/拠点/部門）
- どう使っているか（Webアクセス、API連携、OAuth同意、エージェント/クライアント）
- いつから/どの程度使われているか（時系列、増減、ピーク）
- どの統制で止められるか（DNS/プロキシ/CASB制御/IdP制御/端末制御）

ここでいう“発見”は、単に一覧を作るだけではなく、**統制に繋がる分類（許可・条件付き許可・要審査・遮断）**まで落とし込むことを目的とする。

---

## 前提（対象・範囲・想定）
- 対象：
  - DNSログ（社内リゾルバ、フォワーダ、DoH/DoTの検知補助、EDR/プロキシのDNSイベント）
  - CASB（例：Microsoft Defender for Cloud Apps の Cloud Discovery / log collector / endpoint integration）
  - ネットワーク/境界ログ（プロキシ、FW、SWG、SASE、VPN、NAT、CASB連携）
  - SaaS側監査ログ（可能なら：OAuth同意・アプリ接続・トークン発行/失効・外部共有）
  - IdPログ（Entra/Okta/Google）：サインイン、条件付きアクセス/ポリシー適用、アプリ利用
- 境界：
  - 資産境界：対象は「組織ネットワーク/管理端末」か、「BYOD/社外」まで含むか（含めるほど DNS だけでは見えない）
  - 信頼境界：DNS→（外部）SaaS、IdP→（外部）SaaS、CASB→（外部）SaaS の3本線がある（どの線が観測できるかが差分）
  - 権限境界：ログ閲覧/抽出権限、アプリ制御権限（遮断・許可・例外）を分離する（“見える人”と“止める人”が違うことが多い）
- 想定ユースケース（実務）：
  - 監査/棚卸：未承認SaaSの利用実態把握、部門別の利用傾向
  - 侵害対応：攻撃者が“監視外のSaaS”へ持ち出した/連携した兆候の追跡
  - ペンテスト：組織が“Shadow IT 経路”を観測/統制できるか（検知・証跡・対応導線）

---

## 観測ポイント（何を見ているか：プロトコル/データ/境界）

### 1) 観測の基本モデル（DNS→HTTP→SaaS操作）
Shadow IT の入口は多くが「ドメイン到達」から始まるため、まず DNS を“最小観測点”に置く。

- DNSログが語ること：
  - 「その端末/ネットワークが、そのFQDNを解決しに行った」＝到達意図/到達試行
  - CNAME 連鎖やCDN経由により、**“実サービスの正体”がドメイン単体では見えにくい**（SaaS分類にCASBが効く理由）
- DNSログが語れないこと：
  - 実際にログインしたか（認証の成否）
  - 何を操作したか（権限変更/データ操作）
  - API連携（OAuth同意）をしたか（別ログが必要）

したがって、DNSは“入口の網”であり、**CASB（分類）と IdP/SaaS監査ログ（操作証跡）で確定する**。

---

### 2) DNSログで最低限揃えるフィールド（相関のための必須）
- event_time（UTC推奨）
- client（端末IP / NAT前IP / 端末ID が取れるなら最優先）
- user（可能なら：DHCP連携、端末認証、EDRのユーザ文脈）
- query_name（FQDN）
- qtype（A/AAAA/CNAME/TXT/SRV 等）
- rcode（NOERROR/NXDOMAIN/SERVFAIL）
- response（回答IP、CNAME先、TTL）
- resolver_view（内部/外部、拠点、VLAN、VPN などの文脈）

相関の観点：
- DNSだけで“誰が”が取れない場合が多い。最低でも **端末IP→端末資産台帳→利用者** の導線を設計しておく。

---

### 3) CASB（Cloud Discovery）の観測点（DNSより“サービス確度”が上がる理由）
CASBのCloud Discoveryは、主に「プロキシ/FWログ」や「エンドポイント統合」により、アクセス先をクラウドアプリとして分類・評価する。

- 典型の入力：
  - Firewall/Proxy のトラフィックログ（FQDN/SNI/URLカテゴリ/アプリ識別）
  - エンドポイント統合（例：EDRのネットワーク保護/検知）による端末外（社外）の可視化拡張
  - 解析（パース）成功が前提：ログ形式の一致、時刻、送信元、欠損の扱い
- 得られる状態：
  - 「どのクラウドアプリが、どれくらい使われているか」をランキング化
  - アプリのリスク/カテゴリ（ストレージ、生成AI、CRM、匿名共有、個人向け等）を付与
  - その後の制御（遮断・許可・モニタ・条件付き）に繋げられる

（例：Microsoft Defender for Cloud Apps の Cloud Discovery は、ログコレクタ配備やエンドポイント統合で Shadow IT を発見し、継続監視する設計が示されている）  

---

### 4) “見えない経路”を見える化する観測（Shadow ITの本丸）
Shadow IT は「企業ネットワーク外」や「非ブラウザ経路」に逃げる。これが“観測境界”。

- 企業ネットワーク外（自宅/モバイル）：
  - DNSログ（社内リゾルバ）に出ない
  - プロキシ/FWログに出ない
  - 端末側（EDR）・CASBエンドポイント統合・IdPログで補う
- 非ブラウザ経路（ネイティブアプリ、同期クライアント、API）：
  - URLが出ない、または特定のAPIホストに集約される
  - OAuth同意/トークン利用が起点になることが多い（SaaS/IdP側ログが重要）

---

### 5) Shadow IT を“統制に落とす”ための分類軸（判断に直結）
発見したSaaSを、必ず次の軸で分類する（分類できない＝次のログが必要）。

- データ種別：PII/機密/ソースコード/顧客情報を扱う可能性
- 共有性：外部共有・匿名共有・リンク共有の有無
- 認証：SSO（IdP）経由か、ローカルID/パスワードか
- 連携：OAuth同意/SCIM/連携アプリ/APIトークンの有無
- 保管：アップロード/同期/バックアップ/エクスポートの有無
- 地理/法務：データ所在、規制、DPA等（ここは“要確認”でよいが、判断軸として置く）

---

## 結果の意味（その出力が示す状態：何が言える/言えない）

### 状態1：DNSで多数のSaaS候補が見えるが、正体が曖昧
- 言える：
  - “到達意図”は確実に存在する（利用の入口がある）
  - 部門/拠点/端末群ごとの傾向は作れる（例：特定セグメントで生成AI系が急増）
- 言えない：
  - 実利用（ログイン/操作/データ持ち出し）の断定
  - SaaS名の確定（CDN/共用ドメイン/短縮URL/埋め込みSDK等で曖昧になる）

→ 次の手：CASBでクラウドアプリ分類、またはプロキシログ/SSL可視化/IdPログへ相関。

---

### 状態2：CASBで“未承認SaaS”の利用が確定し、利用者/頻度が追える
- 言える：
  - 未承認SaaSの利用実態（誰が/どれだけ/いつ）が確定
  - 統制（遮断・要承認・監視強化）の優先順位付けが可能
- 言えない：
  - 具体的に“何をアップロードしたか”は、SaaS側監査ログやDLP/端末ログが必要

→ 次の手：上位Nサービスを対象に、SaaS側の監査ログ（共有/ダウンロード/外部招待）と突き合わせる。

---

### 状態3：企業ネットワーク外の利用が多く、DNS/CASB（ログ型）では欠落する
- 言える：
  - 現状の観測網は“社内出口”に依存している（観測境界）
- 言えない：
  - 実際の利用量（大きく過小評価される可能性）

→ 次の手：端末統合（EDR/MDM）または IdP のアプリ利用ログ（SSO経由）に主戦場を移す。

---

### 状態4：ログはあるが相関キーが足りず「誰が」が不確定
- 言える：
  - ネットワーク単位では利用実態がある
- 言えない：
  - 個人/端末単位の責任分界と対策（教育/是正/遮断）の実施根拠

→ 次の手：DHCP/資産管理/プロキシ認証/端末IDの導入など、相関設計を改善（ASVS V7の“相関可能性”として提案）。

---

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
※本章は“攻撃手順”ではなく、Shadow IT が生む「守りの盲点＝意思決定上のリスク」を、観測可能性の観点で整理する。

### 1) 監視外の保管先（個人向けストレージ/転送）に逃げると、持ち出し追跡が困難になる
- 守りの観測点：
  - DNS/プロキシ：利用“入口”は見えるが、転送した“中身”は見えない
  - SaaS監査ログ：ダウンロード/共有/外部招待が取れれば、持ち出しの“形”は追える
- 優先度判断：
  - ストレージ/転送系、匿名共有が可能なサービスは優先度を上げる（統制候補）

### 2) OAuth同意（ユーザ同意/管理者同意）で“継続アクセス”が成立すると、パスワード変更では止まらない
- 守りの観測点：
  - Google/Entra/Okta の「第三者アプリの可視化・許可/遮断」ログ
  - トークン失効/アプリ無効化の証跡（権限境界の操作ログ）
- 優先度判断：
  - “同意済みアプリが増えている”組織は、Shadow IT が単発ではなく永続化している可能性が高い

### 3) 企業ネットワーク外（私用端末/私用回線）への逃避は「DNS/CASB（ログ型）」の盲点
- 守りの観測点：
  - 端末統合（EDR/MDM）と IdP ログが無いと、実態把握が不可能
- 優先度判断：
  - “SSOを使わないクラウド”が増えているなら、統制ポイント（IdP/端末）を再設計すべき

---

## 次に試すこと（仮説A/Bの分岐と検証）

### 0) 最初に固定する（調査の骨格）
- 期間：まず直近7日（傾向把握）→ 直近24h（精査）→ インシデント時は±1h（相関）
- 単位：部門/拠点/VLAN/VPN/端末群のどれで切るか（DNSで“誰が”が弱い場合は端末群が現実的）
- 目的：棚卸（ランキング化）か、特定サービスの深掘り（統制設計）か

---

### 仮説A：社内出口（プロキシ/FW）を通る比率が高く、CASB Cloud Discovery が主戦場
やること（順序固定）：
1) 入口を2本立てで取る：DNSログ（広く）＋ プロキシ/FWログ（確度高く）
2) CASB の Cloud Discovery にログを投入し、パース成功を確認する（成功しない＝観測不能境界）
3) 上位N（例：20）サービスを「カテゴリ×リスク×利用者数×データ性」で分類する
4) 未承認の上位から、統制方針を当てる：許可（公式化）/ 条件付き許可 / 要審査 / 遮断
5) “遮断”の実装点を決める：DNSブロック（粗）/ プロキシカテゴリ（現実的）/ CASB制御（精密）

具体（観測と証跡）：
- “発見”の根拠：CASBのアプリ名、利用者数、トラフィック量、初回/最終利用時刻
- “誰が”の根拠：プロキシ認証ユーザ、端末ID、AD/IdPユーザと結合
- “いつ”の根拠：UTCで統一、増減グラフ化（週次）

---

### 仮説B：社外利用が多く、DNS/CASB（ログ型）だけでは過小評価。端末/IdPログが主戦場
やること（順序固定）：
1) IdPログ（サインイン/アプリ利用）から “利用SaaSの入口” を抽出する（SSO経由のサービスに強い）
2) 端末統合（EDR/MDM）のネットワークイベントで “社外回線の到達” を補完する
3) DNSログは「社内回線の傾向」として使い、全体推定を分割する（社内/社外）
4) OAuth同意/アプリ接続の可視化（Google/Entra 等の第三者アプリ管理）で “永続アクセス” を重点監視する

具体（観測と証跡）：
- “SSO経由の証跡”：IdPのアプリ利用・サインインログ（ユーザ、時刻、デバイス、IP）
- “端末起点の証跡”：EDRイベント（プロセス/宛先/ユーザ文脈が取れる範囲）

---

### 実施方法（最高に具体的）：DNS×CASB×ログ相関の現場手順

#### 1) DNSログで“入口の網”を作る（広く、漏れにくく）
目標：SaaS候補ドメインを漏れなく拾い、サービス分類に回せる形に整える。

- 収集点の優先順位：
  1) 社内リゾルバ（AD DNS / BIND / Unbound 等）：最も網羅性が高い
  2) フォワーダ（外部DNSへの転送点）：拠点ごとの偏りが出る
  3) 端末側イベント（EDR）：社外利用の補助になる
- 最低限やること：
  - query_name を正規化（末尾ドット、大小、IDNの扱い）
  - クライアントIPを欠かさない（NATの前で取るのが理想）
  - 時刻をUTCに寄せる（後段の相関のため）
- “SaaS候補抽出”の考え方：
  - まず eTLD+1（例：example.com）に集約し、ランキング化
  - その後に “よくあるCDN/広告/計測” を別扱いにして、Shadow IT の候補に集中する
  - 短縮URL（bit.ly等）、共有ドメイン（googleusercontent等）は“要深掘り枠”に回す（DNSだけで断定しない）

~~~~
# DNSログの例（概念）
# event_time_utc, client_ip, query_name, qtype, rcode, answers
2025-12-23T09:10:01Z, 10.0.10.25, api.some-storage.example, A, NOERROR, 203.0.113.10
~~~~

---

#### 2) CASB（Cloud Discovery）で“クラウドアプリ名”に落とす（確度を上げる）
目標：DNS候補を「クラウドアプリ」として分類し、利用実態（誰/どれくらい/いつ）を確定する。

- 入力ログを決める：
  - プロキシログ（推奨）：ユーザ識別が入りやすい
  - FWログ：ユーザが弱いが、拠点単位の傾向は取れる
- ログ投入（概念）：
  - データソース（機器種別/ログ形式）を定義
  - ログコレクタ/自動アップロードで継続投入
  - “パース成功”を確認（失敗が続く＝観測不能境界）
- 重要な見方：
  - 未承認アプリの上位
  - カテゴリ（ストレージ/生成AI/匿名共有 等）
  - リスク評価（CASBが提供するスコア/メタ情報）
  - 利用者数・トラフィック量・利用時刻の分布

（Microsoft Defender for Cloud Apps では、ログコレクタ配備やエンドポイント統合により Shadow IT を発見し、継続監視するライフサイクルが示されている）  

---

#### 3) “誰が何をいつ”へ相関（Shadow ITを統制に変える）
目標：発見した未承認SaaSについて、統制（許可/遮断/要審査）に必要な根拠を作る。

- 相関キー（現実的な優先順）：
  1) ユーザID（プロキシ認証、端末ログのユーザ文脈、IdPユーザ）
  2) 端末ID（EDR/資産管理）
  3) IP（ただしNAT/プロキシで共有される境界に注意）
  4) 時刻窓（±5分 → ±30分 → ±24h）
- 相関の基本手順：
  1) CASBで未承認上位サービスを選ぶ（例：ストレージ/生成AI）
  2) そのサービスの“利用者一覧”を引く（可能なら）
  3) 同一ユーザの IdP ログで、同時刻帯のサインイン/アプリ利用を確認する
  4) 可能ならSaaS側の監査ログで “共有/ダウンロード/外部招待/連携追加” を確認する
  5) 統制に必要な“例外パス”を特定する（業務上必要なら公式化、そうでなければ遮断）

---

#### 4) 統制の実装点（DNS/CASB/IdP/端末）を選ぶ：最短で効く順
- DNSブロック：
  - 速いが粗い（共有ドメイン/短縮URLで副作用が出やすい）
  - “まず止血”としては有効
- プロキシ/SWGカテゴリ制御：
  - 現実的。業務例外（部門/ユーザ単位）も作りやすい
- CASB（アクセス/セッション制御が可能な場合）：
  - 精密に制御できるが、設計・運用が必要（適用範囲が境界）
- IdP（アプリ許可/同意制御）：
  - OAuth同意やSSO経由の利用に効く（Shadow IT の永続化を止めやすい）
- 端末（MDM/EDR）：
  - 社外利用まで含めるなら必須。導入率が境界。

---

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - V7.2 / V7.3：ログの完全性（欠損しない収集・保持）、相関可能性（ユーザ/端末/要求ID等のキー）、ログ閲覧のアクセス制御、改ざん耐性（外部転送/保全）
  - V4 / V14（接続）：未承認アプリの統制（許可/遮断/例外）を“アクセス制御/設定管理”として運用に落とす
- WSTG：
  - WSTG-CONF-02（接続）：ログが見えるだけでなく、誰が見られるか、レビューが回るか、抽出が再現できるか（Shadow IT は運用構成依存）
- PTES：
  - Intelligence Gathering：利用実態（どのSaaSが使われているか）をログ根拠で確定
  - Vulnerability Analysis：未承認SaaSのカテゴリ/共有性/同意/統制可否でリスク評価
  - Reporting：上位サービスの統制方針（許可/条件付き/遮断）と、観測境界（見えない経路）を明文化
- MITRE ATT&CK：
  - T1526（Cloud Service Discovery）：攻撃者/利用者がクラウドサービスを探索・利用する。守りはDNS/CASB/IdPログで“発見できるか”が境界
  - Discovery / Defense Evasion / Persistence（接続）：監視外SaaSや同意済みアプリでの継続利用を、監査ログ/同意ログで追えるか

---

## 参考（必要最小限）
- Microsoft Security Blog：Shadow IT discovery（ログコレクタ配備、エンドポイント統合、継続監視）  
  https://www.microsoft.com/en-us/security/blog/2019/03/26/step-7-discover-shadow-it-and-take-control-of-your-cloud-apps-top-10-actions-to-secure-your-environment/
- Microsoft Tech Community：Defender for Cloud Apps の Shadow IT discovery（ログコレクタ/エンドポイント統合の補足）  
  https://techcommunity.microsoft.com/blog/microsoftthreatprotectionblog/microsoft-defender-for-cloud-apps%E2%80%99-shadow-it-discovery-capabilities-now-support-/4159677
- Microsoft（資料）：Defender for Cloud Apps architecture（Cloud discovery とログ/コネクタの概念）  
  https://download.microsoft.com/download/6/D/F/6DFD7614-BBCF-4572-A871-E446B8CF5D79/MSFT_cloud_architecture_security.pdf
- Google Workspace Admin Help：第三者アプリのアクセス制御（可視化/Trusted/Blocked 等）  
  https://support.google.com/a/answer/13152743
- Google Workspace Updates：OAuthアプリの可視化・制御（Shadow IT抑制の文脈）  
  https://workspaceupdates.googleblog.com/2017/07/manage-access-to-third-party-apps-with.html
