<<<BEGIN>>>
# 01_idp_連携（SAML OIDC OAuth）と信頼境界.md

（先頭要約：ガイドライン対応の位置づけ）
- ASVS：認証は“画面”ではなく“連携”で成立する。IdP連携により本人性と権限が決まるため、ASVSのAuthN/AuthZ/セッション運用の前提を支える
- WSTG：SSO/トークン/リダイレクト/セッション管理はWebテストの主戦場。SAML/OIDC/OAuthを“規格暗記”ではなく観測→意味→検証に落とす
- PTES：Intelligence Gathering で連携の境界（責任分界）を確定し、Vulnerability Analysis で攻め筋（どの誤設定が成立し得るか）に落とす
- ATT&CK：Credential Access/Privilege Escalation を、IdP連携における“信頼の崩壊”として整理する

## 目的（この技術で到達する状態）
- SAML/OIDC/OAuthを「違いの説明」ではなく、次を自分で判断できる状態にする。
  - どこが本人性の成立点か（認証境界）
  - どこで権限が決まるか（権限境界：role/group/claim/scope）
  - どこが第三者か（信頼境界：IdP/外部アプリ/連携先）
- 連携フローを観測し、**“この連携で破れると何が起きるか”** を状態で説明できる。
- Web/NW双方の視点で「認証情報（Cookie/Token/Claim）」を扱い、検証の次の一手（A/B分岐）を作れる。

## 前提（対象・範囲・想定）
- 対象：許可範囲のSSO/IdP連携（社内SSO、SaaS、業務Web、API）。
- 想定：
  - SP（Service Provider）とIdP（Identity Provider）に責任分界がある
  - 連携は「ログイン成功」だけでなく、属性（claim）で権限が決まりやすい
  - OAuthは“委任”が中心で、長期権限（refresh/consent）が絡むことがある
- 依存（前段の接続）：
  - `01_topics/02_web/02_authn_認証・セッション・トークン.md`
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- 観測基盤（推奨）：
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
- やらないこと：
  - 規格の網羅説明（RFC要約）で終わらせない
  - “落とし穴”章は作らない

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) まず“境界モデル”でフローを切る（規格名より先）
- 資産境界：守るべき対象は何か（アカウント、権限、データ、テナント）
- 信頼境界：誰を信頼しているか（IdP、外部アプリ、外部テナント）
- 権限境界：どこで権限が決まるか（group/role/claim/scope）

### 2) SAML / OIDC / OAuth を“役割”で捉える（暗記しない）
- SAML：主に“企業SSO”で使われることが多い（主語は組織）
  - 重要観測：Assertion（誰で、どの属性か）、Audience/Recipient、署名、RelayState
- OIDC：OAuthの上に“本人性（IDトークン）”を載せる（主語はユーザー）
  - 重要観測：ID Token / Access Token、iss/aud/sub、nonce/state
- OAuth：主に“委任”の枠組み（主語は権限の委任）
  - 重要観測：client_id、redirect_uri、scope、consent、refreshの扱い

### 3) 入口で必ず取る観測（最小セット）
- 認証開始点（どのURL/どのアプリがトリガ）
- リダイレクト連鎖（どこへ飛ぶか：SP→IdP→SP）
- 付与される材料（Cookie/Token/Assertion）
- 権限に効く属性（group/role/tenant/scope 等）
- 例外時の挙動（state/nonce不一致、署名失敗、期限切れ）

### 4) “何を固定し、何を変えるか”で検証設計する
- 固定するもの（まず変えない）
  - 認証主体（同一ユーザー）、同一ブラウザ/セッション、同一入口
- 変えるもの（A/B差分）
  - パラメータ（state/nonce/redirect_uri 等）
  - 属性（role/group/tenant/scopeに関係しそうな要素）
  - 連携先（別クライアント/別アプリ）
- 目的
  - “どの境界が効いているか”を観測で確定し、攻め筋を絞る

### 5) 典型論点を“状態”として持つ（断定しない）
- リダイレクトの境界：戻り先がどこまで許されるか
- トークン/アサーションの境界：誰が発行し、誰が検証するか
- 属性連携の境界：どの属性が権限に効き、どこで決まるか
- 委任（OAuth）の境界：どのscopeが、どの期間、どの対象に効くか

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言える（確定できる）
  - 認証の成立点（SP/IdPどちらで何が起きるか）
  - 信頼境界（どのIdP/クライアント/連携先を信頼しているか）
  - 権限境界（どの属性/claim/scopeが権限に効いているか）
- 推定（追加観測で強くなる）
  - 誤設定の可能性が高い点（例：戻り先、属性マッピング、検証の責務）
  - 監査点（どこにログが残るか：IdP/SP/プロキシ）
- 言えない（この段階の限界）
  - “脆弱”の断定（観測と最小検証が必要）
  - 属性の真のソース（HR/AD/IdP設定）までの断定

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
### 優先度（境界崩壊が大きい順）
1) 信頼境界（外部IdP/外部アプリ）を跨げる可能性
2) 権限境界（属性/claim/scope）で越権が起きる可能性
3) リダイレクト境界（戻り先/セッション結合）で本人性が崩れる可能性
4) トークンの扱い（期限/更新/保管）で長期化する可能性

### 攻め筋（SSOを“WebのAuthN/AuthZ”へ接続する）
- 認証後にアプリ側で何が権限を決めているか（claim→roleマッピング等）を、Webの `03_authz` と同じ境界モデルで扱う
- OAuthが絡む場合は “委任＝長期権限” を前提に、`03_creds` と接続して価値判断する

### 次の仮説（どこへ進むか）
- 権限が属性で決まりそう → Web側の認可へ：`01_topics/02_web/03_authz_認可（IDOR BOLA BFLA）境界モデル化.md`
- トークンが鍵になりそう → credsへ：`01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- 共有・外部連携・監査が問題になりそう → `02_saas` へ：`01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：SSO後の権限が“属性（claim）”で決まっている
- 検証（A/B）
  - A：通常ログインで、どの属性がアプリ権限に影響していそうかを観測（UI/応答差）
  - B：別ロール/別ユーザーで差分を取り、どの境界で権限が切り替わるかを確定
- 期待する観測
  - 権限境界（claim→role）が説明でき、AuthZ検証に直結する

### 仮説B：OAuthの委任（scope/consent）が長期権限になっている
- 検証（A/B）
  - A：要求されるscopeと、付与されるトークンの範囲を観測
  - B：更新/失効の挙動（期限、refresh、再認可）を観測し、境界（いつまで/どこまで）を確定
- 期待する観測
  - “どのscopeが、どの対象に、どの期間効くか”が状態で説明できる

### 仮説C：リダイレクト境界が弱そう（戻り先の扱い）
- 検証（A/B）
  - A：正規フローのredirect_uri/RelayState/stateの関係を観測
  - B：差分（許可範囲で）で、どの境界がサーバ側で強制されているかを観測
- 期待する観測
  - “どこで拒否されるか”が分かり、検証対象を最短で絞れる

### 例示（最小の観測：コマンドは補助）
~~~~
# 例：ブラウザでSSOを実行し、Proxyで「リダイレクト連鎖」「state/nonce」「token/Assertion」を観測する
# （コマンドより、観測項目の固定が主役）
~~~~

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 認証とセッションはIdP連携で成立し、権限は属性で決まり得るため、AuthN/AuthZ/セッション管理の“前提を支える技術”として扱う
- WSTG：
  - 認証（SSO）、セッション、リダイレクト、トークン/クレデンシャルの観点を、観測→意味→検証（差分）へ落とし込む
- PTES：
  - Intelligence Gathering：SP/IdP/連携先の境界（責任分界）を確定
  - Vulnerability Analysis：境界が崩れた時の影響（越権/越境/長期権限）で優先度を付ける
- MITRE ATT&CK：
  - 戦術：Credential Access（トークン/委任）、Privilege Escalation（属性での越権）、Discovery（連携構造把握）等
  - 本ファイルは、技術名より「信頼の崩れ方」を状態として整理する

## 参考（必要最小限）
- `01_topics/02_web/02_authn_認証・セッション・トークン.md`
- `01_topics/02_web/03_authz_認可（IDOR BOLA BFLA）境界モデル化.md`
- `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- `01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`

<<<END>>>