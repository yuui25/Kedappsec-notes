# ASVS L3（v5.0）Webペネトレーション実務チェックリスト
対象：**高保証レベル（L3）**。金融・医療・公共など**高リスク/高価値**なアプリ向け。ブラックボックスに加え、**必要最小限の設計情報・アカウント**の提供を受けた**グレーボックス**前提で、設計/実装/運用を**深く**検証する。  
本書は**非破壊**かつステージング環境での実施を前提とする。

---

## 0. 運用前提（L3追加注意）
- **脅威モデリング合意**：想定攻撃者・保護資産・インパクト（機密性/完全性/可用性）を共有。**優先シナリオ**（不正送金/不正在庫操作/個人情報大量漏洩 等）を明示。
- **アカウント/権限**：一般/特権/サポート/監査等**複数ロール**、**複数テナント**、APIクライアント資格情報の発行。
- **試験境界**：外部連携（IdP/OIDC・決済・ストレージ・Webhook）・ファイル処理・ジョブ処理の**可否と上限**。レート制御試験やファズは**発火回数/時間枠**を合意。
- **証跡**：HTTPログ、画面キャプチャ、**状態遷移図/シーケンス図**、データフロー図（DFD）を併記。

---

## 1. 設計/アーキテクチャ・脅威モデリング（L3必須）
- **データフロー/信頼境界**：ブラウザ⇄API⇄バックエンド⇄外部の**境界ごとに保護策**（認証/暗号/検証/監査）。
- **秘密情報/鍵管理**：KMS/Secrets管理、**鍵のローテーション**と権限、**環境変数/設定ファイルに秘密を直置きしない**。
- **セキュリティ方針**：入力検証、出力エンコード、認可の**一貫した適用点（PEP/PDP）**、失敗時の既定動作「拒否デフォルト」。
- **設計レビュースポット**：認証/認可、ファイル、外部呼出し、決済/金銭ロジック。

---

## 2. 認証（Authentication）
- **MFA**：高リスク操作に**段階的認証（Step-up）**。リカバリ手段（バックアップコード/2nd要素再発行）の**本人性確認**。
- **アカウント列挙抑止**：ログイン/リセット/登録の応答一様性・遅延均等化。
- **レート制御/アカウント保護**：パスワード/OTP/復旧の**試行制限**、IP/ASN/端末指紋の**適切な利用**（過度なトラッキングは避ける）。
- **パスワード保護**：Argon2id/bcrypt 等の**強ハッシュ**、禁止パスワードリスト、変更時の**再認証**。

---

## 3. セッション/トークン（Cookie/JWT/OIDC）
- **セッション固定化対策**：認証直後の**ID再発行**、権限昇格時の**再認証**。
- **Cookie属性**：`HttpOnly`/`Secure`/`SameSite`（クロスサイト要件時は`None; Secure`）。
- **JWT/OIDC**：`aud/iss/exp/nbf/iat`検証、**アルゴリズム固定**（混同/`none`不可）、**PKCE**、`state`/`nonce`の**使い捨て**、**リダイレクトURIの完全一致**。  
- **トークン失効/回転**：リフレッシュ回転、**再利用検知**、ログアウト/権限剥奪時の**早期失効**。

---

## 4. アクセス制御（Authorization）— 最重要
- **水平（BOLA/IDOR）**：**所有者検証**をリスト/詳細/更新全通過点で確認。**一括エクスポート/バッチ**も対象。
- **垂直**：一般→管理/監査の**機能露出**、**機能トグル**のサーバ側強制。UI非表示だけでは不十分。
- **テナント境界**：トークン内テナントIDとリソースの**整合検証**、越境禁止。共有検索/集計APIでの**フィルタ強制**。
- **Mass Assignment/BFLA**：非公開フィールドの送信、**メソッド/フィルタ/ソート**の悪用、**ドラフト→公開**の状態遷移逸脱。

---

## 5. 入力検証/テンプレート/デシリアライズ/式評価
- **XSS**：反射/格納/DOMすべて、**文脈別エンコード**＋**CSP**下での挙動（`nonce`/`strict-dynamic`/Trusted Typesの有無）。
- **テンプレート/式言語**：SSTI（`{{ }}`等の無害マーカーで兆候→限定PoC）、OGNL/SpEL/ELの**式評価暴露**。
- **SQL/NoSQL/ORM**：**ブラインド/タイミング最小観測**、**予備クエリの漏洩**、**N+1由来のDoSリスク**に対するアプリ側抑止。
- **反序列化**：型固定/許可リスト、外部エンティティ/参照の遮断、**危険ガジェット不使用**。

---

## 6. 外部呼出し/SSRF/メール・Webhook
- **SSRF**：スキーム/ポート/リダイレクト/IPv6/`@`ユーザ情報/二重解決（DNS Rebinding）等を**包括否定**。  
- **到達観測**：安全な自前のエコー先で**ヘッダ/メソッド/本文**の透過を確認。メタデータ（IMDS）遮断。  
- **Webhook/署名**：ボディ/ヘッダの**署名検証**、時刻ずれ/リプレイ対策（`timestamp`+`nonce`）。

---

## 7. ファイル/画像/アーカイブ
- **保存先**：**実行不可領域**、パス固定＋**ベースパス包含判定**。  
- **内容検証**：拡張子/マジックバイト、**MIME再判定**、**危険コンテンツ検査**（画像処理/マクロ/スクリプト）。
- **二次処理**：サムネイル/変換/解凍時の**Zip Slip**・外部呼出し・**メモリ/CPU食い尽くし**。
- **配信**：`Content-Disposition: attachment`、**キャッシュ制御**。

---

## 8. API/GraphQL/WebSocket
- **ドキュメント露出**：本番のSwagger/GraphiQL/Introspectionの公開有無、**認可保護**。  
- **GraphQL制御**：**深さ/複雑度**、**Persisted Queries**、**バッチ/エイリアス**悪用抑止。  
- **WebSocket**：**WSS**・**オリジン検証**・**認可再評価**（接続後の権限変更に追随）。

---

## 9. ブラウザ防御強化
- **CSP**：`default-src 'none'`ベース、`script-src 'self' 'nonce-...' 'strict-dynamic'`、`frame-ancestors`で埋込禁止。  
- **COOP/COEP/CORP**：**サイト分離**とリソース共有制御、クリックジャッキング/XS-Leaks抑止。  
- **Referrer-Policy** と **SRI**（外部リソース）。

---

## 10. データ保護/暗号
- **TLS**：TLS1.2+、安全なスイート、再交渉/圧縮無効。  
- **保存暗号**：AES-GCM等、KMS鍵、**ローテーション**。  
- **ハッシュ**：Argon2id/bcrypt、**パラメータ調整**（メモリ/反復）。  
- **最小化/マスキング**：不要データの**収集回避/早期削除**、ログ/画面の**秘匿化**。

---

## 11. ロギング/監査証跡/検知
- **監査ログ**：`誰が/何に/何を/いつ/どこで`、前後値（機微はハッシュ）、**改ざん検知**（外部転送/署名）。  
- **セキュリティイベント**：ログイン失敗/ロック/権限変更/設定変更/エクスポートの**通知**。  
- **相関ID**：リクエスト単位の**Correlation-ID**。**過度な個人情報の記録禁止**。

---

## 12. 供給網/依存関係/ビルドの健全性
- **SCA/SBOM**：依存関係の**固定/監視/更新手順**。  
- **ビルド署名/プロベナンス**：ビルド成果の出所証明。  
- **SecretsのCI混入防止**：スキャン、**最小権限トークン**、**環境分離**。

---

## 13. ビジネスロジック/不正利用
- **レート/クォータ**：機能/ユーザ/テナント別の**粒度**。  
- **リプレイ/二重実行**：**Idempotency-Key**、**ワンタイムトークン**。  
- **金額/在庫/優待**：丸め/境界/クーポン併用、**越境操作**や**価格改変**。

---

## 14. エラー処理/可用性（アプリ観点）
- **例外非公開**：スタック/内部パス/構成を漏らさない。  
- **安全な既定**：失敗時は**拒否/ロールバック**、**再試行の制御**。  
- **DoS耐性（アプリ）**：**ページネーション必須**、最大件数/サイズ、**計算量の上限**。

---

## 付録A：推奨の実施順（目安：**3〜10営業日**）
1. **アーキ/脅威モデリング短セッション** → 優先シナリオ合意  
2. **外形/ヘッダ/CSP/TLS** → **認証/セッション/トークン**  
3. **アクセス制御（水平/垂直/テナント）**（最重点）  
4. **インジェクション/テンプレ/反序列化** → **SSRF/外部呼出し**  
5. **ファイル/画像/アーカイブ** → **API/GraphQL/WebSocket**  
6. **データ保護/暗号** → **ログ/監査/検知**  
7. **供給網/ビルド/Secrets** → **ビジネスロジック**  
8. **可用性/エラー** → 総合リスク整理・是正案

---

## 付録B：L2→L3 差分（要約）
- **設計レビュー/脅威モデリング**の**前提化**。  
- **トークン運用/失効/回転**、**Step-up** 等の**高度運用確認**。  
- **テナント境界/権限**の**形式的検証**（行列/テーブルで網羅）。  
- **CSP/COOP/COEP/CORP/Trusted Types** 等の**強化ヘッダ**。  
- **供給網/ビルド/署名/SBOM**、**監査ログの完全性**。

---

## 付録C：報告テンプレ（L3版抜粋）
- **ASVS 参照**：章/節/要件ID（例：*ASVS v5 “Access Control”*）。  
- **前提**：脅威モデル、環境、ロール、テナント。  
- **手順**：再現ステップ、HTTP入出力、状態遷移図。  
- **観測**：期待 vs 実測（例：JWT再利用検知が機能しない 等）。  
- **影響**：ビジネス/規制影響（漏えい件数、取引不正 等）。  
- **是正案**：設定例/実装方針/運用手順、優先度、見積もり粒度。

---

## 参考（一次情報）
- OWASP ASVS プロジェクト/ダウンロード（v5.0.0）：  
  https://owasp.org/www-project-application-security-verification-standard/
- OWASP Developer Guide（ASVSの使い方とレベル定義）：  
  https://devguide.owasp.org/en/03-requirements/05-asvs/
- OWASP Cheat Sheet Series：  
  https://cheatsheetseries.owasp.org/
- OWASP WSTG（各テスト手順の詳細）：  
  https://owasp.org/www-project-web-security-testing-guide/latest/
