# ASVS L2（v5.0）Webペネトレーション実務チェックリスト
対象：**ほとんどのWebアプリに推奨**される標準保証レベル（L2）。ブラックボックスを基本に、必要に応じて限定的な補助情報（テスト用アカウント、仕様メモ等）を用いて**実運用に近い深度**で検査する。  
レベルの位置づけは OWASP Developer Guide を参照（L2 = “Most applications”）。  
出典：ASVS v5.0 本体／DLページ、Developer Guide。

---

## 0) 運用前提（L2の追加注意）
- レート制御試験の上限合意・ステージング限定・証跡保全。**[ASVS: v5.0.0-16.1.1]**

---

## 1) HTTP/TLS/ブラウザ保護
- **CSP**（`script-src`/`style-src`/`frame-ancestors` を適切設定、nonce/hash活用）。**[ASVS: v5.0.0-3.4.3]**
- **X-Content-Type-Options: nosniff** を全応答に付与。**[ASVS: v5.0.0-3.4.4]**
- **Referrer-Policy** の適切化。**[ASVS: v5.0.0-3.4.5]**
- **HSTS**（max-age≥1年、必要に応じ includeSubDomains）。**[ASVS: v5.0.0-3.4.1]**
- **CORS** は固定Origin/許可リストで厳格化。**[ASVS: v5.0.0-3.4.2]**
- **frame-ancestors** による埋込制御（X-Frame-Optionsは非推奨）。**[ASVS: v5.0.0-3.4.6]**
- **CSPレポート** 送信先の設定。**[ASVS: v5.0.0-3.4.7]**
- **COOP** を `same-origin` 系で設定。**[ASVS: v5.0.0-3.4.8]**
- **postMessage** の送受信で Origin/型検証。**[ASVS: v5.0.0-3.5.5]**

---

## 2) Cookie / セッション管理
- `Secure`/`HttpOnly`/`SameSite` を適切付与。**[ASVS: v5.0.0-3.3.1][ASVS: v5.0.0-3.3.2][ASVS: v5.0.0-3.3.4]**
- `__Host-`/`__Secure-` 接頭辞の活用。**[ASVS: v5.0.0-3.3.3]**
- 認証成功時の **セッショントークン再発行**。**[ASVS: v5.0.0-7.2.4]**
- **ログアウト時失効**・**セッション一覧/強制終了**。**[ASVS: v5.0.0-7.4.1][ASVS: v5.0.0-7.5.2]**
- **アイドル/絶対タイムアウト** の設定。**[ASVS: v5.0.0-7.3.1][ASVS: v5.0.0-7.3.2]**

---

## 3) 認証（Authentication）
- ログイン/リセット/登録の **列挙抑止**。**[ASVS: v5.0.0-6.3.8]**
- **試行制限/遅延** 等のレート制御。**[ASVS: v5.0.0-6.1.1][ASVS: v5.0.0-6.3.1]**
- パスワード：**最小長≥8**、弱PW拒否、構成強制は**原則禁止**、ペースト許可。**[ASVS: v5.0.0-6.2.1][ASVS: v5.0.0-6.2.4][ASVS: v5.0.0-6.2.5][ASVS: v5.0.0-6.2.7]**
- **MFA提供**（高リスク操作での利用を想定）。**[ASVS: v5.0.0-6.3.3]**
- 要素復旧/再登録の **本人性確認**。**[ASVS: v5.0.0-6.4.3]**

---

## 4) アクセス制御（Authorization）
- **機能レベル認可**。**[ASVS: v5.0.0-8.2.1]**
- **オブジェクトレベル（BOLA/IDOR）**。**[ASVS: v5.0.0-8.2.2]**
- **フィールド/プロパティレベル**。**[ASVS: v5.0.0-8.2.3]**
- ルールは **サーバ側層で強制**。**[ASVS: v5.0.0-8.3.1]**
- 属性変更時の **認可再評価**。**[ASVS: v5.0.0-8.3.2]**
- **テナント境界** の分離。**[ASVS: v5.0.0-8.4.1]**
- **Mass Assignment** 防止（許可フィールド制限）。**[ASVS: v5.0.0-15.3.3]**

---

## 5) 入力検証/インジェクション/テンプレート
- DBは **パラメータ化**。**[ASVS: v5.0.0-1.2.4]**
- OSコマンド呼出しの無害化。**[ASVS: v5.0.0-1.2.5]**
- ディレクトリ/LDAP等の安全化。**[ASVS: v5.0.0-1.2.6]**
- **出力エンコード/サニタイズ**。**[ASVS: v5.0.0-1.3.1]**
- 危険な **eval** 等の排除。**[ASVS: v5.0.0-1.3.2]**
- **テンプレートインジェクション** の抑止。**[ASVS: v5.0.0-1.3.7]**
- **CSV数式注入** の抑止。**[ASVS: v5.0.0-1.2.10]**
- **XXE無効化**。**[ASVS: v5.0.0-1.5.1]**
- **反序列化** の安全化。**[ASVS: v5.0.0-1.5.2][ASVS: v5.0.0-1.5.3]**

---

## 6) SSRF / 外部呼出し
- **SSRF防止**（URL/スキーム/ホストの許可制、DNS再解決抑止）。**[ASVS: v5.0.0-1.3.6]**
- バックエンド **宛先許可リスト**。**[ASVS: v5.0.0-13.2.4][ASVS: v5.0.0-13.2.5]**
- アウトバウンドHTTPの **リダイレクト追従禁止**（必要時のみ）。**[ASVS: v5.0.0-15.3.2]**

---

## 7) ファイル/リソース
- **拡張子と内容（magic bytes）整合**。**[ASVS: v5.0.0-5.2.2]**
- **Zip Bomb対策**（伸長サイズ/件数）。**[ASVS: v5.0.0-5.2.3]**
- **ユーザ毎のクォータ**。**[ASVS: v5.0.0-5.2.4]**
- **シンボリックリンクを含む圧縮**の禁止。**[ASVS: v5.0.0-5.2.5]**
- 公開領域で **実行不可**。**[ASVS: v5.0.0-5.3.1]**
- **パス生成は内部値**＋包含判定。**[ASVS: v5.0.0-5.3.2]**
- **Zip Slip防止**（解凍時パス無視）。**[ASVS: v5.0.0-5.3.3]**
- ダウンロード時 **Content-Disposition**。**[ASVS: v5.0.0-5.4.1]**
- **安全なファイル名エンコード**。**[ASVS: v5.0.0-5.4.2]**
- 未知ファイルの **AVスキャン**。**[ASVS: v5.0.0-5.4.3]**

---

## 8) API / GraphQL / WebSocket
- **HTTP/2/3 スマグリング対策**（長さ一致/禁制ヘッダ/CRLF）。**[ASVS: v5.0.0-4.2.2][ASVS: v5.0.0-4.2.3][ASVS: v5.0.0-4.2.4]**
- GraphQL: **深さ/複雑度制限**、本番 **インスペクション無効**。**[ASVS: v5.0.0-4.3.1][ASVS: v5.0.0-4.3.2]**
- WebSocket: **WSS**・**Origin検証**・セッション連携。**[ASVS: v5.0.0-4.4.1][ASVS: v5.0.0-4.4.2][ASVS: v5.0.0-4.4.4]**

---

## 9) トークン/JWT
- **署名/MAC検証**、**alg許可リスト**、**鍵供給元許可**。**[ASVS: v5.0.0-9.1.1][ASVS: v5.0.0-9.1.2][ASVS: v5.0.0-9.1.3]**
- **有効期間（nbf/exp）** と **audience** の検証。**[ASVS: v5.0.0-9.2.1][ASVS: v5.0.0-9.2.3]**
- **用途ごとの受理**（アクセストークン/IDトークン等）。**[ASVS: v5.0.0-9.2.2]**

---

## 10) ログ/監査/エラー
- 重要イベントの **監査ログ**（認証/認可 等）。**[ASVS: v5.0.0-16.3.1][ASVS: v5.0.0-16.3.2]**
- **時刻同期**、**機微データの非記録/マスキング**。**[ASVS: v5.0.0-16.2.2][ASVS: v5.0.0-16.2.5]**
- **改ざん防止/安全転送**。**[ASVS: v5.0.0-16.4.2][ASVS: v5.0.0-16.4.3]**
- 予期せぬエラーは **一般化**（詳細はログへ）。**[ASVS: v5.0.0-16.5.1]**

---

## 11) 通信セキュリティ
- **TLS1.2+**、推奨暗号スイートのみ。**[ASVS: v5.0.0-12.1.1][ASVS: v5.0.0-12.1.2]**
- 公開向けは **公的証明書**。**[ASVS: v5.0.0-12.2.2]**
- 内部通信も **TLS/検証**（必要に応じ mTLS）。**[ASVS: v5.0.0-12.3.1][ASVS: v5.0.0-12.3.2][ASVS: v5.0.0-12.3.4]**

---

## 付録A：推奨の実施順（目安：1〜3日）
1. **外形ヘッダ/HTTPS/CSP** → **Cookie/セッション**  
2. **認証**（列挙/レート制御/リセット） → **アクセス制御（水平/垂直）**  
3. **インジェクション/XSS/テンプレート** → **ファイル/リソース**  
4. **API/GraphQL/WebSocket** → **SSRF**  
5. **JWT/トークン** → **エラー/ロギング/通信**

---

## 付録B：報告テンプレ（L2版）
- **ASVS参照**：章・節（例：*ASVS v5 “Access Control”*）。  
- **再現**：前提／手順／入出力（ヘッダ含む）／状態遷移。  
- **観測**：期待 vs 実測（CSP指令/トークン属性/認可結果 等）。  
- **影響**：攻撃シナリオ（水平/垂直/SSRFなど）。  
- **改善案**：設定例・実装指針・運用手順。  
- **証跡**：スクリーンショット/HTTPログ/時刻。

---

## 付録C：L1→L2 差分（要約）
- **ブラウザ保護の強化**（CSP/`nosniff`/Referrer-Policy）。  
- **セッション管理の厳格化**（ローテーション/失効/SameSite）。  
- **アクセス制御の深掘り**（BOLA/BFLA/テナント境界）。  
- **API/GraphQL/トークン** の本番要件（Introspection制御、JWT検証、トークン運用）。  
- **ログ/通知** と **通信安全性** の実装確認。

---

## 参考（一次情報）
- OWASP ASVS プロジェクト/ダウンロード（v5.0.0 PDF/CSV/Word）：  
  https://owasp.org/www-project-application-security-verification-standard/  
  https://owasp.org/www-project-application-security-verification-standard/migrated_content
- OWASP Developer Guide（ASVSレベルの定義・使い方）：  
  https://devguide.owasp.org/en/03-requirements/05-asvs/
- OWASP Secure Headers / HTTP Security Headers Cheat Sheet：  
  https://owasp.org/www-project-secure-headers/  
  https://cheatsheetseries.owasp.org/cheatsheets/HTTP_Headers_Cheat_Sheet.html
- OWASP Session Management Cheat Sheet：  
  https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html
- OWASP WSTG（GraphQL/API/JWT/認可 テスト）：  
  https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/12-API_Testing/01-Testing_GraphQL  
  https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/06-Session_Management_Testing/10-Testing_JSON_Web_Tokens  
  https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/README
