# ASVS L2（v5.0）Webペネトレーション実務チェックリスト
対象：**ほとんどのWebアプリに推奨**される標準保証レベル（L2）。ブラックボックスを基本に、必要に応じて限定的な補助情報（テスト用アカウント、仕様メモ等）を用いて**実運用に近い深度**で検査する。  
レベルの位置づけは OWASP Developer Guide を参照（L2 = “Most applications”）。  
出典：ASVS v5.0 本体／DLページ、Developer Guide。

---

## 0. 運用前提（L2用の追加注意）
- **同意と範囲**：権限別（一般/管理）・API/SPA・ファイル機能・外部連携（OIDC/外部API）を**明示的に含む/除外**。過負荷を避けるため**レート制御試験の上限**を合意。
- **証跡**：各試験の**HTTPログ（リクエスト/レスポンス）・画面キャプチャ・時刻**、状態遷移の図（シーケンス）を残す。
- **非破壊原則**：DB破壊・大量書込み・DoS系は不可。タイムベースの盲注は**短時間・安全なメトリクス**で観測。

---

## 1. HTTP/TLS/ブラウザ保護（L2強化）
- **CSP（Content-Security-Policy）**：`default-src` と **文脈別指令（script-src, style-src, frame-ancestors）** を設定。レポートモード→本番適用の移行方針を確認。  
  *観測点*：インラインScript許容、`unsafe-eval`/`data:` の要否、サブリソース整合、`frame-ancestors`での埋込抑止。  
  *根拠*：ASVS v5 “Communication/Headers” & WSTG Clickjacking/XSS対策、OWASP Secure Headers/HTTP Headers CS。
- **`X-Content-Type-Options: nosniff`** と **`Referrer-Policy`** の適切化。
- **HSTS**：サブドメイン含む運用（`includeSubDomains`）の妥当性。プライベート領域は除外判断。
- **CORS**：**厳格なオリジン許可**、資格情報要否（`credentials`）の整理、プリフライトの最適化。誤ったワイルドカード／任意Origin反映が無いこと。

---

## 2. Cookie/セッション管理（L2要点）
- **`HttpOnly`/`Secure`/`SameSite`**：セッションクッキーは `HttpOnly` 必須、クロスサイト要件がなければ `SameSite=Lax` 以上。外部IdP連携時はリダイレクト動作と整合。  
- **セッション固定化対策**：**認証直後のトークン再発行（ローテーション）** を確認。  
- **終了動作**：ログアウト後の**トークン失効**・再利用不可、**アイドル/絶対タイムアウト**。  
- **複数端末/Remember-me**：長寿命トークンの保存先（クッキー限定）と失効手段。  
  *根拠*：ASVS v5 “Session Management”、OWASP Session Management CS。

---

## 3. 認証（Authentication）
- **アカウント列挙抑止**：ログイン/リセット/登録で**一様な応答**（メッセージ・遅延）。
- **レート制御**：ログイン/リセット等の**試行制限・遅延・人間検知**（CAPTCHA等）を観測。
- **パスワードライフサイクル**：最小長（≥8 以上はL1相当）、禁止パスワードリスト、変更時の再認証。  
- **MFA（採用時）**：TOTP/WebAuthn等の**時限性・リセット/バックアップ**方針。  
  *根拠*：ASVS v5 “Authentication”、WSTG Authentication章。

---

## 4. アクセス制御（Authorization）— L2の肝
- **水平（BOLA/IDOR）**：**自他ID差替え**・リスト/詳細APIの**所有者検証**、**一覧→詳細→更新**の連続でサーバ側検証を観測。  
- **垂直（権限昇格）**：ユーザ権限で管理用エンドポイント・非表示機能へ**強制ブラウジング**／メソッド切替（GET⇄POST等）。
- **コンテキスト境界**：テナント/組織/環境（本番・検証）の**越境**が無いこと。  
- **API特有**：**Mass Assignment**（予期せぬフィールド送信）、**メソッド・フィルタのバイパス**。  
  *根拠*：ASVS v5 “Access Control”、WSTG Authorization。

---

## 5. インジェクション/テンプレート/デシリアライズ
- **SQL/NoSQL**：**誤差±最小のタイミング観測**や**型不整合**でプリペアド使用の兆候を確認（破壊操作は不可）。
- **テンプレートインジェクション**：サーバ/クライアント側テンプレートの**構文注入**（`{{7*7}}` 等の**無害マーカー**）で兆候確認。
- **サーバサイドインクルード/式言語**：式評価の暴露がないか（エラー/スタックトレース観測）。
- **反射/格納型XSS**：CSP下でも**DOMベース**・属性/URLコンテキストを**個別に**検査。  
  *根拠*：ASVS v5 “Validation/Encoding”、WSTG XSS/Injection。

---

## 6. SSRF・外部呼出し
- **URLハンドリング**：スキーム（`file:`, `gopher:` 等）・リダイレクト追従・DNS再解決の抑止。  
- **保護**：**内向きアドレス（127.0.0.0/8, 10/8 等）**への到達不可、メタデータ（`/latest/meta-data` 等）遮断。  
- **検査**：**安全な可観測エンドポイント**（自前の無害HTTPエコー）を使用し**ヘッダ/メソッド/本文**の到達を観測。  
  *根拠*：ASVS v5 “Files/Resources & Communication”、WSTG SSRF。

---

## 7. ファイル/リソース
- **アップロード**：拡張子/内容（マジックバイト）整合、**サーバ側MIME検証**、サイズ/寸法上限、サムネイル等の**二次処理の安全性**。  
- **保存/配信**：**実行不可領域**に保存し、ダウンロードは**強制ダウンロード**扱い（`Content-Disposition`）。  
- **パストラバーサル**：`../`・二重エンコード・Unicode正規化の**包含判定**。  
  *根拠*：ASVS v5 “Files and Resources”、WSTG File Upload/Path Traversal。

---

## 8. API/GraphQL/WebSocket
- **ドキュメント露出**：OpenAPI/Swagger/GraphiQL/`/graphql` **Introspection** の本番公開有無。  
- **BFLA（機能レベル認可不備）**：**ミューテーション/管理操作**の権限境界。  
- **クエリ制御**（GraphQL）：**深さ/複雑度制限**、バッチ/エイリアス悪用の抑止。  
- **WebSocket**：**WSS**、**オリジン検証**、サーバ側の**認可再評価**。  
  *根拠*：ASVS v5 “API & Web Service”、WSTG API/GraphQL、OWASP GraphQL CS。

---

## 9. 暗号/トークン/JWT（採用時）
- **発行/検証**：`alg` ピン留め（**`none`/アルゴリズム混同不可**）、`aud`/`iss`/`exp`/`nbf`/`iat` 検証。  
- **保存**：**`localStorage`ではなくHttpOnly Cookie** を原則。CORSと整合。  
- **ローテーション**：短寿命アクセストークン＋長寿命リフレッシュの**回転/失効**。  
  *根拠*：ASVS v5 “Data Protection/Session/Auth”、WSTG JWT、OWASP JWT/REST CS。

---

## 10. エラー処理・ロギング（外形観察）
- **スタックトレース非表示**、**一意のトラッキングID**（Correlation-ID 等）。  
- **セキュリティイベント**：ログイン失敗/ロック/パスワード変更/2FA設定変更などの**ユーザ通知**有無。  
  *根拠*：ASVS v5 “Error Handling & Logging”。

---

## 11. 通信の安全性
- **TLS**：TLS1.2+ 強制、弱暗号/圧縮/再交渉の無効化。  
- **外部サービス**：Webhook/Outboundの**署名検証**と**再生攻撃対策**。  
  *根拠*：ASVS v5 “Communication”。

---

## 付録A：推奨の実施順（目安：1〜3日）
1. **外形ヘッダ/HTTPS/CSP** → **Cookie/セッション**  
2. **認証**（列挙/レート制御/リセット） → **アクセス制御（水平/垂直）**  
3. **インジェクション/XSS/テンプレート** → **ファイル/リソース**  
4. **API/GraphQL/WebSocket** → **SSRF**  
5. **JWT/トークン** → **エラー/ロギング/通信**

---

## 付録B：報告テンプレ（L2版）
- **ASVS参照**：章・節（例：*ASVS v5 “Access Control”*）。  
- **再現**：前提／手順／入出力（ヘッダ含む）／状態遷移。  
- **観測**：期待 vs 実測（CSP指令/トークン属性/認可結果 等）。  
- **影響**：攻撃シナリオ（水平/垂直/SSRFなど）。  
- **改善案**：設定例・実装指針・運用手順。  
- **証跡**：スクリーンショット/HTTPログ/時刻。

---

## 付録C：L1→L2 差分（要約）
- **ブラウザ保護の強化**（CSP/`nosniff`/Referrer-Policy）。  
- **セッション管理の厳格化**（ローテーション/失効/SameSite）。  
- **アクセス制御の深掘り**（BOLA/BFLA/テナント境界）。  
- **API/GraphQL/トークン** の本番要件（Introspection制御、JWT検証、トークン運用）。  
- **ログ/通知** と **通信安全性** の実装確認。

---

## 参考（一次情報）
- OWASP ASVS プロジェクト/ダウンロード（v5.0.0 PDF/CSV/Word）：  
  https://owasp.org/www-project-application-security-verification-standard/  
  https://owasp.org/www-project-application-security-verification-standard/migrated_content
- OWASP Developer Guide（ASVSレベルの定義・使い方）：  
  https://devguide.owasp.org/en/03-requirements/05-asvs/
- OWASP Secure Headers / HTTP Security Headers Cheat Sheet：  
  https://owasp.org/www-project-secure-headers/  
  https://cheatsheetseries.owasp.org/cheatsheets/HTTP_Headers_Cheat_Sheet.html
- OWASP Session Management Cheat Sheet：  
  https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html
- OWASP WSTG（GraphQL/API/JWT/認可 テスト）：  
  https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/12-API_Testing/01-Testing_GraphQL  
  https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/06-Session_Management_Testing/10-Testing_JSON_Web_Tokens  
  https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/README
