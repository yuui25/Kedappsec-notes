# ASVS L2（v5.0）Webペネトレーション実務チェックリスト（修正版）
対象：**ASVS 5.0.0 L2** のWebアプリに対し、*asvs-l1-web-pentest-guide.md* と同じ粒度・表記で、
ブラックボックス主体（軽いグレーボックス可）で外形確認できる観点のみを本編に収録。  
内部実装/運用/ドキュメント確認が中心のものは、**「〇〇のためWEBペネトレーションテスト範囲から対象外」** と明記し、末尾の付録に移動。  
要件番号は **v5.0.0-<chapter.section.requirement>** で併記。

> 目的：既存の L2 ガイドから **ASVS L2以外の項目（L3専用等）を除去**／**未記載のL2要件を追記**／**表記ゆれ統一**。  
> 参照：ASVS 5.0.0 CSV（一次情報）。

---

## 0. 運用前提（L1と同一）
- **ステージング／検証環境限定**、過負荷や破壊的試験は実施しない。  
- **証跡**：日時、再現手順、HTTP要求/応答（ヘッダ含む）、画面キャプチャ。  
- **同意**：対象機能/API・アカウント・ロール・連携IdP/AS/RS（該当時）。

---

## 1. ブラウザ保護ヘッダ（L2強化）
- **CSP** を導入し、最小でも `object-src 'none'; base-uri 'none'` を満たし、許可リスト/nonce/hashを使用（L3は応答毎を要求）。  
  - 手順：主要HTMLレスポンスの CSP を確認。インライン実行は nonce/hash でのみ許可。  
  - ASVS：v5.0.0-3.4.3
- **`X-Content-Type-Options: nosniff`** を全レスポンスに付与。  
  - 手順：HTML/CSS/JS/画像/ファイル応答のヘッダ確認。  
  - ASVS：v5.0.0-3.4.4
- **Referrer-Policy** で参照元漏えいを抑止（`no-referrer` 又は `strict-origin-when-cross-origin` 等）。  
  - ASVS：v5.0.0-3.4.5
- **クリックジャッキング対策**（CSP の `frame-ancestors`）。  
  - ASVS：v5.0.0-3.4.6

> L1継承：HSTS（3.4.1）、CORS許可元固定（3.4.2）、MIME整合（4.1.1）。

---

## 2. Cookie/セッション（L2の追加観点）
- **Cookie 属性の厳格化**：`SameSite` を用途に応じて設定、`HttpOnly` を機密Cookieに付与。共有不要なら `__Host-` / 共有時は `__Secure-`。  
  - ASVS：v5.0.0-3.3.2 / 3.3.3 / 3.3.4
- **敏感操作の再認証**（メール/電話/MFA/回復情報など）。  
  - ASVS：v5.0.0-7.5.1
- **他端末セッションの確認・終了**（UIで一覧→選択終了）。  
  - ASVS：v5.0.0-7.5.2
- **認証要素変更後の全セッション終了オプション**。  
  - ASVS：v5.0.0-7.4.3
- **ログアウトUIの明確配置**（要認証ページから常時到達可）。  
  - ASVS：v5.0.0-7.4.4

---

## 3. 認証（Password/MFA/IdP）
### 3.1 Password（UI/仕様の外形）
- **長大パスワード許容（≥64文字）** を確認。  
  - ASVS：v5.0.0-6.2.9
- **忘れた場合の回復フローがMFAをバイパスしない**。  
  - ASVS：v5.0.0-6.4.3

> 下記は **運用/内部実装中心のためWEBペネトレーションテスト範囲から対象外**（付録Aへ移動）：6.2.10 / 6.2.11 / 6.2.12。

### 3.2 MFA（ワンタイム要素の外形）
- **ワンタイム性（再利用不可）**。  
  - ASVS：v5.0.0-6.5.1
- **生成・エントロピー・寿命の要件** は内部実装依存のため範囲外（付録A：6.5.2〜6.5.5）。

### 3.3 IdP連携（OIDC/SAML）
- **アサーション署名の検証**（ID Token/SAMLが未署名・検証失敗は拒否）。  
  - ASVS：v5.0.0-6.8.2
- **SAMLアサーションの一意処理（リプレイ防止）**。  
  - ASVS：v5.0.0-6.8.3
- **要求強度/最近性の検証**（`acr`/`amr`/`auth_time`）は実装/設計確認主体のため概要のみ外形確認、詳細は範囲外。  
  - ASVS：v5.0.0-6.8.4（付録Aで対象外理由を明記）

---

## 4. 入力/サニタイズ・インジェクション（L2追加）
- **LDAP / XPath / LaTeX / 正規表現メタ文字 の注入抑止**（該当機能がある場合）。  
  - ASVS：v5.0.0-1.2.6 / 1.2.7 / 1.2.8 / 1.2.9
- **テンプレート/Markdown/CSS/XSL/BBCode の無害化**。  
  - ASVS：v5.0.0-1.3.5 / 1.3.7
- **SVG の危険要素除去**（`<script>`/`foreignObject`等）。  
  - ASVS：v5.0.0-1.3.4
- **SSRFの許可リスト＋危険文字無害化**。  
  - ASVS：v5.0.0-1.3.6
- **JNDI/フォーマット文字列/メール注入の無害化**（外形で確認できる範囲）。  
  - ASVS：v5.0.0-1.3.8 / 1.3.10 / 1.3.11
- **安全なデシリアライズ**（型許可リスト等の挙動）。  
  - ASVS：v5.0.0-1.5.2

> **範囲外**：WYSIWYGサニタイズ実装詳細、`eval`/式言語使用有無、メモリ/整数/解放後使用 等は**コード/言語実装領域**（1.3.1 / 1.3.2 / 1.4.1〜1.4.3 → 付録A）。

---

## 5. API/HTTP/GraphQL/WebSocket
- **HTTP→HTTPS 自動リダイレクトはブラウザ向けエンドポイントのみ**。  
  - ASVS：v5.0.0-4.1.2
- **中継層由来ヘッダの偽装耐性**（`X-Forwarded-*` 等の上書き不可）。  
  - ASVS：v5.0.0-4.1.3
- **HTTP Request Smuggling の基本対策**（TE/CL競合の扱い）。  
  - ASVS：v5.0.0-4.2.1
- **GraphQL**：本番でイントロスペクション停止、深さ/コスト/件数などの**DoS対策**。  
  - ASVS：v5.0.0-4.3.1 / 4.3.2
- **WebSocket**：`Origin` 検証、標準セッション不使用時は**専用トークン**、HTTPSセッションからの遷移で初期取得/検証。  
  - ASVS：v5.0.0-4.4.2 / 4.4.3 / 4.4.4

> L1継承：MIME整合（4.1.1）、WSS使用（4.4.1）。

---

## 6. ファイル取扱い（アップロード/ダウンロード）
- **圧縮ファイルの展開前チェック**（最大展開サイズ／ファイル数）。  
  - ASVS：v5.0.0-5.2.3
- **ダウンロード時のファイル名制御（`Content-Disposition`）**。  
  - ASVS：v5.0.0-5.4.1
- **ヘッダ等でのファイル名エンコード/サニタイズ**（RFC 6266等）。  
  - ASVS：v5.0.0-5.4.2

> **範囲外**：許可拡張/最大サイズ等の**文書**（5.1.1）、AVスキャンの実施保証（5.4.3）。

---

## 7. 認可（Authorization）
- **フィールドレベル認可（BOPLA抑止）**。  
  - ASVS：v5.0.0-8.2.3
- **マルチテナント越境の抑止**。  
  - ASVS：v5.0.0-8.4.1

> L1継承：機能レベル（8.2.1）／データレベル（8.2.2）。  
> **範囲外**：フィールドレベル認可の**文書化**（8.1.2）。

---

## 8. 自己完結トークン/JWT（受入側の厳格化）
- **トークン種別/目的の誤用防止**（ID Token を認可用途に使わない等）。  
  - ASVS：v5.0.0-9.2.2
- **Audience の検証**（`aud` がサービスの許可リストと一致）。  
  - ASVS：v5.0.0-9.2.3
- **同一鍵で複数Audience発行時の`aud`制約**（発行側要件の外形確認のみ）。  
  - ASVS：v5.0.0-9.2.4

> **範囲外**：署名アルゴリズム許可リスト/鍵供給元/有効期間検証（9.1.1〜9.1.3/9.2.1）。

---

## 9. OAuth/OIDC（採用時の外形確認）
### 9.1 クライアント/共通
- **トークンは必要部位のみに送付**（BFFではバックエンド限定）。  
  - ASVS：v5.0.0-10.1.1
- **同一UAセッション起点の応答のみ受理**（`state`/`nonce`/PKCEの強固な束縛）。  
  - ASVS：v5.0.0-10.1.2
- **コードフローのCSRF対策**（PKCE または `state`検証）。  
  - ASVS：v5.0.0-10.2.1
- **Mix‑Up攻撃対策**（複数ASとの連携時）。  
  - ASVS：v5.0.0-10.2.2

### 9.2 リソースサーバ（API）
- **Audience検証／委譲権限に基づく認可／必要時の強度・最近性検証**。  
  - ASVS：v5.0.0-10.3.1 / 10.3.2 / 10.3.4

### 9.3 認可サーバ（AS）
- **PKCE必須**、**動的クライアント登録のリスク低減**。  
  - ASVS：v5.0.0-10.4.6 / 10.4.7
- **リフレッシュトークン**：絶対有効期限／UIからの失効／参照トークンの失効。  
  - ASVS：v5.0.0-10.4.8 / 10.4.9
- **バックチャネル要求に対する機密クライアント認証**（PAR/トークン/失効）。  
  - ASVS：v5.0.0-10.4.10
- **必要スコープのみ付与**。  
  - ASVS：v5.0.0-10.4.11

### 9.4 OIDCクライアント
- **ID Token再生防止**（`nonce`整合）／**ユーザ一意識別（`sub`）**／**意図対象（`aud`）検証**／**悪性ASのなりすまし拒否**。  
  - ASVS：v5.0.0-10.5.1 / 10.5.2 / 10.5.4 / 10.5.3
- **バックチャネルログアウトのDoS/混同防止**。  
  - ASVS：v5.0.0-10.5.5

### 9.5 OIDCプロバイダ/同意管理（AS側の挙動の外形）
- **許可 `response_mode` の制限（Implicit禁止）**／**強制ログアウトに対するDoS抑止**。  
  - ASVS：v5.0.0-10.6.1 / 10.6.2
- **同意の取得・説明・撤回**。  
  - ASVS：v5.0.0-10.7.1 / 10.7.2 / 10.7.3

> L1継承：リダイレクトURI完全一致／コード一回限り・短寿命（10.4.1〜10.4.3）。

---

## 10. 構成/公開面・クライアント側データ保護
- **デバッグ無効・ディレクトリリスティング無効・TRACE無効**／**内部ドキュメント/監視エンドポイントの非公開**。  
  - ASVS：v5.0.0-13.4.2 / 13.4.3 / 13.4.4 / 13.4.5
- **機微データのブラウザキャッシュ抑止**（`Cache-Control: no-store` 等）。  
  - ASVS：v5.0.0-14.3.2
- **ブラウザストレージに機微データを保存しない**（セッショントークンを除く）。  
  - ASVS：v5.0.0-14.3.3
- **本番からサンプル/開発用機能を排除**。  
  - ASVS：v5.0.0-15.2.3
- **失敗時の安全動作**（外部リソース失敗時も安全／例外時にフェイルオープンしない）。  
  - ASVS：v5.0.0-16.5.2 / 16.5.3

---

## 付録A：**WEBペネトレーションテスト範囲から対象外**（理由付き、ASVS 5.0.0 L2）
> 原因：**設計/運用ドキュメント確認が中心**、**内部実装・鍵/暗号の選定/管理**、**C/C++等のメモリ安全性**、**内部サービス間通信やSecrets管理** など、外部からのWebペネトレのみでは適切に検証できないため。  
> 本編に「概要外形のみ記載」している項目も、詳細はここで対象外として明記。

V1 エンコード／サニタイズ

v5.0.0-1.3.1：WYSIWYG入力のサニタイズ実装はライブラリ選定／コード実装確認が必要のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-1.3.2：evalや式言語（例：SpEL）の使用有無は内部実装の確認が必要のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-1.3.9：memcache送信前のサニタイズは内部処理依存のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-1.3.10：フォーマット文字列のサニタイズは内部処理依存のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-1.3.11：メール送信前のサニタイズ（SMTP/IMAP注入対策）は内部処理依存のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-1.4.1〜1.4.3：メモリ安全／整数オーバーフロー／解放後使用対策は言語実装・低レイヤのコードレビューが必要のためWEBペネトレーションテスト範囲から対象外。

V2 バリデーション／ビジネスロジック（文書化・運用）

v5.0.0-2.1.2 / 2.1.3：入力検証・ビジネスルールの文書化確認が中心のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-2.4.1：アンチオートメーション等の過負荷防止戦略は運用レビュー中心のためWEBペネトレーションテスト範囲から対象外。

V3 Webフロント（クライアント技術の採否・外部遷移）

v5.0.0-3.7.1 / 3.7.2：クライアント技術の採否／外部自動リダイレクトの許可は設計・運用方針の確認事項のためWEBペネトレーションテスト範囲から対象外。

V5 ファイル

v5.0.0-5.1.1：許可拡張子・最大サイズ等の文書定義の確認のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-5.4.3：アンチウイルススキャンの実施保証は内部連携／運用のためWEBペネトレーションテスト範囲から対象外。

V6 認証

v5.0.0-6.2.10 / 6.2.11 / 6.2.12：PWローテーション方針／文脈語リスト／漏えいPW照合はポリシー／内部実装依存のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-6.5.2〜6.5.5：バックアップコード／OOBコード／TOTPの生成・保存・寿命要件は内部実装依存のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-6.6.1 / 6.6.2：PSTN/SMS要素の提供条件・束縛は運用／設定依存のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-6.8.4：acr/amr/auth_timeによる強度・最近性検証はアプリとIdPの設計確認が必要のためWEBペネトレーションテスト範囲から対象外。

V7 セッション

v5.0.0-7.1.2 / 7.1.3：並行セッション数／SSO協調は文書・運用設計の確認事項のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-7.4.5：管理者による全ユーザセッション終了は管理運用UI／権限設計依存のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-7.6.1 / 7.6.2：IdP/RP間のセッション寿命・再認証連携は運用整合の検証のためWEBペネトレーションテスト範囲から対象外。

V8 認可

v5.0.0-8.1.2：フィールドレベル認可のポリシー文書確認が中心のためWEBペネトレーションテスト範囲から対象外。

V9 自己完結トークン

v5.0.0-9.1.1〜9.1.3 / 9.2.1：署名アルゴリズム許可リスト／鍵供給元／有効期間検証は発行・検証実装や鍵管理のレビューが必要のためWEBペネトレーションテスト範囲から対象外。

V11 暗号

v5.0.0-11.1.1 / 11.1.2：鍵管理方針・暗号在庫は設計／資産管理の確認事項のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-11.2.1〜11.2.3：暗号実装・アジリティ・強度は内部実装／構成の確認のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-11.3.3：暗号化データの改ざん防止（AEAD等）は実装詳細依存のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-11.4.2〜11.4.4：PWハッシュ・署名用ハッシュ・KDF設定は内部実装／パラメータ確認のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-11.5.1：CSPRNGとエントロピー要件は実装・乱数源の確認のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-11.6.1：鍵生成・署名アルゴリズムの採用は実装選定の確認のためWEBペネトレーションテスト範囲から対象外。

V12 通信

v5.0.0-12.1.2 / 12.1.3：TLS設定詳細／mTLSクライアント証明書の信頼検証は内部接続要件・構成確認のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-12.3.3：内部HTTPサービス間TLS強制は内部ネットワーク設計・運用確認のためWEBペネトレーションテスト範囲から対象外。

V13 構成／Secrets

v5.0.0-13.1.1：通信要件の文書化確認のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-13.2.1〜13.2.5：サービス間認証／最小権限／既定資格情報の排除は内部サービス設計・運用確認のためWEBペネトレーションテスト範囲から対象外。

v5.0.0-13.3.1 / 13.3.2：Secrets管理（Vault/HSM等）とアクセス最小化は運用／権限設計の確認のためWEBペネトレーションテスト範囲から対象外。

V14 データ保護（サーバ側・第三者送信・実装）

v5.0.0-14.2.2 / 14.2.3 / 14.2.4：サーバ側キャッシュ抑止／第三者送信防止／保護要件実装はサーバ実装・運用方針の確認のためWEBペネトレーションテスト範囲から対象外。

V15 防御的コーディング（内部実装）

v5.0.0-15.3.4 / 15.3.5 / 15.3.6 / 15.3.7：元IP引継ぎ／型厳密性／プロトタイプ汚染／HTTPパラメータ汚染はアプリ内部実装のレビューが必要のためWEBペネトレーションテスト範囲から対象外。

V16 ログ／エラーハンドリング（設計・運用・形式）

v5.0.0-16.2.1 / 16.2.3 / 16.2.4 / 16.3.3 / 16.3.4 / 16.4.1：ログ項目／出力先／形式／セキュリティイベント／予期せぬエラー／ログエンコードは設計・運用／実装確認が中心のためWEBペネトレーションテスト範囲から対象外。

V17 WebRTC

v5.0.0-17.x：TURN／DTLS／SRTP／シグナリングの堅牢性はメディアサーバ設定・運用・負荷耐性検証が中心のためWEBペネトレーションテスト範囲から対象外。
---

## 付録B：短時間実施の推奨順（3–6h）
1. **ブラウザ保護ヘッダ**（CSP/`nosniff`/Referrer/`frame-ancestors`）  
2. **Cookie/セッション**（SameSite/HttpOnly/再認証/他端末終了UI）  
3. **認証**（長大PW/MFA/IdP署名とリプレイ）  
4. **入力/サニタイズ**（SVG/Markdown/SSRF/正規表現/テンプレ）  
5. **API/HTTP/GraphQL/WS**（Origin検証/専用トークン/INTROSPECTION）  
6. **ファイル**（展開サイズ/Disposition/ファイル名サニタイズ）  
7. **認可**（フィールド/マルチテナント）  
8. **JWT/OAuth/OIDC**（aud/用途/PKCE/同意）  
9. **構成/公開面**（TRACE/ディレクトリ/ドキュメント公開/キャッシュ/LocalStorage）

---

## 参考（一次情報）
- ASVS 5.0.0 CSV（要件とレベルの公式一覧）  
  https://raw.githubusercontent.com/OWASP/ASVS/v5.0.0/5.0/docs_en/OWASP_Application_Security_Verification_Standard_5.0.0_en.csv
- OWASP ASVS プロジェクト  
  https://owasp.org/www-project-application-security-verification-standard/
