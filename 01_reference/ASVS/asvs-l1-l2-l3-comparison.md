# ASVS L1 / L2 / L3 比較と Webペネトレーション実務ガイド（v5.0 準拠）
対象：ASVS の検証レベル差分を **Webペネトレーション（非破壊・ステージング）** に落とし込んだ実務指針。  
使い方：調達/見積り時のレベル選定、試験計画、証跡・報告の期待水準のすり合わせに用いる。

---

## 0. 要点サマリ
- **L1：初期防御の確認** — ブラックボックス中心で外形・基本安全性のスクリーニング。短時間で「まず外せない」箇所の是正。  
- **L2：実運用レベル** — ほとんどのアプリ向け。認証・認可・セッション・CSP 等を**現実的な深度**で検証。API/GraphQL/JWTも対象。  
- **L3：高保証** — 金融/医療/公共等。**脅威モデリングと設計観点**を含め、テナント境界・トークン運用・供給網まで広く深く。

---

## 1. レベル別 比較表（実務観点）
| 観点 | L1 | L2 | L3 |
|---|---|---|---|
| 想定用途 | 初期スクリーニング/外形確認 | 大半の本番アプリの標準検証 | 高リスク/高価値システムの高保証 |
| 情報前提 | ブラックボックス | ブラックボックス＋最小限の補助情報 | グレーボックス（設計/ロール/DFD 要点） |
| 重点領域 | HTTPS/ヘッダ、CSRF基礎、Cookie Secure、基本XSS/SQLi兆候、ファイル/パス基礎、情報漏えい | CSP・CORS精密化、HttpOnly/SameSite、認証列挙/レート制御、**アクセス制御（BOLA/BFLA）**、API/GraphQL、SSRF、JWT運用、ログ/通知 | 脅威モデル、**テナント境界/特権**の形式的検証、Step-up/MFA、トークン回転/失効、COOP/COEP/CORP、供給網/SBOM、監査完全性 |
| 非機能配慮 | 過負荷禁止・短時間 | レート制御試験の上限合意 | 負荷/ファズは回数・時間・影響範囲を厳格合意 |
| 証跡 | HTTPログ抜粋・画面 | HTTPログ・状態遷移・設定値 | HTTPログ・図（DFD/シーケンス）・ポリシ/設定証跡 |
| 代表NG例 | `/.git`公開、HSTS/CORS不備、CSRFトークン欠如、アップロード実行、簡易XSS | BOLA/IDOR、BFLA、CSP欠陥下DOM‑XSS、JWT検証不備、SSRF到達、OpenAPI露出 | テナント越境、トークン再利用検知不備、Step‑up欠落、監査改ざん耐性不足、供給網の脆弱運用 |

---

## 2. レベル別：「Webペネトレで具体的に何をやるか」
### L1（最低限）
1) **外形**：HSTS / CORS / Content‑Type、CSRF（Origin/トークン/メソッド）  
2) **Cookie/セッション**：`Secure`（参考：`HttpOnly`/`SameSite`観察）  
3) **認証**：最小長・変更フロー・弱PW拒否・レート制御の兆候  
4) **入力/インジェクション**：XSS/SQLi/OSコマンド **兆候**、XXE無効化  
5) **ファイル/パス**：サイズ上限・拡張子/内容整合・実行抑止・`../`拒否  
6) **漏えい**：`.git`/バックアップ/URLへの機微情報混入抑止  
7) **API/WS**：`wss://`、基本スキーマ整合

### L2（標準）
1) **ブラウザ保護強化**：**CSP**（`script-src`/`frame-ancestors`）、`nosniff`/Referrer‑Policy  
2) **セッション**：`HttpOnly`/`SameSite`、**認証直後のIDローテーション**、失効/タイムアウト  
3) **認証**：列挙抑止、試行制限/遅延、MFA運用（採用時）  
4) **アクセス制御**：**BOLA/IDOR**、**BFLA**、テナントや役割の境界、Mass Assignment  
5) **API/GraphQL**：ドキュ露出、深さ/複雑度制御、ミューテーション権限  
6) **SSRF**：内向き到達不可、メタデータ遮断、リダイレクト/スキーム禁止  
7) **トークン/JWT**：`aud/iss/exp`検証、`alg`固定、短寿命＋リフレッシュ回転  
8) **ログ/通知**：セキュリティイベントのユーザ通知、相関ID  
9) **通信**：TLS1.2+、弱スイート無効化

### L3（最高保証）
1) **脅威モデリング**：資産/攻撃者/シナリオ合意、優先度反映  
2) **設計/鍵管理**：KMS/ローテーション、Secrets管理、PEP/PDPの一貫性  
3) **特権/テナント境界**：リソース所有者・テナントID整合、**特権遷移の再認証**  
4) **Step‑up/MFA**：高リスク操作で段階的認証、リカバリ強度  
5) **高度ブラウザ防御**：**COOP/COEP/CORP**、CSP `strict-dynamic`/Trusted Types  
6) **反序列化/式評価**：ガジェット禁止、式言語/テンプレ注入の抑止  
7) **Webhook/署名/リプレイ**：時刻合わせ・`nonce`・署名検証  
8) **供給網**：SBOM、依存固定/更新、ビルド署名、Secrets漏洩抑止  
9) **監査完全性**：改ざん検知、外部転送、証跡保持方針

---

## 3. 実施順のモデル（例）
- **L1（2–4h）**：外形→Cookie→認証UI→CSRF→XSS/SQLi→ファイル→漏えい→API/WS  
- **L2（1–3日）**：CSP→セッション→認証→アクセス制御→API/GraphQL→SSRF→JWT→ログ/通信  
- **L3（3–10日）**：脅威モデル→外形/ブラウザ→認証/トークン→アクセス制御→高度インジェクション→外部呼出し→供給網/監査

> 時間はあくまで**目安**。範囲・複雑度・環境で大きく変動。

---

## 4. レベル別 観点×要求差分マトリクス（抜粋）
| ドメイン | L1 | L2 | L3 |
|---|---|---|---|
| HTTP/Headers | HSTS, CORS, Content‑Type | + **CSP**, `nosniff`, Referrer‑Policy | + **COOP/COEP/CORP**, CSP厳格化 |
| Cookie/Session | `Secure` | + `HttpOnly`, `SameSite`, **IDローテーション**, 失効 | + Step‑up時再認証、厳格なタイムアウト |
| 認証 | 長さ/弱PW/レート兆候 | 列挙抑止・試行制限・MFA運用 | 本人性確認/復旧手順の強度 |
| アクセス制御 | 最小限（機能露出） | **BOLA/BFLA**/テナント/マスアサイン | 形式的検証・特権操作の再認証 |
| インジェクション | XSS/SQLi 兆候 | DOM‑XSS/テンプレ/NoSQL | 反序列化/式評価/高度検知 |
| ファイル/パス | サイズ/実行抑止/`../` | 二次処理安全性/保存領域固定 | アーカイブ/画像処理DoS耐性 |
| API/GraphQL/WS | 型/`wss://` | ドキュ露出/深さ/複雑度 | Persisted Query/動的認可再評価 |
| SSRF/外部 | — | 到達不可/リダイレクト抑止 | DNS Rebinding/署名検証/リプレイ対策 |
| トークン/JWT | — | `aud/iss/exp`/alg固定/回転 | 使い回し検知/早期失効 |
| ログ/監査 | — | イベント通知/相関ID | 改ざん耐性/外部保管 |
| 供給網/ビルド | — | 依存更新方針 | **SBOM/ビルド署名/Secrets対策** |

---

## 5. スコーピング補助チェック（抜粋）
- 個人情報/決済/医療/公共データを扱う？→ **L2以上**、規制ありなら **L3候補**  
- マルチテナント/外部連携が重要？→ **L2で境界検証**、高リスクなら **L3**  
- トークン/JWT/OIDC利用？→ **L2**（検証必須）、高保証要件なら **L3**  
- 監査/追跡要件が厳格？→ **L3** で監査完全性・改ざん耐性を確認

---

## 6. 成果物テンプレ（要旨）
- **ASVSマッピング**：章/節/要件ID（例：*ASVS v5 — Access Control*）  
- **再現手順**：前提・HTTP入出力・状態遷移・失敗時動作  
- **観測/影響**：期待 vs 実測・攻撃連鎖（水平/垂直/SSRF 等）  
- **是正案**：設定/実装/運用の改善方針、優先度  
- **証跡**：スクリーンショット・HTTPログ・時刻・相関ID

---

## 7. 参考（一次情報）
- OWASP ASVS（v5.0.0 本体/ダウンロード）: https://owasp.org/www-project-application-security-verification-standard/  
- OWASP Developer Guide（ASVSの使い方/レベル定義）: https://devguide.owasp.org/en/03-requirements/05-asvs/  
- OWASP WSTG（詳細手順書）: https://owasp.org/www-project-web-security-testing-guide/latest/  
- OWASP Cheat Sheet Series: https://cheatsheetseries.owasp.org/
