<<<BEGIN>>>
# 04_authz_境界モデル→検証観点チェック.md

（先頭要約：このプレイブックの位置づけ）
- 目的：認可（AuthZ）を「IDORがあるか」ではなく、権限境界（所有者/ロール/テナント/共有/委任）の“モデル化”として扱い、検証観点を迷わず回す
- 主役：エンドポイント総当たりではなく、境界モデル→差分観測→A/B分岐→最小証跡
- 接続：AuthN（認証）で確定した主体とセッション材料を前提に、APIや業務機能の越権を最短で検証する

## 目的（このプレイブックで到達する状態）
- AuthZの境界を、最低でも次の5つで説明できる。
  - 所有者境界（自分のもの/他人のもの）
  - ロール境界（一般/管理/権限付き）
  - テナント境界（組織・プロジェクト・グループ）
  - 共有境界（公開/限定/外部ゲスト）
  - 委任境界（OAuth scope/代理操作/サービスアカウント）
- “どの境界が崩れると何が起きるか” を短く言語化し、検証優先度を付けられる。
- UI/APIで権限がズレる前提で、差分観測により最短で越権の成立条件を絞れる。

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb機能およびAPI（GraphQL含む）。
- 想定：
  - UIは制限されていてもAPIが通ることがある（UI≠AuthZ）
  - 認可は「リソース＋主体＋操作」の組み合わせで成立する
- 依存（接続先）：
  - AuthN：`02_playbooks/03_authn_観測ポイント（SSO/MFA前提）.md`
  - Topics：`01_topics/02_web/03_authz_認可（IDOR BOLA BFLA）境界モデル化.md`
  - API連動：`02_playbooks/05_api_権限伝播→検証観点チェック.md`

## 入力（このプレイブックの開始条件）
- 入口機能（上位3〜5）：例）プロフィール、注文、ファイル、設定、管理、共有
- 主体（最低2種）：例）ユーザーA/ユーザーB（可能ならロール差）
- リソース（最低2種）：例）自分のデータ/他人のデータ（ID/キー/スラッグ等）

## 観測の進め方（順序固定：モデル化→差分→境界崩壊候補→検証）
### 1) 認可モデルを作る（最小の“表”を頭に作る）
- リソース：何を操作するか（例：order, file, project, user）
- 操作：何をするか（read/create/update/delete/share/admin）
- 主体：誰がやるか（role、tenant、owner）
- 判定点：どこで拒否されるべきか（UI/サーバ/両方）
- ここで確定したい状態
  - “主体×操作×リソース”のどこが境界かが言える

### 2) 差分観測で境界を確定する（A/B比較が主役）
- 比較の軸
  - 主体差：ユーザーA vs B（別ロールがあれば尚良い）
  - 所有差：自分のリソース vs 他人のリソース
  - テナント差：同一テナント vs 別テナント（可能なら）
  - 共有差：未共有 vs 共有済み（リンク/ゲスト等）
- 観測するもの
  - HTTPステータスだけでなく、レスポンスの“意味”（権限不足/存在しない/隠蔽）
- ここで確定したい状態
  - どの境界で挙動が変わるか（拒否点）が言える

### 3) “境界崩壊の候補”を作る（断定しない）
- 例：所有者境界が弱そう
  - 他人IDを入れても同じ形で返る/更新できそう
- 例：テナント境界が弱そう
  - テナントID差が効いていない/参照が混ざる
- 例：ロール境界が弱そう
  - 管理機能に似たAPIが一般ユーザーで呼べる気配
- 例：共有境界が弱そう
  - 共有リンクの推測性/期限/権限が強すぎる
- 目的
  - “どの境界を壊しに行くか” を決める（闇雲に試さない）

### 4) 最小検証を設計する（影響を小さく、再現性を高く）
- 原則
  - read-only（参照）から始める
  - 更新系は“安全な対象”で行う（ラボ/テストデータ/許可範囲）
- 検証の作り方
  - 1つの境界だけを変える（例：IDだけ、テナントだけ、ロールだけ）
  - 期待結果（拒否）と実結果（許可/情報漏洩）を並べる

## 判断（A/B分岐：次の一手）
### 分岐A：UIでは拒否だがAPIが通る（AuthZがサーバで不十分）
- 次の一手
  - APIプレイブックへ：`02_playbooks/05_api_権限伝播→検証観点チェック.md`
  - 技術ユニット：`01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`

### 分岐B：所有者境界が怪しい（IDOR/BOLAの匂い）
- 次の一手
  - “IDが何を表すか” を確定（推測可能性より、境界が効いているか）
  - 読み取り→更新の順で、影響を制御して確認する

### 分岐C：テナント境界が怪しい（組織跨ぎの可能性）
- 次の一手
  - テナント識別子（tenant/org/project）がどこで決まるかを観測（URL/ヘッダ/トークン/サーバ側）
  - 認証（AuthN）と結びつく境界か、リクエストで上書きできる境界かを切り分ける

### 分岐D：共有境界が怪しい（リンク/外部ゲストで伝播）
- 次の一手
  - SaaS/共有の観点へ接続：`01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`
  - 共有の単位・範囲・権限・期限を状態として確定する

### 分岐E：ロール境界が怪しい（管理権限に近い操作）
- 次の一手
  - “管理操作の入口” を抽出し、影響の小さいread系から確認
  - 監査（ログ）とセットで証跡を作る（説明力を上げる）

## 出力（このプレイブックの成果物：最小セット）
- 認可境界モデル（文章で良い）
  - リソース：○○、主体：○○、操作：○○、境界：所有/ロール/テナント/共有/委任
- 差分観測メモ（最小）
  - A（期待拒否） vs B（実結果）を1〜2行で
- 次工程
  - APIへ進むか、共有/SaaSへ進むか、AuthNへ戻るか（分岐理由）

## 証跡（最小セット：再現性のため）
- リクエスト（主要1〜3本）の保存（HAR/ログで可）
- 主体（ユーザーA/B）と対象（ID等）の対応メモ
- 期待結果と実結果（画面/レスポンス要点）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 認可は境界（所有/ロール/テナント/共有/委任）の実装であり、破れると越権・情報漏洩に直結するため、境界モデルで検証を組む
- WSTG：
  - 認可のテスト観点を、差分観測（主体差/所有差/テナント差/共有差）で回し、UIとAPIのズレを前提にする
- PTES：
  - Vulnerability Analysis：越権の成立条件（境界が効かない点）を特定
  - Exploitation：影響制御しつつ最小確認（read→write）で再現性を作る
- MITRE ATT&CK：
  - 戦術：Privilege Escalation / Collection を、AuthZ境界崩壊（越権・越境）として説明する補助に使う

## 関連リンク（リポジトリ内：必要最小限）
- 技術ユニット
  - `01_topics/02_web/03_authz_認可（IDOR BOLA BFLA）境界モデル化.md`
  - `01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`
  - `01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`
- 前後の導線
  - `02_playbooks/03_authn_観測ポイント（SSO/MFA前提）.md`
  - `02_playbooks/05_api_権限伝播→検証観点チェック.md`

<<<END>>>
