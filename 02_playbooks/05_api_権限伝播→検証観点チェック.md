<<<BEGIN>>>
# 05_api_権限伝播→検証観点チェック.md

（先頭要約：このプレイブックの位置づけ）
- 目的：APIを「エンドポイント列挙」ではなく、権限伝播（主体→サービス→内部連携）と入力境界（どこで実行/参照が起きるか）で捉え、検証観点を迷わず回す
- 主役：意味のある観測（権限・所有・テナント・スコープ）と、A/B分岐（次の一手）
- 接続：AuthN（主体/セッション材料）とAuthZ（境界モデル）を前提に、APIの越権・情報漏洩・内部連携を最短で絞る

## 目的（このプレイブックで到達する状態）
- APIの権限を「誰が、どの範囲で、何をできるか」で説明できる。
  - 主体（ユーザー/ロール/サービス）と、セッション材料（token/cookie）
  - 範囲（テナント/プロジェクト/所有者）と、スコープ（OAuth等）
  - 操作（read/write/admin）と、内部連携（別サービス・別データ）
- UI制限とAPI実態がズレる前提で、差分観測により越権成立条件を絞れる。
- APIが呼ぶ“裏側”（バックエンド連携）を推定し、入力境界（実行・参照・委任）に繋げられる。

## 前提（対象・範囲・想定）
- 対象：許可範囲のREST/GraphQL/内部API/モバイルAPI。
- 想定：
  - APIは権限判定が散らばる（ゲートウェイ/サービス/DB）
  - 一つのAPIが複数資産に触れる（権限伝播のズレが起きやすい）
  - トークン/スコープ/テナントが絡むと、境界が複雑化する
- 依存（接続先）：
  - AuthN：`02_playbooks/03_authn_観測ポイント（SSO/MFA前提）.md`
  - AuthZ：`02_playbooks/04_authz_境界モデル→検証観点チェック.md`
  - Topics：`01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`
  - creds：`01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`

## 入力（このプレイブックの開始条件）
- 入口機能（上位3〜5）と、対応する主要API（1機能につき1〜3本で良い）
- 主体（最低2種）：ユーザーA/B、可能ならロール差
- テナント/所有者の差分が作れるデータ（自分/他人、同一/別組織）

## 観測の進め方（順序固定：API地図→権限変数→差分→内部連携→最小検証）
### 1) APIの“地図”を作る（量より構造）
- 観測するもの
  - ベースURL、バージョン、認証方式（cookie/bearer）
  - 主要リソース（users/orders/files/projects等）
  - 操作（read/write/admin）と、危険度（影響の大きさ）
- 確定したい状態
  - “このAPIは何の資産を扱うか” が言える

### 2) 権限に効く変数を抽出する（境界の材料）
- 観測するもの（例）
  - 所有者：user_id/resource_id
  - テナント：tenant_id/org_id/project_id
  - ロール：role/adminフラグ、グループ
  - スコープ：scope/permission、クライアント種別
- 確定したい状態
  - “どの変数が境界”かが言える（変数が分からないと検証が外れる）

### 3) 差分観測で“境界が効いている場所”を確定する
- 差分の作り方（順序）
  1) 主体差：ユーザーA vs B
  2) 所有差：自分ID vs 他人ID
  3) テナント差：同一tenant vs 別tenant
  4) 操作差：read vs write（影響制御）
- 観測するもの
  - ステータスだけでなく、レスポンスの意味（存在隠蔽/権限不足/部分漏洩）
  - ページネーション/フィルタの癖（別資産が混ざる兆候）
- 確定したい状態
  - “どこで境界が効かない/ズレる” の候補が作れる

### 4) 権限伝播（バックエンド連携）を推定する
- 兆候（例：断定しない）
  - 一つのAPIが複数資産を返す（ユーザー＋権限＋設定＋関連データ）
  - エラー文言やヘッダ、レスポンス構造が別サービス臭い
  - 同じtokenで別ドメイン/別サブドメインへ呼び出している
- 意味（状態）
  - “権限判定点”が単一でない可能性（サービス間の判定ズレが起き得る）
- 次の一手
  - どのサービス境界で判定しているかを差分で絞る（主体/テナント/操作）

### 5) 最小検証を設計する（read-only→影響小のwrite）
- 原則
  - まずreadで越境/漏洩の有無を確認
  - writeはラボ/テストデータ/許可範囲の安全な対象で、1項目だけ変える
- 目的
  - 再現性（証跡）と説明力（期待と実結果の差）を最大化

## 判断（A/B分岐：次の一手）
### 分岐A：APIで越権が成立しそう（所有/テナント/ロール境界が弱い）
- 次の一手
  - AuthZプレイブックに戻り、境界モデルを補強：`02_playbooks/04_authz_境界モデル→検証観点チェック.md`
  - 影響を小さくして再現性を作る（read→限定write）

### 分岐B：OAuth/スコープ/クライアントが絡む（委任境界が本体）
- 次の一手
  - IdP/委任へ接続：`01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
  - credsへ接続：`01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
  - “どのscopeがどこまで効くか” を状態で確定する

### 分岐C：入力が裏側の実行境界に繋がっていそう（テンプレ/デシリアライズ等）
- 次の一手
  - 入力境界へ：`01_topics/02_web/05_input_入力→実行境界（テンプレ デシリアライズ等）.md`
  - まず“どこで実行/参照が起きるか”を観測で確定してから検証設計する

### 分岐D：秘密情報/トークンが露出している（長期権限の可能性）
- 次の一手
  - credsへ：`01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
  - 設定/運用へ：`01_topics/02_web/06_config_設定・運用境界（CORS ヘッダ Secrets）.md`

## 出力（このプレイブックの成果物：最小セット）
- API地図（上位3〜5本）
  - API名/資産/操作/権限変数（owner/tenant/role/scope）/優先度理由
- 差分観測メモ（最小）
  - 主体差・所有差・テナント差で、どこが変わったか（1〜2行）
- 次工程
  - AuthZへ戻る / IdP・委任へ進む / 入力境界へ進む / credsへ進む（分岐理由）

## 証跡（最小セット：再現性のため）
- 主要リクエスト（1〜3本）とレスポンス要点（HAR/ログで可）
- 主体（A/B）と対象（ID等）の対応メモ
- 期待結果（拒否）と実結果（許可/漏洩/変更）を並記

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - APIの認証・認可・秘密情報管理を、境界変数（owner/tenant/role/scope）として観測し、越権・漏洩の成立条件を絞る
- WSTG：
  - APIのテスト観点を、差分観測（主体/所有/テナント/操作）で回し、UI制限とのズレを前提に検証する
- PTES：
  - Vulnerability Analysis：権限判定のズレ（伝播/判定点の分散）を特定
  - Exploitation：影響制御しつつ最小確認（read→限定write）で再現性を作る
- MITRE ATT&CK：
  - 戦術：Collection（情報取得）、Privilege Escalation（越権）、Credential Access（トークン/委任）を、API境界崩壊として説明する

## 関連リンク（リポジトリ内：必要最小限）
- 技術ユニット
  - `01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`
  - `01_topics/02_web/05_input_入力→実行境界（テンプレ デシリアライズ等）.md`
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
  - `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- 前後の導線
  - `02_playbooks/04_authz_境界モデル→検証観点チェック.md`
  - `02_playbooks/03_authn_観測ポイント（SSO/MFA前提）.md`

<<<END>>>
