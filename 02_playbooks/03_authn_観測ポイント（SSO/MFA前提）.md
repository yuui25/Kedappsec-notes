<<<BEGIN>>>
# 03_authn_観測ポイント（SSO/MFA前提）.md

（先頭要約：このプレイブックの位置づけ）
- 目的：AuthN（認証）を“フォーム入力”ではなく「どこで本人性が成立し、どんな材料がセッションとして残るか」を観測で確定する
- 前提：SSO/MFAがある環境を標準とし、IdP連携（SAML/OIDC/OAuth）とアプリ側セッションの両方を見る
- 主役：ツールの操作ではなく、観測→意味→分岐（次の一手）と最小証跡

## 目的（このプレイブックで到達する状態）
- 認証の成立点を説明できる。
  - 認証はどこで行われるか（アプリ内/IdP/両方）
  - セッション材料は何か（Cookie/Token/チケット等）
  - 認証後の権限はどこで決まるか（claim/role/group等）
- “安全に検証できる範囲”で、次の分岐を作れる。
  - 認証そのものが怪しい（境界が崩れる）
  - 認証は強いが、権限（AuthZ）で崩れる
  - トークン/Secretsの扱いで長期化する（credsへ）
- Web/NWの接続：
  - Webのセッション/トークン観測は、NW側のCredential（所在/伝播）に繋がる

## 前提（対象・範囲・想定）
- 対象：許可範囲のログイン導線（UI/API/モバイル）、SSO導線（IdP）、MFA導線。
- 想定：
  - 入口は複数（通常ログイン/SSO/管理者/モバイル）
  - MFAは“強い”が、設定・連携・セッションでズレが起きることがある
- 観測基盤（推奨）：
  - Proxy（リクエスト/レスポンス観測、HAR）
  - 可能ならサーバ側ログ（許可範囲で）
- 依存（接続先）：
  - `01_topics/02_web/02_authn_認証・セッション・トークン.md`
  - `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`

## 観測の進め方（順序固定：入口→連鎖→材料→境界→方針）
### 1) 認証入口を確定する（どれが“正規ルート”か）
- 観測するもの
  - ログイン開始URL、リダイレクト先、ログアウトURL
  - UIログイン/APIログイン/モバイルログインの差
- 確定したい状態
  - “どの入口が本体か” と “別入口があるか” を言える

### 2) リダイレクト連鎖を確定する（SSO/IdPの境界）
- 観測するもの
  - アプリ→IdP→アプリの遷移
  - state/nonce/RelayState など、連鎖を結ぶ材料
  - どこでエラーになるか（拒否点）
- 確定したい状態
  - 信頼境界（どのIdP/どのクライアントを信頼しているか）が言える

### 3) セッション材料を確定する（Cookie/Tokenの“状態”）
- 観測するもの（例）
  - Cookieの属性（Secure/HttpOnly/SameSite/Domain/Path/有効期限）
  - Bearerトークンの付与位置（ヘッダ/ストレージ/レスポンス）
  - トークン更新（refresh）の有無とタイミング
- 確定したい状態
  - “何が本人性の継続材料か” と “どこに残るか” が言える

### 4) 認証後に権限がどう決まるかを観測する（AuthZへの橋渡し）
- 観測するもの
  - ロール差/ユーザー差で、UI/API応答がどう変わるか（差分）
  - claim/role/group/tenant の手掛かり（レスポンス、UI、JWT等）
- 確定したい状態
  - 権限境界が“どの要素で切り替わるか”を説明できる

### 5) 例外系の挙動で“境界の強さ”を測る（安全に差分）
- 観測するもの（例）
  - 未ログイン時の扱い（リダイレクト/401/匿名）
  - セッション失効時の扱い（期限、再認証要求）
  - 並行セッション/多端末の扱い（許可範囲で）
- 目的
  - どこが拒否点かを知る（検証を外さない）
  - “セッション固定/取り違え”などの可能性があるかを推定する（断定しない）

## 判断（A/B分岐：次の一手）
### 分岐A：SSO/連携境界が本体（IdP側の設定・信頼が勝負）
- 次の一手
  - `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md` を参照し、信頼境界（iss/aud/署名/クライアント）を整理
  - 次に「権限が属性で決まるか」を観測し、AuthZへ渡す

### 分岐B：認証は成立するが、権限で崩れそう（越権の匂い）
- 次の一手
  - `02_playbooks/04_authz_境界モデル→検証観点チェック.md`
  - `01_topics/02_web/03_authz_認可（IDOR BOLA BFLA）境界モデル化.md`

### 分岐C：トークン/Secretsの扱いが鍵（長期権限/漏洩/伝播）
- 次の一手
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
  - SaaS側の外部アプリ/委任が絡むなら `01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`

### 分岐D：APIログインやモバイルが別挙動（入口が複数で境界がズレる）
- 次の一手
  - `02_playbooks/05_api_権限伝播→検証観点チェック.md`
  - 入口の差分（UI/API/モバイル）を“境界差”として整理し直す

## 出力（このプレイブックの成果物：最小セット）
- 認証フロー図（文章で十分：矢印で表現）
  - 入口 →（リダイレクト）→ IdP →（戻り）→ アプリ
- セッション材料の一覧（最小）
  - Cookie/Tokenの種類、保存場所、期限、更新有無
- 権限境界の手掛かり
  - ロール差/テナント差/claim差の観測メモ（1〜2行）
- 次工程
  - AuthZへ行くか、credsへ行くか、IdPへ深掘りするか（分岐理由）

## 証跡（最小セット：再現性のため）
- HAR/主要リクエストの抜粋（必要最小限）
- Cookie属性の観測結果（スクリーンショット/メモで可）
- 例外時の挙動（失効/未ログイン時の応答の差）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 認証・セッション管理の要求を、SSO境界（IdP/アプリ）とセッション材料（Cookie/Token）に落として観測する
- WSTG：
  - 認証/セッションのテスト観点を、入口→連鎖→材料→例外挙動の順で確認し、差分観測で検証を外さない
- PTES：
  - Vulnerability Analysis：認証境界（連携/セッション）が崩れる可能性を特定し、次工程（AuthZ/API/creds）へ導く
- MITRE ATT&CK：
  - 戦術：Credential Access（トークン/セッション材料）、Privilege Escalation（越権に繋がる認証崩壊）を、状態として整理する

## 関連リンク（リポジトリ内：必要最小限）
- 技術ユニット
  - `01_topics/02_web/02_authn_認証・セッション・トークン.md`
  - `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- 次の導線
  - `02_playbooks/04_authz_境界モデル→検証観点チェック.md`
  - `02_playbooks/05_api_権限伝播→検証観点チェック.md`

<<<END>>>
