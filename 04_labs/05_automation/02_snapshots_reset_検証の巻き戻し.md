<<<BEGIN>>>
# 02_snapshots_reset_検証の巻き戻し.md

## 目的（この技術で到達する状態）
- 検証を「壊して学ぶ→即復帰→再検証」のサイクルで回し、反復回数を最大化できる。
- 失敗の原因を“環境のブレ”ではなく“技術の論点”に収束させられる（同条件比較ができる）。
- 証跡（HAR/Proxyログ/pcap/メモ）を残しながら、環境はクリーンに戻せる運用を確立する。

## 前提（対象・範囲・想定）
- 対象：自前の検証環境（VM/クラウド）。許可範囲のみ。
- 想定：VirtualBox（またはVMware）でAttack Box/Target VMを運用する。
- 依存（関連ファイル）：
  - `04_labs/02_virtualization/01_virtualbox_基盤.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 巻き戻しは「便利機能」ではなく、検証の精度を上げる“条件固定装置”
  - 同じ条件で再実行できる（環境差で結果が変わらない）
  - 破壊的な変更（設定改変、依存更新、認証状態の汚染）を恐れず試せる
- 境界の観点
  - 資産境界：証跡・秘密情報がスナップショットに含まれる（残す/残さないを設計する）
  - 信頼境界：クリーン状態へ戻すことで、意図しない常駐・設定残りを除去できる
  - 権限境界：管理者権限での操作は増えるが、実験環境で閉じる前提を徹底する

## 基本方針（必ず守る）
- “巻き戻しの対象”を明確化する
  - VM本体（OS/ツール/設定/状態）
  - データ（証跡/メモ/検証成果物）
- 証跡は「巻き戻しの外」に出すか、巻き戻し前に退避する（消える/残るの設計を決める）
- 検証の節目は必ずスナップショット（またはリセット手順）を取る
- 手順の羅列ではなく「いつ何を取るか（タイミング）」が主役

## スナップショット設計（VM：VirtualBox/VMware共通の考え方）
> ここでいう“スナップショット”は「状態の固定点」。技術検証の反復回数を増やすために使う。

### スナップショットの種類（用途で分ける）
- S0：クリーン（初期構築完了直後）
  - 目的：いつでも“基礎状態”に戻れる
- S1：計測基盤入り（Proxy/証跡ディレクトリ/最低限ツールが揃った状態）
  - 目的：毎回の検証の出発点（観測できる状態）を固定する
- S2：検証単位（topics 1件/検証テーマ1件ごと）
  - 目的：仮説A/Bの分岐前に固定し、差分だけを作って比較する
- S3：破壊的変更前（OS更新、証明書導入、ネットワーク大改造等）
  - 目的：戻しやすさ最優先（学習効率の担保）

### 命名（比較と検索のため）
- 必ず入れる：日付、対象VM、状態、テーマ（任意）
- 例（概念）：
  - `20251213_AttackBox_S0_clean`
  - `20251213_AttackBox_S1_proxy-capture-ready`
  - `20251213_TargetWeb_S2_authz-boundary-test_A`

## データ（証跡）の扱い：残す/消すを設計する
> スナップショット運用が崩れる最大原因は「証跡が混ざる」こと。最初に決め切る。

### 推奨：証跡はVMの外 or 固定パスに集約し、運用で管理
- 目的：スナップショットは“環境状態”を固定し、証跡は“比較材料”として蓄積する
- 運用の型
  - `~/pentest-work/` を固定（VM内でもOK）
  - 巻き戻し前に、対象の証跡だけを「エクスポート」または「タグ付け」して残す
- 取り扱い注意
  - Proxyログ/HARには秘密情報が含まれ得るため、共有・保管期限を決める

## 巻き戻しの運用（タイミング：ここが最重要）
### 1) 検証開始前（毎回）
- 参照するスナップショットを決める（基本はS1）
- その検証の“視点”をメモに書く（端末/経路/条件）

### 2) 仮説分岐の直前（A/Bを試す前）
- S2を取る（“分岐点”を固定する）
- Aを試す → 証跡取得 → 結果メモ
- ロールバックして同じ分岐点に戻る → Bを試す → 証跡取得 → 結果メモ
- これにより「A/Bの差分が環境差ではなく入力差」であることを担保できる

### 3) 破壊的変更の前（更新・証明書・ネットワーク再設計等）
- S3を取る
- 目的達成後、不要ならロールバックして検証用の“標準状態”へ戻す（肥大化防止）

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：結果が再現せず、原因が“技術”か“環境差”か分からない
  - 次の検証：
    - S1（計測基盤入り）を出発点に固定し、S2（分岐点）を必ず取ってA/Bを比較する
    - メモに「視点（端末/経路/条件）」を必ず残す
  - 期待する観測：
    - 変数が“入力差”に限定され、成立条件が説明できる
- 仮説B：証跡が混ざって比較できず、結論が弱い
  - 次の検証：
    - 証跡の保存先と命名メタ（対象/日時/視点/条件）を固定する
    - 巻き戻しの前に「その検証の証跡」を確実に退避する
  - 期待する観測：
    - 同条件/別条件の比較が容易になり、学習が加速する
- 仮説C：スナップショットが増えすぎて管理できない
  - 次の検証：
    - S0/S1は維持、S2/S3は検証終了後に整理（不要分は削除）
    - “検証単位（topics 1件）”ごとに残すスナップショット数を上限化する
  - 期待する観測：
    - 巻き戻しのメリットを維持しつつ、運用が破綻しない

## 手を動かす検証（完了条件）
- S0（クリーン）とS1（計測基盤入り）が存在する
- topicsの検証で、S2（分岐点）→A→巻き戻し→B の比較を1回以上実施できている
- 証跡が固定の場所にあり、視点（端末/経路/条件）がメモで説明できる

## コマンド/設定例（例示は最小限）
~~~~
# 例：証跡保存先の固定（Attack Box側）
mkdir -p ~/pentest-work/captures/{har,proxy,pcap} ~/pentest-work/notes

# 例：検証メモに必ず残す項目（テンプレ）
# - 出発点：S1（計測基盤入り）
# - 分岐点：S2（仮説A/Bの直前）
# - 視点：AttackBox(VM) → Host-Only → Target
# - 条件：未ログイン / ログイン後 / 低権限 / 高権限 / テナントA/B
# - 取得証跡：HAR / Proxyログ / （必要時）pcap
~~~~
- この例で観測していること：証跡が固定され、A/B比較が同条件で可能になっているか
- 前提が崩れるケース：保存先が散る、スナップショットのタイミングが曖昧、秘密情報の扱いが未定

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - 認証/認可/API/設定/ログなどの検証で、条件差を固定して成立条件を説明できる“検証基盤”として寄与する
- WSTG：
  - WSTG観点を反復し、差分（条件変更）を比較するための前提（再実行で結果がブレない）
- PTES：
  - Vulnerability Analysis / Exploitation を反復するための運用基盤（仮説検証の回数を増やす）
- MITRE ATT&CK：
  - 攻撃者の意図（Recon/Discovery等）を“検証として再現する”際に、環境差ではなく観測差として整理できる

## 参考（必要最小限）
- `04_labs/02_virtualization/01_virtualbox_基盤.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 関連 labs：`04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`
- 関連 topics：`01_topics/02_web/03_authz_認可（IDOR/BOLA/BFLA）境界モデル化.md`

---


<<<END>>>
