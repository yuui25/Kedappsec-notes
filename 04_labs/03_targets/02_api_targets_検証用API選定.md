<<<BEGIN>>>
# 02_api_targets_検証用API選定.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - 位置づけ：APIの認証/セッション（トークン）、認可（スコープ/オブジェクト/プロパティ）、入力検証、設定（CORS/ヘッダ/公開範囲）、ロギングを“同条件比較”で回す教材を選定する
  - 支えるポイント：境界（資産/信頼/権限）が通信にどう表れるかを、差分として説明できる状態にする
- WSTG：
  - 位置づけ：APIテストを「観測→改変→差分説明」で実施する前提（WSTGの各観点をAPIの通信差分に落とす）
  - 支えるポイント：認証/セッション/認可/API入力/設定を、リクエスト（ヘッダ/ボディ/パラメータ）差分で検証できる教材を用意する
- PTES：
  - 該当フェーズ：Pre-engagement（教材選定）→ Intelligence Gathering（API面の把握）→ Vulnerability Analysis（差分解釈）→ Exploitation（成立条件の切り分け）
  - 前後接続（1行）：教材が“差分を作れる”構造だと、分析→検証→結論が再現可能になり、以降のtopics/labsに直結する
- MITRE ATT&CK：
  - 該当戦術：Reconnaissance / Discovery / Collection（API面・データ面の把握）＋（必要時）Credential Access（トークン観測）/ Lateral Movement（権限伝播の理解）
  - 攻撃者の目的：APIの境界（権限・データ・外部連携）を“通信差分”で特定し、次の手を選ぶ

## 目的（この技術で到達する状態）
- API（REST/GraphQL）を、ツールの操作ではなく **境界（資産/信頼/権限）→観測→差分→意思決定** で回せる教材を最小セットで選べる。
- OWASP API Security Top 10 2023 の主要リスク（BOLA/BOPLA、認証/認可不備、消費制御、設定不備等）を、教材の通信差分として再現できる。
- 証跡（Proxyログ/HAR/pcap/サーバログ）と巻き戻し（snapshot/reset）を前提に、同条件比較が成立する。

## 前提（対象・範囲・想定）
- 対象：自前検証環境（VirtualBox想定）。VMwareは現時点で扱わない。
- 観測点固定：
  - Attack Box 側で Proxy/HAR/pcap を集約し、APIクライアント（curl/Postman等）も可能ならAttack Box側に寄せる
  - Target（API教材）は Host-Only 等の閉域で稼働し、外部露出は最小化する
- 依存（関連ファイル）：
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
  - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`
  - `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`
- やらないこと：
  - 教材を増やして満足する（比較不能になる）
  - “脆弱性名の網羅”を目的化する（境界の観測と差分説明が主目的）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### API教材の選定で見るべき「境界」
- 資産境界（データの単位）
  - ユーザ/注文/車両/予約など、オブジェクトが明確で「誰のデータか」が分かる
  - 返却データに“過剰”が起きる余地（フィールド単位の境界）がある
- 信頼境界（外部連携/内部連携の単位）
  - IDP相当（トークン発行）、外部サービス相当（メール/通知/ファイル/検索等）が“どこで切り替わるか”
  - Webhook/URL fetch 等、外部へ出る点（または出る想定）がモデル化されている
- 権限境界（判定の単位）
  - ロール（一般/管理）・テナント・スコープ等が、ヘッダ/トークン/パラメータの差分として観測できる
  - オブジェクト単位（BOLA）だけでなく、プロパティ単位（BOPLA）も差分に落ちる

### 通信として差分を作れるか（API特有の観測）
- 認証/セッション（トークン）：
  - トークン種別（Bearer/JWT/API key等）が分かり、更新/失効/寿命が差分として取れる
- 認可：
  - 403/404/200 の差分が“権限境界”に紐づいて再現する（オブジェクトID・スコープ等）
- 入力/解釈境界：
  - JSONフィールド、ネスト、配列、Content-Type、OpenAPI/GraphQLスキーマ等が観測できる
- 消費制御：
  - レート制限、ページング、検索/フィルタの負荷差が“制御の有無”として観測できる

### 証跡と巻き戻し（教材として回る条件）
- Proxyログ：リクエスト/レスポンス差分（ヘッダ/ボディ/ステータス）
- HAR：ブラウザ経由のAPI呼び出しがある場合の補助（ただしAPIはCLI主体でも可）
- pcap：到達性/プロトコル差分（TLS/HTTP/2/HTTP/3等）と“観測点ズレ”の切り分け
- 巻き戻し：教材を壊しても、クリーン状態へ即復帰できる（教材ごとに基準点がある）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- ここでの成果（選定結果）が示す状態
  - APIの主要境界（資産/信頼/権限）を、通信差分として再現できる教材が確定している
  - 実務でのAPI診断に直結する「観測点・差分セット・証跡セット」の型が作れる
- ここでは言えないこと（限界）
  - 実務対象の権限モデル・データモデルが教材と一致するとは限らない
  - 教材は“境界観測の練習台”。結論の出し方（前提条件の明示）を身につけるのが目的

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- 優先度（最初に見る差分）
  1) 認証/トークンの境界（未認証→認証）  
  2) 認可の境界（一般→管理、Aユーザ→Bユーザ、テナントA→B）  
  3) プロパティ境界（返る/返らない、更新できる/できない）  
  4) 消費制御（制限がある/ない、閾値がどこか）
- 攻め筋（検証仮説の作り方）
  - “権限境界が入力に表れているか”を差分で確認し、以降の検証を短距離化する
  - 失敗（見えない/ブレる）は「観測点がズレている」可能性として扱い、HAR/pcap/ログへ観測点を移す

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：REST中心で、API Security Top 10 の基礎境界を一気に回したい
- 選定（最小セット：2つ）
  - REST教材1：オブジェクト/権限が明確でBOLA差分が取りやすい教材
  - REST教材2：入力/プロパティ境界（BOPLA、マスアサイン等）を差分で取りやすい教材
- 次の一手
  - まず「未認証→認証」「一般→管理（またはユーザA→B）」の2条件差分を取り、観測点（Proxyログ）に残す

### 仮説B：GraphQL をAPI教材として独立に鍛えたい（スキーマ/クエリ境界）
- 選定
  - GraphQL教材：スキーマがあり、クエリ/レスポンスの境界が差分で取れる教材
- 次の一手
  - スキーマ由来の境界（フィールド/型/認可）を「何が返る/返らない」の差分で固定し、以降のtopicsへ接続する

### 仮説C：教材が多くなり比較不能になりそう
- 増やす条件（明確化）
  - 既存教材で差分セット（最低2条件）が取れており、説明できる
  - 新教材は“埋めたい境界”が明確（例：Webhook、mTLS、API Gateway相当）
- 次の一手
  - 追加は1つずつ。追加のたびに「観測点・証跡・巻き戻し」が崩れていないかを確認する

## 推奨API教材（最小セット案：まずは3つ以内）
- REST（大本命）：オブジェクト境界が明確で、認証/認可/データの差分が作りやすい教材
- REST（補助）：小さめで反復が速く、API Top 10 を素直に練習できる教材
- GraphQL（任意）：スキーマ/フィールド認可の境界を学ぶ教材（必要になった時点で導入）

## 手を動かす検証（このファイルの完了条件）
- API教材を2つ（REST×2 または REST+GraphQL）に絞って選定できている
- 各教材について、以下を1ページで説明できる（メモで可）
  - 学べる境界（資産/信頼/権限）
  - 取るべき証跡（Proxy/HAR/pcap/ログ）
  - 最小差分セット（未認証→認証、一般→管理 等）
  - 巻き戻し基準（クリーン状態の定義）
- “教材を増やす前に差分を取る”運用になっている

## コマンド/設定例（例示は最小限）
~~~~
# 目的：教材を「上げ下げ」できる状態を作る（攻撃手順ではない）

# 例：docker-compose が用意されている教材の場合
# docker compose up -d

# 例：単体コンテナで起動できる教材の場合
# docker run --rm -p <port>:<port> <image>
~~~~
- この例で観測していること：
  - 教材の稼働状態と到達性（Host-Only内で届くか）
  - Proxy/pcapで通信が観測できるか（観測点が成立しているか）

## 参考（必要最小限）
- OWASP API Security Top 10 2023（カテゴリ定義）
- 教材候補（REST）：crAPI / VAmPI
- 教材候補（GraphQL）：DVGA

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 関連 labs：`04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

---

<<<END>>>
