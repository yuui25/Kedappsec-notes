<<<BEGIN>>>
# 03_ad_lab_検証用ドメイン構成.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - 位置づけ：Webの認証/セッション/認可を「企業の実体（IdP/Directory/端末信頼）」へ接続して説明するための前提基盤（統合認証・端末/ユーザ境界の理解）
  - 支えるポイント：認証の“成立点”がWeb単体ではなく、ディレクトリ/端末/ネットワーク境界で決まるケースを再現できる
- WSTG：
  - 位置づけ：認証/セッション/認可のテストを「バックエンドの身元基盤（AD/Kerberos/LDAP）」に結びつける前提
  - 支えるポイント：Web側の挙動差（401/302/403等）を“身元基盤・到達性・信頼境界”の差分として解釈できる
- PTES：
  - 該当フェーズ：Pre-engagement（検証環境設計）→ Intelligence Gathering（到達性/列挙）→ Vulnerability Analysis（境界/権限差分）→ Exploitation（成立条件の切り分け）
  - 前後接続（1行）：ADラボがあると「NW側の境界→認証基盤→権限伝播」を連続した検証として回せる
- MITRE ATT&CK：
  - 戦術の位置づけ：Discovery / Credential Access / Privilege Escalation / Lateral Movement / Collection
  - 攻撃者の目的：到達性と権限境界を把握し、認証情報・チケット・権限伝播を使って横展開する流れを“閉域で再現”する

## 目的（この技術で到達する状態）
- AD（ディレクトリ）を「用語理解」ではなく、**境界（資産/信頼/権限）→観測→差分→意思決定** で回せる検証ラボを作る。
- Web/NW=5:5 のNW側の中核として、Kerberos/LDAP/DNS/SMB等の“実通信”を観測し、Web側（SSO/統合認証）の前提にも接続できる状態にする。
- 証跡（pcap/ログ）と巻き戻し（snapshot/reset）を前提に、壊して学ぶ→即復帰の反復が成立する。

## 前提（対象・範囲・想定）
- 対象：自前検証環境（VirtualBox想定）。外部への攻撃/スキャンを意図しない閉域ラボ。
- 観測点固定：
  - Attack Box：pcap取得・疎通確認・列挙の最小検証（証跡集約）
  - ADラボ：Host-Only 等の検証セグメント内で完結
- 依存（関連ファイル）：
  - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`（到達性の設計）
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`（証跡の最小セット）
  - `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`（復帰運用）
- やらないこと：
  - “攻撃手順書”の作成（ここはラボの設計＝観測と差分比較の土台）
  - 実ネットワーク常時接続（Bridge常用）を前提にした構成
  - いきなりフル機能（AD CS/ADFS/複数フォレスト等）を載せる（必要になってから増築）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 観測対象（プロトコル）
- 名前解決：DNS（「どこに問い合わせ、何が返るか」）
- 認証：Kerberos（チケットの取得/更新という“状態変化”）
- ディレクトリ：LDAP（ユーザ/グループ/属性が“どこで参照されるか”）
- ファイル/リモート操作の入口：SMB/RPC（到達性と権限境界が見えやすい）

### 境界（Boundary）
- 資産境界：
  - DC（ドメイン情報/認証の中心）と、メンバーサーバ/クライアントの役割分離
  - どのログを“証跡”として残すか（DCログ/サーバログ/pcap）
- 信頼境界：
  - 検証セグメント（Host-Only）の外に出ない（外部依存がない）
  - 認証要求が「どこに向かうか」（DCに集約される境界）
- 権限境界：
  - ドメイン管理権限 vs ローカル管理権限 vs 一般ユーザ
  - “権限がどこで切り替わるか”（グループ/委任/ローカル権限付与）

### 取るべき証跡（最小セット）
- pcap（Attack Box側）：DNS/Kerberos/LDAP/SMB の到達性と会話の“存在”を押さえる
- Windowsログ（可能なら）：
  - DC：認証・ディレクトリ操作の痕跡（成功/失敗・誰が・どこから）
  - Member Server / Client：ログオン・ネットワークアクセス・管理操作の痕跡
- メタ情報（必須）：
  - “どの状態のスナップショット”から開始したか（クリーン/教材状態/検証中）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（状態としての結論）
  - どの端末が、どの相手（DC/サーバ）に、どのプロトコルで到達しているか（到達性）
  - 認証が「成立している/していない」「どこで失敗しているか」（境界の位置）
  - 権限差（一般/管理）が“どの操作で現れるか”（権限境界の実体）
- 言えないこと（限界）
  - ADの内部状態（GPO/ACL/委任）の正確な断定は、設定・ログ・観測点が揃わない限り推測しない
  - pcapだけでは「なぜ許可されたか/拒否されたか」の最終理由は断定しない（設定と突合する）

## ラボ構成（最小で強い：まずはこれだけ）
### 役割（VM）
- DC（Domain Controller）：
  - DNS + Kerberos + LDAP の中心（“身元と認証”の中核）
- Member Server（任意だが推奨）：
  - 共有/サービス配置用（SMB等の“横移動の入口”と権限差が見えやすい）
- Workstation（任意だが推奨）：
  - 端末視点（ユーザ操作、資格情報/チケットの“所在”が理解しやすい）
- Attack Box：
  - 観測（pcap）・疎通・差分比較（※攻撃実行ではなく、観測点の固定が主目的）

### ネットワーク（到達性の固定）
- 原則：Host-Only 内に閉じる
- 例：
  - Attack Box：NAT（更新）＋ Host-Only（検証）
  - DC/Member/Workstation：Host-Only のみ
- 意味：
  - “外部へ出ない”ことで、観測される通信がラボ内の因果に限定され、差分比較が成立する

### 命名/アカウント（差分比較のための最小設計）
- ドメイン名：社内名と混同しない（例：`lab.local` のような閉域前提名）
- ユーザ：
  - 一般ユーザ（最低1名）
  - 管理者（ドメイン管理/サーバ管理の差分が取れるように）
- グループ/権限：
  - “何のために差分を作るか”が決まってから最小追加（最初から複雑化しない）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
> ここでは“やり方”ではなく、観測にもとづく意思決定の型を作る。

- 優先度（まず確定する差分）
  1) 到達性：DC/サーバへ届くか（DNS→認証→共有の順で境界を確定）
  2) 身元：どのユーザ状態で何ができるか（一般 vs 管理）
  3) 権限伝播：ローカル権限とドメイン権限が“どこで切り替わるか”
- 仮説の立て方（例）
  - もし認証が成立しないなら：名前解決/時刻/到達性のどこが境界かを先に切る
  - もし共有に届くが操作できないなら：権限境界（グループ/ACL/ローカル権限）の問題として切る
- 次の一手の選び方
  - “失敗”は価値ある状態：どの境界で止まったかを証跡として固定し、設定側の確認（または構成の見直し）に繋げる

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：最短でADの「境界と到達性」を掴みたい（最小ラボ）
- 構成：
  - DC + Attack Box（まず2台）
- 取る差分（最小）：
  - DNSが引ける/引けない
  - 認証が成立する/しない
- 次の一手：
  - ここが安定したら Member Server を追加し、権限差（一般/管理）の“実行可能差分”を作る

### 仮説B：横展開や権限差まで含めて“NW側5割”を回したい（推奨ラボ）
- 構成：
  - DC + Member Server + Workstation + Attack Box
- 取る差分（最小）：
  - 一般ユーザの到達可能範囲（見える/見えない）
  - 管理者の到達可能範囲（できる/できない）
- 次の一手：
  - 観測点（pcap/ログ/スナップショット）が固定できたら、以降の `01_topics/` のAD・認証・横展開系に接続して深掘りする

### 仮説C：構成が壊れやすく、反復が止まりそう
- 分岐基準（見直す条件）
  - 巻き戻しが1手でできない
  - ログ/pcapが散逸して差分比較できない
- 次の一手
  - 役割を減らす（DC+Attack Boxに戻す）か、スナップショット基準点を増やす（教材状態を細かく切る）

## 手を動かす検証（このファイルの完了条件）
- Host-Only 内で、Attack Box から DC（必要なら Member/Workstation）へ到達できる
- “DNS→認証→（任意で）共有”の順に、境界がどこにあるかを説明できる
- pcap を最小セットで取得し、どのプロトコル会話が発生しているかを示せる
- クリーン状態（ベース）と教材状態（AD構成後）のスナップショットがあり、即復帰できる
- 一般ユーザ/管理者の差分（何ができる/できない）を、設定ではなく“状態”として言語化できる

## コマンド/設定例（例示は最小限）
~~~~
# 目的：到達性と境界（名前解決/認証）を“状態”として確定するための最小確認例

# 名前解決（どこに問い合わせているかが重要）
nslookup <dc-hostname> <dc-ip>

# ルーティング/IF（観測点の前提）
ip a
ip route

# 以降の詳細な検証コマンドは、設計（観測点・証跡・巻き戻し）が固まってから必要最小限で追加する
~~~~

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 関連 labs：`04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

---

<<<END>>>
