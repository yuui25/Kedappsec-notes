<<<BEGIN>>>
# 01_aws_lab_構成と検証観点.md

## 目的（この技術で到達する状態）
- AWSの検証環境を「とりあえず動いた」ではなく、**境界（資産/信頼/権限）→観測→差分→意思決定**で回せる設計として構築できる。
- Web/NW=5:5 の観点で、クラウド特有の攻撃面（公開面/IAM/ネットワーク/ストレージ/メタデータ/ログ）を **“構成差分”として再現**し、結論を証跡で説明できる。
- 破壊的な検証も含めて、**巻き戻し（IaC再適用・再作成）**で短サイクル反復できる。

## 前提（対象・範囲・想定）
- 対象：自分が管理するAWSアカウント、または明示的に許可された検証環境のみ。
- 想定：
  - クラウドは「設定=挙動」。同一アプリでも IAM/ネットワーク/公開範囲/ログ設定の差で結論が変わる。
  - “最小構成で差分比較できる”ことを優先し、初期から複雑化しない。
- やらないこと：
  - 実環境・第三者資産への探索/侵害を意図する行為
  - クリック手順の羅列（手順書化）で終えること
- 依存（観測点と復帰）：
  - ローカル観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md` / `03_capture_証跡取得（pcap/har/log）.md`
  - 巻き戻し：`04_labs/05_automation/01_iac_terraform_or_bicep.md`
  - 参照：`01_topics/01_asm-osint/05_cloud_露出面（CDN/WAF/Storage等）推定.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 観測対象（AWSで“状態”として押さえるもの）
- 資産境界（どこまでが対象/管理主体か）
  - アカウント境界：1つの検証アカウント内で完結しているか
  - ネットワーク境界：VPC / Subnet（Public/Private）/ Route / Security Group / NACL
  - データ境界：S3（公開/非公開）/ Secrets（Secrets Manager相当）/ 鍵（KMS相当）
- 信頼境界（どこから先が第三者/外部連携か）
  - 公開面：Internet-facing な入口（LB/公開IP/公開API）
  - 外部依存：外部API/外部IDP/CI/CD（最初は原則“無し”で始め、必要時に足す）
  - メタデータ到達性：インスタンス/ワーカーが「自分の権限情報」に到達できる条件
- 権限境界（どこで権限が切り替わる/伝播するか）
  - IAMユーザ/ロール/ポリシー/条件（Condition）
  - “誰が呼ぶか”と“何を触れるか”（管理APIとデータアクセス）を分けて観測する
  - アプリ→AWS API の呼び出し（インスタンスロール/タスクロール）の伝播
- 証跡（結論の根拠になるログ）
  - 監査：管理APIの実行痕跡（誰が/いつ/何をしたか）
  - ネットワーク：到達性の痕跡（入口/出口、通信の有無）
  - アプリ：入口のアクセスログ（HTTP差分）＋（必要なら）アプリログ
  - 変更履歴：設定差分（いつ何が変わったか）

## 設計方針（必ず守る）
- “教材”としてのAWS：実務っぽさより **差分比較**（条件A/Bで挙動が変わる点）を優先する。
- 公開面は最小：インターネット公開は「入口1つ」に絞り、内部は閉じる。
- 依存を減らす：外部IDPや複雑なマルチアカウントは、必要になってから追加する。
- 証跡が残らない検証はしない：ログが無い状態で「〜できる/できない」を断言しない。
- 巻き戻しは“再作成”が基本：スナップショット思考ではなく、IaCで同条件を再現する。

## 推奨ラボ構成（最小で強い：標準形）
### 標準形（Web/NWの境界が揃う）
- 公開面（入口）
  - Internet-facing なHTTP入口（例：LB/公開Web）
- 内部面（閉域）
  - Private相当のアプリ/API（外部から直接叩けない）
- データ面
  - S3相当のオブジェクト（公開/非公開の差分が作れる）
- IAM
  - “操作主体”を最小で分ける（管理者/運用者/アプリロール）
- Logging
  - 監査ログ（管理API）＋ネットワークログ（到達性）＋入口ログ（HTTP）

### ここで作る「差分比較の軸」（例）
- 公開差分：公開（誰でも到達） vs 非公開（閉域）
- 権限差分：アプリロールA（S3 readのみ） vs ロールB（read/write）
- 経路差分：入口経由でのみ到達 vs 直接到達（できないはず）
- 設定差分：CORS/ヘッダ/キャッシュ/署名URL等（“設定=挙動”を体感できる範囲）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（状態としての結論）
  - 公開面が何か（どの入口が外に出ているか）
  - 入口から内部へどこまで到達できるか（到達性の境界）
  - どの主体（人/アプリ）が、どのAWSリソースに何の権限で触れたか（権限境界）
  - その根拠（監査/ネットワーク/入口ログ）が揃っている
- 言えないこと（限界）
  - ログが無い/相関できない状態での断定（“たぶん〜”は禁止）
  - 設計図だけでの安全性断定（検証で差分を取って初めて言える）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
> ここは“攻撃手順”ではなく、観測にもとづく意思決定の型を作る。

- 優先度（最初に確定する）
  1) 公開面：外部から到達できる入口は何か（1つに絞れているか）
  2) 境界：入口→内部→データの導線がどこで切れているか
  3) 権限：アプリが持つ権限が最小化されているか（読める/書けるの差分）
  4) 証跡：上記を裏付けるログが揃っているか（結論の根拠）
- 仮説の立て方（例）
  - もし「内部に直接到達できる」なら：ネットワーク境界の設計差（SG/Route/公開設定）として扱う
  - もし「アプリからデータに触れ過ぎる」なら：IAM境界（ロール/ポリシー/条件）の差として扱う
  - もし「結論がブレる」なら：観測点（ローカル/クラウドログ）の不足か相関失敗として扱う

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：まず“公開面と到達性”の地図を作りたい（NW寄り）
- 次に試すこと
  - 公開入口を1つに絞り、内部は閉域にする構成で固定する
  - ネットワークログで「入口→内部」への通信有無を根拠化する
- 期待する差分
  - 入口以外からの到達が“できない”ことを、設計とログで説明できる

### 仮説B：次に“IAMと権限伝播”を体感したい（権限境界寄り）
- 次に試すこと
  - アプリロールを2種類に分け、同じ処理でも結果が変わる差分を作る（read-only vs read/write 等）
  - 監査ログで「どの主体が何を実行したか」を相関できるようにする
- 期待する差分
  - “同じ入口でも、権限で結果が変わる”を証跡で説明できる

### 仮説C：コスト/運用負荷で反復が止まりそう（継続性寄り）
- 次に試すこと
  - IaCで作る範囲を小さくし、検証単位を縮める（差分セットを減らす）
  - 使い終わったら破棄（destroy）までが1サイクルになるよう設計する
- 期待する差分
  - 検証→破棄→再作成が短サイクルになり、学習が止まらない

## 手を動かす検証（このファイルの完了条件）
- “標準形（入口/内部/データ/IAM/ログ）”の各要素について、以下を1ページで説明できる（メモで可）
  - 資産境界：対象リソースの範囲（アカウント/VPC/データ）
  - 信頼境界：公開面と外部依存の有無
  - 権限境界：主体（人/アプリ）と権限（できる/できない）
  - 証跡：監査/ネットワーク/入口ログの相関キー
- 差分セットが最低2条件定義されている（例：公開/非公開、ロールA/ロールB）
- 巻き戻しが「再作成（IaC）」で成立する前提が置けている（破棄までを含む）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 該当領域：V1（アーキテクチャ）/ V4（アクセス制御）/ V7（エラー処理・ログ）/ V8（データ保護）/ V13（API）など
  - このファイルが支える点：クラウド構成差分（公開面/IAM/ログ）を固定し、「管理策がどこで満たされ/破れるか」を説明可能にする
- WSTG：
  - 該当観点：設定/認証/認可/APIの検証における“前提環境”（観測点・差分比較・証跡）を整える
  - 該当が薄い場合の接続：WSTGの各テストを“実施して差分を観測できる”状態を作る、という前提として位置づける
- PTES：
  - 該当フェーズ：Pre-engagement（環境準備）/ Intelligence Gathering（公開面と境界把握）/ Vulnerability Analysis（差分解釈）
  - 前後接続（1行）：AWSの境界と証跡を固定することで、分析→検証→結論がブレない
- MITRE ATT&CK：
  - 該当戦術：Discovery / Collection（公開面・権限・ログの把握）＋（必要時）Credential Access（権限情報）/ Lateral Movement（権限伝播の理解）
  - 攻撃者の目的：公開面と権限境界を把握し、次の手（到達性/権限伝播/データ到達）を選ぶ前提を作る

## 参考（必要最小限）
- `04_labs/04_cloud/03_logging_クラウド監査ログの取り方.md`
- `04_labs/05_automation/01_iac_terraform_or_bicep.md`
- `01_topics/01_asm-osint/05_cloud_露出面（CDN/WAF/Storage等）推定.md`

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/04_cloud/03_logging_クラウド監査ログの取り方.md`
- 関連 labs：`04_labs/05_automation/01_iac_terraform_or_bicep.md`
- 関連 topics：`01_topics/01_asm-osint/05_cloud_露出面（CDN/WAF/Storage等）推定.md`

---

<<<END>>>
