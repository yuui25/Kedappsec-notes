<<<BEGIN>>>
# 02_azure_lab_構成と検証観点.md

## 目的（この技術で到達する状態）
- Azureの検証環境を「構築できた」で止めず、**境界（資産/信頼/権限）→観測→差分→意思決定**として回せる設計にする。
- Web/NW=5:5 の観点で、Azure特有の攻撃面（公開面/ネットワーク/IAM/ストレージ/マネージドID/ログ）を **“構成差分”として再現**し、結論を証跡で説明できる。
- 破壊して学ぶ→即復帰を、**IaC（Bicep/Terraform）で再作成**として成立させ、短サイクルで反復できる。

## 前提（対象・範囲・想定）
- 対象：自分が管理する Azure Tenant / Subscription、または明示的に許可された検証環境のみ。
- 想定：
  - Azureは「設定=挙動」。同じアプリでも、公開設定・NSG/経路・ロール割当・診断設定の差で結論が変わる。
  - 最初は“最小で強い標準構成”で差分比較できることを優先し、複雑化は後回しにする。
- やらないこと：
  - 実環境・第三者資産への探索/侵害を意図する内容
  - クリック手順の羅列（手順書化）で終えること
- 依存（観測点と復帰）：
  - ローカル観測：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md` / `03_capture_証跡取得（pcap/har/log）.md`
  - 巻き戻し：`04_labs/05_automation/01_iac_terraform_or_bicep.md`
  - 参照：`01_topics/01_asm-osint/05_cloud_露出面（CDN/WAF/Storage等）推定.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 資産境界（どこまでが対象/管理主体か）
- Tenant / Subscription / Management Group の境界
- Resource Group 境界（検証用RGに集約して“対象範囲”を明確化）
- ネットワーク境界：VNet / Subnet / Route / NSG /（必要時）Firewall
- データ境界：Storage（Blob等）/ Key Vault（秘密情報）/ 監視基盤（Log Analytics等）

### 2) 信頼境界（どこから先が第三者/外部連携か）
- 公開面：Public Endpoint（インターネット到達）を1つに絞る
- 外部依存：外部API/外部IdP/CI/CD（最初は原則“無し”、必要になったら追加）
- メタデータ・管理面：VM/アプリが「自身の権限情報」に到達できる条件（Managed Identityの境界）

### 3) 権限境界（どこで権限が切り替わる/伝播するか）
- Entra ID（旧Azure AD）：
  - “人の身元”と“クラウド権限（RBAC）”を分けて観測する
- Azure RBAC：
  - ロール割当（誰に/どのスコープで/何を許可）と、実際の挙動差分
- マネージドID（アプリ/VMの主体）：
  - アプリ→Azure API（Storage/Key Vault等）への権限伝播の境界

### 4) 証跡（結論の根拠になるログ）
- 監査：
  - 誰が/いつ/何を変更したか（管理操作の痕跡）
- ネットワーク：
  - 到達性の痕跡（入口/出口、許可/拒否の有無）
- アプリ：
  - 入口ログ（HTTP差分）＋（必要なら）アプリログ
- 変更履歴：
  - 設定差分（いつ何が変わったか）を追える状態（IaC＋監査で裏付け）

## 設計方針（必ず守る）
- Azureは“教材”。実務っぽさより **差分比較**（条件A/Bで挙動が変わる点）を優先する。
- 公開面は最小：インターネット公開は「入口1つ」に限定し、内部は閉域にする。
- 外部依存を減らす：最初は単一サブスクリプション・単一RGで完結させる。
- 証跡が残らない検証はしない：ログがない状態で断言しない。
- 巻き戻しは“再作成”：スナップショット思考ではなく、IaCで同条件を再現する。

## 推奨ラボ構成（最小で強い：標準形）
### 標準形（Web/NW/IAM/ログの境界が揃う）
- 公開面（入口）
  - 例：App Service /（必要時）Application Gateway / Front Door 相当の入口のうち「1つ」
- 内部面（閉域）
  - 例：Private Subnet上のAPI、または Private Endpoint 経由でしか触れないデータ面
- データ面
  - 例：Storage（公開/非公開の差分を作れる）
- IAM（権限差分の教材化）
  - 人（管理者/運用者）＋アプリ主体（Managed Identity）を分ける
- Logging
  - 監査（管理操作）＋ネットワーク（到達性）＋入口（HTTPアクセス）の3点を必ず揃える

### ここで作る「差分比較の軸」（例）
- 公開差分：Public endpoint あり vs なし（閉域/Private化）
- 権限差分：Managed Identity ロールA（read） vs ロールB（read/write）
- 経路差分：入口経由でのみ到達 vs 直接到達（できないはず）
- 設定差分：CORS/ヘッダ/認証要求/診断設定（“設定=挙動”の体感）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 言えること（状態としての結論）
  - 公開面が何か（どの入口がインターネット到達か）
  - 入口から内部へどこまで到達できるか（到達性の境界）
  - どの主体（人/アプリ）が、どのリソースに、どのスコープで権限を持つか（権限境界）
  - その根拠（監査/ネットワーク/入口ログ）が揃っている
- 言えないこと（限界）
  - ログが無い/相関できない状態での断定（推測で断言しない）
  - 設計図だけでの安全性断定（差分検証で裏付ける）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
> ここは“攻撃手順”ではなく、観測にもとづく意思決定の型を作る。

- 優先度（最初に確定する）
  1) 公開面：外部から到達できる入口は何か（1つに絞れているか）
  2) 境界：入口→内部→データがどこで切れているか（Private化/NSG/経路）
  3) 権限：アプリ主体（Managed Identity）が持つ権限が最小化されているか（read/write差分）
  4) 証跡：上記を裏付けるログが揃っているか（結論の根拠）
- 仮説の立て方（例）
  - もし内部に直接到達できるなら：ネットワーク境界（Public化/NSG/Route/Private Endpoint）の差として扱う
  - もしアプリがデータに触れ過ぎるなら：RBAC境界（割当スコープ/ロール/条件）の差として扱う
  - もし結論がブレるなら：観測点（ローカル/クラウドログ）の不足か相関失敗として扱う

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：まず“公開面と到達性”の地図を作りたい（NW寄り）
- 次に試すこと
  - 公開入口を1つに絞り、内部は閉域にする構成で固定する（Private化の軸を作る）
  - ネットワーク系の証跡で「入口以外は到達できない」を根拠化する
- 期待する差分
  - 入口以外からの到達が“できない”ことを、設計とログで説明できる

### 仮説B：次に“RBACと権限伝播（Managed Identity）”を体感したい（権限境界寄り）
- 次に試すこと
  - アプリ主体の権限を2種類に分け、同じ処理でも結果が変わる差分を作る（read-only vs read/write）
  - 監査ログで「どの主体が何をしたか」を相関できるようにする
- 期待する差分
  - “同じ入口でも、権限で結果が変わる”を証跡で説明できる

### 仮説C：コスト/運用負荷で反復が止まりそう（継続性寄り）
- 次に試すこと
  - IaCの対象を小さくし、検証単位を縮める（差分セットを減らす）
  - 使い終わったら破棄（削除）までを1サイクルにする
- 期待する差分
  - 検証→破棄→再作成が短サイクルになり、学習が止まらない

## 手を動かす検証（このファイルの完了条件）
- “標準形（入口/内部/データ/IAM/ログ）”の各要素について、以下を1ページで説明できる（メモで可）
  - 資産境界：対象リソース範囲（Tenant/Subscription/RG/VNet/データ）
  - 信頼境界：公開面と外部依存の有無
  - 権限境界：主体（人/アプリ）と権限（できる/できない）＋スコープ
  - 証跡：監査/ネットワーク/入口ログの相関キー
- 差分セットが最低2条件定義されている（例：公開/非公開、ロールA/ロールB）
- 巻き戻しが「再作成（IaC）」で成立する前提が置けている（破棄までを含む）

## コマンド/設定例（例示は最小限）
~~~~
# 目的：巻き戻しを「再作成」で成立させる（手順の本体は 05_automation 側に寄せる）
# bicep / terraform の実行例は 04_labs/05_automation/01_iac_terraform_or_bicep.md に集約する

# 例（概念）：
# terraform init
# terraform apply
# terraform destroy
~~~~
- この例で観測していること：環境差を“再現”できるか（同条件比較の土台）
- 出力のどこを見るか：構成（境界）が固定され、ログ/証跡が毎回同じ観測点で取れるか

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回）
- ASVS：
  - 該当領域：V1（アーキテクチャ）/ V4（アクセス制御）/ V7（エラー処理・ログ）/ V8（データ保護）/ V13（API）など
  - このファイルが支える点：Azure構成差分（公開面/RBAC/ログ）を固定し、「管理策がどこで満たされ/破れるか」を説明可能にする
- WSTG：
  - 該当観点：設定/認証/認可/APIの検証における“前提環境”（観測点・差分比較・証跡）を整える
  - 該当が薄い場合の接続：WSTGの各テストを“実施して差分を観測できる”状態を作る前提として位置づける
- PTES：
  - 該当フェーズ：Pre-engagement（環境準備）/ Intelligence Gathering（公開面と境界把握）/ Vulnerability Analysis（差分解釈）
  - 前後接続（1行）：Azureの境界と証跡を固定することで、分析→検証→結論がブレない
- MITRE ATT&CK：
  - 該当戦術：Discovery / Collection（公開面・権限・ログの把握）＋（必要時）Credential Access（権限情報）/ Lateral Movement（権限伝播の理解）
  - 攻撃者の目的：公開面と権限境界を把握し、次の手（到達性/権限伝播/データ到達）を選ぶ前提を作る

## 参考（必要最小限）
- `04_labs/04_cloud/03_logging_クラウド監査ログの取り方.md`
- `04_labs/05_automation/01_iac_terraform_or_bicep.md`
- `01_topics/01_asm-osint/05_cloud_露出面（CDN/WAF/Storage等）推定.md`

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/04_cloud/03_logging_クラウド監査ログの取り方.md`
- 関連 labs：`04_labs/05_automation/01_iac_terraform_or_bicep.md`
- 関連 topics：`01_topics/01_asm-osint/05_cloud_露出面（CDN/WAF/Storage等）推定.md`

---

<<<END>>>
