<<<BEGIN>>>
# 03_logging_クラウド監査ログの取り方.md

## 目的（この技術で到達する状態）
- クラウド検証（AWS/Azure）で「結論」を出すために必要な証跡を、**監査ログ・ネットワークログ・アプリ入口ログ**の3系統で揃えられる。
- “見えない/分からない”を放置せず、**yes/no/unknown** を必ず出す（unknown なら理由と次の観測点を定義できる）。
- ローカル側（Proxy/HAR/pcap）とクラウド側（監査/NW/変更履歴）を相関し、**差分比較（条件A/B）**で結論の再現性を作れる。

## 前提（対象・範囲・想定）
- 対象：自分が管理するAWSアカウント / Azureサブスクリプション（検証環境）に限定する。
- 想定：クラウドの論点は「設定と権限」。ログが無いと、結果が“たまたま”に見えてしまう。
- 依存（関連ファイル）：
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`（ローカル証跡）
  - `04_labs/04_cloud/01_aws_lab_構成と検証観点.md` / `02_azure_lab_構成と検証観点.md`
- やらないこと：
  - ログの設定手順の網羅（クリック手順の羅列）
  - ログの“集めるだけ”運用（結論の根拠にするための相関キーが主役）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 監査ログ（Management plane：管理操作の痕跡）
- 目的：誰が/いつ/どのAPI（または操作）で/何を変えたかを確定する
- 典型的に見たいこと：
  - リソース作成/削除/設定変更
  - IAM/RBAC（権限付与/剥奪/ロール変更）
  - ネットワーク（SG/NSG、ルート、公開設定）変更
  - ストレージ公開/アクセス制御変更
- 結論の型：
  - yes：該当操作がログで確認でき、主体と影響範囲が説明できる
  - no：該当操作はログ上存在しない（別経路/別主体の可能性を検討）
  - unknown：ログが未有効、欠落、権限不足、保存期間外 等（次の観測点へ）

### 2) ネットワークログ（Data planeの到達性）
- 目的：通信が「届いた/届いていない」「どこで止まったか」を確定する
- 典型的に見たいこと：
  - 公開入口への到達（インターネット→入口）
  - 入口→内部（サブネット/Private）への到達
  - 内部→外部（Egress）の有無
- 結論の型：
  - yes：通信が記録され、送受信元/ポート/許可・拒否が説明できる
  - no：通信は記録されない（経路が違う/ログ対象外/到達していない）
  - unknown：ログが未有効/粒度不足/収集先不明（観測設計の見直し）

### 3) 入口ログ（アプリ・Web/APIのアクセスログ）
- 目的：HTTP差分（200/302/401/403/404）と条件（ヘッダ/トークン/入力）を結びつける
- 典型的に見たいこと：
  - リクエストの痕跡（パス/メソッド/クライアントIP/UA）
  - 認証・認可の結果（401/403）と発生条件
  - リダイレクト/キャッシュ等の“境界の揺れ”
- 結論の型：
  - yes：要求が届き、結果がログとして残っている（差分説明可能）
  - no：要求が届いていない/入口が違う（到達性の問題）
  - unknown：ログが無い/粒度不足（入口のログ設定が不十分）

### 4) 変更履歴（設定差分：いつ何が変わったか）
- 目的：検証結果の“ブレ”を、設定差分として説明する
- 典型的に見るもの：
  - 設定変更イベント（監査ログ）
  - IaC差分（plan/applyの差分）
- 結論の型：
  - yes：差分が記録され、検証結果の違いを説明できる
  - no：差分は無い（別要因：キャッシュ/条件/観測点ズレを疑う）
  - unknown：記録が欠落（保管/権限/運用の問題）

## 相関キー（結論を出すために必須の“つなぎ目”）
- 最低限揃えるキー（おすすめ順）
  1) 時刻（UTC/ローカルのズレを管理する）
  2) 対象リソースID（リソース名だけでなく一意識別子）
  3) 操作主体（ユーザ/ロール/サービスプリンシパル/マネージドID）
  4) 送信元（クライアントIP、NATの出口IP、LBの経由情報）
  5) リクエスト識別子（リクエストID、トレースIDがあれば最強）
- ルール：
  - “何が根拠か”を1枚で示せないログは、結論に使えない（unknown に落とす）

## AWS：最小ログセット（教材としての標準）
> 具体名より「3系統（監査/NW/入口）」を揃えることが目的。

- 監査（Management plane）
  - 管理APIの実行痕跡（誰が何を変えたか）
- ネットワーク（到達性）
  - VPC内の到達性（許可/拒否、送受信元）
- 入口（HTTP）
  - 公開入口（LB/公開Web/API）のアクセスログ
- 変更履歴
  - IaC差分（plan/apply）＋監査ログの変更イベント

## Azure：最小ログセット（教材としての標準）
- 監査（Management plane）
  - 管理操作の痕跡（リソース変更、RBAC変更）
- ネットワーク（到達性）
  - VNet/NSGレベルの到達性（許可/拒否、フロー）
- 入口（HTTP）
  - 公開入口（App Service / Gateway等）のアクセスログ
- 変更履歴
  - IaC差分（plan/apply、またはテンプレ差分）＋監査ログ

## 失敗時の切り分け（unknown を潰すための分岐）
### A：監査ログが無い/見えない
- 可能性：
  - そもそも有効化されていない
  - 権限が不足して読めない
  - 保存期間外で消えている
- 次の一手：
  - “監査ログが取れる権限”と “保存期間” を先に固定する（unknown を yes/no に落とす）

### B：ネットワークログが「届いたか」を示さない
- 可能性：
  - 収集粒度が粗い（入口しか分からない）
  - ログ対象の境界が間違っている（見たい区間にログが無い）
- 次の一手：
  - 見たい区間（入口→内部、内部→外部）を宣言し、その区間にログを置く

### C：入口ログが不足してHTTP差分が説明できない
- 可能性：
  - 入口が違う（CDN/キャッシュ/別エンドポイント）
  - アプリ側ログが出ていない/粒度が低い
- 次の一手：
  - Proxyログ（ローカル）と入口ログ（クラウド）の両方で「届いた」を確定し、差分はアプリ側へ寄せる

## 次に試すこと（差分比較の“最小セット”を作る）
- 目的：同条件比較（A/B）で結論を出す訓練をする
- 最小差分セット例（2条件）
  - 条件A：公開入口に到達できる
  - 条件B：公開入口に到達できない（公開設定/ルールを変えた）
- 必須証跡（3点セット）
  - 監査：設定変更の痕跡（誰が変えたか）
  - NW：到達/拒否の痕跡
  - 入口：HTTP結果の痕跡（届いた/届いていない）
- 結論の出し方：
  - yes/no/unknown を必ず書き、unknown の場合は “不足している観測点” を明記する

## 手を動かす検証（このファイルの完了条件）
- AWS/Azure それぞれについて、以下を1ページで説明できる（メモで可）
  - 監査/NW/入口/変更履歴の「どれを」「どこに」「どの粒度で」残すか
  - 相関キー（時刻/主体/リソース/送信元/識別子）
- 検証1件について、yes/no/unknown を出せるテンプレ（運用）ができている
- unknown が出た場合に「次の観測点」が必ず定義される

## コマンド/設定例（例示は最小限）
~~~~
# 目的：ローカル側の証跡と相関できるように、検証メモに残す最小情報（例）

# [検証メモ]
# - 検証ID: <YYYYMMDD-HHMM-ShortName>
# - 時刻: <UTC / JST>
# - 入口URL: <...>
# - 送信元: <AttackBox IP / NAT出口IP>
# - 変更点: <SG/NSG 変更、ロール変更 等>
# - 期待: <到達/拒否>
# - 結果: yes/no/unknown
# - 根拠: <監査ログID>, <NWログ>, <入口ログ>, <Proxyログ保存先>
~~~~
- この例で観測していること：後から“根拠”を辿れること（結論の再現性）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - V7（エラー処理・ログ）を中心に、V1（アーキテクチャ）/ V4（アクセス制御）/ V8（データ保護）等の結論根拠をログで支える
- WSTG：
  - 設定/認証/認可/APIの検証における「観測点固定」と「差分説明」をログで成立させる
- PTES：
  - 検証の根拠（Evidence）を残し、Vulnerability Analysis → Exploitation の判断をブレさせない
- MITRE ATT&CK：
  - Discovery/Collection の観測（ログ）を整え、攻撃者行動の痕跡と境界を説明できる状態を作る

## 参考（必要最小限）
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- `04_labs/04_cloud/01_aws_lab_構成と検証観点.md`
- `04_labs/04_cloud/02_azure_lab_構成と検証観点.md`

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 関連 labs：`04_labs/04_cloud/01_aws_lab_構成と検証観点.md`
- 関連 labs：`04_labs/04_cloud/02_azure_lab_構成と検証観点.md`

---

<<<END>>>
