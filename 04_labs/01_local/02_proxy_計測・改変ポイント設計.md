# 02_proxy_計測・改変ポイント設計.md

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - 該当領域/章：認証/セッション、認可、API、設定、ログ（の検証を支える観測・改変基盤）
  - この内容が支えるポイント：成立条件（どのヘッダ/トークン/経路で挙動が変わるか）を“実通信の差分”として説明可能にする
- WSTG：
  - 該当カテゴリ/テスト観点：情報収集（観測前提）、認証、セッション管理、認可、API、設定/デプロイ（CORS/ヘッダ等）の各テストの実行・観測
  - 該当が薄い場合：WSTG観点を「改変して差分を見る」ための前提（観測点の固定）として接続
- PTES：
  - 該当フェーズ：Intelligence Gathering / Vulnerability Analysis / Exploitation（成立条件の切り分け）
  - 前後フェーズとの繋がり（1行）：観測点を固定して差分を取れると、分析→検証→結論がブレずに再利用できる
- MITRE ATT&CK：
  - 該当戦術：Reconnaissance / Discovery / Collection / Credential Access（観測と意思決定の土台）
  - 攻撃者の目的：境界（信頼/権限/資産）を“通信差分”として把握し、次の手（攻め筋）を選ぶ

## 目的（この技術で到達する状態）
- Web検証の中心となる「計測点（Proxy）」を、自分で設計できる（どこに置くか／何が見えるか／何が見えないか）。
- “とりあえずBurp”ではなく、**差分比較**（ヘッダ/トークン/経路/権限）を目的に、改変・記録・再実行が回る状態を作れる。
- HTTPSを含めて「観測できない/復号できない」状況も“結論”として分類し、次の観測点（HAR/pcap/サーバログ）へ接続できる。

## 前提（対象・範囲・想定）
- 対象：自前検証環境、および許可された範囲のテスト対象のみ。
- 想定：HTTPSが基本。CDN/WAF/SSO/MFA/外部API等により、同じURLでも条件差で挙動が変わる。
- 依存：作業端末（Attack Box）の設計・証跡保存設計に従う（保存先/命名/巻き戻し）。
- やらないこと：
  - Proxyの機能紹介だけで終える（“何が見えるようになるか”と“差分の使い方”が主役）。
  - 無差別な改変（大量リプレイ/過剰負荷）を前提にする。
  - 証跡に含まれる秘密情報の扱いを決めずに共有/持ち出しする。

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### Web（HTTP/S）で観測したい差分
- リクエスト/レスポンス差分
  - ステータス（200/302/401/403/404）と“成立条件”
  - ヘッダ（Cookie/Authorization/Origin/Referer/User-Agent/Forwarded系）
  - ボディ（入力値、JSONフィールド、ファイル、GraphQL query等）
- セッション境界
  - ログイン前後、セッション更新、失効、再認証、step-up
- 権限境界
  - ロール/テナント/オブジェクト境界が「どの入力（ID/ヘッダ/トークン）」で決まるか
- 環境差
  - CDN/WAF/リージョン/キャッシュ/リダイレクトによる差分（同一操作でも別挙動になり得る）

### NW/TLSで観測したい差分（Proxyで“見える範囲”）
- TLSの暗号化境界（Proxyが観測できる範囲の把握）
  - CONNECTの有無、SNI/ALPN等の“メタ情報”、証明書チェーンの差分
- プロトコル差
  - HTTP/2（多重化で順序が崩れやすい）
  - HTTP/3（QUICでProxy経由にならず、観測点がズレやすい）

### 境界の観点（このファイルで固定する）
- 資産境界：
  - Proxyログ/HARに、Cookie/トークン/個人情報が混入し得る（保存/共有/保管期限/マスキング方針）
- 信頼境界：
  - ブラウザ→Proxy→対象 のどこを“観測点”にするか（ホスト直／VM内／VPN越し等）
- 権限境界：
  - どの権限状態（未ログイン/一般/管理者、テナントA/B）で観測したログかを固定する

## 結果の意味（その出力が示す状態：何が言える/言えない）
### Proxyログが示す“状態”
- 観測点（Proxy）を通過した通信について、
  - どの条件（ヘッダ/トークン/経路/入力）で挙動が変わったか
  - その差分が “アプリ側の判定” なのか “周辺（CDN/WAF/ブラウザ/キャッシュ）” なのか
  を説明できる。

### Proxyログだけでは“言えない”こと（扱い方）
- サーバ内部の実装・データフロー（ログ/デバッグがない限り推測で断定しない）
- クライアント内のローカル状態（Service Worker、ブラウザ拡張、端末固有ストレージ等）の全て
- HTTP/3やピンニング等で Proxy が実際には経路に入れていない通信
  - この場合は「観測点がProxyではない」という結論にして、HAR/pcap/別観測点へ切り替える。

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
> ここでは“攻撃手順”ではなく、ペネトレでの **意思決定** に落とす。

- 優先度付け（どこを先に深掘るか）
  - 「権限/セッション/設定」など、境界が揺れるポイントを差分で特定し、深掘り対象を絞る。
- 攻め筋（検証仮説）の立て方
  - 仮説例：
    - ヘッダ差（Origin/Authorization/Cookie）で判定が変わる＝境界が“通信で表現されている”
    - 経路差（直/Proxy/VPN）で挙動が変わる＝WAF/CDN/リージョン/キャッシュの影響が濃い
    - ログイン状態差で “同じAPI” の戻りが変わる＝認可 or スコープ伝播が焦点
- 次の仮説の作り方
  - Proxyで見えない（復号不可/経路外/HTTP/3）ことが分かった時点で、
    - HAR（ブラウザ視点）へ
    - pcap（NW到達性/QUIC/TLSメタ）へ
    - 自前環境ならサーバ/クラウド監査ログへ
    の“観測点の移動”を即決できるようにする。

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：Proxyが経路に入っておらず、観測点がズレている
- 次の検証（最小）：
  - 「Proxyを通った証拠」を作って確認する（例：Proxy側で一意ヘッダを付与し、レスポンス差分で追う／Proxyログに必ず残る対象で確認）
  - HTTP/3（QUIC）疑いがあるなら、観測点をProxy以外（HAR/pcap）に切り替える
- 期待する観測：
  - Proxyログに“確実に”残る通信と、残らない通信が分離できる（経路差が説明できる）

### 仮説B：Proxyには入っているが、差分の原因がキャッシュ/リダイレクト/環境差でブレている
- 次の検証（最小）：
  - 同条件で「直→Proxy」「別ネットワーク（VPN有無等）」を作り、差分を2セットだけ比較する
  - 302やキャッシュヘッダ、Set-Cookieの差分を“原因候補”としてメモに残す
- 期待する観測：
  - どの境界（ブラウザ/Proxy/CDN/WAF/アプリ）で差分が生じているかが説明できる

### 仮説C：HTTPS復号が困難で、改変どころか“中身が見えない”
- 次の検証（最小）：
  - 阻害要因を分類する（クライアント設定／ポリシー要因／プロトコル要因）
  - 無理に改変せず、観測点を変える（pcapで握手・到達性、HARでブラウザ視点、サーバログで受信側）
- 期待する観測：
  - 「見えない」ことが結論にならず、“なぜ見えないか”が次の一手に変換される

## 設計方針（必ず守る）
- Proxyは“便利ツール”ではなく「観測点（測定器）」として設計する。
- 改変は最小限にし、必ず「改変前/改変後の差分」が説明できる形にする。
- 証跡（Proxyログ）は散らさない。保存先と命名メタは `03_capture` の方針に従って固定する。
- 1回の検証で作る差分セットは最小（2〜3条件）に絞る。大量条件は比較不能になる。

## 設計の中核（Proxyを“どこに置くか”）
### 1) ブラウザ観測の基準配置（推奨）
- 基本形：
  - ブラウザ（ホスト or Attack Box） → 明示Proxy → 対象
- 目的：
  - 観測点（どの端末/どの経路）が常に説明できる
  - HAR（ブラウザ視点）と Proxyログ（計測点）の突合ができる

### 2) どのクライアントをProxy配下に入れるか（対象別）
- ブラウザ：最優先（Web検証の中心）
- CLI（curl等）：再現性のために必要時のみ（同条件を作る用途）
- ローカルアプリ/モバイル：必要時のみ（観測点が増えて難度が上がるため、後回しでもよい）

### 3) 上流/下流（Chain）設計（必要時のみ）
- 目的：社内Proxy/VPN/踏み台など“現実の経路差”を再現する
- 方針：まず単一Proxyで観測点を固定し、必要になってから連鎖させる（最初から複雑化しない）

## 証明書・HTTPS観測の設計（改変の可否を決める）
- Proxyが“中身”を見て改変できる条件：
  - クライアントがProxyのCAを信頼し、TLS終端がProxyで成立している（＝観測点がProxyにある）
- Proxyが“中身”を見られない状態も重要な結論：
  - ピンニング/企業管理端末ポリシー/HTTP/3/アプリ内TLS等
- 方針：
  - 「見える/見えない」を判定し、見えないなら観測点を移す（pcap/HAR/ログ）

## 改変ポイントの設計（“何を変えるか”を先に決める）
> 目的はバイパスではなく「境界の成立条件」を特定すること。

- セッション/認証：
  - Cookie属性、Authorizationヘッダ、トークン更新/失効の差分を作る
- 認可/権限伝播：
  - ID（path/query/body）、tenant/roleに相当する値、スコープ表現の差分を作る
- 設定/環境差：
  - Origin/Host/Forwarded系、キャッシュ制御、リダイレクトの差分を作る
- 入力/解析境界（必要時）：
  - Content-Type、エンコード、文字種など“解釈が変わる境界”の差分を作る

## 手を動かす検証（このファイルの完了条件）
- 「どの端末の、どのクライアントの、どの経路」がProxyを通るかを図なしで説明できる
- Proxyログが `captures/proxy/` に固定の命名メタ付きで保存できる
- 最小差分セット（例：未ログイン→ログイン後、直→Proxyなど）を2条件で取り、差分説明ができる
- HTTPS復号ができない場合も、阻害要因を分類し“観測点の移動”が選べる

## コマンド/設定例（例示は最小限）
~~~~
# 例：CLIから「Proxyを通った」ことを最小確認（手段の例）
# （観測点に入っているかを確かめる用途。大量実行はしない）
curl -x http://127.0.0.1:8080 https://example.com/ -I

# 例：Proxyログ保存先（設計の固定）
mkdir -p ~/pentest-work/captures/proxy
~~~~
- この例で観測していること：
  - 「経路がProxyを通っている」こと（観測点の成立）
  - 証跡保存場所が固定され、差分比較できること
- 出力のどこを見るか：
  - Proxy側のログに当該リクエストが残るか
  - `captures/proxy/` に同一ルールで保存できるか
- 前提が崩れるケース：
  - HTTP/3等で実際はProxyを通っていない
  - 証明書/ポリシー要因で復号できず、改変が成立しない
  - 保存先が分散して差分比較が不能

## 参考（必要最小限）
- `04_labs/01_local/01_attack-box_作業端末設計.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/01_local/01_attack-box_作業端末設計.md`
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 関連 topics：`01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`

---
