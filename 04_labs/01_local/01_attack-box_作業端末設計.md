<<<BEGIN>>>
# 01_attack-box_作業端末設計.md

## 目的（この技術で到達する状態）
- Web/NWペネトレの検証を「速く・安全に・比較可能に」回すための作業端末（Attack Box）を、自分で設計・運用できる。
- ツールの寄せ集めではなく、**観測（証跡）・差分比較・巻き戻し**を軸にした環境として維持できる。

## 前提（対象・範囲・想定）
- 対象：自前検証環境、および許可された範囲のテスト対象。
- 想定：Windowsホスト + 仮想化（VirtualBox/VMware）+ 1台以上のLinux系作業端末（VM/WSL/実機いずれか）。
- やらないこと：実環境での破壊的試験や、許可のない対象への探索。
- 依存：巻き戻し（スナップショット/バックアップ）を前提にする。

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 作業端末は「攻撃端末」ではなく、以下を観測し続ける“計測器”でもある。
  - Web：HTTP(S)のリクエスト/レスポンス、セッション、権限伝播、キャッシュ/リダイレクト、環境差
  - NW：到達性、サービス応答、認証要否、疎通経路（必要に応じてpcap）
- 境界の観点
  - 資産境界：作業端末内に保存する証跡・秘密情報（トークン/鍵）をどう守るか
  - 信頼境界：ホストOS⇄VM、ブラウザ⇄proxy、検証ネットワーク⇄外部インターネット
  - 権限境界：一般ユーザ運用と管理者権限の使い分け（最小権限）

## 設計方針（必ず守る）
- 目的は「技術理解を上げる」こと。ツール網羅より、観測と比較が回ることを優先する。
- “同じ条件で再実行できる”状態を作る（環境差で結論がブレない）。
- 証跡保存場所を固定し、差分比較ができるようにする（ログの散逸を防ぐ）。
- 秘密情報（APIキー、トークン、SSH鍵等）は最小限にし、保存・流出リスクを抑える。
- 更新は無闇に追わず、検証の再現性が壊れる更新はタイミングを管理する。

## 構成案（おすすめ：最小で強い）
> 目的別に「役割」を分け、混ぜない。

### 案A：Windowsホスト + Linux VM（推奨：検証の分離が明確）
- ホスト（Windows）：普段の作業、資料、メモ、Git管理、仮想化管理
- Attack Box（Linux VM）：プロキシ/計測、CLIツール、スクリプト実行、pcap取得（必要時）
- ブラウザは原則「Attack Box側」または「ホスト側ブラウザ→Proxy（Attack Box）」で固定し、観測点を明確にする

### 案B：Windows + WSL（軽量だが“観測点”が曖昧になりやすい）
- 手軽だが、ネットワーク境界や証跡設計が曖昧になりやすい
- VMで“分離”を学びたい場合は案Aを優先

## 役割設計（Attack Boxに持たせる責務）
- Proxy（計測/改変）の中核（後述ファイルで詳細化）
- 収集・解析ツールの実行基盤（ASM/OSINT、HTTP観測、必要に応じてpcap）
- 証跡保全のハブ（保存場所の統一、ログの整理）
- 自動化の実行基盤（小さなスクリプト、再実行のための環境固定）

## 保存場所の設計（最重要：技術が伸びる/伸びないを決める）
- 目的：後で「差分」を見られる状態にする（観測→判断の材料）
- 必須の保存カテゴリ（例）
  - `captures/har/`：ブラウザ視点のHAR
  - `captures/proxy/`：proxyログ
  - `captures/pcap/`：pcap（必要時）
  - `notes/`：検証メモ（視点、条件、結論、次の仮説）
- ポイント
  - どの証跡も「対象」「日時」「視点（どの端末/どの経路）」が分かる命名にする
  - ログは散らさない（後で比較できないと技術にならない）

## ネットワークの基本設計（ローカルで差分を作れる状態）
- 目的：視点差（外部/内部、直/プロキシ、分割DNS等）を作って理解を深める
- 最低限の作り分け
  - NAT：外部への一般疎通（最小構成）
  - Host-Only：検証専用セグメント（ターゲット隔離、観測の固定）
  - Bridge：必要時のみ（実ネットワークへの影響に注意）
- どの構成を使うかの判断は `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md` に切り出す

## 最小ツールセット（“何を見たいか”に直結するものだけ）
> ここは網羅しない。観測と解釈に直結する最小セットに限定する。

- ブラウザ（検証用プロファイルを分離）
- Proxy（計測/改変の中核）
- パケット観測（必要時のみ）
- テキスト処理/比較（diff、grep等）
- スクリプト実行環境（Python等、必要な範囲で）

※具体ツール名や詳細設定は `04_labs/01_local/02_proxy_計測・改変ポイント設計.md` と `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md` に寄せる。

## 巻き戻し（検証速度を上げる）
- VMを使う場合：スナップショットを“検証前”に切り、壊したら即戻す
- 設定ファイル：バックアップを定位置に置く（再構築の手戻りを減らす）
- 連動：`04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

## 手を動かす検証（このファイルの完了条件）
- Attack Boxの役割が決まっている（ホスト/VM/ブラウザ/proxyの配置が説明できる）
- 証跡保存場所が決まっている（har/proxy/pcap/notesの置き場が固定）
- 巻き戻し手段がある（スナップショットまたは設定バックアップ）
- “視点”を固定できる（どの経路で観測したかを毎回説明できる）

## コマンド/設定例（例示は最小限）
~~~~
# 例：証跡保存のディレクトリ（Attack Box側）
mkdir -p ~/pentest-work/captures/{har,proxy,pcap} ~/pentest-work/notes
~~~~
- この例で観測していること：証跡の置き場を固定し、比較できる状態を作る
- 出力のどこを見るか：ディレクトリ構造が固定されているか
- 前提が崩れるケース：保存場所が毎回変わる/権限不足で保存できない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：検証の土台（認証/認可/設定/ログ）を“観測可能にする”環境設計として関連
  - この内容が支えるポイント：検証の証跡と条件差を残せることで、ASVSで問うべき管理策の成立条件を説明可能にする
- WSTG：
  - 該当カテゴリ/テスト観点：Information Gatheringおよび各テスト（認証/認可/API/設定）の実行・観測の前提
  - 該当が薄い場合：WSTGのテスト観点を「実行して差分を観測」できる状態を作る、という前提として接続
- PTES：
  - 該当フェーズ：Intelligence Gathering / Vulnerability Analysis / Exploitation を回すための基盤
  - 前後フェーズとの繋がり（1行）：環境を固定し証跡を残すことで、分析→検証→結論の精度を上げる
- MITRE ATT&CK：
  - 該当戦術：Reconnaissance / Discovery（観測精度の土台）
  - 攻撃者の目的：環境把握と意思決定を支える“観測”を、検証側で再現し理解する

## 参考（必要最小限）
- 04_labs/01_local/02_proxy_計測・改変ポイント設計.md
- 04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md
- 04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 関連 labs：`04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

---


<<<END>>>