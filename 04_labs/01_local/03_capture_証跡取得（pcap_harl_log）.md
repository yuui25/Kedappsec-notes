<<<BEGIN>>>
# 03_capture_証跡取得（pcap/har/log）.md

## 目的（この技術で到達する状態）
- Web/NW検証の結論を「感覚」ではなく、証跡（HAR/Proxyログ/pcap/各種ログ）に基づいて説明できる。
- 取得する証跡を“全部取る”ではなく、**判断に直結する最小セット**として設計し、比較（差分）に強い運用を作れる。
- 「どの視点（端末/経路/条件）で観測したか」を固定し、再検証しても結論がブレない。

## 前提（対象・範囲・想定）
- 対象：許可された範囲のみ（自前環境・契約スコープ等）。
- 想定：HTTPSが基本。CDN/WAF/SSO/MFA/外部API/クラウド構成により、条件差で挙動が変わる。
- やらないこと：証跡を無差別に大量保存して、後で追えなくなる運用（技術が伸びない）。
- 依存：Proxy経由での観測が基本（詳細は `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`）。

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- Web（HTTP/S）で見たいもの
  - リクエスト/レスポンスの差分（ヘッダ、Cookie、ボディ、ステータス）
  - セッション境界（ログイン前後、更新、失効、再認証）
  - 権限境界（ロール/テナント/オブジェクト境界がどこで決まるか）
  - キャッシュ/リダイレクト/環境差（CDN/WAF、リージョン差、ヘッダ差）
- NWで見たいもの（必要に応じて）
  - 到達性（疎通/握手/遮断）、サービス応答（バナー/エラー/認証要否）
  - 暗号化境界（TLSハンドシェイク、SNI、ALPN等の“見える範囲”）
- 境界の観点
  - 資産境界：証跡には秘密情報が含まれる可能性（保存/共有/保管期限）
  - 信頼境界：どの経路で観測したか（直/Proxy、社内/社外、VPN有無）
  - 権限境界：どの権限状態で観測したか（未ログイン/一般/管理者、テナントA/B）

## 証跡の最小セット（基本方針）
> 迷ったら「比較できる最小セット」に戻す。

### 最小セット（推奨）
- HAR（ブラウザ視点）
- Proxyログ（計測/改変の中心）
- 検証メモ（視点/条件/結論/次の仮説）

### 追加セット（必要時のみ）
- pcap（NW観測が必要な時、またはHTTPS復号が困難な時の補助）
- サーバ/アプリログ（自前環境で可能な場合のみ）
- クラウド監査ログ（AWS/Azure等を自前で構成した場合）

## 保存場所と命名（差分比較のための設計）
- 目的：後で「同条件/別条件」を並べて比較できる状態にする
- 推奨の保存ルート（例）：`~/pentest-work/`
  - `captures/har/`
  - `captures/proxy/`
  - `captures/pcap/`
  - `notes/`
- 命名に必ず含めるメタ情報（最低限）
  - 対象（host or アプリ名）
  - 日時（YYYYMMDD-HHMM）
  - 視点（端末/経路：host, vm, proxy, direct 等）
  - 条件（未ログイン/一般/管理者、テナントA/B、ヘッダ差など）
- 例（概念）
  - `har_app1_20251213-1030_vm_tenantA_user.har`
  - `proxy_app1_20251213-1030_vm_tenantA_user.log`
  - `note_app1_20251213-1030_vm_tenantA_user.md`

## 取得手順（目的別：何を取るかが主）
> 手順は最小限。重要なのは「どの条件差で取るか」。

### 1) Web（認証/認可/API/入力/設定）を伸ばす取得
- 取るもの：HAR + Proxyログ + メモ
- まず作る差分セット（最小）
  - 未ログイン → ログイン後
  - 低権限 → 高権限（可能な範囲）
  - テナントA → テナントB（可能な範囲）
- 観測する差分
  - Cookie/トークンの変化（発行/更新/失効）
  - Authorization系ヘッダ/スコープ/IDの伝播
  - エラーの変化（401/403/404/200など）と成立条件

### 2) NW（到達性/サービス応答）を伸ばす取得
- 取るもの：必要に応じてpcap + メモ（スキャン結果や応答ログは別途保存）
- 観測する差分
  - 経路差（NAT/Host-Only/Bridge、VPN有無）
  - 認証要否（匿名で見える/見えない）
  - 握手・遮断・再送（“届いていない”の原因切り分け）

### 3) HTTPS復号が難しい場合の扱い（最小の切り分け）
- 取るもの：pcap（補助） + Proxyログ（見える範囲） + メモ
- 目的：復号ができないこと自体を“結論”にせず、阻害要因を分類する
  - クライアント側（証明書未導入、プロキシ未設定）
  - ポリシー側（HSTS、ピンニング等）
  - プロトコル側（HTTP/3等で経路が変わる）
- 方針：無理に改変しない。観測点を変えて理解を進める。

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：証跡が散逸して比較できないため、結論がブレている
  - 次の検証：
    - 保存ルートと命名メタ（対象/日時/視点/条件）を固定する
    - 最小差分セット（未ログイン→ログイン後 等）で取り直す
  - 期待する観測：
    - 同条件/別条件で差分が明確になり、境界（権限/信頼）が説明できる
- 仮説B：Proxyログはあるが、ブラウザ視点の差分（HAR）がなく判断に迷う
  - 次の検証：
    - HARを同条件で取得し、Proxyログと突き合わせる
  - 期待する観測：
    - “ブラウザが実際に見たもの”と“Proxyが観測したもの”が一致/差分の理由が説明できる
- 仮説C：NW側の原因で挙動が変わっているが、Web証跡だけ見て誤判定している
  - 次の検証：
    - 経路/到達性の差分をpcapや応答で確認し、原因がWebかNWか切り分ける
  - 期待する観測：
    - どの境界（NW/アプリ/認証基盤）で変化しているかが説明できる

## 手を動かす検証（このファイルの完了条件）
- `captures/har`, `captures/proxy`, `captures/pcap`, `notes` が固定の場所に作られている
- 最小差分セット（未ログイン→ログイン後 等）でHAR/Proxyログ/メモが一式残っている
- “どの視点で観測したか”（端末/経路/条件）がメモで説明できる

## コマンド/設定例（例示は最小限）
~~~~
# 例：証跡保存のディレクトリ（Attack Box側）
mkdir -p ~/pentest-work/captures/{har,proxy,pcap} ~/pentest-work/notes

# 例：pcap保存先（必要時のみ）
mkdir -p ~/pentest-work/captures/pcap
~~~~
- この例で観測していること：証跡の置き場を固定し、比較可能にする
- 出力のどこを見るか：保存場所が毎回同じか、命名メタが運用できるか
- 前提が崩れるケース：権限不足、保存先が分散、秘密情報の扱いが未定

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - 該当領域/章：認証/セッション、認可、API、設定、ログ（の検証を支える観測基盤）
  - この内容が支えるポイント：成立条件を証跡で説明できるため、管理策の不足/破綻点を明確化しやすい
- WSTG：
  - 該当カテゴリ/テスト観点：INFO（観測前提）、認証/セッション、認可、API、設定の各観点の実行・観測
  - 該当が薄い場合：WSTG観点を“実通信の差分”として確認する前提として接続
- PTES：
  - 該当フェーズ：Vulnerability Analysis / Exploitation の検証と、成立条件の切り分けを支える
  - 前後フェーズとの繋がり（1行）：証跡が残ることで、分析→検証→結論が一貫し、技術の再利用ができる
- MITRE ATT&CK：
  - 該当戦術：Reconnaissance / Discovery（観測と理解の土台）
  - 攻撃者の目的：境界や権限伝播の把握を、検証側で観測し理解する

## 参考（必要最小限）
- `04_labs/01_local/01_attack-box_作業端末設計.md`
- `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- 関連 labs：`04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`
- 関連 topics：`01_topics/02_web/01_web_recon_入口・境界・攻め筋の確定.md`

---


<<<END>>>
