<<<BEGIN>>>
# 03_networking_nat_hostonly_bridge.md

## 目的（この技術で到達する状態）
- VirtualBox（または同等の仮想化）における **NAT / Host-Only / Bridge** を、用語としてではなく「到達性・観測・境界」の観点で使い分けられる。
- 検証で最も重要な「視点（どの端末・どの経路で観測したか）」を固定し、同条件比較（差分）を作れる。
- Web/NW=5:5の両方に効く、検証ネットワークの“最小で強い”標準構成を自分で設計できる。

## 前提（対象・範囲・想定）
- 対象：自前検証環境（Attack Box VM / Target VM）を主とする。
- 想定：ホストOS（普段環境）と検証環境（VM群）を分離し、証跡・秘密情報・誤操作のリスクを抑える。
- やらないこと：Bridgeの常用（実ネットワークへ影響しやすく、制御が難しいため）。
- 関連：
  - `04_labs/02_virtualization/01_virtualbox_基盤.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
  - `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- ここで見ているのは「ネットワーク機能」ではなく、検証の前提を決める要素
  - 到達性：誰が誰に届くか（VM→Internet、ホスト→VM、VM↔VM）
  - 観測点：どの経路にプロキシ/pcapを置けるか（見える/見えないが決まる）
  - 境界：検証環境が普段環境や実ネットワークに“漏れない”か
- 境界の観点
  - 資産境界：証跡（HAR/Proxyログ/pcap）や秘密情報がどこに残るか
  - 信頼境界：ホスト⇄検証環境⇄実ネットワークの線引き
  - 権限境界：検証対象（Target VM）が外部へ出られる必要があるか（原則は不要）

## 3つのモードを「意味」で理解する

### NAT（基本：外へ出るが、外から来にくい）
- 何を意味するか
  - VMは **外（インターネット）へ出られる**（更新、外部参照など）
  - ただし外部（同一LAN含む）からVMへは **基本的に入れない**（ポートフォワード等をしない限り）
- 攻撃者視点の意味（検証者としての意思決定）
  - “攻める対象”をNAT配下に置くのは通常不要（到達性が限定され、観測が複雑化しやすい）
  - **Attack Boxの外部参照・更新**のために使うのが合理的
- 使いどころ（推奨）
  - Attack Box：NATあり（外部参照/更新用）
  - Target VM：原則NATなし（検証専用セグメントに閉じる）

### Host-Only（検証専用セグメント：閉じた実験場）
- 何を意味するか
  - VM同士（+ホスト）で **閉じたネットワーク**を作れる
  - 外（インターネット）には基本的に出ない（構成次第だが、意図しない外部通信が減る）
- 攻撃者視点の意味
  - 到達性・境界を“自分で設計できる”ため、NW検証の精度が上がる
  - WebもNWも、**条件差（経路差）**を作って理解を深めやすい
- 使いどころ（推奨）
  - Attack Box：Host-Onlyあり（Targetセグメントへの入口）
  - Target VM：Host-Onlyのみ（検証環境として隔離）

### Bridge（実ネットワークに“直結”：強いが制御難）
- 何を意味するか
  - VMが実ネットワーク（社内LANや家庭LAN）に **“1台の端末”として参加**する
  - DHCP/ARP/ブロードキャスト等、現実のネットワーク挙動の影響を受ける
- 攻撃者視点の意味
  - “現実に近い”到達性が得られる一方で、検証対象が実ネットワークへ影響するリスクが上がる
- 使いどころ（原則：必要時のみ）
  - どうしても実ネットワーク上の機器/サービスとの疎通が必要
  - ただし、目的・範囲・影響を明確化してから使う（常用しない）

## 標準構成（最小で強い：推奨）
> Web/NW両方の技術を上げやすい構成。視点が固定でき、証跡も管理しやすい。

- Attack Box（Linux VM）
  - Adapter 1：NAT（外部参照/更新）
  - Adapter 2：Host-Only（検証セグメント入口）
- Target VM（Web/API/AD等）
  - Adapter 1：Host-Only（検証セグメントのみ）

この構成で確定できること
- どの検証も「Attack Box → Host-Only → Target」で視点が固定される
- ProxyやpcapをAttack Box側に集約しやすい
- Targetが外部へ出ないため、意図しない通信や影響を抑えられる

## どれを選ぶか（判断基準：技術を上げるための意思決定）
- 目的が「更新・外部参照」なら NAT（Attack Boxのみ）
- 目的が「検証の正確性・比較・隔離」なら Host-Only（Targetは基本これ）
- 目的が「実ネットワーク上の疎通が必須」なら Bridge（必要時のみ）
- “迷ったらHost-Onlyを優先し、必要になったらNAT/Bridgeを足す”

## 観測（証跡）との接続：ネットワーク設計が決めること
- Proxy観測
  - 観測点をAttack Boxに置くと、経路が固定され、差分比較がしやすい
- pcap観測
  - Host-Onlyは“検証セグメント全体”を観測しやすい（VM間通信の把握に向く）
  - Bridgeは実ネットワークの雑音が増え、観測が難しくなることがある
- 連動：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：到達性が想定と違い、検証結果がブレている（経路が固定できていない）
  - 次の検証：
    - “どのNIC（NAT/Host-Only/Bridge）を通っているか”を固定し、視点をメモに残す
    - TargetはHost-Onlyのみにして、経路を単純化する
  - 期待する観測：
    - 同条件で結果が再現し、差分（条件変更）の意味が説明できる
- 仮説B：Targetの外部通信が混ざっており、観測が汚れている（隔離が弱い）
  - 次の検証：
    - TargetからNAT/Bridgeを外し、Host-Onlyのみに閉じる
    - 必要な外部参照はAttack Box（NAT）側で行う
  - 期待する観測：
    - 検証セグメントが静かになり、pcap/ログの解釈が容易になる
- 仮説C：どうしても実ネットワーク疎通が必要で、Host-Onlyだけでは成立しない
  - 次の検証：
    - Bridgeを“一時的に”有効化し、目的の疎通が取れる最小範囲を確認
    - 目的達成後はBridgeを外して隔離に戻す
  - 期待する観測：
    - 実ネットワーク要件を満たしつつ、検証環境の影響範囲を制御できる

## 手を動かす検証（Labs連動：完了条件）
- Attack Boxが NAT で外部疎通できる（更新・外部参照が可能）
- Attack BoxとTargetが Host-Only で疎通できる（検証セグメントが成立）
- Targetが外部へ出ていない（意図しない外部通信が混ざらない）
- “視点（端末/経路）”をメモで説明できる（例：Host-Only経由、NATは更新のみ）

## コマンド/設定例（例示は最小限）
~~~~
# 例：証跡メモに残すべき視点（テンプレ）
# - 視点：AttackBox(VM) → Host-Only → TargetVM
# - 外部参照：AttackBox(VM) → NAT → Internet（更新/参照のみ）
# - TargetVM：Host-Onlyのみ（外部通信なし）
~~~~
- この例で観測していること：視点と経路が固定されているか
- 出力のどこを見るか：検証ごとに同じ経路で観測しているか
- 前提が崩れるケース：Bridge常用で経路がブレる、Targetが外へ出てログが汚れる

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - 検証土台として、認証/認可/API/設定/ログの成立条件を“同条件で観測”するための前提（環境差で結論を誤らない）。
- WSTG：
  - テスト観点を実行する前の“観測の固定”として重要。特にINFO/認証/認可/APIで、経路差が結果に影響しやすい。
- PTES：
  - Intelligence Gathering / Vulnerability Analysis / Exploitation を反復可能にする実験基盤（視点固定と到達性設計）。
- MITRE ATT&CK：
  - Reconnaissance / Discovery の理解を、到達性・視点差として体験し、検証側の意思決定に落とし込む。

## 参考（必要最小限）
- `04_labs/02_virtualization/01_virtualbox_基盤.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

## リポジトリ内リンク（最大3つまで）
- 関連 labs：`04_labs/02_virtualization/01_virtualbox_基盤.md`
- 関連 labs：`04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- 関連 labs：`04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

---


<<<END>>>
