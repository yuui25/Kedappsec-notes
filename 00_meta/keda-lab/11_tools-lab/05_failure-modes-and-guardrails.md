<<<BEGIN>>>
# 11_tools-lab / BASICS11-05 失敗パターン集＋ガードレール（過収集・ログ欠落・時刻ズレ・ROE逸脱を潰す）

## 1. このファイルが補う本編STEP（01〜05への地続き）
- STEP1（Recon）：過剰なアクティブ調査、証拠の時刻不整合、入口の根拠欠落を防ぐ
- STEP2（Auth/SSO/MFA）：MFA/CA の誤読、ログ欠落、本人操作の混入（社員化の前提崩壊）を防ぐ
- STEP3（AD/横展開）：列挙過多・過権限行為・ログ相関不能で“主張が崩れる”事故を防ぐ
- STEP4（Cloud）：監査ログの取り逃し、API過収集、権限根拠不足（Role/Consent）を防ぐ
- STEP5（Evidence/Report）：Evidence Index / Timeline の破綻、L1/L2/L3 混在、提出物の監査性欠落を防ぐ

本ファイルは、STEP5-07（品質ゲート）、STEP5-11（欠落フォールバック）、STEP5-14（早期通知）と直結する。

---

## 2. 失敗パターン（Failure Modes）分類（固定：まずここに当てはめる）

### FM-01 時刻ズレ（Time Drift / TZ混在）
- 症状：
  - Timeline がつながらない（Hop間の因果が説明できない）
  - Blue 側ログと一致しない
- 典型原因：
  - 端末NTP未同期、クラウド/オンプレ/EDRでTZ混在
  - ログ抽出時刻が“取り込み時刻”と“発生時刻”で混同
- 影響（STEP5）：
  - DFIR章が書けない／主張強度が下がる／報告会で揉める

### FM-02 過収集（Over-Collection）
- 症状：
  - 取るべきでない本文/PII/秘密情報が raw に大量混入
  - sanitized が作れない、レビューが終わらない
- 典型原因：
  - “とりあえず全部”の列挙、APIの無制限取得、ログの全量ダンプ
- 影響：
  - ROE違反リスク、提出不能、Evidence Pack が肥大化して監査性が落ちる

### FM-03 取り逃し（Evidence Missing / Log Gap）
- 症状：
  - 必須 Evidence（STEP5-12のM）が欠け、最終的に章が書けない
- 典型原因：
  - ログ保持が短い、権限不足、抽出手順未確立、Day1/Day2を飛ばした
- 影響：
  - Executive が L1止まり、Finding が Observation 扱い、再テストが曖昧

### FM-04 誤検知・誤読（False Positive / Misinterpretation）
- 症状：
  - “できたつもり”だが根拠が薄い、L2/L3 を誤って主張
- 典型原因：
  - ツール出力の意味を確認せず解釈、ログの項目誤読、キャッシュ/リトライの見落とし
- 影響：
  - 報告の信頼性低下、顧客との対立、再現不能

### FM-05 ROE逸脱（Scope/ROE Violation）
- 症状：
  - 禁止行為（破壊的操作、実データ取得、アカウントロック誘発等）が発生
- 典型原因：
  - “実行しない範囲”未定義、ツールのデフォルト動作（列挙/ダウンロード）が強い
- 影響：
  - 契約問題、業務影響、プロジェクト停止

### FM-06 検知・業務影響（Detection Trigger / Service Impact）
- 症状：
  - アラート多発、アカウント凍結、WAF/CA により試験が継続不能
- 典型原因：
  - レート制御不足、ログイン失敗の連続、スキャン強度過大
- 影響：
  - 実施計画崩壊、顧客運用への負荷、結果の偏り

### FM-07 秘密情報混入（Secrets/Token Leakage）
- 症状：
  - Bearer/Cookie/鍵が sanitized に露出、共有/提出物に混入
- 典型原因：
  - マスキング漏れ、スクショ無加工、実行ログに生値貼り付け
- 影響：
  - 重大インシデント化（“テストが原因で漏洩”になり得る）

---

## 3. ガードレール（Guardrails）共通原則（固定）

### GR-01 先に「何を証明するか」を決める（purpose → claim_target）
- Run Log（BASICS11-02）の `purpose` と `claim_target` を埋めない実行は禁止
- 目的が曖昧なら、実行しても Evidence が弱い（= Report が書けない）

### GR-02 最小出力（sampling）を標準化する
- 期間：原則 24h または該当時刻±1h（LM-LOGは±15分）
- 件数：上位20など上限を持つ
- 取得：本文/添付は原則取らない（メタ情報で L2 を狙う）

### GR-03 raw/sanitized 分離を前提に動く（提出物は sanitized）
- raw は隔離、閲覧権限を限定
- Report に貼るのは sanitized の Fact のみ（STEP5-11準拠）

### GR-04 失敗は“早期通知”する（REW起票）
- Must Evidence が `U/No`、時刻ズレ、過収集兆候が出たら
  STEP5-14 の Risk Early Warning（REW-###）を即起票する
- “あとで何とかする”は原則禁止

---

## 4. 失敗パターン別：早期兆候（Early Signals）と対策（Mitigation）

### 4-1 FM-01 時刻ズレ
- 早期兆候：
  - 同一イベントがログで±数分以上ズレて見える（継続）
  - クラウド監査ログと端末実行が一致しない（相関IDも無い）
- 対策：
  - 基準時計（Primary Clock）を確定（BASICS11-04）
  - TZ変換規則を案件メモとして Evidence 化（ROEと同格）
  - 相関キー（request_id/eventRecordId/session_id）を必ず収集（存在する場合）
- REW起票条件：
  - `time_confidence=low` が連続3件以上、または DFIR章の根拠が崩れると判断した時点

### 4-2 FM-02 過収集
- 早期兆候：
  - raw が短時間で肥大（例：1実行で数百MB）
  - PII/本文/添付が含まれるログが出始めた
- 対策：
  - 取得範囲（期間/件数/フィールド）を即縮小
  - APIはメタ情報のみ、本文系エンドポイントは呼ばない
  - sanitized を“先に”作って、必要十分を確認してから追加収集
- REW起票条件：
  - secrets_flag/PII_flag が yes の Evidence が増加、または sanitized 作成が追いつかない

### 4-3 FM-03 取り逃し（Evidence Missing）
- 早期兆候：
  - STEP5-12 の Must が `U` のまま Day2 を迎えそう
  - 抽出手順が確立していない（誰が/どこから/どう取るか不明）
- 対策：
  - STEP5-13 Day1/Day2 を強制実施（ログ抽出の試験が最優先）
  - フォールバック（STEP5-11）を割当し、主張強度（L1止まり）を事前に合意
- REW起票条件：
  - Must Evidence が 24h 以内に不可逆（保持期限）になる見込みが立った時点

### 4-4 FM-04 誤検知・誤読
- 早期兆候：
  - 同じ手順で再現しない
  - “成功”の根拠がツールの出力だけで、ログ/監査/HTTPの根拠が無い
- 対策：
  - L2/L3 を主張する前に “二重根拠” を要求（例：実行結果＋監査ログ）
  - 1行要約（summary_1line）を Evidence と整合させる（STEP5-09）
- REW起票条件：
  - Finding が Fact を2本揃えられないまま重大度を付けそうになった時点

### 4-5 FM-05 ROE逸脱
- 早期兆候：
  - ツールが “全取得/全列挙/自動ダウンロード” をし始める
  - ログイン失敗が連続、アカウントロックの兆候
- 対策：
  - 実行前に `roe_constraints` を Run Log に明記（BASICS11-02）
  - レート制御、試験用アカウント、例外の事前合意（必要なら Change Control）
- REW/CC起票条件：
  - ROEに抵触し得る行為が必要になった時点で CC（変更管理）を先に起票する

### 4-6 FM-06 検知・業務影響
- 早期兆候：
  - WAF/EDR/CA による遮断、アラート多発、ユーザーから問い合わせ
- 対策：
  - 実行強度を下げる（並列度/レート/試行回数）
  - 対象時間帯の調整、Blue 観測と連携してノイズを抑える
- REW起票条件：
  - 業務影響（問い合わせ/遮断/凍結）が発生、または発生しそうな兆候が出た時点

### 4-7 FM-07 秘密情報混入
- 早期兆候：
  - sanitized にトークン断片、Cookie、ユーザー識別子が残る
- 対策：
  - マスキング置換ルールを強制（BASICS11-02）
  - スクショは加工してから sanitized に格納
  - “生値貼り付け禁止”を運用ルールにする
- REW起票条件：
  - sanitized で secrets_flag=yes が1件でも出た時点（即是正）

---

## 5. 実行前ゲート（Preflight Gate：やらないと事故る）

### 5-1 必須チェック（全案件共通）
- [ ] 対象シナリオ（A〜E）が決まっている（STEP5-02）
- [ ] Must Evidence（STEP5-12 のM）を抽出し、取得可否（Y/N/U）が埋まっている
- [ ] 基準時計（Primary Clock）が決まっている（BASICS11-04）
- [ ] データ最小化（ROE）が Evidence 化されている（STEP5-13）
- [ ] Run Log（BASICS11-02）の最小版が用意されている
- [ ] 保存先（raw/sanitized）と採番レンジ（E-###）が決まっている（STEP5-09/13）

### 5-2 “実行停止（Stop）”条件（固定）
- Must Evidence の取得可否が `U` のまま（特に CLOUD-AUDIT / AUTH-LOG / CA-POL）
- ROE が未確定（本文取得/破壊的行為の線引きが無い）
- 時刻同期が取れていない（NTP未確認）
- 検知/業務影響が出たのに連携窓口が不明

---

## 6. 実行中ガードレール（Run-time Guardrails）

### 6-1 レート制御（推奨：事故防止の基本）
- 並列度は最小から開始（増やすのは合意が取れてから）
- 認証試行は連続失敗させない（ロック回避）
- API呼び出しは上限（件数/期間/ページ数）を必ず設定

### 6-2 “Evidenceが先、追加収集は後”
- 1回の実行ごとに sanitized を作れるか確認してから次に進む
- sanitized が作れない実行は“過収集”の兆候として扱う

### 6-3 変更が必要なら先に CC（変更管理）
- ROE解除、スコープ追加、期間延長、ログ保持延長が必要になったら
  STEP5-14 の CC-### を先に起票し、合意後に実行する

---

## 7. 日次レビューゲート（Daily Quality Gate：STEP5-07と接続）

### 7-1 日次の最小チェック
- [ ] 今日の Run Log がすべて埋まっている（purpose/claim_target/時刻）
- [ ] Evidence Index に登録済み（TBDが残っていない）
- [ ] Timeline にイベントが入っている（Hopが飛んでいない）
- [ ] secrets_flag/PII_flag が適切に付いている
- [ ] sanitized が Report に貼れる Fact 形式になっている
- [ ] Must Evidence の充足率が上がっている（STEP5-12）

### 7-2 “日次で止める”判断基準
- Must Evidence が増えない／欠落が解消しない
- 時刻ズレが継続
- sanitized が追いつかない（レビュー不能）
- 検知/業務影響が拡大

→ いずれも REW を起票し、顧客アクションまたは CC を要求する（STEP5-14）。

---

## 8. テンプレ：REW（早期通知）起票の最小文（コピペ用）
~~~~
REW-###:
- what: (欠落/時刻ズレ/過収集/ROE逸脱リスク)
- why: (権限/保持/ツール挙動/合意不足)
- impact: (ES/KC/FD/DF のどこが弱体化するか、L1止まり等)
- ask: (顧客側アクション：権限/抽出/保持延長/合意)
- deadline: (不可逆点：保持期限/提出x日前)
- fallback: (STEP5-11 の代替根拠案)
~~~~

---

## 9. 次のファイル（BASICS11-06）への接続
次は、Hop別に「最低限これだけ実行すれば Evidence が揃う」という“最小コマンド/最小アクション”を固定する。
（ツールの詳細手順は将来 `11_tools-lab/lab-notes/` に分離して置く。）

- 次：keda-lab/11_tools-lab/06_minimal-commands-by-hop.md
  - Hop1〜Hop7 の “最小実行セット”
  - それぞれが生む Evidence 種類（STEP5-12のM）との対応
  - 失敗時のフォールバック（STEP5-11）へのリンク

<<<END>>>
