<<<BEGIN>>>
# 03 STEP3-04 資格情報窃取と LSASS / DPAPI / ブラウザ

## 1. ゴールと前STEPからの接続

### 1-1. このSTEPのゴール

この STEP3-04 のゴールは、以下を一本の線で理解することです。

- Windows / AD 環境で「どこに」「どの種類の認証情報」が保存されているか
- それらを攻撃者がどのように窃取し、  
  - Kerberos 攻撃（STEP3-03）  
  - Lateral Movement（STEP3-05）  
  に接続していくか
- DPAPI やブラウザ保存情報を含め、  
  **「資格情報ストア → 攻撃チェーン」** の対応関係を整理する

最終的には、以下がイメージできる状態を目指します。

> 社員 A として侵入した後、  
> どの端末で、どのストアから、どの種類の認証情報を抜き、  
> それを使って「どのホスト」「どのサービス」「どのアカウント」に横展開するか。

### 1-2. 前STEP までの前提

- STEP3-02：AD / LDAP 列挙で
  - 特権ユーザー / グループ
  - サービスアカウント / SPN
  - DC / サーバ群
  を把握し、「攻撃用組織図」を作った

- STEP3-03：Kerberos 攻撃パターンとして
  - Roasting（AS-REP / TGS）
  - Delegation 悪用
  - チケット窃取 / 再利用
  - Golden / Silver Ticket
  を「どこに・どう刺すか」というレベルで整理した

本 STEP3-04 は、これらを実現するための **「燃料（資格情報）」の調達フェーズ** です。

---

## 2. 資格情報窃取の全体マップ

まず、攻撃者視点で「どこに何があるか」を俯瞰します。

### 2-1. 主な資格情報ストア

1. **LSASS（Local Security Authority Subsystem Service）メモリ**
   - Kerberos チケット（TGT / TGS）
   - NTLM ハッシュ
   - ログオンセッション情報
   - 一部の平文パスワード（条件次第）

2. **SAM / SECURITY / SYSTEM レジストリハイブ**
   - ローカルアカウントのハッシュ
   - 一部 LSA シークレット

3. **LSA Secrets / Credential Manager / DPAPI**
   - サービスアカウントのパスワード
   - 保存された資格情報（RDP / SMB / Proxy 等）
   - DPAPI マスタキーと保護された秘密

4. **ブラウザ保存情報**
   - Web サイトの ID / PW（イントラ / SSO / クラウド）
   - Cookie / セッショントークン / リフレッシュトークン
   - クライアント証明書（場合によって）

5. **各種設定ファイル / スクリプト / ジョブ**
   - `web.config`, `appsettings.json`, バッチファイル等の平文PW
   - スケジュールタスクの資格情報

6. **RDP / VPN クライアント設定**
   - `.rdp` ファイル
   - VPN クライアントプロファイル
   - 保存された認証情報

### 2-2. チェーン上での役割

- **入口端末（社員 A の PC / VDI）**
  - まずは「A 本人 + そこに保存されている他ユーザー / サービスの資格情報」を狙う
- **管理者端末 / ジャンプサーバ**
  - 横展開後に踏んだホストで、管理者の資格情報を抜く
- **サーバ / DC**
  - サービスアカウント / KRBTGT / 高権限ユーザーの情報を狙う

---

## 3. LSASS メモリと Kerberos チケット

### 3-1. LSASS の役割

- Windows の認証まわりを担うプロセス
- ユーザーがログオンすると、LSASS 内に
  - 認証トークン
  - Kerberos チケット
  - NTLM ハッシュ
  などが保持される

攻撃者視点では、

> 「LSASS に触れれば、多くのログオン情報に触れられる」

という非常に価値の高いターゲット。

### 3-2. 前提条件（攻撃者側）

- 多くの場合、**ローカル管理者権限** が必要
  - 権限昇格（Windows Exploit や設定ミス）が前段になる

### 3-3. 何が取れるか

- Kerberos チケット
  - Pass-the-Ticket / チケット再利用
- NTLM ハッシュ
  - Pass-the-Hash 攻撃
- 平文パスワード（条件次第）
  - すでにログオンしているユーザーのパスワード

これらが取れると：

- STEP3-03 で整理した
  - チケット窃取 / 再利用
  - Golden / Silver Ticket 準備（特権ユーザーの情報）
  に直接つながる。

### 3-4. チェーン例（入口端末 → 管理端末）

1. 社員 A の端末でローカル権限昇格に成功
2. LSASS から A 本人 + 他ユーザー（たまたまログオンしていた）の情報を取得
3. そこから別ホストへ Lateral Movement（STEP3-05）実施
4. 管理者端末 / ジャンプサーバで同じく LSASS 調査
5. Domain Admins などのチケット / ハッシュを入手

---

## 4. SAM / SECURITY / SYSTEM ハイブとローカルアカウント

### 4-1. SAM / SECURITY / SYSTEM の役割

- SAM（Security Account Manager）
  - ローカルユーザーアカウントの情報（NTLMハッシュ等）を保持
- SECURITY / SYSTEM
  - ハッシュ暗号化用キー / LSA シークレット などを保持

攻撃者はこれらをオフラインで解析し、

- ローカル Administrator 等のハッシュを取得
- 他ホストのローカル Administrator とハッシュが共通なら、
  - Pass-the-Hash で他ホストに横展開可能

### 4-2. チェーン上の位置づけ

- ドメイン参加クライアント間の横展開でよく効く
  - 特に「ローカル Administrator パスワードが全端末で共通」の環境

- これを起点に：
  - 別のホストで LSASS にアクセス
  - そこでドメインアカウントの情報を抜く  
  → ドメインレベルへ段階的に上っていく

---

## 5. Credential Manager / LSA Secrets / DPAPI

### 5-1. Windows 資格情報マネージャ

- ユーザーが保存した
  - SMB / RDP / Proxy 等の資格情報
- 例）「この資格情報を保存する（今後は聞かない）」のチェック

攻撃者視点：

- 入口端末に保存された
  - 管理者用アカウント
  - サービスアカウント
  などを引き出せる可能性

### 5-2. LSA Secrets

- Windows が内部的に保持する「秘密」
  - サービスアカウントのパスワード
  - 一部システム用資格情報 など

### 5-3. DPAPI の役割

DPAPI（Data Protection API）は、

> 「ユーザー / マシンごとの秘密（キー）を使って  
>  各種資格情報や秘密情報を暗号化・復号する仕組み」

主なポイント：

- 多くのアプリケーションが DPAPI 上で秘密を保護
  - ブラウザパスワード
  - VPN / RDP クライアントの保存情報
  - その他アプリケーションの秘密

### 5-4. 攻撃チェーンのイメージ

1. 入口端末 / 横展開ホストで、
   - ユーザー / マシンの DPAPI キー（マスタキー）にアクセス
2. そのキーを使って、
   - ブラウザ保存パスワード
   - 資格情報マネージャ保存情報
   - 各種アプリの秘密情報
   を復号

3. 得られた認証情報を用いて、
   - SMB / RDP / VPN / Web / DB などへ横展開

---

## 6. ブラウザ保存情報（特に SSO / クラウド）

### 6-1. ブラウザが抱える情報の種類

1. フォームの ID / PW
   - イントラポータル / SSOポータル / Webアプリ 等

2. Cookie / セッショントークン
   - SSO セッション（SAML / OIDC）  
   - クラウドサービス（M365 / Salesforce 等）

3. ローカルストレージ / セッションストレージ
   - SPA / モダン JS アプリのセッショントークン

4. クライアント証明書（場合によって）

### 6-2. WebPT / Recon との接続が濃いポイント

- STEP2 で分析したような
  - VPN / VDI / SSO / OWA へのログイン情報
- STEP1 の Recon で把握している
  - 社内ポータル / クラウドサービスの URL 群

→ これらがブラウザ保存情報とリンクしているケースは多い。

### 6-3. 攻撃チェーンのイメージ

1. 社員 A 端末でローカル権限を取る
2. DPAPI を組み合わせてブラウザ保存情報を復号
3. 得られた ID / PW / Cookie / トークンを用いて、
   - 別端末 / 別ブラウザ / プロキシツール等からアクセス再現
4. それを足掛かりに、
   - 内部 Web アプリ → AD / クラウド連携への横展開
   - Web サーバ側での RCE / Kerberoasting 等へ接続

---

## 7. RDP / VPN / 設定ファイルからの資格情報

### 7-1. RDP 関連

- `.rdp` ファイル
- RDP クライアントに保存された資格情報

攻撃例：

- ユーザーが `admin-server01.rdp` などをデスクトップに置き、
  - そこに保存された認証情報が残っている
- 管理者向けジャンプサーバへのログイン情報を流用

### 7-2. VPN / その他クライアント

- VPN クライアント設定に埋め込まれた ID / PW
- プロキシ設定用の資格情報

これらも DPAPI / 資格情報マネージャ経由で保護されているため、

- DPAPI キーを押さえれば復号可能なケースがある

### 7-3. 設定ファイル / スクリプト / バッチ

- `web.config`, `appsettings.json`, `.env`, バッチファイルなどに  
  「接続用 ID / PW / 接続文字列」が平文で置かれていることも多い

- WebPT やインフラ診断で
  - 「ソースコード / 設定ファイルへのアクセス」が取れた場合、
  - それ自体が資格情報窃取の一部として機能する

---

## 8. 実際のチェーン設計：どこで何を抜くか

ここまでの内容を、攻撃チェーンの中でこう整理します。

### 8-1. ステージ1：入口端末（社員 A の端末 / VDI）

目的：

- A 本人の ID / PW / チケット / トークン
- 入口からすぐ見える「追加の権限（保存された資格情報）」の収集

狙うストア：

- LSASS（A本人体・他ユーザー）
- 資格情報マネージャ（RDP / SMB / VPN 等）
- ブラウザ保存情報（SSO / クラウド / 内部ポータル）
- 設定ファイル / バッチなど

### 8-2. ステージ2：横展開先のクライアント / 管理端末

目的：

- 管理権限を持つユーザーの資格情報を取得

狙うストア：

- LSASS（管理者のチケット / ハッシュ）
- DPAPI + 資格情報マネージャ / ブラウザ

ここで得た情報を用いて、

- Kerberos チケット窃取 / 再利用（STEP3-03）
- 特権ユーザーとしての Lateral Movement（STEP3-05）

へとつなげる。

### 8-3. ステージ3：サーバ / DC

目的：

- サービスアカウント / KRBTGT / 高権限アカウント情報を取得

狙うストア：

- LSASS（DC / サーバ上のログオン情報）
- SAM / SECURITY / SYSTEM（ローカルアカウント）
- LSA Secrets / サービス用資格情報
- 設定ファイル内の接続情報（DB / アプリ）

ここまで来ると、

- Kerberoasting の高価値ターゲット
- Golden / Silver Ticket の前提条件
- クラウンジュエル（DB / 決済系等）への最終到達

が見えてくる。

---

## 9. Blue / DFIR 観点へのブリッジ（STEP3-06 予告）

本 STEP3-04 で整理した資格情報窃取は、

- どの OS ログ / セキュリティログ / EDR に何が残るか
- どの挙動が検知されやすく、どこが見落とされやすいか

という Blue / DFIR 視点と表裏一体です。

次々 STEP（STEP3-06）では、

- 本 STEP3-04 の各テクニックに対し、
  - どのイベントログ / プロセス挙動 / ネットワークログで追えるか
  - 実務 DFIR / 監視でどこまで見ているべきか
- Recon → 認証突破 → AD / Kerberos / 資格情報窃取 → Lateral Movement  
  というチェーン全体を、**検知・調査・遡及** の流れとしても眺める

という形で、Blue チームへのブリッジを作っていきます。

---

## 10. 次のSTEP（3-05）への接続

次の STEP3-05 では、本 STEP3-04 で得られた

- チケット / ハッシュ / ID / PW / トークン
- どのホストでどの権限が取れているか

を前提に、

- SMB / RDP / WinRM / WMI / PsExec などのプロトコル別に
  - どの認証情報を使って、どのように横展開するか
- 「AD 攻撃用組織図」と「資格情報一覧」を組み合わせた  
  **具体的な Lateral Movement ルート設計**

を行っていきます。

> ここまでのまとめ：
> - Windows / AD 環境での主要な資格情報ストア（LSASS / DPAPI / ブラウザ等）を整理した
> - それぞれが、Kerberos 攻撃・Lateral Movement のどの部分に効くかを紐づけた
> - 「どのステージで、どのホストから、どの資格情報を抜き、次にどこへ進むか」を  
>   攻撃チェーンとして設計する視点を示した
> - 次の STEP3-05 では、これを実際の横展開プロトコル・経路に落としていく

<<<END>>>