<<<BEGIN>>>
# 03 STEP3-1 AD / Kerberos / Lateral Movement 全体像

## 1. このSTEPの位置づけと「地続き」関係

### 1-1. ここまでのチェーン復習

- **STEP1（01_asm-recon）**  
  - インターネット側からの Recon / ASM を実施  
  - 例）`vpn.example.co.jp`, `portal.example.co.jp`, `owa.example.co.jp` など  
  - 公開サービス・ドメイン・証明書・メール・社員名などの OSINT を収集

- **STEP2（02_auth-iam-sso-mfa）**  
  - 上記の公開サービスで使われている「認証方式」を分析  
  - 例）  
    - VPN / VDI の ID・パスワード + MFA  
    - SAML / OIDC ベースの SSO ポータル  
    - OWA / Exchange Online などメールフロント  
  - 「どの入口から、社員として内部ネットワークに入り込めるか」を整理  
  - 想定される攻撃側の成果物（例）：  
    - 社員アカウントの ID / PW  
    - フィッシング等で得た OTP / Push 承認  
    - 被害端末上のブラウザ Cookie / SSO トークン など

### 1-2. STEP3の目的

この STEP3（03_ad-kerberos-lateral）では、上記の「外から社員として入り込む入口」を前提に、

- 企業内部で広く使われている **Active Directory（AD）**
- その上で動作する **Kerberos 認証**
- そこで管理される **「内部ID」と権限（グループ / ポリシー）**
- それらを悪用した **横展開（Lateral Movement）**

を「攻撃チェーンの中盤」として整理します。

> ゴールイメージ：  
> STEP2 で「社員として VPN / VDI / SSO にログインできた攻撃者」が、  
> **AD / Kerberos を理解して、ドメイン全体へ横展開・特権昇格するまで**の“筋道”を描ける状態。

---

## 2. シナリオの全体像（Recon → 認証突破 → 内部AD → 横展開）

### 2-1. 典型シナリオ（抽象）

1. STEP1：`vpn.example.co.jp` や `portal.example.co.jp` を Recon で発見
2. STEP2：フィッシングや OSINT 等から社員 A の資格情報を取得
   - 例）`userA@example.co.jp` / password + MFA 一時突破
3. STEP2 の成果を使い、VPN / VDI / OWA / SSO ポータルに「社員A」としてログイン
4. 社員A の PC / VDI 上から、**社内ADドメインに参加している端末・サーバへ到達**可能になる
5. STEP3：ここから
   - AD / Kerberos の仕組みを理解したうえで
   - 資格情報窃取・Kerberosチケット悪用・権限昇格・横展開を行う

この STEP3 は、上記の **4〜5 の“内部世界”の理解と攻撃パターン整理**に集中します。

---

## 3. Active Directory（AD）の超要約と攻撃者視点

### 3-1. AD とは何か（攻撃者目線）

AD は、Windows ドメイン環境で

- 「ユーザー / コンピュータ / グループ / サービスアカウント」などの  
  **ID情報とポリシー**を一元管理するしくみ

攻撃者から見た主なポイント：

- **1つの AD ドメインを制圧すれば**、
  - 多くのサーバ・PC・ファイル共有・メール・SaaS への入口を掌握しやすい
- 多くの企業で「オンプレ / ハイブリッド構成」で使われているため、  
  **TLPT や実務ペンテストの“中核”になりやすい**

### 3-2. AD の主な要素

- **ドメイン（example.local など）**
- **ドメインコントローラ（DC）**
  - 認証 / 認可 / ディレクトリ情報を提供するサーバ
- **ユーザーアカウント**
  - 社員アカウント、管理者アカウント、サービスアカウント
- **グループ**
  - `Domain Admins` などの特権グループが重要
- **コンピュータアカウント**
  - ドメイン参加しているクライアントPC / サーバ
- **GPO（グループポリシー）**
  - ログオンスクリプトやセキュリティ設定などを一括配布

攻撃チェーン上のポイントは、

- 「どのユーザー / グループ / コンピュータがどのリソースにアクセスできるか」
- 「どのルートで特権アカウントに近づけるか」

を **グラフとして捉える**ことです。

---

## 4. Kerberos 認証のざっくり流れと攻撃ポイント

### 4-1. なぜ Kerberos を理解する必要があるか

- AD ドメインに参加した Windows 端末では、  
  ユーザー認証の多くが **Kerberos** で行われる
- 多くの横展開・特権昇格テクニックが  
  **「Kerberos チケット」や「サービスアカウント」を狙う**

STEP2 で学んだ「ID / PW / MFA / SSO トークン」は主に外部入口でしたが、  
STEP3 では **「TGT / TGS などの Kerberos チケット」** を追加で理解します。

### 4-2. Kerberos の基本フロー（超簡略版）

1. ユーザーがドメインにログオン  
   → DC（KDC）の認証サービスに対して **AS-REQ**（認証要求）
2. DC がユーザーを認証  
   → **TGT（Ticket Granting Ticket）** を返す（AS-REP）
3. ユーザーは TGT を使って、特定サービスへのアクセス用チケット（TGS）を要求  
   → **TGS-REQ / TGS-REP**
4. 取得したサービスチケットを使って  
   ファイルサーバ / SQLサーバ / Webアプリ / などにアクセス

このとき発行される **TGT / サービスチケット** が

- メモリ（LSASS プロセスなど）
- チケットキャッシュ

に存在するため、攻撃者はそれらを **窃取・再利用（Pass-the-Ticket）** することで、  
パスワードそのものを知らなくても「なりすまし」できます。

---

## 5. 横展開（Lateral Movement）の典型パターン整理

ここでは詳細な手法名よりも、**流れ（マクロなパターン）**を重視して整理します。  
（個々のテクニックは、今後の STEP3-x で深掘り）

### 5-1. 大まかな流れ

1. **入口端末の確保**
   - STEP2 の成果：社員Aとして VPN / VDI / SSO にログイン済み
   - 社員A 端末に「インタラクティブに操作できる状態」を確保

2. **認証情報・チケットの窃取**
   - 端末上から以下を狙う：
     - メモリ中のハッシュ / トークン / Kerberos チケット
     - ブラウザ保存の Cookie / SSO トークン
     - ローカルの資格情報マネージャー
   - 例（ツール名はイメージ）：  
     ~~~~
     mimikatz, Rubeus, seatbelt, lsassy など
     ~~~~

3. **権限昇格（Privilege Escalation）**
   - 入口ユーザー（社員A）が非管理者の場合：
     - ローカル権限昇格（UAC バイパス、脆弱なサービス設定など）
     - AD 上の権限の不備（誤った Delegation、権限委譲の設定ミス）を悪用
   - 結果として、**ローカル管理者 / ドメイン管理者**に近づく

4. **横展開（Lateral Movement）**
   - SMB / RDP / WinRM / WMI / PsExec などを使って  
     他ホストへ移動し、同様に認証情報を窃取・拡大
   - Kerberos 認証を悪用するシナリオ：
     - AS-REP roasting / Kerberoasting など
     - unconstrained / constrained delegation の悪用
     - Golden Ticket / Silver Ticket などの偽造

5. **ドメイン制御 / クラウンジュエルへの到達**
   - `Domain Admins` / `Enterprise Admins` 相当の権限取得
   - ファイルサーバ / DB / 認証基盤 / クラウド連携アカウント（Azure AD Connect等）へのアクセス獲得
   - この結果が、次の STEP4（04_cloud）・STEP5（05_pentest-chain）へ接続する

---

## 6. このSTEP3で作る「攻撃チェーンToDoリスト」

STEP3 全体を、今後の STEP3-x に分割して扱うため、  
まずは「やること一覧」を洗い出します。

### 6-1. STEP3 内のサブSTEP案

- **STEP3-1（本ファイル）**  
  - AD / Kerberos / Lateral Movement の全体像と、STEP1・2 との接続整理

- **STEP3-2 AD / LDAP での内部情報収集**
  - ドメイン / フォレスト構造
  - ユーザー / グループ / コンピュータ / GPO の列挙
  - 血族図（権限関係グラフ）のイメージ作り

- **STEP3-3 Kerberos 攻撃パターン整理**
  - AS-REP roasting / Kerberoasting / Delegation 関連
  - チケットキャッシュの盗み方・再利用方法
  - Golden / Silver Ticket 等の位置づけ（概念レベル）

- **STEP3-4 資格情報窃取と LSASS / DPAPI**
  - LSASS メモリからの資格情報取得
  - Windows 資格情報マネージャ / ブラウザ保存情報
  - DPAPI の簡易理解（平文に戻るまでの流れ）

- **STEP3-5 Lateral Movement プロトコルと実行経路**
  - SMB / RDP / WinRM / WMI / PsExec 等の仕組みと攻撃利用
  - 各プロトコルで「何が送られて」「どこで認証されるか」を整理

- **STEP3-6 AD / Kerberos × Blue / DFIR への接続**
  - ログ（Windows Event / DC ログ）に何が残るか
  - どの動きが検知されやすく、どこが見落とされやすいか

以降の STEP3-x では、これらを **「攻撃チェーンのどの段階で」「Recon / Auth の成果物をどう使うか」を必ず明示**しながら深掘りします。

---

## 7. WebPT / TLPT / 実務へのつながり

### 7-1. Webアプリ診断からの延長としての AD / Kerberos

ゆういさんの本職である Web 脆弱性診断 / WebPT からのつながりとしては、

- Webアプリケーションで取得したセッション / トークン / 認証情報が  
  **実は裏側の AD / Kerberos にマッピングされている**
- 例）  
  - SSO ポータルへのセッションハイジャック  
  - 内部ポータルの IDOR / RCE から、AD 実行権限を奪う  
  - Web サーバ上のサービスアカウントが Kerberos SPN を持ち、Kerberoasting の対象になる

といった「Web → AD / Kerberos」への橋渡しを、  
STEP3 で体系的に理解していくことが重要です。

### 7-2. TLPT での位置づけ

金融系 TLPT などでは、

- フェーズ1：外部からの侵入（フィッシング・VPN・OWAなど）
- フェーズ2：内部での横展開（AD / Kerberos / Lateral Movement）
- フェーズ3：クラウンジュエル（決済システム・勘定系・重要DB）への到達

という構造が多く、STEP3 の内容は **フェーズ2 の中核**になります。

---

## 8. 次のSTEP（3-2）への接続

次の STEP3-2 では、本STEP3-1 の全体像を前提に、

- 「AD / LDAP を使って、実際に何を列挙し、どのような“攻撃地図”を描くか」
- STEP1 で集めた情報（サブドメイン / メール / 組織図など）と  
  AD 内のユーザー / グループ情報をどう“紐づけるか”

を整理していきます。

> ここまでのまとめ：
> - STEP1・2 の成果物（入口・ID情報）を前提に  
> - AD / Kerberos / Lateral Movement 全体像を「一本の線」として整理した  
> - 以降の STEP3-x では、この線を細かく分解し、  
>   実際に手を動かせるレベルの手順・観点へ落とし込んでいく

<<<END>>>
