<<<BEGIN>>>
# 03 STEP3-02 AD / LDAP を用いた内部情報収集（攻撃用「組織図」を描く）

## 1. このSTEPのゴール

この STEP3-02 のゴールは、以下の状態になることです。

- 攻撃者視点で **「AD ドメイン内の組織図」** を描ける
  - どのドメイン / フォレストがあるか
  - どのユーザー / グループ / コンピュータ / GPO がありそうか
  - どの経路をたどれば特権アカウントに近づけそうか
- STEP1（外部Recon）で得た情報や  
  STEP2（認証突破）で得た「入口ユーザー」を起点に、
  **実際の AD 内部構造と結びつけて考えられること**

最終的には、後続の

- STEP3-3：Kerberos 攻撃パターン整理
- STEP3-4：資格情報窃取
- STEP3-5：Lateral Movement

で **どこを叩くと効くか** の「攻撃マップ」を作るための下準備にあたります。

---

## 2. 前STEPからの「地続き」整理

### 2-1. STEP1 / STEP2 から持ち込んだもの

ここまでの前提として、攻撃側は次のような成果物を持っています。

- STEP1（ASM / Recon）の成果：
  - 会社名・ブランド名・関連ドメイン  
    例）`example.co.jp`, `corp.example.co.jp`, `ad.example.local`（候補）
  - 公開サービス：
    - `vpn.example.co.jp` / `portal.example.co.jp` / `owa.example.co.jp` 等
  - 社員名・部署情報・メールアドレス形式  
    例）`firstname.lastname@example.co.jp` 形式

- STEP2（認証 / SSO / MFA）の成果：
  - 社員 A の認証情報（ID / PW / MFA 一時突破）  
    例）`y.kedashiro@example.co.jp`
  - 社員 A として VPN / VDI / SSO にログイン済み
  - 社員 A が利用できる内部ポータル、ファイルサーバ等への初期アクセス

### 2-2. STEP3-02 のスタート地点

- 社員 A の端末（VDI や VPN 接続された Windows クライアント）上で、
  **ドメイン参加済みの Windows セッションを取得済み** という想定
- ここから、
  - 「自分が今どのドメイン / フォレストにいるのか」
  - 「どんなユーザー / グループ / コンピュータがいるのか」
  - 「誰が偉くて、誰に近づけばクラウンジュエルに届くのか」

を調査していくフェーズが本 STEP3-02 です。

---

## 3. AD / LDAP 内部情報収集の観点

### 3-1. 何を列挙するか（優先度高いもの）

攻撃チェーン上で特に重要になるのは、以下の情報です。

1. **ドメイン / フォレスト情報**
   - ドメイン名（例：`corp.example.local`）
   - フォレスト構成（単一ドメインか、複数か）
   - トラスト関係（別ドメイン / 別フォレストとの信頼関係）

2. **ユーザーアカウント**
   - 全ユーザー一覧（少なくとも所属 OU / 部署と紐づく範囲）
   - 明らかに特権っぽいアカウント  
     例）`svc_***`（サービスアカウント）, `adm_***`（管理用アカウント）
   - メールアドレスとの対応（STEP1で得た情報とつなげる）

3. **グループ / 特権グループ**
   - `Domain Admins`, `Enterprise Admins`, `Schema Admins`
   - `Account Operators`, `Server Operators` などの準特権グループ
   - 運用上使われやすいカスタムグループ（例：`IT-Admin`, `Helpdesk`）

4. **コンピュータ / サーバ / DC**
   - ドメインコントローラ（DC）の特定
   - ファイルサーバ / SQLサーバ / アプリケーションサーバ
   - 管理系ジャンプサーバ / Bastion host

5. **SPN（Service Principal Name）を持つアカウント**
   - Kerberoasting 対象抽出に必要
   - Web / SQL / ファイルサーバ系サービスアカウント

6. **GPO / ログオンスクリプト / 権限委譲設定**
   - 権限昇格や横展開の足掛かりになりうる設定  
   - 例：特定グループに対する「リモートログオン可」権限 など

### 3-2. どのプロトコル / インターフェースで見るか

主に

- **LDAP / LDAPS**
- **PowerShell + ADモジュール**
- 場合によっては **WinRM / WMI 経由でリモートクエリ**

などを利用しますが、STEP3-02 ではあくまで

> 「こういう情報を AD から引き出し、攻撃用の組織図を描く」

という観点に集中し、具体的なコマンドは「サンプル」として扱います。

---

## 4. 初期列挙フロー（例）※概念レベル

ここでは、攻撃者が社員 A の Windows セッションを得た後に行う  
概念的な列挙フローを、順番に整理します。

### 4-1. 自分の立ち位置を確認する

まずは「今どこにいるのか」を確認します。

- 所属ドメイン
- 自分のユーザー名
- 自分が属するグループ

イメージ（コマンド例は雰囲気程度）：

~~~~
whoami
whoami /groups
nltest /dsgetdc:corp.example.local
~~~~

ここで、

- 所属ドメイン名：`corp.example.local`
- ログオンしているユーザー：`CORP\y.kedashiro`
- 所属グループ：一般ユーザーか、一部特権グループに属していないか

などを把握します。

### 4-2. ドメイン / フォレストの全体像を把握

次に、「組織としての骨格」を把握します。

- ドメイン名 / フォレスト名
- 子ドメインの有無
- トラスト関係（別ドメイン / 別フォレストとの信頼）

イメージ：

~~~~
# PowerShell 例（イメージ）
Get-ADDomain
Get-ADForest
~~~~

ここで、

- `corp.example.local` 以外に `child.corp.example.local` があるのか
- `partner.example.co.jp` などとのトラスト関係があるのか

といった情報を得て、**攻撃対象範囲の広さ**を評価します。

### 4-3. ユーザー一覧と部署構造（OU）の把握

続いて、ユーザーと OU（組織単位）を見ます。

- OU 構造  
  例）`OU=Users,OU=Tokyo,DC=corp,DC=example,DC=local`
- 部署ごとのユーザー分布
- 管理系 OU（`OU=Admins` など）の有無

イメージ：

~~~~
# すべてのユーザーをざっくり列挙（※実環境では絞り込み必須）
Get-ADUser -Filter * -Properties DisplayName,Department,Mail,MemberOf

# OU の一覧
Get-ADOrganizationalUnit -Filter *
~~~~

ここで STEP1 の Recon で得た

- 社員名一覧
- 部署 / 子会社名
- メールアドレス（`firstname.lastname@example.co.jp`）

などと **名前・部署・メール属性を突き合わせて**、

> 「Recon で見えていた“外の社員名”が、AD 内部ではどの OU にいるか」

をイメージできるようにします。

### 4-4. グループと特権経路の洗い出し

次に、重要なグループを列挙します。

- `Domain Admins`, `Enterprise Admins` などの特権グループ
- `Server Admins`, `DBA` など、クラウンジュエルに近そうなグループ
- `Helpdesk` や `IT-Admin` など、資格情報リセット権限を持ち得るグループ

イメージ：

~~~~
# 特定グループのメンバーを確認
Get-ADGroupMember "Domain Admins"
Get-ADGroupMember "Enterprise Admins"

# それぞれのメンバーが、どの OU・部署かを見る
# → 「誰を踏めば特権に近づけるか」を考える
~~~~

ここで作りたいのは、

> 「社員 A（自分） → ○○ グループ → △△ グループ → Domain Admins」

という **権限のエスカレーション経路**のイメージです。

この経路を「血族図」的に紙やノートに書いておくと、  
後で Lateral Movement のルート設計がやりやすくなります。

### 4-5. コンピュータ / サーバ / DC の把握

攻撃者として重要なのは、

- **どこに DC があるか**
- **どこにファイルサーバ / アプリサーバ / DBサーバがあるか**
- **自分が今どの PC / サーバ上にいるか**

です。

イメージ：

~~~~
# DC 一覧
Get-ADDomainController -Filter *

# コンピュータ（サーバ系を優先）
Get-ADComputer -Filter 'OperatingSystem -like "*Server*"' -Properties OperatingSystem,IPv4Address
~~~~

ここで、

- DC は `DC01.corp.example.local`, `DC02.corp.example.local` なのか
- ファイルサーバ `FILE01`, DB サーバ `SQL01`, アプリサーバ `APP01` などがあるのか
- これらがどの OU にあり、どのグループが管理しているのか

を見ながら、

> 「どのサーバに横展開すれば、どの種類の情報（ファイル / DB / 認証）が手に入りそうか」

をイメージしていきます。

### 4-6. SPN（Service Principal Name）とサービスアカウントの抽出

Kerberos 攻撃（Kerberoasting 等）に向けて、SPN を持つアカウントを抽出します。

- `MSSQLSvc/...`, `HTTP/...`, `cifs/...` などの SPN を持つアカウント
- それらが「サービスアカウント」か、「人ユーザーアカウント」か
- SPN を持つアカウントが、どのグループ権限を持つか

イメージ：

~~~~
# SPN を持つアカウントの一覧
Get-ADUser -Filter {ServicePrincipalName -like "*"} -Properties ServicePrincipalName
~~~~

これにより、

- どのサービスアカウントを狙うと、どのサーバ / サービスの権限を得られるか
- そのアカウントのパスワードハッシュ（オフラインクラック）が価値あるか

を判断する材料が揃います。

---

## 5. STEP1 Recon 情報とのひもづけ方

ここで、再度 STEP1 の Recon で得た情報と接続します。

### 5-1. 社員名 / 部署 / メールアドレスとのマッピング

例として、

- Recon で「情報システム部の〇〇さん」「インフラチームの△△さん」の名前を知っていたとする
- AD 列挙で、それらの名前 / メール / 部署情報が見つかった場合

攻撃者視点では、

> 「この人たちはどのグループに所属しているか」  
> 「この人たちの PC / サーバはどれか」

を重点的に見ることで、

- 特権を持つユーザー候補
- 管理者の端末 / ジャンプサーバ

を特定しやすくなります。

### 5-2. 公開サービスと内部ホストの対応

STEP1 で、

- `vpn.example.co.jp`
- `portal.example.co.jp`
- `owa.example.co.jp`

などを見つけていたとして、  
内部の AD 列挙で

- `VPN-GW01.corp.example.local`
- `WEB-PORTAL01.corp.example.local`
- `EXCH01.corp.example.local`

などを見つけた場合、

> 「この公開サービスの裏側は、このホスト群で構成されている」

という対応関係をイメージできるようになります。

これにより、

- Web ペネトレーションテストで見えていた脆弱性が  
  「内部 AD / Kerberos / Lateral Movement」にどうつながるか
- TLPT でのシナリオ設計（外から → 内部認証 → AD → クラウンジュエル）を  
  一貫して描きやすくなる

というメリットがあります。

---

## 6. このSTEPで作るべきアウトプット（メモの形）

この STEP3-02 で、実際に手を動かすときに作りたいアウトプットは以下のようなものです。

1. **AD 構造メモ**
   - ドメイン / フォレスト名
   - 子ドメイン / トラスト関係
   - 主要 OU（Users / Admins / Servers / Workstations 等）

2. **重要ユーザー / グループ一覧**
   - Domain Admins / Enterprise Admins のメンバー
   - IT-Admin / Helpdesk / サービス運用グループ 等
   - Recon で知っている社員と AD 内ユーザーの対応表

3. **重要コンピュータ / サーバ一覧**
   - DC 一覧
   - ファイルサーバ / SQL / Web / 認証系サーバ
   - 管理ジャンプサーバ等があればメモ

4. **SPN / サービスアカウント一覧**
   - SPN → 対応するサービス / ホスト
   - アカウントの権限レベル（特権かどうか）

これらを、紙やノート、マインドマップ、スプレッドシート等で  
「グラフ」として整理しておくことで、次のステップで

- どのユーザー / サーバから
- どのような Kerberos / 資格情報窃取 / Lateral Movement を試すか

を設計しやすくなります。

---

## 7. 次のSTEP（3-3）への接続

次の STEP3-3 では、この STEP3-02 で集めた

- 特権 / サービスアカウント
- SPN 情報
- ドメイン / フォレスト / トラスト関係

などを前提に、

- **Kerberos 固有の攻撃パターン**
  - AS-REP Roasting
  - Kerberoasting
  - 各種 Delegation の悪用
  - Golden Ticket / Silver Ticket など

を、「どのタイミングで / どのアカウントに対して / 何を目的に」  
使うのかという形で整理していきます。

> ここまでのまとめ：
> - 社員 A として内部ログオンできる状態から
> - AD / LDAP を使ってドメイン内部の「攻撃用組織図」を描く方法を整理した
> - Recon と内部 AD 情報を紐づけることで、  
>   **誰を踏むべきか・どのサーバを目指すべきか** がだんだん見えてくる
> - 次の STEP3-3 では、この組織図をベースに  
>   Kerberos 攻撃の「どこを刺すと効くか」を具体化していく

<<<END>>>