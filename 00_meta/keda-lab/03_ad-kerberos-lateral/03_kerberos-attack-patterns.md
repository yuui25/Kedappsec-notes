<<<BEGIN>>>
# 03 STEP3-03 Kerberos 攻撃パターン整理（どこをどう刺すかの設計）

## 1. ゴールと前STEPからのつながり

### 1-1. このSTEPのゴール

この STEP3-03 では、STEP3-01 / 02 で整理した

- 「AD / Kerberos 全体像」
- 「AD / LDAP 列挙で作った攻撃用“組織図”」
- 「SPN・サービスアカウント・特権ユーザーの洗い出し」

を前提に、

> Kerberos を悪用した攻撃パターンを  
> 「どのタイミングで」「何を狙い」「何を得るために」使うのか

を整理します。

最終的に、以下が頭の中で線としてつながる状態を目指します。

- 外部からの侵入（STEP1 / STEP2）
- AD / LDAP 列挙（STEP3-02）
- Kerberos 攻撃で「どのアカウント・どのサービス」を崩すか
- その結果としての横展開・特権昇格（STEP3-4 / 3-5）

### 1-2. 前STEPで持ち込んだ前提

STEP3-02 までに攻撃側はすでに：

- 社員 A としてドメインにログオンできる
- AD / LDAP 経由で
  - 特権グループ
  - サービスアカウント
  - SPN（Service Principal Name）を持つアカウント
  - DC / ファイルサーバ / DBサーバ
  を大まかに把握済み

この STEP3-03 は、そこから

> 「列挙したターゲットを Kerberos 視点でどう料理するか」

を決めるフェーズです。

---

## 2. Kerberos 攻撃の大きな分類軸

まず、Kerberos 攻撃をざっくり以下の 4 種に分けます。

1. **チケット発行前の攻撃（パスワードクラック系）**
   - AS-REP Roasting
   - Kerberoasting
   - 目的：オフラインでパスワードをクラックし、アカウント乗っ取り

2. **チケット窃取・再利用（Pass-the-Ticket 系）**
   - 目的：パスワードを知らなくても、既存チケットを悪用してなりすまし

3. **Delegation（委任）設定の悪用**
   - unconstrained / constrained / resource-based constrained delegation（RBCD）
   - 目的：あるサービスアカウントを踏み台に、別サービス / 別ユーザーへなりすまし

4. **チケット偽造（Golden / Silver Ticket 等）**
   - 目的：KDC レベルの秘密情報を奪取し、恒久的なバックドア化

この STEP3-03 では、それぞれを

- 前提条件（Prerequisite）
- 攻撃の流れ（どこからどこへ）
- 得られるもの（アカウント / 権限 / 継続アクセス）
- Web / TLPT / Cloud への波及

の 4 点で整理します。

---

## 3. 攻撃① AS-REP Roasting

### 3-1. 何を狙う攻撃か

- **「事前認証不要（Do not require Kerberos preauthentication）」が有効なユーザー** を狙い、
- KDC から返ってくる **暗号化済み AS-REP（認証応答）」を取得し、
- それをオフラインでクラックしてパスワードを割る攻撃。

### 3-2. 前提条件（Prerequisite）

- 攻撃者がすでにドメインユーザーとしてログオンしている（社員 A）
- AD 列挙（STEP3-02）で  
  「preauth 無しユーザー（`DoNotRequirePreauth` フラグ）」を見つけられていること

イメージ（概念）：

~~~~
# preauth 無しユーザーの例（概念）
ユーザー: svc_legacy_app
属性: DoNotRequirePreauth = True
~~~~

### 3-3. 攻撃の流れ（概念）

1. 攻撃者（社員 A）は、preauth 無しユーザーに対して AS-REQ を送る
2. KDC は、パスワード由来の秘密鍵で暗号化した AS-REP を返す
3. 攻撃者は AS-REP を保存し、オフラインでクラック（hashcat 等）
4. パスワードが割れれば、そのユーザーとしてログオン可能

### 3-4. 何が嬉しいか

- preauth 無しユーザーが「特権 / サービスアカウント」の場合：
  - ファイルサーバ・DB・アプリ基盤・クラウド連携など、様々な権限にアクセス可能
- パスワードがシンプルな場合、比較的成功しやすい

### 3-5. Recon / WebPT との接続

- STEP1 の Recon で見えていた「レガシーシステム / 旧アプリ」の担当ユーザーが  
  preauth 無し設定になっているケースなど：
  - 「レガシーなアカウントはパスワード運用も緩い」→ TLPT での典型的な弱点

---

## 4. 攻撃② Kerberoasting

### 4-1. 何を狙う攻撃か

- **SPN を持つサービスアカウント** をターゲットに、
- KDC からそのサービス向けの **TGS（サービスチケット）」を取得し、
- その暗号化部分をオフラインでクラックして  
  サービスアカウントのパスワードを割る攻撃。

### 4-2. 前提条件

- ドメインユーザーとしてログオン済み（社員 A）
- STEP3-02 の SPN 列挙で、
  - `MSSQLSvc/...`, `HTTP/...`, `cifs/...` などを持つアカウントを把握済み
- サービスアカウントのパスワードが弱い / 共有運用されている可能性がある

### 4-3. 攻撃の流れ（概念）

1. AD / LDAP で SPN を持つアカウント一覧を取得する（STEP3-02 の続き）
2. その中から「狙いたいサービス（DB / Web / ファイル）」を選ぶ
3. そのサービス向け TGS を要求し、暗号化済みチケットを取得
4. TGS の暗号化部分を保存し、オフラインでクラック
5. パスワードが割れれば、サービスアカウントとしてログオン可能

### 4-4. 何が嬉しいか

- サービスアカウントはしばしば：
  - 高権限（ローカル管理者 / ドメイン関連権限）
  - 長期間パスワード未変更
  - 複数サーバ・複数アプリで再利用

→ 一つ割れると、水平展開の攻撃面が一気に広がる。

### 4-5. WebPT / TLPT への接続

- Web ペネトレーションテストで見つけた Web サーバの裏側が、
  - AD SPN `HTTP/webapp01.corp.example.local`  
  などのサービスアカウントと結びついている場合、
- そのアカウントを Kerberoasting して  
  → DB / バッチ処理 / 他サーバの権限に到達するシナリオが描ける。

---

## 5. 攻撃③ Delegation（委任）設定の悪用

### 5-1. 概要

Kerberos Delegation は、

> 「このサービスは、ユーザーの代理として別のサービスにアクセスして良い」

という設定であり、SaaS / Web アプリ連携などでよく使われる。

攻撃者はこの設定のミスを悪用して、

- 別ユーザー（とくに特権ユーザー）になりすましたり、
- 別のサービス（ファイルサーバ / DB / クラウド連携）にアクセスしたりする。

### 5-2. 主な種類

1. **Unconstrained Delegation**
   - そのサービスは、ユーザーの TGT を保持し、任意のサービスに対して代理アクセス可能
   - 最も危険な設定

2. **Constrained Delegation**
   - 指定されたサービスに対してのみ代理アクセス可能
   - 設計次第で安全だが、設定ミスで悪用余地あり

3. **Resource-Based Constrained Delegation（RBCD）**
   - サービス側（リソース側）が「どのアカウントからの委任を受け入れるか」を決めるモデル
   - ACL 誤設定などで悪用されうる

### 5-3. 前提条件

- STEP3-02 の列挙で、
  - `TrustedForDelegation` や `msDS-AllowedToDelegateTo` などの属性を見て、
  - Delegation 設定のあるアカウント / ホストを把握していること
- 入口となるホスト（社員 A の端末 / VDI）から、そのサービスへ到達可能であること

### 5-4. 攻撃のイメージ

1. **Unconstrained Delegation のホストを踏む**
   - そのホストにログオンしてきたユーザーの TGT がキャッシュされる
   - DC / 管理者などがログオンしてくれば、その TGT を奪取できる
   - → 管理者の TGT で別サービスにアクセス

2. **Constrained Delegation の設定ミスを悪用**
   - 「任意 SPN に対して委任可能」などの緩い設定がある場合、
   - 攻撃者は、別サービスへの代理アクセスにそれを利用

3. **RBCD の悪用**
   - リソース側オブジェクトの ACL を悪用し、
   - 攻撃者のアカウント / ホストを「委任可能な主体」に追加
   - → 正規のフローを装いながら他ユーザーになりすまし

### 5-5. TLPT / SSO / Web との接続

- SSO ポータルや Web アプリが AD Delegation に依存している場合、
  - 認証基盤周りの設定ミスが、そのままユーザーなりすまし / 特権昇格に直結
- 金融系 TLPT では、
  - 「SSO → AD Delegation → コアシステム」  
    というチェーンを攻撃側視点で検証することが多い

---

## 6. 攻撃④ チケット窃取・再利用（Pass-the-Ticket 系）

### 6-1. 概要

- ユーザー / サービスがすでにログオンしている端末から、
  - **Kerberos チケット（TGT / TGS）をメモリ等から窃取**し、
- それを別のマシンで再利用してなりすます攻撃。

### 6-2. 前提条件

- ある程度のローカル権限（LSASS へのアクセス）を持っていること
  - 多くの場合、ローカル管理者権限が必要
- STEP3-02 で特定した
  - 管理者端末 / ジャンプサーバ / サーバ上で実行できると効果が大きい

### 6-3. 攻撃イメージ

1. 員 A がローカル権限昇格に成功し（これは STEP3-4 で詳細）、  
   対象端末のメモリから Kerberos チケットを抽出
2. 抽出したチケットを、別ホストのセッションに「インポート」
3. そのチケットを使って、元ユーザーになりすましてサービスにアクセス

### 6-4. 何が嬉しいか

- パスワードそのものを知らなくても、
  - ログオン済みユーザー（特権ユーザー含む）になりすませる
- ログオンユーザーが Domain Admins などの場合、
  - そこからドメイン制御まで一気に到達

---

## 7. 攻撃⑤ チケット偽造（Golden / Silver Ticket 等）

### 7-1. Golden Ticket

- **KRBTGT アカウントのハッシュ** を入手すると、
  - 攻撃者は任意ユーザーとして、任意の TGT を偽造可能
- これは KDC の根本秘密を握るに等しく、
  - ドメイン全体の「パスポート発行機関」を乗っ取るイメージ

前提条件：

- すでに DC 上での高権限（Domain Admins レベル）を取得済み
- したがって、Golden Ticket は「後半戦の永続化テクニック」

### 7-2. Silver Ticket

- 特定のサービス（SPN）のキー（サービスアカウントのハッシュなど）を用いて、
  - そのサービス向けの TGS を偽造
- KDC に問い合わせずにサービスにアクセス可能

前提条件：

- Kerberoasting や資格情報窃取で、特定サービスアカウントの秘密を取得済み

### 7-3. TLPT / 実務での位置づけ

- TLPT では、Golden Ticket まで行かずとも、
  - 「Kerberoasting → サービスアカウント奪取 → Silver Ticket」レベルで  
    十分クリティカルなシナリオを描けることが多い
- Golden Ticket まで行く場合は、
  - 「ドメイン完全制御」を示す根拠として使用

---

## 8. ここまでの攻撃を「チェーン」として見る

STEP1〜3 をつなげると、典型的なチェーンは次のようになります。

1. **STEP1（Recon）**
   - 会社・ドメイン・社員名・公開サービスの把握

2. **STEP2（認証突破）**
   - 社員 A の ID / PW / MFA を得て、VPN / VDI / SSO へログイン
   - 社員 A として内部 Windows セッションを取得

3. **STEP3-02（AD / LDAP 列挙）**
   - 特権グループ
   - サービスアカウント
   - SPN / Delegation 設定
   - DC / 重要サーバ
   を可視化して「攻撃用組織図」を作る

4. **STEP3-03（本 STEP：Kerberos 攻撃パターン）**
   - 組織図を眺めつつ、ターゲットと手段を決定：
     - preauth 無しユーザー → AS-REP Roasting
     - SPN 持ちサービスアカウント → Kerberoasting
     - Delegation 設定 → Delegation 悪用
     - 管理者端末 → チケット窃取・再利用
     - DC 完全制御 → Golden / Silver Ticket

5. **STEP3-04 / 3-05（今後）**
   - 実際の資格情報窃取手順
   - SMB / RDP / WinRM 等を用いた横展開
   - どの順番でどのホストを踏んでいくかのルート設計

---

## 9. WebPT / Cloud / TLPT との接続イメージ

### 9-1. WebPT → Kerberos

- SSO ポータルや内部 Web アプリの脆弱性（RCE / IDOR / SSRF）から
  - AD 連携アカウントの認証情報 / チケットにアクセス
  - → Kerberoasting の足掛かり（SPN 持ちサービスアカウント）

### 9-2. Cloud（STEP4）への橋渡し

- ハイブリッド環境では、
  - Azure AD Connect などがオンプレ AD とクラウド ID をつないでいる
- Kerberoasting / Delegation / Lateral Movement を通じて、
  - これら連携アカウントを奪取すると
  - クラウド側（Azure AD / M365 / 他SaaS）への横展開につながる

### 9-3. TLPT でのストーリー

- 金融系 TLPT シナリオ例：
  1. フィッシングで社員 A の認証情報と MFA を奪取（STEP2）
  2. 内部 AD 列挙（STEP3-02）でサービスアカウント / Delegation を把握
  3. Kerberoasting で権限の高いサービスアカウントを奪取（STEP3-03）
  4. Lateral Movement で決済系サーバ / コアシステムに到達（STEP3-05 / 05_pentest-chain）
  5. インシデントの検知・対応・フォレンジックで Blue チーム評価（08_blue-dfir）

---

## 10. 次のSTEP（3-04）への接続

次の STEP3-04 では、この STEP3-03 で整理した攻撃パターンを前提に、

- 「実際にどのホストで、どの資格情報窃取テクニックを使うか」
- 「LSASS / DPAPI / Credential Manager / ブラウザ保存情報などをどう扱うか」
- 「Kerberos 攻撃と資格情報窃取をどう組み合わせるか」

を、より **手順レベル** に落として整理します。

> ここまでのまとめ：
> - Kerberos 攻撃を
>   - Roasting（AS-REP / TGS）
>   - Delegation 悪用
>   - チケット窃取・再利用
>   - チケット偽造
>   の 4 グループに整理した
> - STEP3-02 の AD 列挙結果から  
>   「どのターゲットに対して、どの攻撃を選ぶか」を決める設計フェーズである
> - 次の STEP3-04 では、これらの攻撃を支える  
>   資格情報窃取テクニックをチェーンの中に具体配置していく

<<<END>>>