<<<BEGIN>>>
# 03 STEP3-05 Lateral Movement プロトコルとルート設計

## 1. ゴールと前STEPからのつながり

### 1-1. このSTEPのゴール

この STEP3-05 のゴールは、以下を一本の攻撃チェーンとして結び切ることです。

- STEP3-02 で作成した **「AD 攻撃用組織図」**
- STEP3-03 で整理した **Kerberos 攻撃パターン**
- STEP3-04 で集めた **資格情報（チケット / ハッシュ / ID / PW / トークン）**

これらを前提として、

> 「どのプロトコルを使って、どのホストへ、どの順番で横展開していくか」  
> を具体的な **ルート設計** として描ける状態にする。

### 1-2. ここまでの前提（おさらい）

攻撃側はすでに：

- 社員 A として VPN / VDI / SSO から内部 AD にログオン済み（STEP2）
- AD / LDAP 列挙で以下を把握済み（STEP3-02）
  - ドメイン / フォレスト構造
  - 特権グループ / サービスアカウント / SPN
  - DC / ファイルサーバ / アプリ / DBサーバ
- Kerberos 攻撃パターンを整理し、ターゲット候補を決定済み（STEP3-03）
- 資格情報窃取により、以下の一部を取得済み（STEP3-04）
  - チケット（TGT / TGS）、NTLM ハッシュ
  - 各種 ID / PW（SMB / RDP / Web / VPN 等）
  - ブラウザ保存セッション / トークン
  - 設定ファイル・スクリプト内の接続情報

本 STEP3-05 では、これらの「材料」を使って

- SMB / RDP / WinRM / WMI / PsExec 等の **プロトコル別の横展開方法**
- それを組み合わせた **具体ルート（ホップ）設計**

を行う。

---

## 2. Lateral Movement の全体イメージ

### 2-1. 大まかな構造

攻撃者視点では、Lateral Movement は概ね以下の構造になる。

1. **起点ホスト**
   - 社員 A の端末 / VDI（最初に入れた場所）
2. **中継ホスト**
   - 管理者のクライアント / ジャンプサーバ
   - アプリケーション / ミドルウェアサーバ
3. **コアホスト**
   - DC
   - ファイルサーバ / DBサーバ
   - 認証基盤 / ハイブリッド連携サーバ
4. **クラウンジュエル**
   - 決済システム / 勘定系 / 重要 DB
   - ID 基盤やクラウド連携のキー管理箇所 など

これを「攻撃用組織図」（STEP3-02）に重ねながら、

> 起点 → 中継 → コア → クラウンジュエル

という **最短かつ検知されにくいルート** を設計する。

### 2-2. 主な横展開プロトコル

本 STEP で扱う主なプロトコルは以下の通り。

- **SMB（445/TCP）**
- **RDP（3389/TCP）**
- **WinRM（5985/5986/TCP）**
- **WMI（DCOM / RPC 経由）**
- **PsExec 系（SMB + サービス作成）**
- （環境によって）SSH / HTTP(S) 経由の横展開など

それぞれについて、

- どの認証情報（ID / PW / ハッシュ / チケット）が使えるか
- どのホストへのアクセスに向いているか
- Blue / DFIR 観点での痕跡 / 検知しやすさ

を整理する。

---

## 3. SMB を利用した横展開

### 3-1. SMB の特徴

- ファイル共有 / プリンタ共有 / 管理共有（`C$`, `ADMIN$` 等）に利用
- Windows 環境でのリモート管理・ツール配布等に多用される
- 認証は主に
  - NTLM（ハッシュベース）
  - Kerberos（ドメイン環境で）  
  のいずれか

### 3-2. 攻撃者が利用するパターン

1. **管理共有へのアクセス**
   - `\\TARGET\C$` などにアクセスし、
     - ファイルアップロード / 実行
     - 設定ファイル・ログ・資格情報の再調査

2. **PsExec 系ツールによるリモート実行**
   - SMB 経由でバイナリを送信し、
   - リモートサービスとして実行させる（後述）

3. **資格情報の再利用**
   - Pass-the-Hash / Pass-the-Ticket による認証バイパス

### 3-3. 必要な前提

- 対象ホストで
  - 該当ユーザーがローカル管理者権限を持っていること
  - SMB / 管理共有が有効であること
- 攻撃者が
  - NTLM ハッシュ
  - Kerberos チケット
  - または平文 ID / PW  
  のいずれかを所持していること（STEP3-04 で確保）

### 3-4. チェーンでの位置づけ

- **クライアント間の横展開** に多用される
- アプリケーション / ファイルサーバへの侵入口にもなる
- DC やジャンプサーバへのアクセスにも用いられることが多い

---

## 4. RDP を利用した横展開

### 4-1. RDP の特徴

- GUI ベースでのリモートデスクトップ接続
- ユーザーが通常業務で利用するため、ログオンイベントが多数
- 認証に
  - ID / PW
  - スマートカード / MFA 併用 など

### 4-2. 攻撃者の利用パターン

1. **正規ユーザーとしてのログイン**
   - 盗んだ ID / PW で RDP ログイン
   - その端末上で再度 LSASS / DPAPI / ブラウザ調査（STEP3-04 の繰り返し）

2. **セッションハイジャック / ローカル RDP 利用**
   - 既存セッションを乗っ取る / 使い回すパターン（条件次第）

3. **ジャンプサーバ経由での多段アクセス**
   - 社内では、RDP ジャンプサーバを中継にして  
     「クライアント → ジャンプサーバ → サーバ群」という構成が多い

### 4-3. 必要な前提

- 対象ホストで RDP が有効
- 対象ユーザーに対し
  - 「リモートログオン権限」が付与されていること
- 盗んだ資格情報が
  - RDP 用に有効（パスワード / MFA 条件など）

### 4-4. チェーンでの位置づけ

- 人間の運用フローと同じ動きをするため、
  - 監視側からは「通常のリモート作業」と見えがち
- ただし、ログオンイベントなどには明確に痕跡が残るため、
  - Blue チームが整備されている環境では検知対象

---

## 5. WinRM / WMI / PsExec を利用した横展開

### 5-1. WinRM（Windows Remote Management）

- HTTP(S) ベースのリモート管理プロトコル（5985 / 5986/TCP）
- PowerShell Remoting の基盤
- スクリプト / 自動化で多用される

攻撃者視点：

- 取得済みの資格情報を利用し、
  - PowerShell リモートセッションを張る
  - スクリプトでホスト横断の操作を自動化

### 5-2. WMI（Windows Management Instrumentation）

- システム管理情報の参照・制御のための仕組み
- リモートプロセス起動 / サービス操作 / 情報収集などが可能

攻撃者視点：

- ファイルドロップ不要でコマンド実行できる手段として好まれる
- ログや EDR への挙動は環境依存だが、近年は検知強化対象

### 5-3. PsExec 系

- SMB + サービス作成を利用したリモート実行手法の総称（オリジナルは Sysinternals の PsExec）
- 流れ（概念）：
  1. SMB 経由でバイナリをアップロード
  2. リモートサービスとして登録・実行
  3. 権限付きのプロセスとしてコマンドを実行

攻撃者視点：

- シンプルかつ多くの環境で動くため、古典的かつ今でも利用される
- ログ（サービス作成 / イベントログ）には痕跡が残りやすい

### 5-4. 必要な前提

- 対象ホストに対する管理権限（ローカル Admin）
- WinRM / WMI / SMB / サービス制御が許可されていること
- NTLM ハッシュ / チケット / ID / PW のいずれかを保有

### 5-5. チェーンでの使い分け

- WinRM / WMI：
  - スクリプト・自動化向き、ファイル転送を減らしたい場面
- PsExec：
  - シンプルな横展開で「まずは foothold を増やす」局面

---

## 6. プロトコル別に「どの資格情報を使うか」

### 6-1. 資格情報の種類

- 平文 ID / PW
- NTLM ハッシュ
- Kerberos チケット（TGT / TGS）
- Kerberos 関連秘密（Golden / Silver Ticket 自作のための秘密）
- Web / SSO / クラウドの Cookie / トークン

### 6-2. マトリクス（概念）

※実際にはツール・環境依存だが、イメージとして：

- SMB / PsExec
  - ID / PW：利用可
  - NTLM ハッシュ：Pass-the-Hash
  - TGT / TGS：Kerberos 認証として利用（環境設定次第）

- RDP
  - ID / PW：基本
  - ハッシュでの直接ログオンは制約が多い
  - セッショントークン再利用などはテクニック依存

- WinRM / WMI
  - ID / PW：利用可
  - NTLM ハッシュ：Pass-the-Hash ベースでの利用可能なケースあり
  - Kerberos：SPN / ホスト名解決前提で利用

- Web / API 経由
  - ID / PW
  - SSO / クラウドのトークン / Cookie
  - ここからさらに内部 API / 管理コンソールへの横展開

---

## 7. 具体的なルート設計の考え方

### 7-1. ルート設計の基本方針

- **目的から逆算** する
  - 例）「最終的に決済DB `SQL-PAY01` から読取りを行いたい」
- そこに至るための前提権限を洗い出す
  - 例）`SQL-PAY01` のローカル Admin or SQL Sysadmin
- その権限を持ちうるアカウント / グループを  
  「攻撃用組織図（STEP3-02）」から特定する
- そのアカウントに関する情報が  
  どのホストの LSASS / DPAPI / 設定ファイルから得られそうかを  
  STEP3-04 の観点で洗い出す
- 最後に、
  - 起点 → 中継 → コア → 目的
  をプロトコル・資格情報付きで線にする

### 7-2. 例：決済DB への到達ルート（概念）

1. 起点：社員 A VDI
   - 資格情報窃取で、
     - 「運用チーム B」の一部ユーザー資格情報を入手（RDP 用）
2. 中継1：運用チーム B のクライアント
   - LSASS / DPAPI / ブラウザから、
     - ジャンプサーバ `JUMP-OPS01` への RDP 保存情報を入手
3. 中継2：JUMP-OPS01
   - LSASS から、
     - `SQL-SVC-PAY` サービスアカウントのチケット / ハッシュを取得
   - または Kerberoasting（STEP3-03）で `SQL-SVC-PAY` を狙う
4. コア：`SQL-PAY01`
   - `SQL-SVC-PAY` の資格情報で
     - SMB / WinRM 経由でローカル権限取得
     - SQL Sysadmin として DB へ直接接続
5. クラウンジュエル
   - 決済テーブルの読み取り / 改ざん等

---

## 8. WebPT / Recon / TLPT との接続

### 8-1. WebPT からの横展開

- Web サーバで RCE を取った場合：
  - そのサーバ上の
    - サービスアカウント
    - 接続先 DB / ファイルサーバの資格情報
  を入手 → SMB / WinRM で横展開

### 8-2. Recon との接続

- STEP1 で集めた情報（部署・社員・公開サービス）が、
  - 「誰がどのホストにログインしていそうか」
  - 「どのジャンプサーバがどのシステムを管理していそうか」
  の予測に役立つ

### 8-3. TLPT でのシナリオ構築

- 金融系 TLPT などでは、
  - 外部侵入（フィッシング / VPN）
  - 内部 AD / Kerberos / 資格情報窃取
  - Lateral Movement（本 STEP の内容）
  - クラウンジュエル到達
  を 1 本のストーリーとして設計する必要がある

---

## 9. Blue / DFIR との接続（次STEPの予告）

本 STEP3-05 で整理した Lateral Movement は、

- 各プロトコルごとに
  - イベントログ
  - ネットワークログ
  - EDR / EPP のアラート
  として異なる痕跡を残す。

次の STEP3-06 では、

- SMB / RDP / WinRM / WMI / PsExec などの横展開に対し、
  - どのイベント ID / ログを見ればよいか
  - 実務 DFIR ではどのようにトレースするか
  - 攻撃チェーン全体（Recon → Auth → AD → Lateral → Cloud）を  
    Blue 視点でどう可視化するか

を整理し、**攻撃チェーンと防御チェーンの両方**の視点を揃えていく。

---

## 10. ここまでのまとめ

- Lateral Movement を
  - 起点 / 中継 / コア / クラウンジュエル  
    の 4 層構造として整理した。
- SMB / RDP / WinRM / WMI / PsExec などのプロトコルについて、
  - 必要な資格情報
  - 適した利用場面
  - 攻撃チェーン上での位置づけ
  を整理した。
- STEP3-02〜3-04 で得た
  - 攻撃用組織図
  - Kerberos 攻撃パターン
  - 資格情報群
  を使い、
  - 「どのホストで何を取り、次にどこへ進むか」  
    という具体的なルート設計の考え方を示した。
- 次の STEP3-06 では、これらの横展開を  
  **検知・調査・防御** の観点から逆算して整理していく。

<<<END>>>