<<<BEGIN>>>
# 04 STEP4-02 Azure AD Connect と同期アカウント侵害

## 1. このSTEPのゴールと位置づけ

### 1-1. ゴール

この STEP4-02 のゴールは、

> **オンプレ AD を侵害した攻撃者が、  
> Azure AD（Entra ID）の管理権限へ“変換”できる具体ポイントを理解すること**

です。

STEP4-01 で整理した Hybrid Identity の全体像を前提に、

- Azure AD Connect が **何をしているサーバなのか**
- どの **アカウント / 権限 / 秘密情報** が集中しているのか
- STEP3 で得た権限が、どのように **クラウド侵害へ直結するのか**

を、攻撃チェーンとして一本につなげます。

---

## 2. STEP3 からの地続き（前提整理）

### 2-1. 攻撃者がすでに持っているもの

STEP3 までで、攻撃者は以下のいずれか、または複数を取得済みとします。

- ドメイン管理者権限（Domain Admins）
- AD 管理サーバ / 認証基盤サーバへの管理者アクセス
- サービスアカウントの資格情報
- 横展開ルート（RDP / WinRM / SMB）

これらはすべて、

> **Azure AD Connect を直接操作できる前提条件**

になり得ます。

---

## 3. Azure AD Connect の役割（攻撃者視点）

### 3-1. Azure AD Connect とは何か

Azure AD Connect は、

- オンプレ AD と Azure AD の間で
  - ユーザー
  - グループ
  - パスワード / 認証情報
を **同期・連携** する中核コンポーネントです。

攻撃者視点では、

> 「オンプレ侵害を、クラウド侵害へ変換する“変圧器”」

に相当します。

### 3-2. 典型的な配置

- オンプレ Windows Server
- ドメイン参加済み
- 以下の権限・秘密を保持：
  - AD への高権限
  - Azure AD への高権限
  - 同期用サービスアカウントの秘密

---

## 4. Azure AD Connect が持つ重要なアカウント

### 4-1. 同期用サービスアカウント（オンプレ側）

環境によって名称は異なるが、典型的には：

- `MSOL_XXXXXXXX`
- `AAD_Connect_Sync`
- カスタム作成された同期用アカウント

特徴：

- オンプレ AD 上で
  - 広範なディレクトリ読み取り権限
  - 場合によっては書き込み権限
- パスワードは **長期間変更されない** ことが多い

---

### 4-2. Azure AD 側の権限

Azure AD Connect は、Azure AD 側で：

- ディレクトリ同期に必要な権限
- 場合によっては **グローバル管理者相当の操作能力**

を持ちます（構成依存）。

つまり、

> 同期アカウント or Connect サーバを奪う  
> → Azure AD 管理面に手が届く

という構図になります。

---

## 5. 攻撃者視点での主要侵害パターン

### 5-1. パターン① Azure AD Connect サーバ侵害

#### 前提条件

- Domain Admins
- または Connect サーバへのローカル管理者権限

#### 攻撃の考え方（概念）

1. STEP3 の横展開ルートを使い、
   - Azure AD Connect サーバに RDP / WinRM で到達
2. サーバ上に保存された
   - 同期アカウントの資格情報
   - Azure AD 接続用の秘密情報
   を取得
3. Azure AD 側の管理操作へ展開

#### 攻撃者視点での重要性

- **一気にオンプレ → クラウドへジャンプ**
- TLPT では「決定的な証拠」として扱われやすい

---

### 5-2. パターン② 同期アカウント資格情報の奪取

#### 前提条件

- AD 内での資格情報窃取能力（STEP3-04）
- LSASS / DPAPI / 設定ファイルアクセス

#### 攻撃の流れ（概念）

1. Connect サーバ or 管理サーバ上で
   - 同期アカウントの資格情報を取得
2. そのアカウントを使い、
   - AD 側の属性操作
   - Azure AD 同期動作を悪用
3. クラウド ID へ影響を与える

#### 攻撃者視点でのポイント

- 同期アカウントは
  - 監視されにくい
  - 利用頻度が低い
- しかし影響範囲は非常に広い

---

### 5-3. パターン③ 同期設定の改変（Persistence）

#### 概念

- Azure AD Connect の同期ルールや設定を変更し、
  - 特定ユーザーを同期対象に追加
  - 属性を書き換え
- 攻撃者用のアカウントを
  - Azure AD 側で「正規ユーザー」に見せる

#### TLPT 的な意味

- 単なる侵害ではなく
  - **永続化（Persistence）**
- Blue チーム評価の核心に踏み込める

---

## 6. STEP3 成果物との対応関係

ここで明確に **地続き** を整理します。

| STEP3 で得たもの | STEP4-02 での意味 |
|---|---|
| Domain Admins | Azure AD Connect サーバ管理 |
| サービスアカウント | 同期アカウント奪取の足掛かり |
| Lateral Movement ルート | Connect サーバへの到達 |
| 資格情報窃取 | Azure AD 側操作権限取得 |

STEP3 を雑に終わらせると、  
STEP4-02 は成立しません。

---

## 7. Blue / DFIR 視点（簡易）

### 7-1. Blue 側の検知ポイント

- Azure AD Connect サーバへの
  - 異常な RDP / WinRM アクセス
- 同期アカウントの
  - 予期しない利用
  - 設定変更
- Azure AD 側での
  - 管理操作ログ

### 7-2. 攻撃者視点の示唆

- Connect サーバは
  - 重要だが運用担当者が限定される
  - アクセス頻度が低い
- そのため
  - 「静かに侵害できると一気に深く刺さる」

---

## 8. WebPT / TLPT との接続

### 8-1. WebPT 視点

- 内部 Web 管理画面から
  - Azure AD Connect 管理情報が露出しているケース
- Web → AD → Cloud の橋渡しが成立

### 8-2. TLPT 視点

- TLPT レポートでは、
  - 「オンプレ侵害 → Azure AD 管理権限到達」
は非常に強いインパクトを持つ

---

## 9. 次の STEP（4-03）への接続

次の **STEP4-03** では、

- Azure AD 側の
  - 管理ロール
  - Conditional Access
  - MFA / 認証制御
- それらをどう **回避・悪用・評価** するか

を、攻撃チェーンとして整理していきます。

---

## 10. まとめ

- Azure AD Connect は
  - オンプレ侵害をクラウド侵害へ変換する最重要コンポーネント
- STEP3 の成果（権限・資格情報・横展開）が
  - そのまま STEP4 の突破条件になる
- 次の STEP4-03 から、
  - クラウド側での権限・認証・制御の世界に踏み込む

<<<END>>>