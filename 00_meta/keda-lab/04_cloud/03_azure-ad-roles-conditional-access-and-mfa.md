<<<BEGIN>>>
# 04 STEP4-03 Azure AD 管理ロール / Conditional Access / MFA の突破と評価

## 1. このSTEPのゴールと位置づけ

### 1-1. ゴール

この STEP4-03 のゴールは、

> **Azure AD（Entra ID）側で“何が権限の本体か”を理解し、  
> 認証制御（Conditional Access / MFA）が  
> 攻撃チェーン上でどう作用するかを評価できる状態になること**

です。

STEP4-02 で到達した

- Azure AD Connect
- 同期アカウント
- クラウド管理操作の足掛かり

を前提に、

- どのロールを取れば「勝ち」なのか
- どの制御が攻撃を止め、どこが形骸化しやすいか
- TLPT でどこまで踏み込むのが妥当か

を整理します。

---

## 2. STEP3 / STEP4-02 からの地続き

### 2-1. 攻撃者の現在地

この時点の攻撃者は、以下のいずれかに到達している想定です。

- Azure AD Connect サーバへの管理者アクセス
- 同期アカウントの資格情報
- Azure AD 側での限定的な管理操作権限
- 一部クラウドユーザーとしてのログイン能力

ここから先は、

> **「どの Azure AD ロールを奪うか」**  
> **「Conditional Access がそれをどう妨げるか」**

という **クラウド特有の戦い** になります。

---

## 3. Azure AD 管理ロールの整理（攻撃者視点）

### 3-1. なぜロール理解が重要か

Azure AD では、

- オンプレ AD の「Domain Admins」のような
  - 単一の絶対権限は存在しない
- 代わりに
  - **細分化された管理ロール** が組み合わさっている

攻撃者は、

> 「最小のロールで最大の影響を得る」

ことを狙います。

---

### 3-2. 攻撃者が狙う代表的ロール

#### グローバル管理者（Global Administrator）

- ほぼすべての管理操作が可能
- Conditional Access / MFA 設定の変更可
- 他ロールの付与・剥奪可

→ **最終目標**。ただし監視も最も厳しい。

---

#### 特権認証管理者（Privileged Authentication Administrator）

- MFA / 認証方式のリセット
- 認証要素の再登録誘導

→ **MFA バイパスの中核ロール**

---

#### 認証管理者（Authentication Administrator）

- 一般ユーザーの認証要素管理
- パスワードリセット

→ 横展開・なりすましの起点になりやすい。

---

#### ユーザー管理者（User Administrator）

- ユーザー作成・削除
- ロール割当（一部）

→ Persistence（永続化）に向く。

---

#### アプリケーション管理者 / クラウドアプリ管理者

- Enterprise App / App Registration 管理
- OAuth 権限付与

→ **API / トークン経由の横展開** に直結。

---

## 4. Conditional Access（CA）の実態

### 4-1. Conditional Access とは

Conditional Access（CA）は、

> 「誰が・どこから・どの条件で  
> クラウドリソースへアクセスできるか」

を制御する **Azure AD の中核防御機構** です。

典型的な条件：

- ユーザー / グループ
- デバイス状態（Intune 準拠など）
- 場所（IP / 国）
- リスクレベル
- MFA 要求

---

### 4-2. 攻撃者視点での CA の弱点

CA は強力ですが、以下の理由で **抜け道が生まれやすい**。

- 例外（Break Glass / 特定ユーザー除外）
- 管理者ロール向けの例外ルール
- レガシー認証の許可
- 同期アカウントやサービスアカウントが CA 対象外

---

### 4-3. STEP4-02 との接続点

Azure AD Connect 侵害により、

- CA の対象外となる同期アカウント
- CA が適用されない操作経路

を利用できるケースがある。

攻撃者視点では、

> **「CA がかからない経路で管理操作する」**

のが基本戦略。

---

## 5. MFA の位置づけ（誤解の整理）

### 5-1. MFA は万能ではない

MFA は

- ユーザーの **対話的ログイン** を守る仕組み

であり、

- API
- 同期処理
- 管理操作
- トークン再利用

を **完全に防ぐものではない**。

---

### 5-2. 攻撃チェーン上の MFA 回避パターン（概念）

- MFA が不要なロール / 操作
- MFA 済みセッション / トークンの再利用
- 認証管理ロールを用いた MFA リセット
- CA 非対象ユーザーの悪用

TLPT では、

> 「MFA があるのに侵害できた理由」

を説明できることが重要。

---

## 6. 攻撃者の典型的な思考ルート

ここまでを踏まえた、攻撃者の意思決定例です。

1. Azure AD Connect / 同期経路を確保（STEP4-02）
2. CA / MFA がかからない操作経路を特定
3. 小さな管理ロールを奪取
4. そのロールを使って：
   - 認証要素リセット
   - 新規管理ユーザー作成
   - App Registration / OAuth 権限付与
5. 最終的に Global Admin 相当の影響力を獲得

---

## 7. TLPT / 実務ペンテストでの評価観点

### 7-1. TLPT で問われるポイント

- CA / MFA が **本当に防御として機能しているか**
- 「管理操作」が想定外に実行できないか
- Break Glass / 例外ユーザーの管理は適切か

### 7-2. 攻撃者視点レポートの価値

- 「MFA があるから安全」ではなく
- 「どの操作が MFA を回避できたか」
- 「なぜそれが可能だったか」

を説明できることが、TLPT での評価を高める。

---

## 8. Blue / DFIR 視点（簡易）

### 8-1. ログと検知

- Azure AD Audit Log
- Sign-in Log
- CA Evaluation Log

### 8-2. 攻撃者視点での示唆

- クラウドは **ログが豊富**
- しかし：
  - 見ていない
  - 相関していない
ケースが多い

→ TLPT では「検知できたか」も評価対象。

---

## 9. 次の STEP（4-04）への接続

次の **STEP4-04** では、

- Azure AD / M365 上での
  - トークン
  - OAuth
  - API 権限
- SaaS 連携を利用した横展開

を整理し、

> **クラウド内部での Lateral Movement**

を完成させます。

---

## 10. まとめ

- Azure AD では「ロール」が権限の本体
- Conditional Access / MFA は強力だが万能ではない
- 攻撃者は
  - CA 非対象経路
  - 認証管理ロール
  - トークン / API
  を組み合わせて前進する
- 次の STEP4-04 で、クラウド内部横展開を完成させる

<<<END>>>