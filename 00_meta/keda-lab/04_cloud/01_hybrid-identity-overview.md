<<<BEGIN>>>
# 04 STEP4-01 オンプレAD → クラウドID（Hybrid Identity）の全体像

## 1. このSTEPの位置づけとゴール

### 1-1. STEP4 の役割（STEP3 からの地続き）

STEP3 では、以下を達成しました。

- オンプレミス AD 環境への内部侵入
- Kerberos / 資格情報窃取 / Lateral Movement による
  - 管理者
  - サービスアカウント
  - 認証基盤関連サーバ
  への到達
- Blue / DFIR 視点で「どこまでやると現実的か」を判断可能な状態

STEP4（04_cloud）は、ここからさらに一段階進み、

> **オンプレ AD で奪った“ID と権限”が、  
>  クラウド（Azure AD / M365 / SaaS）にどう波及するか**

を整理するフェーズです。

### 1-2. この STEP4-01 のゴール

この STEP4-01 では、まず

- 企業で一般的な **Hybrid Identity 構成**
- オンプレ AD とクラウド ID（主に Azure AD）の接続点
- 攻撃者視点での「踏み台ポイント」

を **全体像レベル** で把握することをゴールとします。

以降の STEP4-02 以降で、

- Azure AD Connect
- 同期アカウント
- クラウド管理権限
- SaaS への横展開

を段階的に深掘りしていきます。

---

## 2. なぜ STEP4（Cloud）が重要なのか

### 2-1. 現代企業の現実

多くの企業では、

- オンプレ AD だけで業務が完結することは少ない
- 実態は：
  - Azure AD（Microsoft Entra ID）
  - Microsoft 365（Exchange Online / SharePoint / Teams）
  - 各種 SaaS（Salesforce, Box, ServiceNow 等）

が **ID 基盤として AD と強く結合** しています。

つまり攻撃者視点では、

> オンプレ AD を取る  
> ＝ クラウド ID に“手が届く位置”に来る

ということになります。

### 2-2. TLPT での位置づけ

金融系・大規模組織の TLPT では、

- 最終的なクラウンジュエルが
  - オンプレ DB ではなく
  - クラウド上の業務データ（M365 / SaaS）
であるケースも多い

そのため、

- STEP3（AD 内部）で止めるか
- STEP4（クラウド ID まで波及）まで示すか

は **評価の深さを左右する分岐点** になります。

---

## 3. Hybrid Identity の基本構成

### 3-1. 典型的な構成図（概念）

多くの企業は、以下のような構成を取ります。

- オンプレミス
  - Active Directory（AD DS）
  - ドメインコントローラ
  - AD 管理者 / サービスアカウント
- クラウド
  - Azure AD（Entra ID）
  - Microsoft 365
  - 各種 SaaS
- 接続点
  - Azure AD Connect
  - フェデレーション（AD FS 等）
  - パススルー認証 / パスワードハッシュ同期

攻撃者は **この「接続点」** を最重要視します。

---

## 4. オンプレ AD と Azure AD の関係整理

### 4-1. 役割の違い（重要）

まず、よくある誤解を整理します。

- **オンプレ AD**
  - Kerberos / NTLM
  - PC / サーバログオン
  - ファイル / 内部リソース管理
- **Azure AD**
  - OAuth / OIDC / SAML
  - SaaS / M365 認証
  - クラウド管理ロール

両者は「別物」だが、

> 同一ユーザーを  
> 同一 ID として扱うために“同期”されている

という関係です。

### 4-2. 同期される主な要素

- ユーザーアカウント
- パスワード（方式により異なる）
- グループ
- 属性（メール、UPN、部署など）

つまり、STEP3 で奪取した

- オンプレ AD ユーザー
- サービスアカウント
- 管理者権限

が、そのまま **Azure AD 側の権限や認証能力に影響** する可能性があります。

---

## 5. 認証方式別の攻撃面整理（概要）

### 5-1. パスワードハッシュ同期（PHS）

- オンプレ AD のパスワードハッシュを
  - Azure AD に同期
- Azure AD 側で直接認証

攻撃者視点：

- オンプレでパスワードを奪えば
  - クラウドにもそのまま使える可能性
- AD Connect サーバが重要ターゲット

---

### 5-2. パススルー認証（PTA）

- クラウド認証時に
  - オンプレのエージェントへ問い合わせ
- 実体はオンプレ AD が認証元

攻撃者視点：

- 認証フロー上の
  - PTA エージェント
  - 関連サービスアカウント
が踏み台になる

---

### 5-3. フェデレーション（AD FS 等）

- クラウド認証を
  - オンプレのフェデレーションサーバが仲介
- 証明書・トークン署名が重要

攻撃者視点：

- AD FS サーバ
- トークン署名証明書
を奪えば **なりすまし範囲が極端に広がる**

---

## 6. STEP3 の成果物がどう生きるか

ここで、明確に **地続き** を示します。

### 6-1. STEP3 → STEP4 の接続点

STEP3 で得ている可能性が高いもの：

- ドメイン管理者権限
- サービスアカウントの資格情報
- 管理サーバ / 認証基盤サーバへのアクセス

これらは：

- Azure AD Connect サーバ管理
- フェデレーションサーバ管理
- 同期アカウント操作

に **直結** します。

### 6-2. 攻撃者の思考転換

STEP3 までの攻撃者：

> 「どの DC / サーバを踏むか」

STEP4 以降の攻撃者：

> 「どの ID がクラウド管理権限につながるか」

という **軸の変化** が起きます。

---

## 7. 攻撃者視点での最重要ターゲット（概要）

STEP4 全体を通して、攻撃者が狙う代表的ターゲットは以下です。

- Azure AD Connect サーバ
- 同期用サービスアカウント
- グローバル管理者に同期されるユーザー
- Conditional Access 設定
- クラウド管理ロール割当

これらは次の STEP4-02 以降で個別に深掘りします。

---

## 8. WebPT / TLPT との接続

### 8-1. WebPT 視点

- 内部 Web アプリが
  - Azure AD 認証（OIDC / SAML）を利用している場合
- Web 脆弱性 → クラウド ID 侵害
という流れが成立する

### 8-2. TLPT 視点

- TLPT では、
  - オンプレ侵入だけでなく
  - クラウド管理画面（M365 Admin / Azure Portal）への到達
が評価対象になることが多い

STEP4 は、

> TLPT における「オンプレ止まり」か「クラウド波及」か  
> を分ける重要フェーズ

となる。

---

## 9. 次の STEP（4-02）への接続

次の **STEP4-02** では、この全体像を前提に、

- Azure AD Connect の内部構成
- 同期アカウントの権限と役割
- オンプレ侵害が、どうやってクラウド管理権限に変換されるか

を **攻撃チェーンとして具体化** していきます。

---

## 10. まとめ

- STEP4 は、STEP3 で得たオンプレ AD 支配を  
  クラウド ID へ波及させるフェーズ
- Hybrid Identity（AD × Azure AD）の構成理解が核心
- 攻撃者は「接続点（Connect / Federation / 認証方式）」を最優先で狙う
- 次の STEP4-02 から、具体的なクラウド侵害ルートを分解していく

<<<END>>>