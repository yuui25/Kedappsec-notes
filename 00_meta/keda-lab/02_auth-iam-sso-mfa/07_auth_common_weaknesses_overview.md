<<<BEGIN>>>
# STEP2-7 認証まわりの典型的な弱点（高リスク観点の整理）

本 STEP では、これまで整理してきた認証方式（Session / OAuth / SAML / MFA / セッションライフサイクル）を前提に、  
**「実務で特に問題になりやすい認証まわりの弱点」を、高リスク観点に絞って体系化** する。  

ここでは「どこにどんな弱点が生まれやすいか」を整理することに集中し、  
具体的な攻撃手順・悪用方法は後工程（攻撃チェーン・PT/TLPT）で扱う。

---

## 1. 目的

- 認証まわりで頻出する高リスクな弱点の「カテゴリ」を整理する  
- STEP1・STEP2 で集めた情報を使って、どこを重点的にレビュー/テストすべきか見えるようにする  
- 後続の工程（権限分析・攻撃チェーン設計）に向けて、  
  「どの部分が攻撃者の入口になりやすいか」の視点を持たせる  

---

## 2. 前ステップとの関係（どの情報がここで生きるか）

### 2.1 STEP1（外部資産・技術スタック）

- **STEP1-3 サブドメイン列挙**  
  - `/login`, `/signin`, `/auth`, `/sso`, `/idp` など「認証入口」の洗い出し  
- **STEP1-4 技術スタック推定**  
  - フレームワーク固有の Session 管理やデフォルト設定を意識  
- **STEP1-5 クラウド露出資産**  
  - Cognito / Azure AD / Auth0 / Okta 等の有無 → クラウド側設定の弱点候補  
- **STEP1-6 GitHub / CI/CD / SaaS**  
  - 環境変数・設定ファイルに認証関連の設定値が出ていないか

### 2.2 STEP2（認証方式〜セッション）

- **STEP2-1 認証方式の全体像**  
  - 対象ごとに「Session / Token / OAuth / SAML / MFA」どれかを分類済み  
- **STEP2-2 Session 認証**  
  - Cookie 属性・セッション管理方式を把握済み  
- **STEP2-3 OAuth/OIDC**  
  - `redirect_uri` や `client_id` 等のパラメータ構造を理解済み  
- **STEP2-4 SAML/SSO**  
  - SAMLRequest / SAMLResponse / RelayState の構造を理解済み  
- **STEP2-5 MFA**  
  - MFA がどの段階で行われ、どの API で状態が管理されているかを把握済み  
- **STEP2-6 セッションライフサイクル**  
  - ログイン〜ログアウト〜タイムアウトまでの挙動を観察済み  

本 STEP では、  
**これらの情報を前提として「どこに弱点カテゴリが潜みやすいか」をマッピングする。**

---

## 3. 認証まわりの典型的な高リスク弱点カテゴリ

### 3.1 認証前後の境界の甘さ

- ログイン前でも参照できてよい情報と、ログイン後でなければならない情報の分離が不十分  
- 「ログイン状態でないのに一部情報が閲覧できる」「セッションが未確立でも特定 API が動く」 など  
- URL 構造として `/public` `/internal` `/admin` などが混在している場合は特に要注意

観察観点：
- STEP1 で洗い出した URL のうち、ログイン前にアクセスできる範囲  
- STEP2-6 で把握したセッション無し状態でのレスポンス

---

### 3.2 アカウント・パスワードポリシーの弱さ（高レベル）

- パスワード要件が弱い（長さ・複雑さ・再利用制限）  
- ログイン試行回数制限やロックアウトが不十分  
- エラーメッセージから「ID が存在するかどうか」が推測できる  

観察観点：
- ログインフォーム上の説明文（ポリシー記載）  
- エラーメッセージが「IDが存在しません」「パスワードが誤っています」などで分かれていないか  
- パスワード変更画面や登録画面の UI 誘導

※ 実際の試行を伴うテストは後工程の話とし、本 STEP では設計・UI 上の観察に留める。

---

### 3.3 Session/Cookie 設定の不備（構成レベル）

- Secure / HttpOnly / SameSite の未設定  
- Domain / Path の範囲が広すぎる（不要なサブドメインまで共有）  
- ログアウト時に Cookie が削除されない、または一部のみ残る  

観察観点：
- STEP2-2 / STEP2-6 で取得した Cookie 属性  
- `Set-Cookie` の挙動（ログイン時・ログアウト時・タイムアウト後）  
- サブドメイン間で同一 Cookie が流れているかどうか

---

### 3.4 OAuth/OIDC 設定の弱さ（パラメータ設計）

- `redirect_uri` の管理が緩い（許可リストが広すぎる、ワイルドカード許可など）  
- `state` パラメータが未使用 / 誤用  
- PKCE（code_challenge）の未利用（Public Client であるのに未使用）  
- Scope 設定が過剰（必要以上の情報取得・権限付与）

観察観点：
- STEP2-3 で観察した `authorize` リクエスト  
  - `redirect_uri` の形式（サブドメインやパスがどこまで許されているか）  
  - `state` / `code_challenge` の有無  
  - `scope` に `openid profile email` 以上の権限が付与されていないか  

※ 実際にパラメータを書き換えて挙動を見るのは後工程。  
　本 STEP では「設計として怪しいポイント」を特定する。

---

### 3.5 SAML 設定の弱さ（検証ロジック・メタデータ）

- 署名検証に問題がある実装パターン  
- `AssertionConsumerServiceURL` の管理が緩くなりがちな構成  
- RelayState の扱いが雑であるケース  

観察観点：
- STEP2-4 で確認した `SAMLRequest` / `SAMLResponse` の送受信先  
- メタデータファイル（もし公開されていれば）の内容  
- ACS URL がどの程度固定・限定されているか（設計レベルの話）

ここも同様に、  
検証や書き換えそのものは後工程に回し、  
「どの設定項目が弱点候補になるか」だけを整理する。

---

### 3.6 MFA 運用・設定の弱さ

- MFA がオプション設定で、多くのユーザーが有効化していない  
- SMS のみなど、単一チャネルに依存している  
- 「このデバイスを信頼する」などの機能が長期間有効  
- 保護対象が限定的で、重要操作時に MFA が求められない

観察観点：
- STEP2-5 で整理した MFA フロー  
- アカウント設定画面での MFA オプションの有無  
- 重要操作（パスワード変更、メールアドレス変更、支払い情報変更）の画面に MFA が要求されているか  

---

### 3.7 ログアウトとセッション失効の不備

- ログアウトしても一部機能が利用できてしまう  
- 別タブでは「まだログイン状態」が続く  
- Token / Cookie がサーバ側では無効化されず、クライアント側の破棄のみで処理されている  

観察観点：
- STEP2-6 で確認したログアウト後の Cookie / Token 状態  
- ログアウト → ブラウザバック → 再表示時の挙動  
- ログイン後に複数タブを開いて、片方でログアウトしたときの他方の初回リクエスト

※ 実際にどこまでテストするかは環境ルールに依存するため、  
　本 STEP では「設計としてのリスクポイント」を棚卸ししておく。

---

## 4. 実務での整理手順（チェックリスト的な使い方）

1. **STEP1・STEP2 の結果から対象サービスを分類する**  
   - 認証方式（Session / OAuth / SAML）  
   - クラウド基盤（Cognito / Azure AD / 自前 IdP 等）  
   - MFA の有無  

2. **本 STEP の弱点カテゴリ（3.1〜3.7）を、対象ごとに当てはめる**  
   - どのカテゴリが当該サービスに関係するかチェック  
   - 「関係する箇所」にはマーカーを付けておく  

3. **後工程（権限・攻撃チェーン）に渡す “認証まわりリスクメモ” を作る**  
   - 「Session 設定が弱そう」「OAuth の redirect 管理が広い」など  
   - TLPT のシナリオ設計時に、どの入口になりうるかを明確にしておく  

---

## 5. 注意事項

- 本 STEP はあくまで「弱点のカテゴリ整理」と「観察観点の整理」にとどめる  
- 実際の攻撃手順・悪用方法・テストシナリオは、  
  後のフォルダ（03_ad-kerberos-lateral / 04_cloud / 05_pentest-chain）で扱う  
- 環境のルールや契約範囲を超えるようなテストはここでは想定しない  

---

## 6. 参考文献

- OWASP ASVS V2 Authentication / V3 Session Management  
- OWASP Cheat Sheets（Authentication, Session Management, OAuth Security, SAML Security）  
- NIST SP800-63 Digital Identity Guidelines  
- 各 IdP / クラウド認証サービスのベストプラクティスガイド  

<<<END>>>